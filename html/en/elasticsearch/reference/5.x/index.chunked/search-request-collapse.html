<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title xmlns="">Field Collapsing
        | Elasticsearch Reference [5.x]
      | Elastic
    </title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Elasticsearch Reference [5.x]" /><link rel="up" href="search-request-body.html" title="Request Body Search" /><link rel="prev" href="search-request-inner-hits.html" title="Inner hits" /><link rel="next" href="search-request-search-after.html" title="Search After" /><meta xmlns="" name="description" content="Get started with the documentation for Elasticsearch, Kibana, Logstash, Beats, X-Pack, Elastic Cloud, Elasticsearch for Apache Hadoop, and our language clients." /><meta xmlns="" name="DC.type" content="Docs/Elasticsearch/Reference/5.x" /></head><body><div xmlns="" class="page_header">You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div><div xmlns="" class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">Elasticsearch Reference
      [5.x]
    </a></span> » <span class="breadcrumb-link"><a href="search.html">Search APIs</a></span> » <span class="breadcrumb-link"><a href="search-request-body.html">Request Body Search</a></span> » <span class="breadcrumb-node">Field Collapsing</span></div><div xmlns="" class="navheader"><span class="prev"><a href="search-request-inner-hits.html">
              « 
              Inner hits</a>
           
        </span><span class="next">
           
          <a href="search-request-search-after.html">Search After
               »
            </a></span></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="search-request-collapse"></a>Field Collapsing<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/5.x/docs/reference/search/request/collapse.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h2></div></div></div><p>Allows to collapse search results based on field values.
The collapsing is done by selecting only the top sorted document per collapse key.
For instance the query below retrieves the best tweet for each user and sorts them by number of likes.</p><div xmlns="" class="pre_wrapper"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-js">GET /twitter/tweet/_search
{
    "query": {
        "match": {
            "message": "elasticsearch"
        }
    },
    "collapse" : {
        "field" : "user" <a id="CO22-1"></a><span xmlns=""><img src="images/icons/callouts/1.png" alt="" /></span>
    },
    "sort": ["likes"], <a id="CO22-2"></a><span xmlns=""><img src="images/icons/callouts/2.png" alt="" /></span>
    "from": 10 <a id="CO22-3"></a><span xmlns=""><img src="images/icons/callouts/3.png" alt="" /></span>
}</pre></div><div xmlns="" class="console_widget" data-snippet=":CONSOLE:"></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-1"><span xmlns=""><img src="images/icons/callouts/1.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
collapse the result set using the "user" field
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-2"><span xmlns=""><img src="images/icons/callouts/2.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
sort the top docs by number of likes
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-3"><span xmlns=""><img src="images/icons/callouts/3.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
define the offset of the first collapsed result
</p></td></tr></table></div><div xmlns="" class="warning admon"><div class="icon"><img alt="Warning" src="images/icons/warning.png" /></div><div class="admon_content"><p xmlns="http://www.w3.org/1999/xhtml">The total number of hits in the response indicates the number of matching documents without collapsing.
The total number of distinct group is unknown.</p></div></div><p>The field used for collapsing must be a single valued <a class="link" href="keyword.html" title="Keyword datatype"><code class="literal">keyword</code></a> or <a class="link" href="number.html" title="Numeric datatypes"><code class="literal">numeric</code></a> field with <a class="link" href="doc-values.html" title="doc_values"><code class="literal">doc_values</code></a> activated</p><div xmlns="" class="note admon"><div class="icon"><img alt="Note" src="images/icons/note.png" /></div><div class="admon_content"><p xmlns="http://www.w3.org/1999/xhtml">The collapsing is applied to the top hits only and does not affect aggregations.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_expand_collapse_results"></a>Expand collapse results<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/5.x/docs/reference/search/request/collapse.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>It is also possible to expand each collapsed top hits with the <code class="literal">inner_hits</code> option.</p><div xmlns="" class="pre_wrapper"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-js">GET /twitter/tweet/_search
{
    "query": {
        "match": {
            "message": "elasticsearch"
        }
    },
    "collapse" : {
        "field" : "user", <a id="CO23-1"></a><span xmlns=""><img src="images/icons/callouts/1.png" alt="" /></span>
        "inner_hits": {
            "name": "last_tweets", <a id="CO23-2"></a><span xmlns=""><img src="images/icons/callouts/2.png" alt="" /></span>
            "size": 5, <a id="CO23-3"></a><span xmlns=""><img src="images/icons/callouts/3.png" alt="" /></span>
            "sort": [{ "date": "asc" }] <a id="CO23-4"></a><span xmlns=""><img src="images/icons/callouts/4.png" alt="" /></span>
        },
        "max_concurrent_group_searches": 4 <a id="CO23-5"></a><span xmlns=""><img src="images/icons/callouts/5.png" alt="" /></span>
    },
    "sort": ["likes"]
}</pre></div><div xmlns="" class="console_widget" data-snippet=":CONSOLE:"></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO23-1"><span xmlns=""><img src="images/icons/callouts/1.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
collapse the result set using the "user" field
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO23-2"><span xmlns=""><img src="images/icons/callouts/2.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
the name used for the inner hit section in the response
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO23-3"><span xmlns=""><img src="images/icons/callouts/3.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
the number of inner_hits to retrieve per collapse key
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO23-4"><span xmlns=""><img src="images/icons/callouts/4.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
how to sort the document inside each group
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO23-5"><span xmlns=""><img src="images/icons/callouts/5.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
the number of concurrent requests allowed to retrieve the inner_hits` per group
</p></td></tr></table></div><p>See <a class="link" href="search-request-inner-hits.html" title="Inner hits">inner hits</a> for the complete list of supported options and the format of the response.</p><p>The expansion of the group is done by sending an additional query for each
collapsed hit returned in the response.
The <code class="literal">max_concurrent_group_searches</code> request parameter can be used to control
the maximum number of concurrent searches allowed in this phase.
The default is based on the number of data nodes and the default search thread pool size.</p><div xmlns="" class="warning admon"><div class="icon"><img alt="Warning" src="images/icons/warning.png" /></div><div class="admon_content"><p xmlns="http://www.w3.org/1999/xhtml"><code class="literal">collapse</code> cannot be used in conjunction with <a class="link" href="search-request-scroll.html" title="Scroll">scroll</a>,
<a class="link" href="search-request-rescore.html" title="Rescoring">rescore</a> or <a class="link" href="search-request-search-after.html" title="Search After">search after</a>.</p></div></div></div></div><div xmlns="" class="navfooter"><span class="prev"><a href="search-request-inner-hits.html">
              « 
              Inner hits</a>
           
        </span><span class="next">
           
          <a href="search-request-search-after.html">Search After
               »
            </a></span></div></body></html>
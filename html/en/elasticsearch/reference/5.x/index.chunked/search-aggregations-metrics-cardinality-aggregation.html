<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title xmlns="">Cardinality Aggregation
        | Elasticsearch Reference [5.x]
      | Elastic
    </title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Elasticsearch Reference [5.x]" /><link rel="up" href="search-aggregations-metrics.html" title="Metrics Aggregations" /><link rel="prev" href="search-aggregations-metrics-avg-aggregation.html" title="Avg Aggregation" /><link rel="next" href="search-aggregations-metrics-extendedstats-aggregation.html" title="Extended Stats Aggregation" /><meta xmlns="" name="description" content="Get started with the documentation for Elasticsearch, Kibana, Logstash, Beats, X-Pack, Elastic Cloud, Elasticsearch for Apache Hadoop, and our language clients." /><meta xmlns="" name="DC.type" content="Docs/Elasticsearch/Reference/5.x" /></head><body><div xmlns="" class="page_header">You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div><div xmlns="" class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">Elasticsearch Reference
      [5.x]
    </a></span> » <span class="breadcrumb-link"><a href="search-aggregations.html">Aggregations</a></span> » <span class="breadcrumb-link"><a href="search-aggregations-metrics.html">Metrics Aggregations</a></span> » <span class="breadcrumb-node">Cardinality Aggregation</span></div><div xmlns="" class="navheader"><span class="prev"><a href="search-aggregations-metrics-avg-aggregation.html">
              « 
              Avg Aggregation</a>
           
        </span><span class="next">
           
          <a href="search-aggregations-metrics-extendedstats-aggregation.html">Extended Stats Aggregation
               »
            </a></span></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="search-aggregations-metrics-cardinality-aggregation"></a>Cardinality Aggregation<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/5.x/docs/reference/aggregations/metrics/cardinality-aggregation.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h2></div></div></div><p>A <code class="literal">single-value</code> metrics aggregation that calculates an approximate count of
distinct values. Values can be extracted either from specific fields in the
document or generated by a script.</p><p>Assume you are indexing books and would like to count the unique authors that
match a query:</p><div xmlns="" class="pre_wrapper"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-js">{
    "aggs" : {
        "author_count" : {
            "cardinality" : {
                "field" : "author"
            }
        }
    }
}</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_precision_control"></a>Precision control<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/5.x/docs/reference/aggregations/metrics/cardinality-aggregation.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>This aggregation also supports the <code class="literal">precision_threshold</code> option:</p><div xmlns="" class="warning admon"><div class="icon"><img alt="Warning" src="images/icons/warning.png" /></div><div class="admon_content">
The precision_threshold option is specific to the current internal implementation of the cardinality agg, which may change in the future
</div></div><div xmlns="" class="pre_wrapper"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-js">{
    "aggs" : {
        "author_count" : {
            "cardinality" : {
                "field" : "author_hash",
                "precision_threshold": 100 <a id="CO46-1"></a><span xmlns=""><img src="images/icons/callouts/1.png" alt="" /></span>
            }
        }
    }
}</pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO46-1"><span xmlns=""><img src="images/icons/callouts/1.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
The <code class="literal">precision_threshold</code> options allows to trade memory for accuracy, and
defines a unique count below which counts are expected to be close to
accurate. Above this value, counts might become a bit more fuzzy. The maximum
supported value is 40000, thresholds above this number will have the same
effect as a threshold of 40000. The default values is <code class="literal">3000</code>.
</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_counts_are_approximate"></a>Counts are approximate<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/5.x/docs/reference/aggregations/metrics/cardinality-aggregation.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>Computing exact counts requires loading values into a hash set and returning its
size. This doesn’t scale when working on high-cardinality sets and/or large
values as the required memory usage and the need to communicate those
per-shard sets between nodes would utilize too many resources of the cluster.</p><p>This <code class="literal">cardinality</code> aggregation is based on the
<a class="ulink" href="http://static.googleusercontent.com/media/research.google.com/fr//pubs/archive/40671.pdf" target="_top">HyperLogLog++</a>
algorithm, which counts based on the hashes of the values with some interesting
properties:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
configurable precision, which decides on how to trade memory for accuracy,
</li><li class="listitem">
excellent accuracy on low-cardinality sets,
</li><li class="listitem">
fixed memory usage: no matter if there are tens or billions of unique values,
   memory usage only depends on the configured precision.
</li></ul></div><p>For a precision threshold of <code class="literal">c</code>, the implementation that we are using requires
about <code class="literal">c * 8</code> bytes.</p><p>The following chart shows how the error varies before and after the threshold:</p><p><span class="inlinemediaobject"><img src="images/cardinality_error.png" alt="images/cardinality_error.png" /></span></p><p>For all 3 thresholds, counts have been accurate up to the configured threshold
(although not guaranteed, this is likely to be the case). Please also note that
even with a threshold as low as 100, the error remains very low, even when
counting millions of items.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_pre_computed_hashes"></a>Pre-computed hashes<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/5.x/docs/reference/aggregations/metrics/cardinality-aggregation.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>On string fields that have a high cardinality, it might be faster to store the
hash of your field values in your index and then run the cardinality aggregation
on this field. This can either be done by providing hash values from client-side
or by letting elasticsearch compute hash values for you by using the
<a class="ulink" href="https://www.elastic.co/guide/en/elasticsearch/plugins/5.x/mapper-murmur3.html" target="_top"><code class="literal">mapper-murmur3</code></a> plugin.</p><div xmlns="" class="note admon"><div class="icon"><img alt="Note" src="images/icons/note.png" /></div><div class="admon_content"><p xmlns="http://www.w3.org/1999/xhtml">Pre-computing hashes is usually only useful on very large and/or
high-cardinality fields as it saves CPU and memory. However, on numeric
fields, hashing is very fast and storing the original values requires as much
or less memory than storing the hashes. This is also true on low-cardinality
string fields, especially given that those have an optimization in order to
make sure that hashes are computed at most once per unique value per segment.</p></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_script_2"></a>Script<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/5.x/docs/reference/aggregations/metrics/cardinality-aggregation.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>The <code class="literal">cardinality</code> metric supports scripting, with a noticeable performance hit
however since hashes need to be computed on the fly.</p><div xmlns="" class="pre_wrapper"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-js">{
    "aggs" : {
        "author_count" : {
            "cardinality" : {
                "script": {
                    "lang": "painless",
                    "inline": "doc['author.first_name'].value + ' ' + doc['author.last_name'].value"
                }
            }
        }
    }
}</pre></div><p>This will interpret the <code class="literal">script</code> parameter as an <code class="literal">inline</code> script with the <code class="literal">painless</code> script language and no script parameters. To use a file script use the following syntax:</p><div xmlns="" class="pre_wrapper"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-js">{
    "aggs" : {
        "author_count" : {
            "cardinality" : {
                "script" : {
                    "file": "my_script",
                    "params": {
                        "first_name_field": "author.first_name",
                        "last_name_field": "author.last_name"
                    }
                }
            }
        }
    }
}</pre></div><div xmlns="" class="tip admon"><div class="icon"><img alt="Tip" src="images/icons/tip.png" /></div><div class="admon_content"><p xmlns="http://www.w3.org/1999/xhtml">for indexed scripts replace the <code class="literal">file</code> parameter with an <code class="literal">id</code> parameter.</p></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_missing_value_2"></a>Missing value<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/5.x/docs/reference/aggregations/metrics/cardinality-aggregation.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>The <code class="literal">missing</code> parameter defines how documents that are missing a value should be treated.
By default they will be ignored but it is also possible to treat them as if they
had a value.</p><div xmlns="" class="pre_wrapper"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-js">{
    "aggs" : {
        "tag_cardinality" : {
            "cardinality" : {
                "field" : "tag",
                "missing": "N/A" <a id="CO47-1"></a><span xmlns=""><img src="images/icons/callouts/1.png" alt="" /></span>
            }
        }
    }
}</pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO47-1"><span xmlns=""><img src="images/icons/callouts/1.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
Documents without a value in the <code class="literal">tag</code> field will fall into the same bucket as documents that have the value <code class="literal">N/A</code>.
</p></td></tr></table></div></div></div><div xmlns="" class="navfooter"><span class="prev"><a href="search-aggregations-metrics-avg-aggregation.html">
              « 
              Avg Aggregation</a>
           
        </span><span class="next">
           
          <a href="search-aggregations-metrics-extendedstats-aggregation.html">Extended Stats Aggregation
               »
            </a></span></div></body></html>
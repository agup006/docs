<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title xmlns="">Derivative Aggregation
        | Elasticsearch Reference [5.1]
      | Elastic
    </title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Elasticsearch Reference [5.1]" /><link rel="up" href="search-aggregations-pipeline.html" title="Pipeline Aggregations" /><link rel="prev" href="search-aggregations-pipeline-avg-bucket-aggregation.html" title="Avg Bucket Aggregation" /><link rel="next" href="search-aggregations-pipeline-max-bucket-aggregation.html" title="Max Bucket Aggregation" /><meta xmlns="" name="description" content="Get started with the documentation for Elasticsearch, Kibana, Logstash, Beats, X-Pack, Elastic Cloud, Elasticsearch for Apache Hadoop, and our language clients." /><meta xmlns="" name="DC.type" content="Docs/Elasticsearch/Reference/5.1" /></head><body><div xmlns="" class="page_header">You are looking at documentation for an older release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div><div xmlns="" class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">Elasticsearch Reference
      [5.1]
    </a></span> » <span class="breadcrumb-link"><a href="search-aggregations.html">Aggregations</a></span> » <span class="breadcrumb-link"><a href="search-aggregations-pipeline.html">Pipeline Aggregations</a></span> » <span class="breadcrumb-node">Derivative Aggregation</span></div><div xmlns="" class="navheader"><span class="prev"><a href="search-aggregations-pipeline-avg-bucket-aggregation.html">
              « 
              Avg Bucket Aggregation</a>
           
        </span><span class="next">
           
          <a href="search-aggregations-pipeline-max-bucket-aggregation.html">Max Bucket Aggregation
               »
            </a></span></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="search-aggregations-pipeline-derivative-aggregation"></a>Derivative Aggregation<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/5.1/docs/reference/aggregations/pipeline/derivative-aggregation.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h2></div></div></div><div xmlns="" class="warning admon"><div class="icon"><img alt="Warning" src="images/icons/warning.png" /></div><div class="admon_content"><p>This functionality is experimental and may be changed or removed completely in a future release. Elastic will take a best effort approach to fix any issues, but experimental features are not subject to the support SLA of official GA features.</p></div></div><p>A parent pipeline aggregation which calculates the derivative of a specified metric in a parent histogram (or date_histogram)
aggregation. The specified metric must be numeric and the enclosing histogram must have <code class="literal">min_doc_count</code> set to <code class="literal">0</code> (default
for <code class="literal">histogram</code> aggregations).</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_syntax_2"></a>Syntax<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/5.1/docs/reference/aggregations/pipeline/derivative-aggregation.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>A <code class="literal">derivative</code> aggregation looks like this in isolation:</p><div xmlns="" class="pre_wrapper"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-js">"derivative": {
  "buckets_path": "the_sum"
}</pre></div><div class="table"><a id="id-1.8.5.41.4.4"></a><p class="title"><strong>Table 2. <code class="literal">derivative</code> Parameters</strong></p><div class="table-contents"><table summary="derivative Parameters" cellpadding="4px" border="1"><colgroup><col class="col_1" /><col class="col_2" /><col class="col_3" /><col class="col_4" /></colgroup><tbody><tr><td align="left" valign="top"><p>Parameter Name</p></td><td align="left" valign="top"><p>Description</p></td><td align="left" valign="top"><p>Required</p></td><td align="left" valign="top"><p>Default Value</p></td></tr><tr><td align="left" valign="top"><p><code class="literal">buckets_path</code></p></td><td align="left" valign="top"><p>The path to the buckets we wish to find the derivative for (see <a class="xref" href="search-aggregations-pipeline.html#buckets-path-syntax" title="buckets_path Syntaxedit">the section called “<code class="literal">buckets_path</code> Syntax<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/5.1/docs/reference/aggregations/pipeline.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a>”</a> for more
 details)</p></td><td align="left" valign="top"><p>Required</p></td><td align="left" valign="top"><p></p></td></tr><tr><td align="left" valign="top"><p><code class="literal">gap_policy</code></p></td><td align="left" valign="top"><p>The policy to apply when gaps are found in the data (see <a class="xref" href="search-aggregations-pipeline.html#gap-policy" title="Dealing with gaps in the dataedit">the section called “Dealing with gaps in the data<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/5.1/docs/reference/aggregations/pipeline.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a>”</a> for more
 details)</p></td><td align="left" valign="top"><p>Optional, defaults to <code class="literal">skip</code></p></td><td align="left" valign="top"><p></p></td></tr><tr><td align="left" valign="top"><p><code class="literal">format</code></p></td><td align="left" valign="top"><p>format to apply to the output value of this aggregation</p></td><td align="left" valign="top"><p>Optional, defaults to <code class="literal">null</code></p></td><td align="left" valign="top"><p></p></td></tr></tbody></table></div></div><br class="table-break" /></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_first_order_derivative"></a>First Order Derivative<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/5.1/docs/reference/aggregations/pipeline/derivative-aggregation.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>The following snippet calculates the derivative of the total monthly <code class="literal">sales</code>:</p><div xmlns="" class="pre_wrapper"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-js">POST /sales/_search
{
    "size": 0,
    "aggs" : {
        "sales_per_month" : {
            "date_histogram" : {
                "field" : "date",
                "interval" : "month"
            },
            "aggs": {
                "sales": {
                    "sum": {
                        "field": "price"
                    }
                },
                "sales_deriv": {
                    "derivative": {
                        "buckets_path": "sales" <a id="CO97-1"></a><span xmlns=""><img src="images/icons/callouts/1.png" alt="" /></span>
                    }
                }
            }
        }
    }
}</pre></div><div xmlns="" class="console_widget" data-snippet=":CONSOLE:"></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO97-1"><span xmlns=""><img src="images/icons/callouts/1.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
<code class="literal">buckets_path</code> instructs this derivative aggregation to use the output of the <code class="literal">sales</code> aggregation for the derivative
</p></td></tr></table></div><p>And the following may be the response:</p><div xmlns="" class="pre_wrapper"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-js">{
   "took": 11,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "sales_per_month": {
         "buckets": [
            {
               "key_as_string": "2015/01/01 00:00:00",
               "key": 1420070400000,
               "doc_count": 3,
               "sales": {
                  "value": 550.0
               } <a id="CO98-1"></a><span xmlns=""><img src="images/icons/callouts/1.png" alt="" /></span>
            },
            {
               "key_as_string": "2015/02/01 00:00:00",
               "key": 1422748800000,
               "doc_count": 2,
               "sales": {
                  "value": 60.0
               },
               "sales_deriv": {
                  "value": -490.0 <a id="CO98-2"></a><span xmlns=""><img src="images/icons/callouts/2.png" alt="" /></span>
               }
            },
            {
               "key_as_string": "2015/03/01 00:00:00",
               "key": 1425168000000,
               "doc_count": 2, <a id="CO98-3"></a><span xmlns=""><img src="images/icons/callouts/3.png" alt="" /></span>
               "sales": {
                  "value": 375.0
               },
               "sales_deriv": {
                  "value": 315.0
               }
            }
         ]
      }
   }
}</pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO98-1"><span xmlns=""><img src="images/icons/callouts/1.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
No derivative for the first bucket since we need at least 2 data points to calculate the derivative
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO98-2"><span xmlns=""><img src="images/icons/callouts/2.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
Derivative value units are implicitly defined by the <code class="literal">sales</code> aggregation and the parent histogram so in this case the units
would be $/month assuming the <code class="literal">price</code> field has units of $.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO98-3"><span xmlns=""><img src="images/icons/callouts/3.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
The number of documents in the bucket are represented by the <code class="literal">doc_count</code> f
</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_second_order_derivative"></a>Second Order Derivative<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/5.1/docs/reference/aggregations/pipeline/derivative-aggregation.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>A second order derivative can be calculated by chaining the derivative pipeline aggregation onto the result of another derivative
pipeline aggregation as in the following example which will calculate both the first and the second order derivative of the total
monthly sales:</p><div xmlns="" class="pre_wrapper"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-js">POST /sales/_search
{
    "size": 0,
    "aggs" : {
        "sales_per_month" : {
            "date_histogram" : {
                "field" : "date",
                "interval" : "month"
            },
            "aggs": {
                "sales": {
                    "sum": {
                        "field": "price"
                    }
                },
                "sales_deriv": {
                    "derivative": {
                        "buckets_path": "sales"
                    }
                },
                "sales_2nd_deriv": {
                    "derivative": {
                        "buckets_path": "sales_deriv" <a id="CO99-1"></a><span xmlns=""><img src="images/icons/callouts/1.png" alt="" /></span>
                    }
                }
            }
        }
    }
}</pre></div><div xmlns="" class="console_widget" data-snippet=":CONSOLE:"></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO99-1"><span xmlns=""><img src="images/icons/callouts/1.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
<code class="literal">buckets_path</code> for the second derivative points to the name of the first derivative
</p></td></tr></table></div><p>And the following may be the response:</p><div xmlns="" class="pre_wrapper"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-js">{
   "took": 50,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "sales_per_month": {
         "buckets": [
            {
               "key_as_string": "2015/01/01 00:00:00",
               "key": 1420070400000,
               "doc_count": 3,
               "sales": {
                  "value": 550.0
               } <a id="CO100-1"></a><span xmlns=""><img src="images/icons/callouts/1.png" alt="" /></span>
            },
            {
               "key_as_string": "2015/02/01 00:00:00",
               "key": 1422748800000,
               "doc_count": 2,
               "sales": {
                  "value": 60.0
               },
               "sales_deriv": {
                  "value": -490.0
               } <a id="CO100-2"></a><span xmlns=""><img src="images/icons/callouts/2.png" alt="" /></span>
            },
            {
               "key_as_string": "2015/03/01 00:00:00",
               "key": 1425168000000,
               "doc_count": 2,
               "sales": {
                  "value": 375.0
               },
               "sales_deriv": {
                  "value": 315.0
               },
               "sales_2nd_deriv": {
                  "value": 805.0
               }
            }
         ]
      }
   }
}</pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO100-1"><span xmlns=""><img src="images/icons/callouts/1.png" alt="" /></span></a> <a href="#CO100-2"><span xmlns=""><img src="images/icons/callouts/2.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
No second derivative for the first two buckets since we need at least 2 data points from the first derivative to calculate the
second derivative
</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_units"></a>Units<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/5.1/docs/reference/aggregations/pipeline/derivative-aggregation.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>The derivative aggregation allows the units of the derivative values to be specified. This returns an extra field in the response
<code class="literal">normalized_value</code> which reports the derivative value in the desired x-axis units.  In the below example we calculate the derivative
of the total sales per month but ask for the derivative of the sales as in the units of sales per day:</p><div xmlns="" class="pre_wrapper"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-js">POST /sales/_search
{
    "size": 0,
    "aggs" : {
        "sales_per_month" : {
            "date_histogram" : {
                "field" : "date",
                "interval" : "month"
            },
            "aggs": {
                "sales": {
                    "sum": {
                        "field": "price"
                    }
                },
                "sales_deriv": {
                    "derivative": {
                        "buckets_path": "sales",
                        "unit": "day" <a id="CO101-1"></a><span xmlns=""><img src="images/icons/callouts/1.png" alt="" /></span>
                    }
                }
            }
        }
    }
}</pre></div><div xmlns="" class="console_widget" data-snippet=":CONSOLE:"></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO101-1"><span xmlns=""><img src="images/icons/callouts/1.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
<code class="literal">unit</code> specifies what unit to use for the x-axis of the derivative calculation
</p></td></tr></table></div><p>And the following may be the response:</p><div xmlns="" class="pre_wrapper"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-js">{
   "took": 50,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "sales_per_month": {
         "buckets": [
            {
               "key_as_string": "2015/01/01 00:00:00",
               "key": 1420070400000,
               "doc_count": 3,
               "sales": {
                  "value": 550.0
               } <a id="CO102-1"></a><span xmlns=""><img src="images/icons/callouts/1.png" alt="" /></span>
            },
            {
               "key_as_string": "2015/02/01 00:00:00",
               "key": 1422748800000,
               "doc_count": 2,
               "sales": {
                  "value": 60.0
               },
               "sales_deriv": {
                  "value": -490.0, <a id="CO102-2"></a><span xmlns=""><img src="images/icons/callouts/2.png" alt="" /></span>
                  "normalized_value": -15.806451612903226 <a id="CO102-3"></a><span xmlns=""><img src="images/icons/callouts/3.png" alt="" /></span>
               }
            },
            {
               "key_as_string": "2015/03/01 00:00:00",
               "key": 1425168000000,
               "doc_count": 2,
               "sales": {
                  "value": 375.0
               },
               "sales_deriv": {
                  "value": 315.0,
                  "normalized_value": 11.25
               }
            }
         ]
      }
   }
}</pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO102-1"><span xmlns=""><img src="images/icons/callouts/1.png" alt="" /></span></a> <a href="#CO102-2"><span xmlns=""><img src="images/icons/callouts/2.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
<code class="literal">value</code> is reported in the original units of <span class="emphasis"><em>per month</em></span>
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO102-3"><span xmlns=""><img src="images/icons/callouts/3.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
<code class="literal">normalized_value</code> is reported in the desired units of <span class="emphasis"><em>per day</em></span>
</p></td></tr></table></div></div></div><div xmlns="" class="navfooter"><span class="prev"><a href="search-aggregations-pipeline-avg-bucket-aggregation.html">
              « 
              Avg Bucket Aggregation</a>
           
        </span><span class="next">
           
          <a href="search-aggregations-pipeline-max-bucket-aggregation.html">Max Bucket Aggregation
               »
            </a></span></div></body></html>
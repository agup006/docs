<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title xmlns="">Diversified Sampler Aggregation
        | Elasticsearch Reference [5.1]
      | Elastic
    </title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Elasticsearch Reference [5.1]" /><link rel="up" href="search-aggregations-bucket.html" title="Bucket Aggregations" /><link rel="prev" href="search-aggregations-bucket-daterange-aggregation.html" title="Date Range Aggregation" /><link rel="next" href="search-aggregations-bucket-filter-aggregation.html" title="Filter Aggregation" /><meta xmlns="" name="description" content="Get started with the documentation for Elasticsearch, Kibana, Logstash, Beats, X-Pack, Elastic Cloud, Elasticsearch for Apache Hadoop, and our language clients." /><meta xmlns="" name="DC.type" content="Docs/Elasticsearch/Reference/5.1" /></head><body><div xmlns="" class="page_header">You are looking at documentation for an older release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div><div xmlns="" class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">Elasticsearch Reference
      [5.1]
    </a></span> » <span class="breadcrumb-link"><a href="search-aggregations.html">Aggregations</a></span> » <span class="breadcrumb-link"><a href="search-aggregations-bucket.html">Bucket Aggregations</a></span> » <span class="breadcrumb-node">Diversified Sampler Aggregation</span></div><div xmlns="" class="navheader"><span class="prev"><a href="search-aggregations-bucket-daterange-aggregation.html">
              « 
              Date Range Aggregation</a>
           
        </span><span class="next">
           
          <a href="search-aggregations-bucket-filter-aggregation.html">Filter Aggregation
               »
            </a></span></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="search-aggregations-bucket-diversified-sampler-aggregation"></a>Diversified Sampler Aggregation<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/5.1/docs/reference/aggregations/bucket/diversified-sampler-aggregation.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h2></div></div></div><div xmlns="" class="warning admon"><div class="icon"><img alt="Warning" src="images/icons/warning.png" /></div><div class="admon_content"><p>This functionality is experimental and may be changed or removed completely in a future release. Elastic will take a best effort approach to fix any issues, but experimental features are not subject to the support SLA of official GA features.</p></div></div><p>A filtering aggregation used to limit any sub aggregations' processing to a sample of the top-scoring documents. Diversity settings are
used to limit the number of matches that share a common value such as an "author".</p><div class="itemizedlist"><p class="title"><strong>Example use cases:</strong></p><ul class="itemizedlist" type="disc"><li class="listitem">
Tightening the focus of analytics to high-relevance matches rather than the potentially very long tail of low-quality matches
</li><li class="listitem">
Removing bias from analytics by ensuring fair representation of content from different sources
</li><li class="listitem">
Reducing the running cost of aggregations that can produce useful results using only samples e.g. <code class="literal">significant_terms</code>
</li></ul></div><p>Example:</p><div xmlns="" class="pre_wrapper"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-js">{
    "query": {
        "match": {
            "text": "iphone"
        }
    },
    "aggs": {
        "sample": {
            "diversified_sampler": {
                "shard_size": 200,
                "field" : "user.id"
            },
            "aggs": {
                "keywords": {
                    "significant_terms": {
                        "field": "text"
                    }
                }
            }
        }
    }
}</pre></div><p>Response:</p><div xmlns="" class="pre_wrapper"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-js">{
    ...
        "aggregations": {
        "sample": {
            "doc_count": 1000,<a id="CO76-1"></a><span xmlns=""><img src="images/icons/callouts/1.png" alt="" /></span>
            "keywords": {<a id="CO76-2"></a><span xmlns=""><img src="images/icons/callouts/2.png" alt="" /></span>
                "doc_count": 1000,
                "buckets": [
                    ...
                    {
                        "key": "bend",
                        "doc_count": 58,
                        "score": 37.982536582524276,
                        "bg_count": 103
                    },
                    ....
}</pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO76-1"><span xmlns=""><img src="images/icons/callouts/1.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
1000 documents were sampled in total because we asked for a maximum of 200 from an index with 5 shards. The cost of performing the nested significant_terms aggregation was therefore limited rather than unbounded.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO76-2"><span xmlns=""><img src="images/icons/callouts/2.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
The results of the significant_terms aggregation are not skewed by any single over-active Twitter user because we asked for a maximum of one tweet from any one user in our sample.
</p></td></tr></table></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_shard_size"></a>shard_size<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/5.1/docs/reference/aggregations/bucket/diversified-sampler-aggregation.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>The <code class="literal">shard_size</code> parameter limits how many top-scoring documents are collected in the sample processed on each shard.
The default value is 100.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_controlling_diversity"></a>Controlling diversity<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/5.1/docs/reference/aggregations/bucket/diversified-sampler-aggregation.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>=<code class="literal">field</code> or <code class="literal">script</code> and <code class="literal">max_docs_per_value</code> settings are used to control the maximum number of documents collected on any one shard which share a common value.
The choice of value (e.g. <code class="literal">author</code>) is loaded from a regular <code class="literal">field</code> or derived dynamically by a <code class="literal">script</code>.</p><p>The aggregation will throw an error if the choice of field or script produces multiple values for a document.
It is currently not possible to offer this form of de-duplication using many values, primarily due to concerns over efficiency.</p><div xmlns="" class="note admon"><div class="icon"><img alt="Note" src="images/icons/note.png" /></div><div class="admon_content"><p xmlns="http://www.w3.org/1999/xhtml">Any good market researcher will tell you that when working with samples of data it is important
that the sample represents a healthy variety of opinions rather than being skewed by any single voice.
The same is true with aggregations and sampling with these diversify settings can offer a way to remove the bias in your content (an over-populated geography, a large spike in a timeline or an over-active forum spammer).</p></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_field"></a>Field<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/5.1/docs/reference/aggregations/bucket/diversified-sampler-aggregation.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>Controlling diversity using a field:</p><div xmlns="" class="pre_wrapper"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-js">{
    "aggs" : {
        "sample" : {
            "diversified_sampler" : {
                "field" : "author",
                "max_docs_per_value" : 3
            }
        }
    }
}</pre></div><p>Note that the <code class="literal">max_docs_per_value</code> setting applies on a per-shard basis only for the purposes of shard-local sampling.
It is not intended as a way of providing a global de-duplication feature on search results.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_script_11"></a>Script<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/5.1/docs/reference/aggregations/bucket/diversified-sampler-aggregation.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>Controlling diversity using a script:</p><div xmlns="" class="pre_wrapper"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-js">{
    "aggs" : {
        "sample" : {
            "diversified_sampler" : {
                "script" : {
                    "lang" : "painless",
                    "inline" : "doc['author'].value + '/' + doc['genre'].value"
                }
            }
        }
    }
}</pre></div><p>Note in the above example we chose to use the default <code class="literal">max_docs_per_value</code> setting of 1 and combine author and genre fields to ensure
each shard sample has, at most, one match for an author/genre pair.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_execution_hint"></a>execution_hint<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/5.1/docs/reference/aggregations/bucket/diversified-sampler-aggregation.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>When using the settings to control diversity, the optional <code class="literal">execution_hint</code> setting can influence the management of the values used for de-duplication.
Each option will hold up to <code class="literal">shard_size</code> values in memory while performing de-duplication but the type of value held can be controlled as follows:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
hold field values directly (<code class="literal">map</code>)
</li><li class="listitem">
hold ordinals of the field as determined by the Lucene index (<code class="literal">global_ordinals</code>)
</li><li class="listitem">
hold hashes of the field values - with potential for hash collisions (<code class="literal">bytes_hash</code>)
</li></ul></div><p>The default setting is to use <code class="literal">global_ordinals</code> if this information is available from the Lucene index and reverting to <code class="literal">map</code> if not.
The <code class="literal">bytes_hash</code> setting may prove faster in some cases but introduces the possibility of false positives in de-duplication logic due to the possibility of hash collisions.
Please note that Elasticsearch will ignore the choice of execution hint if it is not applicable and that there is no backward compatibility guarantee on these hints.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_limitations_2"></a>Limitations<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/5.1/docs/reference/aggregations/bucket/diversified-sampler-aggregation.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_cannot_be_nested_under_literal_breadth_first_literal_aggregations"></a>Cannot be nested under <code class="literal">breadth_first</code> aggregations<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/5.1/docs/reference/aggregations/bucket/diversified-sampler-aggregation.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4></div></div></div><p>Being a quality-based filter the sampler aggregation needs access to the relevance score produced for each document.
It therefore cannot be nested under a <code class="literal">terms</code> aggregation which has the <code class="literal">collect_mode</code> switched from the default <code class="literal">depth_first</code> mode to <code class="literal">breadth_first</code> as this discards scores.
In this situation an error will be thrown.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_limited_de_dup_logic"></a>Limited de-dup logic.<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/5.1/docs/reference/aggregations/bucket/diversified-sampler-aggregation.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4></div></div></div><p>The de-duplication logic in the diversify settings applies only at a shard level so will not apply across shards.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_no_specialized_syntax_for_geo_date_fields"></a>No specialized syntax for geo/date fields<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/5.1/docs/reference/aggregations/bucket/diversified-sampler-aggregation.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4></div></div></div><p>Currently the syntax for defining the diversifying values is defined by a choice of <code class="literal">field</code> or
<code class="literal">script</code> - there is no added syntactical sugar for expressing geo or date units such as "7d" (7
days). This support may be added in a later release and users will currently have to create these
sorts of values using a script.</p></div></div></div><div xmlns="" class="navfooter"><span class="prev"><a href="search-aggregations-bucket-daterange-aggregation.html">
              « 
              Date Range Aggregation</a>
           
        </span><span class="next">
           
          <a href="search-aggregations-bucket-filter-aggregation.html">Filter Aggregation
               »
            </a></span></div></body></html>
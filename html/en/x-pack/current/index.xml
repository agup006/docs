<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE book PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd">
<?asciidoc-toc?>
<?asciidoc-numbered?>

<book lang="en">
<bookinfo>
    <title>X-Pack for the Elastic Stack</title>
</bookinfo>
<chapter id="xpack-introduction">
<title>Introduction<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-introduction.asciidoc">Edit me</ulink></title>
<simpara>X-Pack is an Elastic Stack extension that bundles security, alerting, monitoring, reporting, and
graph capabilities into one easy-to-install package. While the X-Pack components are designed to work
together seamlessly, you can easily enable or disable the features you want to use.</simpara>
<simpara>Prior to Elasticsearch 5.0.0, you had to install separate Shield, Watcher, and Marvel plugins
to get the features that are bundled together in X-Pack. With X-Pack, you no longer have to
worry about whether or not you have the right version of each plugin, just install the X-Pack
for the Elasticsearch version you&#8217;re running, and you&#8217;re good to go!</simpara>
<bridgehead id="_where_to_go_next" renderas="sect2">Where to Go Next<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-introduction.asciidoc">Edit me</ulink></bridgehead>
<itemizedlist>
<listitem>
<simpara>
<link linkend="installing-xpack">Installing X-Pack</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="security-getting-started">Getting Started with Security</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="monitoring-getting-started">Getting Started with Monitoring</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="watcher-getting-started">Getting Started with Alerting and Notification</link>
<remark> * &lt;&lt;reporting-getting-started, Getting Started with Reporting&gt;&gt;</remark>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="graph-getting-started">Getting Started with Graph</link>
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_have_comments_questions_or_feedback" renderas="sect2">Have Comments, Questions, or Feedback?<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-introduction.asciidoc">Edit me</ulink></bridgehead>
<simpara>Head over to our discussion forums to share you experience, questions, and
suggestions:</simpara>
<itemizedlist>
<listitem>
<simpara>
<ulink url="https://discuss.elastic.co/c/shield">Security Discussion Forum</ulink>
</simpara>
</listitem>
<listitem>
<simpara>
<ulink url="https://discuss.elastic.co/c/marvel">Monitoring Discussion Forum</ulink>
</simpara>
</listitem>
<listitem>
<simpara>
<ulink url="https://discuss.elastic.co/c/watcher">Alerting &amp; Notification Discussion Forum</ulink>
</simpara>
</listitem>
<listitem>
<simpara>
<ulink url="https://discuss.elastic.co/c/graph">Graph Discussion Forum</ulink>
</simpara>
</listitem>
</itemizedlist>
</chapter>
<chapter id="installing-xpack">
<title>Installing X-Pack<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-installing.asciidoc">Edit me</ulink></title>
<simpara>To use X-Pack for Elasticsearch and Kibana, you need:</simpara>
<itemizedlist>
<listitem>
<simpara>
Elasticsearch 5.0.1 - <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/_installation.html">Installing Elasticsearch</ulink>
</simpara>
</listitem>
<listitem>
<simpara>
Kibana 5.0.1 -  <ulink url="http://www.elastic.co/guide/en/kibana/5.0/setup.html">Getting Kibana Up and Running</ulink>
</simpara>
</listitem>
</itemizedlist>
<important><simpara>You must run the version of X-Pack that matches the version of
            Elasticsearch you are running.</simpara></important>
<simpara>To install X-Pack:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Run <literal>bin/elasticsearch-plugin install</literal> from <literal>ES_HOME</literal> on each node in your cluster:
</simpara>
<programlisting language="shell" linenumbering="unnumbered">bin/elasticsearch-plugin install x-pack</programlisting>
<note><simpara>If you are using a <link linkend="xpack-package-installation">DEB/RPM distribution</link>
      of Elasticsearch, run the installation with superuser permissions. To
      perform an offline installation, <link linkend="xpack-installing-offline">download the X-Pack binaries</link>.</simpara></note>
</listitem>
<listitem>
<simpara>
Confirm that you want to grant X-Pack additional permissions. X-Pack needs
these permissions to set the threat context loader during install so Watcher can
send email notifications.
</simpara>
<programlisting language="shell" linenumbering="unnumbered">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@     WARNING: plugin requires additional permissions     @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
* java.lang.RuntimePermission accessClassInPackage.com.sun.activation.registries
* java.lang.RuntimePermission getClassLoader
* java.lang.RuntimePermission setContextClassLoader
* java.lang.RuntimePermission setFactory
* java.security.SecurityPermission createPolicy.JavaPolicy
* java.security.SecurityPermission getPolicy
* java.security.SecurityPermission putProviderProperty.BC
* java.security.SecurityPermission setPolicy
* java.util.PropertyPermission * read,write
* java.util.PropertyPermission sun.nio.ch.bugLevel write
* javax.net.ssl.SSLPermission setHostnameVerifier
See http://docs.oracle.com/javase/8/docs/technotes/guides/security/permissions.html
for descriptions of what these permissions allow and the associated risks.

Continue with installation? [y/N]y</programlisting>
<tip><simpara>Specify the <literal>--batch</literal> option when running the install command to
      automatically grant these permissions and bypass this install prompt.</simpara></tip>
</listitem>
<listitem>
<simpara>
If you have disabled automatic index creation in Elasticsearch, configure
<ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/docs-index_.html#index-creation"><literal>action.auto_create_index</literal></ulink> in
<literal>elasticsearch.yml</literal> to allow X-Pack to create the following indices:
</simpara>
<programlisting language="yaml" linenumbering="unnumbered">action.auto_create_index: .security,.monitoring*,.watches,.triggered_watches,.watcher-history*</programlisting>
</listitem>
<listitem>
<simpara>
Start Elasticsearch.
</simpara>
<programlisting language="shell" linenumbering="unnumbered">bin/elasticsearch</programlisting>
</listitem>
<listitem>
<simpara>
Install X-Pack into <ulink url="http://www.elastic.co/guide/en/kibana/5.0/setup.html">Kibana</ulink> by running
<literal>bin/kibana-plugin</literal> in your Kibana installation directory.
</simpara>
<programlisting language="shell" linenumbering="unnumbered">bin/kibana-plugin install x-pack</programlisting>
</listitem>
<listitem>
<simpara>
Start Kibana.
</simpara>
<programlisting language="shell" linenumbering="unnumbered">bin/kibana</programlisting>
</listitem>
</orderedlist>
<simpara>To verify X-Pack installation, point your web browser at <literal>http://localhost:5601/</literal>
to open Kibana. You should be prompted to log in to Kibana. To log in, you can
use the built-in <literal>elastic</literal> user and the password <literal>changeme</literal>.</simpara>
<important>
<simpara>SSL/TLS encryption is disabled by default, which means user credentials are
passed in the clear. <emphasis role="strong">Do not deploy to production without enabling encryption!</emphasis>
For more information, see <link linkend="encrypting-communications">Encrypting Communications</link>.</simpara>
<simpara>You must also <emphasis role="strong">change the passwords for the built-in <literal>elastic</literal> user and the
<literal>kibana</literal> user that enables Kibana to communicate with elasticsearch before
deploying to production</emphasis>. See <link linkend="built-in-users">Built-in Users</link> for more information.</simpara>
</important>
<bridgehead id="xpack-package-installation" renderas="sect2">Installing X-Pack on a DEB/RPM Package Installation<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-installing.asciidoc">Edit me</ulink></bridgehead>
<simpara>If you use the DEB/RPM packages to install Elasticsearch, by default Elasticsearch
is installed in <literal>/usr/share/elasticsearch</literal> and the configuration files are stored
in <literal>/etc/elasticsearch</literal>. (For the complete list of default paths, see
<ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/deb.html#deb-layout">Debian Directory Layout</ulink> and
<ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/rpm.html#rpm-layout">RPM Directory Layout</ulink> in the Elasticsearch Reference.)</simpara>
<simpara>To install X-Pack on a DEB/RPM package installation, you need to run
<literal>bin/plugin install</literal> from the <literal>/usr/share/elasticsearch</literal> directory with superuser
permissions:</simpara>
<programlisting language="shell" linenumbering="unnumbered">cd /usr/share/elasticsearch
sudo bin/elasticsearch-plugin install x-pack</programlisting>
<note><simpara>If the configuration files are not in <literal>/etc/elasticsearch</literal> you
      need to specify the location of the configuration files by
      setting the system property`es.path.conf` to the config path via
      <literal>ES_JAVA_OPTS="-Des.path.conf=&lt;path&gt;"</literal> or by setting the
      environment variable <literal>CONF_DIR</literal> via <literal>CONF_DIR=&lt;path&gt;</literal>.</simpara></note>
<bridgehead id="xpack-installing-offline" renderas="sect2">Installing X-Pack on Offline Machines<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-installing.asciidoc">Edit me</ulink></bridgehead>
<simpara>The <literal>bin/elasticsearch-plugin</literal> install script requires direct Internet access
to download and install X-Pack. If your server doesn’t have Internet access, you
can manually download and install X-Pack.</simpara>
<simpara>To install X-Pack on a machine that doesn&#8217;t have Internet access:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Manually download the X-Pack zip file:
<ulink url="https://artifacts.elastic.co/downloads/packs/x-pack/x-pack-5.0.1.zip">
<literal>https://artifacts.elastic.co/downloads/packs/x-pack/x-pack-5.0.1.zip</literal></ulink>
(<ulink url="https://artifacts.elastic.co/downloads/packs/x-pack/x-pack-5.0.1.zip.sha1">sha1</ulink>)
</simpara>
</listitem>
<listitem>
<simpara>
Transfer the zip file to a temporary directory on the offline machine. (Do NOT
put the file in the Elasticsearch plugins directory.)
</simpara>
</listitem>
<listitem>
<simpara>
Run <literal>bin/elasticsearch-plugin install</literal> from the Elasticsearch install directory
and specify the location of the X-Pack zip file. For example:
</simpara>
<programlisting language="sh" linenumbering="unnumbered">bin/elasticsearch-plugin install file:///path/to/file/x-pack-5.0.1.zip</programlisting>
<note><simpara>You must specify an absolute path to the zip file after the <literal>file://</literal> protocol.</simpara></note>
</listitem>
<listitem>
<simpara>
Run <literal>bin/kibana-plugin install</literal> from the Kibana install directory and
specify the location of the X-Pack zip file. (The Elasticsearch and Kibana
plugins are included in the same zip file.) For example:
</simpara>
<programlisting language="sh" linenumbering="unnumbered">bin/kibana-plugin install file:///path/to/file/x-pack-5.0.1.zip</programlisting>
</listitem>
</orderedlist>
<bridgehead id="xpack-enabling" renderas="sect2">Enabling and Disabling X-Pack Features<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-installing.asciidoc">Edit me</ulink></bridgehead>
<simpara>By default, all X-Pack features are enabled. You can explicitly enable or
disable X-Pack features in <literal>elasticsearch.yml</literal> and <literal>kibana.yml</literal>:</simpara>
<informaltable
frame="all"
rowsep="1" colsep="1"
>
<tgroup cols="2">
<colspec colname="col_1" colwidth="50*"/>
<colspec colname="col_2" colwidth="50*"/>
<thead>
<row>
<entry align="left" valign="top"> Setting                           </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>xpack.security.enabled</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Set to <literal>false</literal> to disable X-Pack security.
Configure in both <literal>elasticsearch.yml</literal> and <literal>kibana.yml</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>xpack.monitoring.enabled</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Set to <literal>false</literal> to disable X-Pack monitoring.
Configure in both <literal>elasticsearch.yml</literal> and <literal>kibana.yml</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>xpack.graph.enabled</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Set to <literal>false</literal> to disable X-Pack graph.
Configure in both <literal>elasticsearch.yml</literal> and <literal>kibana.yml</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>xpack.watcher.enabled</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Set to <literal>false</literal> to disable Watcher.
Configure in <literal>elasticsearch.yml</literal> only.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>xpack.reporting.enabled</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Set to <literal>false</literal> to disable X-Pack reporting.
Configure in <literal>kibana.yml</literal> only.</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
<bridgehead id="xpack-upgrading" renderas="sect2">Upgrading X-Pack<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-installing.asciidoc">Edit me</ulink></bridgehead>
<simpara>To upgrade X-Pack:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Stop Elasticsearch.
</simpara>
</listitem>
<listitem>
<simpara>
Uninstall X-Pack from Elasticsearch:
</simpara>
<programlisting language="shell" linenumbering="unnumbered">bin/elasticsearch-plugin remove x-pack</programlisting>
</listitem>
<listitem>
<simpara>
Install the new version of X-Pack into Elasticsearch.
</simpara>
<programlisting language="shell" linenumbering="unnumbered">bin/elasticsearch-plugin install x-pack</programlisting>
</listitem>
<listitem>
<simpara>
Restart Elasticsearch.
</simpara>
<important><simpara>If you&#8217;re upgrading a production cluster, perform a
            <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/rolling-upgrades.html">rolling upgrade</ulink> to ensure recovery is
            as quick as possible. Rolling upgrades are supported when upgrading
            to a new minor version. A full cluster restart is required when
            upgrading to a new major version.</simpara></important>
</listitem>
<listitem>
<simpara>
Uninstall X-Pack from Kibana:
</simpara>
<programlisting language="shell" linenumbering="unnumbered">bin/kibana-plugin remove x-pack</programlisting>
</listitem>
<listitem>
<simpara>
Install the new version of X-Pack into Kibana.
</simpara>
<programlisting language="shell" linenumbering="unnumbered">bin/kibana-plugin install x-pack</programlisting>
</listitem>
<listitem>
<simpara>
Restart Kibana.
</simpara>
</listitem>
</orderedlist>
<bridgehead id="xpack-uninstalling" renderas="sect2">Uninstalling X-Pack<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-installing.asciidoc">Edit me</ulink></bridgehead>
<simpara>To uninstall X-Pack:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Stop Elasticsearch.
</simpara>
</listitem>
<listitem>
<simpara>
Remove X-Pack from Elasticsearch:
</simpara>
<programlisting language="shell" linenumbering="unnumbered">bin/elasticsearch-plugin remove x-pack</programlisting>
</listitem>
<listitem>
<simpara>
Restart Elasticsearch.
</simpara>
</listitem>
<listitem>
<simpara>
Remove X-Pack from Kibana:
</simpara>
<programlisting language="shell" linenumbering="unnumbered">bin/kibana-plugin remove x-pack</programlisting>
</listitem>
<listitem>
<simpara>
Restart Kibana.
</simpara>
</listitem>
</orderedlist>
</chapter>
<chapter id="migrating-to-xpack">
<title>Migrating to X-Pack<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-migrating.asciidoc">Edit me</ulink></title>
<section id="security-migration">
<title>Migrating from Shield<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-migrating.asciidoc">Edit me</ulink></title>
<simpara>With the move to X-Pack, the biggest changes to security functionality are the
names of the security configuration options, TLS/SSL configuration, and how roles
are defined. A few privileges have also been removed. This section describes the
changes you need to make when upgrading from Shield.</simpara>
<simpara>Also, all endpoints have been renamed from <literal>/_shield/XYZ</literal> to <literal>/_xpack/security/XYZ</literal>.</simpara>
<section id="_migrating_settings">
<title>Migrating Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-migrating.asciidoc">Edit me</ulink></title>
<simpara>Most Shield settings have simply had their prefix changes from <literal>shield.</literal> to
<literal>xpack.security.</literal>. Hare a few examples of Shield 2.x settings and their new X-Pack
counterparts:</simpara>
<informaltable
frame="all"
rowsep="1" colsep="1"
>
<tgroup cols="2">
<colspec colname="col_1" colwidth="50*"/>
<colspec colname="col_2" colwidth="50*"/>
<thead>
<row>
<entry align="left" valign="top"> Shield 2.x Setting Name              </entry>
<entry align="left" valign="top"> X-Pack 5.0 Setting Name</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>shield.authc.realms.*</literal></simpara></entry>
<entry align="left" valign="top"><simpara><literal>xpack.security.authc.realms.*</literal></simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>shield.audit.outputs</literal></simpara></entry>
<entry align="left" valign="top"><simpara><literal>xpack.secuirty.audit.outputs</literal></simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
<simpara>Persistent cluster state settings used for <link linkend="ip-filtering">IP Filtering</link> are not automatically migrated to the new names. You will need to
manually migrate these settings.</simpara>
<section id="security-tls-ssl-migrate">
<title>TLS/SSL Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-migrating.asciidoc">Edit me</ulink></title>
<simpara>X-Pack introduces a simpler way of configuring TLS/SSL within your cluster and
as part of this effort, some of the settings have changed or been removed. Also,
new options have been introduced, which includes the ability to more easily
separate default TLS/SSL configurations from the transport configuration.</simpara>
<simpara>There is a hierarchy to TLS/SSL settings in X-Pack, which allows for a simple
configuration for everything or customizations to be applied to individual
components. The X-Pack wide configuration are the settings that being with
<literal>xpack.ssl</literal>. X-Pack security adds configuration for HTTP under the settings
that begin with <literal>xpack.security.http.ssl.</literal> and Transport under the settings that
begin with <literal>xpack.security.transport.ssl.</literal>. Transport profiles can still have
their own configurations with settings that begin with
<literal>transport.profiles.$PROFILE.xpack.security.ssl.</literal> and they will fallback to
the default transport configuration. Realms can also have their own
configurations, which are available as settings that begin with
<literal>xpack.security.authc.realms.$REALM_NAME.ssl.</literal>.</simpara>
<simpara>There is also an important change in terms of how hostname verification is done
by X-Pack security. Previously, a reverse DNS lookup would be made to determine the
name of the address being connected to. This reverse DNS lookup has been removed
and the name/address provided when connecting is used. Please make sure the
the publish host on your nodes is one of the values in the certificate.</simpara>
<simpara>The following settings have been replaced with new settings:</simpara>
<informaltable tabstyle="horizontal" frame="none" colsep="0" rowsep="0"><tgroup cols="2"><colspec colwidth="15*"/><colspec colwidth="85*"/><tbody valign="top">
<row>
<entry>
<simpara>
<literal>shield.ssl</literal>
</simpara>
</entry>
<entry>
<simpara>
Use <literal>xpack.security.transport.ssl.enabled</literal> as a replacement to control whether ssl is enabled or disabled
for node to node and transport client traffic.
</simpara>
</entry>
</row>
<row>
<entry>
<simpara>
<literal>shield.http.ssl</literal>
</simpara>
</entry>
<entry>
<simpara>
Use <literal>xpack.security.http.ssl.enabled</literal> as a replacement to control whether ssl is enabled or disabled for http traffic.
</simpara>
</entry>
</row>
<row>
<entry>
<simpara>
<literal>shield.ssl.ciphers</literal>
</simpara>
</entry>
<entry>
<simpara>
Use <literal>xpack.ssl.cipher_suites</literal> as a replacement to control the default enabled cipher suites.
</simpara>
</entry>
</row>
<row>
<entry>
<simpara>
<literal>shield.ssl.hostname_verification</literal>
</simpara>
</entry>
<entry>
<simpara>
This boolean setting has been replaced by <literal>xpack.ssl.verification_mode</literal> that supports more options as described in the
<link linkend="ssl-tls-settings">ssl settings</link> reference section.
</simpara>
</entry>
</row>
<row>
<entry>
<simpara>
<literal>shield.authc.realms.$REALM_NAME.hostname_verification</literal>
</simpara>
</entry>
<entry>
<simpara>
This boolean setting has been replaced by <literal>xpack.authc.realms.$REALM_NAME.ssl.verification_mode</literal> that supports more
options as described in the <link linkend="ssl-tls-settings">ssl settings</link> reference section.
</simpara>
</entry>
</row>
</tbody></tgroup></informaltable>
<simpara>The following settings have been removed:</simpara>
<informaltable tabstyle="horizontal" frame="none" colsep="0" rowsep="0"><tgroup cols="2"><colspec colwidth="15*"/><colspec colwidth="85*"/><tbody valign="top">
<row>
<entry>
<simpara>
<literal>shield.ssl.hostname_verification.resolve_name</literal>
</simpara>
</entry>
<entry>
<simpara>
This setting controlled the name resolution for SSL traffic, but was not easy to use and hard to set up. If certificates are not set with
the proper DNS names, you should configure <literal>xpack.security.verification_mode</literal> as either <literal>certificate</literal> or <literal>none</literal>.
</simpara>
</entry>
</row>
<row>
<entry>
<simpara>
<literal>shield.ssl.session.cache_size</literal>
</simpara>
</entry>
<entry>
<simpara>
The value for the SSL session cache size should be configured through the use of the system property <literal>javax.net.ssl.sessionCacheSize</literal>.
</simpara>
</entry>
</row>
<row>
<entry>
<simpara>
<literal>shield.ssl.session.cache_timeout</literal>
</simpara>
</entry>
<entry>
<simpara>
The SSL session cache timeout being set incorrectly can negatively impact performance and was not widely used, so it has been removed and
the default value of the JDK is used.
</simpara>
</entry>
</row>
</tbody></tgroup></informaltable>
</section>
</section>
<section id="migrate-tool">
<title>Migrating File-based Users and Roles to the Native Realm<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/migrate-tool.asciidoc">Edit me</ulink></title>
<simpara>From 5.0 onward, you should use the <literal>native</literal> realm to manage roles and local
users. To migrate existing file-based users and roles to the native realm, use
the <literal>migrate</literal> tool that&#8217;s included with the X-Pack plugin.</simpara>
<simpara>The <literal>migrate</literal> tool loads the existing file-based users and roles and calls the
user and roles APIs to add them to the native realm. You can migrate all users
and roles, or specify the ones you want to migrate. Users and roles that
already exist in the <literal>native</literal> realm are not replaced or overridden. If
the names you specify with the <literal>--users</literal> and <literal>--roles</literal> options don&#8217;t
exist in the <literal>file</literal> realm, they are skipped.</simpara>
<simpara>Run the migrate tool after you install the X-Pack plugin. For example:</simpara>
<programlisting language="sh" linenumbering="unnumbered">$ bin/x-pack/migrate native -U http://localhost:9200 -u test_user -p changeme
-n lee,foo -r role1,role2,role3,role4,foo
starting migration of users and roles...
importing users from [/home/es/config/shield/users]...
found existing users: [test_user, joe3, joe2]
migrating user [lee]
{"user":{"created":true}}
no user [foo] found, skipping
importing roles from [/home/es/config/shield/roles.yml]...
found existing roles: [marvel_user, role_query_fields, admin_role, role3, admin,
remote_marvel_agent, power_user, role_new_format_name_array, role_run_as,
logstash, role_fields, role_run_as1, role_new_format, kibana4_server, user,
transport_client, role1.ab, role_query]
migrating role [role1]
{"role":{"created":true}}
migrating role [role2]
{"role":{"created":true}}
role [role3] already exists, skipping
no role [foo] found, skipping
users and roles imported.</programlisting>
<simpara id="migrate-tool-options">The <literal>native</literal> subcommand supports the following options:</simpara>
<variablelist>
<varlistentry>
<term>
<literal>-U</literal>, <literal>--url</literal>
</term>
<listitem>
<simpara>
Endpoint URL of the Elasticsearch cluster to which you want to migrate the
file-based users and roles. Required.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>-u</literal>, <literal>--username</literal>
</term>
<listitem>
<simpara>
Username to use for authentication.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>-p</literal>, <literal>--password</literal>
</term>
<listitem>
<simpara>
Password to use for authentication.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>-c</literal>, <literal>--config</literal>
</term>
<listitem>
<simpara>
Location of the configuration files for the <literal>file</literal> realm. Required if they are
not located in <literal>CONF_DIR/x-pack</literal>, where <literal>CONF_DIR</literal> is <literal>ES_HOME/config</literal> (zip/tar
installations) or <literal>/etc/elasticsearch</literal> (package installations).
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>-n</literal>, <literal>--users</literal>
</term>
<listitem>
<simpara>
Comma-separated list of the users you want to migrate. If not specified, all
users are migrated.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>-r</literal>, <literal>--roles</literal>
</term>
<listitem>
<simpara>
Comma-separated list of the roles you want to migrate. If not specified, all
roles are migrated.
</simpara>
</listitem>
</varlistentry>
</variablelist>
</section>
<section id="_file_configuration_changes">
<title>File Configuration Changes<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-migrating.asciidoc">Edit me</ulink></title>
<simpara>In Shield, the location of the <literal>users</literal>, <literal>users_roles</literal>, <literal>roles.yml</literal>, and <literal>system_key</literal>
files could be changed using settings. In X-Pack, these files must always reside
in the <literal>CONFIG_DIR/x-pack</literal> directory.</simpara>
</section>
<section id="_literal_esusers_literal_realm_changes">
<title><literal>esusers</literal> Realm Changes<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-migrating.asciidoc">Edit me</ulink></title>
<simpara>In Shield, <literal>esusers</literal> was the type for the file based realm. This realm type has been
renamed to <literal>file</literal> in X-Pack.</simpara>
<simpara>Additionally, the names of users in the <literal>file</literal> based realm are not allowed to conflict
with the <link linkend="built-in-users">built-in users</link>.</simpara>
</section>
<section id="_role_format_changes">
<title>Role Format Changes<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-migrating.asciidoc">Edit me</ulink></title>
<simpara>In X-Pack, the format for specifying <link linkend="roles">roles</link> in the <literal>roles.yml</literal> file is much stricter:</simpara>
<itemizedlist>
<listitem>
<simpara>
Role names are not allowed to conflict with the <link linkend="built-in-roles">built-in roles</link>.
</simpara>
</listitem>
<listitem>
<simpara>
Index names and expressions, such as <literal>.kibana</literal> or <literal>logstash-*</literal>, may no longer be
used as the <link linkend="index-expression-keys"><literal>key</literal> for a set of indices permissions</link>.
</simpara>
</listitem>
<listitem>
<simpara>
Support for comma-separated values and single values has been removed
in favor of collections or arrays.
</simpara>
</listitem>
<listitem>
<simpara>
Syntax for field level security has changed. Instead of providing a list of allowed <literal>fields</literal>, the allowed fields are now inside an
object <literal>field_security</literal>. The new syntax allows to also define exceptions.
See <link linkend="field-level-security">field-level-security</link> for more details.
</simpara>
</listitem>
</itemizedlist>
<simpara>The following role shows how to specify multiple cluster and index
permissions using collections.</simpara>
<formalpara><title>Using collection notation to define roles</title><para>
<programlisting language="yaml" linenumbering="unnumbered">get_user: <co id="CO1-1"/>
  cluster: <co id="CO1-2"/>
    - monitor
    - manage_security
  indices:
    - names: <co id="CO1-3"/>
        - events_index
        - results
      privileges:
        - read
        - monitor
    - names: <co id="CO1-4"/>
        - user_index
      privileges:
        - monitor
        - read
      query:
        term:
          department_id: 12
      field_security:
        grant:
          - name
          - email
          - contact.*
        except:
          - contact.mobile</programlisting>
</para></formalpara>
<calloutlist>
<callout arearefs="CO1-1">
<para>
The name of the role is <literal>get_user</literal>
</para>
</callout>
<callout arearefs="CO1-2">
<para>
The cluster privileges are defined as a collection
</para>
</callout>
<callout arearefs="CO1-3">
<para>
The first set of indices permissions contained in this role. This permission
    applies to the <literal>events_index</literal> and <literal>results</literal> indices and grants the <literal>read</literal> and
    <literal>monitor</literal> privileges.
</para>
</callout>
<callout arearefs="CO1-4">
<para>
The second set of indices permissions contained in this role. This permission
    applies to the <literal>user_index</literal> index, grants <literal>monitor</literal> and <literal>read</literal> privileges,
    limits the visible documents to those matching the <literal>query</literal> and limits the
    visible fields inside of the documents to <literal>name</literal> and <literal>email</literal> and all contact fields except for contact.mobile.
</para>
</callout>
</calloutlist>
<simpara>You can also use arrays to specify multiple cluster and index permissions.
The following role uses the array notation to define the same role as in the
previous example.</simpara>
<formalpara><title>Using array notation to define roles</title><para>
<programlisting language="yaml" linenumbering="unnumbered">get_user:
  cluster: [ monitor, manage_security ]
  indices:
    - names: [ events_index, results ]
      privileges: [ read, monitor ]
    - names: user_index
      privileges: [ monitor, read ]
      query:
        term:
          department_id: 12
      field_security:
        grant: [ name, email, contact.* ]
        except: [ contact.mobile ]</programlisting>
</para></formalpara>
<simpara>Values for <literal>cluster</literal>, <literal>privileges</literal>, and the entries in <literal>fields_security</literal> must be specified as a collection
or array even if there&#8217;s only one value. You can specify a single value for the
<literal>names</literal> field.</simpara>
<simpara id="index-expression-keys">If you have roles that use an index name or expression as a key, you&#8217;ll
need to update them. For example, the following role definitions
are no longer valid.</simpara>
<programlisting language="yaml" linenumbering="unnumbered"># Unsupported role format: index name as key and privilege as value
get_user:
  indices:
    'events_index': read</programlisting>
<programlisting language="yaml" linenumbering="unnumbered"># Unsupported role format: index name as the key with privileges as a value within the object
get_user:
  indices:
    'events_index':
      privileges: read</programlisting>
<simpara>You can rewrite this role to work with X-Pack using collection notation:</simpara>
<programlisting language="yaml" linenumbering="unnumbered"># Correct role format for X-Pack
get_user:
  indices:
    - names: <co id="CO2-1"/>
        - events_index
      privileges:
        - read</programlisting>
<calloutlist>
<callout arearefs="CO2-1">
<para>
This line is the start of a privilege definition for a set of indices. Note
    that this line is indented further underneath <literal>indices</literal>
</para>
</callout>
</calloutlist>
<simpara>Similarly, if you have roles that use comma-separated values to specify multiple
values, you need to rewrite them to use the collection or array notation. For
example, the following role definition is no longer valid.</simpara>
<programlisting language="yaml" linenumbering="unnumbered"># Unsupported role format: comma-separated values
get_user:
  cluster: monitor, manage
  indices:
    'events_index,results':
       - privileges: read, write, create_index
       - field_security:
         - grant: fieldA, fieldB</programlisting>
<simpara>You can rewrite this role using either collections or arrays.</simpara>
<formalpara><title>Specifying multiple values with a collection</title><para>
<programlisting language="yaml" linenumbering="unnumbered">get_user:
  cluster:
    - monitor
    - manage
  indices:
    - names :
        - 'events_index'
        - 'results'
      privileges:
        - read
        - write
        - create_index
      field_security:
        grant:
          - fieldA
          - fieldB</programlisting>
</para></formalpara>
<formalpara><title>Specifying multiple values with an array</title><para>
<programlisting language="yaml" linenumbering="unnumbered">get_user:
  cluster: [ 'monitor', 'manage' ]
  indices:
    - names: [ 'events_index', 'results' ]
      privileges: [ 'read', 'write', 'create_index' ]
      field_security:
        grant: [ 'fieldA', 'fieldB' ]</programlisting>
</para></formalpara>
<simpara>If you have roles that specify single values for <literal>cluster</literal>, <literal>privileges</literal>,
and <literal>fields</literal>, you need to rewrite them to use the collection or array notation.
For example, the following role definition is no longer valid.</simpara>
<programlisting language="yaml" linenumbering="unnumbered"># Unsupported role format: single values
get_user:
  cluster: manage
  indices:
    'events_index':
       - privileges: read
         field_security:
           grant: fieldA</programlisting>
<simpara>You can rewrite this role using collections or arrays (or a combination of
the two). Note that the <literal>names</literal> field still accepts a single value.</simpara>
<formalpara><title>Specifying multiple values with collections and arrays</title><para>
<programlisting language="yaml" linenumbering="unnumbered">get_user:
  cluster:
    - manage
  indices:
    - names: 'events_index'
      privileges:
        - read
      field_security:
        grant: [ 'fieldA' ]</programlisting>
</para></formalpara>
</section>
<section id="_removed_privileges">
<title>Removed Privileges<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-migrating.asciidoc">Edit me</ulink></title>
<simpara>A few of the <link linkend="security-privileges">privileges</link> that were available in Shield 2.x
are no longer available in X-Pack. The following tables list the privileges that
have been removed and their suggested replacements.</simpara>
<table
frame="all"
rowsep="1" colsep="1"
>
<title>Cluster Privileges</title>
<tgroup cols="2">
<colspec colname="col_1" colwidth="50*"/>
<colspec colname="col_2" colwidth="50*"/>
<thead>
<row>
<entry align="left" valign="top"> Removed Privilege </entry>
<entry align="left" valign="top"> Replacement Privilege</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>manage_shield</literal></simpara></entry>
<entry align="left" valign="top"><simpara><literal>manage_security</literal></simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>manage_watcher</literal></simpara></entry>
<entry align="left" valign="top"><simpara><literal>manage</literal></simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>monitor_watcher</literal></simpara></entry>
<entry align="left" valign="top"><simpara><literal>monitor</literal></simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<table
frame="all"
rowsep="1" colsep="1"
>
<title>Indices Privileges</title>
<tgroup cols="2">
<colspec colname="col_1" colwidth="50*"/>
<colspec colname="col_2" colwidth="50*"/>
<thead>
<row>
<entry align="left" valign="top"> Removed Privilege </entry>
<entry align="left" valign="top"> Replacement Privilege</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>get</literal></simpara></entry>
<entry align="left" valign="top"><simpara><literal>read</literal></simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>search</literal></simpara></entry>
<entry align="left" valign="top"><simpara><literal>read</literal></simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>suggest</literal></simpara></entry>
<entry align="left" valign="top"><simpara><literal>read</literal></simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>crud</literal></simpara></entry>
<entry align="left" valign="top"><simpara><literal>read</literal>,<literal>write</literal></simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>data_access</literal></simpara></entry>
<entry align="left" valign="top"><simpara><literal>read</literal>,<literal>write</literal></simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>manage_aliases</literal></simpara></entry>
<entry align="left" valign="top"><simpara><literal>manage</literal></simpara></entry>
</row>
</tbody>
</tgroup>
</table>
</section>
<section id="_field_level_security_and_the_percolator">
<title>Field level security and the percolator<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-migrating.asciidoc">Edit me</ulink></title>
<simpara>The percolator has been refactored and now requires a <literal>percolator</literal> field in the mapping.
As a result, when using field level security with the percolator, access to the <literal>percolator</literal> field needs to be granted.</simpara>
</section>
<section id="_auditing_changes">
<title>Auditing Changes<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-migrating.asciidoc">Edit me</ulink></title>
<simpara>A new event type, <literal>realm_authentication_failed</literal>, has been added. These events were
previously audited as <literal>authentication_failed</literal> events but in some cases produced confusing
output. The <literal>realm_authentication_failed</literal> event indicates that the credentials provided by
the user failed authentication for a specific realm; it does not indicate a failed login
attempt as there could be other realms to try to authenticate against.</simpara>
<simpara>The <link linkend="audit-log-output"><literal>logfile</literal></link> output no longer relies on the logger level to determine
what events to output. The <literal>xpack.security.audit.logfile.events.include</literal> setting can be used
to specify the events that should be output; you may also use the
<literal>xpack.security.audit.logfile.events.exclude</literal> setting to simply exclude values from the
defaults.</simpara>
<simpara>Some audit events would output the content of a REST request if the log level was configured at
the <literal>TRACE</literal> level; control over this output has been replaced with the settings
<literal>xpack.security.audit.logfile.events.emit_request_body</literal> and
<literal>xpack.security.audit.index.events.emit_request_body</literal> for the logfile and index outputs. The
default is <literal>false</literal>.</simpara>
<simpara>Finally, as part of the move to Log4j2 the <literal>logging.yml</literal> file has been replaced with the
<literal>log4j2.properties</literal> file.</simpara>
</section>
<section id="_run_as_changes">
<title>Run As Changes<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-migrating.asciidoc">Edit me</ulink></title>
<simpara>In X-Pack security, the default header name for <link linkend="run-as-privilege">submitting requests</link> on behalf of other users has changed
to <literal>es-security-runas-user</literal>. Applications making use of the run as functionality will need to use the new header name.</simpara>
</section>
</section>
<section id="_migrating_from_marvel">
<title>Migrating from Marvel<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-migrating.asciidoc">Edit me</ulink></title>
<simpara>Prior to 5.0, monitoring functionality was provided as a separate Marvel plugin
for Elasticsearch and Kibana. As of 5.0, all of Marvel&#8217;s features have been
rolled into X-Pack monitoring.</simpara>
<simpara>To migrate to X-Pack monitoring, you simply need to install X-Pack and update your
monitoring settings:</simpara>
<informaltable
frame="all"
rowsep="1" colsep="1"
>
<tgroup cols="2">
<colspec colname="col_1" colwidth="50*"/>
<colspec colname="col_2" colwidth="50*"/>
<thead>
<row>
<entry align="left" valign="top"> Monitoring 2.x Settings          </entry>
<entry align="left" valign="top"> X-Pack 5.0 Settings</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>marvel.*</literal></simpara></entry>
<entry align="left" valign="top"><simpara><literal>xpack.monitoring.*</literal></simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>marvel.agent.*</literal></simpara></entry>
<entry align="left" valign="top"><simpara><literal>xpack.monitoring.collection.*</literal></simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>marvel.agent.exporters.*</literal></simpara></entry>
<entry align="left" valign="top"><simpara><literal>xpack.monitoring.exporters.*</literal></simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
<simpara>For example <literal>marvel.history.duration</literal> is now <literal>xpack.monitoring.history.duration</literal>,
and <literal>marvel.agent.interval</literal> is now <literal>xpack.monitoring.collection.interval</literal>.</simpara>
<simpara>See <link linkend="xpack-settings">X-Pack Settings</link> for the complete list of
<link linkend="monitoring-settings">X-Pack monitoring settings</link> and other X-Pack configuration
options.</simpara>
<simpara>All of the Marvel metric indexes created by Marvel 2.3+ (named like
<literal>.marvel-es-1-*</literal>) will be automatically aliased to be used by Monitoring.
Marvel metric indexes created by 2.0 through 2.2 are not compatible with
Monitoring so they are unused and unmodified. You can delete them by running:</simpara>
<programlisting language="js" linenumbering="unnumbered">DELETE /.marvel-es-20*</programlisting>
<remark> CONSOLE</remark>
<remark> TEST[s/^/PUT .marvel-es-2016-01-01\n/]</remark>
<simpara>Marvel&#8217;s data index (named like <literal>.marvel-es-data</literal> or <literal>.marvel-es-data-1</literal>) is
also unused and unmodified. Monitoring will recreate a new data index soon
after startup so there is no real need to keep Marvel&#8217;s data indexes. You can
delete them by running:</simpara>
<programlisting language="js" linenumbering="unnumbered">DELETE /.marvel-es-data*</programlisting>
<remark> TEST[s/^/PUT .marvel-es-data\n/]</remark>
<section id="_using_an_external_monitoring_cluster">
<title>Using an External Monitoring Cluster<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-migrating.asciidoc">Edit me</ulink></title>
<simpara>To use an external monitoring cluster to monitor an Elasticsearch 5.0 cluster,
you must run Elasticsearch 5.0 on the monitoring cluster. For more information
about external monitoring clusters, see <link linkend="monitoring-cluster">Setting up a Separate Monitoring Cluster</link>.</simpara>
</section>
</section>
<section id="_migrating_from_watcher">
<title>Migrating from Watcher<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-migrating.asciidoc">Edit me</ulink></title>
<simpara>Prior to 5.0 all watcher specific settings were prefixed with <literal>watcher</literal>. Those
have been changed to start with <literal>xpack.watcher</literal> now, For example
<literal>watcher.execution.default_throttle_period</literal> becomes
<literal>xpack.watcher.execution.default_throttle_period</literal>.</simpara>
<simpara>The setting to allow scripting only for watcher has been renamed from
<literal>script.engine.groovy.inline.elasticsearch-watcher_watch</literal> to
<literal>script.engine.groovy.inline.xpack_watch</literal>.</simpara>
<simpara>All account specific SMTP timeouts (<literal>smtp.timeout</literal>, <literal>smtp.connection_timeout</literal> and
<literal>smtp.write_timeout</literal>) now require a time value instead of a number, that
represented milliseconds in earlier releases.</simpara>
<simpara>Watcher history now uses a versioned template. The index names also changed and
contain this version. So instead of <literal>.watch_history_2016.02.03</literal> the new index
name is <literal>.watcher-history-1-2016.02.03</literal>, <literal>1</literal> being the current version. If are
also migrating from Shield (to X-Pack security).</simpara>
<important><simpara>this might require you to change roles/permissions because of the
            different index names!</simpara></important>
<simpara>The old index template named <literal>watch_history</literal> can be deleted now. It will not
interfere with the newly added index template though.</simpara>
<simpara>The notification settings for pagerduty, slack, hipchat and email have been moved and renamed. The move
happened from <literal>xpack.watcher.actions</literal> to <literal>xpack.notification</literal>.
For example the slack configuration needs to move from <literal>xpack.watcher.actions.slack.service</literal>
to <literal>xpack.notification.slack</literal>. The <literal>service</literal> part has been removed for all notification settings.</simpara>
<simpara>All watcher endpoints have been renamed from <literal>/_watcher/XYZ</literal> to <literal>/_xpack/watcher/XYZ</literal>.
You might need to fix this in your clients, monitoring scripts, potential HTTP proxies/redirectors
as well as in your watches.</simpara>
<section id="_watcher_and_scripts">
<title>Watcher and scripts<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-migrating.asciidoc">Edit me</ulink></title>
<simpara>The default scripting language in Elasticsearch has been changed to be painless. This applies for Watcher too, so
when new scripts or updating existing scripts and no script language has been explicitly specified then the painless
language will be used.</simpara>
<simpara>If in your watches you have scripts that don&#8217;t set the scripting language specifically then upon upgrading watcher
will set the language explicitly. By default the language will be set to groovy. If you your default language for scripts
is different than groovy then set the <literal>script.legacy.default_lang</literal> setting before upgrading to what your default language
is now.  This is important otherwise watches may not work after the upgrade and you need to update all your watches manually.</simpara>
</section>
</section>
</chapter>
<part id="xpack-security">
<title>Securing Elasticsearch and Kibana <ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/index.asciidoc">Edit me</ulink></title>
<partintro>
<simpara>X-Pack security enables you to easily secure a cluster. With Security,
you can password-protect your data as well as implement more advanced security
measures such as encrypting communications, role-based access control,
IP filtering, and auditing. This guide describes how to configure the security
features you need, and interact with your secured cluster.</simpara>
<simpara>Security protects Elasticsearch clusters by:</simpara>
<itemizedlist>
<listitem>
<simpara>
<link linkend="preventing-unauthorized-access">Preventing unauthorized access</link>
  with password protection, role-based access control, and IP filtering.
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="preserving-data-integrity">Preserving the integrity of your data</link>
  with message authentication and SSL/TLS encryption.
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="maintaining-audit-trail">Maintaining an audit trail</link>
  so you know who&#8217;s doing what to your cluster and the data it stores.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="preventing-unauthorized-access" renderas="sect2">Preventing Unauthorized Access<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/index.asciidoc">Edit me</ulink></bridgehead>
<simpara>To prevent unauthorized access to your Elasticsearch cluster, you must have a
way to <emphasis>authenticate</emphasis> users. This simply means that you need a way to validate
that a user is who they claim to be. For example, you have to make sure only
the person named <emphasis>Kelsey Andorra</emphasis> can sign in as the user <literal>kandorra</literal>. X-Pack
Security provides a standalone authentication mechanism that enables you to
quickly password-protect your cluster. If you&#8217;re already using <link linkend="ldap-realm">LDAP</link>,
<link linkend="active-directory-realm">Active Directory</link>, or <link linkend="pki-realm">PKI</link> to manage
users in your organization, X-Pack security is able to integrate with those
systems to perform user authentication.</simpara>
<simpara>In many cases, simply authenticating users isn&#8217;t enough. You also need a way to
control what data users have access to and what tasks they can perform. X-Pack security
enables you to <emphasis>authorize</emphasis> users by assigning access <emphasis>privileges</emphasis> to <emphasis>roles</emphasis>,
and assigning those roles to users. For example, this
<link linkend="authorization">role-based access control</link> mechanism (a.k.a RBAC) enables
you to specify that the user <literal>kandorra</literal> can only perform read operations on the
<literal>events</literal> index and can&#8217;t do anything at all with other indices.</simpara>
<simpara>X-Pack security also supports <link linkend="ip-filtering">IP-based authorization</link>. You can
whitelist and blacklist specific IP addresses or subnets to control network-level
access to a server.</simpara>
<bridgehead id="preserving-data-integrity" renderas="sect2">Preserving Data Integrity<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/index.asciidoc">Edit me</ulink></bridgehead>
<simpara>A critical part of security is keeping confidential data confidential.
Elasticsearch has built-in protections against accidental data loss and
corruption. However, there&#8217;s nothing to stop deliberate tampering or data
interception. X-Pack security preserves the integrity of your data by
<link linkend="ssl-tls">encrypting communications</link> to and from nodes and
<link linkend="enable-message-authentication">authenticating messages</link> to verify that they
have not been tampered with or corrupted in transit during node-to-node
communication. For even greater protection, you can increase the
<link linkend="ciphers">encryption strength</link> and
<link linkend="separating-node-client-traffic">separate client traffic from node-to-node communications</link>.</simpara>
<bridgehead id="maintaining-audit-trail" renderas="sect2">Maintaining an Audit Trail<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/index.asciidoc">Edit me</ulink></bridgehead>
<simpara>Keeping a system secure takes vigilance. By using X-Pack security to maintain
an audit trail, you can easily see who is accessing your cluster and what they&#8217;re
doing. By analyzing access patterns and failed attempts to access your cluster,
you can gain insights into attempted attacks and data breaches. Keeping an
auditable log of the activity in your cluster can also help diagnose operational
issues.</simpara>
<bridgehead id="_where_to_go_next_2" renderas="sect2">Where to Go Next<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/index.asciidoc">Edit me</ulink></bridgehead>
<itemizedlist>
<listitem>
<simpara>
<link linkend="security-getting-started">Getting Started</link>
  steps through how to install and start using Security for basic authentication.
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="how-security-works">How Security Works</link>
  provides more information about how Security supports user authentication,
  authorization, and encryption.
</simpara>
</listitem>
<listitem>
<simpara>
<xref linkend="tribe-clients-integrations"/>
  shows you how to interact with an Elasticsearch cluster protected by.
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="security-reference">Reference</link>
  provides detailed information about the access privileges you can grant to
  users, the settings you can configure for Security in <literal>elasticsearch.yml</literal>,
  and the files where Security configuration information is stored.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_have_comments_questions_or_feedback_2" renderas="sect2">Have Comments, Questions, or Feedback?<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/index.asciidoc">Edit me</ulink></bridgehead>
<simpara>Head over to our <ulink url="https://discuss.elastic.co/c/shield">Security Discussion Forum</ulink>
to share your experience, questions, and suggestions.</simpara>
</partintro>
<chapter id="security-getting-started">
<title>Getting Started with Security<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/getting-started.asciidoc">Edit me</ulink></title>
<simpara>To secure a cluster, you must install X-Pack on every node in the
cluster. Basic authentication is enabled by default&#8212;to communicate
with the cluster, you must specify a username and password.
Unless you <link linkend="anonymous-access">enable anonymous access</link>, all
requests that don&#8217;t include a user name and password are rejected.</simpara>
<simpara>X-Pack security provides a built-in <literal>elastic</literal> superuser you can use
to start setting things up. This <literal>elastic</literal> user has full access
to the cluster, including all indices and data, so make sure
you change the default password and protect the <literal>elastic</literal> user
credentials accordingly.</simpara>
<simpara>To get started with X-Pack security:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
<link linkend="installing-xpack">Install X-Pack</link> and start Elasticsearch and Kibana.
</simpara>
</listitem>
<listitem>
<simpara>
Change the passwords of the built in <literal>kibana</literal> and <literal>elastic</literal> users:
</simpara>
<programlisting language="shell" linenumbering="unnumbered">curl -XPUT -u elastic 'localhost:9200/_xpack/security/user/elastic/_password' -d '{
  "password" : "elasticpassword"
}'

curl -XPUT -u elastic 'localhost:9200/_xpack/security/user/kibana/_password' -d '{
  "password" : "kibanapassword"
}'</programlisting>
<note><simpara>The default password for the <literal>elastic</literal> user is <literal>changeme</literal>.</simpara></note>
</listitem>
<listitem>
<simpara>
Set up roles and users to control access to Elasticsearch and Kibana.
For example, to grant <emphasis>John Doe</emphasis> full access to all indices that match
the pattern <literal>events*</literal> and enable him to create visualizations and dashboards
for those indices in Kibana, you could create an <literal>events_admin</literal> role and
and assign the role to a new <literal>johndoe</literal> user.
</simpara>
<programlisting language="shell" linenumbering="unnumbered">curl -XPOST -u elastic 'localhost:9200/_xpack/security/role/events_admin' -d '{
  "indices" : [
    {
      "names" : [ "events*" ],
      "privileges" : [ "all" ]
    },
    {
      "names" : [ ".kibana*" ],
      "privileges" : [ "manage", "read", "index" ]
    }
  ]
}'

curl -XPOST -u elastic 'localhost:9200/_xpack/security/user/johndoe' -d '{
  "password" : "userpassword",
  "full_name" : "John Doe",
  "email" : "john.doe@anony.mous",
  "roles" : [ "events_admin" ]
}'</programlisting>
</listitem>
<listitem>
<simpara>
Enable message authentication to verify that messages are not tampered with or corrupted in transit:
</simpara>
<orderedlist id="enable-message-authentication" numeration="loweralpha">
<listitem>
<simpara>
Run the <literal>syskeygen</literal> tool from <literal>ES_HOME</literal> without any options:
</simpara>
<programlisting language="shell" linenumbering="unnumbered">bin/x-pack/syskeygen</programlisting>
<simpara>This creates a system key file in <literal>CONFIG_DIR/x-pack/system_key</literal>.</simpara>
</listitem>
<listitem>
<simpara>
Copy the generated system key to the rest of the nodes in the cluster.
</simpara>
<important><simpara>The system key is a symmetric key, so the same key must be on every
            node in the cluster.</simpara></important>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>
Enable Auditing to keep track of attempted and successful interactions with
  your Elasticsearch cluster:
</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>
Add the following setting to <literal>elasticsearch.yml</literal> on all nodes in your cluster:
</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.security.audit.enabled: true</programlisting>
</listitem>
<listitem>
<simpara>
Restart Elasticsearch.
</simpara>
</listitem>
</orderedlist>
<simpara>By default, events are logged to a dedicated <literal>elasticsearch-access.log</literal> file in
<literal>ES_HOME/logs</literal>. You can also store the events in an Elasticsearch index for
easier analysis and control what events are logged. For more information, see
<link linkend="auditing">Configuring Auditing</link>.</simpara>
</listitem>
</orderedlist>
<important id="moving-on"><simpara>Once you get these basic security measures in place, we strongly
            recommend that you secure communications to and from nodes by
            configuring your cluster to use <link linkend="ssl-tls">SSL/TLS encryption</link>.
            Nodes that do not have encryption enabled send passwords in plain
            text!</simpara></important>
<simpara>Depending on your security requirements, you might also want to:</simpara>
<itemizedlist>
<listitem>
<simpara>
Integrate with <link linkend="ldap-realm">LDAP</link> or <link linkend="active-directory-realm">Active Directory</link>,
or <link linkend="pki-realm">require certificates</link> for authentication.
</simpara>
</listitem>
<listitem>
<simpara>
Use <link linkend="ip-filtering">IP Filtering</link> to allow or deny requests from particular
IP addresses or address ranges.
</simpara>
</listitem>
</itemizedlist>
</chapter>
<chapter id="how-security-works">
<title>How Security Works<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/how-security-works.asciidoc">Edit me</ulink></title>
<simpara>An Elasticsearch cluster is typically made out of many moving parts. There are
the Elasticsearch nodes that form the cluster, and often Logstash instances,
Kibana instances, Beats agents an clients, all communicating with the it.
It should not come as a surprise that securing such clusters has many facets and
layers.</simpara>
<simpara>X-Pack security provides the means to secure the Elastic cluster on several levels:</simpara>
<itemizedlist>
<listitem>
<simpara>
User authentication
</simpara>
</listitem>
<listitem>
<simpara>
Authorization and Role Based Access Control (a.k.a RBAC)
</simpara>
</listitem>
<listitem>
<simpara>
Node/Client Authentication and Channel Encryption
</simpara>
</listitem>
<listitem>
<simpara>
Auditing
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_user_authentication" renderas="sect2">User Authentication<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/how-security-works.asciidoc">Edit me</ulink></bridgehead>
<simpara>User authentication is the process of identifying the users behind the requests
that hit the cluster and verifying that indeed they are who they claim to be. The
authentication process is handled by one or more authentication services called
<emphasis>realms</emphasis>. X-Pack security provides the following built-in realms:</simpara>
<informaltable
frame="all"
rowsep="1" colsep="1"
>
<tgroup cols="4">
<colspec colname="col_1" colwidth="25*"/>
<colspec colname="col_2" colwidth="25*"/>
<colspec colname="col_3" colwidth="25*"/>
<colspec colname="col_4" colwidth="25*"/>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>native</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>An internal realm where users are stored in a dedicated
                            Elasticsearch index. With this realm, users are
                            authenticated by usernames and passwords. The users
                            are managed via the <link linkend="security-api-users">User Management API</link>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ldap</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>A realm that uses an external LDAP server to authenticate
                            the users. With this realm, users are authenticated by
                            usernames and passwords.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>active_directory</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>A realm that uses an external Active Directory Server
                            to authenticate the users. With this realm, users
                            are authenticated by usernames and passwords.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>pki</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>A realm that authenticates users using Public Key
                            Infrastructure (PKI). This realm works in conjunction
                            with SSL/TLS and identifies the users through the
                            Distinguished Name (DN) of the client&#8217;s X.509
                            certificates.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>file</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>An internal realm where users are defined in files
                            stored on each node in the Elasticsearch cluster.
                            With this realm, users are authenticated by usernames
                            and passwords. The users are managed via
                            <link linkend="managing-file-users">dedicated tools</link> that are
                            provided by X-Pack on installation.</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
<simpara>If none of the built-in realms meets your needs, you can also build your own
custom realm and plug it into X-Pack.</simpara>
<simpara>When X-Pack security is enabled, depending on the realms you&#8217;ve configured, you will
need to attach your user credentials to the requests sent to Elasticsearch. For
example, when using realms that support usernames and passwords you can simply
attach <ulink url="https://en.wikipedia.org/wiki/Basic_access_authentication">basic auth</ulink> header to the requests.</simpara>
<simpara>For more information on user authentication see <xref linkend="setting-up-authentication"/></simpara>
<bridgehead id="_authorization" renderas="sect2">Authorization<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/how-security-works.asciidoc">Edit me</ulink></bridgehead>
<simpara>The authorization process takes place once a request is authenticated and the
User behind the request is identified. Authorization is the process of determining
whether the user behind an incoming request is allowed to execute it. Naturally,
this process takes place right after an successful authentication - when the
user identity is known.</simpara>
<simpara>The authorization process revolves around the following 5 constructs:</simpara>
<variablelist>
<varlistentry>
<term>
<emphasis>Secured Resource</emphasis>
</term>
<listitem>
<simpara>
A resource to which access is restricted. Indices/aliases, documents, fields,
users and the Elasticsearch cluster itself are all examples of secured objects.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<emphasis>Privilege</emphasis>
</term>
<listitem>
<simpara>
A named group representing one or more actions that a user may execute against a
secured resource. Each secured resource has its own sets of available privileges.
For example, <literal>read</literal> is an index privilege that represents all actions that enable
reading the indexed/stored data. For a complete list of available privileges
see <xref linkend="security-privileges"/>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<emphasis>Permissions</emphasis>
</term>
<listitem>
<simpara>
A set of one or more privileges against a secured resource. Permissions can
easily be described in words, here are few examples:
</simpara>
<itemizedlist>
<listitem>
<simpara>
<literal>read</literal> privilege on the <literal>products</literal> index
</simpara>
</listitem>
<listitem>
<simpara>
<literal>manage</literal> privilege on the cluster
</simpara>
</listitem>
<listitem>
<simpara>
<literal>run_as</literal> privilege on <literal>john</literal> user
</simpara>
</listitem>
<listitem>
<simpara>
<literal>read</literal> privilege on documents that match query X
</simpara>
</listitem>
<listitem>
<simpara>
<literal>read</literal> privilege on <literal>credit_card</literal> field
</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>
<emphasis>Role</emphasis>
</term>
<listitem>
<simpara>
A named sets of permissions
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<emphasis>User</emphasis>
</term>
<listitem>
<simpara>
The authenticated user.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<simpara>A secure Elasticsearch cluster manages the privileges of users through <emphasis>roles</emphasis>.
A role has a unique name and identifies a set of permissions that translate to
privileges on resources. A user can be associated with an arbitrary number of
roles. The total set of permissions that a user has is therefore defined by
union of the permissions in all its roles.</simpara>
<simpara>Roles can be assigned to users in a number of ways depending on the realms by
which the users are authenticated.</simpara>
<simpara>For more information on user authentication see <xref linkend="authorization"/></simpara>
<bridgehead id="_node_client_authentication_and_channel_encryption" renderas="sect2">Node/Client Authentication and Channel Encryption<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/how-security-works.asciidoc">Edit me</ulink></bridgehead>
<simpara>X-Pack security supports configuring SSL/TLS for securing the communication channels
to, from and within the cluster. This support accounts for:</simpara>
<itemizedlist>
<listitem>
<simpara>
Encryption of data transmitted over the wires
</simpara>
</listitem>
<listitem>
<simpara>
Certificate based node authentication - preventing unauthorized nodes/clients
    from establishing a connection with the cluster.
</simpara>
</listitem>
</itemizedlist>
<simpara>For more information, see <link linkend="encrypting-communications">Encrypting Communications</link>.</simpara>
<simpara>X-Pack security also enables you to <link linkend="ip-filtering">configure IP Filters</link> which can
be seen as a light mechanism for node/client authentication. With IP Filtering
you can restrict the nodes and clients that can connect to the cluster based
on their IP addresses. The IP filters configuration provides whitelisting
and blacklisting of IPs, subnets and DNS domains.</simpara>
<bridgehead id="_auditing" renderas="sect2">Auditing<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/how-security-works.asciidoc">Edit me</ulink></bridgehead>
<simpara>When dealing with any secure system, it is critical to have a audit trail
mechanism set in place. Audit trails log various activities/events that occur in
the system, enabling you to analyze and back track past events when things go
wrong (e.g. security breach).</simpara>
<simpara>X-Pack security provides such audit trail functionality for all nodes in the cluster.
You can configure the audit level which accounts for the type of events that are
logged. These events include failed authentication attempts, user access denied,
node connection denied, and more.</simpara>
<simpara>For more information on auditing see <xref linkend="auditing"/>.</simpara>
</chapter>
<chapter id="setting-up-authentication">
<title>Setting Up User Authentication<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication.asciidoc">Edit me</ulink></title>
<simpara>Authentication identifies an individual. To gain access to restricted resources,
a user must prove their identity, via passwords, credentials, or some other
means (typically referred to as authentication tokens).</simpara>
<simpara>You can use the native support for managing and authenticating users, or
integrate with external user management systems such as LDAP and Active
Directory. For information about managing native users,
see <link linkend="managing-native-users">Managing Native Users</link>.</simpara>
<bridgehead id="built-in-users" renderas="sect2">Built-in Users<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication.asciidoc">Edit me</ulink></bridgehead>
<simpara>X-Pack security provides built-in user credentials to help you get up and running.
These users have a fixed set of privileges and the default password <literal>changeme</literal>.</simpara>
<table
frame="all"
rowsep="1" colsep="1"
>
<title>X-Pack security Built-in Users</title>
<tgroup cols="2">
<colspec colname="col_1" colwidth="50*"/>
<colspec colname="col_2" colwidth="50*"/>
<tbody>
<row>
<entry align="left" valign="top"><simpara>Name</simpara></entry>
<entry align="left" valign="top"><simpara>Description</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>elastic</literal></simpara></entry>
<entry align="left" valign="top"><simpara>A built-in <link linkend="built-in-roles-superuser"><emphasis>superuser</emphasis></link>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>kibana</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The user Kibana uses to connect and communicate with Elasticsearch.</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<important id="reset-built-in-user-passwords">
<simpara>You must reset the default passwords for all built-in users. You can update
passwords from the <emphasis role="strong">Management &gt; Users</emphasis> UI in Kibana or with the
<link linkend="security-api-reset-user-password">Reset Password API</link>:</simpara>
<programlisting language="js" linenumbering="unnumbered">PUT _xpack/security/user/elastic/_password
{
  "password": "elasticpassword"
}</programlisting>
<remark> CONSOLE</remark>
<programlisting language="js" linenumbering="unnumbered">PUT _xpack/security/user/kibana/_password
{
  "password": "kibanapassword"
}</programlisting>
<remark> CONSOLE</remark>
<simpara>Once the <literal>kibana</literal> user password is reset, you need to update the Kibana server
with the new password by setting <literal>elasticsearch.password</literal> in the
<literal>kibana.yml</literal> configuration file:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">elasticsearch.password: kibanapassword</programlisting>
</important>
<section id="_how_authentication_works">
<title>How Authentication Works<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication.asciidoc">Edit me</ulink></title>
<simpara>Authentication in X-Pack security is handled by one or more authentication services
called <emphasis>realms</emphasis>. A <emphasis>realm</emphasis> is used to resolve and authenticate users based on
authentication tokens. X-Pack security provides the following built-in realms:</simpara>
<variablelist>
<varlistentry>
<term>
<emphasis>native</emphasis>
</term>
<listitem>
<simpara>
An internal realm where users are stored in a dedicated Elasticsearch index.
This realm supports an authentication token in the form of username and password,
and is available by default when no realms are explicitly configured. See
<xref linkend="native-realm"/>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<emphasis>ldap</emphasis>
</term>
<listitem>
<simpara>
A realm that uses an external LDAP server to authenticate the
users. This realm supports an authentication token in the form of username and
password, and requires explicit configuration in order to be used. See
<xref linkend="ldap-realm"/>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<emphasis>active_directory</emphasis>
</term>
<listitem>
<simpara>
A realm that uses an external Active Directory Server to authenticate the
users. With this realm, users are authenticated by usernames and passwords.
See <xref linkend="active-directory-realm"/>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<emphasis>pki</emphasis>
</term>
<listitem>
<simpara>
A realm that authenticates users using Public Key Infrastructure (PKI). This
realm works in conjunction with SSL/TLS and identifies the users through the
Distinguished Name (DN) of the client&#8217;s X.509 certificates. See <xref linkend="pki-realm"/>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<emphasis>file</emphasis>
</term>
<listitem>
<simpara>
An internal realm where users are defined in files stored on each node in the
Elasticsearch cluster. This realm supports an authentication token in the form
of username and password, and is always available. See <xref linkend="file-realm"/>.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<simpara>X-Pack security also supports custom realms. If you need to integrate with another
authentication system, you can build a custom realm plugin. For more information,
see <link linkend="custom-realms">Integrating with Other Authentication Systems</link>.</simpara>
<simpara>Realms live within a <emphasis>realm chain</emphasis>. It is essentially a prioritized list of
configured realms (typically of various types). The order of the list determines
the order in which the realms will be consulted. During the authentication process,
X-Pack security will consult and try to authenticate the request one realm at a time.
Once one of the realms successfully authenticates the request, the authentication
is considered to be successful and the authenticated user will be associated
with the request (which will then proceed to the authorization phase). If a realm
cannot authenticate the request, the next in line realm in the chain will be
consulted. If all realms in the chain could not authenticate the request, the
authentication is then considered to be unsuccessful and an authentication error
will be returned (as HTTP status code <literal>401</literal>).</simpara>
<note><simpara>Some systems (e.g. Active Directory) have a temporary lock-out period after
      several successive failed login attempts. If the same username exists in
      multiple realms, unintentional account lockouts are possible. For more
      information, please see <link linkend="trouble-shoot-active-directory">here</link>.</simpara></note>
<simpara>The default realm chain contains the <literal>native</literal> and <literal>file</literal> realms. To explicitly,
configure a realm chain, you specify the chain in <literal>elasticsearch.yml</literal>. When you
configure a realm chain, only the realms you specify are used for authentication.
To use the <literal>native</literal> and <literal>file</literal> realms, you must include them in the chain.</simpara>
<simpara>The following snippet configures a realm chain that includes the <literal>file</literal> and
<literal>native</literal> realms, as well as two LDAP realms and an Active Directory realm.</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.security.authc:
  realms:

    file:
      type: file
      order: 0

    native:
      type: native
      order: 1

    ldap1:
      type: ldap
      order: 2
      enabled: false
      url: 'url_to_ldap1'
      ...

    ldap2:
      type: ldap
      order: 3
      url: 'url_to_ldap2'
      ...

    ad1:
      type: active_directory
      order: 4
      url: 'url_to_ad'</programlisting>
<simpara>As can be seen above, each realm has a unique name that identifies it and each
realm type dictates its own set of required and optional settings. That said,
there are three settings that are common to all realms:</simpara>
<informaltable
frame="all"
rowsep="1" colsep="1"
>
<tgroup cols="3">
<colspec colname="col_1" colwidth="33*"/>
<colspec colname="col_2" colwidth="33*"/>
<colspec colname="col_3" colwidth="33*"/>
<thead>
<row>
<entry align="left" valign="top"> Setting     </entry>
<entry align="center" valign="top"> Required  </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>type</literal></simpara></entry>
<entry align="center" valign="top"><simpara>true</simpara></entry>
<entry align="left" valign="top"><simpara>Identifies the type of the realm. The realm type
                            determines what other settings the realms should be
                            configured with. The type can be one of: <literal>native</literal>,
                            <literal>ldap</literal>, <literal>active_directory</literal>, <literal>pki</literal>, <literal>file</literal>, or in case
                            of a custom realm, the type name that identifies it.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>order</literal></simpara></entry>
<entry align="center" valign="top"><simpara>false</simpara></entry>
<entry align="left" valign="top"><simpara>A numeric value representing the priority/index of
                            the realm within the realm chain. This will determine
                            the order by which the realms will be consulted
                            during authentication, with lower order being consulted
                            first.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>enabled</literal></simpara></entry>
<entry align="center" valign="top"><simpara>false</simpara></entry>
<entry align="left" valign="top"><simpara>When set to <literal>false</literal> the realm will be disabled and
                            will not be added to the realm chain. This is useful
                            for debugging purposes as it enables you to remove
                            a realm from the chain without deleting and losing
                            its configuration.</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
<simpara>Realm types can roughly be classified in two categories:</simpara>
<variablelist>
<varlistentry>
<term>
Internal
</term>
<listitem>
<simpara>
Realms that are internal to Elasticsearch and don&#8217;t require any
            communication with external parties. They are fully managed by
            X-Pack security. There can only be a maximum of one configured realm
            per internal realm type. X-Pack security provides two internal realm
            types: <literal>native</literal> and <literal>file</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
External
</term>
<listitem>
<simpara>
Realms that require interaction with parties/components external to
            Elasticsearch, typically, with enterprise grade identity management
            systems. Unlike internal realms, there can be as many external realms
            as one would like - each with its own unique name and configuration.
            X-Pack security provides three external realm types: <literal>ldap</literal>,
            <literal>active_directory</literal> and <literal>pki</literal>.
</simpara>
</listitem>
</varlistentry>
</variablelist>
</section>
<section id="anonymous-access">
<title>Enabling Anonymous Access<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/anonymous-access.asciidoc">Edit me</ulink></title>
<simpara>Incoming requests are considered to be <emphasis>anonymous</emphasis> if no authentication token
can be extracted from the incoming request. By default, anonymous requests are rejected and an authentication error is returned (status code <literal>401</literal>).</simpara>
<simpara>To enable anonymous access, you assign one or more roles to anonymous
users in the <literal>elasticsearch.yml</literal> configuration file. For example, the following
configuration assigns anonymous users <literal>role1</literal> and <literal>role2</literal>:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.security.authc:
  anonymous:
    username: anonymous_user <co id="CO3-1"/>
    roles: role1, role2 <co id="CO3-2"/>
    authz_exception: true <co id="CO3-3"/></programlisting>
<calloutlist>
<callout arearefs="CO3-1">
<para>
The username/principal of the anonymous user. Defaults to
<literal>_es_anonymous_user</literal> if not specified.
</para>
</callout>
<callout arearefs="CO3-2">
<para>
The roles to associate with the anonymous user. If no roles are specified, anonymous access is disabled&#8212;anonymous requests will be rejected and return an authentication error.
</para>
</callout>
<callout arearefs="CO3-3">
<para>
When <literal>true</literal>, a 403 HTTP status code is returned if the anonymous user
does not have the permissions needed to perform the requested action and the
user will NOT be prompted to provide credentials to access the requested
resource. When <literal>false</literal>, a 401 HTTP status code is returned if the anonymous user
does not have the necessary permissions and the user is prompted for
credentials to access the requested resource. If you are using anonymous access
in combination with HTTP, you might need to set <literal>authz_exception</literal> to <literal>false</literal>
if your client does not support preemptive basic authentication. Defaults to
<literal>true</literal>.
</para>
</callout>
</calloutlist>
</section>
<section id="native-realm">
<title>Native User Authentication<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/native-realm.asciidoc">Edit me</ulink></title>
<simpara>The easiest way to manage and authenticate users is with the internal <literal>native</literal>
realm. You can use the REST APIs or Kibana to add and remove users, assign user roles, and
manage user passwords.</simpara>
<bridgehead id="native-realm-configuration" renderas="sect3">Configuring a Native Realm<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/native-realm.asciidoc">Edit me</ulink></bridgehead>
<simpara>The native realm is added to the realm chain by default. You don&#8217;t need to
explicitly configure a native realm to manage users through the REST APIs.</simpara>
<simpara>You can, however, configure options for the <literal>native</literal> realm in the
<literal>xpack.security.authc.realms</literal> namespace in <literal>elasticsearch.yml</literal>. Explicitly
configuring a native realm enables you to set the order in which it appears in
the realm chain, temporary disable the realm, and control its cache options.</simpara>
<simpara>To configure a native realm:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Add a realm configuration of type <literal>native</literal> to <literal>elasticsearch.yml</literal> under the
<literal>xpack.security.authc.realms</literal> namespace. At a minimum, you must set the realm
<literal>type</literal> to <literal>native</literal>. If you are configuring multiple realms, you should also
explicitly set the <literal>order</literal> attribute. See <link linkend="native-settings">Native Realm Settings</link>
for all of the options you can set for the <literal>native</literal> realm.
</simpara>
<simpara>For example, the following snippet shows a <literal>native</literal> realm configuration that
sets the <literal>order</literal> to zero so the realm is checked first:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack:
  security:
    authc:
      realms:
        native1:
          type: native
          order: 0</programlisting>
</listitem>
<listitem>
<simpara>
Restart Elasticsearch.
</simpara>
</listitem>
</orderedlist>
<table id="native-settings"
frame="all"
rowsep="1" colsep="1"
>
<title>Native Realm Settings</title>
<tgroup cols="3">
<colspec colname="col_1" colwidth="23*"/>
<colspec colname="col_2" colwidth="17*"/>
<colspec colname="col_3" colwidth="58*"/>
<tbody>
<row>
<entry align="left" valign="top"><simpara>Setting</simpara></entry>
<entry align="center" valign="top"><simpara>Required</simpara></entry>
<entry align="left" valign="top"><simpara>Description</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>type</literal></simpara></entry>
<entry align="center" valign="top"><simpara>yes</simpara></entry>
<entry align="left" valign="top"><simpara>Indicates the realm type. Must be set to <literal>native</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>order</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Indicates the priority of this realm within
                                    the realm chain. Realms with a lower order
                                    are consulted first. Although not required,
                                    we recommend explicitly setting this value
                                    when you configure multiple realms. Defaults
                                    to <literal>Integer.MAX_VALUE</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>enabled</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Indicates whether this realm is enabled or
                                    disabled. When set to <literal>false</literal>, the realm is
                                    not added to the realm chain and therefore
                                    is inactive. Defaults to <literal>true</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>cache.ttl</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the time-to-live for cached user
                                    entries. A user&#8217;s credentials are cached for
                                    this period of time. Specify the time period
                                    using the standard Elasticsearch
                                    <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/common-options.html#time-units">time units</ulink>.
                                    Defaults to <literal>20m</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>cache.max_users</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the maximum number of user entries
                                    that can be cached at any given time. Defaults
                                    to 100,000.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>cache.hash_algo</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the hashing algorithm that is used
                                    for the cached user credentials. See
                                    <link linkend="cache-hash-algo">Cache hash algorithms</link>
                                    for the possible values. (Expert Setting)</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<section id="managing-native-users">
<title>Managing Native Users<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/native-realm.asciidoc">Edit me</ulink></title>
<simpara>You manage users in the <literal>native</literal> realm through the <link linkend="security-api-users">user API</link>.</simpara>
<note id="migrating-from-file"><simpara>To migrate file-based users to the <literal>native</literal> realm, use the
<link linkend="migrate-tool">migrate</link> tool.</simpara></note>
<bridgehead id="native-add" renderas="sect4">Adding Users<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/native-realm.asciidoc">Edit me</ulink></bridgehead>
<simpara>To add a user, submit a PUT or POST request to the <literal>/_xpack/security/user/&lt;username&gt;</literal>
endpoint. A username must be at least 1 character long and no longer than 30
characters. The first character must be a letter (<literal>a-z</literal> or <literal>A-Z</literal>) or an
underscore (<literal>_</literal>). Subsequent characters can be letters, underscores (<literal>_</literal>),
digits (<literal>0-9</literal>), or any of the following symbols <literal>@</literal>, <literal>-</literal>, <literal>.</literal> or <literal>$</literal>.</simpara>
<programlisting language="js" linenumbering="unnumbered">POST /_xpack/security/user/jacknich
{
  "password" : "j@rV1s", <co id="CO4-1"/>
  "roles" : [ "admin", "other_role1" ], <co id="CO4-2"/>
  "full_name" : "Jack Nicholson", <co id="CO4-3"/>
  "email" : "jacknich@example.com", <co id="CO4-4"/>
  "metadata" : { <co id="CO4-5"/>
    "intelligence" : 7
  },
  "enabled": true <co id="CO4-6"/>
}</programlisting>
<remark> CONSOLE</remark>
<calloutlist>
<callout arearefs="CO4-1">
<para>
You must specify a password when adding a user. Passwords must be at least 6
    characters long.
</para>
</callout>
<callout arearefs="CO4-2">
<para>
You must assign at least one role to the user. The roles determine the user&#8217;s
    access permissions.
</para>
</callout>
<callout arearefs="CO4-3">
<para>
The user&#8217;s full name. Optional.
</para>
</callout>
<callout arearefs="CO4-4">
<para>
The user&#8217;s email address. Optional.
</para>
</callout>
<callout arearefs="CO4-5">
<para>
Arbitrary metadata you want to associate with the user. Optional.
</para>
</callout>
<callout arearefs="CO4-6">
<para>
Specifies whether the user should be enabled. Optional with a default of true.
</para>
</callout>
</calloutlist>
<bridgehead id="native-list" renderas="sect4">Retrieving Users<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/native-realm.asciidoc">Edit me</ulink></bridgehead>
<simpara>To retrieve all users, submit a GET request to the <literal>/_xpack/security/user</literal> endpoint:</simpara>
<programlisting language="js" linenumbering="unnumbered">GET /_xpack/security/user</programlisting>
<remark> CONSOLE</remark>
<remark> TEST[continued]</remark>
<simpara>To retrieve particular users, specify the users as a comma-separated list:</simpara>
<programlisting language="js" linenumbering="unnumbered">GET /_xpack/security/user/jacknich,rdeniro</programlisting>
<remark> CONSOLE</remark>
<remark> TEST[continued]</remark>
<simpara>An object is returned holding the found users, each keyed by the relevant
username. Note that user passwords are not included.</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "jacknich" : {
    "username": "jacknich",
    "roles" : [ "admin", "other_role1" ],
    "full_name" : "Jack Nicholson",
    "email" : "jacknich@example.com",
    "enabled" : true,
    "metadata" : {
      "intelligence" : 7
    }
  }
}</programlisting>
<remark> TESTRESPONSE</remark>
<bridgehead id="native-delete" renderas="sect4">Deleting Users<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/native-realm.asciidoc">Edit me</ulink></bridgehead>
<simpara>To delete a user, submit a DELETE request to the <literal>/_xpack/security/user/&lt;username&gt;</literal>
endpoint:</simpara>
<programlisting language="js" linenumbering="unnumbered">DELETE /_xpack/security/user/jacknich</programlisting>
<remark> CONSOLE</remark>
<remark> TEST[continued]</remark>
<simpara>If the user is successfully deleted, the request returns <literal>{"found": true}</literal>.
Otherwise, <literal>found</literal> is set to false.</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "found" : true
}</programlisting>
<remark> TESTRESPONSE</remark>
</section>
</section>
<section id="ldap-realm">
<title>LDAP User Authentication<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/ldap-realm.asciidoc">Edit me</ulink></title>
<simpara>You can configure X-Pack security to communicate with a Lightweight Directory Access
Protocol (LDAP) server to authenticate users. To integrate with LDAP, you
configure an <literal>ldap</literal> realm and map LDAP groups to user roles in the
<link linkend="mapping-roles">role mapping file</link>.</simpara>
<simpara>To protect passwords, communications between Elasticsearch and the LDAP server
should be encrypted using SSL/TLS. Clients and nodes that connect via SSL/TLS to
the LDAP server need to have the LDAP server&#8217;s certificate or the server&#8217;s root
CA certificate installed in their <emphasis>keystore</emphasis> or <emphasis>truststore</emphasis>. For more information
about installing certificates, see <xref linkend="ldap-ssl"/>.</simpara>
<section id="_configuring_an_ldap_realm">
<title>Configuring an LDAP Realm<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/ldap-realm.asciidoc">Edit me</ulink></title>
<simpara>LDAP stores users and groups hierarchically, similar to the way folders are
grouped in a file system. An LDAP directory&#8217;s hierarchy is built from containers
such as the <emphasis>organizational unit</emphasis> (<literal>ou</literal>), <emphasis>organization</emphasis> (<literal>o</literal>), and
<emphasis>domain controller</emphasis> (<literal>dc</literal>).</simpara>
<simpara>The path to an entry is a <emphasis>Distinguished Name</emphasis> (DN) that uniquely identifies a
user or group. User and group names typically have attributes such as a
<emphasis>common name</emphasis> (<literal>cn</literal>) or <emphasis>unique ID</emphasis> (<literal>uid</literal>). A DN is specified as a string,
for example  <literal>"cn=admin,dc=example,dc=com"</literal> (white spaces are ignored).</simpara>
<simpara>The <literal>ldap</literal> realm supports two modes of operation, a user search mode
and a mode with specific templates for user DNs. See
<link linkend="ldap-settings">LDAP Realm Settings</link> for all of the options you can set for an
<literal>ldap</literal> realm.</simpara>
<section id="ldap-user-search">
<title>User Search Mode<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/ldap-realm.asciidoc">Edit me</ulink></title>
<simpara>LDAP user search is the most common mode of operation. In this mode, a specific
user with permission to search the LDAP directory is used to search for the
authenticating user DN based on its username and an LDAP attribute. Once found,
the it&#8217;ll be authenticated by attempting to bind it to the LDAP server using the
found DN and the provided password.</simpara>
<simpara>To configure an <literal>ldap</literal> Realm with User Search:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Add a realm configuration of type <literal>ldap</literal> to <literal>elasticsearch.yml</literal> under the
<literal>xpack.security.authc.realms</literal> namespace. At a minimum, you must set the realm <literal>type</literal>
to <literal>ldap</literal>, specify the <literal>url</literal> of the LDAP server, and set <literal>user_search.base_dn</literal>
to the container DN where the users are searched for. If you are configuring
multiple realms, you should also explicitly set the <literal>order</literal> attribute to control
the order in which the realms are consulted during authentication. See
<link linkend="ldap-settings">LDAP Realm Settings</link> for all of the options you can set for an
<literal>ldap</literal> realm.
</simpara>
<simpara>For example, the following snippet shows an LDAP realm configured with a user search:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack:
  security:
    authc:
      realms:
        ldap1:
          type: ldap
          order: 0
          url: "ldaps://ldap.example.com:636"
          bind_dn: "cn=ldapuser, ou=users, o=services, dc=example, dc=com"
          bind_password: changeme
          user_search:
            base_dn: "dc=example,dc=com"
            attribute: cn
          group_search:
            base_dn: "dc=example,dc=com"
          files:
            role_mapping: "CONFIG_DIR/x-pack/role_mapping.yml"
          unmapped_groups_as_roles: false</programlisting>
<important><simpara>When you configure realms in <literal>elasticsearch.yml</literal>, only the
realms you specify are used for authentication. If you also want to use the
<literal>native</literal> or <literal>file</literal> realms, you must include them in the realm chain.</simpara></important>
</listitem>
<listitem>
<simpara>
Restart Elasticsearch
</simpara>
</listitem>
</orderedlist>
</section>
<section id="_user_dn_templates_mode">
<title>User DN Templates Mode<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/ldap-realm.asciidoc">Edit me</ulink></title>
<simpara>If your LDAP environment uses a few specific standard naming conditions for
users, you can use User DN templates to configure the realm. The advantage of
this method is that a search does not have to be performed to find the user DN.
However, multiple bind operations might be needed to find the correct user DN.</simpara>
<simpara>To configure an <literal>ldap</literal> Realm with User Search:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Add a realm configuration of type <literal>ldap</literal> to <literal>elasticsearch.yml</literal> in the
<literal>xpack.security.authc.realms</literal> namespace. At a minimum, you must set the realm <literal>type</literal> to
<literal>ldap</literal>, specify the <literal>url</literal> of the LDAP server, and specify at least one template
with the <literal>user_dn_templates</literal> option. If you are configuring multiple realms, you
should also explicitly set the <literal>order</literal> attribute to control the order in which
the realms are consulted during authentication. See <link linkend="ldap-settings">LDAP Realm Settings</link>
for all of the options you can set for an <literal>ldap</literal> realm.
</simpara>
<simpara>For example, the following snippet shows an LDAP realm configured with User DN templates:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack:
  security:
    authc:
      realms:
        ldap1:
          type: ldap
          order: 0
          url: "ldaps://ldap.example.com:636"
          user_dn_templates:
            - "cn={0}, ou=users, o=marketing, dc=example, dc=com"
            - "cn={0}, ou=users, o=engineering, dc=example, dc=com"
          group_search:
            base_dn: "dc=example,dc=com"
          files:
            role_mapping: "/mnt/elasticsearch/group_to_role_mapping.yml"
          unmapped_groups_as_roles: false</programlisting>
</listitem>
<listitem>
<simpara>
Restart Elasticsearch
</simpara>
</listitem>
</orderedlist>
</section>
<section id="ldap-load-balancing">
<title>Load Balancing and Failover<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/ldap-realm.asciidoc">Edit me</ulink></title>
<simpara>The <literal>load_balance.type</literal> setting can be used at the realm level to configure how
X-Pack security should interact with multiple LDAP servers. X-Pack security supports both
failover and load balancing modes of operation.</simpara>
<table
frame="all"
rowsep="1" colsep="1"
>
<title>Load Balancing and Failover Types</title>
<tgroup cols="4">
<colspec colname="col_1" colwidth="25*"/>
<colspec colname="col_2" colwidth="25*"/>
<colspec colname="col_3" colwidth="25*"/>
<colspec colname="col_4" colwidth="25*"/>
<tbody>
<row>
<entry align="left" valign="top"><simpara>Type</simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Description</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>failover</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>The URLs specified are used in the order that they are specified.
                          The first server that can be connected to will be used for all
                          subsequent connections. If a connection to that server fails then
                          the next server that a connection can be established to will be
                          used for subsequent connections.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>dns_failover</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>In this mode of operation, only a single URL may be specified.
                          This URL must contain a DNS name. The system will be queried for
                          all IP addresses that correspond to this DNS name. Connections to
                          the LDAP server will always be tried in the order in which they
                          were retrieved. This differs from <literal>failover</literal> in that there is no
                          reordering of the list and if a server has failed at the beginning
                          of the list, it will still be tried for each subsequent connection.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>round_robin</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Connections will continuously iterate through the list of provided
                          URLs. If a server is unavailable, iterating through the list of
                          URLs will continue until a successful connection is made.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>dns_round_robin</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>In this mode of operation, only a single URL may be specified. This
                          URL must contain a DNS name. The system will be queried for all IP
                          addresses that correspond to this DNS name. Connections will
                          continuously iterate through the list of addresses. If a server is
                          unavailable, iterating through the list of URLs will continue until
                          a successful connection is made.</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
</section>
<section id="ldap-settings">
<title>LDAP Realm Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/ldap-realm.asciidoc">Edit me</ulink></title>
<table
frame="all"
rowsep="1" colsep="1"
>
<title>Common LDAP Realm Settings</title>
<tgroup cols="3">
<colspec colname="col_1" colwidth="23*"/>
<colspec colname="col_2" colwidth="17*"/>
<colspec colname="col_3" colwidth="58*"/>
<tbody>
<row>
<entry align="left" valign="top"><simpara>Setting</simpara></entry>
<entry align="center" valign="top"><simpara>Required</simpara></entry>
<entry align="left" valign="top"><simpara>Description</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>type</literal></simpara></entry>
<entry align="center" valign="top"><simpara>yes</simpara></entry>
<entry align="left" valign="top"><simpara>Indicates the realm type. Must be set to <literal>ldap</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>order</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Indicates the priority of this realm within the realm
                                              chain. Realms with a lower order are consulted first.
                                              Although not required, we recommend explicitly
                                              setting this value when you configure multiple realms.
                                              Defaults to <literal>Integer.MAX_VALUE</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>enabled</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Indicates whether this realm is enabled or disabled.
                                              Enables you to disable a realm without removing its
                                              configuration. Defaults to <literal>true</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>url</literal></simpara></entry>
<entry align="center" valign="top"><simpara>yes</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies one or more LDAP URLs of the form of
                                              <literal>ldap[s]://&lt;server&gt;:&lt;port&gt;</literal>. Multiple URLs can be
                                              defined using a comma separated value or array syntax:
                                              <literal>[ "ldaps://server1:636", "ldaps://server2:636" ]</literal>.
                                              <literal>ldaps</literal> and <literal>ldap</literal> URL protocols cannot be mixed in
                                              the same realm.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>load_balance.type</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>The behavior to use when there are multiple LDAP URLs
                                              defined. For supported values see
                                              <link linkend="ldap-load-balancing">LDAP load balancing and failover types</link>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>load_balance.cache_ttl</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>When using <literal>dns_failover</literal> or <literal>dns_round_robin</literal> as the
                                              load balancing type, this setting controls the amount of time
                                              to cache DNS lookups. Defaults to <literal>1h</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>user_group_attribute</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the attribute to examine on the user for group
                                              membership. The default is <literal>memberOf</literal>. This setting will
                                              be ignored if any <literal>group_search</literal> settings are specified.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>group_search.base_dn</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies a container DN to search for groups in which
                                              the user has membership. When this element is absent,
                                              Security searches for the attribute specified by
                                              <literal>user_group_attribute</literal> set on the user to determine
                                              group membership.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>group_search.scope</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies whether the group search should be
                                              <literal>sub_tree</literal>, <literal>one_level</literal> or <literal>base</literal>.  <literal>one_level</literal> only
                                              searches objects directly contained within the
                                              <literal>base_dn</literal>. The default <literal>sub_tree</literal> searches all objects
                                              contained under <literal>base_dn</literal>. <literal>base</literal> specifies that the
                                              <literal>base_dn</literal> is a group object, and that it is the only
                                              group considered.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>group_search.filter</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies a filter to use to lookup a group. If not
                                              set, the realm searches for <literal>group</literal>,
                                              <literal>groupOfNames</literal>, <literal>groupOfUniqueNames</literal>, or <literal>posixGroup</literal> with the
                                              attributes <literal>member</literal>, <literal>memberOf</literal>, or <literal>memberUid</literal>. Any instance of
                                              <literal>{0}</literal> in the filter is replaced by the user
                                              attribute defined in <literal>group_search.user_attribute</literal></simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>group_search.user_attribute</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the user attribute that is fetched and
                                              provided as a parameter to the filter.  If not set,
                                              the user DN is passed to the filter.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>unmapped_groups_as_roles</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies whether the names of any unmapped LDAP groups
                                              should be used as role names and assigned to the user.
                                              Defaults to <literal>false</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>connect_timeout</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the timeout period for establishing an
                                              LDAP connection. An <literal>s</literal> at the end indicates seconds,
                                              <literal>ms</literal> indicates milliseconds. Defaults to <literal>5s</literal> (5 seconds).</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>read_timeout</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>The timeout period for an LDAP operation.  An <literal>s</literal> at
                                              the end indicates seconds, <literal>ms</literal> indicates
                                              milliseconds. Defaults to <literal>5s</literal> (5 seconds).</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>files.role_mapping</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the path and file name for the
                                              <link linkend="ldap-role-mapping">YAML role mapping configuration file</link>.
                                              Defaults to <literal>ES_HOME/config/x-pack/role_mapping.yml</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>follow_referrals</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies whether X-Pack security should follow referrals
                                              returned by the LDAP server. Referrals are URLs returned by
                                              the server that are to be used to continue the LDAP operation
                                              (e.g. search). Defaults to <literal>true</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ssl.key</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the path to the PEM encoded private key to use if the LDAP
                                              server requires client authentication. <literal>ssl.key</literal> and <literal>ssl.keystore.path</literal>
                                              may not be used at the same time.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ssl.key_passphrase</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the passphrase to decrypt the PEM encoded private key if it is encrypted.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ssl.certificate</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the path to the PEM encoded certificate (or certificate chain) that goes with the
                                              key if the LDAP server requires client authentication.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ssl.certificate_authorities</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the paths to the PEM encoded certificate authority certificates that
                                              should be trusted. <literal>ssl.certificate_authorities</literal> and <literal>ssl.trustsore.path</literal> may not be used
                                              at the same time.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ssl.keystore.path</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>The path to the Java Keystore file that contains a private key and certificate. <literal>ssl.key</literal> and
                                              <literal>ssl.keystore.path</literal> may not be used at the same time.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ssl.keystore.password</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>The password to the keystore.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ssl.keystore.key_password</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>The password for the key in the keystore. Defaults to the keystore password.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ssl.truststore.path</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>The path to the Java Keystore file that contains the certificates to trust.
                                              <literal>ssl.certificate_authorities</literal> and <literal>ssl.trustsore.path</literal> may not be used at the same time.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ssl.truststore.password</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>The password to the truststore.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ssl.verification_mode</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the type of verification to be performed when
                                              connecting to a LDAP server using <literal>ldaps</literal>. When
                                              set to <literal>full</literal>, the hostname or IP address used in the <literal>url</literal>
                                              must match one of the names in the certificate or the
                                              connection will not be allowed. Due to their potential security impact,
                                              <literal>ssl</literal> settings are not exposed via the
                                              <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/cluster-nodes-info.html#cluster-nodes-info">nodes info API</ulink>.
                                              Values are <literal>none</literal>, <literal>certificate</literal>, and <literal>full</literal>. Defaults to <literal>full</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ssl.supported_protocols</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the supported protocols for SSL/TLS.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ssl.cipher_suites</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the cipher suites that should be supported when communicating
                                              with the LDAP server.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>cache.ttl</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the time-to-live for cached user entries. A
                                              user&#8217;s credentials are cached for this period of time.
                                              Specify the time period using the standard Elasticsearch
                                              <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/common-options.html#time-units">time units</ulink>.
                                              Defaults to <literal>20m</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>cache.max_users</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the maximum number of user entries that can be
                                              stored in the cache at one time. Defaults to 100,000.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>cache.hash_algo</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the hashing algorithm that is used for the
                                              cached user credentials. See
                                              <link linkend="cache-hash-algo">Cache hash algorithms</link> for the possible
                                              values. (Expert Setting).</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<table
frame="all"
rowsep="1" colsep="1"
>
<title>User Search Mode Settings</title>
<tgroup cols="3">
<colspec colname="col_1" colwidth="33*"/>
<colspec colname="col_2" colwidth="33*"/>
<colspec colname="col_3" colwidth="33*"/>
<tbody>
<row>
<entry align="left" valign="top"><simpara>Setting</simpara></entry>
<entry align="left" valign="top"><simpara>Required</simpara></entry>
<entry align="left" valign="top"><simpara>Description</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>bind_dn</literal></simpara></entry>
<entry align="left" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>The DN of the user that is used to bind to the LDAP
                                                        and perform searches. If not specified, an anonymous
                                                        bind is attempted. Due to its potential security
                                                        impact, <literal>bind_dn</literal> is not exposed via the
                                                        <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/cluster-nodes-info.html#cluster-nodes-info">nodes info API</ulink>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>bind_password</literal></simpara></entry>
<entry align="left" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>The password for the user that is used to bind to the
                                                        LDAP. Due to its potential security impact,
                                                        <literal>bind_password</literal> is not exposed via the
                                                        <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/cluster-nodes-info.html#cluster-nodes-info">nodes info API</ulink>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>user_search.base_dn</literal></simpara></entry>
<entry align="left" valign="top"><simpara>yes</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies a container DN to search for users.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>user_search.scope</literal></simpara></entry>
<entry align="left" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>The scope of the user search. Valid values are <literal>sub_tree</literal>,
                                                        <literal>one_level</literal> or <literal>base</literal>. <literal>one_level</literal> only searches objects
                                                        directly contained within the <literal>base_dn</literal>. <literal>sub_tree</literal> searches
                                                        all objects contained under <literal>base_dn</literal>. <literal>base</literal> specifies
                                                        that the <literal>base_dn</literal> is the user object, and that it is the
                                                        only user considered. Defaults to <literal>sub_tree</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>user_search.attribute</literal></simpara></entry>
<entry align="left" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the attribute to match with the username presented
                                                        to. Defaults to <literal>uid</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>user_search.pool.enabled</literal></simpara></entry>
<entry align="left" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Enables or disables connection pooling for user search. When
                                                        disabled a new connection is created for every search. The
                                                        default is <literal>true</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>user_search.pool.size</literal></simpara></entry>
<entry align="left" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the maximum number of connections to the LDAP
                                                        server to allow in the connection pool. Defaults to <literal>20</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>user_search.pool.initial_size</literal></simpara></entry>
<entry align="left" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>The initial number of connections to create to the LDAP
                                                        server on startup. Defaults to <literal>0</literal>. Values greater than <literal>0</literal>
                                                        could cause startup failures if the LDAP server is down.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>user_search.pool.health_check.enabled</literal></simpara></entry>
<entry align="left" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Enables or disables a health check on LDAP connections in
                                                        the connection pool. Connections are checked in the
                                                        background at the specified interval. Defaults to <literal>true</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>user_search.pool.health_check.dn</literal></simpara></entry>
<entry align="left" valign="top"><simpara>no/yes</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the distinguished name to retrieve as part of
                                                        the health check. Defaults to the value of <literal>bind_dn</literal>.
                                                        This setting is required when <literal>bind_dn</literal> is not configured.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>user_search.pool.health_check.interval</literal></simpara></entry>
<entry align="left" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>How often to perform background checks of connections in
                                                        the pool. Defaults to <literal>60s</literal>.</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<table
frame="all"
rowsep="1" colsep="1"
>
<title>User Templates Mode Settings</title>
<tgroup cols="3">
<colspec colname="col_1" colwidth="23*"/>
<colspec colname="col_2" colwidth="17*"/>
<colspec colname="col_3" colwidth="58*"/>
<tbody>
<row>
<entry align="left" valign="top"><simpara>Setting</simpara></entry>
<entry align="center" valign="top"><simpara>Required</simpara></entry>
<entry align="left" valign="top"><simpara>Description</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>user_dn_templates</literal></simpara></entry>
<entry align="center" valign="top"><simpara>yes</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the DN template that replaces the
                                      user name with the string <literal>{0}</literal>. This element
                                      is multivalued, allowing for multiple user
                                      contexts.</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<note><simpara>If any settings starting with <literal>user_search</literal> are specified, the
        <literal>user_dn_templates</literal> the settings are ignored.</simpara></note>
</section>
</section>
<section id="mapping-roles-ldap">
<title>Mapping LDAP Groups to Roles<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/ldap-realm.asciidoc">Edit me</ulink></title>
<simpara>An integral part of a realm authentication process is to resolve the roles
associated with the authenticated user. Roles define the privileges a user has
in the cluster.</simpara>
<simpara>Since with the <literal>ldap</literal> realm the users are managed externally in the LDAP server,
the expectation is that their roles are managed there as well. If fact, LDAP
supports the notion of groups, which often represent user roles for different
systems in the organization.</simpara>
<simpara>The <literal>ldap</literal> realm enables you to map LDAP groups to roles in the role mapping
file stored on each node. When a user authenticates with LDAP, the privileges
for that user are the union of all privileges defined by the roles assigned to
the set of groups that the user belongs to.</simpara>
<simpara>You specify groups using their distinguished names. For example, the following
mapping configuration maps the LDAP <literal>admins</literal> group to both the <literal>monitoring</literal> and
<literal>user</literal> roles, and maps the <literal>users</literal> group to the <literal>user</literal> role.</simpara>
<programlisting language="yaml" linenumbering="unnumbered">monitoring: <co id="CO5-1"/>
  - "cn=admins,dc=example,dc=com" <co id="CO5-2"/>
user:
  - "cn=users,dc=example,dc=com" <co id="CO5-3"/>
  - "cn=admins,dc=example,dc=com"</programlisting>
<calloutlist>
<callout arearefs="CO5-1">
<para>
The name of the mapped role.
</para>
</callout>
<callout arearefs="CO5-2">
<para>
The LDAP distinguished name (DN) of the <literal>admins</literal> group.
</para>
</callout>
<callout arearefs="CO5-3">
<para>
The LDAP distinguished name (DN) of the <literal>users</literal> group.
</para>
</callout>
</calloutlist>
<simpara>For more information, see <link linkend="mapping-roles">Mapping Users and Groups to Roles</link>.</simpara>
</section>
<section id="ldap-ssl">
<title>Setting up SSL Between Elasticsearch and LDAP<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/ldap-realm.asciidoc">Edit me</ulink></title>
<simpara>To protect the user credentials that are sent for authentication, it&#8217;s highly
recommended to encrypt communications between Elasticsearch and your LDAP server.
Connecting via SSL/TLS ensures that the identity of the LDAP server is
authenticated before X-Pack security transmits the user credentials and the contents
of the connection are encrypted.</simpara>
<simpara>To encrypt communications between Elasticsearch and your LDAP server:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Configure the realm&#8217;s SSL settings on each node to trust certificates signed by the CA that signed your
LDAP server certificates. The following example demonstrates how to trust a CA certificate,
<literal>cacert.pem</literal>, located within the X-Pack configuration directory:
</simpara>
<programlisting language="shell" linenumbering="unnumbered">xpack:
  security:
    authc:
      realms:
        ldap1:
          type: ldap
          order: 0
          url: "ldaps://ldap.example.com:636"
          ssl:
            certificate_authorities: [ "CONFIG_DIR/x-pack/cacert.pem" ]</programlisting>
<simpara>The CA cert must be a PEM encoded certificate.</simpara>
<note>
<simpara>You can also specify the individual server certificates rather than the CA
certificate, but this is only recommended if you have a single LDAP server
or the certificates are self-signed.</simpara>
</note>
</listitem>
<listitem>
<simpara>
Set the <literal>url</literal> attribute in the realm configuration to specify the LDAPS
protocol and the secure port number. For example, <literal>url: ldaps://ldap.example.com:636</literal>.
</simpara>
</listitem>
<listitem>
<simpara>
Restart Elasticsearch.
</simpara>
</listitem>
</orderedlist>
<note><simpara>By default, when you configure X-Pack security to connect to an LDAP server
      using SSL/TLS, X-Pack security attempts to verify the hostname or IP address
      specified with the <literal>url</literal> attribute in the realm configuration with the
      values in the certificate. If the values in the certificate and realm
      configuration do not match, X-Pack security does not allow a connection to the
      LDAP server. This is done to protect against man-in-the-middle attacks. If
      necessary, you can disable this behavior by setting the
      <literal>ssl.verification_mode</literal> property to <literal>none</literal>.</simpara></note>
</section>
</section>
<section id="active-directory-realm">
<title>Active Directory User Authentication<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/active-directory-realm.asciidoc">Edit me</ulink></title>
<simpara>You can configure X-Pack security to communicate with Active Directory to authenticate
users. To integrate with Active Directory, you configure an <literal>active_directory</literal>
realm and map Active Directory users and groups to X-Pack security roles in the
<link linkend="mapping-roles">role mapping file</link>.</simpara>
<simpara>To protect passwords, communications between Elasticsearch and the Active Directory
server should be encrypted using SSL/TLS. Clients and nodes that connect via
SSL/TLS to the Active Directory server need to have the Active Directory server&#8217;s
certificate or the server&#8217;s root CA certificate installed in their keystore or
truststore. For more information about installing certificates, see
<xref linkend="active-directory-ssl"/>.</simpara>
<section id="_configuring_an_active_directory_realm">
<title>Configuring an Active Directory Realm<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/active-directory-realm.asciidoc">Edit me</ulink></title>
<simpara>X-Pack security uses LDAP to communicate with Active Directory, so <literal>active_directory</literal>
realms are similar to <link linkend="ldap-realm"><literal>ldap</literal> realms</link>. Like LDAP directories,
Active Directory stores users and groups hierarchically. The directory&#8217;s
hierarchy is built from containers such as the <emphasis>organizational unit</emphasis> (<literal>ou</literal>),
<emphasis>organization</emphasis> (<literal>o</literal>), and <emphasis>domain controller</emphasis> (<literal>dc</literal>).</simpara>
<simpara>The path to an entry is a <emphasis>Distinguished Name</emphasis> (DN) that uniquely identifies a
user or group. User and group names typically have attributes such as a
<emphasis>common name</emphasis> (<literal>cn</literal>) or <emphasis>unique ID</emphasis> (<literal>uid</literal>). A DN is specified as a string, for
example <literal>"cn=admin,dc=example,dc=com"</literal> (white spaces are ignored).</simpara>
<simpara>X-Pack security only supports Active Directory security groups. You cannot map
distribution groups to roles.</simpara>
<note><simpara>When you use Active Directory for authentication, the username entered by
      the user is expected to match the <literal>sAMAccountName</literal> or <literal>userPrincipalName</literal>,
      not the common name.</simpara></note>
<simpara>To configure an <literal>active_directory</literal> realm:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Add a realm configuration of type <literal>active_directory</literal> to <literal>elasticsearch.yml</literal>
under the <literal>xpack.security.authc.realms</literal> namespace. At a minimum, you must set the realm
<literal>type</literal> to <literal>active_directory</literal> and specify the Active Directory <literal>domain_name</literal>. To
use SSL/TLS for secured communication with the Active Directory server, you must
also set the <literal>url</literal> attribute and specify the <literal>ldaps</literal> protocol and secure port
number. If you are configuring multiple realms, you should also explicitly set
the <literal>order</literal> attribute to control the order in which the realms are consulted
during authentication. See <link linkend="ad-settings">Active Directory Realm Settings</link>
for all of the options you can set for an <literal>active_directory</literal> realm.
</simpara>
<note><simpara>Binding to Active Directory fails if the domain name is not mapped in DNS.
      If DNS is not being provided by a Windows DNS server, add a mapping for
      the domain in the local <literal>/etc/hosts</literal> file.</simpara></note>
<simpara>For example, the following realm configuration configures X-Pack security to connect
to <literal>ldaps://example.com:636</literal> to authenticate users through Active Directory.</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack:
  security:
    authc:
      realms:
        active_directory:
          type: active_directory
          order: 0 <co id="CO6-1"/>
          domain_name: ad.example.com
          url: ldaps://ad.example.com:636 <co id="CO6-2"/>
          unmapped_groups_as_roles: true <co id="CO6-3"/></programlisting>
<calloutlist>
<callout arearefs="CO6-1">
<para>
The realm order controls the order in which the configured realms are checked
    when authenticating a user.
</para>
</callout>
<callout arearefs="CO6-2">
<para>
If you don&#8217;t specify the URL, it defaults to <literal>ldap:&lt;domain_name&gt;:389</literal>.
</para>
</callout>
<callout arearefs="CO6-3">
<para>
When this option is enabled, Active Directory groups are automatically mapped
    to roles of the same name.
</para>
<important><simpara>When you configure realms in <literal>elasticsearch.yml</literal>, only the
realms you specify are used for authentication. If you also want to use the
<literal>native</literal> or <literal>file</literal> realms, you must include them in the realm chain.</simpara></important>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>
Restart Elasticsearch.
</simpara>
</listitem>
</orderedlist>
<section id="_multiple_domain_support">
<title>Multiple Domain Support<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/active-directory-realm.asciidoc">Edit me</ulink></title>
<simpara>When authenticating users across multiple domains in a forest, there are a few minor
differences in the configuration and the way that users will authenticate. The <literal>domain_name</literal>
setting should be set to the forest root domain name. The <literal>url</literal> setting also needs to
be set as you will need to authenticate against the Global Catalog, which uses a different
port and may not be running on every Domain Controller.</simpara>
<simpara>For example, the following realm configuration configures X-Pack security to connect to specific
Domain Controllers on the Global Catalog port with the domain name set to the forest root.</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack:
  security:
    authc:
      realms:
        active_directory:
          type: active_directory
          order: 0
          domain_name: example.com <co id="CO7-1"/>
          url: ldaps://dc1.ad.example.com:3269, ldaps://dc2.ad.example.com:3269 <co id="CO7-2"/>
          load_balance:
            type: "round_robin" <co id="CO7-3"/></programlisting>
<calloutlist>
<callout arearefs="CO7-1">
<para>
The <literal>domain_name</literal> is set to the name of the root domain in the forest.
</para>
</callout>
<callout arearefs="CO7-2">
<para>
The <literal>url</literal> value used in this example has URLs for two different Domain Controllers,
which are also Global Catalog servers. Port 3268 is the default port for unencrypted
communication with the Global Catalog; port 3269 is the default port for SSL connections.
The servers that are being connected to can be in any domain of the forest as long as
they are also Global Catalog servers.
</para>
</callout>
<callout arearefs="CO7-3">
<para>
A load balancing setting is provided to indicate the desired behavior when choosing
the server to connect to.
</para>
</callout>
</calloutlist>
<simpara>In this configuration, users will need to use either their full User Principal
Name (UPN) or their Down-Level Logon Name. A UPN is typically a concatenation of
the username with <literal>@&lt;DOMAIN_NAME</literal> such as <literal>johndoe@ad.example.com</literal>. The Down-Level
Logon Name is the NetBIOS domain name, followed by a <literal>\</literal> and the username, such as
<literal>AD\johndoe</literal>. Use of Down-Level Logon Name requires a connection to the regular LDAP
ports (389 or 636) in order to query the configuration container to retrieve the
domain name from the NetBIOS name.</simpara>
</section>
<section id="ad-load-balancing">
<title>Load Balancing and Failover<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/active-directory-realm.asciidoc">Edit me</ulink></title>
<simpara>The <literal>load_balance.type</literal> setting can be used at the realm level to configure how
X-Pack security should interact with multiple Active Directory servers. Two modes of
operation are supported: failover and load balancing</simpara>
<table
frame="all"
rowsep="1" colsep="1"
>
<title>Load Balancing and Failover Types</title>
<tgroup cols="4">
<colspec colname="col_1" colwidth="25*"/>
<colspec colname="col_2" colwidth="25*"/>
<colspec colname="col_3" colwidth="25*"/>
<colspec colname="col_4" colwidth="25*"/>
<tbody>
<row>
<entry align="left" valign="top"><simpara>Type</simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Description</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>failover</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>The URLs specified are used in the order that they are
                          specified. The first server that can be connected to will
                          be used for all subsequent connections. If a connection to
                          that server fails then the next server that a connection
                          can be established to will be used for subsequent connections.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>dns_failover</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>In this mode of operation, only a single URL may be specified.
                          This URL must contain a DNS name. The system will be queried
                          for all IP addresses that correspond to this DNS name.
                          Connections to the Active Directory server will always be
                          tried in the order in which they were retrieved. This differs
                          from <literal>failover</literal> in that there is no reordering of the list
                          and if a server has failed at the beginning of the list, it
                          will still be tried for each subsequent connection.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>round_robin</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Connections will continuously iterate through the list of
                          provided URLs. If a server is unavailable, iterating through
                          the list of URLs will continue until a successful connection
                          is made.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>dns_round_robin</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>In this mode of operation, only a single URL may be specified.
                          This URL must contain a DNS name. The system will be queried
                          for all IP addresses that correspond to this DNS name.
                          Connections will continuously iterate through the list of
                          addresses. If a server is unavailable, iterating through the
                          list of URLs will continue until a successful connection is
                          made.</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
</section>
<section id="ad-settings">
<title>Active Directory Realm Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/active-directory-realm.asciidoc">Edit me</ulink></title>
<informaltable
frame="all"
rowsep="1" colsep="1"
>
<tgroup cols="3">
<colspec colname="col_1" colwidth="23*"/>
<colspec colname="col_2" colwidth="17*"/>
<colspec colname="col_3" colwidth="58*"/>
<tbody>
<row>
<entry align="left" valign="top"><simpara>Setting</simpara></entry>
<entry align="center" valign="top"><simpara>Required</simpara></entry>
<entry align="left" valign="top"><simpara>Description</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>type</literal></simpara></entry>
<entry align="center" valign="top"><simpara>yes</simpara></entry>
<entry align="left" valign="top"><simpara>Indicates the realm type. Must be set to <literal>active_directory</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>order</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Indicates the priority of this realm within the realm chain.
                                          Realms with a lower order are consulted first. Although not
                                          required, we recommend explicitly setting this value when
                                          you configure multiple realms. Defaults to <literal>Integer.MAX_VALUE</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>enabled</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Indicates whether this realm is enabled or disabled. Enables
                                          you to disable a realm without removing its configuration.
                                          Defaults to <literal>true</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>domain_name</literal></simpara></entry>
<entry align="center" valign="top"><simpara>yes</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the domain name of the Active Directory. X-Pack security
                                          uses the domain name to derive the LDAP URL and <literal>user_search_dn</literal>
                                          if those fields are not specified.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>url</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no/yes</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies an LDAP URL of the form <literal>ldap[s]://&lt;server&gt;:&lt;port&gt;</literal>.
                                          X-Pack security attempts to authenticate against this URL. If the
                                          URL is not specified, it is derived from the <literal>domain_name</literal>,
                                          assuming an unencrypted connection to port 389. For example,
                                          <literal>ldap://&lt;domain_name&gt;:389</literal>. This settings is required when
                                          connecting using SSL/TLS or via a custom port.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>load_balance.type</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>The behavior to use when there are multiple LDAP URLs defined.
                                          For supported values see <xref linkend="ad-load-balancing"/>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>load_balance.cache_ttl</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>When using <literal>dns_failover</literal> or <literal>dns_round_robin</literal> as the load
                                          balancing type, this setting controls the amount of time to
                                          cache DNS lookups. Defaults to <literal>1h</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>user_search.base_dn</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the context to search for the user. Defaults to the
                                          root of the Active Directory domain.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>user_search.scope</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies whether the user search should be <literal>sub_tree</literal> (default),
                                          <literal>one_level</literal>, or <literal>base</literal>. <literal>sub_tree</literal> searches all objects contained
                                          under <literal>base_dn</literal>. <literal>one_level</literal> only searches users directly
                                          contained within the <literal>base_dn</literal>. <literal>base</literal> specifies that the
                                          <literal>base_dn</literal> is a user object and that it is the only user considered.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>user_search.filter</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies a filter to use to lookup a user given a username.
                                          The default filter looks up <literal>user</literal> objects with either
                                          <literal>sAMAccountName</literal> or <literal>userPrincipalName</literal>. If specified, this
                                          must be a valid LDAP user search filter, for example
                                          <literal>(&amp;(objectClass=user)(sAMAccountName={0}))</literal>. For more
                                          information, see <ulink url="https://msdn.microsoft.com/en-us/library/aa746475(v=vs.85).aspx">Search Filter Syntax</ulink>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>group_search.base_dn</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the context to search for groups in which the user
                                          has membership. Defaults to the root of the Active Directory
                                          domain.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>group_search.scope</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies whether the group search should be <literal>sub_tree</literal> (default),
                                          <literal>one_level</literal> or <literal>base</literal>.  <literal>sub_tree</literal> searches all objects contained
                                          under <literal>base_dn</literal>. <literal>one_level</literal> searches for groups directly
                                          contained within the <literal>base_dn</literal>. <literal>base</literal> specifies that the
                                          <literal>base_dn</literal> is a group object and that it is the only group considered.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>unmapped_groups_as_roles</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies whether the names of any unmapped Active Directory
                                          groups should be used as role names and assigned to the user.
                                          Defaults to <literal>false</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>files.role_mapping</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the path and file name of the
                                          <link linkend="ad-role-mapping">YAML role  mapping configuration file</link>.
                                          Defaults to <literal>CONF_DIR/x-pack/role_mapping.yml</literal>,
                                          where <literal>CONF_DIR</literal> is <literal>ES_HOME/config</literal> (zip/tar installations)
                                          or <literal>/etc/elasticsearch</literal> (package installations).</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>follow_referrals</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies whether X-Pack security should follow referrals returned
                                          by the Active Directory server. Referrals are URLs returned by
                                          the server that are to be used to continue the LDAP operation
                                          (such as <literal>search</literal>). Defaults to <literal>true</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ssl.key</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the path to the PEM encoded private key to use if the Active Directory
                                          server requires client authentication. <literal>ssl.key</literal> and <literal>ssl.keystore.path</literal> may not be used at the
                                          same time.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ssl.key_passphrase</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the passphrase to decrypt the PEM encoded private key if it is encrypted.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ssl.certificate</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the path to the PEM encoded certificate (or certificate chain) that goes with the key
                                          if the Active Directory server requires client authentication.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ssl.certificate_authorities</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the paths to the PEM encoded certificate authority certificates that
                                          should be trusted. <literal>ssl.certificate_authorities</literal> and <literal>ssl.trustsore.path</literal> may not be used at
                                          the same time.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ssl.keystore.path</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>The path to the Java Keystore file that contains a private key and certificate. <literal>ssl.key</literal> and
                                          <literal>ssl.keystore.path</literal> may not be used at the same time.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ssl.keystore.password</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>The password to the keystore.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ssl.keystore.key_password</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>The password for the key in the keystore. Defaults to the keystore password.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ssl.truststore.path</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>The path to the Java Keystore file that contains the certificates to trust.
                                          <literal>ssl.certificate_authorities</literal> and <literal>ssl.trustsore.path</literal> may not be used at the same time.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ssl.truststore.password</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>The password to the truststore.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ssl.verification_mode</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the type of verification to be performed when
                                          connecting to an Active Directory server using <literal>ldaps</literal>. When
                                          set to <literal>full</literal>, the hostname or IP address used in the <literal>url</literal>
                                          must match one of the names in the certificate or the
                                          connection will not be allowed. Due to their potential security impact,
                                          <literal>ssl</literal> settings are not exposed via the
                                          <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/cluster-nodes-info.html#cluster-nodes-info">nodes info API</ulink>.
                                          Values are <literal>none</literal>, <literal>certificate</literal>, and <literal>full</literal>. Defaults to <literal>full</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ssl.supported_protocols</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the supported protocols for TLS/SSL.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ssl.cipher_suites</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the cipher suites that should be supported when communicating
                                          with the Active Directory server.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>cache.ttl</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the time-to-live for cached user entries. A user&#8217;s
                                          credentials are cached for this period of time. Specify the
                                          time period using the standard Elasticsearch
                                          <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/common-options.html#time-units">time units</ulink>.
                                          Defaults to <literal>20m</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>cache.max_users</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the maximum number of user entries that can be
                                          stored in the cache at one time. Defaults to 100,000.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>cache.hash_algo</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the hashing algorithm that is used for the
                                          cached user credentials.
                                          See <link linkend="cache-hash-algo">Cache hash algorithms</link> for the
                                          possible values. (Expert Setting).</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
</section>
</section>
<section id="mapping-roles-ad">
<title>Mapping Active Directory Users and Groups to Roles<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/active-directory-realm.asciidoc">Edit me</ulink></title>
<simpara>An integral part of a realm authentication process is to resolve the roles
associated with the authenticated user. Roles define the privileges a user has
in the cluster.</simpara>
<simpara>Since with the <literal>active_directory</literal> realm the users are managed externally in the
Active Directory server, the expectation is that their roles are managed there
as well. If fact, Active Directory supports the notion of groups, which often
represent user roles for different systems in the organization.</simpara>
<simpara>The <literal>active_directory</literal> realm enables you to map Active Directory users and groups
to roles in the role mapping file stored on each node. You specify users and
groups using their distinguished names (DNs). For example, the following mapping
configuration maps the Active Directory <literal>admins</literal> group to both the <literal>monitoring</literal>
and <literal>user</literal> roles, maps the <literal>users</literal> group to the <literal>user</literal> role and maps the <literal>John Doe</literal>
user to the <literal>user</literal> role.</simpara>
<programlisting language="yaml" linenumbering="unnumbered">monitoring: <co id="CO8-1"/>
  - "cn=admins,dc=example,dc=com" <co id="CO8-2"/>
user:
  - "cn=users,dc=example,dc=com" <co id="CO8-3"/>
  - "cn=admins,dc=example,dc=com"
  - "cn=John Doe,cn=contractors,dc=example,dc=com" <co id="CO8-4"/></programlisting>
<calloutlist>
<callout arearefs="CO8-1">
<para>
The name of the role.
</para>
</callout>
<callout arearefs="CO8-2">
<para>
The Active Directory distinguished name (DN) of the <literal>admins</literal> group.
</para>
</callout>
<callout arearefs="CO8-3">
<para>
The Active Directory distinguished name (DN) of the <literal>users</literal> group.
</para>
</callout>
<callout arearefs="CO8-4">
<para>
The Active Directory distinguished name (DN) of the user <literal>John Doe</literal>.
</para>
</callout>
</calloutlist>
<simpara>For more information, see <link linkend="mapping-roles">Mapping Users and Groups to Roles</link>.</simpara>
</section>
<section id="active-directory-ssl">
<title>Setting up SSL Between Elasticsearch and Active Directory<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/active-directory-realm.asciidoc">Edit me</ulink></title>
<simpara>To protect the user credentials that are sent for authentication, it&#8217;s highly
recommended to encrypt communications between Elasticsearch and your Active
Directory server. Connecting via SSL/TLS ensures that the identity of the Active
Directory server is authenticated before X-Pack security transmits the user
credentials, and the usernames and passwords are encrypted in transit.</simpara>
<simpara>To encrypt communications between Elasticsearch and Active Directory:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Configure each node to trust certificates signed by the CA that signed your
Active Directory server certificates. The following example demonstrates how to trust a CA certificate,
<literal>cacert.pem</literal>, located within the X-Pack configuration directory:
</simpara>
<programlisting language="shell" linenumbering="unnumbered">xpack:
  security:
    authc:
      realms:
        active_directory:
          type: active_directory
          order: 0
          domain_name: ad.example.com
          url: ldaps://ad.example.com:636
          ssl:
            certificate_authorities: [ "CONFIG_DIR/x-pack/cacert.pem" ]</programlisting>
<simpara>The CA cert must be a PEM encoded certificate.</simpara>
</listitem>
<listitem>
<simpara>
Set the <literal>url</literal> attribute in the realm configuration to specify the LDAPS protocol
and the secure port number. For example, <literal>url: ldaps://ad.example.com:636</literal>.
</simpara>
</listitem>
<listitem>
<simpara>
Restart Elasticsearch.
</simpara>
</listitem>
</orderedlist>
<note><simpara>By default, when you configure X-Pack security to connect to Active Directory
      using SSL/TLS, X-Pack security attempts to verify the hostname or IP address
      specified with the <literal>url</literal> attribute in the realm configuration with the
      values in the certificate. If the values in the certificate and realm
      configuration do not match, X-Pack security does not allow a connection to the
      Active Directory server. This is done to protect against man-in-the-middle
      attacks. If necessary, you can disable this behavior by setting the
      <link linkend="ssl-tls-settings"><literal>ssl.verification_mode</literal></link> property to <literal>none</literal>.</simpara></note>
</section>
</section>
<section id="pki-realm">
<title>PKI User Authentication<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/pki-realm.asciidoc">Edit me</ulink></title>
<simpara>You can configure X-Pack security to use Public Key Infrastructure (PKI) certificates
to authenticate users. This requires clients to present X.509 certificates. To
use PKI, you configure a PKI realm, enable client authentication on the desired
network layers (transport or http), and map the Distinguished Names (DNs) from
the user certificates to X-Pack security roles in the <link linkend="mapping-roles">role mapping file</link>.</simpara>
<simpara>You can also use a combination of PKI and username/password authentication. For
example, you can enable SSL/TLS on the transport layer and define a PKI realm to
require transport clients to authenticate with X.509 certificates, while still
authenticating HTTP traffic using username and password credentials. You can also set
<literal>xpack.security.transport.ssl.client_authentication</literal> to <literal>optional</literal> to allow clients without
certificates to authenticate with other credentials.</simpara>
<important><simpara>You must enable SSL/TLS and enabled client authentication to use PKI.
            For more information, see <link linkend="ssl-tls">Setting Up SSL/TLS on a Cluster</link>.</simpara></important>
<section id="_pki_realm_configuration">
<title>PKI Realm Configuration<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/pki-realm.asciidoc">Edit me</ulink></title>
<simpara>Like other realms, you configure options for a <literal>pki</literal> realm under the
<literal>xpack.security.authc.realms</literal> namespace in <literal>elasticsearch.yml</literal>.</simpara>
<simpara>To configure <literal>pki</literal> realm:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Add a realm configuration of type <literal>pki</literal> to <literal>elasticsearch.yml</literal> under the
<literal>xpack.security.authc.realms</literal> namespace. At a minimum, you must set the realm <literal>type</literal> to
<literal>pki</literal>. If you are configuring multiple realms, you should also explicitly set
the <literal>order</literal> attribute. See <xref linkend="pki-settings"/> for all of the options you can set
for a <literal>pki</literal> realm.
</simpara>
<simpara>For example, the following snippet shows the most basic <literal>pki</literal> realm configuration:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack:
  security:
    authc:
      realms:
        pki1:
          type: pki</programlisting>
<simpara>With this configuration, any certificate trusted by the SSL/TLS layer is accepted
for authentication. The username is the common name (CN) extracted from the DN
of the certificate.</simpara>
<important><simpara>When you configure realms in <literal>elasticsearch.yml</literal>, only the
realms you specify are used for authentication. If you also want to use the
<literal>native</literal> or <literal>file</literal> realms, you must include them in the realm chain.</simpara></important>
<simpara>If you want to use something other than the CN of the DN as the username, you
can specify a regex to extract the desired username. For example, the regex in
the following configuration extracts the email address from the DN:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack:
  security:
    authc:
      realms:
        pki1:
          type: pki
          username_pattern: "EMAILADDRESS=(.*?)(?:,|$)"</programlisting>
<simpara>You can also specify which truststore to use for authentication. This is useful
when the SSL/TLS layer trusts clients with certificates that are signed by a
different CA than the one that signs your users' certificates. To specify the
location of the truststore, specify the <literal>truststore.path</literal> option:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack:
  security:
    authc:
      realms:
        pki1:
          type: pki
          truststore:
            path: "/path/to/pki_truststore.jks"
            password: "changeme"</programlisting>
</listitem>
<listitem>
<simpara>
Restart Elasticsearch.
</simpara>
</listitem>
</orderedlist>
<section id="pki-settings">
<title>PKI Realm Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/pki-realm.asciidoc">Edit me</ulink></title>
<informaltable
frame="all"
rowsep="1" colsep="1"
>
<tgroup cols="3">
<colspec colname="col_1" colwidth="23*"/>
<colspec colname="col_2" colwidth="17*"/>
<colspec colname="col_3" colwidth="58*"/>
<tbody>
<row>
<entry align="left" valign="top"><simpara>Setting</simpara></entry>
<entry align="center" valign="top"><simpara>Required</simpara></entry>
<entry align="left" valign="top"><simpara>Description</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>type</literal></simpara></entry>
<entry align="center" valign="top"><simpara>yes</simpara></entry>
<entry align="left" valign="top"><simpara>Indicates the realm type. Must be set to <literal>pki</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>order</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Indicates the priority of this realm within the realm
                                        chain. Realms with a lower order are consulted first.
                                        Although not required, we recommend explicitly
                                        setting this value when you configure multiple realms.
                                        Defaults to <literal>Integer.MAX_VALUE</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>enabled</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Indicates whether this realm is enabled or disabled.
                                        Enables you to disable a realm without removing its
                                        configuration. Defaults to <literal>true</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>username_pattern</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the regular expression pattern used to extract
                                        the username from the certificate DN. The first match
                                        group is used as the username. Defaults to <literal>CN=(.*?)(?:,|$)</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>truststore.path</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>The path to the truststore. Defaults to the path
                                        defined by <link linkend="ssl-tls-settings">SSL/TLS settings</link>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>truststore.password</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no/yes</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the password for the truststore. Must be
                                        provided if <literal>truststore.path</literal> is set.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>truststore.algorithm</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the algorithm used for the truststore.
                                        Defaults to <literal>SunX509</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>files.role_mapping</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the <link linkend="security-files-location">location</link>
                                        for the <link linkend="pki-role-mapping">YAML role mapping configuration file</link>.
                                        Defaults to <literal>CONFIG_DIR/x-pack/role_mapping.yml</literal>.</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
</section>
</section>
<section id="assigning-roles-pki">
<title>Mapping Roles for PKI Users<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/pki-realm.asciidoc">Edit me</ulink></title>
<simpara>You map roles for PKI users in the role mapping file stored on each node. You
identify a user by the distinguished name in their certificate. For example, the
following mapping configuration maps <literal>John Doe</literal> to the <literal>user</literal> role:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">user: <co id="CO9-1"/>
  - "cn=John Doe,ou=example,o=com" <co id="CO9-2"/></programlisting>
<calloutlist>
<callout arearefs="CO9-1">
<para>
The name of a role.
</para>
</callout>
<callout arearefs="CO9-2">
<para>
The distinguished name (DN) of a PKI user.
</para>
</callout>
</calloutlist>
<simpara>For more information, see <link linkend="mapping-roles">Mapping Users and Groups to Roles</link>.</simpara>
</section>
</section>
<section id="file-realm">
<title>File-based User Authentication<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/file-realm.asciidoc">Edit me</ulink></title>
<simpara>You can manage and authenticate users with the built-in <literal>file</literal> internal realm.
With the <literal>file</literal> realm users are defined in local files on each node in the cluster.</simpara>
<important><simpara>As the administrator of the cluster, it is your responsibility to
            ensure the same users are defined on every node in the cluster.
            X-Pack security does not deliver any mechanism to guarantee this.</simpara></important>
<simpara>The <literal>file</literal> realm is primarily supported to serve as a fallback/recovery realm. It
is mostly useful in situations where all users locked themselves out of the system
(no one remembers their username/password). In this type of scenarios, the <literal>file</literal>
realm is your only way out - you can define a new <literal>admin</literal> user in the <literal>file</literal> realm
and use it to log in and reset the credentials of all other users.</simpara>
<important><simpara>When you configure realms in <literal>elasticsearch.yml</literal>, only the
realms you specify are used for authentication. To use the
<literal>file</literal> realm as a fallback, you must include it in the realm chain.</simpara></important>
<simpara>To define users, X-Pack security provides the <link linkend="managing-file-users">users</link> command-line
tool. This tool enables you to add and remove users, assign user roles and manage
user passwords.</simpara>
<section id="_configuring_a_file_realm">
<title>Configuring a File Realm<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/file-realm.asciidoc">Edit me</ulink></title>
<simpara>The <literal>file</literal> realm is added to the realm chain by default. You don&#8217;t need to
explicitly configure a <literal>file</literal> realm to manage users with the <literal>users</literal> tool.</simpara>
<simpara>Like other realms, you can configure options for a <literal>file</literal> realm in the
<literal>xpack.security.authc.realms</literal> namespace in <literal>elasticsearch.yml</literal>.</simpara>
<simpara>To configure an <literal>file</literal> realm:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Add a realm configuration of type <literal>file</literal> to <literal>elasticsearch.yml</literal> under the
<literal>xpack.security.authc.realms</literal> namespace. At a minimum, you must set the realm <literal>type</literal> to
<literal>file</literal>. If you are configuring multiple realms, you should also explicitly set
the <literal>order</literal> attribute. See <xref linkend="file-realm-settings"/> for all of the options you can set
for a <literal>file</literal> realm.
</simpara>
<simpara>For example, the following snippet shows a <literal>file</literal> realm configuration that sets
the <literal>order</literal> to zero so the realm is checked first:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack:
  security:
    authc:
      realms:
        file1:
          type: file
          order: 0</programlisting>
</listitem>
<listitem>
<simpara>
Restart Elasticsearch.
</simpara>
</listitem>
</orderedlist>
<section id="file-realm-settings">
<title>File Realm Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/file-realm.asciidoc">Edit me</ulink></title>
<informaltable
frame="all"
rowsep="1" colsep="1"
>
<tgroup cols="3">
<colspec colname="col_1" colwidth="23*"/>
<colspec colname="col_2" colwidth="17*"/>
<colspec colname="col_3" colwidth="58*"/>
<tbody>
<row>
<entry align="left" valign="top"><simpara>Setting</simpara></entry>
<entry align="center" valign="top"><simpara>Required</simpara></entry>
<entry align="left" valign="top"><simpara>Description</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>type</literal></simpara></entry>
<entry align="center" valign="top"><simpara>yes</simpara></entry>
<entry align="left" valign="top"><simpara>Indicates the realm type. Must be set to <literal>file</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>order</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Indicates the priority of this realm within the
                                        realm chain. Realms with a lower order are
                                        consulted first. Although not required, we
                                        recommend explicitly setting this value when you
                                        configure multiple realms. Defaults to
                                        <literal>Integer.MAX_VALUE</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>enabled</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Indicates whether this realm is enabled or
                                        disabled. Enables you to disable a realm without
                                        removing its configuration. Defaults to <literal>true</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>cache.ttl</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the time-to-live for cached user entries.
                                        A user&#8217;s credentials are cached for this period of
                                        time. Specify the time period using the standard
                                        Elasticsearch <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/common-options.html#time-units">time units</ulink>.
                                        Defaults to <literal>20m</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>cache.max_users</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the maximum number of user entries that
                                        can be stored in the cache at one time. Defaults
                                        to 100,000.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>cache.hash_algo</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Specifies the hashing algorithm that is used for
                                        the cached user credentials. See <link linkend="cache-hash-algo">Cache hash algorithms</link> for the possible values.
                                        (Expert Setting).</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
</section>
</section>
<section id="managing-file-users">
<title>Managing Users<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/file-realm.asciidoc">Edit me</ulink></title>
<simpara>The <literal>users</literal> command-line tool is located in <literal>ES_HOME/bin/x-pack</literal> and enables
several administrative tasks for managing users:</simpara>
<itemizedlist>
<listitem>
<simpara>
<link linkend="file-realm-add-user">Adding users</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="file-realm-list-users">Listing users and roles</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="file-realm-manage-passwd">Managing user passwords</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="file-realm-manage-roles">Managing users' roles</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="file-realm-remove-user">Removing users</link>
</simpara>
</listitem>
</itemizedlist>
<section id="file-realm-add-user">
<title>Adding Users<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/file-realm.asciidoc">Edit me</ulink></title>
<simpara>Use the <literal>useradd</literal> sub-command to add a user to your local node.</simpara>
<note><simpara>To ensure that Elasticsearch can read the user and role information at
      startup, run <literal>users useradd</literal> as the same user you use to run Elasticsearch.
      Running the command as root or some other user will update the permissions
      for the <literal>users</literal> and <literal>users_roles</literal> files and prevent Elasticsearch from
      accessing them.</simpara></note>
<programlisting language="shell" linenumbering="unnumbered">bin/x-pack/users useradd &lt;username&gt;</programlisting>
<simpara>A username must be at least 1 character and no longer than 30 characters. The
first character must be a letter (<literal>a-z</literal> or <literal>A-Z</literal>) or an underscore (<literal>_</literal>).
Subsequent characters can be letters, underscores (<literal>_</literal>), digits (<literal>0-9</literal>), or any
of the following symbols <literal>@</literal>, <literal>-</literal>, <literal>.</literal> or <literal>$</literal>.</simpara>
<simpara>You can specify the user&#8217;s password at the command-line with the <literal>-p</literal> option.
When this option is absent, the command prompts you for the password. Omit the
<literal>-p</literal> option to keep plaintext passwords out of the terminal session&#8217;s command
history.</simpara>
<programlisting language="shell" linenumbering="unnumbered">bin/x-pack/users useradd &lt;username&gt; -p &lt;secret&gt;</programlisting>
<simpara>Passwords must be at least 6 characters long.</simpara>
<simpara>You can define a user&#8217;s roles with the <literal>-r</literal> option. This option accepts a
comma-separated list of role names to assign to the user.</simpara>
<programlisting language="shell" linenumbering="unnumbered">bin/x-pack/users useradd &lt;username&gt; -r &lt;comma-separated list of role names&gt;</programlisting>
<simpara>The following example adds a new user named <literal>jacknich</literal> to the <literal>file</literal> realm. The
password for this user is <literal>theshining</literal>, and this user is associated with the
<literal>network</literal> and <literal>monitoring</literal> roles.</simpara>
<programlisting language="shell" linenumbering="unnumbered">bin/x-pack/users useradd jacknich -p theshining -r network,monitoring</programlisting>
<simpara>For valid role names please see <link linkend="valid-role-name">Role Definitions</link>.</simpara>
</section>
<section id="file-realm-list-users">
<title>Listing Users<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/file-realm.asciidoc">Edit me</ulink></title>
<simpara>Use the <literal>list</literal> sub-command to list the users registered with the <literal>file</literal> realm
on the local node.</simpara>
<programlisting language="shell" linenumbering="unnumbered">bin/x-pack/users list
rdeniro        : admin
alpacino       : power_user
jacknich       : monitoring,network</programlisting>
<simpara>Users are in the left-hand column and their corresponding roles are listed in
the right-hand column.</simpara>
<simpara>The <literal>list &lt;username&gt;</literal> sub-command lists a specific user. Use this command to
verify that a user was successfully added to the local <literal>file</literal> realm.</simpara>
<programlisting language="shell" linenumbering="unnumbered">bin/x-pack/users list jacknich
jacknich       : monitoring,network</programlisting>
</section>
<section id="file-realm-manage-passwd">
<title>Managing User Passwords<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/file-realm.asciidoc">Edit me</ulink></title>
<simpara>Use the <literal>passwd</literal> sub-command to reset a user&#8217;s password. You can specify the new
password directly with the <literal>-p</literal> option. When <literal>-p</literal> option is omitted, the tool
will prompt you to enter and confirm a password in interactive mode.</simpara>
<programlisting language="shell" linenumbering="unnumbered">bin/x-pack/users passwd &lt;username&gt;</programlisting>
<programlisting language="shell" linenumbering="unnumbered">bin/x-pack/users passwd &lt;username&gt; -p &lt;password&gt;</programlisting>
</section>
<section id="file-realm-manage-roles">
<title>Assigning Users to Roles<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/file-realm.asciidoc">Edit me</ulink></title>
<simpara>Use the <literal>roles</literal> sub-command to manage the roles of a particular user. The <literal>-a</literal>
option adds a comma-separated list of roles to a user. The <literal>-r</literal> option removes
a comma-separated list of roles from a user. You can combine adding and removing
roles within the same command to change a user&#8217;s roles.</simpara>
<programlisting language="shell" linenumbering="unnumbered">bin/x-pack/users roles &lt;username&gt; -a &lt;commma-separate list of roles&gt; -r &lt;comma-separated list of roles&gt;</programlisting>
<simpara>The following command removes the <literal>network</literal> and <literal>monitoring</literal> roles from user
<literal>jacknich</literal> and adds the <literal>user</literal> role:</simpara>
<programlisting language="shell" linenumbering="unnumbered">bin/x-pack/users roles jacknich -r network,monitoring -a user</programlisting>
<simpara>Listing the user displays the new role assignment:</simpara>
<programlisting language="shell" linenumbering="unnumbered">bin/x-pack/users list jacknich
jacknich       : user</programlisting>
</section>
<section id="file-realm-remove-user">
<title>Deleting Users<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/file-realm.asciidoc">Edit me</ulink></title>
<simpara>Use the <literal>userdel</literal> sub-command to delete a user.</simpara>
<programlisting language="shell" linenumbering="unnumbered">bin/x-pack/userdel &lt;username&gt;</programlisting>
</section>
</section>
<section id="_a_look_under_the_hood">
<title>A Look Under the Hood<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/file-realm.asciidoc">Edit me</ulink></title>
<simpara>All the data about the users for the <literal>file</literal> realm is stored in two files, <literal>users</literal>
and <literal>users_roles</literal>. Both files are located in <literal>CONFIG_DIR/x-pack/</literal> and are read
on startup.</simpara>
<simpara>By default, X-Pack security checks these files for changes every 5 seconds. You can
change this default behavior by changing the <literal>resource.reload.interval.high</literal> setting in
the <literal>elasticsearch.yml</literal> file (as this is a common setting in Elasticsearch,
changing its value may effect other schedules in the system).</simpara>
<important>
<simpara>These files are managed locally by the node and are <emphasis role="strong">not</emphasis> managed
globally by the cluster. This means that with a typical multi-node cluster,
the exact same changes need to be applied on each and every node in the
cluster.</simpara>
<simpara>A safer approach would be to apply the change on one of the nodes and have the
<literal>users</literal> and <literal>users_roles</literal> files distributed/copied to all other nodes in the
cluster (either manually or using a configuration management system such as
Puppet or Chef).</simpara>
</important>
<simpara>While it is possible to modify these files directly using any standard text
editor, we strongly recommend using the <literal>bin/x-pack/users</literal> command-line tool
to apply the required changes.</simpara>
<bridgehead id="users-file" renderas="sect4">The <literal>users</literal> File<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/file-realm.asciidoc">Edit me</ulink></bridgehead>
<simpara>The <literal>users</literal> file stores all the users and their passwords. Each line in the
<literal>users</literal> file represents a single user entry consisting of the username and
<emphasis role="strong">hashed</emphasis> password.</simpara>
<programlisting language="bash" linenumbering="unnumbered">rdeniro:$2a$10$BBJ/ILiyJ1eBTYoRKxkqbuDEdYECplvxnqQ47uiowE7yGqvCEgj9W
alpacino:$2a$10$cNwHnElYiMYZ/T3K4PvzGeJ1KbpXZp2PfoQD.gfaVdImnHOwIuBKS
jacknich:$2a$10$GYUNWyABV/Ols/.bcwxuBuuaQzV6WIauW6RdboojxcixBq3LtI3ni</programlisting>
<note><simpara>X-Pack security uses <literal>bcrypt</literal> to hash the user passwords.</simpara></note>
<bridgehead id="users_defining-roles" renderas="sect3">The <literal>users_roles</literal> File<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/file-realm.asciidoc">Edit me</ulink></bridgehead>
<simpara>The <literal>users_roles</literal> file stores the roles associated with the users, as in the
following example:</simpara>
<programlisting language="shell" linenumbering="unnumbered">admin:rdeniro
power_user:alpacino,jacknich
user:jacknich</programlisting>
<simpara>Each row maps a role to a comma-separated list of all the users that are
associated with that role.</simpara>
</section>
</section>
<section id="custom-realms">
<title>Integrating with Other Authentication Systems<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/custom-realm.asciidoc">Edit me</ulink></title>
<simpara>If you are using an authentication system that is not supported out-of-the-box
by X-Pack security, you can create a custom realm to interact with it to authenticate
users. You implement a custom realm as an X-Pack extension.</simpara>
<section id="implementing-custom-realm">
<title>Implementing a Custom Realm<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/custom-realm.asciidoc">Edit me</ulink></title>
<simpara>Sample code that illustrates the structure and implementation of a custom realm
is provided in the <ulink url="https://github.com/elastic/shield-custom-realm-example">custom-realm-example</ulink>
repository on GitHub. You can use this code as a starting point for creating your
own realm.</simpara>
<simpara>To create a custom realm, you need to:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Extend <literal>org.elasticsearch.xpack.security.authc.Realm</literal> to communicate with your
  authentication system to authenticate users.
</simpara>
</listitem>
<listitem>
<simpara>
Implement the <literal>org.elasticsearch.xpack.security.authc.Realm.Factory</literal> interface in
  a class that will be used to create the custom realm.
</simpara>
</listitem>
<listitem>
<simpara>
Extend <literal>org.elasticsearch.xpack.security.authc.DefaultAuthenticationFailureHandler</literal> to
  handle authentication failures when using your custom realm.
</simpara>
</listitem>
</orderedlist>
<simpara>To package your custom realm as a plugin:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Implement an extension class for your realm that extends
  <literal>org.elasticsearch.xpack.extensions.XPackExtension</literal>. There you need to
  override one or more of the following methods:
</simpara>
<programlisting language="java" linenumbering="unnumbered">@Override
public Map&lt;String, Factory&gt; getRealms() {
    ...
}</programlisting>
<simpara>The <literal>getRealms</literal> method is used to provide a map of type names to the <literal>Factory</literal> that
will be used to create the realm.</simpara>
<programlisting language="java" linenumbering="unnumbered">@Override
public AuthenticationFailureHandler getAuthenticationFailureHandler() {
    ...
}</programlisting>
<simpara>The <literal>getAuthenticationFailureHandler</literal> method is used to optionally provide a
custom <literal>AuthenticationFailureHandler</literal>, which will control how X-Pack responds
in certain authentication failure events.</simpara>
<programlisting language="java" linenumbering="unnumbered">@Override
public Collection&lt;String&gt; getRestHeaders() {
    ...
}</programlisting>
<simpara>The <literal>getRestHeaders</literal> method returns a collection of header names that should be
copied from the request into the <literal>ThreadContext</literal> where they can be accessed by
the realm.</simpara>
<programlisting language="java" linenumbering="unnumbered">@Override
public List&lt;String&gt; getSettingsFilter() {
    ...
}</programlisting>
<simpara>The <literal>getSettingsFilter</literal> method returns a list of setting names that should be
filtered from the settings APIs as they may contain sensitive credentials.</simpara>
</listitem>
<listitem>
<simpara>
Create a build configuration file for the plugin; Gradle is our recommendation.
</simpara>
</listitem>
<listitem>
<simpara>
Create a <literal>x-pack-extension-descriptor.properties</literal> descriptor file for the
  extension.
</simpara>
</listitem>
<listitem>
<simpara>
Bundle all in a single zip file.
</simpara>
</listitem>
</orderedlist>
</section>
<section id="using-custom-realm">
<title>Using a Custom Realm to Authenticate Users<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/custom-realm.asciidoc">Edit me</ulink></title>
<simpara>To use a custom realm:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Install the realm extension on each node in the cluster. You run
  <literal>bin/x-pack/extension</literal> with the <literal>install</literal> sub-command and specify the URL
  pointing to the zip file that contains the extension. For example:
</simpara>
<programlisting language="shell" linenumbering="unnumbered">bin/x-pack/extension install file:///&lt;path&gt;/my-realm-1.0.zip</programlisting>
</listitem>
<listitem>
<simpara>
Add a realm configuration of the appropriate realm type to <literal>elasticsearch.yml</literal>
under the <literal>xpack.security.authc.realms</literal> namespace. The options you can set depend
on the settings exposed by the custom realm. At a minimum, you must set the realm
<literal>type</literal> to the type defined by the extension. If you are configuring multiple
realms, you should also explicitly set the  <literal>order</literal> attribute to control the
order in which the realms are consulted during authentication.
</simpara>
<important><simpara>When you configure realms in <literal>elasticsearch.yml</literal>, only the
realms you specify are used for authentication. If you also want to use the
<literal>native</literal> or <literal>file</literal> realms, you must include them in the realm chain.</simpara></important>
</listitem>
<listitem>
<simpara>
Restart Elasticsearch.
</simpara>
</listitem>
</orderedlist>
</section>
</section>
<section id="controlling-user-cache">
<title>Controlling the User Cache<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/user-cache.asciidoc">Edit me</ulink></title>
<simpara>User credentials are cached in memory on each node to avoid connecting to a
remote authentication service or hitting the disk for every incoming request.
You can configure characteristics of the user cache with the <literal>cache.ttl</literal>,
<literal>cache.max_users</literal>, and <literal>cache.hash_algo</literal> realm settings.</simpara>
<note><simpara>PKI realms do not use the user cache.</simpara></note>
<simpara>The cached user credentials are hashed in memory. By default, X-Pack security uses a
salted <literal>sha-256</literal> hash algorithm. You can use a different hashing algorithm by
setting the <literal>cache_hash_algo</literal> setting to any of the following:</simpara>
<table id="cache-hash-algo"
frame="all"
rowsep="1" colsep="1"
>
<title>Cache hash algorithms</title>
<tgroup cols="4">
<colspec colname="col_1" colwidth="25*"/>
<colspec colname="col_2" colwidth="25*"/>
<colspec colname="col_3" colwidth="25*"/>
<colspec colname="col_4" colwidth="25*"/>
<tbody>
<row>
<entry align="left" valign="top"><simpara>Algorithm</simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Description</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ssha256</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Uses a salted <literal>sha-256</literal> algorithm (default).</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>md5</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Uses <literal>MD5</literal> algorithm.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>sha1</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Uses <literal>SHA1</literal> algorithm.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>bcrypt</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Uses <literal>bcrypt</literal> algorithm with salt generated in 10 rounds.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>bcrypt4</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Uses <literal>bcrypt</literal> algorithm with salt generated in 4 rounds.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>bcrypt5</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Uses <literal>bcrypt</literal> algorithm with salt generated in 5 rounds.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>bcrypt6</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Uses <literal>bcrypt</literal> algorithm with salt generated in 6 rounds.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>bcrypt7</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Uses <literal>bcrypt</literal> algorithm with salt generated in 7 rounds.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>bcrypt8</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Uses <literal>bcrypt</literal> algorithm with salt generated in 8 rounds.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>bcrypt9</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Uses <literal>bcrypt</literal> algorithm with salt generated in 9 rounds.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>noop</literal>,<literal>clear_text</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Doesn&#8217;t hash the credentials and keeps it in clear text in
                            memory. CAUTION: keeping clear text is considered insecure
                            and can be compromised at the OS level (for example through
                            memory dumps and using <literal>ptrace</literal>).</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<section id="cache-eviction-api">
<title>Evicting Users from the Cache<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authentication/user-cache.asciidoc">Edit me</ulink></title>
<simpara>X-Pack security exposes a <link linkend="security-api-clear-cache">Clear Cache API</link> you can use
to force the eviction of cached users. For example, the following request evicts
all users from the <literal>ad1</literal> realm:</simpara>
<programlisting language="js" linenumbering="unnumbered">$ curl -XPOST 'http://localhost:9200/_xpack/security/realm/ad1/_clear_cache'</programlisting>
<simpara>To clear the cache for multiple realms, specify the realms as a comma-separated
list:</simpara>
<programlisting language="js" linenumbering="unnumbered">$ curl -XPOST 'http://localhost:9200/_xpack/security/realm/ad1,ad2/_clear_cache'</programlisting>
<simpara>You can also evict specific users:</simpara>
<programlisting language="java" linenumbering="unnumbered">$ curl -XPOST 'http://localhost:9200/_xpack/security/realm/ad1/_clear_cache?usernames=rdeniro,alpacino'</programlisting>
</section>
</section>
</chapter>
<chapter id="authorization">
<title>Configuring Role-based Access Control<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authorization.asciidoc">Edit me</ulink></title>
<simpara>X-Pack security introduces the concept of <emphasis>authorization</emphasis> to Elasticsearch.
Authorization is the process of determining whether the user behind an incoming
request is allowed to execute it. This process takes place once a request is
successfully authenticated and the user behind the request is identified.</simpara>
<bridgehead id="roles" renderas="sect2">Roles, Permissions and Privileges<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authorization.asciidoc">Edit me</ulink></bridgehead>
<simpara>The authorization process revolves around the following 5 constructs:</simpara>
<variablelist>
<varlistentry>
<term>
<emphasis>Secured Resource</emphasis>
</term>
<listitem>
<simpara>
A resource to which access is restricted. Indices/aliases, documents, fields,
users and the Elasticsearch cluster itself are all examples of secured objects.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<emphasis>Privilege</emphasis>
</term>
<listitem>
<simpara>
A named group representing one or more actions that a user may execute against a
secured resource. Each secured resource has its own sets of available privileges.
For example, <literal>read</literal> is an index privilege that represents all actions that enable
reading the indexed/stored data. For a complete list of available privileges
see <xref linkend="security-privileges"/>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<emphasis>Permissions</emphasis>
</term>
<listitem>
<simpara>
A set of one or more privileges against a secured resource. Permissions can
easily be described in words, here are few examples:
</simpara>
<itemizedlist>
<listitem>
<simpara>
<literal>read</literal> privilege on the <literal>products</literal> index
</simpara>
</listitem>
<listitem>
<simpara>
<literal>manage</literal> privilege on the cluster
</simpara>
</listitem>
<listitem>
<simpara>
<literal>run_as</literal> privilege on <literal>john</literal> user
</simpara>
</listitem>
<listitem>
<simpara>
<literal>read</literal> privilege on documents that match query X
</simpara>
</listitem>
<listitem>
<simpara>
<literal>read</literal> privilege on <literal>credit_card</literal> field
</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>
<emphasis>Role</emphasis>
</term>
<listitem>
<simpara>
A named sets of permissions
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<emphasis>User</emphasis>
</term>
<listitem>
<simpara>
The authenticated user.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<simpara>A secure Elasticsearch cluster manages the privileges of users through <emphasis>roles</emphasis>.
A role has a unique name and identifies a set of permissions that translate to
privileges on resources. A user can be associated with an arbitrary number of
roles. The total set of permissions that a user has is therefore defined by
union of the permissions in all its roles.</simpara>
<simpara>As an administrator, you will need to define the roles that you want to use,
then assign users to the roles. These can be assigned to users in a number of
ways depending on the realms by which the users are authenticated.</simpara>
<section id="built-in-roles">
<title>Built-in Roles<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authorization.asciidoc">Edit me</ulink></title>
<simpara>X-Pack security applies a default role to all users, including <link linkend="anonymous-access">anonymous users</link>. The default role enables users to access the authenticate
endpoint, change their own passwords, and get information about themselves.</simpara>
<simpara>X-Pack security also provides a set of built-in roles you can explicitly assign
to users. These roles have a fixed set of privileges and cannot be updated.</simpara>
<variablelist id="built-in-roles-superuser">
<varlistentry>
<term>
<literal>superuser</literal>
</term>
<listitem>
<simpara>
Grants full access to the cluster, including all indices and data. A user with
the <literal>superuser</literal> role can also manage users and roles and <link linkend="run-as-privilege">impersonate</link> any other user in the system. Due to the permissive nature of
this role, take extra care when assigning it to a user.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>transport_client</literal>
</term>
<listitem>
<simpara>
Grants the privileges required to access the cluster through the Java Transport Client. The Java Transport Client fetches information about the nodes in the
cluster using the <emphasis>Node Liveness API</emphasis> and the <emphasis>Cluster State API</emphasis> (when
sniffing is enabled). Assign your users this role if they use the
Transport Client.
</simpara>
<note id="built-in-roles-transport-client"><simpara>Using the Transport Client effectively means the users are granted access
to the cluster state. This means users can view the metadata over all indices,
index templates, mappings, node and basically everything about the cluster.
However, this role does not grant permission to view the data in all indices.</simpara></note>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>kibana_user</literal> 
</term>
<listitem>
<simpara>
Grants the minimum privileges required for any user of Kibana. This role grants
access to the Kibana indices and grants  monitoring privileges for the cluster.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>monitoring_user</literal> 
</term>
<listitem>
<simpara>
Grants the minimum privileges required for any user of Monitoring other than those
required to use Kibana. This role grants access to the monitoring indices. Monitoring
users should also be assigned the <literal>kibana_user</literal> role.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>reporting_user</literal> 
</term>
<listitem>
<simpara>
Grants the specific privileges required for users of Reporting other than those
required to use Kibana. This role grants access to the reporting indices. Reporting
users should also be assigned the <literal>kibana_user</literal> role and a role that grants them
access to the data that will be used to generate reports with.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>remote_monitoring_agent</literal> 
</term>
<listitem>
<simpara>
Grants the minimum privileges required for a remote monitoring agent to write data
into this cluster.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>ingest_admin</literal> 
</term>
<listitem>
<simpara>
Grants access to manage <emphasis role="strong">all</emphasis> index templates and <emphasis role="strong">all</emphasis> ingest pipeline configurations.
These privileges are necessary to to use the ingest feature in Kibana.
</simpara>
<note id="built-in-roles-ingest-user"><simpara>This role does <emphasis role="strong">not</emphasis> provide the ability to create indices; those privileges
must be defined in a separate role.</simpara></note>
</listitem>
</varlistentry>
</variablelist>
</section>
<section id="defining-roles">
<title>Defining Roles<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authorization.asciidoc">Edit me</ulink></title>
<simpara>A role is defined by the following JSON structure:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "name": "...", <co id="CO10-1"/>
  "run_as": [ ... ] <co id="CO10-2"/>
  "cluster": [ ... ], <co id="CO10-3"/>
  "indices": [ ... ] <co id="CO10-4"/>
}</programlisting>
<calloutlist>
<callout arearefs="CO10-1">
<para>
The role name, also used as the role ID.
</para>
</callout>
<callout arearefs="CO10-2">
<para>
A list of usernames the owners of this role can <link linkend="run-as-privilege">impersonate</link>.
</para>
</callout>
<callout arearefs="CO10-3">
<para>
A list of cluster privileges. These privileges define the
    cluster level actions users with this role are able to execute. This field
    is optional (missing <literal>cluster</literal> privileges effectively mean no cluster level
    permissions).
</para>
</callout>
<callout arearefs="CO10-4">
<para>
A list of indices permissions entries. This field is optional (missing <literal>cluster</literal>
    privileges effectively mean no cluster level permissions).
</para>
</callout>
</calloutlist>
<note id="valid-role-name"><simpara>A valid role name must be at least 1 character and no longer than 30
      characters. It must begin with a letter (<literal>a-z</literal>) or an underscore (<literal>_</literal>).
      Subsequent characters can be letters, underscores (<literal>_</literal>), digits (<literal>0-9</literal>) or
      any of the following symbols <literal>@</literal>, <literal>-</literal>, <literal>.</literal> or <literal>$</literal></simpara></note>
<simpara>The following describes the structure of an indices permissions entry:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "names": [ ... ], <co id="CO11-1"/>
  "privileges": [ ... ], <co id="CO11-2"/>
  "field_security" : { ... }, <co id="CO11-3"/>
  "query": "..." <co id="CO11-4"/>
}</programlisting>
<calloutlist>
<callout arearefs="CO11-1">
<para>
A list of indices (or index name patterns) to which the permissions in this
    entry apply.
</para>
</callout>
<callout arearefs="CO11-2">
<para>
The index level privileges the owners of the role have on the associated
    indices (those indices that are specified in the <literal>name</literal> field)
</para>
</callout>
<callout arearefs="CO11-3">
<para>
Specification for document fields the owners of the role have read access to.
    See <xref linkend="field-and-document-access-control"/> for details.
</para>
</callout>
<callout arearefs="CO11-4">
<para>
A search query that defines the documents the owners of the role have read
    access to. A document within the associated indices must match this query
    in order for it to be accessible by the owners of the role.
</para>
</callout>
</calloutlist>
<tip>
<simpara>When specifying index names, you can use indices and aliases with their full
names or regular expressions that refer to multiple indices.</simpara>
<itemizedlist>
<listitem>
<simpara>
Wildcard (default) - simple wildcard matching where <literal>*</literal> is a placeholder
  for zero or more characters, <literal>?</literal> is a placeholder for a single character
  and <literal>\</literal> may be used as an escape character.
</simpara>
</listitem>
<listitem>
<simpara>
Regular Expressions - A more powerful syntax for matching more complex
  patterns. This regular expression is based on Lucene&#8217;s regexp automaton
  syntax. To enable this syntax, it must be wrapped within a pair of
  forward slashes (<literal>/</literal>). Any pattern starting with <literal>/</literal> and not ending with
  <literal>/</literal> is considered to be malformed.
</simpara>
</listitem>
</itemizedlist>
<formalpara><title>Example Regular Expressions</title><para>
<programlisting language="yaml" linenumbering="unnumbered">"foo-bar":               # match the literal `foo-bar`
"foo-*":                 # match anything beginning with "foo-"
"logstash-201?-*":       # ? matches any one character
"/.*-201[0-9]-.*/":      # use a regex to match anything containing 2010-2019
"/foo":                  # syntax error - missing final /</programlisting>
</para></formalpara>
</tip>
<simpara>The following snippet shows an example definition of a <literal>clicks_admin</literal> role:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "run_as": [ "clicks_watcher_1" ]
  "cluster": [ "monitor" ],
  "indices": [
    {
      "names": [ "events-*" ],
      "privileges": [ "read" ],
      "field_security" : {
        "grant" : [ "category", "@timestamp", "message" ]
      },
      "query": "{\"match\": {\"category\": \"click\"}}"
    }
  ]
}</programlisting>
<simpara>Based on the above definition, users owning the <literal>clicks_admin</literal> role can:</simpara>
<itemizedlist>
<listitem>
<simpara>
Impersonate the <literal>clicks_watcher_1</literal> user and execute requests on its behalf.
</simpara>
</listitem>
<listitem>
<simpara>
Monitor the Elasticsearch cluster
</simpara>
</listitem>
<listitem>
<simpara>
Read data from all indices prefixed with <literal>events-</literal>
</simpara>
</listitem>
<listitem>
<simpara>
Within these indices, only read the events of the <literal>click</literal> category
</simpara>
</listitem>
<listitem>
<simpara>
Within these document, only read the <literal>category</literal>, <literal>@timestamp</literal> and <literal>message</literal>
    fields.
</simpara>
</listitem>
</itemizedlist>
<tip><simpara>For a complete list of available <link linkend="security-privileges">cluster and indices privileges</link></simpara></tip>
<simpara>There are two available mechanisms to define roles: using the <emphasis>Role Management APIs</emphasis>
or in local files on the Elasticsearch nodes.</simpara>
<bridgehead id="roles-management-ui" renderas="sect2">Role Management UI<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authorization.asciidoc">Edit me</ulink></bridgehead>
<simpara>If you are a Kibana user, make sure to <link linkend="installing-xpack">install X-Pack in Kibana</link>.
This enables you to easily manage users and roles from within Kibana. To manage roles,
log in to Kibana and go to <emphasis role="strong">Management / Elasticsearch / Roles</emphasis>.</simpara>
<bridgehead id="roles-management-api" renderas="sect2">Role Management API<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authorization.asciidoc">Edit me</ulink></bridgehead>
<simpara>The <emphasis>Role Management APIs</emphasis> enable you to add, update, remove and retrieve roles
dynamically. When you use the APIs to manage roles in the <literal>native</literal> realm, the
roles are stored in an internal Elasticsearch index.</simpara>
<section id="roles-api-add">
<title>Adding a Role<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authorization.asciidoc">Edit me</ulink></title>
<simpara>To add a role, submit a PUT or POST request to the <literal>/_xpack/security/role/&lt;name&gt;</literal>
endpoint.</simpara>
<programlisting language="js" linenumbering="unnumbered">POST /_xpack/security/role/clicks_admin
{
  "run_as": [ "clicks_watcher_1" ],
  "cluster": [ "monitor" ],
  "indices": [
    {
      "names": [ "events-*" ],
      "privileges": [ "read" ],
      "field_security" : {
        "grant" : [ "category", "@timestamp", "message" ]
      },
      "query": "{\"match\": {\"category\": \"click\"}}"
    }
  ]
}</programlisting>
<remark> CONSOLE</remark>
<remark> TESTSETUP</remark>
<note><simpara>This API can also be used for updating role definitions.</simpara></note>
</section>
<section id="roles-api-list">
<title>List Role<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authorization.asciidoc">Edit me</ulink></title>
<simpara>To retrieve all roles, submit a GET request to the <literal>/_xpack/security/role</literal> endpoint:</simpara>
<programlisting language="js" linenumbering="unnumbered">GET /_xpack/security/role</programlisting>
<remark> CONSOLE</remark>
<simpara>To retrieve particular roles, specify the roles as a comma-separated list:</simpara>
<programlisting language="js" linenumbering="unnumbered">GET /_xpack/security/role/clicks_admin</programlisting>
<remark> CONSOLE</remark>
<simpara>Response:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "clicks_admin": {
    "run_as": [ "clicks_watcher_1" ],
    "cluster": [ "monitor" ],
    "indices": [
      {
        "names": [ "events-*" ],
        "privileges": [ "read" ],
        "field_security" : {
          "grant" : [ "category", "@timestamp", "message" ]
        },
        "query": "{\"match\": {\"category\": \"click\"}}"
      }
    ],
    "metadata": { }
  }
}</programlisting>
<remark> TESTRESPONSE</remark>
<note><simpara>If single role is requested, that role is returned as the response. When
      requesting multiple roles, an object is returned holding the found roles,
      each keyed by the relevant role name.</simpara></note>
</section>
<section id="roles-api-delete">
<title>Deleting a Role<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authorization.asciidoc">Edit me</ulink></title>
<simpara>To delete a role, submit a DELETE request to the <literal>/_xpack/security/role/&lt;name&gt;</literal>
endpoint:</simpara>
<programlisting language="js" linenumbering="unnumbered">DELETE /_xpack/security/role/clicks_admin</programlisting>
<remark> CONSOLE</remark>
<bridgehead id="roles-management-file" renderas="sect2">File-based Role Management<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authorization.asciidoc">Edit me</ulink></bridgehead>
<simpara>Apart from the <emphasis>Role Management APIs</emphasis> roles can also be defined in local
<literal>roles.yml</literal> file located in <literal>CONFIG_DIR/x-pack</literal>. This is a YAML file where each
role definition is keyed by its name.</simpara>
<important>
<simpara>If the same role name is used in the <literal>roles.yml</literal> file and through the
<emphasis>Role Management APIs</emphasis>, the role found in the file will be used.</simpara>
</important>
<simpara>While the <emphasis>Role Management APIs</emphasis> is the preferred mechanism to define roles,
using the <literal>roles.yml</literal> file becomes useful if you want to define fixed roles that
no one (beside an administrator having physical access to the Elasticsearch nodes)
would be able to change.</simpara>
<important>
<simpara>The <literal>roles.yml</literal> file is managed locally by the node and is not globally by the
cluster. This means that with a typical multi-node cluster, the exact same
changes need to be applied on each and every node in the cluster.</simpara>
<simpara>A safer approach would be to apply the change on one of the nodes and have the
<literal>roles.yml</literal> distributed/copied to all other nodes in the cluster (either
manually or using a configuration management system such as Puppet or Chef).</simpara>
</important>
<simpara>The following snippet shows an example of the <literal>roles.yml</literal> file configuration:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">click_admins:
  run_as: [ 'clicks_watcher_1' ]
  cluster: [ 'monitor' ]
  "indices":
    - names: [ 'events-*' ]
      privileges: [ 'read' ]
      field_security:
        grant: ['category', '@timestamp', 'message' ]
      query: '{\"match\": {\"category\": \"click\"}}'
    }
  ]</programlisting>
<simpara>X-Pack security continuously monitors the <literal>roles.yml</literal> file and automatically picks
up and apples any changes to it.</simpara>
</section>
</section>
<section id="securing-aliases">
<title>Granting Privileges for Indices &amp; Aliases<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authorization/alias-privileges.asciidoc">Edit me</ulink></title>
<simpara>Elasticsearch allows to execute operations against <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/indices-aliases.html">index aliases</ulink>,
which are effectively virtual indices. An alias points to one or more indices,
holds metadata and potentially a filter. X-Pack security treats aliases and indices
the same. Privileges for indices actions are granted on specific indices or
aliases. In order for an indices action to be authorized, the user that executes
it needs to have permissions for that action on all the specific indices or
aliases that the request relates to.</simpara>
<simpara>Let&#8217;s look at an example. Assuming we have an index called <literal>2015</literal>, an alias that
points to it called <literal>current_year</literal>, and a user with the following role:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "names" : [ "2015" ],
  "privileges" : [ "read" ]
}</programlisting>
<simpara>The user attempts to retrieve a document from <literal>current_year</literal>:</simpara>
<programlisting language="shell" linenumbering="unnumbered">curl -XGET 'localhost:9200/current_year/event/1'</programlisting>
<simpara>The above request gets rejected, although the user has <literal>read</literal> privilege on the
concrete index that the <literal>current_year</literal> alias points to. The correct permission
would be as follows:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "names" : [ "current_year" ],
  "privileges" : [ "read" ]
}</programlisting>
<bridgehead id="_managing_aliases" renderas="sect3">Managing aliases<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authorization/alias-privileges.asciidoc">Edit me</ulink></bridgehead>
<simpara>Unlike creating indices, which requires the <literal>create_index</literal> privilege, adding,
removing and retrieving aliases requires the <literal>manage</literal> permission. Aliases can be
added to an index directly as part of the index creation:</simpara>
<programlisting language="shell" linenumbering="unnumbered">curl -XPUT localhost:9200/2015 -d '{
    "aliases" : {
        "current_year" : {}
    }
}'</programlisting>
<simpara>or via the dedicated aliases api if the index already exists:</simpara>
<programlisting language="shell" linenumbering="unnumbered">curl -XPOST 'http://localhost:9200/_aliases' -d '{
    "actions" : [
        { "add" : { "index" : "2015", "alias" : "current_year" } }
    ]
}'</programlisting>
<simpara>The above requests both require the <literal>manage</literal> privilege on the alias name as well
as the targeted index, as follows:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "names" : [ "20*", "current_year" ],
  "privileges" : [ "manage" ]
}</programlisting>
<simpara>The index aliases api also allows also to delete aliases from existing indices.
The privileges required for such a request are the same as above. Both index and
alias need the <literal>manage</literal> permission.</simpara>
<bridgehead id="_filtered_aliases" renderas="sect3">Filtered aliases<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authorization/alias-privileges.asciidoc">Edit me</ulink></bridgehead>
<simpara>Aliases can hold a filter, which allows to select a subset of documents that can
be accessed out of all the documents that the physical index contains. These
filters are not always applied and should not be used in place of
<link linkend="document-level-security">document level security</link>.</simpara>
</section>
<section id="mapping-roles">
<title>Mapping Users and Groups to Roles<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authorization/mapping-roles.asciidoc">Edit me</ulink></title>
<simpara>If you authenticate users with the <literal>native</literal> or <literal>file</literal> realms, you can manage
role assignment user the <link linkend="managing-native-users">User Management APIs</link> or the
<link linkend="managing-file-users">file-realm</link> command-line tool respectively.</simpara>
<simpara>For other types of realms, you configure role mappings for users and groups in a
YAML file and copy it to each node in the cluster. Tools like Puppet or Chef can
help with this.</simpara>
<simpara>By default, role mappings are stored in <literal>CONF_DIR/x-pack/role_mapping.yml</literal>, where
<literal>CONF_DIR</literal> is <literal>ES_HOME/config</literal> (zip/tar installations) or <literal>/etc/elasticsearch</literal>
(package installations). To specify a different location, you configure the
<literal>files.role_mapping</literal> realm settings in <literal>elasticsearch.yml</literal>. This setting enable
you to use a different set of mappings for each realm type:</simpara>
<informaltable
frame="all"
rowsep="1" colsep="1"
>
<tgroup cols="4">
<colspec colname="col_1" colwidth="25*"/>
<colspec colname="col_2" colwidth="25*"/>
<colspec colname="col_3" colwidth="25*"/>
<colspec colname="col_4" colwidth="25*"/>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>xpack.security.authc.ldap.files.role_mapping</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>The location of the role mappings for LDAP realms.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>xpack.security.authc.active_directory.files.role_mapping</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>The location of the role mappings for Active Directory realms.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>xpack.security.authc.pki.files.role_mapping</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>The location of the role mappings for PKI realms.</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
<simpara>Within the role mapping file, the security roles are keys and groups and users
are values. The mappings can have a many-to-many relationship. When you map roles
to groups, the roles of a user in that group are the combination of the roles
assigned to that group and the roles assigned to that user.</simpara>
<simpara id="ad-role-mapping">The available roles are either added using the <link linkend="roles-management-api">Role Management APIs</link>
or defined in the <link linkend="roles-management-file">roles file</link>. To specify users and
groups in the role mappings, you use their <emphasis>Distinguished Names</emphasis> (DNs). A DN is
a string that uniquely identifies the user or group, for example
<literal>"cn=John Doe,cn=contractors,dc=example,dc=com"</literal>.</simpara>
<note><simpara>X-Pack security only supports Active Directory security groups. You cannot map
      distribution groups to roles.</simpara></note>
<simpara id="ldap-role-mapping">For example, the following snippet maps the <literal>admins</literal> group to the <literal>monitoring</literal>
role and maps the <literal>John Doe</literal> user, the <literal>users</literal> group, and the <literal>admins</literal> group to
the <literal>user</literal> role.</simpara>
<programlisting language="yaml" linenumbering="unnumbered">monitoring: <co id="CO12-1"/>
  - "cn=admins,dc=example,dc=com" <co id="CO12-2"/>
user:
  - "cn=John Doe,cn=contractors,dc=example,dc=com" <co id="CO12-3"/>
  - "cn=users,dc=example,dc=com"
  - "cn=admins,dc=example,dc=com"</programlisting>
<calloutlist>
<callout arearefs="CO12-1">
<para>
The name of a X-Pack security role.
</para>
</callout>
<callout arearefs="CO12-2">
<para>
The distinguished name of an LDAP group or an Active Directory security group.
</para>
</callout>
<callout arearefs="CO12-3">
<para>
The distinguished name of an LDAP or Active Directory user.
</para>
</callout>
</calloutlist>
<simpara id="pki-role-mapping">PKI realms only support mapping users to roles, as there is no notion of a group
in PKI. For example:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">monitoring:
  - "cn=Admin,ou=example,o=com"
user:
  - "cn=John Doe,ou=example,o=com"</programlisting>
</section>
<section id="field-and-document-access-control">
<title>Setting Up Field and Document Level Security<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authorization/field-and-document-access-control.asciidoc">Edit me</ulink></title>
<simpara>You can control access to data within an index by adding field and document level
security permissions to a role. Field level security permissions restrict access
to particular fields within a document. Document level security permissions
restrict access to particular documents within an index.</simpara>
<note><simpara>Document and field level security is currently meant to operate with
read-only privileged accounts. Users with document and field level
security enabled for an index should not perform write operations.</simpara></note>
<simpara>A role can define both field and document level permissions on a per-index basis.
A role that doesn’t specify field level permissions grants access to ALL fields.
Similarly, a role that doesn&#8217;t specify document level permissions grants access
to ALL documents in the index.</simpara>
<important>
<simpara>When assigning users multiple roles, be careful that you don&#8217;t inadvertently
grant wider access than intended. Each user has a single set of field level and
document level permissions per index. When you assign a user multiple roles,
the permissions are ORed together. This means if you assign one role that
restricts access to  particular fields in an index, and another that doesn&#8217;t
specify any field level access restrictions for that index, the user will have
access to all fields. The same is true for document level permissions.</simpara>
<simpara>For example, let&#8217;s say <literal>role_a</literal> only grants access to the <literal>address</literal>
field of the documents in <literal>index1</literal>, but doesn&#8217;t specify any document
restrictions. Conversely, <literal>role_b</literal> limits access to a subset of the documents
in <literal>index1</literal>, but doesn&#8217;t specify any field restrictions. If you assign a user
both roles, <literal>role_a</literal> gives the user access to all documents and <literal>role_b</literal> gives
the user access to all fields.</simpara>
<simpara>If you need to restrict access to both documents and fields, consider splitting
documents by index instead.</simpara>
</important>
<section id="field-level-security">
<title>Field Level Security<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authorization/field-and-document-access-control.asciidoc">Edit me</ulink></title>
<simpara>To enable field level security, you specify the fields that each role can access
as part of the indices permissions in a role definition. This binds field level
security to a well defined set of indices (and potentially a set of
<link linkend="document-level-security">documents</link>).</simpara>
<simpara>The following role definition grants read access only to the <literal>category</literal>,
<literal>@timestamp</literal>, and <literal>message</literal> fields in all the <literal>events-*</literal> indices.</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "indices": [
    {
      "names": [ "events-*" ],
      "privileges": [ "read" ],
      "field_security" : {
        "grant" : [ "category", "@timestamp", "message" ]
      }
    }
  ]
}</programlisting>
<simpara>To allow access to the <literal>_all</literal> meta field, you must explicitly list it as an
allowed field. Access to the following meta fields is always allowed: <literal>_id</literal>,
<literal>_type</literal>, <literal>_parent</literal>, <literal>_routing</literal>, <literal>_timestamp</literal>, <literal>_ttl</literal>, <literal>_size</literal> and <literal>_index</literal>. If
you specify an empty list of fields, only these meta fields are accessible.</simpara>
<note><simpara>Omitting the fields entry entirely disables field-level security.</simpara></note>
<simpara>You can also specify field expressions. For example, the following
example grants read access to all fields starting with <literal>event_</literal> prefix:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "indices" : [
    {
      "names" : [ "*" ],
      "privileges" : [ "read" ],
      "field_security" : {
        "grant" : [ "event_*" ]
      }
    }
  ]
}</programlisting>
<simpara>Use the dot notations to refer to nested fields in more complex documents. For
example, assuming the following document:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "customer": {
    "handle": "Jim",
    "email": "jim@mycompany.com",
    "phone": "555-555-5555"
  }
}</programlisting>
<simpara>The following role definition only allows access to the customer <literal>handle</literal> field:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "indices" : [
    {
      "names" : [ "*" ],
      "privileges" : [ "read" ],
      "field_security" : {
        "grant" : [ "customer.handle" ]
      }
    }
  ]
}</programlisting>
<simpara>This is where wildcard support shines. For example, use <literal>customer.*</literal> to only
enable read access to the <literal>customer</literal> data:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "indices" : [
    {
      "names" : [ "*" ],
      "privileges" : [ "read" ],
      "field_security" : {
        "grant" : [ "customer.*" ]
      }
    }
  ]
}</programlisting>
<simpara>Similar to granting field permissions the permission to access fields can be denied with the following syntax:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "indices" : [
    {
      "names" : [ "*" ],
      "privileges" : [ "read" ],
      "field_security" : {
        "grant" : [ "*"],
        "except": [ "customer.handle" ]
      }
    }
  ]
}</programlisting>
<simpara>The following rules apply:</simpara>
<simpara>Absence of "field_security" in a role is equivalent to * access.
Denied fields may only be provided if permission has been granted explicitly to other fields. The exceptions given must be a subset of the
fields that permissions have been granted to.
Denied and granted fields defined implies access to all granted fields except those which match the pattern in denied fields. Example:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "indices" : [
    {
      "names" : [ "*" ],
      "privileges" : [ "read" ],
      "field_security" : {
        "except": [ "customer.handle" ],
        "grant" : [ "customer.*" ]
      }
    }
  ]
}</programlisting>
<simpara>In the above example all fields with the prefix "customer." are allowed except for "customer.handle".</simpara>
<simpara>An empty array for grant (eg. "grant" : []) means that no fields are granted access to.</simpara>
<section id="_field_level_security_and_roles">
<title>Field Level Security and Roles<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authorization/field-and-document-access-control.asciidoc">Edit me</ulink></title>
<simpara>When a user has several roles that specify field level permissions then the resulting field level permissions per index are the union
of the individual role permissions.
For example if these two roles are merged:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  // role 1
  ...
  "indices" : [
    {
      "names" : [ "*" ],
      "privileges" : [ "read" ],
      "field_security" : {
        "grant": [ "a.*" ],
        "except" : [ "a.b*" ]
      }
    }
  ]
}

{
  // role 2
  ...
  "indices" : [
    {
      "names" : [ "*" ],
      "privileges" : [ "read" ],
      "field_security" : {
        "grant": [ "a.b*" ],
        "except" : [ "a.b.c*" ]
      }
    }
  ]
}</programlisting>
<simpara>Then the resulting permission would be equal to:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  // role 1 + role 2
  ...
  "indices" : [
    {
      "names" : [ "*" ],
      "privileges" : [ "read" ],
      "field_security" : {
        "grant": [ "a.*" ],
        "except" : [ "a.b.c*" ]
      }
    }
  ]
}</programlisting>
</section>
</section>
<section id="document-level-security">
<title>Document Level Security<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authorization/field-and-document-access-control.asciidoc">Edit me</ulink></title>
<simpara>Document level security restricts the documents that users have read access to.
To enable document level security, you specify a query that matches all the
accessible documents as part of the indices permissions within a role definition.
This binds document level security to a well defined set of indices.</simpara>
<simpara>Enabling document level security restricts which documents can be accessed from any document based read API.
To enable document level security, you use a query to specify the documents that each role can access in the <literal>roles.yml</literal> file.
You specify the document query with the <literal>query</literal> option. The document query is associated with a particular index or index pattern and
operates in conjunction with the privileges specified for the indices.</simpara>
<simpara>The following role definition grants read access only to documents that
belong to the <literal>click</literal> category within all the <literal>events-*</literal> indices.</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "indices": [
    {
      "names": [ "events-*" ],
      "privileges": [ "read" ],
      "query": "{\"match\": {\"category\": \"click\"}}"
    }
  ]
}</programlisting>
<note><simpara>Omitting the <literal>query</literal> entry entirely disables document level security for
      the respective indices permission entry.</simpara></note>
<simpara>The specified <literal>query</literal> expects the same format as if it was defined in the
search request and supports ELasticsearch&#8217;s full <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/query-dsl.html">Query DSL</ulink>.</simpara>
<simpara>For example, the following role grants read access to all indices, but restricts
access to documents whose <literal>department_id</literal> equals <literal>12</literal>.</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "indices" : [
    {
      "names" : [ "*" ],
      "privileges" : [ "read" ],
      "query" : {
        "term" : { "department_id" : 12 }
      }
    }
  ]
}</programlisting>
<note><simpara><literal>query</literal> also accepts queries written as string values</simpara></note>
<section id="templating-role-query">
<title>Templating a Role Query<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authorization/field-and-document-access-control.asciidoc">Edit me</ulink></title>
<simpara>You can use Mustache templates in a role query to insert the username of the
current authenticated user into the role. Like other places in Elasticsearch
that support templating or scripting, you can specify inline, stored,
or file based templates and define custom parameters. You access the current
authenticated user&#8217;s details through the <literal>_user</literal> parameter.</simpara>
<simpara>For example, the following role query uses a template to insert the username
of the current authenticated user:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "indices" : [
    {
      "names" : [ "my_index" ],
      "privileges" : [ "read" ],
      "query" : {
        "template" : {
          "inline" : {
            "term" : { "acl.username" : "{{_user.username}}" }
          }
        }
      }
    }
  ]
}</programlisting>
<simpara>You can access the following information through the <literal>_user</literal> variable:</simpara>
<informaltable
frame="all"
rowsep="1" colsep="1"
>
<tgroup cols="2">
<colspec colname="col_1" colwidth="50*"/>
<colspec colname="col_2" colwidth="50*"/>
<thead>
<row>
<entry align="left" valign="top"> Property              </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>_user.username</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The username of the current authenticated user.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>_user.full_name</literal></simpara></entry>
<entry align="left" valign="top"><simpara>If specified, the full name of the current authenticated user.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>_user.email</literal></simpara></entry>
<entry align="left" valign="top"><simpara>If specified, the email of the current authenticated user.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>_user.roles</literal></simpara></entry>
<entry align="left" valign="top"><simpara>If associated, a list of the role names of the current authenticated user.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>_user.metadata</literal></simpara></entry>
<entry align="left" valign="top"><simpara>If specified, a hash holding custom metadata of the current authenticated user.</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
<simpara>You can also access custom user metadata. For example, if you maintain a
<literal>group_id</literal> in your user metadata, you can apply document level security
based on the <literal>group.id</literal> field in your documents:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "indices" : [
    {
      "names" : [ "my_index" ],
      "privileges" : [ "read" ],
      "query" : {
        "template" : {
          "inline" : {
            "term" : { "group.id" : "{{_user.metadata.group_id}}" }
          }
        }
      }
    }
  ]
}</programlisting>
</section>
<section id="set-security-user-processor">
<title>Set Security User Ingest Processor<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authorization/field-and-document-access-control.asciidoc">Edit me</ulink></title>
<simpara>If an index is being shared by many small users it makes sense put all these users into the same index as having a
dedicated index or shard per user is too wasteful. In order to guarantee that a user only read its own documents it
makes sense to set up document level security. In order to use document level security for this each document must have
the username or role name associated with it, so that it can be queried by the document level security&#8217;s role query.
This is where the <literal>set_security_user</literal> ingest processor can help.</simpara>
<note><simpara>You need to make sure to use unique ids for each user that uses the same index, because document level security
      doesn&#8217;t apply on write APIs and you can overwrite other users' documents. This ingest processor just adds
      properties of the current authenticated user to the documents being indexed.</simpara></note>
<simpara>The <literal>set_security_user</literal> processor attaches user related details (<literal>username</literal>, <literal>roles</literal>, <literal>email</literal>, <literal>full_name</literal> and <literal>metadata</literal> )
from the current authenticated user to the current document by pre-processed by ingest.</simpara>
<simpara>So when indexing data with an ingest pipeline then user details get automatically attached with the document:</simpara>
<programlisting language="js" linenumbering="unnumbered">PUT shared-logs/log/1?pipeline=my_pipeline_id
{
  ...
}</programlisting>
<simpara>Read the <ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/master/ingest.html">ingest docs</ulink> for more information
about setting up a pipeline and other processors.</simpara>
<table id="set-security-user-options"
frame="all"
rowsep="1" colsep="1"
>
<title>Set Security User Options</title>
<tgroup cols="4">
<colspec colname="col_1" colwidth="25*"/>
<colspec colname="col_2" colwidth="25*"/>
<colspec colname="col_3" colwidth="25*"/>
<colspec colname="col_4" colwidth="25*"/>
<thead>
<row>
<entry align="left" valign="top"> Name          </entry>
<entry align="left" valign="top"> Required  </entry>
<entry align="left" valign="top"> Default                                                   </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>field</literal></simpara></entry>
<entry align="left" valign="top"><simpara>yes</simpara></entry>
<entry align="left" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The field to store the user information into.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>properties</literal></simpara></entry>
<entry align="left" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>[<literal>username</literal>, <literal>roles</literal>, <literal>email</literal>, <literal>full_name</literal>, <literal>metadata</literal>]</simpara></entry>
<entry align="left" valign="top"><simpara>Controls what user related properties are added to the <literal>field</literal>.</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<simpara>Example config that adds all user details of the current authenticated user to the <literal>user</literal> field to  all documents being
processed by this pipeline:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "processors" : [
    {
      "set_security_user": {
        "field": "user"
      }
    }
  ]
}</programlisting>
</section>
</section>
<section id="multiple-roles-dls-fls">
<title>Multiple Roles with Document and Field Level Security<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authorization/field-and-document-access-control.asciidoc">Edit me</ulink></title>
<simpara>A user can have many roles and each role can define different permissions on the
same index. It is important to understand the behavior of Document and Field Level
security in this scenario.</simpara>
<simpara>Document level security will take into account each role held by the user, and
combine each document level security query for a given index with an "OR". This
means that only one of the role queries must match for a document to be returned.
For example, if a role grants access to an index without document level security
and another grants access with document level security, document level security
will not be applied; the user with both roles will have access to all of the
documents in the index.</simpara>
<simpara>Field level security will take into account each role the user has and combine
all of the fields listed into a single set for each index. For example, if a
role grants access to an index without field level security and another grants
access with field level security, field level security will not be applied for
that index; the user with both roles will have access to all of the fields in
in the index.</simpara>
</section>
</section>
<section id="run-as-privilege">
<title>Submitting Requests on Behalf of Other Users<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/authorization/run-as-privilege.asciidoc">Edit me</ulink></title>
<simpara>X-Pack security supports a permission that enables an authenticated user to submit
requests on behalf of other users. If your application already authenticates
users, you can use the <emphasis>run as</emphasis> mechanism to restrict data access according to
X-Pack security permissions without having to re-authenticate each user through.</simpara>
<simpara>To "run as" (impersonate) another user, you must be able to retrieve the user from
the realm you use to authenticate. Both the internal <literal>native</literal> and <literal>file</literal> realms
support this out of the box. The LDAP realm however must be configured to enable
user search. For more information, see <link linkend="ldap-user-search">Configuring an LDAP Realm with User Search</link>.</simpara>
<simpara>To submit requests on behalf of other users, you need to have the <literal>run_as</literal>
permission. For example, the following role grants permission to submit request
on behalf of <literal>jacknich</literal> or <literal>redeniro</literal>:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "run_as" : [ "jacknich", "rdeniro" ]
}</programlisting>
<simpara>To submit a request as another user, you specify the user in the
<literal>es-security-runas-user</literal> request header. For example:</simpara>
<programlisting language="shell" linenumbering="unnumbered">curl -H "es-security-runas-user: jacknich"  -u es_admin -XGET 'http://localhost:9200/'</programlisting>
</section>
</chapter>
<chapter id="auditing">
<title>Auditing Security Events<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/auditing.asciidoc">Edit me</ulink></title>
<simpara>You can enable auditing to keep track of security-related events such as
authentication failures and refused connections. Logging these events enables you
to monitor your cluster for suspicious activity and provides evidence in the
event of an attack.</simpara>
<important>
<simpara>Audit logs are <emphasis role="strong">disabled</emphasis> by default. To enable this functionality, you
must set <literal>xpack.security.audit.enabled</literal> to <literal>true</literal> in <literal>elasticsearch.yml</literal>.</simpara>
</important>
<simpara>X-Pack security provides two ways to persist audit logs:</simpara>
<itemizedlist>
<listitem>
<simpara>
The <link linkend="audit-log-output"><literal>logfile</literal></link> output, which persists events to
  a dedicated <literal>&lt;clustername&gt;_access.log</literal> file on the host&#8217;s file system.
</simpara>
</listitem>
<listitem>
<simpara>
The <link linkend="audit-index"><literal>index</literal></link> output, which persists events to an Elasticsearch index.
The audit index can reside on the same cluster, or a separate cluster.
</simpara>
</listitem>
</itemizedlist>
<simpara>By default, only the <literal>logfile</literal> output is used when enabling auditing.
To facilitate browsing and analyzing the events, you can also enable
indexing by setting <literal>xpack.security.audit.outputs</literal> in <literal>elasticsearch.yml</literal>:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.security.audit.outputs: [ index, logfile ]</programlisting>
<simpara>The <literal>index</literal> output type should be used in conjunction with the <literal>logfile</literal>
output type Because it is possible for the <literal>index</literal> output type to lose
messages if the target index is unavailable, the <literal>access.log</literal> should be
used as the official record of events.</simpara>
<note><simpara>Audit events are batched for indexing so there is a lag before
events appear in the index. You can control how frequently batches of
events are pushed to the index by setting
<literal>xpack.security.audit.index.flush_interval</literal> in <literal>elasticsearch.yml</literal>.</simpara></note>
<bridgehead id="audit-event-types" renderas="sect2">Audit Event Types<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/auditing.asciidoc">Edit me</ulink></bridgehead>
<simpara>Each request may generate multiple audit events.
The following is a list of the events that can be generated:</simpara>
<informaltable
frame="all"
rowsep="1" colsep="1"
>
<tgroup cols="4">
<colspec colname="col_1" colwidth="25*"/>
<colspec colname="col_2" colwidth="25*"/>
<colspec colname="col_3" colwidth="25*"/>
<colspec colname="col_4" colwidth="25*"/>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>anonymous_access_denied</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Logged when a request is denied due to a missing
                                          authentication token.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>authentication_success</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Logged when a user successfully authenticates.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>authentication_failed</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Logged when the authentication token cannot be
                                          matched to a known user.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>realm_authentication_failed</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Logged for every realm that fails to present a valid
                                          authentication token. <literal>&lt;realm&gt;</literal> represents the
                                          realm type.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>access_denied</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Logged when an authenticated user attempts to execute
                                          an action they do not have the necessary
                                          <link linkend="security-reference">privilege</link> to perform.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>access_granted</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Logged when an authenticated user attempts to execute
                                          an action they have the necessary privilege to perform.
                                          When the <literal>system_access_granted</literal> event is included, all system
                                          (internal) actions are also logged. The default setting does
                                          not log system actions to avoid cluttering the logs.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>run_as_granted</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Logged when an authenticated user attempts to <link linkend="run-as-privilege">run as</link>
                                          another user that they have the necessary privileges to do.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>run_as_denied</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Logged when an authenticated user attempts to <link linkend="run-as-privilege">run as</link>
                                          another user action they do not have the necessary
                                          <link linkend="security-reference">privilege</link> to do so.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>tampered_request</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Logged when X-Pack security detects that the request has
                                          been tampered with. Typically relates to <literal>search/scroll</literal>
                                          requests when the scroll ID is believed to have been
                                          tampered with.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>connection_granted</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Logged when an incoming TCP connection passes the
                                          <link linkend="ip-filtering">IP Filter</link> for a specific
                                          profile.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>connection_denied</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Logged when an incoming TCP connection does not pass the
                                          <link linkend="ip-filtering">IP Filter</link> for a specific
                                          profile.</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
<bridgehead id="audit-event-attributes" renderas="sect2">Audit Event Attributes<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/auditing.asciidoc">Edit me</ulink></bridgehead>
<simpara>The following table shows the common attributes that can be associated with every event.</simpara>
<table
frame="all"
rowsep="1" colsep="1"
>
<title>Common Attributes</title>
<tgroup cols="2">
<colspec colname="col_1" colwidth="22*"/>
<colspec colname="col_2" colwidth="77*"/>
<thead>
<row>
<entry align="left" valign="top"> Attribute           </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>timestamp</literal></simpara></entry>
<entry align="left" valign="top"><simpara>When the event occurred.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>node_name</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The name of the node.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>node_host_name</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The hostname of the node.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>node_host_address</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The IP address of the node.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>layer</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The layer from which this event originated: <literal>rest</literal>, <literal>transport</literal> or <literal>ip_filter</literal></simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>event_type</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The type of event that occurred: <literal>anonymous_access_denied</literal>,
                        <literal>authentication_failed</literal>, <literal>access_denied</literal>, <literal>access_granted</literal>,
                        <literal>connection_granted</literal>, <literal>connection_denied</literal>, <literal>tampered_request</literal>,
                        <literal>run_as_granted</literal>, <literal>run_as_denied</literal>.</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<simpara>The following tables show the attributes that can be associated with each type of event.
The log level determines  which attributes are included in a log entry.</simpara>
<table
frame="all"
rowsep="1" colsep="1"
>
<title>REST anonymous_access_denied Attributes</title>
<tgroup cols="2">
<colspec colname="col_1" colwidth="22*"/>
<colspec colname="col_2" colwidth="77*"/>
<thead>
<row>
<entry align="left" valign="top"> Attribute         </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>origin_address</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The IP address from which the request originated.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>uri</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The REST endpoint URI.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request_body</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The body of the request, if enabled.</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<table
frame="all"
rowsep="1" colsep="1"
>
<title>REST authentication_success Attributes</title>
<tgroup cols="2">
<colspec colname="col_1" colwidth="22*"/>
<colspec colname="col_2" colwidth="77*"/>
<thead>
<row>
<entry align="left" valign="top"> Attribute         </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>user</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The authenticated user.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>realm</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The realm that authenticated the user.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>uri</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The REST endpoint URI.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>params</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The REST URI query parameters.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request_body</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The body of the request, if enabled.</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<table
frame="all"
rowsep="1" colsep="1"
>
<title>REST authentication_failed Attributes</title>
<tgroup cols="2">
<colspec colname="col_1" colwidth="22*"/>
<colspec colname="col_2" colwidth="77*"/>
<thead>
<row>
<entry align="left" valign="top"> Attribute         </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>origin_address</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The IP address from which the request originated.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>principal</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The principal (username) that failed authentication.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>uri</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The REST endpoint URI.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request_body</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The body of the request, if enabled.</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<table
frame="all"
rowsep="1" colsep="1"
>
<title>REST realm_authentication_failed Attributes</title>
<tgroup cols="2">
<colspec colname="col_1" colwidth="22*"/>
<colspec colname="col_2" colwidth="77*"/>
<thead>
<row>
<entry align="left" valign="top"> Attribute         </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>origin_address</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The IP address from which the request originated.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>principal</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The principal (username) that failed authentication.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>uri</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The REST endpoint URI.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request_body</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The body of the request, if enabled.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>realm</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The realm that failed to authenticate the user.
                      NOTE: A separate entry is logged for each
                            consulted realm.</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<table
frame="all"
rowsep="1" colsep="1"
>
<title>Transport anonymous_access_denied Attributes</title>
<tgroup cols="2">
<colspec colname="col_1" colwidth="22*"/>
<colspec colname="col_2" colwidth="77*"/>
<thead>
<row>
<entry align="left" valign="top"> Attribute         </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>origin_type</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Where the request originated: <literal>rest</literal> (request
                      originated from a REST API request), <literal>transport</literal>
                      (request was received on the transport channel),
                      <literal>local_node</literal> (the local node issued the request).</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>origin_address</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The IP address from which the request originated.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>action</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The name of the action that was executed.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The type of request that was executed.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>indices</literal></simpara></entry>
<entry align="left" valign="top"><simpara>A comma-separated list of indices this request
                      pertains to (when applicable).</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<table
frame="all"
rowsep="1" colsep="1"
>
<title>Transport authentication_success Attributes</title>
<tgroup cols="2">
<colspec colname="col_1" colwidth="22*"/>
<colspec colname="col_2" colwidth="77*"/>
<thead>
<row>
<entry align="left" valign="top"> Attribute         </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>origin_type</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Where the request originated: <literal>rest</literal> (request
                      originated from a REST API request), <literal>transport</literal>
                      (request was received on the transport channel),
                      <literal>local_node</literal> (the local node issued the request).</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>origin_address</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The IP address from which the request originated.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>user</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The authenticated user.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>realm</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The realm that authenticated the user.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>action</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The name of the action that was executed.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The type of request that was executed.</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<table
frame="all"
rowsep="1" colsep="1"
>
<title>Transport authentication_failed Attributes</title>
<tgroup cols="2">
<colspec colname="col_1" colwidth="22*"/>
<colspec colname="col_2" colwidth="77*"/>
<thead>
<row>
<entry align="left" valign="top"> Attribute         </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>origin_type</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Where the request originated: <literal>rest</literal> (request
                      originated from a REST API request), <literal>transport</literal>
                      (request was received on the transport channel),
                      <literal>local_node</literal> (the local node issued the request).</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>origin_address</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The IP address from which the request originated.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>principal</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The principal (username) that failed authentication.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>action</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The name of the action that was executed.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The type of request that was executed.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>indices</literal></simpara></entry>
<entry align="left" valign="top"><simpara>A comma-separated list of indices this request
                      pertains to (when applicable).</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<table
frame="all"
rowsep="1" colsep="1"
>
<title>Transport realm_authentication_failed Attributes</title>
<tgroup cols="2">
<colspec colname="col_1" colwidth="22*"/>
<colspec colname="col_2" colwidth="77*"/>
<thead>
<row>
<entry align="left" valign="top"> Attribute         </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>origin_type</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Where the request originated: <literal>rest</literal> (request
                      originated from a REST API request), <literal>transport</literal>
                      (request was received on the transport channel),
                      <literal>local_node</literal> (the local node issued the request).</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>origin_address</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The IP address from which the request originated.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>principal</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The principal (username) that failed authentication.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>action</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The name of the action that was executed.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The type of request that was executed.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>indices</literal></simpara></entry>
<entry align="left" valign="top"><simpara>A comma-separated list of indices this request
                      pertains to (when applicable).</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>realm</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The realm that failed to authenticate the user.
                      NOTE: A separate entry is logged for each
                            consulted realm.</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<table
frame="all"
rowsep="1" colsep="1"
>
<title>Transport access_granted Attributes</title>
<tgroup cols="2">
<colspec colname="col_1" colwidth="22*"/>
<colspec colname="col_2" colwidth="77*"/>
<thead>
<row>
<entry align="left" valign="top"> Attribute         </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>origin_type</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Where the request originated: <literal>rest</literal> (request
                      originated from a REST API request), <literal>transport</literal>
                      (request was received on the transport channel),
                      <literal>local_node</literal> (the local node issued the request).</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>origin_address</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The IP address from which the request originated.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>principal</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The principal (username) that failed authentication.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>action</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The name of the action that was executed.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The type of request that was executed.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>indices</literal></simpara></entry>
<entry align="left" valign="top"><simpara>A comma-separated list of indices this request
                      pertains to (when applicable).</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<table
frame="all"
rowsep="1" colsep="1"
>
<title>Transport access_denied Attributes</title>
<tgroup cols="2">
<colspec colname="col_1" colwidth="22*"/>
<colspec colname="col_2" colwidth="77*"/>
<thead>
<row>
<entry align="left" valign="top"> Attribute         </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>origin_type</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Where the request originated: <literal>rest</literal> (request
                      originated from a REST API request), <literal>transport</literal>
                      (request was received on the transport channel),
                      <literal>local_node</literal> (the local node issued the request).</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>origin_address</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The IP address from which the request originated.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>principal</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The principal (username) that failed authentication.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>action</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The name of the action that was executed.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The type of request that was executed.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>indices</literal></simpara></entry>
<entry align="left" valign="top"><simpara>A comma-separated list of indices this request
                      relates to (when applicable).</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<table
frame="all"
rowsep="1" colsep="1"
>
<title>Transport tampered_request Attributes</title>
<tgroup cols="2">
<colspec colname="col_1" colwidth="22*"/>
<colspec colname="col_2" colwidth="77*"/>
<thead>
<row>
<entry align="left" valign="top"> Attribute         </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>origin_type</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Where the request originated: <literal>rest</literal> (request
                      originated from a REST API request), <literal>transport</literal>
                      (request was received on the transport channel),
                      <literal>local_node</literal> (the local node issued the request).</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>origin_address</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The IP address from which the request originated.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>principal</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The principal (username) that failed to authenticate.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>action</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The name of the action that was executed.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The type of request that was executed.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>indices</literal></simpara></entry>
<entry align="left" valign="top"><simpara>A comma-separated list of indices this request
                      pertains to (when applicable).</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<table
frame="all"
rowsep="1" colsep="1"
>
<title>IP Filter connection_granted Attributes</title>
<tgroup cols="2">
<colspec colname="col_1" colwidth="22*"/>
<colspec colname="col_2" colwidth="77*"/>
<thead>
<row>
<entry align="left" valign="top"> Attribute           </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>origin_address</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The IP address from which the request originated.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>transport_profile</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The transport profile the request targeted.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>rule</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The <link linkend="ip-filtering">IP filtering</link> rule that granted
                        the request.</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<table
frame="all"
rowsep="1" colsep="1"
>
<title>IP Filter connection_denied Attributes</title>
<tgroup cols="2">
<colspec colname="col_1" colwidth="22*"/>
<colspec colname="col_2" colwidth="77*"/>
<thead>
<row>
<entry align="left" valign="top"> Attribute           </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>origin_address</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The IP address from which the request originated.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>transport_profile</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The transport profile the request targeted.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>rule</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The <link linkend="ip-filtering">IP filtering</link> rule that denied
                        the request.</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<bridgehead id="audit-log-output" renderas="sect2">Logfile Audit Output<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/auditing.asciidoc">Edit me</ulink></bridgehead>
<simpara>The <literal>logfile</literal> audit output is the default output for auditing. It writes data to
the <literal>&lt;clustername&gt;_access.log</literal> file in the logs directory.</simpara>
<bridgehead id="audit-log-entry-format" renderas="sect2">Log Entry Format<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/auditing.asciidoc">Edit me</ulink></bridgehead>
<simpara>The format of a log entry is:</simpara>
<programlisting language="txt" linenumbering="unnumbered">[&lt;timestamp&gt;] [&lt;local_node_info&gt;] [&lt;layer&gt;] [&lt;entry_type&gt;] &lt;attribute_list&gt;</programlisting>
<variablelist>
<varlistentry>
<term>
<literal>&lt;timestamp&gt;</literal>       
</term>
<listitem>
<simpara>
When the event occurred. You can configure the
                            timestamp format in <literal>log4j2.properties</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>&lt;local_node_info&gt;</literal> 
</term>
<listitem>
<simpara>
Information about the local node that generated
                            the log entry. You can control what node information
                            is included by configuring the
                            <link linkend="audit-log-entry-local-node-info">local node info settings</link>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>&lt;layer&gt;</literal>           
</term>
<listitem>
<simpara>
The layer from which this event originated:
                            <literal>rest</literal>, <literal>transport</literal> or <literal>ip_filter</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>&lt;entry_type&gt;</literal>      
</term>
<listitem>
<simpara>
The type of event that occurred: <literal>anonymous_access_denied</literal>,
                            <literal>authentication_failed</literal>, <literal>access_denied</literal>, <literal>access_granted</literal>,
                            <literal>connection_granted</literal>, <literal>connection_denied</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>&lt;attribute_list&gt;</literal>  
</term>
<listitem>
<simpara>
A comma-separated list of key-value pairs that contain
                            data pertaining to the event. Formatted as
                            <literal>attr1=[val1], attr2=[val2]</literal>. See <link linkend="audit-event-attributes">Audit Entry Attributes</link> for the attributes that can be included
                            for each type of event.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="audit-log-settings" renderas="sect2">Logfile Output Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/auditing.asciidoc">Edit me</ulink></bridgehead>
<simpara>The events and some other information about what gets logged can be
controlled using settings in the <literal>elasticsearch.yml</literal> file.</simpara>
<table
frame="all"
rowsep="1" colsep="1"
>
<title>Audited Event Settings</title>
<tgroup cols="3">
<colspec colname="col_1" colwidth="40*"/>
<colspec colname="col_2" colwidth="20*"/>
<colspec colname="col_3" colwidth="40*"/>
<thead>
<row>
<entry align="left" valign="top"> Name                                                   </entry>
<entry align="center" valign="top"> Default   </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>xpack.security.audit.logfile.events.include</literal></simpara></entry>
<entry align="center" valign="top"><simpara><literal>access_denied</literal>, <literal>access_granted</literal>, <literal>anonymous_access_denied</literal>, <literal>authentication_failed</literal>, <literal>connection_denied</literal>, <literal>tampered_request</literal>, <literal>run_as_denied</literal>, <literal>run_as_granted</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Includes the specified events in the output.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>xpack.security.audit.logfile.events.exclude</literal></simpara></entry>
<entry align="center" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Excludes the specified events from the output.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>xpack.security.audit.logfile.events.emit_request_body</literal></simpara></entry>
<entry align="center" valign="top"><simpara>false</simpara></entry>
<entry align="left" valign="top"><simpara>Include or exclude the request body from REST requests
                                                                       on certain event types such as <literal>authentication_failed</literal>.</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<important><simpara>No filtering is performed when auditing, so sensitive data may be
audited in plain text when including the request body in audit events.</simpara></important>
<table id="audit-log-entry-local-node-info"
frame="all"
rowsep="1" colsep="1"
>
<title>Local Node Info Settings</title>
<tgroup cols="3">
<colspec colname="col_1" colwidth="40*"/>
<colspec colname="col_2" colwidth="20*"/>
<colspec colname="col_3" colwidth="40*"/>
<thead>
<row>
<entry align="left" valign="top"> Name                                                   </entry>
<entry align="center" valign="top"> Default   </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>xpack.security.audit.logfile.prefix.emit_node_name</literal></simpara></entry>
<entry align="center" valign="top"><simpara>true</simpara></entry>
<entry align="left" valign="top"><simpara>Include or exclude the node&#8217;s name
                                                                               from the local node info.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>xpack.security.audit.logfile.prefix.emit_node_host_address</literal></simpara></entry>
<entry align="center" valign="top"><simpara>false</simpara></entry>
<entry align="left" valign="top"><simpara>Include or exclude the node&#8217;s IP address
                                                                               from the local node info.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>xpack.security.audit.logfile.prefix.emit_node_host_name</literal></simpara></entry>
<entry align="center" valign="top"><simpara>false</simpara></entry>
<entry align="left" valign="top"><simpara>Include or exclude the node&#8217;s host name
                                                                               from the local node info.</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<simpara id="logging-file">You configure also configure how the logfile is written in the <literal>log4j2.properties</literal>
file located in <literal>CONFIG_DIR/x-pack</literal>. By default, audit information is appended to the
<literal>&lt;clustername&gt;_access.log</literal> file located in the standard Elasticsearch <literal>logs</literal> directory
(typically located at <literal>$ES_HOME/logs</literal>). The file rolls over on a daily basis.</simpara>
<bridgehead id="audit-index" renderas="sect2">Index Audit Output<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/auditing.asciidoc">Edit me</ulink></bridgehead>
<simpara>In addition to logging to a file, you can store audit logs in Elasticsearch
rolling indices. These indices can be either on the same cluster, or on a
remote cluster. You configure the following settings in
<literal>elasticsearch.yml</literal> to control how audit entries are indexed. To enable
this output, you need to configure the setting <literal>xpack.security.audit.outputs</literal>
in the <literal>elasticsearch.yml</literal> file:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.security.audit.outputs: [ index, logfile ]</programlisting>
<table
frame="all"
rowsep="1" colsep="1"
>
<title>Audit Log Indexing Configuration</title>
<tgroup cols="3">
<colspec colname="col_1" colwidth="33*"/>
<colspec colname="col_2" colwidth="33*"/>
<colspec colname="col_3" colwidth="33*"/>
<thead>
<row>
<entry align="left" valign="top"> Attribute                           </entry>
<entry align="left" valign="top"> Default Setting </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>xpack.security.audit.index.bulk_size</literal></simpara></entry>
<entry align="left" valign="top"><simpara><literal>1000</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Controls how many audit events are batched into a single write.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>xpack.security.audit.index.flush_interval</literal></simpara></entry>
<entry align="left" valign="top"><simpara><literal>1s</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Controls how often buffered events are flushed to the index.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>xpack.security.audit.index.rollover</literal></simpara></entry>
<entry align="left" valign="top"><simpara><literal>daily</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Controls how often to roll over to a new index:
                                                                  <literal>hourly</literal>, <literal>daily</literal>, <literal>weekly</literal>, or <literal>monthly</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>xpack.security.audit.index.events.include</literal></simpara></entry>
<entry align="left" valign="top"><simpara><literal>anonymous_access_denied</literal>, <literal>authentication_failed</literal>, <literal>realm_authentication_failed</literal>, <literal>access_granted</literal>, <literal>access_denied</literal>, <literal>tampered_request</literal>, <literal>connection_granted</literal>, <literal>connection_denied</literal>, <literal>run_as_granted</literal>, <literal>run_as_denied</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The audit events to be indexed. See <link linkend="audit-event-types">Audit Entry Types</link> for the complete list.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>xpack.security.audit.index.events.exclude</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>The audit events to exclude from indexing.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>xpack.security.audit.index.events.emit_request_body</literal></simpara></entry>
<entry align="left" valign="top"><simpara>false</simpara></entry>
<entry align="left" valign="top"><simpara>Include or exclude the request body from REST requests
                                                                   on certain event types such as <literal>authentication_failed</literal>.</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<important><simpara>No filtering is performed when auditing, so sensitive data may be
audited in plain text when including the request body in audit events.</simpara></important>
<bridgehead id="_audit_index_settings" renderas="sect3">Audit Index Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/auditing.asciidoc">Edit me</ulink></bridgehead>
<simpara>You can also configure settings for the indices that the events are stored in.
These settings are configured in the <literal>xpack.security.audit.index.settings</literal> namespace
in <literal>elasticsearch.yml</literal>. For example, the following configuration sets the
number of shards and replicas to 1 for the audit indices:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.security.audit.index.settings:
  index:
    number_of_shards: 1
    number_of_replicas: 1</programlisting>
<bridgehead id="_forwarding_audit_logs_to_a_remote_cluster" renderas="sect3">Forwarding Audit Logs to a Remote Cluster<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/auditing.asciidoc">Edit me</ulink></bridgehead>
<simpara>To index audit events to a remote Elasticsearch cluster, you configure
the following <literal>xpack.security.audit.index.client</literal> settings.</simpara>
<table
frame="all"
rowsep="1" colsep="1"
>
<title>Remote Audit Log Indexing Configuration</title>
<tgroup cols="2">
<colspec colname="col_1" colwidth="50*"/>
<colspec colname="col_2" colwidth="50*"/>
<thead>
<row>
<entry align="left" valign="top"> Attribute                                                 </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>xpack.security.audit.index.client.hosts</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Comma-separated list of <literal>host:port</literal> pairs. These hosts
                                                              should be nodes in the remote cluster.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>xpack.security.audit.index.client.cluster.name</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The name of the remote cluster.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>xpack.security.audit.index.client.xpack.security.user</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The <literal>username:password</literal> pair to use to authenticate with
                                                              the remote cluster.</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<simpara>You can pass additional settings to the remote client by specifying them in the
<literal>xpack.security.audit.index.client</literal> namespace. For example, to allow the remote
client to discover all of the nodes in the remote cluster you can specify the
<literal>client.transport.sniff</literal> setting:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.security.audit.index.client.transport.sniff: true</programlisting>
</chapter>
<chapter id="encrypting-communications">
<title>Encrypting Communications<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/securing-communications.asciidoc">Edit me</ulink></title>
<simpara>Elasticsearch nodes store data that may be confidential. Attacks on the data may
come from the network. These attacks could include sniffing of the data,
manipulation of the data, and attempts to gain access to the server and thus the
files storing the data. Securing your nodes with the procedures below helps to
reduce risk from network-based attacks.</simpara>
<simpara>This section shows how to:</simpara>
<itemizedlist>
<listitem>
<simpara>
Encrypt traffic to, from and within an Elasticsearch cluster using SSL/TLS,
</simpara>
</listitem>
<listitem>
<simpara>
Require nodes to authenticate as they join the cluster using SSL certificates, and
</simpara>
</listitem>
<listitem>
<simpara>
Make it more difficult for remote attackers to issue any commands to Elasticsearch.
</simpara>
</listitem>
</itemizedlist>
<simpara>The authentication of new nodes helps prevent a rogue node from joining the
cluster and receiving data through replication.</simpara>
<section id="ssl-tls">
<title>Setting Up SSL/TLS on a Cluster<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/securing-communications/setting-up-ssl.asciidoc">Edit me</ulink></title>
<simpara>X-Pack security enables you to encrypt traffic to, from and within your Elasticsearch
cluster. Connections are secured using Transport Layer Security (TLS), which is
commonly referred to as "SSL".</simpara>
<warning><simpara>Clusters that do not have encryption enabled send all data in plain text
including passwords.</simpara></warning>
<simpara>To enable encryption, you need to perform the following steps on each node in
the cluster:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
<link linkend="installing-node-certificates">Generate a private key and X.509 certificate</link>.
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="configure-ssl">Configure the node</link> to:
</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>
Identify itself using its signed certificate.
</simpara>
</listitem>
<listitem>
<simpara>
Enable SSL on the transport and HTTP layers.
</simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>
Restart Elasticsearch.
</simpara>
</listitem>
</orderedlist>
<section id="installing-node-certificates">
<title>Node Certificates<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/securing-communications/setting-up-ssl.asciidoc">Edit me</ulink></title>
<simpara>TLS requires X.509 certificates to perform encryption and authentication of the application
that is being communicated with. In order for the communication between nodes to be truly
secure, the certificates must be validated. The recommended approach for validating
certificate authenticity in a Elasticsearch cluster is to trust the certificate authority (CA)
that signed the certificate. By doing this, as nodes are added to your cluster they just need
to use a certificate signed by the same CA and the node is automatically allowed to join the
cluster. Additionally, it is recommended that the certificates contain subject alternative
names (SAN) that correspond to the node&#8217;s ip address and dns name so that hostname verification
can be performed.</simpara>
<simpara>In order to simplify the process of generating certificates for the Elastic Stack, a command
line tool, <literal>certgen</literal> has been included with X-Pack. This tool takes care of the generating
a CA and signing certificates with the CA. <literal>certgen</literal> can be used interactively or in a silent
mode through the use of an input file. The <literal>certgen</literal> tool also supports generation of certificate
signing requests (CSR), so that a commercial or organization specific CA may be used to sign
the certificates.</simpara>
<note><simpara>If you choose not to use the <literal>certgen</literal>, the certificates that you obtain must allow for both
<literal>clientAuth</literal> and <literal>serverAuth</literal> if the extended key usage extension is present. The certificates
need to be in PEM format. Although not required, it is highly recommended that the certificate contain
the dns name(s) and/or ip address(es) of the node so that hostname verification may be used.</simpara></note>
<section id="generating-signed-certificates">
<title>Generating Certificates with <literal>certgen</literal><ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/securing-communications/setting-up-ssl.asciidoc">Edit me</ulink></title>
<simpara>The <literal>certgen</literal> tool can be used to generate a CA and signed certificates for your nodes. The tool
can be used interactively:</simpara>
<screen>bin/x-pack/certgen
This tool assists you in the generation of X.509 certificates and certificate
signing requests for use with SSL in the Elastic stack. Depending on the command
line option specified, you may be prompted for the following:

* The path to the output file
    * The output file is a zip file containing the signed certificates and
      private keys for each instance. If a Certificate Authority was generated,
      the certificate and private key will also be included in the output file.
* Information about each instance
    * An instance is any piece of the Elastic Stack that requires a SSL certificate.
      Depending on your configuration, Elasticsearch, Logstash, Kibana, and Beats
      may all require a certificate and private key.
    * The minimum required value for each instance is a name. This can simply be the
      hostname, which will be used as the Common Name of the certificate. A full
      distinguished name may also be used.
    * IP addresses and DNS names are optional. Multiple values can be specified as a
      comma separated string. If no IP addresses or DNS names are provided, you may
      disable hostname verification in your SSL configuration.
* Certificate Authority private key password
    * The password may be left empty if desired.

Let's get started...

Please enter the desired output file [/home/es/config/x-pack/certificate-bundle.zip]:
Enter instance name: node01
Enter name for directories and files [node01]:
Enter IP Addresses for instance (comma-separated if more than one) []: 10.10.0.1
Enter DNS names for instance (comma-separated if more than one) []: node01.mydomain.com,node01
Would you like to specify another instance? Press 'y' to continue entering instance information: y
Enter instance name: node02
Enter name for directories and files [node02]:
Enter IP Addresses for instance (comma-separated if more than one) []: 10.10.0.2
Enter DNS names for instance (comma-separated if more than one) []: node02.mydomain.com
Would you like to specify another instance? Press 'y' to continue entering instance information:
Certificates written to /Users/jmodi/dev/tmp/elasticsearch-5.0.0-alpha5-SNAPSHOT/config/x-pack/certificate-bundle.zip

This file should be properly secured as it contains the private keys for all
instances and the certificate authority.

After unzipping the file, there will be a directory for each instance containing
the certificate and private key. Copy the certificate, key, and CA certificate
to the configuration directory of the Elastic product that they will be used for
and follow the SSL configuration instructions in the product guide.

For client applications, you may only need to copy the CA certificate and
configure the client to trust this certificate.</screen>
<simpara>The usage of <literal>certgen</literal> above generates a zip file with the CA certificate, private key, two signed certificates and keys
in PEM format for <literal>node01</literal> and <literal>node02</literal>.</simpara>
</section>
<section id="generating-csr">
<title>Generating Certificate Signing Requests with <literal>certgen</literal><ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/securing-communications/setting-up-ssl.asciidoc">Edit me</ulink></title>
<simpara>When using a commercial or organization specific CA, the <literal>certgen</literal> tool may be used to generate
certificate signing requests (CSR) for the nodes in your cluster:</simpara>
<screen>bin/x-pack/certgen -csr
This tool assists you in the generation of X.509 certificates and certificate
signing requests for use with SSL in the Elastic stack. Depending on the command
line option specified, you may be prompted for the following:

* The path to the output file
    * The output file is a zip file containing the certificate signing requests
      and private keys for each instance.
* Information about each instance
    * An instance is any piece of the Elastic Stack that requires a SSL certificate.
      Depending on your configuration, Elasticsearch, Logstash, Kibana, and Beats
      may all require a certificate and private key.
    * The minimum required value for each instance is a name. This can simply be the
      hostname, which will be used as the Common Name of the certificate. A full
      distinguished name may also be used.
    * IP addresses and DNS names are optional. Multiple values can be specified as a
      comma separated string. If no IP addresses or DNS names are provided, you may
      disable hostname verification in your SSL configuration.

Let's get started...

Please enter the desired output file [/home/es/config/x-pack/csr-bundle.zip]:
Enter instance name: node01
Enter name for directories and files [node01]:
Enter IP Addresses for instance (comma-separated if more than one) []: 10.10.0.1
Enter DNS names for instance (comma-separated if more than one) []: node01.mydomain.com,node01
Would you like to specify another instance? Press 'y' to continue entering instance information: y
Enter instance name: node02
Enter name for directories and files [node02]:
Enter IP Addresses for instance (comma-separated if more than one) []: 10.10.0.2
Enter DNS names for instance (comma-separated if more than one) []: node02.mydomain.com
Would you like to specify another instance? Press 'y' to continue entering instance information:
Certificate signing requests written to /Users/jmodi/dev/tmp/elasticsearch-5.0.0-alpha5-SNAPSHOT/config/x-pack/csr-bundle.zip

This file should be properly secured as it contains the private keys for all
instances.

After unzipping the file, there will be a directory for each instance containing
the certificate signing request and the private key. Provide the certificate
signing requests to your certificate authority. Once you have received the
signed certificate, copy the signed certificate, key, and CA certificate to the
configuration directory of the Elastic product that they will be used for and
follow the SSL configuration instructions in the product guide.</screen>
<simpara>The usage of <literal>certgen</literal> above generates a zip file with two CSRs and private
keys. The CSRs should be provided to the CA in order to obtain the signed
certificates. The signed certificates will need to be in PEM format in order to
be used.</simpara>
</section>
</section>
<section id="enable-ssl">
<title>Enabling SSL in the Node Configuration<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/securing-communications/setting-up-ssl.asciidoc">Edit me</ulink></title>
<simpara>Once you have the signed certificate, private key, and CA certificate you need to
modify the node configuration to enable SSL.</simpara>
<simpara id="configure-ssl">To enable SSL, make the following changes in <literal>elasticsearch.yml</literal>:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Specify the location of the node&#8217;s keystore and the password(s) needed to
access the node&#8217;s certificate. For example:
</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.ssl.key:                     /home/es/config/x-pack/node01.key <co id="CO13-1"/>
xpack.ssl.certificate:             /home/es/config/x-pack/node01.crt <co id="CO13-2"/>
xpack.ssl.certificate_authorities: [ "/home/es/config/x-pack/ca.crt" ] <co id="CO13-3"/></programlisting>
<calloutlist>
<callout arearefs="CO13-1">
<para>
The full path to the node key file. This must be a location within the
    Elasticsearch configuration directory.
</para>
</callout>
<callout arearefs="CO13-2">
<para>
The full path to the node certificate. This must be a location within the
    Elasticsearch configuration directory.
</para>
</callout>
<callout arearefs="CO13-3">
<para>
An array of paths to the CA certificates that should be trusted. These paths
    must be a location within the Elasticsearch configuration directory.
</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>
Enable SSL on the transport networking layer to ensure that communication
between nodes is encrypted:
</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.security.transport.ssl.enabled: true</programlisting>
</listitem>
<listitem>
<simpara>
Enable SSL on the HTTP layer to ensure that communication between HTTP clients
and the cluster is encrypted:
</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.security.http.ssl.enabled: true</programlisting>
</listitem>
<listitem>
<simpara>
Restart Elasticsearch.
</simpara>
</listitem>
</orderedlist>
<note><simpara>All SSL related node settings that are considered to be highly sensitive
      and therefore are not exposed via the
      <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/cluster-nodes-info.html#cluster-nodes-info">nodes info API</ulink>.</simpara></note>
</section>
</section>
<section id="ciphers">
<title>Enabling Cipher Suites for Stronger Encryption<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/securing-communications/enabling-cipher-suites.asciidoc">Edit me</ulink></title>
<simpara>The TLS and SSL protocols use a cipher suite that determines the strength of
encryption used to protect the data. You may want to increase the strength of
encryption used when using a Oracle JVM; the IcedTea OpenJDK ships without these
restrictions in place. This step is not required to successfully use encrypted
communication.</simpara>
<simpara>The <emphasis>Java Cryptography Extension (JCE) Unlimited Strength Jurisdiction Policy
Files</emphasis> enable the use of additional cipher suites for Java in a separate JAR file
that you need to add to your Java installation. You can download this JAR file
from Oracle&#8217;s <ulink url="http://www.oracle.com/technetwork/java/javase/downloads/index.html">download page</ulink>.
The <emphasis>JCE Unlimited Strength Jurisdiction Policy Files`</emphasis> are required for
encryption with key lengths greater than 128 bits, such as 256-bit AES encryption.</simpara>
<simpara>After installation, all cipher suites in the JCE are available for use. To enable
the use of stronger cipher suites with X-Pack security, configure the <literal>cipher_suites</literal>
parameter. See the <link linkend="ssl-tls-settings">Configuration Parameters for TLS/SSL</link>
section of this document for specific parameter information.</simpara>
<note><simpara>The <emphasis>JCE Unlimited Strength Jurisdiction Policy Files</emphasis> must be installed
      on all nodes in the cluster to establish an improved level of encryption
      strength.</simpara></note>
</section>
<section id="separating-node-client-traffic">
<title>Separating node-to-node and client traffic<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/securing-communications/separating-node-client-traffic.asciidoc">Edit me</ulink></title>
<simpara>Elasticsearch has the feature of so called <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/modules-transport.html#_tcp_transport_profiles">TCP transport profiles</ulink>
that allows it to bind to several ports and addresses. X-Pack security extends on this
functionality to enhance the security of the cluster by enabling the separation
of node-to-node transport traffic from client transport traffic. This is important
if the client transport traffic is not trusted and could potentially be malicious.
To separate the node-to-node traffic from the client traffic, add the following
to <literal>elasticsearch.yml</literal>:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">transport.profiles.client: <co id="CO14-1"/>
  port: 9500-9600 <co id="CO14-2"/>
  shield:
    type: client <co id="CO14-3"/></programlisting>
<calloutlist>
<callout arearefs="CO14-1">
<para>
<literal>client</literal> is the name of this example profile
</para>
</callout>
<callout arearefs="CO14-2">
<para>
The port range that will be used by transport clients to communicate with
    this cluster
</para>
</callout>
<callout arearefs="CO14-3">
<para>
Categorizes the profile as a <literal>client</literal>. This accounts for additional security
    filters by denying request attempts on for internal cluster operations
    (e.g shard level actions and ping requests) from this profile.
</para>
</callout>
</calloutlist>
<simpara>If supported by your environment, an internal network can be used for node-to-node
traffic and public network can be used for client traffic by adding the following
to <literal>elasticsearch.yml</literal>:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">transport.profiles.default.bind_host: 10.0.0.1 <co id="CO15-1"/>
transport.profiles.client.bind_host: 1.1.1.1 <co id="CO15-2"/></programlisting>
<calloutlist>
<callout arearefs="CO15-1">
<para>
The bind address for the network that will be used for node-to-node communication
</para>
</callout>
<callout arearefs="CO15-2">
<para>
The bind address for the network used for client communication
</para>
</callout>
</calloutlist>
<simpara>If separate networks are not available, then <link linkend="ip-filtering">IP Filtering</link> can
be enabled to limit access to the profiles.</simpara>
<simpara>The TCP transport profiles also allow for enabling SSL on a per profile basis.
This is useful if you have a secured network for the node-to-node communication,
but the client is on an unsecured network. To enable SSL on a client profile when
SSL is disabled for node-to-node communication, add the following to
<literal>elasticsearch.yml</literal>:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">transport.profiles.client.xpack.security.ssl.enabled: true <co id="CO16-1"/></programlisting>
<calloutlist>
<callout arearefs="CO16-1">
<para>
This enables SSL on the client profile. The default value for this setting
    is the value of <literal>xpack.security.transport.ssl.enabled</literal>.
</para>
</callout>
</calloutlist>
<simpara>When using SSL for transport, a different set of certificates can also be used
for the client traffic by adding the following to <literal>elasticsearch.yml</literal>:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">transport.profiles.client.xpack.security.ssl.truststore:
  path: /path/to/another/truststore
  password: changeme

transport.profiles.client.xpack.security.ssl.keystore:
  path: /path/to/another/keystore
  password: changeme</programlisting>
<simpara>To change the default behavior that requires certificates for transport clients,
set the following value in the <literal>elasticsearch.yml</literal> file:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">transport.profiles.client.xpack.security.ssl.client_authentication: no</programlisting>
<simpara>This setting keeps certificate authentication active for node-to-node traffic,
but removes the requirement to distribute a signed certificate to transport
clients. Please see the <link linkend="transport-client">Transport Client</link> section.</simpara>
</section>
</chapter>
<chapter id="ip-filtering">
<title>Restricting Connections with IP Filtering<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/using-ip-filtering.asciidoc">Edit me</ulink></title>
<simpara>You can apply IP filtering to application clients, node clients, or transport
clients, in addition to other nodes that are attempting to join the cluster.</simpara>
<simpara>If a node&#8217;s IP address is on the blacklist, X-Pack security will still allow the
connection to Elasticsearch, but it will be dropped immediately, and no requests
will be processed.</simpara>
<note><simpara>Elasticsearch installations are not designed to be publicly accessible
      over the Internet. IP Filtering and the other security capabilities of
      X-Pack security do not change this condition.</simpara></note>
<bridgehead id="_enabling_ip_filtering" renderas="sect2">Enabling IP filtering<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/using-ip-filtering.asciidoc">Edit me</ulink></bridgehead>
<simpara>X-Pack security features an access control feature that allows or rejects hosts,
domains, or subnets.</simpara>
<simpara>You configure IP filtering by specifying the <literal>xpack.security.transport.filter.allow</literal> and
<literal>xpack.security.transport.filter.deny</literal> settings in in <literal>elasticsearch.yml</literal>. Allow rules
take precedence over the deny rules.</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.security.transport.filter.allow: "192.168.0.1"
xpack.security.transport.filter.deny: "192.168.0.0/24"</programlisting>
<simpara>The <literal>_all</literal> keyword can be used to deny all connections that are not explicitly
allowed.</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.security.transport.filter.allow: [ "192.168.0.1", "192.168.0.2", "192.168.0.3", "192.168.0.4" ]
xpack.security.transport.filter.deny: _all</programlisting>
<simpara>IP filtering configuration also support IPv6 addresses.</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.security.transport.filter.allow: "2001:0db8:1234::/48"
xpack.security.transport.filter.deny: "1234:0db8:85a3:0000:0000:8a2e:0370:7334"</programlisting>
<simpara>You can also filter by hostnames when DNS lookups are available.</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.security.transport.filter.allow: localhost
xpack.security.transport.filter.deny: '*.google.com'</programlisting>
<bridgehead id="_disabling_ip_filtering" renderas="sect2">Disabling IP Filtering<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/using-ip-filtering.asciidoc">Edit me</ulink></bridgehead>
<simpara>Disabling IP filtering can slightly improve performance under some conditions.
To disable IP filtering entirely, set the value of the <literal>xpack.security.transport.filter.enabled</literal>
setting in the <literal>elasticsearch.yml</literal> configuration file to <literal>false</literal>.</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.security.transport.filter.enabled: false</programlisting>
<simpara>You can also disable IP filtering for the transport protocol but enable it for
HTTP only.</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.security.transport.filter.enabled: false
xpack.security.http.filter.enabled: true</programlisting>
<bridgehead id="_specifying_tcp_transport_profiles" renderas="sect2">Specifying TCP transport profiles<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/using-ip-filtering.asciidoc">Edit me</ulink></bridgehead>
<simpara><ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/modules-transport.html#_tcp_transport_profiles">TCP transport profiles</ulink>
enable Elasticsearch to bind on multiple hosts. X-Pack security enables you to apply
different IP filtering on different profiles.</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.security.transport.filter.allow: 172.16.0.0/24
xpack.security.transport.filter.deny: _all
transport.profiles.client.xpack.security.filter.allow: 192.168.0.0/24
transport.profiles.client.xpack.security.filter.deny: _all</programlisting>
<note><simpara>When you do not specify a profile, <literal>default</literal> is used automatically.</simpara></note>
<bridgehead id="_http_filtering" renderas="sect2">HTTP Filtering<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/using-ip-filtering.asciidoc">Edit me</ulink></bridgehead>
<simpara>You may want to have different IP filtering for the transport and HTTP protocols.</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.security.transport.filter.allow: localhost
xpack.security.transport.filter.deny: '*.google.com'
xpack.security.http.filter.allow: 172.16.0.0/16
xpack.security.http.filter.deny: _all</programlisting>
<bridgehead id="dynamic-ip-filtering" renderas="sect3">Dynamically updating ip filter settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/using-ip-filtering.asciidoc">Edit me</ulink></bridgehead>
<simpara>In case of running in an environment with highly dynamic IP addresses like cloud
based hosting, it is very hard to know the IP addresses upfront when provisioning
a machine. Instead of changing the configuration file and restarting the node,
you can use the <emphasis>Cluster Update Settings API</emphasis>. For example:</simpara>
<programlisting language="js" linenumbering="unnumbered">curl -XPUT localhost:9200/_cluster/settings -d '{
    "persistent" : {
        "xpack.security.transport.filter.allow" : "172.16.0.0/24"
    }
}'</programlisting>
<simpara>You can also dynamically disable filtering completely:</simpara>
<programlisting language="js" linenumbering="unnumbered">curl -XPUT localhost:9200/_cluster/settings -d '{
    "persistent" : {
        "xpack.security.transport.filter.enabled" : false
    }
}'</programlisting>
<note><simpara>In order to avoid locking yourself out of the cluster, the default bound
      transport address will never be denied. This means you can always SSH into
      a system and use curl to apply changes.</simpara></note>
</chapter>
<chapter id="tribe-clients-integrations">
<title>Tribe, Clients and Integrations<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/tribe-clients-integrations.asciidoc">Edit me</ulink></title>
<simpara>When using a <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/modules-tribe.html">Tribe Nodes</ulink> you need to take extra steps to secure its communication
with the connected clusters</simpara>
<itemizedlist>
<listitem>
<simpara>
<link linkend="tribe-node-configuring">Tribe Node Security</link>
</simpara>
</listitem>
</itemizedlist>
<simpara>You will need to update the configuration for several clients to work with a
secured cluster:</simpara>
<itemizedlist>
<listitem>
<simpara>
<link linkend="java-clients">Java Clients</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="http-clients">HTTP Clients</link>
</simpara>
</listitem>
</itemizedlist>
<simpara>X-Pack security enables you to secure you Elasticsearch cluster. But Elasticsearch
itself is only one product within the Elastic Stack. It is often the case that
other products in the stack are connected to the cluster and therefore need to
be secured as well, or at least communicate with the cluster in a secured way:</simpara>
<itemizedlist>
<listitem>
<simpara>
<link linkend="hadoop">Apache Hadoop</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="logstash">Logstash</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="kibana">Kibana</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="secure-monitoring">Monitoring</link>
</simpara>
</listitem>
</itemizedlist>
<section id="tribe-node-configuring">
<title>Tribe Nodes and Security<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/tribe-clients-integrations/tribe.asciidoc">Edit me</ulink></title>
<simpara><ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/modules-tribe.html">Tribe nodes</ulink> act as a federated client across multiple
clusters. When using tribe nodes with secured clusters, all clusters must have
X-Pack security enabled and share the same security configuration (users, roles,
user-role mappings, SSL/TLS CA). The tribe node itself also must be configured
to grant access to actions and indices on all of the connected clusters, as
security checks on incoming requests are primarily done on the tribe node
itself.</simpara>
<important><simpara>Kibana 5.0 does not support tribe nodes. We are working on a
solution that addresses this limitation.</simpara></important>
<simpara>To use a tribe node with secured clusters:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Install X-Pack on the tribe node and every node in each connected cluster.
</simpara>
</listitem>
<listitem>
<simpara>
Enable <link linkend="enable-message-authentication">message authentication</link> globally.
Generate a system key on one node and copy it to the tribe node and every other
node in each of the connected clusters.
</simpara>
<important><simpara>For message authentication to work properly across multiple clusters,
            the tribe node and all of the connected clusters must share the same
            system key. X-Pack security reads the system key from <literal>CONFIG_DIR/x-pack/system_key</literal>.</simpara></important>
</listitem>
<listitem>
<simpara>
Enable encryption globally. To encrypt communications, you must enable
<link linkend="ssl-tls">enable SSL/TLS</link> on every node.
</simpara>
<tip><simpara>To simplify SSL/TLS configuration, use the same certificate authority to
      generate certificates for all connected clusters.</simpara></tip>
</listitem>
<listitem>
<simpara>
Configure the tribe in the tribe node&#8217;s <literal>elasticsearch.yml</literal> file. You must
specify each cluster that is a part of the tribe and configure discovery and
encryption settings per cluster. For example, the following configuration adds
two clusters to the tribe:
</simpara>
<programlisting language="yml" linenumbering="unnumbered">tribe:
  on_conflict: prefer_cluster1 <co id="CO17-1"/>
  c1: <co id="CO17-2"/>
    cluster.name: cluster1
    discovery.zen.ping.unicast.hosts: [ "cluster1-node1:9300", "cluster1-node2:9300"]
    xpack.ssl.key: /home/es/config/x-pack/es-tribe-01.key
    xpack.ssl.certificate: /home/es/config/x-pack/es-tribe-01.crt
    xpack.ssl.certificate_authorities: [ "/home/es/config/x-pack/ca.crt" ]
    xpack.security.transport.ssl.enabled: true
    xpack.security.http.ssl.enabled: true
  c2:
    cluster.name: cluster2
    discovery.zen.ping.unicast.hosts: [ "cluster2-node1:9300", "cluster2-node2:9300"]
    xpack.ssl.key: /home/es/config/x-pack/es-tribe-01.key
    xpack.ssl.certificate: /home/es/config/x-pack/es-tribe-01.crt
    xpack.ssl.certificate_authorities: [ "/home/es/config/x-pack/ca.crt" ]
    xpack.security.transport.ssl.enabled: true
    xpack.security.http.ssl.enabled: true</programlisting>
<calloutlist>
<callout arearefs="CO17-1">
<para>
Results are returned from the preferred cluster if the named index exists
    in multiple clusters. A preference is <emphasis role="strong">required</emphasis> when using X-Pack security on
    a tribe node.
</para>
</callout>
<callout arearefs="CO17-2">
<para>
An arbitrary name that represents the connection to the cluster.
</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>
Configure the same index privileges for your users on all nodes, including the
tribe node. The nodes in each cluster must grant access to indices in other
connected clusters as well as their own.
</simpara>
<simpara>For example, let&#8217;s assume <literal>cluster1</literal> and <literal>cluster2</literal> each have a indices <literal>index1</literal>
and <literal>index2</literal>. To enable a user to submit a request through the tribe node to
search both clusters:</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>
On the tribe node and both clusters, <link linkend="defining-roles">define a <literal>tribe_user</literal> role</link>
that has read access to <literal>index1</literal> and <literal>index2</literal>:
</simpara>
<programlisting language="yaml" linenumbering="unnumbered">tribe_user:
  indices:
    'index*': search</programlisting>
</listitem>
<listitem>
<simpara>
Assign the <literal>tribe_user</literal> role to a user on the tribe node and both clusters.
For example, run the following command on each node to create <literal>my_tribe_user</literal>
and assign the <literal>tribe_user</literal> role:
</simpara>
<programlisting language="shell" linenumbering="unnumbered">./bin/shield/users useradd my_tribe_user -p password -r tribe_user</programlisting>
<note><simpara>Each cluster needs to have its own users with admin privileges.
      You cannot perform administration tasks such as create index through
      the tribe node, you must send the request directly to the appropriate
      cluster.</simpara></note>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>
To enable selected users to retrieve merged cluster state information
for the tribe from the tribe node, grant them the cluster
<link linkend="privileges-list-cluster"><literal>monitor</literal> privilege</link> on the tribe node. For example,
you could create a <literal>tribe_monitor</literal> role that assigns the <literal>monitor</literal> privilege:
</simpara>
<programlisting language="yaml" linenumbering="unnumbered">tribe_monitor:
  cluster: monitor</programlisting>
</listitem>
<listitem>
<simpara>
Start the tribe node. If you&#8217;ve made configuration changes to the nodes in the
connected clusters, they also need to be restarted.
</simpara>
</listitem>
</orderedlist>
</section>
<section id="java-clients">
<title>Java Client and Security<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/tribe-clients-integrations/java.asciidoc">Edit me</ulink></title>
<simpara>X-Pack security supports the Java <ulink url="http://www.elastic.co/guide/en/elasticsearch/client/java-api/current/transport-client.html">transport client</ulink> for Elasticsearch.
The transport client uses the same transport protocol that the cluster nodes use
for inter-node communication. It is very efficient as it does not have to marshall
and unmarshall JSON requests like a typical REST client.</simpara>
<note><simpara>Using the Java Node Client with secured clusters is not recommended or
      supported.</simpara></note>
<bridgehead id="transport-client" renderas="sect3">Configuring the Transport Client to work with a Secured Cluster<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/tribe-clients-integrations/java.asciidoc">Edit me</ulink></bridgehead>
<simpara>To use the transport client with a secured cluster, you need to:</simpara>
<orderedlist id="java-transport-client-role" numeration="arabic">
<listitem>
<simpara>
Configure a user with the privileges required to start the transport client.
A default <literal>transport_client</literal> role is built-in to X-Pack that grants the
appropriate cluster permissions for the transport client to work with the secured
cluster. The transport client uses the <emphasis>Nodes Info API</emphasis> to fetch information about
the nodes in the cluster.
</simpara>
</listitem>
<listitem>
<simpara>
Add the X-Pack transport JAR file to your CLASSPATH. You can download the X-Pack
distribution and extract the JAR file manually or you can get it from the
<ulink url="https://artifacts.elastic.co/maven/org/elasticsearch/client/x-pack-transport/5.0.1/x-pack-transport-5.0.1.jar">Elasticsearch Maven repository</ulink>.
</simpara>
<simpara>If you are using Maven, you need to add the X-Pack JAR file as a dependency in
your project&#8217;s <literal>pom.xml</literal> file:</simpara>
<programlisting language="xml" linenumbering="unnumbered">&lt;project ...&gt;

   &lt;repositories&gt;
      &lt;!-- add the elasticsearch repo --&gt;
      &lt;repository&gt;
         &lt;id&gt;elasticsearch-releases&lt;/id&gt;
         &lt;url&gt;https://artifacts.elastic.co/maven&lt;/url&gt;
         &lt;releases&gt;
            &lt;enabled&gt;true&lt;/enabled&gt;
         &lt;/releases&gt;
         &lt;snapshots&gt;
            &lt;enabled&gt;false&lt;/enabled&gt;
         &lt;/snapshots&gt;
      &lt;/repository&gt;
      ...
   &lt;/repositories&gt;
   ...

   &lt;dependencies&gt;
      &lt;!-- add the x-pack jar as a dependency --&gt;
      &lt;dependency&gt;
         &lt;groupId&gt;org.elasticsearch.client&lt;/groupId&gt;
         &lt;artifactId&gt;x-pack-transport&lt;/artifactId&gt;
         &lt;version&gt;5.0.0&lt;/version&gt;
      &lt;/dependency&gt;
      ...
   &lt;/dependencies&gt;
   ...

 &lt;/project&gt;</programlisting>
<simpara>If you are using Gradle, you need to add the X-Pack JAR file as a dependency in
your <literal>build.gradle</literal> file:</simpara>
<programlisting language="groovy" linenumbering="unnumbered">repositories {
  /* ... Any other repositories ... */

  // Add the Elasticsearch Maven Repository
  maven {
    url "https://artifacts.elastic.co/maven"
  }
}

dependencies {
  compile "org.elasticsearch.client:x-pack-transport:5.0.0"

  /* ... */
}</programlisting>
</listitem>
<listitem>
<simpara>
Set up the transport client. At a minimum, you must configure <literal>xpack.security.user</literal> to
include the name and password of your transport client user in your requests. The
following snippet configures the user credentials globally&#8212;every request
submitted with this client includes the <literal>transport_client_user</literal> credentials in
its headers.
</simpara>
<programlisting language="java" linenumbering="unnumbered">import org.elasticsearch.xpack.client.PreBuiltXPackTransportClient;
...

TransportClient client = new PreBuiltXPackTransportClient(Settings.builder()
        .put("cluster.name", "myClusterName")
        .put("xpack.security.user", "transport_client_user:changeme")
        ...
        .build())
    .addTransportAddress(new InetSocketTransportAddress("localhost", 9300))
    .addTransportAddress(new InetSocketTransportAddress("localhost", 9301));</programlisting>
<warning><simpara>If you configure a transport client without SSL, passwords are sent in
          clear text.</simpara></warning>
<simpara>You can also add an <literal>Authorization</literal> header to each request. If you&#8217;ve configured
global authorization credentials, the <literal>Authorization</literal> header overrides the global
authentication credentials. This is useful when an application has multiple users
who access Elasticsearch using the same client. You can set the global token to
a user that only has the <literal>transport_client</literal> role, and add the <literal>transport_client</literal>
role to the individual users.</simpara>
<simpara>For example, the following snippet adds the <literal>Authorization</literal> header to a search
request:</simpara>
<programlisting language="java" linenumbering="unnumbered">import org.elasticsearch.common.settings.Settings;
import org.elasticsearch.common.transport.InetSocketTransportAddress;
import org.elasticsearch.xpack.security.authc.support.SecuredString;
import org.elasticsearch.xpack.client.PreBuiltXPackTransportClient;

import static org.elasticsearch.xpack.security.authc.support.UsernamePasswordToken.basicAuthHeaderValue;
...

TransportClient client = new PreBuiltXPackTransportClient(Settings.builder()
        .put("cluster.name", "myClusterName")
        .put("xpack.security.user", "transport_client_user:changeme")
        ...
        .build())
    .build()
    .addTransportAddress(new InetSocketTransportAddress(InetAddress.getByName("localhost"), 9300))
    .addTransportAddress(new InetSocketTransportAddress(InetAddress.getByName("localhost"), 9301))

String token = basicAuthHeaderValue("test_user", new SecuredString("changeme".toCharArray()));

client.filterWithHeader(Collections.singletonMap("Authorization", token))
    .prepareSearch().get();</programlisting>
</listitem>
<listitem>
<simpara>
Enable SSL to authenticate clients and encrypt communications. To enable SSL,
you need to:
</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>
Configure the paths to the client&#8217;s key and certificate in addition to the certificate authorities.
Client authentication requires every client to have a certification signed by a trusted CA.
</simpara>
<note><simpara>Client authentication is enabled by default. For information about
      disabling client authentication, see <link linkend="disabling-client-auth">Disabling Client Authentication</link>.</simpara></note>
<programlisting language="java" linenumbering="unnumbered">import org.elasticsearch.xpack.client.PreBuiltXPackTransportClient;
...

TransportClient client = new PreBuiltXPackTransportClient(Settings.builder()
        .put("cluster.name", "myClusterName")
        .put("xpack.security.user", "transport_client_user:changeme")
        .put("xpack.ssl.key", "/path/to/client.key")
        .put("xpack.ssl.certificate", "/path/to/client.crt")
        .put("xpack.ssl.certificate_authorities", "/path/to/ca.crt")
        ...
        .build());</programlisting>
</listitem>
</orderedlist>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>
Enable the SSL transport by setting <literal>xpack.security.transport.ssl.enabled</literal> to <literal>true</literal> in the
client configuration.
</simpara>
<programlisting language="java" linenumbering="unnumbered">import org.elasticsearch.xpack.client.PreBuiltXPackTransportClient;
...

TransportClient client = new PreBuiltXPackTransportClient(Settings.builder()
        .put("cluster.name", "myClusterName")
        .put("xpack.security.user", "transport_client_user:changeme")
        .put("xpack.ssl.key", "/path/to/client.key")
        .put("xpack.ssl.certificate", "/path/to/client.crt")
        .put("xpack.ssl.certificate_authorities", "/path/to/ca.crt")
        .put("xpack.security.transport.ssl.enabled", "true")
        ...
        .build())
    .addTransportAddress(new InetSocketTransportAddress(InetAddress.getByName("localhost"), 9300))
    .addTransportAddress(new InetSocketTransportAddress(InetAddress.getByName("localhost"), 9301))</programlisting>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
<bridgehead id="disabling-client-auth" renderas="sect4">Disabling Client Authentication<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/tribe-clients-integrations/java.asciidoc">Edit me</ulink></bridgehead>
<simpara>If you want to disable client authentication, you can use a client-specific
transport protocol. For more information see <link linkend="separating-node-client-traffic">Separating Node to Node and Client Traffic</link>.</simpara>
<simpara>If you are not using client authentication and sign the Elasticsearch node
certificates with your own CA, you need to provide the path to the CA
certificate in your client configuration.</simpara>
<programlisting language="java" linenumbering="unnumbered">import org.elasticsearch.xpack.client.PreBuiltXPackTransportClient;
...

TransportClient client = new PreBuiltXPackTransportClient(Settings.builder()
        .put("cluster.name", "myClusterName")
        .put("xpack.security.user", "test_user:changeme")
        .put("xpack.ssl.certificate_authorities", "/path/to/ca.crt")
        .put("xpack.security.transport.ssl.enabled", "true")
        ...
        .build())
    .addTransportAddress(new InetSocketTransportAddress("localhost", 9300))
    .addTransportAddress(new InetSocketTransportAddress("localhost", 9301));</programlisting>
<note><simpara>If you are using a public CA that is already trusted by the Java runtime,
      you to not need to set the <literal>xpack.ssl.certificate_authorities</literal>.</simpara></note>
<bridgehead id="connecting-anonymously" renderas="sect4">Connecting Anonymously<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/tribe-clients-integrations/java.asciidoc">Edit me</ulink></bridgehead>
<simpara>To enable the transport client to connect anonymously, you must assign the
anonymous user the privileges defined in the <link linkend="java-transport-client-role">transport_client</link>
role. Anonymous access must also be enabled, of course. For more information,
see <link linkend="anonymous-access">Enabling Anonymous Access</link>.</simpara>
<bridgehead id="security-client" renderas="sect3">Security Client<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/tribe-clients-integrations/java.asciidoc">Edit me</ulink></bridgehead>
<simpara>X-Pack security exposes its own API through the <literal>SecurityClient</literal> class. To get a hold
of a <literal>SecurityClient</literal> you&#8217;ll first need to create the <literal>XPackClient</literal>, which is a
wrapper around the existing Elasticsearch clients (any client class implementing
<literal>org.elasticsearch.client.Client</literal>).</simpara>
<simpara>The following example shows how you can clear X-Pack security&#8217;s realm caches using
the <literal>SecurityClient</literal>:</simpara>
<programlisting language="java" linenumbering="unnumbered">Client client = ... // create the transport client

XPackClient xpackClient = new XPackClient(client);
SecurityClient securityClient = xpackClient.security();
ClearRealmCacheResponse response = securityClient.authc().prepareClearRealmCache()
    .realms("ldap1", "ad1") <co id="CO18-1"/>
    .usernames("rdeniro")
    .get();</programlisting>
<calloutlist>
<callout arearefs="CO18-1">
<para>
Clears the <literal>ldap1</literal> and <literal>ad1</literal> realm caches for the <literal>rdeniro</literal> user.
</para>
</callout>
</calloutlist>
</section>
<section id="http-clients">
<title>HTTP/REST Clients and Security<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/tribe-clients-integrations/http.asciidoc">Edit me</ulink></title>
<simpara>X-Pack security works with standard HTTP <ulink url="https://en.wikipedia.org/wiki/Basic_access_authentication">basic authentication</ulink>
headers to authenticate users. Since Elasticsearch is stateless, this header must
be sent with every request:</simpara>
<programlisting language="shell" linenumbering="unnumbered">Authorization: Basic &lt;TOKEN&gt; <co id="CO19-1"/></programlisting>
<calloutlist>
<callout arearefs="CO19-1">
<para>
The <literal>&lt;TOKEN&gt;</literal> is computed as <literal>base64(USERNAME:PASSWORD)</literal>
</para>
</callout>
</calloutlist>
<bridgehead id="_client_examples" renderas="sect3">Client examples<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/tribe-clients-integrations/http.asciidoc">Edit me</ulink></bridgehead>
<simpara>This example uses <literal>curl</literal> without basic auth to create an index:</simpara>
<programlisting language="shell" linenumbering="unnumbered">curl -XPUT 'localhost:9200/idx'</programlisting>
<programlisting language="js" linenumbering="unnumbered">{
  "error":  "AuthenticationException[Missing authentication token]",
  "status": 401
}</programlisting>
<simpara>Since no user is associated with the request above, an authentication error is
returned. Now we&#8217;ll use <literal>curl</literal> with basic auth to create an index as the
<literal>rdeniro</literal> user:</simpara>
<programlisting language="shell" linenumbering="unnumbered">curl --user rdeniro:taxidriver -XPUT 'localhost:9200/idx'</programlisting>
<programlisting language="js" linenumbering="unnumbered">{
  "acknowledged": true
}</programlisting>
<bridgehead id="_client_libraries_over_http" renderas="sect3">Client Libraries over HTTP<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/tribe-clients-integrations/http.asciidoc">Edit me</ulink></bridgehead>
<simpara>For more information about how to use X-Pack security with the language specific clients
please refer to
<ulink url="https://github.com/elasticsearch/elasticsearch-ruby/tree/master/elasticsearch-transport#authentication">Ruby</ulink>,
<ulink url="http://elasticsearch-py.readthedocs.org/en/master/#ssl-and-authentication">Python</ulink>,
<ulink url="https://metacpan.org/pod/Search::Elasticsearch::Role::Cxn::HTTP#CONFIGURATION">Perl</ulink>,
<ulink url="http://www.elastic.co/guide/en/elasticsearch/client/php-api/current/_security.html">PHP</ulink>,
<ulink url="http://nest.azurewebsites.net/elasticsearch-net/security.html">.NET</ulink>,
<ulink url="http://www.elastic.co/guide/en/elasticsearch/client/javascript-api/current/auth-reference.html">Javascript</ulink></simpara>
</section>
<section id="hadoop">
<title>ES-Hadoop and Security<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/tribe-clients-integrations/hadoop.asciidoc">Edit me</ulink></title>
<simpara>Elasticsearch for Apache Hadoop ("ES-Hadoop") is capable of using HTTP basic and
PKI authentication and/or TLS/SSL when accessing an Elasticsearch cluster. For
full details please refer to the ES-Hadoop documentation, in particular the
<literal>Security</literal> section.</simpara>
<simpara>For authentication purposes, select the user for your ES-Hadoop client (for
maintenance purposes it is best to create a dedicated user). Then, assign that
user to a role with the privileges required by your Hadoop/Spark/Storm job.
Configure ES-Hadoop to use the user name and password through the
<literal>es.net.http.auth.user</literal> and <literal>es.net.http.auth.pass</literal> properties.</simpara>
<simpara>If PKI authentication is enabled, setup the appropriate <literal>keystore</literal> and <literal>truststore</literal>
instead through <literal>es.net.ssl.keystore.location</literal> and <literal>es.net.truststore.location</literal>
(and their respective <literal>.pass</literal> properties to specify the password).</simpara>
<simpara>For secured transport, enable SSL/TLS through the <literal>es.net.ssl</literal> property by
setting it to <literal>true</literal>. Depending on your SSL configuration (keystore, truststore, etc&#8230;)
you might need to set other parameters as well - please refer to the
<ulink url="http://www.elastic.co/guide/en/elasticsearch/hadoop/current/configuration.html">ES-Hadoop</ulink> documentation,
specifically the <literal>Configuration</literal> and <literal>Security</literal> chapters.</simpara>
</section>
<section id="logstash">
<title>Logstash and Security<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/tribe-clients-integrations/logstash.asciidoc">Edit me</ulink></title>
<simpara>The Logstash Elasticsearch plugins (
<ulink url="http://www.elastic.co/guide/en/logstash/5.0/plugins-outputs-elasticsearch.html">output</ulink>,
<ulink url="http://www.elastic.co/guide/en/logstash/5.0/plugins-inputs-elasticsearch.html">input</ulink>
and <ulink url="http://www.elastic.co/guide/en/logstash/5.0/plugins-filters-elasticsearch.html">filter</ulink>)
support authentication and encryption over HTTP.</simpara>
<simpara>To use Logstash with a secured cluster, you need to configure authentication
credentials for Logstash. Logstash throws an exception and the processing
pipeline is halted if authentication fails.</simpara>
<simpara>If encryption is enabled on the cluster, you also need to enable SSL in the
Logstash configuration.</simpara>
<simpara>In addition to configuring authentication credentials for Logstash, you need
to grant authorized users permission to access the Logstash indices.</simpara>
<bridgehead id="ls-http-auth-basic" renderas="sect3">Configuring Logstash to use Basic Authentication<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/tribe-clients-integrations/logstash.asciidoc">Edit me</ulink></bridgehead>
<simpara>Logstash needs to be able to manage index templates, create indices,
and write and delete documents in the indices it creates.</simpara>
<simpara>To set up authentication credentials for Logstash:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Create a <literal>logstash_writer</literal> role that has the <literal>manage_index_templates</literal> cluster
privilege, and the <literal>write</literal>, <literal>delete</literal>, and <literal>create_index</literal> privileges  for the
Logstash indices. You can create roles from the <emphasis role="strong">Management &gt; Roles</emphasis> UI in
Kibana or through the <literal>role</literal> API:
</simpara>
<programlisting language="sh" linenumbering="unnumbered">POST _xpack/security/role/logstash_writer
{
  "cluster": ["manage_index_templates", "monitor"],
  "indices": [
    {
      "names": [ "logstash-*" ], <co id="CO20-1"/>
      "privileges": ["write","delete","create_index"]
    }
  ]
}</programlisting>
<calloutlist>
<callout arearefs="CO20-1">
<para>
If you use a custom Logstash index pattern, specify that pattern
instead of the default <literal>logstash-*</literal> pattern.
</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>
Create a <literal>logstash_internal</literal> user and assign it the <literal>logstash_writer</literal> role.
You can create users from the <emphasis role="strong">Management &gt; Users</emphasis> UI in Kibana or through
the <literal>user</literal> API:
</simpara>
<programlisting language="sh" linenumbering="unnumbered">POST /_xpack/security/user/logstash_internal
{
  "password" : "changeme",
  "roles" : [ "logstash_writer"],
  "full_name" : "Internal Logstash User"
}</programlisting>
</listitem>
<listitem>
<simpara>
Configure Logstash to authenticate as the <literal>logstash_internal</literal> user you just
created. You configure credentials separately for each of the Elasticsearch
plugins in your Logstash <literal>.conf</literal> file. For example:
</simpara>
<programlisting language="js" linenumbering="unnumbered">input {
    ...
    user =&gt; logstash_internal
    password =&gt; changeme
  }
filter {
    ...
    user =&gt; logstash_internal
    password =&gt; changeme
  }
output {
  elasticsearch {
    ...
    user =&gt; logstash_internal
    password =&gt; changeme
  }</programlisting>
</listitem>
</orderedlist>
<bridgehead id="ls-user-access" renderas="sect3">Granting Users Access to the Logstash Indices<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/tribe-clients-integrations/logstash.asciidoc">Edit me</ulink></bridgehead>
<simpara>To access the indices Logstash creates, users need the <literal>read</literal> and
<literal>view_index_metadata</literal> privileges:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Create a <literal>logstash_reader</literal> role that has the <literal>read and `view_index_metadata</literal>
privileges  for the Logstash indices. You can create roles from the
<emphasis role="strong">Management &gt; Roles</emphasis> UI in Kibana or through the <literal>role</literal> API:
</simpara>
<programlisting language="sh" linenumbering="unnumbered">POST _xpack/security/role/logstash_reader
{
  "indices": [
    {
      "names": [ "logstash-*" ], <co id="CO21-1"/>
      "privileges": ["read","view_index_metadata"]
    }
  ]
}</programlisting>
<calloutlist>
<callout arearefs="CO21-1">
<para>
If you use a custom Logstash index pattern, specify that pattern
instead of the default <literal>logstash-*</literal> pattern.
</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>
Assign your Logstash users the <literal>logstash_reader</literal> role. You can create
and manage users from the <emphasis role="strong">Management &gt; Users</emphasis> UI in Kibana or through
the <literal>user</literal> API:
</simpara>
<programlisting language="sh" linenumbering="unnumbered">POST /_xpack/security/user/logstash_user
{
  "password" : "changeme",
  "roles" : [ "logstash_reader"],
  "full_name" : "Kibana User"
}</programlisting>
</listitem>
</orderedlist>
<bridgehead id="ls-http-auth-pki" renderas="sect4">Configuring the elasticsearch Output to use PKI Authentication<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/tribe-clients-integrations/logstash.asciidoc">Edit me</ulink></bridgehead>
<simpara>The <literal>elasticsearch</literal> output supports PKI authentication. To use an X.509
client-certificate for authentication, you configure the <literal>keystore</literal> and
<literal>keystore_password</literal> options in your Logstash <literal>.conf</literal> file:</simpara>
<programlisting language="js" linenumbering="unnumbered">output {
  elasticsearch {
    ...
    keystore =&gt; /path/to/keystore.jks
    keystore_password =&gt; realpassword
    truststore =&gt;  /path/to/truststore.jks <co id="CO22-1"/>
    truststore_password =&gt;  realpassword
  }
}</programlisting>
<calloutlist>
<callout arearefs="CO22-1">
<para>
If you use a separate truststore, the truststore path and password are
also required.
</para>
</callout>
</calloutlist>
<bridgehead id="ls-http-ssl" renderas="sect4">Configuring Logstash to use TLS Encryption<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/tribe-clients-integrations/logstash.asciidoc">Edit me</ulink></bridgehead>
<simpara>If TLS encryption is enabled on the Elasticsearch cluster, you need to
configure the <literal>ssl</literal> and <literal>cacert</literal> options in your Logstash <literal>.conf</literal> file:</simpara>
<programlisting language="js" linenumbering="unnumbered">output {
  elasticsearch {
    ...
    ssl =&gt; true
    cacert =&gt; '/path/to/cert.pem' <co id="CO23-1"/>
  }
}</programlisting>
<calloutlist>
<callout arearefs="CO23-1">
<para>
The path to the local <literal>.pem</literal> file that contains the Certificate
    Authority&#8217;s certificate.
</para>
</callout>
</calloutlist>
</section>
<section id="beats">
<title>Beats and Security<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/tribe-clients-integrations/beats.asciidoc">Edit me</ulink></title>
<simpara>To send data to a secured cluster through the <literal>elasticsearch</literal> output,
a Beat needs to authenticate as a user who can manage index templates,
monitor the cluster, create indices, and read, and write to the indices
it creates.</simpara>
<simpara>If encryption is enabled on the cluster, you also need to enable HTTPS in the
Beat configuration.</simpara>
<simpara>In addition to configuring authentication credentials for the Beat itself, you
need to grant authorized users permission to access the indices it creates.</simpara>
<bridgehead id="beats-basic-auth" renderas="sect3">Configuring Authentication Credentials for a Beat<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/tribe-clients-integrations/beats.asciidoc">Edit me</ulink></bridgehead>
<simpara>When sending data to a secured cluster through the <literal>elasticsearch</literal>
output, a Beat must either provide basic authentication credentials
or present a client certificate.</simpara>
<simpara>To configure authentication credentials for a Beat:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Create a role that has the <literal>manage_index_templates</literal> and
<literal>monitor</literal> cluster privileges, and <literal>read</literal>, <literal>write</literal>, and <literal>create_index</literal>
privileges for the indices the Beat creates. You can create roles from the
<emphasis role="strong">Management / Roles</emphasis> UI in Kibana or through the <literal>role</literal> API.
For example, the following request creates a <literal>packetbeat_writer</literal> role:
</simpara>
<programlisting language="sh" linenumbering="unnumbered">POST _xpack/security/role/packetbeat_writer
{
  "cluster": ["manage_index_templates", "monitor"],
  "indices": [
    {
      "names": [ "packetbeat-*" ], <co id="CO24-1"/>
      "privileges": ["read","write","create_index"]
    }
  ]
}</programlisting>
<calloutlist>
<callout arearefs="CO24-1">
<para>
If you use a custom Packetbeat index pattern, specify that pattern
instead of the default <literal>packetbeat-*</literal> pattern.
</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>
Assign the writer role to the user the Beat is going to use to
connect to Elasticsearch:
</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>
To authenticate as a native user, create a user for the Beat
to use internally and assign it the writer role. You can create
users from the <emphasis role="strong">Management / Users</emphasis> UI in Kibana or through the
<literal>user</literal> API. For example, the following request creates a
<literal>packetbeat_internal</literal> user that has the <literal>packetbeat_writer</literal> role:
</simpara>
<programlisting language="sh" linenumbering="unnumbered">POST /_xpack/security/user/packetbeat_internal
{
  "password" : "changeme",
  "roles" : [ "packetbeat_writer"],
  "full_name" : "Internal Packetbeat User"
}</programlisting>
</listitem>
<listitem>
<simpara>
To authenticate using PKI authentication, assign the writer role
to the internal Beat user in the <link linkend="mapping-roles"><literal>role_mapping.yml</literal></link>
configuration file. Specify the user by the distinguished name that
appears in its certificate.
</simpara>
<programlisting language="yaml" linenumbering="unnumbered">packetbeat_writer:
  - "cn=Internal Packetbeat User,ou=example,o=com"</programlisting>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>
Configure authentication credentials for the <literal>elasticsearch</literal> output
in the Beat configuration file:
</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>
To use basic authentication, configure the <literal>username</literal> and <literal>password</literal>
settings. For example, the following Packetbeat output configuration
uses the native <literal>packetbeat_internal</literal> user to connect to Elasticsearch:
</simpara>
<programlisting language="js" linenumbering="unnumbered">output.elasticsearch:
    hosts: ["localhost:9200"]
    index: "packetbeat"
    username: "packetbeat_internal"
    password: "changeme"</programlisting>
</listitem>
<listitem>
<simpara>
To use PKI authentication, configure the <literal>certificate</literal> and
<literal>key</literal> settings:
</simpara>
<programlisting language="js" linenumbering="unnumbered">output.elasticsearch:
    hosts: ["localhost:9200"]
    index: "packetbeat"
    ssl.certificate: "/etc/pki/client/cert.pem" <co id="CO25-1"/>
    ssl.key: "/etc/pki/client/cert.key"</programlisting>
<calloutlist>
<callout arearefs="CO25-1">
<para>
The distinguished name (DN) in the certificate must be mapped to
the writer role in the <literal>role_mapping.yml</literal> configuration file on each
node in the Elasticsearch cluster.
</para>
</callout>
</calloutlist>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
<bridgehead id="beats-user-access" renderas="sect3">Granting Users Access to Beats Indices<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/tribe-clients-integrations/beats.asciidoc">Edit me</ulink></bridgehead>
<simpara>To enable users to access the indices a Beat creates, grant them <literal>read</literal> and
<literal>view_index_metadata</literal> privileges on the Beat indices:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Create a role that has the <literal>read</literal> and <literal>view_index_metadata</literal>
privileges  for the Beat indices. You can create roles from the
<emphasis role="strong">Management &gt; Roles</emphasis> UI in Kibana or through the <literal>role</literal> API.
For example, the following request creates a <literal>packetbeat_reader</literal>
role:
</simpara>
<programlisting language="sh" linenumbering="unnumbered">POST _xpack/security/role/packetbeat_reader
{
  "indices": [
    {
      "names": [ "packetbeat-*" ], <co id="CO26-1"/>
      "privileges": ["read","view_index_metadata"]
    }
  ]
}</programlisting>
<calloutlist>
<callout arearefs="CO26-1">
<para>
If you use a custom Packetbeat index pattern, specify that pattern
instead of the default <literal>packetbeat-*</literal> pattern.
</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>
Assign your users the reader role so they can access the Beat indices:
</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>
If you&#8217;re using the <literal>native</literal> realm, you can assign roles with the
<emphasis role="strong">Management &gt; Users</emphasis> UI in Kibana or through the <literal>user</literal> API. For
example, the following request grants <literal>packetbeat_user</literal>
the <literal>packetbeat_reader</literal> role:
</simpara>
<programlisting language="sh" linenumbering="unnumbered">POST /_xpack/security/user/packetbeat_user
{
  "password" : "changeme",
  "roles" : [ "packetbeat_reader"],
  "full_name" : "Packetbeat User"
}</programlisting>
</listitem>
<listitem>
<simpara>
If you&#8217;re using the LDAP, Active Directory, or PKI realms, you
assign the roles in the <link linkend="mapping-roles"><literal>role_mapping.yml</literal></link> configuration
file. For example, the following snippet grants <literal>Packetbeat User</literal>
the <literal>packetbeat_reader</literal> role:
</simpara>
<programlisting language="yaml" linenumbering="unnumbered">packetbeat_reader:
  - "cn=Packetbeat User,dc=example,dc=com"</programlisting>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
<bridgehead id="beats-tls" renderas="sect4">Configuring Beats to use Encrypted Connections<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/tribe-clients-integrations/beats.asciidoc">Edit me</ulink></bridgehead>
<simpara>If encryption is enabled on the Elasticsearch cluster, you need to
connect to Elasticsearch via HTTPS. If the CA that signed your node certificates
is not in the host system&#8217;s trusted certificate authorities list, you also need
to add the path to the <literal>.pem</literal> file that contains your CA&#8217;s certificate to the
Beat configuration.</simpara>
<simpara>To configure a Beat to connect to Elasticsearch via HTTPS, add the <literal>https</literal> protocol
to all host URLs:</simpara>
<programlisting language="js" linenumbering="unnumbered">output.elasticsearch:
    hosts: ["https://localhost:9200"] <co id="CO27-1"/>
    index: "packetbeat"
    ssl.certificate_authorities: ["/etc/pki/root/ca.pem"] <co id="CO27-2"/></programlisting>
<calloutlist>
<callout arearefs="CO27-1">
<para>
Specify the <literal>https</literal> protocol to connect the Elasticsearch cluster.
</para>
</callout>
<callout arearefs="CO27-2">
<para>
Specify the path to the local <literal>.pem</literal> file that contains your Certificate
Authority&#8217;s certificate. This is generally only needed if you use your
own CA to sign your node certificates.
</para>
</callout>
</calloutlist>
</section>
<section id="kibana">
<title>Kibana and Security<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/tribe-clients-integrations/kibana.asciidoc">Edit me</ulink></title>
<simpara id="using-kibana-with-security">Kibana users have to log in when X-Pack security is enabled on your cluster. You
configure X-Pack security roles for your Kibana users to control what data those users
can access. You also need to configure credentials for the
Kibana server so the requests it submits to Elasticsearch on the user&#8217;s
behalf can be authenticated.</simpara>
<simpara>To prevent user passwords from being sent in the clear, you must configure
Kibana to encrypt communications between the browser and the Kibana server.
If are encrypting traffic to and from the nodes in your Elasticsearch cluster,
you must also configure Kibana to connect to Elasticsearch via HTTPS.</simpara>
<simpara>With X-Pack security enabled, if you load a Kibana dashboard that accesses data in an
index that you are not authorized to view, you get an error that indicates the
index does not exist. X-Pack security do not currently provide a way to control which
users can load which dashboards.</simpara>
<important><simpara>Kibana 5.0 does not support tribe nodes. We are working on a
solution that addresses this limitation.</simpara></important>
<simpara>To use Kibana with X-Pack security:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Configure the password for the built-in <literal>kibana</literal> user. The Kibana server submits
requests as this user to access the cluster monitoring APIs and the <literal>.kibana</literal> index.
The server does <emphasis>not</emphasis> need access to user indices.
</simpara>
<simpara>By default, the <literal>kibana</literal> user password is set to <literal>changeme</literal>. Change this password
through the reset password API:</simpara>
<programlisting language="shell" linenumbering="unnumbered">curl -XPUT 'localhost:9200/_xpack/security/user/kibana/_password' -d '{
  "password" : "s0m3th1ngs3cr3t"
}'</programlisting>
<simpara>Once you change the password, you need to specify it with the <literal>elasticsearch.password</literal>
property in <literal>kibana.yml</literal>:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">elasticsearch.password: "s0m3th1ngs3cr3t"</programlisting>
</listitem>
<listitem>
<simpara>
Assign the <literal>kibana_user</literal> role to grant Kibana users the privileges they
need to use Kibana.
</simpara>
<important id="kibana-roles"><simpara>You also need to grant Kibana users access to the
indices that they will be working with in Kibana.</simpara></important>
<itemizedlist>
<listitem>
<simpara>
If you&#8217;re using the <literal>native</literal> realm, you can assign roles using the
<link linkend="managing-native-users">User Management API</link>. For example, the following
creates a user named <literal>jacknich</literal> and assigns it the <literal>kibana_user</literal> role:
</simpara>
<programlisting language="js" linenumbering="unnumbered">POST /_xpack/security/user/jacknich
{
  "password" : "t0pS3cr3t",
  "roles" : [ "kibana_user" ]
}</programlisting>
</listitem>
<listitem>
<simpara>
If you are using an LDAP or Active Directory realm, you can either assign
roles on a per user basis, or assign roles to groups of users. By default, role
mappings are stored in <link linkend="mapping-roles"><literal>CONFIGDIR/x-pack/role_mapping.yml</literal></link>.
For example, the following snippet assigns the <literal>kibana_user</literal> role to the
group named <literal>admins</literal> and the user named Jack Nicholson:
</simpara>
<programlisting language="yaml" linenumbering="unnumbered">kibana_user:
  - "cn=admins,dc=example,dc=com"
  - "cn=Jack Nicholson,dc=example,dc=com"</programlisting>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>
Configure Kibana to encrypt communications between the browser and the Kibana
server:
</simpara>
<orderedlist id="configure-kibana-cert" numeration="loweralpha">
<listitem>
<simpara>
Generate a server certificate for Kibana. You must either set the certificate&#8217;s
<literal>subjectAltName</literal> to the hostname, fully-qualified domain name (FQDN), or IP
address of the Kibana server, or set the CN to the Kibana server&#8217;s hostname
or FQDN. Using the server&#8217;s IP address as the CN does not work.
</simpara>
</listitem>
<listitem>
<simpara>
Set the <literal>server.ssl.key</literal> and <literal>server.ssl.cert</literal> properties in <literal>kibana.yml</literal>:
</simpara>
<programlisting language="yaml" linenumbering="unnumbered">server.ssl.key: /path/to/your/server.key
server.ssl.cert: /path/to/your/server.crt</programlisting>
<simpara>Once you enable SSL encryption between the browser and the Kibana server,
access Kibana via HTTPS. For example, <literal>https://localhost:5601</literal>.</simpara>
<note><simpara>You must enable SSL encryption between the browser and the Kibana
server to use Kibana with X-Pack security enabled. If X-Pack security is configured to
encrypt connections to Elasticsearch, you must also <link linkend="configure-kibana-ssl">configure Kibana to connect to Elasticsearch via HTTPS</link>.</simpara></note>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>
If you have enabled SSL encryption in X-Pack security, configure Kibana to connect
to Elasticsearch via HTTPS:
</simpara>
<orderedlist id="configure-kibana-ssl" numeration="loweralpha">
<listitem>
<simpara>
Specify the HTTPS protocol in the <literal>elasticsearch.url</literal> setting in the Kibana
configuration file, <literal>kibana.yml</literal>:
</simpara>
<programlisting language="yaml" linenumbering="unnumbered">elasticsearch.url: "https://&lt;your_elasticsearch_host&gt;.com:9200"</programlisting>
</listitem>
<listitem>
<simpara>
If you are using your own CA to sign certificates for Elasticsearch, set the
<literal>elasticsearch.ssl.ca</literal> setting in <literal>kibana.yml</literal> to specify the location of the PEM
file.
</simpara>
<programlisting language="yaml" linenumbering="unnumbered">elasticsearch.ssl.ca: /path/to/your/cacert.pem</programlisting>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>
Install X-Pack into Kibana to secure user sessions and enable users
to log in and out of Kibana:
</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>
Run the following command in your Kibana installation directory.
</simpara>
<programlisting language="console" linenumbering="unnumbered">bin/kibana-plugin install x-pack</programlisting>
<note>
<simpara>To perform an offline install, download the X-Pack zip file from
<ulink url="https://artifacts.elastic.co/downloads/packs/x-pack/x-pack-5.0.1.zip">
<literal>https://artifacts.elastic.co/downloads/packs/x-pack/x-pack-5.0.1.zip</literal></ulink>
(<ulink url="https://artifacts.elastic.co/downloads/packs/x-pack/x-pack-5.0.1.zip.sha1">sha1</ulink>)
and run:</simpara>
<programlisting language="sh" linenumbering="unnumbered">bin/kibana-plugin install file:///path/to/file/x-pack-5.0.1.zip</programlisting>
</note>
</listitem>
<listitem>
<simpara>
Set the <literal>xpack.security.encryptionKey</literal> property in the <literal>kibana.yml</literal> configuration file.
You can use any text string that is 32 characters or longer as the encryption key.
</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.security.encryptionKey: "something_at_least_32_characters"</programlisting>
</listitem>
<listitem>
<simpara>
To change the default session duration, set the <literal>xpack.security.sessionTimeout</literal> property
in the <literal>kibana.yml</literal> configuration file. By default, sessions will stay active until the
browser is closed. The timeout is specified in milliseconds. For example, set the timeout
to 600000 to expire sessions after 10 minutes:
</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.security.sessionTimeout: 600000</programlisting>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>
Restart Kibana and verify that you can log in as a user. If you are running
Kibana locally, go to <literal>https://localhost:5601</literal> and enter the credentials for a
user you&#8217;ve assigned a Kibana user role. For example, you could log in as the
<literal>jacknich</literal> user created above.
</simpara>
<informalfigure>
<mediaobject>
  <imageobject>
  <imagedata fileref="images/security/kibana-login.jpg"/>
  </imageobject>
  <textobject><phrase>Kibana Login</phrase></textobject>
</mediaobject>
</informalfigure>
<note><simpara>This must be a user who has been assigned the <literal>kibana_user</literal> role.
Kibana server credentials should only be used internally by the
Kibana server.</simpara></note>
</listitem>
</orderedlist>
<bridgehead id="security-ui-settings" renderas="sect4">Kibana X-Pack security UI Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/tribe-clients-integrations/kibana.asciidoc">Edit me</ulink></bridgehead>
<informaltable
frame="all"
rowsep="1" colsep="1"
>
<tgroup cols="3">
<colspec colname="col_1" colwidth="33*"/>
<colspec colname="col_2" colwidth="33*"/>
<colspec colname="col_3" colwidth="33*"/>
<thead>
<row>
<entry align="left" valign="top"> Name                               </entry>
<entry align="left" valign="top"> Default                  </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>xpack.security.encryptionKey</literal></simpara></entry>
<entry align="left" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>An arbitrary string of 32 characters or more used to encrypt credentials in a
                                                                  cookie. It is crucial that this key is not exposed to
                                                                  users of Kibana. Required.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>xpack.security.sessionTimeout</literal></simpara></entry>
<entry align="left" valign="top"><simpara><literal>1800000</literal> (30 minutes)</simpara></entry>
<entry align="left" valign="top"><simpara>Sets the session duration (in milliseconds).</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>xpack.security.cookieName</literal></simpara></entry>
<entry align="left" valign="top"><simpara><literal>"sid"</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Sets the name of the cookie used for the session.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>xpack.security.secureCookies</literal></simpara></entry>
<entry align="left" valign="top"><simpara><literal>false</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Sets the <literal>secure</literal> flag of the session cookie. Is set
                                                                  to <literal>true</literal> if <literal>server.ssl.cert</literal> and <literal>server.ssl.key</literal>
                                                                  are set. Set this to <literal>true</literal> if SSL is configured
                                                                  outside of Kibana (for example, you are routing
                                                                  requests through a load balancer or proxy).</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
</section>
<section id="secure-monitoring">
<title>Monitoring and Security<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/tribe-clients-integrations/monitoring.asciidoc">Edit me</ulink></title>
<simpara><link linkend="xpack-monitoring">X-Pack monitoring</link> consists of two components: an agent
that you install on on each Elasticsearch node in your cluster, and a Monitoring UI
in Kibana. The monitoring agent collects and indexes metrics from Elasticsearch
and you visualize the data through the Monitoring dashboards in Kibana. The agent
can index data on the same cluster, or send it to an external monitoring cluster.</simpara>
<simpara>To use X-Pack monitoring with X-Pack security enabled, you need to
<link linkend="kibana">set up Kibana to work with X-Pack security</link> and create at least one user
for the Monitoring UI. If you are using an external monitoring cluster, you also
need to configure a user for the monitoring agent and configure the agent to use
the appropriate credentials when communicating with the monitoring cluster.</simpara>
<bridgehead id="monitoring-ui-users" renderas="sect3">Setting Up Monitoring UI Users<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/tribe-clients-integrations/monitoring.asciidoc">Edit me</ulink></bridgehead>
<simpara>When X-Pack security is enabled, Kibana users are prompted to log in when they access
the UI. To use the Monitoring UI, a user must have access to the Kibana indices
and permission to read from the monitoring indices.</simpara>
<simpara>You set up Monitoring UI users on the cluster where the monitoring data is being
stored. To grant all of the necessary permissions, assign the user the
<literal>monitoring_user</literal> and <literal>kibana_user</literal> roles:</simpara>
<itemizedlist>
<listitem>
<simpara>
If you&#8217;re using the <literal>native</literal> realm, you can assign roles using the
<link linkend="managing-native-users">User Management API</link>. For example, the following
command creates a user named <literal>jacknich</literal> and assigns him the <literal>kibana_user</literal> and
<literal>monitoring_user</literal> roles:
</simpara>
<programlisting language="js" linenumbering="unnumbered">POST /_xpack/security/user/jacknich
{
  "password" : "t0pS3cr3t",
  "roles" : [ "kibana_user", "monitoring_user" ]
}</programlisting>
</listitem>
<listitem>
<simpara>
If you are using an LDAP or Active Directory realm, you can either assign roles
on a per user basis, or assign roles to groups of users. By default, role mappings
are configured in <link linkend="mapping-roles"><literal>config/x-pack/role_mapping.yml</literal></link>. For example,
the following snippet assigns the user named Jack Nicholson to the <literal>kibana_user</literal>
and <literal>monitoring_user</literal> roles:
</simpara>
<programlisting language="yaml" linenumbering="unnumbered">kibana_user:
  - "cn=Jack Nicholson,dc=example,dc=com"
monitoring_user:
  - "cn=Jack Nicholson,dc=example,dc=com"</programlisting>
</listitem>
</itemizedlist>
<bridgehead id="configuring-monitoring-agent-security" renderas="sect3">Configuring Monitoring Agent to Communicate with a X-Pack security-Enabled Monitoring Cluster<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/tribe-clients-integrations/monitoring.asciidoc">Edit me</ulink></bridgehead>
<simpara>To configure the monitoring agent to communicate with a secured monitoring cluster:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Configure a user on the monitoring cluster who has the <literal>remote_monitoring_agent</literal>
role, which is &lt;&lt;<anchor id="built-in-roles-remote-monitoring-agent" xreflabel="[built-in-roles-remote-monitoring-agent]"/>, built-in to X-Pack&gt;&gt;.
For example:
</simpara>
<programlisting language="js" linenumbering="unnumbered">POST /_xpack/security/user/agent-user
{
  "password" : "t0pS3cr3t",
  "roles" : [ "remote_monitoring_agent" ]
}</programlisting>
</listitem>
<listitem>
<simpara>
On each node in the cluster being monitored, configure a Monitoring HTTP exporter
in <literal>elasticsearch.yml</literal> and restart Elasticsearch. In the exporter configuration,
you need to:
</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>
Set the <literal>type</literal> to <literal>http</literal>.
</simpara>
</listitem>
<listitem>
<simpara>
Specify the location of the monitoring cluster in the <literal>host</literal> setting.
</simpara>
</listitem>
<listitem>
<simpara>
Provide the agent user credentials with the <literal>username</literal> and <literal>password</literal> settings.
</simpara>
</listitem>
</orderedlist>
<simpara>For example:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.monitoring.exporters:
  id1:
    type: http
    host: ["http://es-mon1:9200", "http://es-mon2:9200"]
    auth:
      username: agent-user
      password: password</programlisting>
<simpara>If SSL/TLS is enabled on the monitoring cluster:</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>
Specify the HTTPS protocol when setting the monitoring server host.
</simpara>
</listitem>
<listitem>
<simpara>
Include the CA certificate in the trusted certificates in order to verify
   the identities of the nodes in the monitoring cluster.
</simpara>
</listitem>
</orderedlist>
<simpara>Trust material may be specified by providing a list of PEM encoded certificates:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.monitoring.exporters:
  id1:
    type: http
    host: ["https://es-mon1:9200", "https://es-mon2:9200"]
    auth:
      username: agent-user
      password: password
    ssl:
      certificate_authorities: [ "/path/to/ca.crt" ]
  id2:
    type: local</programlisting>
<simpara>Trusted certificates may also be configured using a truststore
(Java Keystore file containing certificates):</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.monitoring.exporters:
  id1:
    type: http
    host: ["https://es-mon1:9200", "https://es-mon2:9200"]
    auth:
      username: agent-user
      password: password
    ssl:
      truststore.path: /path/to/file
      truststore.password: password
  id2:
    type: local</programlisting>
</listitem>
</orderedlist>
</section>
<section id="secure-reporting">
<title>Reporting and Security<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/tribe-clients-integrations/reporting.asciidoc">Edit me</ulink></title>
<simpara>Reporting operates by creating and updating documents in Elasticsearch in
response to user actions in Kibana.</simpara>
<simpara>To use Reporting with X-Pack security enabled, you need to <link linkend="kibana">set up Kibana to work with X-Pack security</link>. If you are automatically generating reports with
<link linkend="xpack-alerting">Watcher</link>, you also need to configure Watcher to trust the
Kibana server&#8217;s certificate. For more information, see <link linkend="securing-reporting">Securing Reporting</link>.</simpara>
<simpara id="reporting-app-users">To enable users to generate reports, assign them the built in <literal>reporting_user</literal>
and <literal>kibana_user</literal> roles:</simpara>
<itemizedlist>
<listitem>
<simpara>
If you&#8217;re using the <literal>native</literal> realm, you can assign roles through
<emphasis role="strong">Management / Users</emphasis> UI in Kibana or with the <literal>user</literal> API. For example,
the following request creates a <literal>reporter</literal> user that has the
<literal>reporting_user</literal> and <literal>kibana_user</literal> roles:
</simpara>
<programlisting language="sh" linenumbering="unnumbered">POST /_xpack/security/user/reporter
{
  "password" : "changeme",
  "roles" : ["kibana_user", "reporting_user"],
  "full_name" : "Reporting User"
}</programlisting>
</listitem>
<listitem>
<simpara>
If you are using an LDAP or Active Directory realm, you can either assign
roles on a per user basis, or assign roles to groups of users. By default, role
mappings are configured in <link linkend="mapping-roles"><literal>config/shield/role_mapping.yml</literal></link>.
For example, the following snippet assigns the user named Bill Murray the
<literal>kibana_user</literal> and <literal>reporting_user</literal> roles:
</simpara>
<programlisting language="yaml" linenumbering="unnumbered">kibana_user:
  - "cn=Bill Murray,dc=example,dc=com"
reporting_user:
  - "cn=Bill Murray,dc=example,dc=com"</programlisting>
</listitem>
</itemizedlist>
</section>
</chapter>
<chapter id="security-reference">
<title>Reference<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/reference.asciidoc">Edit me</ulink></title>
<itemizedlist>
<listitem>
<simpara>
<link linkend="security-privileges">Security Privileges</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="security-settings">Security Settings</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="security-files">Security Files</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="security-api">Security API</link>
</simpara>
</listitem>
</itemizedlist>
<section id="security-privileges">
<title>Security Privileges<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/reference/privileges.asciidoc">Edit me</ulink></title>
<simpara>This section lists the privileges that you can assign to a role.</simpara>
<section id="privileges-list-cluster">
<title>Cluster Privileges<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/reference/privileges.asciidoc">Edit me</ulink></title>
<informaltable tabstyle="horizontal" frame="none" colsep="0" rowsep="0"><tgroup cols="2"><colspec colwidth="15*"/><colspec colwidth="85*"/><tbody valign="top">
<row>
<entry>
<simpara>
<literal>all</literal>
</simpara>
</entry>
<entry>
<simpara>
All cluster administration operations, like snapshotting, node shutdown/restart,
settings update, rerouting, or managing users and roles.
</simpara>
</entry>
</row>
<row>
<entry>
<simpara>
<literal>monitor</literal>
</simpara>
</entry>
<entry>
<simpara>
All cluster read-only operations, like cluster health &amp; state, hot threads, node
info, node &amp; cluster stats, snapshot/restore status, pending cluster tasks.
</simpara>
</entry>
</row>
<row>
<entry>
<simpara>
<literal>manage</literal>
</simpara>
</entry>
<entry>
<simpara>
Builds on <literal>monitor</literal> and adds cluster operations that change values in the cluster.
This includes snapshotting,updating settings, and rerouting. This privilege does
not include the ability to manage security.
</simpara>
</entry>
</row>
<row>
<entry>
<simpara>
<literal>manage_security</literal>
</simpara>
</entry>
<entry>
<simpara>
All security related operations such as CRUD operations on users and roles and
cache clearing.
</simpara>
</entry>
</row>
<row>
<entry>
<simpara>
<literal>manage_index_templates</literal>
</simpara>
</entry>
<entry>
<simpara>
All operations on index templates.
</simpara>
</entry>
</row>
<row>
<entry>
<simpara>
<literal>manage_pipeline</literal>
</simpara>
</entry>
<entry>
<simpara>
All operations on ingest pipelines.
</simpara>
</entry>
</row>
<row>
<entry>
<simpara>
<literal>transport_client</literal>
</simpara>
</entry>
<entry>
<simpara>
All privileges necessary for a transport client to connect.
</simpara>
</entry>
</row>
</tbody></tgroup></informaltable>
</section>
<section id="privileges-list-indices">
<title>Indices Privileges<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/reference/privileges.asciidoc">Edit me</ulink></title>
<informaltable tabstyle="horizontal" frame="none" colsep="0" rowsep="0"><tgroup cols="2"><colspec colwidth="15*"/><colspec colwidth="85*"/><tbody valign="top">
<row>
<entry>
<simpara>
<literal>all</literal>
</simpara>
</entry>
<entry>
<simpara>
Any action on an index
</simpara>
</entry>
</row>
<row>
<entry>
<simpara>
<literal>monitor</literal>
</simpara>
</entry>
<entry>
<simpara>
All actions that are required for monitoring (recovery, segments info, index stats
&amp; status).
</simpara>
</entry>
</row>
<row>
<entry>
<simpara>
<literal>manage</literal>
</simpara>
</entry>
<entry>
<simpara>
All <literal>monitor</literal> privileges plus index administration (aliases, analyze, cache clear,
close, delete, exists, flush, mapping, open, force merge, refresh, settings,
search shards, templates, validate).
</simpara>
</entry>
</row>
<row>
<entry>
<simpara>
<literal>view_index_metadata</literal>
</simpara>
</entry>
<entry>
<simpara>
Read-only access to information about an index (aliases, aliases exists, get index, exists, field mappings,
mappings, search shards, type exists, validate, warmers, settings).
</simpara>
</entry>
</row>
<row>
<entry>
<simpara>
<literal>read</literal>
</simpara>
</entry>
<entry>
<simpara>
Read only access to actions (count, explain, get, mget, get indexed scripts,
more like this, multi percolate/search/termvector, percolate, scroll,
clear_scroll, search, suggest, tv). Also grants access to the update mapping
action.
</simpara>
</entry>
</row>
<row>
<entry>
<simpara>
<literal>index</literal>
</simpara>
</entry>
<entry>
<simpara>
Privilege to index and update documents. Also grants access to the update
mapping action.
</simpara>
</entry>
</row>
<row>
<entry>
<simpara>
<literal>create</literal>
</simpara>
</entry>
<entry>
<simpara>
Privilege to index documents. Also grants access to the update mapping
action.
</simpara>
</entry>
</row>
<row>
<entry>
<simpara>
<literal>delete</literal>
</simpara>
</entry>
<entry>
<simpara>
Privilege to delete documents.
</simpara>
</entry>
</row>
<row>
<entry>
<simpara>
<literal>write</literal>
</simpara>
</entry>
<entry>
<simpara>
Privilege to perform all write operations to documents, which includes the
permission to index, update, and delete documents as well as performing bulk
operations. Also grants access to the update mapping action.
</simpara>
</entry>
</row>
<row>
<entry>
<simpara>
<literal>delete_index</literal>
</simpara>
</entry>
<entry>
<simpara>
Privilege to delete an index.
</simpara>
</entry>
</row>
<row>
<entry>
<simpara>
<literal>create_index</literal>
</simpara>
</entry>
<entry>
<simpara>
Privilege to create an index. A create index request may contain aliases to be
added to the index once created. In that case the request requires the <literal>manage</literal>
privilege as well, on both the index and the aliases names.
</simpara>
</entry>
</row>
<row>
<entry>
<simpara>
<literal>view_index_metadata</literal>
</simpara>
</entry>
<entry>
<simpara>
Privilege to view the the index metadata such as its mappings and settings. This
privilege is primarily available for use by <link linkend="kibana-roles">Kibana users</link>.
</simpara>
</entry>
</row>
</tbody></tgroup></informaltable>
</section>
<section id="_run_as_privilege">
<title>Run As Privilege<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/reference/privileges.asciidoc">Edit me</ulink></title>
<simpara>The <literal>run_as</literal> permission enables an authenticated user to submit requests on
behalf of another user. The value can be a user name or a comma-separated list
of user names. (You can also specify users as an array of strings or a YAML
sequence.) For more information, see
<link linkend="run-as-privilege">Submitting Requests on Behalf of Other Users</link>.</simpara>
<remark> include::reference/settings.asciidoc[]</remark>
</section>
</section>
<section id="security-files">
<title>Security Files<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/reference/files.asciidoc">Edit me</ulink></title>
<simpara>The X-Pack security uses the following files:</simpara>
<itemizedlist>
<listitem>
<simpara>
<literal>CONFIG_DIR/x-pack/roles.yml</literal> defines the roles in use on the cluster
  (read more <link linkend="roles-management-file">here</link>).
</simpara>
</listitem>
<listitem>
<simpara>
<literal>CONFIG_DIR/x-pack/users</literal> defines the users and their hashed passwords for
  the <link linkend="file-realm"><literal>file</literal> realm</link>.
</simpara>
</listitem>
<listitem>
<simpara>
<literal>CONFIG_DIR/x-pack/users_roles</literal> defines the user roles assignment for the
  the <link linkend="file-realm"><literal>file</literal> realm</link>.
</simpara>
</listitem>
<listitem>
<simpara>
<literal>CONFIG_DIR/x-pack/role_mapping.yml</literal> defines the role assignments for a
  Distinguished Name (DN) to a role. This allows for LDAP and Active Directory
  groups and users and PKI users to be mapped to roles (read more
  <link linkend="mapping-roles">here</link>).
</simpara>
</listitem>
<listitem>
<simpara>
<literal>CONFIG_DIR/x-pack/log4j2.properties</literal> contains audit information (read more
  <link linkend="logging-file">here</link>).
</simpara>
</listitem>
<listitem>
<simpara>
<literal>CONFIG_DIR/x-pack/system_key</literal> holds a cluster secret key that&#8217;s used to
  authenticate messages during node to node communication. For more information,
  see <link linkend="enable-message-authentication">Enabling Message Authentication</link>.
</simpara>
</listitem>
</itemizedlist>
<important id="security-files-location"><simpara>Any files that X-Pack security uses must be stored in the Elasticsearch
            configuration directory. Elasticsearch runs with restricted permissions
            and is only permitted to read from the locations configured in the
            directory layout for enhanced security.</simpara></important>
<simpara>Several of these files are in the YAML format. When you edit these files, be
aware that YAML is indentation-level sensitive and indentation errors can lead
to configuration errors. Avoid the tab character to set indentation levels, or
use an editor that automatically expands tabs to spaces.</simpara>
<simpara>Be careful to properly escape YAML constructs such as <literal>:</literal> or leading exclamation
points within quoted strings. Using the <literal>|</literal> or <literal>&gt;</literal> characters to define block
literals instead of escaping the problematic characters can help avoid problems.</simpara>
</section>
</chapter>
</part>
<part id="xpack-monitoring">
<title>Monitoring Elasticsearch and Kibana <ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/marvel/index.asciidoc">Edit me</ulink></title>
<partintro>
<simpara>The X-Pack monitoring components enable you to easily monitor Elasticsearch through
<ulink url="https://www.elastic.co/guide/en/kibana/current/introduction.html">
Kibana</ulink>. You can view cluster health and performance in real time as
well as analyze past cluster, index, and node metrics. In addition, you can
monitor the performance of Kibana itself.</simpara>
<simpara>When you install X-Pack on your cluster, a monitoring agent runs on
each node to collect and index metrics from Elasticsearch. With X-Pack
installed in Kibana, you can then view the monitoring data through a set of
specialized dashboards.</simpara>
</partintro>
<chapter id="monitoring-getting-started">
<title>Getting Started<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/marvel/getting-started.asciidoc">Edit me</ulink></title>
<simpara>Monitoring is automatically enabled when you <link linkend="installing-xpack">install X-Pack</link> into Elasticsearch and Kibana. By default, the monitoring agents
index data within the same cluster.</simpara>
<tip><simpara>If you <link linkend="monitoring-cluster">send data to a separate monitoring cluster</link>,
the information is accessible even if the cluster you&#8217;re monitoring is not.
You can send data from multiple clusters to the same monitoring cluster and
view them all through the same instance of Kibana.</simpara></tip>
<simpara>To view and analyze cluster, index, node, and Kibana metrics:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Open Kibana in your web browser and log in. If you are running Kibana
locally, go to <literal>http://localhost:5601/</literal>. To access Kibana and view the
monitoring dashboards, you need the <literal>kibana_user</literal> and <literal>monitoring_user</literal>
roles.
</simpara>
</listitem>
<listitem>
<simpara>
Click <emphasis role="strong">Monitoring</emphasis> in the side navigation to view the clusters being monitored:
</simpara>
</listitem>
</orderedlist>
<informalfigure>
<mediaobject>
  <imageobject>
  <imagedata fileref="images/monitoring/monitoring.jpg"/>
  </imageobject>
  <textobject><phrase>Cluster Overview</phrase></textobject>
</mediaobject>
</informalfigure>
<bridgehead id="cluster-overview-page" renderas="sect2">Cluster Overview<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/marvel/getting-started.asciidoc">Edit me</ulink></bridgehead>
<simpara>To view the key metrics that indicate the overall health of an Elasticsearch
cluster, click <emphasis role="strong">Overview</emphasis> in the Elasticsearch section. Anything that
needs your attention is highlighted in yellow or red.</simpara>
<tip><simpara>Did you know that you can also set up watches to alert you when the status
of your cluster changes? To learn how, see <link linkend="watch-cluster-status">Watch Your Cluster Health</link>.</simpara></tip>
<simpara>The panel at the top shows the current cluster stats, the charts show the
search and indexing performance over time, and the table at the bottom shows
information about any shards that are being recovered.</simpara>
<informalfigure>
<mediaobject>
  <imageobject>
  <imagedata fileref="images/monitoring/monitoring-overview.jpg"/>
  </imageobject>
  <textobject><phrase>Cluster Overview</phrase></textobject>
</mediaobject>
</informalfigure>
<tip><simpara>Not sure what a chart is showing? Click the info button for a description
of the metrics.</simpara></tip>
<simpara>From there, you can dive into detailed metrics for particular nodes and indices.</simpara>
<bridgehead id="indices-overview-page" renderas="sect2">Indices<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/marvel/getting-started.asciidoc">Edit me</ulink></bridgehead>
<simpara>To view index metrics, click <emphasis role="strong">Indices</emphasis>. The Indices section shows the same
overall index and search metrics as the Overview and a table of your indices.</simpara>
<informalfigure>
<mediaobject>
  <imageobject>
  <imagedata fileref="images/monitoring/monitoring-indices.jpg"/>
  </imageobject>
  <textobject><phrase>Indices Page</phrase></textobject>
</mediaobject>
</informalfigure>
<simpara>From there, you can view data for a particular index or group of indices.
To drill down into the data for a particular index, click its name in the
Indices table.</simpara>
<informalfigure>
<mediaobject>
  <imageobject>
  <imagedata fileref="images/monitoring/monitoring-index.jpg"/>
  </imageobject>
  <textobject><phrase>Index View</phrase></textobject>
</mediaobject>
</informalfigure>
<bridgehead id="nodes-page" renderas="sect2">Nodes<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/marvel/getting-started.asciidoc">Edit me</ulink></bridgehead>
<simpara>To view node metrics, click <emphasis role="strong">Nodes</emphasis>. The Nodes section shows the status
of each node in your cluster.</simpara>
<informalfigure>
<mediaobject>
  <imageobject>
  <imagedata fileref="images/monitoring/monitoring-nodes.jpg"/>
  </imageobject>
  <textobject><phrase>Node View</phrase></textobject>
</mediaobject>
</informalfigure>
<simpara>Click the name of a node to view its node stats over time.</simpara>
<informalfigure>
<mediaobject>
  <imageobject>
  <imagedata fileref="images/monitoring/monitoring-node.jpg"/>
  </imageobject>
  <textobject><phrase>Node View</phrase></textobject>
</mediaobject>
</informalfigure>
<bridgehead id="kibana-page" renderas="sect2">Kibana<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/marvel/getting-started.asciidoc">Edit me</ulink></bridgehead>
<simpara>To view the key metrics that indicate the overall health of Kibana itself,
click <emphasis role="strong">Overview</emphasis> in the Kibana section.</simpara>
<informalfigure>
<mediaobject>
  <imageobject>
  <imagedata fileref="images/monitoring/monitoring-kibana-overview.jpg"/>
  </imageobject>
  <textobject><phrase>Node View</phrase></textobject>
</mediaobject>
</informalfigure>
<simpara>To view Kibana instance metrics, click <emphasis role="strong">Instances</emphasis>. The Instances section
shows the status of each Kibana instance.</simpara>
<informalfigure>
<mediaobject>
  <imageobject>
  <imagedata fileref="images/monitoring/monitoring-kibana-instances.jpg"/>
  </imageobject>
  <textobject><phrase>Node View</phrase></textobject>
</mediaobject>
</informalfigure>
<simpara>Click the name of an instance to view its instance stats over time.</simpara>
<informalfigure>
<mediaobject>
  <imageobject>
  <imagedata fileref="images/monitoring/monitoring-kibana-instance.jpg"/>
  </imageobject>
  <textobject><phrase>Node View</phrase></textobject>
</mediaobject>
</informalfigure>
</chapter>
<chapter id="configuring-monitoring">
<title>Configuring Monitoring<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/marvel/configuring-monitoring.asciidoc">Edit me</ulink></title>
<simpara>By default, the monitoring agent collects data from all indices
every 10 seconds and stores the monitoring data locally. You can
configure Monitoring to:</simpara>
<itemizedlist>
<listitem>
<simpara>
<link linkend="stats-export">Specify the indices you want to monitor</link>.
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="monitoring-cluster">Export data to a separate monitoring cluster</link>.
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="config-monitoring-indices">Configure the indices used to store monitoring data</link>.
</simpara>
</listitem>
</itemizedlist>
<simpara>Advanced monitoring settings enable you to control how frequently data
is collected, configure timeouts, and set the retention period for
locally-stored monitoring indices. You can also adjust how monitoring
data is displayed. See <link linkend="monitoring-settings">Monitoring Settings</link>
for the complete list of settings you can configure.</simpara>
<section id="stats-export">
<title>Collecting Data from Particular Indices<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/marvel/configuring-monitoring.asciidoc">Edit me</ulink></title>
<simpara>To collect data from particular indices, configure the
<literal>xpack.monitoring.collection.indices</literal> setting in <literal>elasticsearch.yml</literal>.
You can specify multiple indices as a comma-separated list or
use an index pattern to match multiple indices:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.monitoring.collection.indices: logstash-*, index1, test2</programlisting>
<simpara>You can prepend <literal>+</literal> or <literal>-</literal> to explicitly include or exclude index
names or patterns. For example, to include all indices that
start with <literal>test</literal> except <literal>test3</literal>, you could specify <literal>+test*,-test3</literal>.</simpara>
</section>
<section id="monitoring-cluster">
<title>Setting up a Separate Monitoring Cluster<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/marvel/configuring-monitoring.asciidoc">Edit me</ulink></title>
<simpara>To store monitoring data in a separate cluster:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Set up the Elasticsearch cluster you want to use for monitoring,
<link linkend="installing-xpack">install X-Pack</link>, and start Elasticsearch. For
example, you might set up a two host cluster with the nodes <literal>es-mon-1</literal>
and <literal>es-mon-2</literal>.
</simpara>
<note><simpara>To monitor an Elasticsearch 5.0 cluster, you must run Elasticsearch
5.0 on the monitoring cluster. While installing X-Pack on the monitoring
cluster is not absolutely required, it is strongly recommended.</simpara></note>
</listitem>
<listitem>
<simpara>
Install X-Pack on the nodes in your production cluster.
</simpara>
</listitem>
<listitem>
<simpara>
If X-Pack security is enabled on the monitoring cluster, create a user on the
monitoring cluster that has the <literal>remote_monitoring_agent</literal> role. You can create
users from <emphasis role="strong">Management / Users</emphasis> in Kibana. The Kibana instance must be
connected to the monitoring cluster. You can also create users through the
<literal>user</literal> API. For example, the following request creates a <literal>remote_monitor</literal> user
that has the <literal>remote_monitoring_agent</literal> role:
</simpara>
<programlisting language="sh" linenumbering="unnumbered">POST /_xpack/security/user/remote_monitor
{
  "password" : "changeme",
  "roles" : [ "remote_monitoring_agent"],
  "full_name" : "Internal Agent For Remote Monitoring"
}</programlisting>
</listitem>
<listitem>
<simpara>
Configure the nodes in your production cluster to send metrics to your
monitoring cluster by configuring an HTTP exporter in the
<literal>xpack.monitoring.exporters</literal> settings in <literal>elasticsearch.yml</literal>:
</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.monitoring.exporters:
  id1:
    type: http
    host: ["http://es-mon-1:9200", "http://es-mon2:9200"] <co id="CO28-1"/>
    auth.username: remote_monitor <co id="CO28-2"/>
    auth.password: changeme</programlisting>
<calloutlist>
<callout arearefs="CO28-1">
<para>
If SSL/TLS is enabled on the monitoring cluster, you must
connect through HTTPS and specify the trusted certificates
that will be used to verify the identity of the nodes in the
monitoring cluster. For more information, see <link linkend="secure-monitoring">Monitoring and Security</link>.
</para>
</callout>
<callout arearefs="CO28-2">
<para>
If X-Pack security is disabled on the monitoring cluster, you can
omit <literal>auth.username</literal> and <literal>auth.password</literal>.
</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>
Restart Elasticsearch on the nodes in your production cluster
</simpara>
<tip><simpara>You may want to temporarily <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/modules-cluster.html">disable shard
allocation</ulink> before you restart your nodes to avoid unnecessary shard
reallocation during the install process.</simpara></tip>
</listitem>
<listitem>
<simpara>
<link linkend="installing-xpack">Install X-Pack</link> into Kibana.
</simpara>
</listitem>
<listitem>
<simpara>
Configure Kibana to connect to your monitoring cluster by setting the
<literal>xpack.monitoring.elasticsearch</literal> properties in the <literal>kibana.yml</literal> configuration
file.
</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>
Set the <literal>url</literal> property to point to your monitoring cluster. For example:
</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.monitoring.elasticsearch.url: "http://es-mon-1:9200"</programlisting>
</listitem>
<listitem>
<simpara>
Configure credentials for Kibana to use to connect to the
monitoring cluster. If X-Pack security is disabled on the monitoring
cluster, you can omit the credentials.
</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.monitoring.elasticsearch.username: "kibana-monitor"
xpack.monitoring.elasticsearch.password: "changeme"</programlisting>
</listitem>
<listitem>
<simpara>
If SSL is enabled on the monitoring cluster, you must configure the SSL
properties. These properties have the same options as Kibana&#8217;s primary
connection to Elasticsearch. For example:
</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.monitoring.elasticsearch.ssl.ca: "/path/to/ca/file"</programlisting>
<simpara>For more information, see the <literal>elasticsearch.ssl</literal> properties in
<ulink url="https://www.elastic.co/guide/en/kibana/5.0/settings.html">Setting
Kibana Server Properties</ulink>.</simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>
Start Kibana by running <literal>bin/kibana</literal>.
</simpara>
</listitem>
<listitem>
<simpara>
To verify your X-Pack monitoring installation, point your web browser at your Kibana
host, and select <emphasis role="strong">Monitoring</emphasis> from the side navigation.
</simpara>
<simpara><inlinemediaobject>
  <imageobject>
  <imagedata fileref="images/monitoring/monitoring.jpg"/>
  </imageobject>
  <textobject><phrase>Monitoring</phrase></textobject>
</inlinemediaobject></simpara>
</listitem>
</orderedlist>
<bridgehead id="http-exporter-reference" renderas="sect2">HTTP Exporter<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/marvel/configuring-monitoring.asciidoc">Edit me</ulink></bridgehead>
<simpara>X-Pack monitoring agents default to indexing data into the cluster where
they&#8217;re running. In production, you should use an <literal>http</literal> exporter to send data
to a separate <link linkend="monitoring-cluster">monitoring cluster</link>. When you configure
an exporter in <literal>elasticsearch.yml</literal>, the default <literal>local</literal> exporter is disabled.</simpara>
<simpara>The <literal>http</literal> exporter uses the low-level Elasticsearch REST Client. This allows
the <literal>http</literal> exporter to send its data to any Elasticsearch cluster it can access
through the network.</simpara>
<simpara>The <literal>http</literal> exporter supports a number of settings that control how it
communicates over HTTP to remote clusters. In most cases, it is not
necessary to explicitly configure these settings. For detailed
descriptions, see <link linkend="http-exporter-settings">Monitoring Settings</link>.</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.monitoring.exporters:
  my_local: <co id="CO29-1"/>
    type: local
  my_remote: <co id="CO29-2"/>
    type: http
    host: [ "10.1.2.3", ... ] <co id="CO29-3"/>
    auth: <co id="CO29-4"/>
      username: my_username
      password: changeme
    connection:
      timeout: 6s
      read_timeout: 60s
    ssl: ... <co id="CO29-5"/>
    proxy:
      base_path: /some/base/path <co id="CO29-6"/>
    headers: <co id="CO29-7"/>
      My-Proxy-Header: abc123
      My-Other-Thing: [ def456, ... ]
    index.name.time_format: YYYY-MM <co id="CO29-8"/></programlisting>
<calloutlist>
<callout arearefs="CO29-1">
<para>
A <literal>local</literal> exporter defined explicitly whose arbitrary name is <literal>my_local</literal>.
</para>
</callout>
<callout arearefs="CO29-2">
<para>
An <literal>http</literal> exporter defined whose arbitrary name is <literal>my_remote</literal>.
</para>
</callout>
<callout arearefs="CO29-3">
<para>
<literal>host</literal> is a required setting for <literal>http</literal> exporters, which can take a few
    different forms as described in the table below.
</para>
</callout>
<callout arearefs="CO29-4">
<para>
User authentication for those using X-Pack Security or some other
    form of user authentication protecting the cluster.
</para>
</callout>
<callout arearefs="CO29-5">
<para>
See below for all TLS / SSL settings. If not supplied, the default
    node-level TLS / SSL settings will be used.
</para>
</callout>
<callout arearefs="CO29-6">
<para>
Optional base path to prefix any outgoing request with in order to
    work with proxies.
</para>
</callout>
<callout arearefs="CO29-7">
<para>
Arbitrary key/value pairs to define as headers to send with every request.
    The array-based key/value format sends one header per value.
</para>
</callout>
<callout arearefs="CO29-8">
<para>
A mechanism for changing the date suffix used by default.
</para>
</callout>
</calloutlist>
</section>
<section id="config-monitoring-indices">
<title>Configuring Monitoring&#8217;s Indices<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/marvel/configuring-monitoring.asciidoc">Edit me</ulink></title>
<simpara><ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/indices-templates.html">Index templates</ulink> are used to configure the indices
that store the monitoring data collected from a cluster.</simpara>
<simpara>You can retrieve the templates through the <literal>_template</literal> API:</simpara>
<programlisting language="sh" linenumbering="unnumbered">GET /_template/.monitoring-*</programlisting>
<simpara>By default, the template configures one shard and one replica for the
monitoring indices. To override the default settings, add your own template:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Set the <literal>template</literal> pattern to <literal>.monitoring-*</literal>.
</simpara>
</listitem>
<listitem>
<simpara>
Set the template <literal>order</literal> to <literal>1</literal>. This ensures your template is
applied after the default template, which has an order of 0.
</simpara>
</listitem>
<listitem>
<simpara>
Specify the <literal>number_of_shards</literal> and/or <literal>number_of_replicas</literal> in the <literal>settings</literal>
section.
</simpara>
</listitem>
</orderedlist>
<simpara>For example, the following template increases the number of shards to five
and the number of replicas to two.</simpara>
<programlisting language="js" linenumbering="unnumbered">PUT /_template/custom_monitoring
{
    "template": ".monitoring-*",
    "order": 1,
    "settings": {
        "number_of_shards": 5,
        "number_of_replicas": 2
    }
}</programlisting>
<important><simpara>Only set the <literal>number_of_shards</literal> and <literal>number_of_replicas</literal> in the
settings section. Overriding other monitoring template settings could cause
your monitoring dashboards to stop working correctly.</simpara></important>
</section>
</chapter>
</part>
<part id="xpack-alerting">
<title>Alerting on Cluster and Index Events <ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/index.asciidoc">Edit me</ulink></title>
<partintro>
<simpara>You can watch for changes or anomalies in your data and perform the necessary
actions in response. For example, you might want to:</simpara>
<itemizedlist>
<listitem>
<simpara>
Monitor social media as another way to detect failures in user-facing
  automated systems like ATMs or ticketing systems. When the number of tweets
  and posts in an area exceeds a threshold of significance, notify a service
  technician.
</simpara>
</listitem>
<listitem>
<simpara>
Monitor your infrastructure, tracking disk usage over time. Open a helpdesk
  ticket when any servers are likely to run out of free space in the next few
  days.
</simpara>
</listitem>
<listitem>
<simpara>
Track network activity to detect malicious activity, and proactively change
  firewall configuration to reject the malicious user.
</simpara>
</listitem>
<listitem>
<simpara>
Monitor Elasticsearch, and send immediate notification to the system
  administrator if nodes leave the cluster or query throughput exceeds an
  expected range.
</simpara>
</listitem>
<listitem>
<simpara>
Track application response times and if page-load time exceeds SLAs for more
  than 5 minutes, open a helpdesk ticket. If SLAs are exceeded for an hour,
  page the administrator on duty.
</simpara>
</listitem>
</itemizedlist>
<simpara>All of these use-cases share a few key properties:</simpara>
<itemizedlist>
<listitem>
<simpara>
The relevant data or changes in data can be identified with a periodic
  Elasticsearch query.
</simpara>
</listitem>
<listitem>
<simpara>
The results of the query can be checked against a condition.
</simpara>
</listitem>
<listitem>
<simpara>
One or more actions are taken if the condition is true&#8201;&#8212;&#8201;an email is sent, a
  3rd party system is notified, or the query results are stored.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_how_watches_work" renderas="sect2">How Watches Work<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/index.asciidoc">Edit me</ulink></bridgehead>
<simpara>X-Pack provides an API for creating, managing and testing <emphasis>watches</emphasis>. A watch
describes a single alert and can contain multiple notification actions.</simpara>
<simpara>A watch is constructed from four simple building blocks:</simpara>
<variablelist>
<varlistentry>
<term>
Schedule
</term>
<listitem>
<simpara>
A schedule for running a query and checking the condition.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
Query
</term>
<listitem>
<simpara>
The query to run as input to the condition. Watches
            support the full Elasticsearch query language, including
            aggregations.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
Condition
</term>
<listitem>
<simpara>
A condition that determines whether or not to execute the actions.
            You can use simple conditions (always true), or use scripting for
            more sophisticated scenarios.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
Actions
</term>
<listitem>
<simpara>
One or more actions, such as sending email, pushing data to
            3rd party systems through a webhook, or indexing the results of
            the query.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<simpara>A full history of all watches is maintained in an Elasticsearch index. This
history keeps track of each time a watch is triggered and records the results
from the query, whether the condition was met, and what actions were taken.</simpara>
</partintro>
<chapter id="watcher-getting-started">
<title>Getting Started with Watcher<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/getting-started.asciidoc">Edit me</ulink></title>
<simpara>This getting started guide walks you through setting up alerting and creating
your first watches, and introduces the building blocks you&#8217;ll use to create
custom watches.</simpara>
<simpara>To get started with alerting and notification:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
<link linkend="installing-xpack">Install X-Pack</link> on each node in your cluster.
</simpara>
</listitem>
<listitem>
<simpara>
Start Elasticsearch.
</simpara>
<programlisting language="shell" linenumbering="unnumbered">bin/elasticsearch</programlisting>
</listitem>
<listitem>
<simpara>
Verify that Watcher is enabled, by calling the <link linkend="watcher-api-stats">Watcher Stats API</link>:
</simpara>
<programlisting language="js" linenumbering="unnumbered">GET _xpack/watcher/stats</programlisting>
<simpara>You haven&#8217;t set up any watches yet, so the <literal>watch_count</literal> is zero and the
<literal>execution_thread_pool</literal> queue is empty:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "watcher_state" : "started",
  "watch_count" : 0,
  "execution_thread_pool" : {
    "queue_size" : 0,
    "max_size" : 0
  },
  "manually_stopped" : false
}</programlisting>
</listitem>
</orderedlist>
<simpara>Ready to start building watches? Choose one of the following scenarios:</simpara>
<itemizedlist>
<listitem>
<simpara>
<link linkend="watch-log-data">Watch Log Data for Errors</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="watch-cluster-status">Watch Your Cluster Health</link>
</simpara>
</listitem>
</itemizedlist>
<section id="watch-log-data">
<title>Watch Log Data for Errors<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/getting-started.asciidoc">Edit me</ulink></title>
<simpara>You can easily configure a watch that periodically checks your log data for
error conditions:</simpara>
<itemizedlist>
<listitem>
<simpara>
<link linkend="log-add-input">Schedule the watch and define an input</link> to search your log
  data for error events.
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="log-add-condition">Add a condition</link> that checks to see if any errors were
  found.
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="log-take-action">Take action</link> if there are any errors.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="log-add-input" renderas="sect3">Schedule the Watch and Add an Input<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/getting-started.asciidoc">Edit me</ulink></bridgehead>
<simpara>A watch <link linkend="trigger-schedule">schedule</link> controls how often a watch is triggered.
The watch <link linkend="input">input</link> gets the data that you want to evaluate.</simpara>
<simpara>To periodically search your log data and load the results into the watch, you
use an <link linkend="schedule-interval">interval</link> schedule and a <link linkend="input-search">search</link>
input. For example, the following Watch searches the <literal>logs</literal> index for errors
every 10 seconds:</simpara>
<programlisting language="js" linenumbering="unnumbered">PUT _xpack/watcher/watch/errors_in_logs
{
  "trigger" : {
    "schedule" : { "interval" : "10s" } <co id="CO30-1"/>
  },
  "input" : {
    "search" : {
      "request" : {
        "indices" : [ "logs" ],
        "body" : {
          "query" : {
            "match" : { "message": "error" }
          }
        }
      }
    }
  }
}</programlisting>
<calloutlist>
<callout arearefs="CO30-1">
<para>
Schedules are typically configured to run less frequently. This example sets
    the interval to 10 seconds so you can easily see the watches being triggered.
    Since this watch runs so frequently, don&#8217;t forget to <link linkend="log-delete">delete the watch</link>
    when you&#8217;re done experimenting.
</para>
</callout>
</calloutlist>
<simpara>If you check the watch history you&#8217;ll see that the watch is being triggered every
10 seconds. However, the search isn&#8217;t returning any results so nothing is loaded
into the watch payload.</simpara>
<simpara>For example, the following snippet gets the last ten watch executions (a.k.a watch
records) from the watch history:</simpara>
<programlisting language="js" linenumbering="unnumbered">GET .watcher-history*/_search?pretty
{
  "sort" : [
    { "result.execution_time" : "desc" }
  ]
}</programlisting>
<bridgehead id="log-add-condition" renderas="sect3">Add a Condition<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/getting-started.asciidoc">Edit me</ulink></bridgehead>
<simpara>A <link linkend="condition">condition</link> evaluates the data you&#8217;ve loaded into the watch and
determines if any action is required. Since you&#8217;ve defined an input that loads
log errors into the watch, you can define a condition that checks to see if any
errors were found.</simpara>
<simpara>For example, you could add a condition that checks to see if the search input
returned any hits.</simpara>
<programlisting language="js" linenumbering="unnumbered">PUT _xpack/watcher/watch/errors_in_logs
{
  "trigger" : { "schedule" : { "interval" : "10s" }},
  "input" : {
    "search" : {
      "request" : {
        "indices" : [ "logs" ],
        "body" : {
          "query" : {
            "match" : { "message": "error" }
          }
        }
      }
    }
  },
  "condition" : {
    "compare" : { "ctx.payload.hits.total" : { "gt" : 0 }} <co id="CO31-1"/>
  }
}</programlisting>
<calloutlist>
<callout arearefs="CO31-1">
<para>
The <link linkend="condition-compare">compare</link> condition lets you easily compare against
    values in the execution context without enabling dynamic scripting.
</para>
</callout>
</calloutlist>
<simpara>The condition result is recorded as part of the <literal>watch_record</literal> each time the watch
executes. Since there are currently no log events in the <literal>logs</literal> index, the watch
condition will not be met. If you search the history for watch executions where
the condition was met during the last 5 seconds, there are no hits:</simpara>
<programlisting language="js" linenumbering="unnumbered">GET .watcher-history*/_search?pretty
{
  "query" : {
    "bool" : {
      "must" : [
        { "match" : { "result.condition.met" : true }},
        { "range" : { "result.execution_time" : { "from" : "now-10s" }}}
      ]
    }
  }
}</programlisting>
<simpara>For the condition in the example to evaluate to <literal>true</literal>, you need to add an event
to the <literal>logs</literal> index that contains an error. For example, the following snippet
adds a 404 error to the <literal>logs</literal> index:</simpara>
<programlisting language="js" linenumbering="unnumbered">POST logs/event
{
    "timestamp" : "2015-05-17T18:12:07.613Z",
    "request" : "GET index.html",
    "status_code" : 404,
    "message" : "Error: File not found"
}</programlisting>
<simpara>Once you add this event, the next time the watch executes its condition will
evaluate to <literal>true</literal>. You can verify this by searching the watch history:</simpara>
<programlisting language="js" linenumbering="unnumbered">XGET .watcher-history*/_search?pretty
{
  "query" : {
    "bool" : {
      "must" : [
        { "match" : { "result.condition.met" : true }},
        { "range" : { "result.execution_time" : { "from" : "now-10s" }}}
      ]
    }
  }
}</programlisting>
<bridgehead id="log-take-action" renderas="sect3">Take Action<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/getting-started.asciidoc">Edit me</ulink></bridgehead>
<simpara>Recording <literal>watch_records</literal> in the watch history is nice, but the real power of
Watcher is being able to do something when the watch condition is met. The
watch&#8217;s <link linkend="actions">actions</link>  define what to do when the watch condition evaluates
to <literal>true</literal>--you can send emails, call third-party webhooks, write documents to an
Elasticsearch or log messages to the standards Elasticsearch log files.</simpara>
<simpara>For example, you could add an action to write a message to the Elasticsearch log
when an error is detected.</simpara>
<programlisting language="js" linenumbering="unnumbered">PUT _xpack/watcher/watch/log_error_watch
{
  "trigger" : { "schedule" : { "interval" : "10s" }},
  "input" : {
    "search" : {
      "request" : {
        "indices" : [ "logs" ],
        "body" : {
          "query" : {
            "match" : { "message": "error" }
          }
        }
      }
    }
  },
  "condition" : {
    "compare" : { "ctx.payload.hits.total" : { "gt" : 0 }}
  },
  "actions" : {
    "log_error" : {
      "logging" : {
        "text" : "Found {{ctx.payload.hits.total}} errors in the logs"
      }
    }
  }
}</programlisting>
<bridgehead id="log-delete" renderas="sect3">Delete the Watch<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/getting-started.asciidoc">Edit me</ulink></bridgehead>
<simpara>Since the <literal>log_error_watch</literal> is configured to run every 10 seconds, make sure you
delete it when you&#8217;re done experimenting. Otherwise, the noise from this sample
watch will make it hard to see what else is going on in your watch history and
log file.</simpara>
<simpara>To remove the watch, use the <link linkend="watcher-api-delete-watch">DELETE watch</link> API:</simpara>
<programlisting language="js" linenumbering="unnumbered">DELETE _xpack/watcher/watch/log_error_watch</programlisting>
</section>
<section id="watch-cluster-status">
<title>Watch Your Cluster Health<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/getting-started.asciidoc">Edit me</ulink></title>
<simpara>You can easily configure a basic watch to monitor the health of your
Elasticsearch cluster:</simpara>
<itemizedlist>
<listitem>
<simpara>
<link linkend="health-add-input">Schedule the watch and define an input</link> that gets the
  cluster health status.
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="health-add-condition">Add a condition</link> that evaluates the health status to
  determine if action is required.
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="health-take-action">Take action</link> if the cluster is RED.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="health-add-input" renderas="sect3">Schedule the Watch and Add an Input<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/getting-started.asciidoc">Edit me</ulink></bridgehead>
<simpara>A watch <link linkend="trigger-schedule">schedule</link> controls how often a watch is triggered.
The watch <link linkend="input">input</link> gets the data that you want to evaluate.</simpara>
<simpara>The simplest way to define a schedule is to specify an interval. For example,
the following schedule runs every 10 seconds:</simpara>
<programlisting language="js" linenumbering="unnumbered">PUT _xpack/watcher/watch/cluster_health_watch
{
  "trigger" : {
    "schedule" : { "interval" : "10s" } <co id="CO32-1"/>
  }
}</programlisting>
<calloutlist>
<callout arearefs="CO32-1">
<para>
Schedules are typically configured to run less frequently. This example sets
    the interval to 10 seconds to you can easily see the watches being triggered.
    Since this watch runs so frequently, don&#8217;t forget to <link linkend="health-delete">delete the watch</link>
    when you&#8217;re done experimenting.
</para>
</callout>
</calloutlist>
<simpara>To get the status of your cluster, you can call the Elasticsearch
<ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0//cluster-health.html">cluster health</ulink> API:</simpara>
<programlisting language="js" linenumbering="unnumbered">GET _cluster/health?pretty</programlisting>
<simpara>To load the health status into your watch, you simply add an
<link linkend="input-http">HTTP input</link> that calls the cluster health API:</simpara>
<programlisting language="js" linenumbering="unnumbered">PUT _xpack/watcher/watch/cluster_health_watch
{
  "trigger" : {
    "schedule" : { "interval" : "10s" }
  },
  "input" : {
    "http" : {
      "request" : {
        "host" : "localhost",
        "port" : 9200,
        "path" : "/_cluster/health"
      }
    }
  }
}</programlisting>
<simpara>If you check the watch history, you&#8217;ll see that the cluster status is recorded
as part of the <literal>watch_record</literal> each time the watch executes.</simpara>
<simpara>For example, the following snippet gets the last ten watch records from the watch
history:</simpara>
<programlisting language="js" linenumbering="unnumbered">GET .watcher-history*/_search
{
  "sort" : [
    { "result.execution_time" : "desc" }
  ]
}</programlisting>
<bridgehead id="health-add-condition" renderas="sect3">Add a Condition<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/getting-started.asciidoc">Edit me</ulink></bridgehead>
<simpara>A <link linkend="condition">condition</link> evaluates the data you&#8217;ve loaded into the watch and
determines if any action is required. Since you&#8217;ve defined an input that loads
the cluster status into the watch, you can define a condition that checks that
status.</simpara>
<simpara>For example, you could add a condition to check to see if the status is RED.</simpara>
<programlisting language="js" linenumbering="unnumbered">PUT _xpack/watcher/watch/cluster_health_watch
{
  "trigger" : {
    "schedule" : { "interval" : "10s" } <co id="CO33-1"/>
  },
  "input" : {
    "http" : {
      "request" : {
       "host" : "localhost",
       "port" : 9200,
       "path" : "/_cluster/health"
      }
    }
  },
  "condition" : {
    "compare" : {
      "ctx.payload.status" : { "eq" : "red" }
    }
  }
}</programlisting>
<calloutlist>
<callout arearefs="CO33-1">
<para>
Schedules are typically configured to run less frequently. This example sets
    the interval to 10 seconds to you can easily see the watches being triggered.
</para>
</callout>
</calloutlist>
<simpara>If you check the watch history, you&#8217;ll see that the condition result is recorded
as part of the <literal>watch_record</literal> each time the watch executes.</simpara>
<simpara>To check to see if the condition was met, you can run the following query.</simpara>
<programlisting language="js" linenumbering="unnumbered">GET .watcher-history*/_search?pretty
{
  "query" : {
    "match" : { "result.condition.met" : true }
  }
}</programlisting>
<bridgehead id="health-take-action" renderas="sect3">Take Action<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/getting-started.asciidoc">Edit me</ulink></bridgehead>
<simpara>Recording <literal>watch_records</literal> in the watch history is nice, but the real power of
Watcher is being able to do something in response to an alert. A watch&#8217;s
<link linkend="actions">actions</link>  define what to do when the watch condition is true&#8212;you
can send emails, call third-party webhooks, or write documents to an
Elasticsearch index or log when the watch condition is met.</simpara>
<simpara>For example, you could add an action to index the cluster status information
when the status is RED.</simpara>
<programlisting language="js" linenumbering="unnumbered">PUT _xpack/watcher/watch/cluster_health_watch
{
  "trigger" : {
    "schedule" : { "interval" : "10s" }
  },
  "input" : {
    "http" : {
      "request" : {
       "host" : "localhost",
       "port" : 9200,
       "path" : "/_cluster/health"
      }
    }
  },
  "condition" : {
    "compare" : {
      "ctx.payload.status" : { "eq" : "red" }
    }
  },
  "actions" : {
    "send_email" : {
      "email" : {
        "to" : "&lt;username&gt;@&lt;domainname&gt;",
        "subject" : "Cluster Status Warning",
        "body" : "Cluster status is RED"
      }
    }
  }
}</programlisting>
<simpara>For Watcher to send email, you must configure an email account in your
<literal>elasticsearch.yml</literal> configuration file and restart Elasticsearch. To add an email
account, set the <literal>xpack.notification.email.account</literal> property.</simpara>
<simpara>For example, the following snippet configures a single Gmail account named <literal>work</literal>:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.notification.email.account:
  work:
    profile: gmail
    email_defaults:
      from: &lt;email&gt; <co id="CO34-1"/>
    smtp:
      auth: true
      starttls.enable: true
      host: smtp.gmail.com
      port: 587
      user: &lt;username&gt; <co id="CO34-2"/>
      password: &lt;password&gt; <co id="CO34-3"/></programlisting>
<calloutlist>
<callout arearefs="CO34-1">
<para>
Replace <literal>&lt;email&gt;</literal> with the email address from which you want to send
    notifications.
</para>
</callout>
<callout arearefs="CO34-2">
<para>
Replace <literal>&lt;username&gt;</literal> with your Gmail user name (typically your Gmail address).
</para>
</callout>
<callout arearefs="CO34-3">
<para>
Replace <literal>&lt;password&gt;</literal> with your Gmail password.
</para>
</callout>
</calloutlist>
<note><simpara>If you have advanced security options enabled for your email account,
        you need to take additional steps to send email from Watcher. For more
        information, see <link linkend="configuring-email">Working with Various Email Services</link>.</simpara></note>
<simpara>You can check the watch history or the <literal>status_index</literal> to see that the action was
performed.</simpara>
<programlisting language="js" linenumbering="unnumbered">GET .watcher-history*/_search?pretty
{
  "query" : {
    "match" : { "result.condition.met" : true }
  }
}</programlisting>
<bridgehead id="health-delete" renderas="sect3">Delete the Watch<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/getting-started.asciidoc">Edit me</ulink></bridgehead>
<simpara>Since the <literal>cluster_health_watch</literal> is configured to run every 10 seconds, make
sure you delete it when you&#8217;re done experimenting. Otherwise, you&#8217;ll spam yourself
indefinitely.</simpara>
<simpara>To remove the watch, use the <link linkend="watcher-api-delete-watch">DELETE watch</link> API:</simpara>
<programlisting language="js" linenumbering="unnumbered">DELETE _xpack/watcher/watch/cluster_health_watch</programlisting>
</section>
</chapter>
<chapter id="how-watcher-works">
<title>How Watcher Works<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/how-watcher-works.asciidoc">Edit me</ulink></title>
<simpara>You <link linkend="watch-definition">add watches</link> to automatically perform an action when
certain conditions are met. The conditions are generally based on data you&#8217;ve
loaded into the watch, also known as the <emphasis>Watch Payload</emphasis>. This payload can be
loaded from different sources - from Elasticsearch, an external HTTP service, or
even a combination of the two.</simpara>
<simpara>For example, you could configure a watch to send an email to the sysadmin when a
search in the logs data indicates that there are too many 503 errors in the last
5 minutes.</simpara>
<simpara>This topic describes the elements of a watch and how watches operate.</simpara>
<bridgehead id="watch-definition" renderas="sect2">Watch Definition<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/how-watcher-works.asciidoc">Edit me</ulink></bridgehead>
<simpara>A watch consists of a <emphasis>trigger</emphasis>, <emphasis>input</emphasis>, <emphasis>condition</emphasis>, and <emphasis>actions</emphasis>. The actions
define what needs to be done once the condition is met. In addition, you can
define <emphasis>conditions</emphasis> and <emphasis>transforms</emphasis> to process and prepare the watch payload before
executing the actions.</simpara>
<variablelist>
<varlistentry>
<term>
<link linkend="trigger">Trigger</link>
</term>
<listitem>
<simpara>
Determines when the watch is checked. A watch must have a trigger.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<link linkend="input">Input</link>
</term>
<listitem>
<simpara>
Loads data into the watch payload. If no input is specified, an empty payload is
loaded.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<link linkend="condition">Condition</link>
</term>
<listitem>
<simpara>
Controls whether the watch actions are executed. If no condition is specified,
the condition defaults to <literal>always</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<link linkend="transform">Transform</link>
</term>
<listitem>
<simpara>
Processes the watch payload to prepare it for the watch actions. You can define
transforms at the watch level or define action-specific transforms. Optional.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<link linkend="actions">Actions</link>
</term>
<listitem>
<simpara>
Specify what happens when the watch condition is met.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<simpara id="watch-definition-example">For example, the following snippet shows a <link linkend="watcher-api-put-watch">Put Watch</link>
request that defines a watch that looks for log error events:</simpara>
<programlisting language="js" linenumbering="unnumbered">PUT _xpack/watcher/watch/log_errors
{
  "metadata" : { <co id="CO35-1"/>
    "color" : "red"
  },
  "trigger" : { <co id="CO35-2"/>
    "schedule" : {
      "interval" : "5m"
    }
  },
  "input" : { <co id="CO35-3"/>
    "search" : {
      "request" : {
        "indices" : "log-events",
        "body" : {
          "size" : 0,
          "query" : { "match" : { "status" : "error" } }
        }
      }
    }
  },
  "condition" : { <co id="CO35-4"/>
    "compare" : { "ctx.payload.hits.total" : { "gt" : 5 }}
  },
  "transform" : { <co id="CO35-5"/>
    "search" : {
        "request" : {
          "indices" : "log-events",
          "body" : {
            "query" : { "match" : { "status" : "error" } }
          }
        }
    }
  },
  "actions" : { <co id="CO35-6"/>
    "my_webhook" : {
      "webhook" : {
        "method" : "POST",
        "host" : "mylisteninghost",
        "port" : 9200,
        "path" : "/{{watch_id}}",
        "body" : "Encountered {{ctx.payload.hits.total}} errors"
      }
    },
    "email_administrator" : {
      "email" : {
        "to" : "sys.admino@host.domain",
        "subject" : "Encountered {{ctx.payload.hits.total}} errors",
        "body" : "Too many error in the system, see attached data",
        "attachments" : {
          "attached_data" : {
            "data" : {
              "format" : "json"
            }
          }
        },
        "priority" : "high"
      }
    }
  }
}</programlisting>
<remark> CONSOLE</remark>
<calloutlist>
<callout arearefs="CO35-1">
<para>
Metadata  - You can attach optional static metadata to a watch.
</para>
</callout>
<callout arearefs="CO35-2">
<para>
Trigger   - This schedule trigger executes the watch every 5 minutes.
</para>
</callout>
<callout arearefs="CO35-3">
<para>
Input     - This input searches for errors in the <literal>log-events</literal> index and
                loads the response into the watch payload.
</para>
</callout>
<callout arearefs="CO35-4">
<para>
Condition - This condition checks to see if there are more than 5 error
                events (hits in the search response). If there are, execution
                continues for all <literal>actions</literal>.
</para>
</callout>
<callout arearefs="CO35-5">
<para>
Transform - If the watch condition is met, this transform loads all of the
                errors into the watch payload by searching for the errors using
                the default search type, <literal>query_then_fetch</literal>. All of the watch
                actions have access to this payload.
</para>
</callout>
<callout arearefs="CO35-6">
<para>
Actions   - This watch has two actions. The <literal>my_webhook</literal> action notifies a
                3rd party system about the problem. The <literal>email_administrator</literal>
                action sends a high priority email to the system administrator.
                The watch payload that contains the errors is attached to the
                email.
</para>
</callout>
</calloutlist>
<bridgehead id="watch-execution" renderas="sect2">Watch Execution<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/how-watcher-works.asciidoc">Edit me</ulink></bridgehead>
<simpara id="schedule-scheduler">When you add a watch, Watcher immediately registers its trigger with the
appropriate trigger engine. Watches that have a <literal>schedule</literal> trigger are
registered with the <literal>scheduler</literal> trigger engine.</simpara>
<simpara>The scheduler tracks time and triggers watches according to their schedules.
The scheduler runs on the master node and is bound to the lifecycle of the
Watcher service. When the Watcher service is stopped, the scheduler
stops with it. Trigger engines use a separate thread pool from the one used
to execute watches.</simpara>
<simpara>When a watch is triggered, Watcher queues it up for execution. A <literal>watch_record</literal>
document is created and added to the watch history and the watch&#8217;s status is set
to <literal>awaits_execution</literal>.</simpara>
<simpara>When execution starts, Watcher creates a watch execution context for the watch.
The execution context provides scripts and templates with access to the watch
metadata, payload, watch ID, execution time, and trigger information. For more
information, see <link linkend="watch-execution-context">Watch Execution Context</link>.</simpara>
<simpara>During the execution process, Watcher:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Loads the input data as the payload in the watch execution context. This makes
  the data available to all subsequent steps in the execution process. This step
  is controlled by the input of the watch.
</simpara>
</listitem>
<listitem>
<simpara>
Evaluates the watch condition to determine whether or not to continue processing
  the watch. If the condition is met (evaluates to <literal>true</literal>), processing advances
  to the next step. If it is not met (evaluates to <literal>false</literal>), execution of the watch
  stops.
</simpara>
</listitem>
<listitem>
<simpara>
Applies transforms to the watch payload (if needed).
</simpara>
</listitem>
<listitem>
<simpara>
Executes the watch actions granted the condition is met and the watch is not
  <link linkend="watch-acknowledgment-throttling">throttled</link>.
</simpara>
</listitem>
</orderedlist>
<simpara>When the watch execution finishes, the execution result is recorded as a
<emphasis>Watch Record</emphasis> in the watch history. The watch record includes the execution
time and duration, whether the watch condition was met, and the status of each
action that was executed.</simpara>
<simpara>The following diagram shows the watch execution process:</simpara>
<informalfigure>
<mediaobject>
  <imageobject>
  <imagedata fileref="images/watcher/watch-execution.jpg" align="center"/>
  </imageobject>
  <textobject><phrase>watch-execution.jpg</phrase></textobject>
</mediaobject>
</informalfigure>
<bridgehead id="watch-acknowledgment-throttling" renderas="sect2">Watch Acknowledgment and Throttling<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/how-watcher-works.asciidoc">Edit me</ulink></bridgehead>
<simpara>Watcher supports both time-based and acknowledgment-based throttling. This
enables you to prevent actions from being repeatedly executed for the same event.</simpara>
<simpara>By default, Watcher uses time-based throttling with a throttle period of 5
seconds. This means that if a watch is executed every second, its actions are
performed a maximum of once every 5 seconds, even when the condition is always
met. You can configure the throttle period on a per-action basis or at the
watch level.</simpara>
<simpara>Acknowledgment-based throttling enables you to tell Watcher not to send any more
notifications about a watch as long as its condition is met. Once the condition
evaluates to <literal>false</literal>, the acknowledgment is cleared and Watcher resumes executing
the watch actions normally.</simpara>
<simpara>For more information, see <xref linkend="actions-ack-throttle"/>.</simpara>
<bridgehead id="watch-active-state" renderas="sect2">Watch Active State<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/how-watcher-works.asciidoc">Edit me</ulink></bridgehead>
<simpara>By default, when you add a watch it is immediately set to the <emphasis>active</emphasis> state,
registered with the appropriate trigger engine, and executed according
to its configured trigger.</simpara>
<simpara>You can also set a watch to the <emphasis>inactive</emphasis> state. Inactive watches are not
registered with a trigger engine and can never be triggered.</simpara>
<simpara>To set a watch to the inactive state when you create it, set the
<link linkend="watcher-api-put-watch-active-state"><literal>active</literal></link> parameter to <emphasis>inactive</emphasis>.
To deactivate an existing watch, use the <link linkend="watcher-api-deactivate-watch">D eactivate Watch API</link>. To reactivate an inactive watch, use the
<link linkend="watcher-api-activate-watch">Activate Watch API</link>.</simpara>
<note><simpara>You can use the <link linkend="watcher-api-execute-watch">Execute Watch API</link> to
        force the execution of a watch even when it is inactive.</simpara></note>
<simpara>Deactivating watches is useful in a variety of situations. For example, if you
have a watch that monitors an external system and you need to take that system
down for maintenance, you can deactivate the watch to prevent it from falsely
reporting availability issues during the maintenance window.</simpara>
<simpara>Deactivating a watch also enables you to keep it around for future use without
deleting it from the system.</simpara>
<bridgehead id="scripts-templates" renderas="sect2">Scripts and Templates<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/how-watcher-works.asciidoc">Edit me</ulink></bridgehead>
<simpara>You can use scripts and templates when defining a watch. Scripts and templates
can reference elements in the watch execution context, including the watch payload.
The execution context defines variables you can use in a script and parameter
placeholders in a template.</simpara>
<simpara>Watcher uses the Elasticsearch script infrastructure, which supports
<link linkend="inline-templates-scripts">inline</link>, <link linkend="stored-templates-scripts">stored</link>, and
<link linkend="file-templates-scripts">file-based scripts</link>. Scripts and templates are compiled
and cached by Elasticsearch to optimize recurring execution.
<ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/modules-scripting-using.html#reload-scripts">Autoloading</ulink> is also
supported. For more information, see <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/modules-scripting.html">Scripting</ulink>
in the Elasticsearch Reference.</simpara>
<bridgehead id="watch-execution-context" renderas="sect3">Watch Execution Context<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/how-watcher-works.asciidoc">Edit me</ulink></bridgehead>
<simpara>The following snippet shows the basic structure of the <emphasis>Watch Execution Context</emphasis>:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "ctx" : {
    "metadata" : { ... }, <co id="CO36-1"/>
    "payload" : { ... }, <co id="CO36-2"/>
    "watch_id" : "&lt;id&gt;", <co id="CO36-3"/>
    "execution_time" : "20150220T00:00:10Z", <co id="CO36-4"/>
    "trigger" : { <co id="CO36-5"/>
      "triggered_time" : "20150220T00:00:10Z",
      "scheduled_time" : "20150220T00:00:00Z"
    },
    "vars" : { ... } <co id="CO36-6"/>
}</programlisting>
<calloutlist>
<callout arearefs="CO36-1">
<para>
Any static metadata specified in the watch definition.
</para>
</callout>
<callout arearefs="CO36-2">
<para>
The current watch payload.
</para>
</callout>
<callout arearefs="CO36-3">
<para>
The id of the executing watch.
</para>
</callout>
<callout arearefs="CO36-4">
<para>
A timestamp that shows when the watch execution started.
</para>
</callout>
<callout arearefs="CO36-5">
<para>
Information about the trigger event. For a <literal>schedule</literal> trigger, this
    consists of the <literal>triggered_time</literal> (when the watch was triggered)
    and the <literal>scheduled_time</literal> (when the watch was scheduled to be triggered).
</para>
</callout>
<callout arearefs="CO36-6">
<para>
Dynamic variables that can be set and accessed by different constructs
    during the execution. These variables are scoped to a single execution
    (i.e they&#8217;re not persisted and can&#8217;t be used between different executions
    of the same watch)
</para>
</callout>
</calloutlist>
<bridgehead id="scripts" renderas="sect3">Using Scripts<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/how-watcher-works.asciidoc">Edit me</ulink></bridgehead>
<simpara>You can use scripts to define <link linkend="condition-script">conditions</link> and
<link linkend="transform-script">transforms</link>. The default scripting language is groovy.</simpara>
<note><simpara>Starting with 5.0, Elasticsearch is shipped with the new
      <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/modules-scripting-painless.html">Painless</ulink> scripting language.
      Painless was created and designed specifically for use in Elasticsearch.
      Beyond providing an extensive feature set, its biggest trait is that it&#8217;s
      properly sandboxed and safe to use anywhere in the system (including in
      Watcher) without the need to enable dynamic scripting.</simpara></note>
<simpara>Scripts can reference any of the values in the watch execution context or values
explicitly passed through script parameters.</simpara>
<simpara>For example, if the watch metadata contains a <literal>color</literal> field
(e.g. <literal>"metadata" : {"color": "red"}</literal>), you can access its value with the via the
<literal>ctx.metadata.color</literal> variable. If you pass in a <literal>color</literal>  parameter as part of the
condition or transform definition (e.g. <literal>"params" : {"color": "red"}</literal>), you can
access its value via the <literal>color</literal> variable.</simpara>
<bridgehead id="templates" renderas="sect3">Using Templates<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/how-watcher-works.asciidoc">Edit me</ulink></bridgehead>
<simpara>You use templates to define dynamic content for a watch. At execution time,
templates pull in data from the watch execution context. For example, you can use
a template to populate the <literal>subject</literal> field for an <literal>email</literal> action with data stored
in the watch payload. Templates can also access values explicitly passed through
template parameters.</simpara>
<simpara>You specify templates using the <ulink url="https://mustache.github.io">Mustache</ulink> scripting
language.</simpara>
<simpara>For example, the following snippet shows how templates enable dynamic subjects
in sent emails:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "actions" : {
    "email_notification" : {
      "email" : {
        "subject" : "{{ctx.metadata.color}} alert"
      }
    }
  }
}</programlisting>
<bridgehead id="inline-templates-scripts" renderas="sect4">Inline Templates and Scripts<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/how-watcher-works.asciidoc">Edit me</ulink></bridgehead>
<simpara>To define an inline template or script, you simply specify it directly in the
value of a field. For example, the following snippet configures the subject of
the <literal>email</literal> action using an inline template that references the <literal>color</literal> value in
the context metadata.</simpara>
<programlisting language="js" linenumbering="unnumbered">"actions" : {
  "email_notification" : {
     "email" : {
       "subject" : "{{ctx.metadata.color}} alert"
     }
   }
  }
}</programlisting>
<simpara>For a script, you simply specify the inline script as the value of the <literal>script</literal>
field. For example:</simpara>
<programlisting language="js" linenumbering="unnumbered">"condition" : {
  "script" : "return true"
}</programlisting>
<simpara>You can also explicitly specify the inline type by using a formal object
definition as the field value. For example:</simpara>
<programlisting language="js" linenumbering="unnumbered">"actions" : {
  "email_notification" : {
    "email" : {
      "subject" : {
         "inline" : "{{ctx.metadata.color}} alert"
      }
    }
  }
}</programlisting>
<simpara>The formal object definition for a script would be:</simpara>
<programlisting language="js" linenumbering="unnumbered">"condition" : {
  "script" : {
    "inline": "return true"
  }
}</programlisting>
<bridgehead id="stored-templates-scripts" renderas="sect4">Stored Templates and Scripts<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/how-watcher-works.asciidoc">Edit me</ulink></bridgehead>
<simpara>If you <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/modules-scripting-using.html#modules-scripting-stored-scripts">store</ulink>
your templates and scripts, you can reference them by id.</simpara>
<simpara>To reference a stored script or template, you use the formal object definition
and specify its id in the <literal>id</literal> field. For example, the following snippet
references the <literal>email_notification_subject</literal> template:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  ...
  "actions" : {
    "email_notification" : {
      "email" : {
        "subject" : {
          "id" : "email_notification_subject",
          "params" : {
            "color" : "red"
          }
        }
      }
    }
  }
}</programlisting>
<bridgehead id="file-templates-scripts" renderas="sect4">File-based Templates and Scripts<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/how-watcher-works.asciidoc">Edit me</ulink></bridgehead>
<simpara>If you store templates or scripts in the <literal>$ES_HOME/config/scripts</literal> directory, you
can reference them by name. Template files must be saved with the extension
<literal>.mustache</literal>. Script files must be saved with the appropriate file extension, such
as <literal>.groovy</literal>.</simpara>
<note><simpara>The <literal>config/scripts</literal> directory is scanned periodically for changes. New
        and changed templates and scripts are reloaded and deleted templates and
        scripts are removed from the preloaded scripts cache. For more information,
        see <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/modules-scripting-using.html#reload-scripts">Automatic Script
        Reloading</ulink> in the Elasticsearch Reference.</simpara></note>
<simpara>To reference a file-based stored or script, you use the formal object definition
and specify its name in the <literal>file</literal> field. For example, the following snippet
references the script file <literal>threshold_hits.groovy</literal>:</simpara>
<programlisting language="js" linenumbering="unnumbered">"condition" : {
    "script" : {
      "file" : "threshold_hits",
      "params" : {
        "threshold" : 0
      }
    }
  }</programlisting>
</chapter>
<chapter id="input">
<title>Inputs<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/input.asciidoc">Edit me</ulink></title>
<simpara>When a watch is triggered, its <emphasis>input</emphasis> loads data into the execution
context. This payload is accessible during the subsequent watch execution
phases. For example, you can base a watch&#8217;s condition on the data loaded by its
input.</simpara>
<simpara>Watcher supports four input types:</simpara>
<itemizedlist>
<listitem>
<simpara>
<link linkend="input-simple"><literal>simple</literal></link>: load static data into the execution context.
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="input-search"><literal>search</literal></link>: load the results of a search into the execution
context.
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="input-http"><literal>http</literal></link>: load the results of an HTTP request into the execution
context.
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="input-chain"><literal>chain</literal></link>: use a series of inputs to load data into the
execution context.
</simpara>
</listitem>
</itemizedlist>
<note><simpara>If you don&#8217;t define an input for a watch, an empty payload is loaded
      into the execution context.</simpara></note>
<section id="input-simple">
<title>Simple Input<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/input/simple.asciidoc">Edit me</ulink></title>
<simpara>Use the <literal>simple</literal> input to load static data into the execution
context when the watch is triggered. This enables you to store the data
centrally and reference it with templates.</simpara>
<simpara>You can define the static data as a string (<literal>str</literal>), numeric value (<literal>num</literal>), or
an object (<literal>obj</literal>):</simpara>
<programlisting language="js" linenumbering="unnumbered">"input" : {
  "simple" : {
    "str" : "val1",
    "num" : 23,
    "obj" : {
      "str" : "val2"
    }
  }
}</programlisting>
<simpara>For example, the following watch uses the <literal>simple</literal> input to set the recipient
name for a daily reminder email:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "trigger" : {
    "schedule" : {
      "daily" : { "at" : "noon" }
    }
  },
  "input" : {
    "simple" : {
      "name" : "John"
    }
  },
  "actions" : {
    "reminder_email" : {
      "email" : {
        "to" : "to@host.domain",
        "subject" : "Reminder",
        "body" : "Dear {{ctx.payload.name}}, by the time you read these lines, I'll be gone"
      }
    }
  }
}</programlisting>
</section>
<section id="input-search">
<title>Search Input<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/input/search.asciidoc">Edit me</ulink></title>
<simpara>Use the <literal>search</literal> input to load the results of an Elasticsearch search request
into the execution context when the watch is triggered. See
<link linkend="search-input-attributes">Search Input Attributes</link> for all of the
supported attributes.</simpara>
<simpara>In the search input&#8217;s <literal>request</literal> object, you specify:</simpara>
<itemizedlist>
<listitem>
<simpara>
The indices you want to search
</simpara>
</listitem>
<listitem>
<simpara>
The <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/search-request-search-type.html">search type</ulink>
</simpara>
</listitem>
<listitem>
<simpara>
The search request body
</simpara>
</listitem>
</itemizedlist>
<simpara>The search request body supports the full Elasticsearch Query DSL&#8212;it&#8217;s the
same as the body of an Elasticsearch <literal>_search</literal> request.</simpara>
<simpara>For example, the following input retrieves all <literal>event</literal>
documents from the <literal>logs</literal> index:</simpara>
<programlisting language="js" linenumbering="unnumbered">"input" : {
  "search" : {
    "request" : {
      "indices" : [ "logs" ],
      "types" : [ "event" ],
      "body" : {
        "query" : { "match_all" : {}}
      }
    }
  }
}</programlisting>
<simpara>You can use date math and wildcards when specifying indices. For example,
the following input loads the latest VIXZ quote from today&#8217;s daily quotes index:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "input" : {
    "search" : {
      "request" : {
        "indices" : [ "&lt;stock-quotes-{now/d}&gt;" ],
        "body" : {
          "size" : 1,
          "sort" : {
            "timestamp" : { "order" : "desc"}
          },
          "query" : {
            "term" : { "symbol" : "vix"}
          }
        }
      }
    }
  }
}</programlisting>
<section id="_extracting_specific_fields">
<title>Extracting Specific Fields<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/input/search.asciidoc">Edit me</ulink></title>
<simpara>You can specify which fields in the search response you want to load into the
watch payload with the <literal>extract</literal> attribute. This is useful when a search
generates a large response and you are only interested in particular fields.</simpara>
<simpara>For example, the following input loads only the total number of hits into the
watch payload:</simpara>
<programlisting language="js" linenumbering="unnumbered">"input": {
    "search": {
      "request": {
        "indices": [ ".watcher-history*" ]
      },
      "extract": [ "hits.total" ]
    }
  },</programlisting>
</section>
<section id="_using_templates">
<title>Using Templates<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/input/search.asciidoc">Edit me</ulink></title>
<simpara>The <literal>search</literal> input supports <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/search-template.html">search templates</ulink>. For
example, the following snippet references the indexed template called
<literal>my_template</literal> and passes a value of 23 to fill in the template&#8217;s <literal>value</literal>
parameter:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "input" : {
    "search" : {
      "request" : {
        "indices" : [ "logs" ],
        "template" : {
          "id" : "my_template",
          "params" : {
            "value" : 23
          }
        }
      }
    }
  }
  ...
}</programlisting>
</section>
<section id="_applying_conditions">
<title>Applying Conditions<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/input/search.asciidoc">Edit me</ulink></title>
<simpara>The <literal>search</literal> input is often used in conjunction with the <link linkend="condition-script"><literal>script</literal></link> condition. For example, the following snippet adds a condition to
check if the search returned more than five hits:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "input" : {
    "search" : {
      "request" : {
        "indices" : [ "logs" ],
        "body" : {
          "query" : { "match_all" : {} }
        }
      }
    }
  },
  "condition" : {
    "compare" : { "ctx.payload.hits.total" : { "gt" : 5 }}
  }
  ...
}</programlisting>
</section>
<section id="_accessing_the_search_results">
<title>Accessing the Search Results<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/input/search.asciidoc">Edit me</ulink></title>
<simpara>Conditions, transforms, and actions can access the search results through the
watch execution context. For example:</simpara>
<itemizedlist>
<listitem>
<simpara>
To load all of the search hits into an email body, use <literal>ctx.payload.hits</literal>.
</simpara>
</listitem>
<listitem>
<simpara>
To reference the total number of hits, use <literal>ctx.payload.hits.total</literal>.
</simpara>
</listitem>
<listitem>
<simpara>
To access a particular hit, use its zero-based array index. For example, to
  get the third hit, use <literal>ctx.payload.hits.hits.2</literal>.
</simpara>
</listitem>
<listitem>
<simpara>
To get a field value from a particular hit, use
  <literal>ctx.payload.hits.hits.&lt;index&gt;.fields.&lt;fieldname&gt;</literal>. For example, to get the
  message field from the first hit, use <literal>ctx.payload.hits.hits.0.fields.message</literal>.
</simpara>
</listitem>
</itemizedlist>
</section>
<section id="search-input-attributes">
<title>Search Input Attributes<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/input/search.asciidoc">Edit me</ulink></title>
<informaltable
frame="all"
rowsep="1" colsep="1"
>
<tgroup cols="4">
<colspec colname="col_1" colwidth="25*"/>
<colspec colname="col_2" colwidth="25*"/>
<colspec colname="col_3" colwidth="25*"/>
<colspec colname="col_4" colwidth="25*"/>
<thead>
<row>
<entry align="left" valign="top"> Name                                          </entry>
<entry align="center" valign="top">Required   </entry>
<entry align="left" valign="top"> Default             </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>request.search_type</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara><literal>query_then_fetch</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/search-request-search-type.html#search-request-search-type">type</ulink>
                                                                                    of search request to perform. Valid values are: <literal>dfs_query_and_fetch</literal>,
                                                                                    <literal>dfs_query_then_fetch</literal>, <literal>query_and_fetch</literal>, and <literal>query_then_fetch</literal>. The
                                                                                    Elasticsearch default is <literal>query_then_fetch</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request.indices</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The indices to search. If omitted, all indices are searched, which is the
                                                                                    default behaviour in Elasticsearch.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request.types</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The document types to search for. If omitted, all document types are are
                                                                                    searched, which is the default behaviour in Elasticsearch.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request.body</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The body of the request. The <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/search-request-body.html">request body</ulink>
                                                                                    follows the same structure you normally send in the body of a REST <literal>_search</literal>
                                                                                    request. The body can be static text or include <literal>mustache</literal> <link linkend="templates">templates</link>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request.template</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The body of the search template. See <link linkend="templates">configure templates</link>
                                                                                    for more information.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request.indices_options.expand_wildcards</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara><literal>open</literal></simpara></entry>
<entry align="left" valign="top"><simpara>How to expand wildcards. Valid values are: <literal>all</literal>, <literal>open</literal>, <literal>closed</literal>, and <literal>none</literal>
                                                                                    See <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/multi-index.html#multi-index"><literal>expand_wildcards</literal></ulink> for more information.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request.indices_options.ignore_unavailable</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara><literal>true</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Whether the search should ignore unavailable indices. See
                                                                                    <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/multi-index.html#multi-index"><literal>ignore_unavailable</literal></ulink> for more information.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request.indices_options.allow_no_indices</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara><literal>true</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Whether to allow a search where a wildcard indices expression results in no
                                                                                    concrete indices. See <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/multi-index.html#multi-index">allow_no_indices</ulink>
                                                                                    for more information.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>extract</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>A array of JSON keys to extract from the search response and load as the payload.
                                                                                    When a search generates a large response, you can use <literal>extract</literal> to select the
                                                                                    relevant fields instead of loading the entire response.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>timeout</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>30s</simpara></entry>
<entry align="left" valign="top"><simpara>The timeout for waiting for the search api call to return. If no response is
                                                                                    returned within this time, the search input times out and fails. This setting
                                                                                    overrides the default search operations timeouts.</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
<simpara>You can reference the following variables in the execution context when
specifying the request <literal>body</literal>:</simpara>
<informaltable
frame="all"
rowsep="1" colsep="1"
>
<tgroup cols="2">
<colspec colname="col_1" colwidth="50*"/>
<colspec colname="col_2" colwidth="50*"/>
<thead>
<row>
<entry align="left" valign="top"> Name                         </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>ctx.watch_id</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The id of the watch that is currently executing.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ctx.execution_time</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The time execution of this watch started.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ctx.trigger.triggered_time</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The time this watch was triggered.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ctx.trigger.scheduled_time</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The time this watch was supposed to be triggered.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ctx.metadata.*</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Any metadata associated with the watch.</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
</section>
</section>
<section id="input-http">
<title>HTTP Input<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/input/http.asciidoc">Edit me</ulink></title>
<simpara>Use the <literal>http</literal> input to submit a request to an HTTP endpoint and load the
response into the watch execution context when the watch is triggered. See
<link linkend="http-input-attributes">Input Attributes</link> for all of the supported attributes.</simpara>
<simpara>With the <literal>http</literal> input, you can:</simpara>
<itemizedlist>
<listitem>
<simpara>
Query external Elasticsearch clusters. The <literal>http</literal> input provides a way
  to submit search requests to clusters other than the one Watcher is running
  on. This is useful when you&#8217;re running a dedicated Watcher cluster or if you
  need to search clusters that are running different Elasticsearch versions.
</simpara>
</listitem>
<listitem>
<simpara>
Query Elasticsearch APIs other than the search API. For example, you might want
  to load data from the <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/cluster-nodes-stats.html">Nodes Stats</ulink>,
  <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/cluster-health.html">Cluster Health</ulink> or <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/cluster-state.html">Cluster
  State</ulink> APIs.
</simpara>
</listitem>
<listitem>
<simpara>
Query external web services. The <literal>http</literal> input enables you to load data from
  any service that exposes an HTTP endpoint. This provides a bridge
  between Elasticsearch clusters and other systems.
</simpara>
</listitem>
</itemizedlist>
<section id="_querying_external_elasticsearch_clusters">
<title>Querying External Elasticsearch Clusters<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/input/http.asciidoc">Edit me</ulink></title>
<simpara>To query an external Elasticsearch cluster, you specify the cluster&#8217;s
<literal>host</literal> and <literal>port</literal> attributes and the index&#8217;s search endpoint as the <literal>path</literal>.
If you omit the search body, the request returns all documents in the specified
index:</simpara>
<programlisting language="js" linenumbering="unnumbered">"input" : {
  "http" : {
    "request" : {
      "host" : "example.com",
      "port" : 9200,
      "path" : "/idx/_search"
    }
  }
}</programlisting>
<simpara>You can use the full Elasticsearch <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/query-dsl.html">Query DSL</ulink> to perform
more sophisticated searches. For example, the following <literal>http</literal> input retrieves
all documents that contain <literal>event</literal> in the <literal>category</literal> field:</simpara>
<programlisting language="js" linenumbering="unnumbered">"input" : {
  "http" : {
    "request" : {
      "host" : "host.domain",
      "port" : 9200,
      "path" : "/idx/_search",
      "body" :  "{\"query\" :  {  \"match\" : { \"category\" : \"event\"}}}"
    }
  }
}</programlisting>
</section>
<section id="_calling_elasticsearch_apis">
<title>Calling Elasticsearch APIs<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/input/http.asciidoc">Edit me</ulink></title>
<simpara>To load the data from other Elasticsearch APIs, specify the API
endpoint as the <literal>path</literal> attribute. Use the <literal>params</literal> attribute to specify
query string parameters. For example, the following <literal>http</literal> input
calls the <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/cluster-stats.html">Cluster
Stats</ulink> API and enables the <literal>human</literal> attribute:</simpara>
<programlisting language="js" linenumbering="unnumbered">"input" : {
  "http" : {
    "request" : {
      "host" : "host.domain",
      "port" : "9200",
      "path" : "/_cluster/stats",
      "params" : {
        "human" : "true" <co id="CO37-1"/>
      }
    }
  }
}</programlisting>
<calloutlist>
<callout arearefs="CO37-1">
<para>
Enabling this attribute returns the <literal>bytes</literal> values in the response in human
    readable format.
</para>
</callout>
</calloutlist>
</section>
<section id="input-http-auth-basic-example">
<title>Calling External Web Services<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/input/http.asciidoc">Edit me</ulink></title>
<simpara>You can use <literal>http</literal> input to get data from any external web service. The <literal>http</literal>
input supports basic authentication. For example, the following input provides
a username and password to access <literal>myservice</literal>:</simpara>
<programlisting language="js" linenumbering="unnumbered">"input" : {
  "http" : {
    "request" : {
      "host" : "host.domain",
      "port" : "9200",
      "path" : "/myservice",
      "auth" : {
        "basic" : {
          "username" : "user",
          "password" : "pass"
        }
      }
    }
  }
}</programlisting>
<simpara>You can also pass in service-specific API keys and other information
through the <literal>params</literal> attribute. For example, the following <literal>http</literal>
input loads the current weather forecast for Amsterdam from the
<ulink url="http://openweathermap.org/appid">OpenWeatherMap</ulink> service:</simpara>
<programlisting language="js" linenumbering="unnumbered">"input" : {
  "http" : {
    "request" : {
      "url" : "http://api.openweathermap.org/data/2.5/weather",
      "params" : {
        "lat" : "52.374031",
        "lon" : "4.88969",
        "appid" : "&lt;your openweathermap appid&gt;"
      }
    }
  }
}</programlisting>
</section>
<section id="_using_templates_2">
<title>Using Templates<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/input/http.asciidoc">Edit me</ulink></title>
<simpara>The <literal>http</literal> input supports templating. You can use <link linkend="templates">templates</link> when
specifying the <literal>path</literal>, <literal>body</literal>, header values, and parameter values.</simpara>
<simpara>For example, the following snippet uses templates to specify what index to query
and restrict the results to documents added within the last five minutes:</simpara>
<programlisting language="js" linenumbering="unnumbered">"input" : {
  "http" : {
    "request" : {
      "host" : "host.domain",
      "port" : 9200,
      "path" : "/{{ctx.watch_id}}/_search",
      "body" : "{\"query\" : {\"range\": {\"@timestamp\" : {\"from\": \"{{ctx.trigger.triggered_time}}||-5m\",\"to\": \"{{ctx.trigger.triggered_time}}\"}}}}"
      }
    }
  }</programlisting>
</section>
<section id="_accessing_the_http_response">
<title>Accessing the HTTP Response<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/input/http.asciidoc">Edit me</ulink></title>
<simpara>If the response body is formatted in  JSON or YAML, it is parsed and loaded into
the execution context. If the response body is not formatted in JSON or YAML, it
is loaded into the payload&#8217;s <literal>_value</literal> field.</simpara>
<simpara>Conditions, transforms, and actions access the response data through the
execution context. For example, if the response contains a <literal>message</literal>
object, you can use <literal>ctx.payload.message</literal> to access the message data.</simpara>
<simpara>In addition all the headers from the response can be accessed using the
<literal>ctx.payload._headers</literal> field as well as the HTTP status code of the response using
<literal>ctx.payload._status_code</literal>.</simpara>
</section>
<section id="http-input-attributes">
<title>HTTP Input Attributes<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/input/http.asciidoc">Edit me</ulink></title>
<informaltable
frame="all"
rowsep="1" colsep="1"
>
<tgroup cols="4">
<colspec colname="col_1" colwidth="25*"/>
<colspec colname="col_2" colwidth="25*"/>
<colspec colname="col_3" colwidth="25*"/>
<colspec colname="col_4" colwidth="25*"/>
<thead>
<row>
<entry align="left" valign="top"> Name                          </entry>
<entry align="center" valign="top"> Required </entry>
<entry align="center" valign="top"> Default </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>request.scheme</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="center" valign="top"><simpara>http</simpara></entry>
<entry align="left" valign="top"><simpara>Url scheme. Valid values are: <literal>http</literal> or <literal>https</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request.host</literal></simpara></entry>
<entry align="center" valign="top"><simpara>yes</simpara></entry>
<entry align="center" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The host to connect to.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request.port</literal></simpara></entry>
<entry align="center" valign="top"><simpara>yes</simpara></entry>
<entry align="center" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The port the http service is listening on.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request.path</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="center" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The URL path. The path can be static text or contain <literal>mustache</literal>
                                                       <link linkend="templates">templates</link>. URL query string parameters must be
                                                       specified via the <literal>request.params</literal> attribute.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request.method</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="center" valign="top"><simpara>get</simpara></entry>
<entry align="left" valign="top"><simpara>The HTTP method. Supported values are: <literal>head</literal>, <literal>get</literal>, <literal>post</literal>,
                                                       <literal>put</literal> and <literal>delete</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request.headers</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="center" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The HTTP request headers. The header values can be static text
                                                       or include <literal>mustache</literal> <link linkend="templates">templates</link>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request.params</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="center" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The URL query string parameters. The parameter values can be
                                                       static text or contain <literal>mustache</literal> <link linkend="templates">templates</link>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request.url</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="center" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>Allows you to set <literal>request.scheme</literal>, <literal>request.host</literal>, <literal>request.port</literal>
                                                       and <literal>request.params</literal> add once by specifying a real URL, like
                                                       <literal>https://www.example.org:1234/mypath?foo=bar</literal>. May not be combined
                                                       with on of those four parameters. As those parameters are set,
                                                       specifying them individually might overwrite them.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request.auth</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="center" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>Authentication related HTTP headers. Currently, only basic
                                                       authentication is supported.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request.proxy.host</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="center" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The proxy host to use when connecting to the host.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request.proxy.port</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="center" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The proxy port to use when connecting to the host.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request.connection_timeout</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="center" valign="top"><simpara>10s</simpara></entry>
<entry align="left" valign="top"><simpara>The timeout for setting up the http connection. If the connection
                                                       could not be set up within this time, the input will timeout and
                                                       fail.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request.read_timeout</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="center" valign="top"><simpara>10s</simpara></entry>
<entry align="left" valign="top"><simpara>The timeout for reading data from http connection. If no response
                                                       was received within this time, the input will timeout and fail.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request.body</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="center" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The HTTP request body. The body can be static text or include
                                                       <literal>mustache</literal> <link linkend="templates">templates</link>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>extract</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="center" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>A array of JSON keys to extract from the input response and
                                                       use as payload. In cases when an input generates a large
                                                       response this can be used to filter the relevant piece of
                                                       the response to be used as payload.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>response_content_type</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="center" valign="top"><simpara>json</simpara></entry>
<entry align="left" valign="top"><simpara>The expected content type the response body will contain.
                                                       Supported values are <literal>json</literal>, <literal>yaml</literal> and <literal>text</literal>. If the
                                                       format is <literal>text</literal> the <literal>extract</literal> attribute cannot exist.
                                                       Note that this overrides the header that is returned in the
                                                       HTTP response. If this is set to <literal>text</literal> the body of the
                                                       response will be assigned and accessible to/via the <literal>_value</literal>
                                                       variable of the payload.</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
<simpara>You can reference the following variables in the execution context when
specifying the <literal>path</literal>, <literal>params</literal>, <literal>headers</literal> and <literal>body</literal> values:</simpara>
<informaltable
frame="all"
rowsep="1" colsep="1"
>
<tgroup cols="2">
<colspec colname="col_1" colwidth="50*"/>
<colspec colname="col_2" colwidth="50*"/>
<thead>
<row>
<entry align="left" valign="top"> Name                         </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>ctx.watch_id</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The id of the watch that is currently executing.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ctx.execution_time</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The time execution of this watch started.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ctx.trigger.triggered_time</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The time this watch was triggered.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ctx.trigger.scheduled_time</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The time this watch was supposed to be triggered.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ctx.metadata.*</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Any metadata associated with the watch.</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
</section>
</section>
<section id="input-chain">
<title>Chain Input<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/input/chain.asciidoc">Edit me</ulink></title>
<simpara>Use the <literal>chain</literal> input to load data from multiple sources into the watch
execution context when the watch is triggered. The inputs in a chain
are processed in order and the data loaded by an input can be accessed by the
subsequent inputs in the chain.</simpara>
<simpara>The <literal>chain</literal> input enables you perform actions based on data from multiple
sources. You can also use the data collected by one input to load data
from another source.</simpara>
<simpara>For example, the following chain input loads data from an HTTP server using the
path set by a <literal>simple</literal> input:</simpara>
<programlisting language="js" linenumbering="unnumbered">"input" : {
  "chain" : {
    "inputs" : [ <co id="CO38-1"/>
      {
        "first" : {
          "simple" : { "path" : "/_search" }
        }
      },
      {
        "second" : {
          "http" : {
            "request" : {
              "host" : "localhost",
              "port" : 9200,
              "path" : "{{ctx.payload.first.path}}" <co id="CO38-2"/>
            }
          }
        }
      }
    ]
  }
}</programlisting>
<calloutlist>
<callout arearefs="CO38-1">
<para>
The inputs in a chain are specified as an array to guarantee the order in
    which the inputs are processed. (JSON does not guarantee the order of
    arbitrary objects.)
</para>
</callout>
<callout arearefs="CO38-2">
<para>
Loads the <literal>path</literal> set by the <literal>first</literal> input.
</para>
</callout>
</calloutlist>
<section id="_accessing_chained_input_data">
<title>Accessing Chained Input Data<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/input/chain.asciidoc">Edit me</ulink></title>
<simpara>To reference data loaded by a particular input, you use the input&#8217;s name,
<literal>ctx.payload.&lt;input-name&gt;.&lt;value&gt;</literal>.</simpara>
</section>
</section>
</chapter>
<chapter id="trigger">
<title>Triggers<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/trigger.asciidoc">Edit me</ulink></title>
<simpara>Every watch must have a <literal>trigger</literal> that defines when the watch execution process
should start. When you create a watch, its trigger is registered with the
appropriate <emphasis>Trigger Engine</emphasis>. The trigger engine is responsible for evaluating
the trigger and triggering the watch when needed.</simpara>
<simpara>Watcher is designed to support different types of triggers, but only time-based
<link linkend="trigger-schedule"><literal>schedule</literal></link> triggers are currently available.</simpara>
<section id="trigger-schedule">
<title>Schedule Trigger<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/trigger/schedule.asciidoc">Edit me</ulink></title>
<simpara>Schedule <link linkend="trigger">triggers</link> define when the watch execution should start based
on date and time. All times are specified in UTC time.</simpara>
<simpara>Watcher uses the system clock to determine the current time. To ensure schedules
are triggered when expected, you should synchronize the clocks of all nodes in the
cluster using a time service such as <ulink url="http://www.ntp.org/">NTP</ulink>.</simpara>
<simpara>Keep in mind that the throttle period can affect when a watch is actually executed.
The default throttle period is five seconds (5000 ms). If you configure a schedule
that&#8217;s more frequent than the throttle period, the throttle period overrides the
schedule. For example, if you set the throttle period to one minute (60000 ms)
and set the schedule to every 10 seconds, the watch is executed no more than
once per minute. For more information about throttling, see
<link linkend="actions-ack-throttle">Acknowledgement and Throttling</link>.</simpara>
<simpara>Watcher provides several types of schedule triggers:</simpara>
<itemizedlist>
<listitem>
<simpara>
<link linkend="schedule-hourly"><literal>hourly</literal></link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="schedule-daily"><literal>daily</literal></link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="schedule-weekly"><literal>weekly</literal></link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="schedule-monthly"><literal>monthly</literal></link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="schedule-yearly"><literal>yearly</literal></link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="schedule-cron"><literal>cron</literal></link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="schedule-interval"><literal>interval</literal></link>
</simpara>
</listitem>
</itemizedlist>
<section id="schedule-hourly">
<title>Hourly Schedule<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/trigger/schedule/hourly.asciidoc">Edit me</ulink></title>
<simpara>A <link linkend="trigger-schedule"><literal>schedule</literal></link> that triggers at a particular minute every
hour of the day. To use the <literal>hourly</literal> schedule, you specify the minute (or minutes)
when you want the scheduler to start the watch execution with the <literal>minute</literal>
attribute.</simpara>
<note><simpara>If you don&#8217;t specify the <literal>minute</literal> attribute for an <literal>hourly</literal> schedule, it
      defaults to <literal>0</literal> and the schedule triggers on the hour every hour--<literal>12:00</literal>,
      <literal>13:00</literal>, <literal>14:00</literal>, and so on.</simpara></note>
<section id="_configuring_a_once_an_hour_schedule">
<title>Configuring a Once an Hour Schedule<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/trigger/schedule/hourly.asciidoc">Edit me</ulink></title>
<simpara>To configure a once an hour schedule, you specify a single time with the <literal>minute</literal>
attribute.</simpara>
<simpara>For example, the following <literal>hourly</literal> schedule triggers at minute 30 every hour--
<literal>12:30</literal>, <literal>13:30</literal>, <literal>14:30</literal>, &#8230;:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "trigger" : {
    "schedule" : {
      "hourly" : { "minute" : 30 }
    }
  }
}</programlisting>
</section>
<section id="_configuring_a_multiple_times_hourly_schedule">
<title>Configuring a Multiple Times Hourly Schedule<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/trigger/schedule/hourly.asciidoc">Edit me</ulink></title>
<simpara>To configure an <literal>hourly</literal> schedule that triggers at multiple times during the
hour, you specify an array of minutes. For example, the following schedule
triggers every 15 minutes every hour--<literal>12:00</literal>, <literal>12:15</literal>, <literal>12:30</literal>, <literal>12:45</literal>,
<literal>1:00</literal>, <literal>1:15</literal>, &#8230;:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "trigger" : {
    "schedule" : {
      "hourly" : { "minute" : [ 0, 15, 30, 45 ] }
    }
  }
}</programlisting>
</section>
</section>
<section id="schedule-daily">
<title>Daily Schedule<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/trigger/schedule/daily.asciidoc">Edit me</ulink></title>
<simpara>A <link linkend="trigger-schedule"><literal>schedule</literal></link> that triggers at a particular time
every day. To use the <literal>daily</literal> schedule, you specify the time of day (or times)
when you want the scheduler to start the watch execution with the <literal>at</literal> attribute.</simpara>
<simpara>Times are specified in the form <literal>HH:mm</literal> on a 24-hour clock. You can also use the
reserved values <literal>midnight</literal> and <literal>noon</literal> for <literal>00:00</literal> and <literal>12:00</literal>, and
<link linkend="specifying-times-using-objects">specify times using objects</link>.</simpara>
<note><simpara>If you don&#8217;t specify the <literal>at</literal> attribute for a <literal>daily</literal> schedule, it defaults
      to firing once daily at midnight, <literal>00:00</literal>.</simpara></note>
<section id="_configuring_a_daily_schedule">
<title>Configuring a Daily Schedule<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/trigger/schedule/daily.asciidoc">Edit me</ulink></title>
<simpara>To configure a once a day schedule, you specify a single time with the <literal>at</literal>
attribute. For example, the following <literal>daily</literal> schedule triggers once every
day at 5:00 PM:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "trigger" : {
    "schedule" : {
      "daily" : { "at" : "17:00" }
    }
  }
}</programlisting>
</section>
<section id="_configuring_a_multiple_times_daily_schedule">
<title>Configuring a Multiple Times Daily Schedule<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/trigger/schedule/daily.asciidoc">Edit me</ulink></title>
<simpara>To configure a <literal>daily</literal> schedule that triggers at multiple times during the day,
you specify an array of times. For example, the following <literal>daily</literal> schedule
triggers at <literal>00:00</literal>, <literal>12:00</literal>, and <literal>17:00</literal> every day.</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "trigger" : {
    "schedule" : {
      "daily" : { "at" : [ "midnight", "noon", "17:00" ] }
    }
  }
}</programlisting>
</section>
<section id="specifying-times-using-objects">
<title>Specifying Times Using Objects<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/trigger/schedule/daily.asciidoc">Edit me</ulink></title>
<simpara>In addition to using the <literal>HH:mm</literal> string syntax to specify times, you can specify
a time as an object that has <literal>hour</literal> and <literal>minute</literal> attributes.</simpara>
<simpara>For example, the following <literal>daily</literal> schedule triggers once every day at 5:00 PM:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "trigger" : {
    "schedule" : {
      "daily" : {
        "at" {
          "hour" : 17,
          "minute" : 0
        }
      }
    }
  }
}</programlisting>
<simpara>To specify multiple times using the object notation, you specify multiple hours
or minutes as an array. For example, following <literal>daily</literal> schedule triggers at
<literal>00:00</literal>, <literal>00:30</literal>, <literal>12:00</literal>, <literal>12:30</literal>, <literal>17:00</literal> and <literal>17:30</literal> every day:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "trigger" : {
    "schedule" : {
      "daily" : {
        "at" {
          "hour" : [ 0, 12, 17 ],
          "minute" : [0, 30]
        }
      }
    }
  }
}</programlisting>
</section>
</section>
<section id="schedule-weekly">
<title>Weekly Schedule<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/trigger/schedule/weekly.asciidoc">Edit me</ulink></title>
<simpara>A <link linkend="trigger-schedule"><literal>schedule</literal></link> that triggers at a specific day and time
every week. To use the <literal>weekly</literal> schedule, you specify the day and time (or days
and times) when you want the scheduler to start the watch execution with the <literal>on</literal>
and <literal>at</literal> attributes.</simpara>
<simpara>You can specify the day of the week by name, abbreviation, or number (with Sunday
being the first day of the week):</simpara>
<itemizedlist>
<listitem>
<simpara>
<literal>sunday</literal>, <literal>monday</literal>, <literal>tuesday</literal>, <literal>wednesday</literal>, <literal>thursday</literal>, <literal>friday</literal> and <literal>saturday</literal>
</simpara>
</listitem>
<listitem>
<simpara>
<literal>sun</literal>, <literal>mon</literal>, <literal>tue</literal>, <literal>wed</literal>, <literal>thu</literal>, <literal>fri</literal> and <literal>sat</literal>
</simpara>
</listitem>
<listitem>
<simpara>
<literal>1</literal>, <literal>2</literal>, <literal>3</literal>, <literal>4</literal>, <literal>5</literal>, <literal>6</literal> and <literal>7</literal>
</simpara>
</listitem>
</itemizedlist>
<simpara>Times are specified in the form <literal>HH:mm</literal> on a 24-hour clock. You can also use the
reserved values <literal>midnight</literal> and <literal>noon</literal> for <literal>00:00</literal> and <literal>12:00</literal>.</simpara>
<section id="_configuring_a_weekly_schedule">
<title>Configuring a Weekly Schedule<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/trigger/schedule/weekly.asciidoc">Edit me</ulink></title>
<simpara>To configure a once a week schedule, you specify the day with the <literal>on</literal> attribute
and the time with the <literal>at</literal> attribute. For example, the following <literal>weekly</literal> schedule
triggers once a week on Friday at 5:00 PM:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "trigger" : {
    "schedule" : {
      "weekly" : { "on" : "friday", "at" : "17:00" }
    }
  }
}</programlisting>
<note><simpara>You can also specify the day and time with the <literal>day</literal> and <literal>time</literal> attributes,
      they are interchangeable with <literal>on</literal> and <literal>at</literal>.</simpara></note>
</section>
<section id="_configuring_a_multiple_times_weekly_schedule">
<title>Configuring a Multiple Times Weekly Schedule<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/trigger/schedule/weekly.asciidoc">Edit me</ulink></title>
<simpara>To configure a <literal>weekly</literal> schedule that triggers multiple times a week, you can
specify an array of day and time values. For example, the following <literal>weekly</literal>
schedule triggers every Tuesday at 12:00 PM and every Friday at 5:00 PM:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "trigger" : {
    "schedule" : {
      "weekly" : [
        { "on" : "tuesday", "at" : "noon" },
        { "on" : "friday", "at" : "17:00" }
      ]
    }
  }
}</programlisting>
<simpara>Alternatively, you can specify days and times in an object that has <literal>on</literal> and
<literal>minute</literal> attributes that contain an array of values. For example, the following
<literal>weekly</literal> schedule triggers every Tuesday and Friday at 12:00 PM and 17:00 PM:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "trigger" : {
    "schedule" : {
      "weekly" : {
        "on" : [ "tuesday", "friday" ],
        "at" : [ "noon", "17:00" ]
      }
    }
  }
}</programlisting>
</section>
</section>
<section id="schedule-monthly">
<title>Monthly Schedule<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/trigger/schedule/monthly.asciidoc">Edit me</ulink></title>
<simpara>A <link linkend="trigger-schedule"><literal>schedule</literal></link> that triggers at a specific day and time
every month. To use the <literal>monthly</literal> schedule, you specify the day of the month and
time (or days and times) when you want the scheduler to start the watch execution
with the <literal>on</literal> and <literal>at</literal> attributes.</simpara>
<simpara>You specify the day of month as a numeric value between <literal>1</literal> and <literal>31</literal> (inclusive).
Times are specified in the form <literal>HH:mm</literal> on a 24-hour clock. You can also use the
reserved values <literal>midnight</literal> and <literal>noon</literal> for <literal>00:00</literal> and <literal>12:00</literal>.</simpara>
<section id="_configuring_a_monthly_schedule">
<title>Configuring a Monthly Schedule<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/trigger/schedule/monthly.asciidoc">Edit me</ulink></title>
<simpara>To configure a once a month schedule, you specify a single day and time with the
<literal>on</literal> and <literal>at</literal> attributes. For example, the following <literal>monthly</literal> schedule triggers
on the 10th of each month at noon:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "trigger" : {
    "schedule" : {
      "monthly" : { "on" : 10, "at" : "noon" }
    }
  }
}</programlisting>
<note><simpara>You can also specify the day and time with the <literal>day</literal> and <literal>time</literal> attributes,
      they are interchangeable with <literal>on</literal> and <literal>at</literal>.</simpara></note>
</section>
<section id="_configuring_a_multiple_times_monthly_schedule">
<title>Configuring a Multiple Times Monthly Schedule<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/trigger/schedule/monthly.asciidoc">Edit me</ulink></title>
<simpara>To configure a <literal>monthly</literal> schedule that triggers multiple times a month, you can
specify an array of day and time values. For example, the following <literal>monthly</literal>
schedule triggers at 12:00 PM on the 10th of each month and at 5:00 PM on the
20th of each month:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "trigger" : {
    "schedule" : {
      "monthly" : [
        { "on" : 10, "at" : "noon" },
        { "on" : 20, "at" : "17:00" }
      ]
    }
  }
}</programlisting>
<simpara>Alternatively, you can specify days and times in an object that has <literal>on</literal> and <literal>at</literal>
attributes that contain an array of values. For example, the following <literal>monthly</literal>
schedule triggers at 12:00 AM and 12:00 PM on the 10th and 20th of each month.</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "trigger" : {
    "schedule" : {
      "monthly" : {
        "on" : [ 10, 20 ],
        "at" : [ "midnight", "noon" ]
      }
    }
  }
}</programlisting>
</section>
</section>
<section id="schedule-yearly">
<title>Yearly Schedule<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/trigger/schedule/yearly.asciidoc">Edit me</ulink></title>
<simpara>A <link linkend="trigger-schedule"><literal>schedule</literal></link> that triggers at a specific day and time
every year. To use the <literal>yearly</literal> schedule, you specify the month, day, and time
(or months, days, and times) when you want the scheduler to start the watch
execution with the <literal>in</literal>, <literal>on</literal>, and <literal>at</literal> attributes.</simpara>
<simpara>You can specify the month by name, abbreviation, or number:</simpara>
<itemizedlist>
<listitem>
<simpara>
<literal>january</literal>, <literal>february</literal>, <literal>march</literal>, <literal>april</literal>, <literal>may</literal>, <literal>june</literal>, <literal>july</literal>,
  <literal>august</literal>, <literal>september</literal>, <literal>october</literal>, <literal>november</literal> and <literal>december</literal>
</simpara>
</listitem>
<listitem>
<simpara>
<literal>jan</literal>, <literal>feb</literal>, <literal>mar</literal>, <literal>apr</literal>, <literal>may</literal>, <literal>jun</literal>, <literal>jul</literal>, <literal>aug</literal>,
  <literal>sep</literal>, <literal>oct</literal>, <literal>nov</literal> and <literal>dec</literal>
</simpara>
</listitem>
<listitem>
<simpara>
<literal>1</literal>, <literal>2</literal>, <literal>3</literal>, <literal>4</literal>, <literal>5</literal>, <literal>6</literal>, <literal>7</literal>, <literal>8</literal>, <literal>9</literal>, <literal>10</literal>, <literal>11</literal> and <literal>12</literal>
</simpara>
</listitem>
</itemizedlist>
<simpara>You specify the day of month as a numeric value between <literal>1</literal> and <literal>31</literal> (inclusive).
The Times are specified in the form <literal>HH:mm</literal> on a 24-hour clock. You can also use
the reserved values <literal>midnight</literal> and <literal>noon</literal> for <literal>00:00</literal> and <literal>12:00</literal>.</simpara>
<section id="_configuring_a_yearly_schedule">
<title>Configuring a Yearly Schedule<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/trigger/schedule/yearly.asciidoc">Edit me</ulink></title>
<simpara>To configure a once a year schedule, you specify the month with the <literal>in</literal> attribute,
the day with the  <literal>on</literal> attribute, and the time with the <literal>at</literal> attribute. For
example, the following <literal>yearly</literal> schedule triggers once a year at noon on January
10th:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "trigger" : {
    "schedule" : {
      "yearly" : { "in" : "january", "on" : 10, "at" : "noon" }
    }
  }
}</programlisting>
<note><simpara>You can also specify the month, day, and time with the <literal>month</literal>, <literal>day</literal>, and
      <literal>time</literal> attributes, they are interchangeable with <literal>in</literal>, <literal>on</literal>, and <literal>at</literal>.</simpara></note>
</section>
<section id="_configuring_a_multiple_times_yearly_schedule">
<title>Configuring a Multiple Times Yearly Schedule<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/trigger/schedule/yearly.asciidoc">Edit me</ulink></title>
<simpara>To configure a <literal>yearly</literal> schedule that triggers multiple times a year, you can
specify an array of month, day, and time values. For example, the following
<literal>yearly</literal> schedule triggers twice a year: at noon on January 10th, and at 5:00 PM
on July 20th.</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "trigger" : {
    "schedule" : {
      "yearly" : [
        { "in" : "january", "on" : 10, "at" : "noon" },
        { "in" : "july", "on" : 20, "at" : "17:00" }
      ]
    }
  }
}</programlisting>
<simpara>Alternatively, you can specify the months, days, and times in an object that has
<literal>in</literal>, <literal>on</literal>, and <literal>minute</literal> attributes that contain an array of values. For example,
the following <literal>yearly</literal> schedule triggers at 12:00 AM and 12:00 PM on January 10th,
January 20th, December 10th, and December 20th.</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "trigger" : {
    "schedule" : {
      "yearly" : {
        "in" : [ "jan", "dec" ],
        "on" : [ 10, 20 ],
        "at" : [ "midnight", "noon" ]
      }
    }
  }
}</programlisting>
</section>
</section>
<section id="schedule-cron">
<title><literal>cron</literal> Schedule<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/trigger/schedule/cron.asciidoc">Edit me</ulink></title>
<simpara>A <link linkend="trigger-schedule"><literal>schedule</literal></link> trigger that enables you to use a
<ulink url="https://en.wikipedia.org/wiki/Cron">cron</ulink> style expression to specify when you
want the scheduler to start the watch execution. Watcher uses the cron parser
from the <ulink url="http://www.quartz-scheduler.org">Quartz Job Scheduler</ulink>. For more
information about writing Quartz cron expressions, see the
<ulink url="http://www.quartz-scheduler.org/documentation/quartz-1.x/tutorials/crontrigger">Quartz CronTrigger Tutorial</ulink>.</simpara>
<warning><simpara>While <literal>cron</literal> triggers are super powerful, we recommend using one of
          the other schedule types if you can, as they are much more
          straightforward to configure. If you use <literal>cron</literal>, construct your <literal>cron</literal>
          expressions with care to be sure you are actually setting the schedule
          you want. You can use the <link linkend="croneval"><literal>croneval</literal></link> tool to validate
          your cron expressions and see what the resulting trigger times will be.</simpara></warning>
<section id="_cron_expressions">
<title>Cron Expressions<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/trigger/schedule/cron.asciidoc">Edit me</ulink></title>
<simpara>A cron expression is a string of the following form:</simpara>
<programlisting language="txt" linenumbering="unnumbered">    &lt;seconds&gt; &lt;minutes&gt; &lt;hours&gt; &lt;day_of_month&gt; &lt;month&gt; &lt;day_of_week&gt; [year]</programlisting>
<simpara>All elements are required except for <literal>year</literal>. <xref linkend="schedule-cron-elements"/> shows
the valid values for each element in a cron expression.</simpara>
<table id="schedule-cron-elements"
frame="all"
rowsep="1" colsep="1"
>
<title>Cron Expression Elements</title>
<tgroup cols="4">
<colspec colname="col_1" colwidth="25*"/>
<colspec colname="col_2" colwidth="25*"/>
<colspec colname="col_3" colwidth="25*"/>
<colspec colname="col_4" colwidth="25*"/>
<thead>
<row>
<entry align="left" valign="top"> Name           </entry>
<entry align="center" valign="top"> Required  </entry>
<entry align="left" valign="top"> Valid Values            </entry>
<entry align="left" valign="top"> Valid Special Characters</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>seconds</literal></simpara></entry>
<entry align="center" valign="top"><simpara>yes</simpara></entry>
<entry align="left" valign="top"><simpara><literal>0</literal>-<literal>59</literal></simpara></entry>
<entry align="left" valign="top"><simpara><literal>,</literal> <literal>-</literal> <literal>*</literal> <literal>/</literal></simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>minutes</literal></simpara></entry>
<entry align="center" valign="top"><simpara>yes</simpara></entry>
<entry align="left" valign="top"><simpara><literal>0</literal>-<literal>59</literal></simpara></entry>
<entry align="left" valign="top"><simpara><literal>,</literal> <literal>-</literal> <literal>*</literal> <literal>/</literal></simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>hours</literal></simpara></entry>
<entry align="center" valign="top"><simpara>yes</simpara></entry>
<entry align="left" valign="top"><simpara><literal>0</literal>-<literal>23</literal></simpara></entry>
<entry align="left" valign="top"><simpara><literal>,</literal> <literal>-</literal> <literal>*</literal> <literal>/</literal></simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>day_of_month</literal></simpara></entry>
<entry align="center" valign="top"><simpara>yes</simpara></entry>
<entry align="left" valign="top"><simpara><literal>1</literal>-<literal>31</literal></simpara></entry>
<entry align="left" valign="top"><simpara><literal>,</literal> <literal>-</literal> <literal>*</literal> <literal>/</literal> <literal>?</literal> <literal>L</literal> <literal>W</literal></simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>month</literal></simpara></entry>
<entry align="center" valign="top"><simpara>yes</simpara></entry>
<entry align="left" valign="top"><simpara><literal>1</literal>-<literal>12</literal> or <literal>JAN</literal>-<literal>DEC</literal></simpara></entry>
<entry align="left" valign="top"><simpara><literal>,</literal> <literal>-</literal> <literal>*</literal> <literal>/</literal></simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>day_of_week</literal></simpara></entry>
<entry align="center" valign="top"><simpara>yes</simpara></entry>
<entry align="left" valign="top"><simpara><literal>1</literal>-<literal>7</literal> or <literal>SUN</literal>-<literal>SAT</literal></simpara></entry>
<entry align="left" valign="top"><simpara><literal>,</literal> <literal>-</literal> <literal>*</literal> <literal>/</literal> <literal>?</literal> <literal>L</literal> <literal>#</literal></simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>year</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>empty or <literal>1970</literal>-`2099</simpara></entry>
<entry align="left" valign="top"><simpara><literal>,</literal> <literal>-</literal> <literal>*</literal> <literal>/</literal></simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<simpara>The special characters you can use in a cron expression are described in
<xref linkend="schedule-cron-special-characters"/>. The names of months and days of the week
are not case sensitive. For example, <literal>MON</literal> and <literal>mon</literal> are equivalent.</simpara>
<note><simpara>Currently, you must specify <literal>?</literal> for either the <literal>day_of_week</literal> or
      <literal>day_of_month</literal>. Explicitly specifying both values is not supported.</simpara></note>
<table id="schedule-cron-special-characters"
frame="all"
rowsep="1" colsep="1"
>
<title>Cron Special Characters</title>
<tgroup cols="2">
<colspec colname="col_1" colwidth="50*"/>
<colspec colname="col_2" colwidth="50*"/>
<thead>
<row>
<entry align="left" valign="top"> Special Character </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara>*</simpara></entry>
<entry align="left" valign="top"><simpara>All values. Selects every possible value for a field. For
                      example, <literal>*</literal> in the <literal>hours</literal> field means "every hour".</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>?</simpara></entry>
<entry align="left" valign="top"><simpara>No specific value. Use when you don&#8217;t care what the value
                      is. For example, if you want the schedule to trigger on a
                      particular day of the month, but don&#8217;t care what day of
                      the week that happens to be, you can specify <literal>?</literal> in the
                      <literal>day_of_week</literal> field.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>A range of values (inclusive). Use to separate a minimum
                      and maximum value. For example, if you want the schedule
                      to trigger every hour between 9:00 AM and 5:00 PM, you
                      could specify  <literal>9-17</literal> in the <literal>hours</literal> field.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>,</simpara></entry>
<entry align="left" valign="top"><simpara>Multiple values. Use to separate multiple values for a
                      field. For example, if you want the schedule to trigger
                      every Tuesday and Thursday, you could specify <literal>TUE,THU</literal>
                      in the <literal>day_of_week</literal> field.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>/</simpara></entry>
<entry align="left" valign="top"><simpara>Increment. Use to separate values when specifying a time
                      increment. The first value represents the starting point,
                      and the second value represents the interval. For example,
                      if you want the schedule to trigger every 20 minutes
                      starting at the top of the hour, you could specify <literal>0/20</literal>
                      in the <literal>minutes</literal> field. Similarly, specifying <literal>1/5</literal> in
                      <literal>day_of_month</literal> field will trigger every 5 days starting on
                      the first day of the month.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>L</simpara></entry>
<entry align="left" valign="top"><simpara>Last. Use in the <literal>day_of_month</literal> field to mean the last day
                      of the month&#8212;day 31 for January, day 28 for February in
                      non-leap years, day 30 for April, and so on. Use alone in
                      the <literal>day_of_week</literal> field in place of <literal>7</literal> or <literal>SAT</literal>, or after
                      a particular day of the week to select the last day of that
                      type in the month. For example <literal>6L</literal> means the last Friday
                      of the month. You can specify <literal>LW</literal> in the <literal>day_of_month</literal>
                      field to specify the last weekday of the month. Avoid using
                      the <literal>L</literal> option when specifying lists or ranges of values,
                      as the results likely won&#8217;t be what you expect.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>W</simpara></entry>
<entry align="left" valign="top"><simpara>Weekday. Use to specify the weekday (Monday-Friday) nearest
                      the given day. As an example, if you specify <literal>15W</literal> in the
                      <literal>day_of_month</literal> field and the 15th is a Saturday, the
                      schedule will trigger on the 14th. If the 15th is a Sunday,
                      the schedule will trigger on Monday the 16th. If the 15th
                      is a Tuesday, the schedule will trigger on Tuesday the 15th.
                      However if you specify <literal>1W</literal> as the value for <literal>day_of_month</literal>,
                      and the 1st is a Saturday, the schedule will trigger on
                      Monday the 3rd&#8212;it won&#8217;t jump over the month boundary. You
                      can specify <literal>LW</literal> in the <literal>day_of_month</literal> field to specify the
                      last weekday of the month. You can only use the <literal>W</literal> option
                      when the <literal>day_of_month</literal> is a single day&#8212;it is not valid
                      when specifying a range or list of days.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>#</simpara></entry>
<entry align="left" valign="top"><simpara>Nth XXX day in a month. Use in the <literal>day_of_week</literal> field to
                      specify the nth XXX day of the month. For example, if you
                      specify <literal>6#1</literal>, the schedule will trigger on the first
                      Friday of the month. Note that if you specify <literal>3#5</literal> and
                      there are not 5 Tuesdays in a particular month, the
                      schedule won&#8217;t trigger that month.</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<table
frame="all"
rowsep="1" colsep="1"
>
<title>Setting Daily Triggers</title>
<tgroup cols="2">
<colspec colname="col_1" colwidth="50*"/>
<colspec colname="col_2" colwidth="50*"/>
<thead>
<row>
<entry align="left" valign="top"> Cron Expression       </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>0 5 9 * * ?</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Trigger at 9:05 AM every day.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>0 5 9 * * ? 2015</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Trigger at 9:05 AM every day during the year 2015.</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<table
frame="all"
rowsep="1" colsep="1"
>
<title>Restricting Triggers to a Range of Days or Times</title>
<tgroup cols="2">
<colspec colname="col_1" colwidth="50*"/>
<colspec colname="col_2" colwidth="50*"/>
<thead>
<row>
<entry align="left" valign="top"> Cron Expression       </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>0 5 9 ? * MON-FRI</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Trigger at 9:05 AM Monday through Friday.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>0 0-5 9 * * ?</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Trigger every minute starting at 9:00 AM and ending
                          at 9:05 AM every day.</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<table
frame="all"
rowsep="1" colsep="1"
>
<title>Setting Interval Triggers</title>
<tgroup cols="2">
<colspec colname="col_1" colwidth="50*"/>
<colspec colname="col_2" colwidth="50*"/>
<thead>
<row>
<entry align="left" valign="top"> Cron Expression       </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>0 0/15 9 * * ?</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Trigger every 15 minutes starting at 9:00 AM and ending
                          at 9:45 AM every day.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>0 5 9 1/3 * ?</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Trigger at 9:05 AM every 3 days every month, starting
                          on the first day of the month.</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<table
frame="all"
rowsep="1" colsep="1"
>
<title>Setting Schedules that Trigger on a Particular Day</title>
<tgroup cols="2">
<colspec colname="col_1" colwidth="50*"/>
<colspec colname="col_2" colwidth="50*"/>
<thead>
<row>
<entry align="left" valign="top"> Cron Expression       </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>0 1 4 1 4 ?</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Trigger every April 1st at 4:01 AM.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>0 0,30 9 ? 4 WED</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Trigger at 9:00 AM and at 9:30 AM every Wednesday in
                          the month of April.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>0 5 9 15 * ?</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Trigger at 9:05 AM on the 15th day of every month.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>0 5 9 15W * ?</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Trigger at 9:05 AM on the nearest weekday to the 15th
                          of every month.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>0 5 9 ? * 6#1</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Trigger at 9:05 AM on the first Friday of every month.</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<table
frame="all"
rowsep="1" colsep="1"
>
<title>Setting Triggers Using Last</title>
<tgroup cols="2">
<colspec colname="col_1" colwidth="50*"/>
<colspec colname="col_2" colwidth="50*"/>
<thead>
<row>
<entry align="left" valign="top"> Cron Expression       </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>0 5 9 L * ?</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Trigger at 9:05 AM on the last day of every month.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>0 5 9 ? * 2L</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Trigger at 9:05 AM on the last Monday of every month</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>0 5 9 LW * ?</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Trigger at 9:05 AM on the last weekday of every month.</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
</section>
<section id="_configuring_a_cron_schedule">
<title>Configuring a Cron Schedule<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/trigger/schedule/cron.asciidoc">Edit me</ulink></title>
<simpara>To configure a <literal>cron</literal> schedule, you simply specify the cron expression as a
string value. For example, the following snippet configures a <literal>cron</literal> schedule
that triggers every day at noon:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  ...
  "trigger" : {
    "schedule" : {
      "cron" : "0 0 12 * * ?"
    }
  }
  ...
}</programlisting>
</section>
<section id="croneval">
<title>Verifying Cron Expressions<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/trigger/schedule/cron.asciidoc">Edit me</ulink></title>
<simpara>X-Pack ships with a <literal>croneval</literal> command line tool that you can use to verify that
your cron expressions are valid and produce the expected results. This tool is
provided in the <literal>$ES_HOME/bin/x-pack</literal> directory.</simpara>
<simpara>To verify a cron expression, simply pass it in as a parameter to <literal>croneval</literal>:</simpara>
<programlisting language="bash" linenumbering="unnumbered">bin/x-pack/croneval "0 0/1 * * * ?"</programlisting>
<simpara>If the cron expression is valid, <literal>croneval</literal> displays the next 10 times that the
schedule will be triggered.</simpara>
<simpara>You can specify the <literal>-c</literal> option to control how many future trigger times are
displayed. For example, the following command displays the next 20 trigger times:</simpara>
<programlisting language="bash" linenumbering="unnumbered">bin/x-pack/croneval "0 0/1 * * * ?" -c 20</programlisting>
</section>
</section>
<section id="schedule-interval">
<title>Interval Schedule<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/trigger/schedule/interval.asciidoc">Edit me</ulink></title>
<simpara>A <link linkend="trigger-schedule"><literal>schedule</literal></link> that triggers at a fixed time interval. The
interval can be set in seconds, minutes, hours, days, or weeks:</simpara>
<itemizedlist>
<listitem>
<simpara>
<literal>"Xs"</literal> - trigger every <literal>X</literal> seconds. For example, <literal>"30s"</literal> means every 30 seconds.
</simpara>
</listitem>
<listitem>
<simpara>
<literal>"Xm"</literal> - trigger every <literal>X</literal> minutes. For example, <literal>"5m"</literal> means every 5 minutes.
</simpara>
</listitem>
<listitem>
<simpara>
<literal>"Xh"</literal> - trigger every <literal>X</literal> hours. For example, <literal>"12h"</literal> means every 12 hours.
</simpara>
</listitem>
<listitem>
<simpara>
<literal>"Xd"</literal> - trigger every <literal>X</literal> days. For example, <literal>"3d"</literal> means every 3 days.
</simpara>
</listitem>
<listitem>
<simpara>
<literal>"Xw"</literal> - trigger every <literal>X</literal> weeks. For example, <literal>"2w"</literal> means every 2 weeks.
</simpara>
</listitem>
</itemizedlist>
<simpara>If you don&#8217;t specify a time unit, it defaults to seconds.</simpara>
<note><simpara>The interval value differs from the standard <emphasis>time value</emphasis> used in
      Elasticsearch. You cannot configure intervals in milliseconds or
      nanoseconds.</simpara></note>
<section id="_configuring_an_interval_schedule">
<title>Configuring an Interval Schedule<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/trigger/schedule/interval.asciidoc">Edit me</ulink></title>
<simpara>To configure an <literal>interval</literal> schedule, you specify a string value that represents
the interval. If you omit the unit of time (<literal>s</literal>,<literal>m</literal>, <literal>h</literal>, <literal>d</literal>, or <literal>w</literal>), it
defaults to seconds.</simpara>
<simpara>For example, the following <literal>interval</literal> schedule triggers every five minutes:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "trigger" : {
    "schedule" : {
      "interval" : "5m"
    }
  }
}</programlisting>
</section>
</section>
</section>
</chapter>
<chapter id="condition">
<title>Conditions<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/condition.asciidoc">Edit me</ulink></title>
<simpara>When a watch is triggered, its condition determines whether or not to execute
the watch actions. Watcher supports the following condition types:</simpara>
<itemizedlist>
<listitem>
<simpara>
<link linkend="condition-always"><literal>always</literal></link>: set the watch condition to <literal>true</literal> so the watch
actions are always executed.
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="condition-never"><literal>never</literal></link>: set the watch condition to <literal>false</literal> so the watch
actions are never executed.
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="condition-compare"><literal>compare</literal></link>: perform simple comparisons against values
in the watch payload to determine whether or not to execute the watch actions.
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="condition-array-compare"><literal>array_compare</literal></link>: compare an array of values in the
watch payload to a given value to determine whether or not to execute the watch
actions.
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="condition-script"><literal>script</literal></link>: use a script to determine wehther or not to
execute the watch actions.
</simpara>
</listitem>
</itemizedlist>
<note><simpara>If you omit the condition definition from a watch, the condition defaults
      to <literal>always</literal>.</simpara></note>
<simpara>When a condition is evaluated, it has full access to the watch execution context,
including the watch payload (<literal>ctx.payload.*</literal>). The <link linkend="condition-script">script</link>,
<link linkend="condition-compare">compare</link>  and <link linkend="condition-array-compare">array_compare</link>
conditions can use the payload data to determine whether or not the necessary
conditions are met.</simpara>
<section id="condition-always">
<title>Always Condition<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/condition/always.asciidoc">Edit me</ulink></title>
<simpara>Use the <literal>always</literal> condition to set the condition to <literal>true</literal>. This forces the watch
actions to be executed unless they are <link linkend="actions-ack-throttle">throttled</link>.</simpara>
<simpara>The <literal>always</literal> condition enables you to perform watch actions on a fixed schedule,
such as, <emphasis>"Every Friday at noon, send a status report email to
<ulink url="mailto:sys.admin@example.com">sys.admin@example.com</ulink>."</emphasis></simpara>
<section id="_using_the_always_condition">
<title>Using the Always Condition<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/condition/always.asciidoc">Edit me</ulink></title>
<simpara>This is the default if you omit the condition definition from a watch.</simpara>
<simpara>There are no attributes to specify for the <literal>always</literal> condition. To explicitly
use this condition, specify the condition type and associate it with an empty
object:</simpara>
<programlisting language="js" linenumbering="unnumbered">"condition" : {
  "always" : {}
}</programlisting>
</section>
</section>
<section id="condition-never">
<title>Never Condition<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/condition/never.asciidoc">Edit me</ulink></title>
<simpara>Use the <literal>never</literal> condition to set the condition to <literal>false</literal>. This means the
watch actions are never executed when the watch is triggered. The watch input is
executed, a record is added to the watch history, and the watch execution ends.
This condition is generally used for testing.</simpara>
<section id="_using_the_never_condition">
<title>Using the Never Condition<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/condition/never.asciidoc">Edit me</ulink></title>
<simpara>There are no attributes to specify for the <literal>never</literal> condition. To use the it,
you specify the condition type and associate it with an empty object:</simpara>
<programlisting language="js" linenumbering="unnumbered">"condition" : {
  "never" : {}
}</programlisting>
</section>
</section>
<section id="condition-compare">
<title>Compare Condition<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/condition/compare.asciidoc">Edit me</ulink></title>
<simpara>Use the <literal>compare</literal> condition to perform a simple comparison against a value in
the watch payload. You can use the <literal>compare</literal> condition without enabling
dynamic scripting.</simpara>
<orderedlist id="condition-compare-operators" numeration="arabic">
<listitem>
<simpara>
Supported Comparison Operators
</simpara>
</listitem>
</orderedlist>
<informaltable
frame="all"
rowsep="1" colsep="1"
>
<tgroup cols="2">
<colspec colname="col_1" colwidth="50*"/>
<colspec colname="col_2" colwidth="50*"/>
<thead>
<row>
<entry align="left" valign="top"> Name      </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>eq</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Returns <literal>true</literal> when the resolved value equals the given one (applies
              to numeric, string, list, object and values)</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>not_eq</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Returns <literal>true</literal> when the resolved value does not equal the given one
              (applies to numeric, string, list, object and null values)</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>gt</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Returns <literal>true</literal> when the resolved value is greater than the given
              one (applies to numeric and string values)</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>gte</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Returns <literal>true</literal> when the resolved value is greater/equal than/to the
              given one (applies to numeric and string values)</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>lt</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Returns <literal>true</literal> when the resolved value is less than the given one
              (applies to numeric and string values)</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>lte</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Returns <literal>true</literal> when the resolved value is less/equal than/to the
              given one (applies to numeric and string values)</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
<section id="_using_a_compare_condition">
<title>Using a Compare Condition<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/condition/compare.asciidoc">Edit me</ulink></title>
<simpara>To use the <literal>compare</literal> condition, you specify the value in the execution context
that you want to evaluate, a <link linkend="condition-compare-operators">comparison operator</link>,
and the value you want to compare against. For example, the following <literal>compare</literal>
condition returns <literal>true</literal> if the number of the total hits in the <link linkend="input-search">search result</link> is greater than or equal to 5:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "condition" : {
    "compare" : {
      "ctx.payload.hits.total" : { <co id="CO39-1"/>
        "gte" : 5 <co id="CO39-2"/>
      }
  }
}</programlisting>
<calloutlist>
<callout arearefs="CO39-1">
<para>
Use dot notation to reference a value in the execution context.
</para>
</callout>
<callout arearefs="CO39-2">
<para>
Specify a comparison operator and the value you want to compare against.
</para>
</callout>
</calloutlist>
<simpara id="compare-condition-date-math">When comparing dates and times, you can use date math expressions
of the form <literal>&lt;{expression}&gt;</literal>. For example, the following expression returns
<literal>true</literal> if the watch was executed within the last five minutes:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "condition" : {
    "compare" : {
      "ctx.execution_time" : {
        "gte" : "&lt;{now-5m}&gt;"
      }
  }
}</programlisting>
<simpara>You can also compare two values in the execution context by specifying the
compared value as a path of the form of <literal>{{path}}</literal>. For example, the following
condition compares the <literal>ctx.payload.aggregations.status.buckets.error.doc_count</literal>
to the <literal>ctx.payload.aggregations.handled.buckets.true.doc_count</literal>:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "condition" : {
    "compare" : {
      "ctx.payload.aggregations.status.buckets.error.doc_count" : {
        "not_eq" : "{{ctx.payload.aggregations.handled.buckets.true.doc_count}}"
      }
  }
}</programlisting>
</section>
<section id="_accessing_values_in_the_execution_context">
<title>Accessing Values in the Execution Context<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/condition/compare.asciidoc">Edit me</ulink></title>
<simpara>You use "dot-notation" to access values in the execution context. Values loaded
into the execution context by the input are prefixed by <literal>ctx.payload</literal>.</simpara>
<simpara>You can reference entries in arrays using their zero-based array indices.
For example, to access the third element of the <literal>ctx.payload.hits.hits</literal>
array, use <literal>ctx.payload.hits.hits.2</literal>.</simpara>
<informaltable
frame="all"
rowsep="1" colsep="1"
>
<tgroup cols="2">
<colspec colname="col_1" colwidth="50*"/>
<colspec colname="col_2" colwidth="50*"/>
<thead>
<row>
<entry align="left" valign="top"> Name                         </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>ctx.watch_id</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The id of the watch that is currently executing.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ctx.execution_time</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The time execution of this watch started.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ctx.trigger.triggered_time</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The time this watch was triggered.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ctx.trigger.scheduled_time</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The time this watch was supposed to be triggered.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ctx.metadata.*</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Any metadata associated with the watch.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ctx.payload.*</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The payload data loaded by the watch&#8217;s input.</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
</section>
</section>
<section id="condition-array-compare">
<title>Array Compare Condition<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/condition/array-compare.asciidoc">Edit me</ulink></title>
<simpara>Use <literal>array_compare</literal> to compare an array of values in the execution context to a
given value. See <link linkend="condition-compare-operators">Supported Comparison Operators</link>
for the operators you can use.</simpara>
<section id="_using_an_array_compare_condition">
<title>Using an Array Compare Condition<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/condition/array-compare.asciidoc">Edit me</ulink></title>
<simpara>To use the <literal>array_compare</literal> condition, you specify the array in the execution
context that you want to evaluate, a <link linkend="condition-compare-operators">comparison operator</link>, and the value you want to compare against. Optionally, you
can specify the path to the field in each array element that you want to
evaluate.</simpara>
<simpara>For example, the following <literal>array_compare</literal> condition returns <literal>true</literal> if there
is at least one bucket in the aggregation that has a <literal>doc_count</literal> greater
than or equal to 25:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "condition": {
    "array_compare": {
      "ctx.payload.aggregations.top_tweeters.buckets" : { <co id="CO40-1"/>
        "path": "doc_count" <co id="CO40-2"/>,
        "gte": { <co id="CO40-3"/>
          "value": 25, <co id="CO40-4"/>
        }
      }
    }
  }
}</programlisting>
<calloutlist>
<callout arearefs="CO40-1">
<para>
The path to the array in the execution
    context that you want to evaluate, specified in dot notation.
</para>
</callout>
<callout arearefs="CO40-2">
<para>
The path to the field in each array element that you want to evaluate.
</para>
</callout>
<callout arearefs="CO40-3">
<para>
The <link linkend="condition-compare-operators">comparison operator</link> to use.
</para>
</callout>
<callout arearefs="CO40-4">
<para>
The comparison value. Supports date math like the
    <link linkend="compare-condition-date-math">compare condition</link>.
</para>
</callout>
</calloutlist>
</section>
<section id="_array_compare_condition_attributes">
<title>Array-Compare Condition Attributes<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/condition/array-compare.asciidoc">Edit me</ulink></title>
<informaltable
frame="all"
rowsep="1" colsep="1"
>
<tgroup cols="2">
<colspec colname="col_1" colwidth="50*"/>
<colspec colname="col_2" colwidth="50*"/>
<thead>
<row>
<entry align="left" valign="top"> Name                                 </entry>
<entry align="left" valign="top"> Description
/<literal>&lt;array path&gt;</literal>                        / The path to the array in the execution
                                         context, specified in dot notation.
                                         For example, <literal>ctx.payload.aggregations.top_tweeters.buckets</literal>.</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>&lt;array path&gt;.path</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The path to the field in each array element
                                         that you want to evaluate. For example,
                                         <literal>doc_count</literal>. Defaults to an empty string.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>&lt;array path&gt;.&lt;operator&gt;.quantifier</literal></simpara></entry>
<entry align="left" valign="top"><simpara>How many matches are required for the
                                         comparison to evaluate to <literal>true</literal>: <literal>some</literal>
                                         or <literal>all</literal>. Defaults to <literal>some</literal>--there must
                                         be at least one match. If the array is
                                         empty, the comparison evaluates to <literal>true</literal>
                                         if the quantifier is set to <literal>all</literal> and
                                         <literal>false</literal> if the quantifier is set to
                                         <literal>some</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>&lt;array path&gt;.&lt;operator&gt;.value</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The value to compare against.</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
</section>
</section>
<section id="condition-script">
<title>Script Condition<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/condition/script.asciidoc">Edit me</ulink></title>
<simpara>A watch <link linkend="condition">condition</link> that evaluates a script. The default scripting
language is <literal>groovy</literal>. You can use any of the scripting languages supported by
Elasticsearch as long as the language supports evaluating expressions to Boolean
values. Note that the <literal>mustache</literal> and <literal>expression</literal> languages are too limited to be
used by this condition. For more information, see <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/modules-scripting.html">Scripting</ulink>
in the Elasticsearch Reference.</simpara>
<important>
<simpara>For Groovy, you must explicitly <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/modules-scripting-security.html#enable-dynamic-scripting">enable dynamic scripts</ulink>
in <literal>elasticsearch.yml</literal> to use <literal>inline</literal> or <literal>stored</literal> scripts.  To enable groovy
scripting for watches only, you can set <literal>script.engine.groovy.inline.xpack_watch: true</literal>.</simpara>
<simpara>Alternatively, starting with 5.0, Elasticsearch is shipped with the new
<ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/modules-scripting-painless.html">Painless</ulink> scripting language. Painless was
created and designed specifically for use in Elasticsearch. Beyond providing an
extensive feature set, its biggest trait is that it&#8217;s properly sandboxed and safe
to use anywhere in the system (including in Watcher) without the need to enable
dynamic scripting.</simpara>
</important>
<section id="_using_a_script_condition">
<title>Using a Script Condition<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/condition/script.asciidoc">Edit me</ulink></title>
<simpara>The following snippet configures an inline <literal>script</literal> condition that always returns
<literal>true</literal>:</simpara>
<programlisting language="js" linenumbering="unnumbered">"condition" : {
  "script" : "return true"
}</programlisting>
<simpara>This example defines a script as a simple string. This format is actually a
shortcut for defining an <link linkend="condition-script-inline">inline</link> groovy script. The
formal definition of a script is an object that specifies the script type and
optional language and parameter values. If the <literal>lang</literal> attribute is omitted, the
language defaults to groovy. Elasticsearch supports three script types:
<link linkend="condition-script-inline">Inline</link>, <link linkend="condition-script-file">File</link>, and
<link linkend="condition-script-stored">Stored</link>.</simpara>
<simpara>For example, the following snippet shows a formal definition of an <literal>inline</literal>
script that explicitly specifies the language and defines a single script
parameter, <literal>result</literal>:</simpara>
<programlisting language="js" linenumbering="unnumbered">"condition" : {
  "script" : {
    "inline" : "return result",
    "lang" : "groovy",
    "params" : {
      "result" : true
    }
  }
}</programlisting>
</section>
<section id="condition-script-inline">
<title>Inline Scripts<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/condition/script.asciidoc">Edit me</ulink></title>
<simpara>Inline scripts are scripts that are defined in the condition itself. The
following snippet shows the formal configuration of a simple groovy script that
always returns <literal>true</literal>.</simpara>
<programlisting language="js" linenumbering="unnumbered">"condition" : {
  "script" : {
    "inline" : "return true"
  }
}</programlisting>
</section>
<section id="condition-script-file">
<title>File Scripts<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/condition/script.asciidoc">Edit me</ulink></title>
<simpara>File scripts are scripts that are defined in files stored in the <literal>config/scripts</literal>
directory. The following snippet shows how to refer to the <literal>my_script.groovy</literal>
file:</simpara>
<programlisting language="js" linenumbering="unnumbered">"condition" : {
  "script" : {
    "file" : "my_script"
  }
}</programlisting>
<simpara>As with <link linkend="condition-script-inline">Inline</link> scripts, you can also specify the
script language and parameters:</simpara>
<programlisting language="js" linenumbering="unnumbered">"condition" : {
  "script" : {
    "file" : "my_script",
    "lang" : "javascript",
    "params" : {
      "result" : true
    }
  }
}</programlisting>
</section>
<section id="condition-script-stored">
<title>Stored Scripts<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/condition/script.asciidoc">Edit me</ulink></title>
<simpara>Stored scripts refer to scripts that were <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/modules-scripting-using.html#modules-scripting-stored-scripts">stored</ulink>
in Elasticsearch. The following snippet shows how to refer to a script by its <literal>id</literal>:</simpara>
<programlisting language="js" linenumbering="unnumbered">"condition" : {
  "script" : {
    "id" : "my_script"
  }
}</programlisting>
<simpara>As with <link linkend="condition-script-file">File</link> and <link linkend="condition-script-inline">Inline</link>
scripts, you can also specify the script language and parameters:</simpara>
<programlisting language="js" linenumbering="unnumbered">"condition" : {
  "script" : {
    "id" : "my_script",
    "lang" : "javascript",
    "params" : { "color" : "red" }
  }
}</programlisting>
</section>
<section id="accessing-watch-payload">
<title>Accessing the Watch Payload<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/condition/script.asciidoc">Edit me</ulink></title>
<simpara>A script can access the current watch execution context, including the payload
data, as well as any parameters passed in through the condition definition.</simpara>
<simpara>For example, the following snippet defines a watch that uses a <link linkend="input-search"><literal>search</literal> input</link>
and uses a <literal>script</literal> condition to check if the number of hits is above a specified
threshold:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "input" : {
    "search" : {
      "indices" : "log-events",
      "body" : {
        "size" : 0,
        "query" : { "match" : { "status" : "error" } }
      }
    }
  },
  "condition" : {
    "script" : {
      "inline" : "return ctx.payload.hits.total &gt; threshold",
      "params" : {
        "threshold" : 5
      }
    }
  }
}</programlisting>
<simpara>When you&#8217;re using a scripted condition to evaluate an Elasticsearch response,
keep in mind that the fields in the response are no longer in their native data
types. For example, the <literal>@timestamp</literal> in the response is a string, rather than a
<literal>DateTime</literal>. To compare the response <literal>@timestamp</literal> against the <literal>ctx.execution_time</literal>,
you need to parse the <literal>@timestamp</literal> string into a <literal>DateTime</literal>. For example:</simpara>
<programlisting language="js" linenumbering="unnumbered">org.elasticsearch.common.joda.time.DateTime.parse(@timestamp)</programlisting>
<simpara>You can reference the following variables in the watch context:</simpara>
<informaltable
frame="all"
rowsep="1" colsep="1"
>
<tgroup cols="2">
<colspec colname="col_1" colwidth="50*"/>
<colspec colname="col_2" colwidth="50*"/>
<thead>
<row>
<entry align="left" valign="top"> Name                          </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>ctx.watch_id</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The id of the watch that is currently executing.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ctx.execution_time</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The time execution of this watch started.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ctx.trigger.triggered_time</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The time this watch was triggered.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ctx.trigger.scheduled_time</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The time this watch was supposed to be triggered.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ctx.metadata.*</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Any metadata associated with the watch.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ctx.payload.*</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The payload data loaded by the watch&#8217;s input.</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
</section>
</section>
</chapter>
<chapter id="actions">
<title>Actions<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions.asciidoc">Edit me</ulink></title>
<simpara>When a watch&#8217;s condition is met, it&#8217;s actions are executed unless it is being
<link linkend="actions-ack-throttle">throttled</link>. A watch can perform multiple actions.
The actions are executed one at a time and each action executes independently.
Any failures encountered while executing an action are recorded in the
action result and in the watch history.</simpara>
<note><simpara>If no actions are defined for a watch, no actions are executed.
        However, a <literal>watch_record</literal> is still written to the watch history.</simpara></note>
<simpara>Actions have access to the payload in the execution context. They can use it to
support their execution in any way they need. For example, the payload might
serve as a model for a templated email body.</simpara>
<simpara>Watcher supports the following types of actions:
<link linkend="actions-email">email</link>, <link linkend="actions-webhook">webhook</link>, <link linkend="actions-index">index</link>,
<link linkend="actions-logging">logging</link>, <link linkend="actions-hipchat">hipchat</link>, <link linkend="actions-slack">Slack</link>, and <link linkend="actions-pagerduty">pagerduty</link>.</simpara>
<bridgehead id="actions-ack-throttle" renderas="sect2">Acknowledgement and Throttling<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions.asciidoc">Edit me</ulink></bridgehead>
<simpara>During the watch execution, once the condition is met, a decision is made per
configured action as to whether it should be throttled. The main purpose of
action throttling is to prevent too many executions of the same action for the
same watch.</simpara>
<simpara>For example, suppose you have a watch that detects errors in an application&#8217;s log
entries. The watch is triggered every five minutes and searches for errors during
the last hour. In this case, if there are errors, there is a period of time where
the watch is checked and its actions are executed multiple times based on the same
errors. As a result, the system administrator receives multiple notifications about
the same issue, which can be annoying.</simpara>
<simpara>To address this issue, Watcher supports time-based throttling. You can define
a throttling period as part of the action configuration to limit how often the
action is executed. When you set a throttling period, Watcher prevents repeated
execution of the action if it has already executed within the throttling period
time frame (<literal>now - throttling period</literal>).</simpara>
<simpara>The following snippet shows a watch for the scenario described above - associating
a throttle period with the <literal>email_administrator</literal> action:</simpara>
<programlisting language="js" linenumbering="unnumbered">PUT _xpack/watcher/watch/error_logs_alert
{
  "metadata" : {
    "color" : "red"
  },
  "trigger" : {
    "schedule" : {
      "interval" : "5m"
    }
  },
  "input" : {
    "search" : {
      "request" : {
        "indices" : "log-events",
        "body" : {
          "size" : 0,
          "query" : { "match" : { "status" : "error" } }
        }
      }
    }
  },
  "condition" : {
    "compare" : { "ctx.payload.hits.total" : { "gt" : 5 }}
  },
  "actions" : {
    "email_administrator" : {
      "throttle_period": "15m", <co id="CO41-1"/>
      "email" : { <co id="CO41-2"/>
        "to" : "sys.admino@host.domain",
        "subject" : "Encountered {{ctx.payload.hits.total}} errors",
        "body" : "Too many error in the system, see attached data",
        "attachments" : {
          "attached_data" : {
            "data" : {
              "format" : "json"
            }
          }
        },
        "priority" : "high"
      }
    }
  }
}</programlisting>
<remark> CONSOLE</remark>
<calloutlist>
<callout arearefs="CO41-1">
<para>
There will be at least 15 minutes between subsequent <literal>email_administrator</literal>
                action executions.
</para>
</callout>
<callout arearefs="CO41-2">
<para>
See <link linkend="actions-email">Email Action</link> for more information.
</para>
</callout>
</calloutlist>
<simpara>You can also define a throttle period at the watch level. The watch-level
throttle period serves as the default throttle period for all of the actions
defined in the watch:</simpara>
<programlisting language="js" linenumbering="unnumbered">PUT _xpack/watcher/watch/log_event_watch
{
  "trigger" : {
    ...
  },
  "input" : {
    ...
  },
  "condition" : {
    ...
  },
  "throttle_period" : "15m", <co id="CO42-1"/>
  "actions" : {
    "email_administrator" : {
      "email" : {
        "to" : "sys.admino@host.domain",
        "subject" : "Encountered {{ctx.payload.hits.total}} errors",
        "body" : "Too many error in the system, see attached data",
        "attachments" : {
          "attached_data" : {
            "data" : {
              "format" : "json"
            }
          }
        },
        "priority" : "high"
      }
    },
    "notify_pager" : {
      "condition": { <co id="CO42-2"/>
        "compare" : { "ctx.payload.hits.total" : { "gt" : 5 }}
      }
      "webhook" : {
        "method" : "POST",
        "host" : "pager.service.domain",
        "port" : 1234,
        "path" : "/{{watch_id}}",
        "body" : "Encountered {{ctx.payload.hits.total}} errors"
      }
    }
  }
}</programlisting>
<calloutlist>
<callout arearefs="CO42-1">
<para>
There will be at least 15 minutes between subsequent action executions
                (applies to both <literal>email_administrator</literal> and <literal>notify_pager</literal> actions)
</para>
</callout>
<callout arearefs="CO42-2">
<para>
A <literal>condition</literal> that only applies to the <literal>notify_pager</literal> action, which
    restricts its execution to when the condition succeeds (at least 6 hits in this case).
</para>
</callout>
</calloutlist>
<simpara>If you do not define a throttle period at the action or watch level, the global
default throttle period is applied. Initially, this is set to 5 seconds. To
change the global default, configure the <literal>xpack.watcher.execution.default_throttle_period</literal>
setting in <literal>elasticsearch.yml</literal>:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.watcher.execution.default_throttle_period: 15m</programlisting>
<simpara>Watcher also supports acknowledgement-based throttling. You can acknowledge a
watch using the <link linkend="watcher-api-ack-watch">Ack Watch API</link> to prevent the watch actions
from being executed again while the watch condition remains <literal>true</literal>. This essentially
tells Watcher "I received the notification and I&#8217;m handling it, please do not
notify me about this error again". An acknowledged watch action remains in the
<literal>acked</literal> state until the watch&#8217;s condition evaluates to <literal>false</literal>. When that happens,
the action&#8217;s state changes to <literal>awaits_successful_execution</literal>.</simpara>
<simpara>To acknowledge an action, you use the <link linkend="watcher-api-ack-watch">Ack Watch API</link>:</simpara>
<programlisting language="js" linenumbering="unnumbered">POST _xpack/watcher/watch/&lt;id&gt;/_ack/&lt;action_ids&gt;</programlisting>
<remark> CONSOLE</remark>
<remark> TEST[skip:https://github.com/elastic/x-plugins/issues/2513]</remark>
<simpara>Where <literal>&lt;id&gt;</literal> is the id of the watch and <literal>&lt;action_ids&gt;</literal> is a comma-separated list
of the action ids you want to acknowledge. To acknowledge all actions, omit the
<literal>actions</literal> parameter.</simpara>
<simpara>The following diagram illustrates the throttling decisions made for each action
of a watch during its execution:</simpara>
<informalfigure>
<mediaobject>
  <imageobject>
  <imagedata fileref="images/watcher/action-throttling.jpg" align="center"/>
  </imageobject>
  <textobject><phrase>action-throttling.jpg</phrase></textobject>
</mediaobject>
</informalfigure>
<section id="actions-email">
<title>Email Action<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/email.asciidoc">Edit me</ulink></title>
<simpara>Use the <literal>email</literal> action to send email notifications. To send email, you must
<link linkend="configuring-email">configure at least one email account</link> in
<literal>elasticsearch.yml</literal>.</simpara>
<simpara>Email notifications can be plain text or styled using HTML. You can include
information from the watch execution payload using <link linkend="templates">templates</link>
and attach the entire watch payload to the message.</simpara>
<simpara>See <xref linkend="email-action-attributes"/> for the supported attributes. Any attributes that
are missing from the email action definition are looked up in the email
account configuration. The required attributes must either be set in the email
action definition or the account&#8217;s <literal>email_defaults</literal>.</simpara>
<section id="configuring-email-actions">
<title>Configuring Email Actions<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/email.asciidoc">Edit me</ulink></title>
<simpara>You configure email actions in the <literal>actions</literal> array. Action-specific attributes
are specified using the <literal>email</literal> keyword.</simpara>
<simpara>For example, the following email action uses a template to include data from
the watch payload in the email body:</simpara>
<programlisting language="js" linenumbering="unnumbered">"actions" : {
  "send_email" : { <co id="CO43-1"/>
    "email" : { <co id="CO43-2"/>
      "to" : "&lt;username&gt;@&lt;domainname&gt;", <co id="CO43-3"/>
      "subject" : "Watcher Notification", <co id="CO43-4"/>
      "body" : "{{ctx.payload.hits.total}} error logs found" <co id="CO43-5"/>
    }
  }
}</programlisting>
<calloutlist>
<callout arearefs="CO43-1">
<para>
The id of the action.
</para>
</callout>
<callout arearefs="CO43-2">
<para>
The action type is set to <literal>email</literal>.
</para>
</callout>
<callout arearefs="CO43-3">
<para>
One or more addresses to send the email to. Must be specified in the
    action definition or in the email account configuration.
</para>
</callout>
<callout arearefs="CO43-4">
<para>
The subject of the email can contain static text and Mustache <link linkend="templates">templates</link>.
</para>
</callout>
<callout arearefs="CO43-5">
<para>
The body of the email can contain static text and Mustache <link linkend="templates">templates</link>. Must be specified in the action definition or in the email
     account configuration.
</para>
</callout>
</calloutlist>
</section>
<section id="configuring-email-attachments">
<title>Configuring Email Attachments<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/email.asciidoc">Edit me</ulink></title>
<simpara>You can attach the execution context payload or data from an any HTTP service to
the email notification. There is no limit on the number of attachments you can
configure.</simpara>
<simpara>To configure attachments, specify a name for the attached file and the type of
attachment: <literal>data</literal> or <literal>http</literal>. The <literal>data</literal> attachment type attaches the execution
context payload to the email message. The <literal>http</literal> attachment type enables
you to issue an HTTP request and attach the response to the email message. When
configuring the <literal>http</literal> attachment type, you must specify the request URL.</simpara>
<programlisting language="js" linenumbering="unnumbered">"actions" : {
  "email_admin" : {
    "email": {
      "to": "'John Doe &lt;john.doe@example.com&gt;'",
      "attachments" : {
        "my_report.pdf" : { <co id="CO44-1"/>
          "http" : { <co id="CO44-2"/>
            "content_type" : "application/pdf",
            "request" : {
              "url": "http://example.org/foo/my-report" <co id="CO44-3"/>
            }
          }
        },
        "data.yml" : {
          "data" : {
            "format" : "yaml" <co id="CO44-4"/>
          }
        }
      }
    }
  }
}</programlisting>
<calloutlist>
<callout arearefs="CO44-1">
<para>
The ID of the attachment, which is used as the file name in the email
    attachment.
</para>
</callout>
<callout arearefs="CO44-2">
<para>
The type of the attachment and its specific configuration.
</para>
</callout>
<callout arearefs="CO44-3">
<para>
The URL from which to retrieve the attachment.
</para>
</callout>
<callout arearefs="CO44-4">
<para>
Data attachments default to JSON if you don&#8217;t specify the format.
</para>
</callout>
</calloutlist>
<table
frame="all"
rowsep="1" colsep="1"
>
<title><literal>http</literal> attachment type attributes</title>
<tgroup cols="2">
<colspec colname="col_1" colwidth="50*"/>
<colspec colname="col_2" colwidth="50*"/>
<thead>
<row>
<entry align="left" valign="top"> Name            </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>content_type</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Sets the content type for the email attachment. By default,
                    the content type is extracted from the response sent by the
                    HTTP service. You can explicitly specify the content type to
                    ensure that the type is set correctly in the email in case
                    the response does not specify the content type or it&#8217;s specified
                    incorrectly. Optional.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>inline</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Configures as an attachment to sent with disposition <literal>inline</literal>. This
                    allows the use of embedded images in HTML bodies, which are displayed
                    in certain email clients. Optional. Defaults to <literal>false</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Contains the HTTP request attributes. At a minimum, you must
                    specify the <literal>url</literal> attribute to configure the host and path to
                    the service endpoint. See <xref linkend="webhook-action-attributes"/> for
                    the full list of HTTP request attributes. Required.</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<table
frame="all"
rowsep="1" colsep="1"
>
<title><literal>data</literal> attachment type attributes</title>
<tgroup cols="2">
<colspec colname="col_1" colwidth="50*"/>
<colspec colname="col_2" colwidth="50*"/>
<thead>
<row>
<entry align="left" valign="top"> Name        </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>format</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Attaches the watch data, equivalent to specifying <literal>attach_data</literal>
                in the watch configuration. Possible values are <literal>json</literal> or <literal>yaml</literal>.
                Defaults to <literal>json</literal> if not specified.</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<section id="email-action-reports">
<title>Attaching Reports to an Email<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/email.asciidoc">Edit me</ulink></title>
<simpara>You can use the <literal>http</literal> attachment type in an <literal>email</literal> action to automatically
generate a Kibana report and distribute it via email.</simpara>
<simpara>For example, the following watch generates a report that contains the
<emphasis role="strong">Error Monitoring</emphasis> dashboard and emails the report every hour:</simpara>
<programlisting language="js" linenumbering="unnumbered">PUT _xpack/watcher/watch/error_report
{
  "trigger" : {
    "schedule": {
      "interval": "1h"
    }
  },
  "actions" : {
  "email_admin" : { <co id="CO45-1"/>
    "email": {
      "to": "'Recipient Name &lt;recipient@example.com&gt;'",
      "subject": "Error Monitoring Report",
      "attachments" : {
        "error_report.pdf" : {
          "http" : {
            "content_type" : "application/pdf",
            "request" : {
              "method": "POST", <co id="CO45-2"/>
              "headers": {
                "kbn-xsrf": "reporting"
              },
              "read_timeout": "300s", <co id="CO45-3"/>
              "url": "http://0.0.0.0:5601/api/reporting/generate/dashboard/Error-Monitoring?_g=(time:(from:now-1d%2Fd,mode:quick,to:now))&amp;sync" <co id="CO45-4"/>
            }
          }
        }
      }
    }
  }
 }
}</programlisting>
<remark> CONSOLE</remark>
<calloutlist>
<callout arearefs="CO45-1">
<para>
You must <ulink url="https://www.elastic.co/guide/en/watcher/current/email-services.html#email-account">
configure at least one email account</ulink> to enable Watcher to send email.
</para>
</callout>
<callout arearefs="CO45-2">
<para>
Requests to the Reporting endpoints must use POST and include the
<literal>kbn-xsrf</literal> header.
</para>
</callout>
<callout arearefs="CO45-3">
<para>
Increase the <literal>read_timeout</literal> to give X-Pack reporting enough time to generate the
report.
</para>
</callout>
<callout arearefs="CO45-4">
<para>
This is an example Generation URL. You can copy and paste the URL for any
report from the Kibana UI.
</para>
</callout>
</calloutlist>
<important>
<simpara>The interval between report requests must be longer than the time it
takes to generate the reports&#8212;otherwise, the report queue can back up. To
avoid this, increase the time between report requests.</simpara>
<simpara>By default, report generation times out if the report cannot be generated
within 30 seconds. If you are generating reports that contain complex
visualizations or your machine is slow or under constant heavy load, it
might take longer than 30 seconds to generate a report. You can increase
the timeout by setting <literal>xpack.reporting.queue.timeout</literal> in <literal>kibana.yml</literal>.</simpara>
</important>
<simpara>For more information, see <link linkend="automating-report-generation">Automating Report Generation</link>.</simpara>
</section>
</section>
<section id="email-action-attributes">
<title>Email Action Attributes<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/email.asciidoc">Edit me</ulink></title>
<informaltable
frame="all"
rowsep="1" colsep="1"
>
<tgroup cols="4">
<colspec colname="col_1" colwidth="25*"/>
<colspec colname="col_2" colwidth="25*"/>
<colspec colname="col_3" colwidth="25*"/>
<colspec colname="col_4" colwidth="25*"/>
<thead>
<row>
<entry align="left" valign="top"> Name                  </entry>
<entry align="center" valign="top">Required   </entry>
<entry align="left" valign="top"> Default             </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>account</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>the default account</simpara></entry>
<entry align="left" valign="top"><simpara>The <link linkend="configuring-email">email account</link> to use to send the email.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>from</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The email <link linkend="email-address">address</link> from which the email
                                                            will be sent. The <literal>from</literal> field can contain Mustache
                                                            <link linkend="templates">templates</link> as long as it resolves to a
                                                            valid email address.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>to</literal></simpara></entry>
<entry align="center" valign="top"><simpara>yes</simpara></entry>
<entry align="left" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The email <link linkend="email-address">addresses</link> of the <literal>to</literal> recipients.
                                                            The <literal>to</literal> field can contain Mustache <link linkend="templates">templates</link>
                                                            as long as it resolves to a valid email address.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>cc</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The email <link linkend="email-address">addresses</link> of the <literal>cc</literal> recipients.
                                                            The <literal>cc</literal> field can contain Mustache <link linkend="templates">templates</link>
                                                            as long as it resolves to a valid email address.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>bcc</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The email <link linkend="email-address">addresses</link> of the <literal>bcc</literal> recipients.
                                                            The <literal>bcc</literal> field can contain Mustache <link linkend="templates">templates</link>
                                                            as long as it resolves to a valid email address.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>reply_to</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The email <link linkend="email-address">addresses</link> that will be set on the
                                                            message&#8217;s <literal>Reply-To</literal> header. The <literal>reply_to</literal> field can contain
                                                            Mustache <link linkend="templates">templates</link> as long as it resolves to
                                                            a valid email address.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>subject</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The subject of the email. The subject can be static text or
                                                            contain Mustache <link linkend="templates">templates</link>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>body</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The body of the email. When this field holds a string, it
                                                            will default to the text body of the email. Set as an object
                                                            to specify either the text or the html body or both (using
                                                            the fields below)</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>body.text</literal></simpara></entry>
<entry align="center" valign="top"><simpara>yes</simpara></entry>
<entry align="left" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The plain text body of the email. The body can be static text
                                                            or contain Mustache <link linkend="templates">templates</link>. The email <literal>body</literal>
                                                            must contain at least one <literal>text</literal> or <literal>html</literal> field.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>body.html</literal></simpara></entry>
<entry align="center" valign="top"><simpara>yes</simpara></entry>
<entry align="left" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The html body of the email. The body can be static text or
                                                            contain Mustache <link linkend="templates">templates</link>. This body will be
                                                            sanitized to remove dangerous content such as scripts. This
                                                            behavior can be disabled by setting
                                                            <literal>xpack.notification.email.html.sanitization.enabled: false</literal> in
                                                            <literal>elasticsearch.yaml</literal>. The email <literal>body</literal> must contain at least
                                                            one <literal>text</literal> or <literal>html</literal> field.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>priority</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The priority of this email. Valid values are: <literal>lowest</literal>, <literal>low</literal>,
                                                            <literal>normal</literal>, <literal>high</literal> and <literal>highest</literal>. The priority can contain a
                                                            Mustache <link linkend="templates">template</link> as long as it resolves to
                                                            one of the valid values.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>attachments</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>Attaches the watch payload (<literal>data</literal> attachment) or a file
                                                            retrieved from an HTTP service (<literal>http</literal> attachment) to the
                                                            email. For more information, see
                                                            <link linkend="configuring-email-attachments">Configuring Email Attachments</link>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>attach_data</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>false</simpara></entry>
<entry align="left" valign="top"><simpara>Indicates whether the watch execution data should be attached
                                                            to the email. You can specify a Boolean value or an object.
                                                            If <literal>attach_data</literal> is set to  <literal>true</literal>, the data is attached as a
                                                            YAML file. This attribute is deprecated, use the <literal>attachments</literal>
                                                            attribute to add a <literal>data</literal> attachment to attach the watch payload.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>attach_data.format</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>yaml</simpara></entry>
<entry align="left" valign="top"><simpara>When <literal>attach_data</literal> is specified as an object, this field
                                                            controls the format of the attached data. The supported formats
                                                            are <literal>json</literal> and <literal>yaml</literal>. This attribute is deprecated, use the
                                                            <literal>attachments</literal> attribute to add a <literal>data</literal> attachment to attach
                                                            the watch payload.</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
<variablelist id="email-address">
<varlistentry>
<term>
Email Address
</term>
<listitem>
<simpara>
An email address can contain two possible parts&#8212;the address itself and an
optional personal name as described in <ulink url="http://www.ietf.org/rfc/rfc822.txt">RFC 822</ulink>.
The address can be represented either as a string of the form <literal>user@host.domain</literal>
or <literal>Personal Name &lt;user@host.domain&gt;</literal>. You can also specify an email address as
an object that contains <literal>name</literal> and <literal>address</literal> fields.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
Address List
</term>
<listitem>
<simpara>
A list of addresses can be specified as a an
array: <literal>[ 'Personal Name &lt;user1@host.domain&gt;', 'user2@host.domain' ]</literal>.
</simpara>
</listitem>
</varlistentry>
</variablelist>
</section>
<section id="configuring-email">
<title>Configuring Email Accounts<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/email.asciidoc">Edit me</ulink></title>
<simpara>Watcher can send email using any SMTP email service. Email
messages can contain basic HTML tags. You can control which groups of tags are
allowed by <link linkend="email-html-sanitization">Configuring HTML Sanitization Options</link>.</simpara>
<simpara>You configure the accounts Watcher can use to send email in the
<literal>xpack.notification.email</literal> namespace in <literal>elasticsearch.yml</literal>.</simpara>
<simpara>If your email account is configured to require two step verification, you need
to generate and use a unique App Password to send email from Watcher.
Authentication will fail if you use your primary password.</simpara>
<important><simpara>Currently, neither Watcher nor Shield provide a mechanism to encrypt
settings in <literal>elasticsearch.yml</literal>. Because the email account credentials appear
in plain text, you should limit access to <literal>elasticsearch.yml</literal> to the user that
you use to run Elasticsearch.</simpara></important>
<simpara id="email-profile">Watcher provides three email profiles that control how MIME messages are
structured: <literal>standard</literal> (default), <literal>gmail</literal>, and <literal>outlook</literal>. These profiles
accommodate differences in how various email systems interpret the MIME
standard. If you are using Gmail or Outlook, we recommend using the
corresponding profile. Use the <literal>standard</literal> profile if you are using another
email system.</simpara>
<simpara>For more information about configuring Watcher to work with different email
systems, see:</simpara>
<itemizedlist>
<listitem>
<simpara>
<link linkend="gmail">Sending Email from Gmail</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="outlook">Sending Email from Outlook</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="exchange">Sending Email from Exchange</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="amazon-ses">Sending Email from Amazon SES</link>
</simpara>
</listitem>
</itemizedlist>
<simpara>If you configure multiple email accounts, you must either configure a default
account or specify which account the email should be sent with in the
<link linkend="actions-email"><literal>email</literal></link> action.</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.notification.email:
  default_account: team1
  account:
    team1:
      ...
    team2:
      ...</programlisting>
<bridgehead id="gmail" renderas="sect4">Sending Email From Gmail<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/email.asciidoc">Edit me</ulink></bridgehead>
<simpara>Use the following email account settings to send email from the
<ulink url="https://mail.google.com">Gmail</ulink> SMTP service:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.notification.email.account:
    gmail_account:
        profile: gmail
        smtp:
            auth: true
            starttls.enable: true
            host: smtp.gmail.com
            port: 587
            user: &lt;username&gt;
            password: &lt;password&gt;</programlisting>
<simpara>If you get an authentication error that indicates that you need to continue the
sign-in process from a web browser when Watcher attempts to send email, you need
to configure Gmail to <ulink url="https://support.google.com/accounts/answer/6010255?hl=en">Allow
Less Secure Apps to access your account</ulink>.</simpara>
<simpara>If two-step verification is enabled for your account, you must generate and use
a unique App Password to send email from Watcher. See
<ulink url="https://support.google.com/accounts/answer/185833?hl=en">Sign in using App Passwords</ulink>
for more information.</simpara>
<bridgehead id="outlook" renderas="sect4">Sending Email from Outlook.com<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/email.asciidoc">Edit me</ulink></bridgehead>
<simpara>Use the following email account settings to send email action from the
<ulink url="https://www.outlook.com/">Outlook.com</ulink> SMTP service:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.notification.email.account:
    outlook_account:
        profile: outlook
        smtp:
            auth: true
            starttls.enable: true
            host: smtp-mail.outlook.com
            port: 587
            user: &lt;username&gt;
            password: &lt;password&gt;</programlisting>
<note><simpara>You need to use a unique App Password if two-step verification is enabled.
        See <ulink url="http://windows.microsoft.com/en-us/windows/app-passwords-two-step-verification">App
        passwords and two-step verification</ulink> for more information.</simpara></note>
<bridgehead id="amazon-ses" renderas="sect4">Sending Email from Amazon SES (Simple Email Service)<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/email.asciidoc">Edit me</ulink></bridgehead>
<simpara>Use the following email account settings to send email from the
<ulink url="http://aws.amazon.com/ses">Amazon Simple Email Service</ulink> (SES) SMTP service:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.notification.email.account:
    ses_account:
        smtp:
            auth: true
            starttls.enable: true
            starttls.required: true
            host: email-smtp.us-east-1.amazonaws.com <co id="CO46-1"/>
            port: 587
            user: &lt;username&gt;
            password: &lt;password&gt;</programlisting>
<calloutlist>
<callout arearefs="CO46-1">
<para>
<literal>smtp.host</literal> varies depending on the region
</para>
</callout>
</calloutlist>
<note><simpara>You need to use your Amazon SES SMTP credentials to send email through
        Amazon SES. For more information, see
        <ulink url="http://docs.aws.amazon.com/ses/latest/DeveloperGuide/smtp-credentials.html">Obtaining
        Your Amazon SES SMTP Credentials</ulink>. You might also need to verify
        <ulink url="https://docs.aws.amazon.com/ses/latest/DeveloperGuide/verify-email-addresses.html">your email address</ulink>
        or <ulink url="https://docs.aws.amazon.com/ses/latest/DeveloperGuide/verify-domains.html">your whole domain</ulink>
        at AWS.</simpara></note>
<bridgehead id="exchange" renderas="sect4">Sending Email from Microsoft Exchange<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/email.asciidoc">Edit me</ulink></bridgehead>
<simpara>Use the following email account settings to send email action from Microsoft
Exchange:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.notification.email.account:
    exchange_account:
        profile: outlook
        email_defaults:
            from: &lt;email address of service account&gt; <co id="CO47-1"/>
        smtp:
            auth: true
            starttls.enable: true
            host: &lt;your exchange server&gt;
            port: 587
            user: &lt;email address of service account&gt; <co id="CO47-2"/>
            password: &lt;password&gt;</programlisting>
<calloutlist>
<callout arearefs="CO47-1">
<para>
Some organizations configure Exchange to validate that the <literal>from</literal> field is a
    valid local email account.
</para>
</callout>
<callout arearefs="CO47-2">
<para>
Many organizations support use of your email address as your username, though
    it is a good idea to check with your system administrator if you receive
    authentication-related failures.
</para>
</callout>
</calloutlist>
<bridgehead id="email-html-sanitization" renderas="sect4">Configuring HTML Sanitization Options<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/email.asciidoc">Edit me</ulink></bridgehead>
<simpara>The <literal>email</literal> action supports sending messages with an HTML body. However, for
security reasons, Watcher <ulink url="https://en.wikipedia.org/wiki/HTML_sanitization">sanitizes</ulink>
the HTML.</simpara>
<simpara>You can control which HTML features are allowed or disallowed by configuring the
<literal>xpack.notification.email.html.sanitization.allow</literal> and
<literal>xpack.notification.email.html.sanitization.disallow</literal> settings in
<literal>elasticsearch.yml</literal>. You can specify individual HTML elements and
<link linkend="html-feature-groups">HTML feature groups</link>. By default, Watcher allows the following
features: <literal>body</literal>, <literal>head</literal>, <literal>_tables</literal>, <literal>_links</literal>, <literal>_blocks</literal>, <literal>_formatting</literal> and
<literal>img:embedded</literal>.</simpara>
<simpara>For example, the following settings allow the HTML to contain tables and block
elements, but disallow  <literal>&lt;h4&gt;</literal>, <literal>&lt;h5&gt;</literal> and <literal>&lt;h6&gt;</literal> tags.</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.notification.email.html.sanitization:
    allow: _tables, _blocks
    disallow: h4, h5, h6</programlisting>
<simpara>To disable sanitization entirely, add the following setting to
<literal>elasticsearch.yml</literal>:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.notification.email.html.sanitization.enabled: false</programlisting>
</section>
</section>
<section id="actions-webhook">
<title>Webhook Action<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/webhook.asciidoc">Edit me</ulink></title>
<simpara>Use the <literal>webhook</literal> action to send a request to any web service. The
webhook action supports both HTTP and HTTPS connections. See
<link linkend="webhook-action-attributes">Webhook Action Attributes</link> for the supported
attributes.</simpara>
<section id="configuring-webook-actions">
<title>Configuring Webhook Actions<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/webhook.asciidoc">Edit me</ulink></title>
<simpara>You configure webhook actions in the <literal>actions</literal> array. Action-specific attributes
are specified using the <literal>webhook</literal> keyword.</simpara>
<simpara>The following snippet shows a simple webhook action definition:</simpara>
<programlisting language="js" linenumbering="unnumbered">"actions" : {
  "my_webhook" : { <co id="CO48-1"/>
    "transform" : { ... }, <co id="CO48-2"/>
    "throttle_period" : "5m", <co id="CO48-3"/>
    "webhook" : {
      "method" : "POST", <co id="CO48-4"/>
      "host" : "mylisteningserver", <co id="CO48-5"/>
      "port" : 9200, <co id="CO48-6"/>
      "path": ":/{{ctx.watch_id}", <co id="CO48-7"/>
      "body" : "{{ctx.watch_id}}:{{ctx.payload.hits.total}}" <co id="CO48-8"/>
    }
  }
}</programlisting>
<calloutlist>
<callout arearefs="CO48-1">
<para>
The id of the action
</para>
</callout>
<callout arearefs="CO48-2">
<para>
An optional <link linkend="transform">transform</link> to transform the payload before
    executing the <literal>webhook</literal> action
</para>
</callout>
<callout arearefs="CO48-3">
<para>
An optional <link linkend="actions-ack-throttle">throttle period</link> for the action
    (5 minutes in this example)
</para>
</callout>
<callout arearefs="CO48-4">
<para>
The HTTP method to use when connecting to the host
</para>
</callout>
<callout arearefs="CO48-5">
<para>
The host to connect to
</para>
</callout>
<callout arearefs="CO48-6">
<para>
The port to connect to
</para>
</callout>
<callout arearefs="CO48-7">
<para>
The path (URI) to use in the HTTP request
</para>
</callout>
<callout arearefs="CO48-8">
<para>
The body to send with the request
</para>
</callout>
</calloutlist>
<simpara>You can use basic authentication when sending a request to a secured webservice.
For example, the following <literal>webhook</literal> action creates a new issue in GitHub:</simpara>
<programlisting language="js" linenumbering="unnumbered">"actions" : {
  "create_github_issue" : {
    "webhook" : {
      "method" : "POST",
      "url" : "https://api.github.com/repos/&lt;owner&gt;/&lt;repo&gt;/issues",
      "body" : "{
        \"title\": \"Found errors in 'contact.html'\",
        \"body\": \"Found {{ctx.payload.hits.total}} errors in the last 5 minutes\",
        \"assignee\": \"web-admin\",
        \"labels\": [ \"bug\", \"sev2\" ]
      }",
      "auth" : {
        "basic" : {
          "username" : "&lt;username&gt;", <co id="CO49-1"/>
          "password" : "&lt;password&gt;"
        }
      }
    }
  }
}</programlisting>
<calloutlist>
<callout arearefs="CO49-1">
<para>
The username and passwword for the user creating the issue
</para>
</callout>
</calloutlist>
<note><simpara>By default, both the username and the password are stored in the <literal>.watches</literal>
      index in plain text. When X-Pack security is enabled, Watcher can encrypt the
      password before storing it.</simpara></note>
<simpara>You can also use PKI-based authentication when submitting requests to a cluster
secured with X-Pack security. When you use PKI-based authentication instead of HTTP
basic auth, you don&#8217;t need to store any authentication information in the watch
itself. To use PKI-based authentication, you <link linkend="ssl-notification-settings">configure the SSL key settings</link> for Watcher in <literal>elasticsearch.yml</literal>.</simpara>
</section>
<section id="webhook-query-parameters">
<title>Query Parameters<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/webhook.asciidoc">Edit me</ulink></title>
<simpara>You can specify query parameters to send with the request with the <literal>params</literal> field.
This field simply holds an object where the keys serve as the parameter names and
the values serve as the parameter values:</simpara>
<programlisting language="js" linenumbering="unnumbered">"actions" : {
  "my_webhook" : {
    "webhook" : {
      "method" : "POST",
      "host" : "mylisteningserver",
      "port" : 9200,
      "path": ":/alert",
      "params" : {
        "watch_id" : "{{ctx.watch_id}}" <co id="CO50-1"/>
      }
    }
  }
}</programlisting>
<calloutlist>
<callout arearefs="CO50-1">
<para>
The parameter values can contain templated strings.
</para>
</callout>
</calloutlist>
</section>
<section id="webhook-custom-request-headers">
<title>Custom Request Headers<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/webhook.asciidoc">Edit me</ulink></title>
<simpara>You can specify request headers to send with the request with the <literal>headers</literal> field.
This field simply holds an object where the keys serve as the header names and
the values serve as the header values:</simpara>
<programlisting language="js" linenumbering="unnumbered">"actions" : {
  "my_webhook" : {
    "webhook" : {
      "method" : "POST",
      "host" : "mylisteningserver",
      "port" : 9200,
      "path": ":/alert/{{ctx.watch_id}}",
      "headers" : {
        "Content-Type" : "application/yaml" <co id="CO51-1"/>
      },
      "body" : "count: {{ctx.payload.hits.total}}"
    }
  }
}</programlisting>
<calloutlist>
<callout arearefs="CO51-1">
<para>
The header values can contain templated strings.
</para>
</callout>
</calloutlist>
</section>
<section id="_webhook_action_attributes">
<title>Webhook Action Attributes<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/webhook.asciidoc">Edit me</ulink></title>
<informaltable id="webhook-action-attributes"
frame="all"
rowsep="1" colsep="1"
>
<tgroup cols="4">
<colspec colname="col_1" colwidth="25*"/>
<colspec colname="col_2" colwidth="25*"/>
<colspec colname="col_3" colwidth="25*"/>
<colspec colname="col_4" colwidth="25*"/>
<thead>
<row>
<entry align="left" valign="top"> Name                  </entry>
<entry align="center" valign="top">Required   </entry>
<entry align="center" valign="top"> Default     </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>scheme</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="center" valign="top"><simpara>http</simpara></entry>
<entry align="left" valign="top"><simpara>The connection scheme. Valid values are: <literal>http</literal> or <literal>https</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>host</literal></simpara></entry>
<entry align="center" valign="top"><simpara>yes</simpara></entry>
<entry align="center" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The host to connect to.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>port</literal></simpara></entry>
<entry align="center" valign="top"><simpara>yes</simpara></entry>
<entry align="center" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The port the HTTP service is listening on.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>path</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="center" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The URL path. The path can be static text or include Mustache
                                                    <link linkend="templates">templates</link>. URL query string parameters must be
                                                    specified via the <literal>request.params</literal> attribute.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>method</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="center" valign="top"><simpara>get</simpara></entry>
<entry align="left" valign="top"><simpara>The HTTP method. Valid values are: <literal>head</literal>, <literal>get</literal>, <literal>post</literal>, <literal>put</literal>
                                                    and <literal>delete</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>headers</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="center" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The HTTP request headers. The header values can be static text
                                                    or include Mustache <link linkend="templates">templates</link>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>params</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="center" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The URL query string parameters. The parameter values can be
                                                    static text or include Mustache <link linkend="templates">templates</link>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>auth</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="center" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>Authentication related HTTP headers. Currently, only basic
                                                    authentication is supported.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>body</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="center" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The HTTP request body. The body can be static text or include
                                                    Mustache <link linkend="templates">templates</link>. When not specified, an empty
                                                    body is sent.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>proxy.host</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="center" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The proxy host to use when connecting to the host.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>proxy.port</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="center" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The proxy port to use when connecting to the host.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>connection_timeout</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="center" valign="top"><simpara>10s</simpara></entry>
<entry align="left" valign="top"><simpara>The timeout for setting up the http connection. If the connection
                                                    could not be set up within this time, the action will timeout and
                                                    fail.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>read_timeout</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="center" valign="top"><simpara>10s</simpara></entry>
<entry align="left" valign="top"><simpara>The timeout for reading data from http connection. If no response
                                                    was received within this time, the action will timeout and fail.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>url</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="center" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>A shortcut for specifying the request scheme, host, port, and
                                                    path as a single string. For example, <literal>http://example.org/foo/my-service</literal>.</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
</section>
</section>
<section id="actions-index">
<title>Index Action<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/index.asciidoc">Edit me</ulink></title>
<simpara>Use the <literal>index</literal> action to index data into Elasticsearch.
See <xref linkend="index-action-attributes"/> for the supported attributes.</simpara>
<section id="_configuring_index_actions">
<title>Configuring Index Actions<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/index.asciidoc">Edit me</ulink></title>
<simpara>The following snippet shows a simple <literal>index</literal> action definition:</simpara>
<programlisting language="js" linenumbering="unnumbered">"actions" : {
  "index_payload" : { <co id="CO52-1"/>
    "condition": { ... }, <co id="CO52-2"/>
    "transform": { ... }, <co id="CO52-3"/>
    "index" : {
      "index" : "my-index", <co id="CO52-4"/>
      "doc_type" : "my-type" <co id="CO52-5"/>
    }
  }
}</programlisting>
<calloutlist>
<callout arearefs="CO52-1">
<para>
The id of the action
</para>
</callout>
<callout arearefs="CO52-2">
<para>
An optional <link linkend="condition">condition</link> to restrict action execution
</para>
</callout>
<callout arearefs="CO52-3">
<para>
An optional <link linkend="transform">transform</link> to transform the payload and prepare the data that should be indexed
</para>
</callout>
<callout arearefs="CO52-4">
<para>
The elasticsearch index to store the data to
</para>
</callout>
<callout arearefs="CO52-5">
<para>
The document type to store the data as
</para>
</callout>
</calloutlist>
</section>
<section id="index-action-attributes">
<title>Index Action Attributes<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/index.asciidoc">Edit me</ulink></title>
<informaltable
frame="all"
rowsep="1" colsep="1"
>
<tgroup cols="4">
<colspec colname="col_1" colwidth="25*"/>
<colspec colname="col_2" colwidth="25*"/>
<colspec colname="col_3" colwidth="25*"/>
<colspec colname="col_4" colwidth="25*"/>
<thead>
<row>
<entry align="left" valign="top">Name                     </entry>
<entry align="left" valign="top">Required    </entry>
<entry align="left" valign="top"> Default    </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>index</literal></simpara></entry>
<entry align="left" valign="top"><simpara>yes</simpara></entry>
<entry align="left" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The Elasticsearch index to index into.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>doc_type</literal></simpara></entry>
<entry align="left" valign="top"><simpara>yes</simpara></entry>
<entry align="left" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The type of the document the data will be indexed as.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>execution_time_field</literal></simpara></entry>
<entry align="left" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The field that will store/index the watch execution
                                                      time.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>timeout</literal></simpara></entry>
<entry align="left" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>60s</simpara></entry>
<entry align="left" valign="top"><simpara>The timeout for waiting for the index api call to
                                                      return. If no response is returned within this time,
                                                      the index action times out and fails. This setting
                                                      overrides  the default  timeouts.</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
</section>
<section id="anatomy-actions-index-multi-doc-support">
<title>Multi-Document Support<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/index.asciidoc">Edit me</ulink></title>
<simpara>Like with all other actions, you can use a <link linkend="transform">transform</link> to replace
the current execution context payload with another and by that change the document
that will end up indexed.</simpara>
<simpara>The index action plays well with transforms with its support for the special <literal>_doc</literal>
payload field.</simpara>
<simpara>When resolving the document to be indexed, the index action first looks up for a
<literal>_doc</literal> field in the payload. When not found, the payload is indexed as a single
document.</simpara>
<simpara>When a <literal>_doc</literal> field exists, if the field holds an object, it is extracted and indexed
as a single document. If the field holds an array of objects, each object is treated as
a document and the index aciton indexes all of them in a bulk.</simpara>
</section>
</section>
<section id="actions-logging">
<title>Logging Action<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/logging.asciidoc">Edit me</ulink></title>
<simpara>Use the <literal>logging</literal> action to log text to the standard Elasticsearch
logs. See <xref linkend="logging-action-attributes"/> for the supported attributes.</simpara>
<simpara>This action is primarily used during development and for debugging purposes.</simpara>
<section id="configuring-logging-actions">
<title>Configuring Logging Actions<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/logging.asciidoc">Edit me</ulink></title>
<simpara>You configure logging actions in the <literal>actions</literal> array. Action-specific attributes
are specified using the <literal>logging</literal> keyword.</simpara>
<simpara>The following snippet shows a simple logging action definition:</simpara>
<programlisting language="js" linenumbering="unnumbered">"actions" : {
  "log" : { <co id="CO53-1"/>
    "transform" : { ... }, <co id="CO53-2"/>
    "logging" : {
      "text" : "executed at {{ctx.execution_time}}" <co id="CO53-3"/>
    }
  }
}</programlisting>
<calloutlist>
<callout arearefs="CO53-1">
<para>
The id of the action.
</para>
</callout>
<callout arearefs="CO53-2">
<para>
An optional <link linkend="transform">transform</link> to transform the payload before
    executing the <literal>logging</literal> action.
</para>
</callout>
<callout arearefs="CO53-3">
<para>
The text to be logged.
</para>
</callout>
</calloutlist>
</section>
<section id="logging-action-attributes">
<title>Logging Action Attributes<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/logging.asciidoc">Edit me</ulink></title>
<informaltable
frame="all"
rowsep="1" colsep="1"
>
<tgroup cols="4">
<colspec colname="col_1" colwidth="25*"/>
<colspec colname="col_2" colwidth="25*"/>
<colspec colname="col_3" colwidth="25*"/>
<colspec colname="col_4" colwidth="25*"/>
<thead>
<row>
<entry align="left" valign="top"> Name        </entry>
<entry align="left" valign="top">Required </entry>
<entry align="left" valign="top"> Default                       </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>text</literal></simpara></entry>
<entry align="left" valign="top"><simpara>yes</simpara></entry>
<entry align="left" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The text that should be logged. Can be static text or
                                                          include Mustache <link linkend="templates">templates</link>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>category</literal></simpara></entry>
<entry align="left" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>xpack.watcher.actions.logging</simpara></entry>
<entry align="left" valign="top"><simpara>The category under which the text will be logged.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>level</literal></simpara></entry>
<entry align="left" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>info</simpara></entry>
<entry align="left" valign="top"><simpara>The logging level. Valid values are: <literal>error</literal>, <literal>warn</literal>,
                                                          <literal>info</literal>, <literal>debug</literal> and <literal>trace</literal>.</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
</section>
</section>
<section id="actions-hipchat">
<title>HipChat Action<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/hipchat.asciidoc">Edit me</ulink></title>
<simpara>Use the <literal>hipchat</literal> action to send messages to <ulink url="https://www.hipchat.com">HipChat</ulink>
rooms or users. To send HipChat messages, you must &lt;&lt;<link linkend="configuring-hipchat">configure at least one HipChat account</link> in <literal>elasticsearch.yml</literal>.</simpara>
<section id="configuring-hipchat-actions">
<title>Configuring HipChat Actions<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/hipchat.asciidoc">Edit me</ulink></title>
<simpara>You configure HipChat actions in a <literal>actions</literal> array. Action-specific attributes
are specified using the <literal>hipchat</literal> keyword. You must specify the <literal>message</literal>
attribute for all <literal>hipchat</literal> actions. If you omit the <literal>account</literal> attribute, the
message is sent using the default HipChat account configured in
<literal>elasticsearch.yml</literal>.</simpara>
<simpara>For example, the following action is configured to send messages using a HipChat
account that uses the <link linkend="hipchat-api-integration">integration</link> profile. Because
this type of account can only send messages to a specific room, the only required
attribute is the message itself:</simpara>
<programlisting language="js" linenumbering="unnumbered">"actions" : {
  "notify-hipchat" : {
    "transform" : { ... },
    "throttle_period" : "5m",
    "hipchat" : {
      "account" : "integration-account", <co id="CO54-1"/>
      "message" : {
        "body" : "Encountered  {{ctx.payload.hits.total}} errors in the last 5 minutes (facepalm)", <co id="CO54-2"/>
        "format" : "text",
        "color" : "red",
        "notify" : true
      }
    }
  }
}</programlisting>
<calloutlist>
<callout arearefs="CO54-1">
<para>
The name of a HipChat account configured in <literal>elasticsearch.yml</literal>.
</para>
</callout>
<callout arearefs="CO54-2">
<para>
The message you want to send to HipChat.
</para>
</callout>
</calloutlist>
<simpara>To send messages with a HipChat account that uses the <link linkend="hipchat-api-user">user</link>
profile, you need to specify what rooms and users you want to send the message to.
For example, the following action is configured to send messages to the
<literal>mission-control</literal> and <literal>devops</literal> rooms as well as the user <literal>website-admin@example.com</literal>.
(To send to multiple users or rooms, specify an array of strings):</simpara>
<programlisting language="js" linenumbering="unnumbered">"actions" : {
  "notify-hipchat" : {
    "transform" : { ... },
    "throttle_period" : "5m",
    "hipchat" : {
      "account" : "user-account",
      "message" : {
        "room" : [ "mission-control", "devops" ],
        "user" : "website-admin@example.com",
        "body" : "Encountered  {{ctx.payload.hits.total}} errors in the last 5 minutes (facepalm)",
        "format" : "text",
        "color" : "red",
        "notify" : true
      }
    }
  }
}</programlisting>
<simpara>To send messages with a HipChat account that uses the <link linkend="hipchat-api-v1">v1</link>
profile, you need to specify what room or rooms you want to send the message to.
For example, the following action is configured to send messages to the
<literal>server-status</literal> room. (To send to multiple rooms, specify an array of strings.)</simpara>
<programlisting language="js" linenumbering="unnumbered">"actions" : {
  "notify-hipchat" : {
    "transform" : { ... },
    "throttle_period" : "5m",
    "hipchat" : {
      "account" : "v1-account",
      "message" : {
        "from" : "Watcher",
        "room" : [ "server-status", "infra-team" ],
        "body" : "Encountered  {{ctx.payload.hits.total}} errors in the last 5 minutes (facepalm)",
        "format" : "text",
        "color" : "red",
        "notify" : true
      }
    }
  }
}</programlisting>
</section>
<section id="hipchat-action-attributes">
<title>HipChat Action Attributes<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/hipchat.asciidoc">Edit me</ulink></title>
<informaltable
frame="all"
rowsep="1" colsep="1"
>
<tgroup cols="4">
<colspec colname="col_1" colwidth="25*"/>
<colspec colname="col_2" colwidth="25*"/>
<colspec colname="col_3" colwidth="25*"/>
<colspec colname="col_4" colwidth="25*"/>
<thead>
<row>
<entry align="left" valign="top"> Name              </entry>
<entry align="center" valign="top">Required </entry>
<entry align="left" valign="top"> Default         </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>account</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Default account</simpara></entry>
<entry align="left" valign="top"><simpara>The HipChat account to use to send the message.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>message.body</literal></simpara></entry>
<entry align="center" valign="top"><simpara>yes</simpara></entry>
<entry align="left" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The message content. Can contain up to 1000 characters.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>message.format</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>html</simpara></entry>
<entry align="left" valign="top"><simpara>The format of the message: <literal>text</literal> or <literal>html</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>message.color</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>yellow</simpara></entry>
<entry align="left" valign="top"><simpara>The background color of the notification in the room:
                                                  <literal>gray</literal>, <literal>green</literal>, <literal>purple</literal>, <literal>red</literal>, <literal>yellow</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>message.notify</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>false</simpara></entry>
<entry align="left" valign="top"><simpara>Indicates whether people in the room should be actively
                                                  notified</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>message.from</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>the watch ID</simpara></entry>
<entry align="left" valign="top"><simpara>The name that appears as the notification sender. Only
                                                  valid for accounts that use the v1 profile.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>message.room</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The rooms that the notification should go to. Accepts
                                                  a string value or an array of string values. Must be
                                                  specified when using the v1 profile. At least one room
                                                  or user must be specified when using the <literal>user</literal> profile.
                                                  Not valid for the <literal>integration</literal> profile.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>message.user</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The users that the notification should go to. Accepts
                                                  a string value or an array of string values. At least
                                                  one room or user must be specified when using the <literal>user</literal>
                                                  profile. Not valid for the <literal>integration</literal> or <literal>v1</literal> profiles.</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
</section>
<section id="configuring-hipchat">
<title>Configuring HipChat Accounts<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/hipchat.asciidoc">Edit me</ulink></title>
<simpara>You configure the accounts Watcher can use to communicate with HipChat in the
<literal>xpack.notification.hipchat</literal> namespace in <literal>elasticsearch.yml</literal>. Both
<ulink url="https://www.hipchat.com/docs/api">v1</ulink> and
<ulink url="https://www.hipchat.com/docs/apiv2">v2</ulink> HipChat APIs are supported.</simpara>
<simpara>Watcher provides three HipChat API profiles:</simpara>
<variablelist>
<varlistentry>
<term>
<link linkend="hipchat-api-integration">integration</link>
</term>
<listitem>
<simpara>
Sends messages to a specific room using HipChat&#8217;s v2 API
<ulink url="https://www.hipchat.com/docs/apiv2/method/send_room_notification">Send room
notification</ulink>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<link linkend="hipchat-api-user">user</link>
</term>
<listitem>
<simpara>
Sends messages as a particular user through the HipChat v2 API. Enables you to
send messages to arbitrary rooms or users.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<link linkend="hipchat-api-v1">v1</link>
</term>
<listitem>
<simpara>
Sends messages to rooms using HipChat&#8217;s v1 API
<ulink url="https://www.hipchat.com/docs/api/method/rooms/message">rooms/message</ulink>.
</simpara>
<note><simpara>The <literal>v1</literal> profile is provided because it is simple to set up and this API
      is familiar to many users. That said, HipChat has deprecated the v1 API
      and is encouraging users to migrate to v2. Both the <literal>integration</literal> and
      <literal>user</literal> profiles are based on the HipChat v2 API.</simpara></note>
</listitem>
</varlistentry>
</variablelist>
<simpara>If you configure multiple HipChat accounts, you either need to set a default
HipChat account or specify which account the notification should be sent with
in the <link linkend="actions-hipchat">hipchat</link> action.</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.notification.hipchat:
  default_account: team1
  account:
    team1:
      ...
    team2:
      ...</programlisting>
<section id="hipchat-api-integration">
<title>Using the Hipchat Integration Profile<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/hipchat.asciidoc">Edit me</ulink></title>
<simpara>You can use the <literal>integration</literal> profile to send messages to specific rooms. When
you set an account&#8217;s profile to <literal>integration</literal>, the messages are sent through
HipChat&#8217;s v2 <ulink url="https://www.hipchat.com/docs/apiv2/method/send_room_notification">
Send room notification</ulink> API.</simpara>
<simpara>When you use the <literal>integration</literal> profile, you need to configure a separate HipChat
account for each room you want to send messages&#8212;the account configuration
contains a room-specific authentication token. Alternatively, you can use the
<link linkend="hipchat-api-user"><literal>user</literal></link> or <link linkend="hipchat-api-v1"><literal>v1</literal></link> profile to send messages
to multiple rooms.</simpara>
<note><simpara>The <literal>integration</literal> profile only supports sending messages to rooms, it does
      not support sending private messages. Use the <link linkend="hipchat-api-user"><literal>user</literal></link>
      profile to notify a particular HipChat user.</simpara></note>
<simpara>You need a room-specific authentication token to configure an <literal>integration</literal>
account. To generate an authentication token:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Log in to <ulink url="http://hipchat.com">hipchat.com</ulink> or your HipChat server as a group
  administrator.
</simpara>
</listitem>
<listitem>
<simpara>
Go to <emphasis role="strong">Group admin &gt; Rooms</emphasis>.
</simpara>
</listitem>
<listitem>
<simpara>
Click the name of the room you want to send messages to.
</simpara>
</listitem>
<listitem>
<simpara>
Click the <emphasis role="strong">Tokens</emphasis> link.
</simpara>
</listitem>
<listitem>
<simpara>
Enter a name for the token in the <emphasis role="strong">Label</emphasis> field.
</simpara>
<informalfigure>
<mediaobject>
  <imageobject>
  <imagedata fileref="images/watcher/hipchat-generate-room-token.jpg"/>
  </imageobject>
  <textobject><phrase>hipchat-generate-room-token.jpg</phrase></textobject>
</mediaobject>
</informalfigure>
</listitem>
<listitem>
<simpara>
Select the <emphasis role="strong">Send Notification</emphasis> scope.
</simpara>
</listitem>
<listitem>
<simpara>
Click <emphasis role="strong">Create</emphasis>.
</simpara>
</listitem>
<listitem>
<simpara>
Copy the generated token so you can paste it into your HipChat account
  configuration in <literal>elasticsearch.yml</literal>.
</simpara>
<informalfigure>
<mediaobject>
  <imageobject>
  <imagedata fileref="images/watcher/hipchat-copy-room-token.jpg"/>
  </imageobject>
  <textobject><phrase>hipchat-copy-room-token.jpg</phrase></textobject>
</mediaobject>
</informalfigure>
</listitem>
</orderedlist>
<simpara>To configure a HipChat account that uses the <literal>integration</literal> profile:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Set the <literal>type</literal> to <literal>integration</literal>.
</simpara>
</listitem>
<listitem>
<simpara>
Set <literal>room</literal> to the name of the room you want to send messages to.
</simpara>
</listitem>
<listitem>
<simpara>
Set <literal>auth_token</literal> to the room-specific authentication token.
</simpara>
</listitem>
</orderedlist>
<simpara>For example, the following snippet configures an account called
<literal>notify-monitoring</literal> that sends messages to the <literal>monitoring</literal> room:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.notification.hipchat:
  account:
    notify-monitoring:
      profile: integration
      auth_token: 3eLB803Nyp7UBmegJwP1rMdUmzk5HqnzJCgflrhv
      room: monitoring</programlisting>
<simpara>You can also specify defaults for the <link linkend="hipchat-account-attributes">message attributes</link>:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.notification.hipchat:
  account:
    notify-monitoring:
      profile: integration
      auth_token: 3eLB803Nyp7UBmegJwP1rMdUmzk5HqnzJCgflrhv
      room: monitoring
      message:
        format: text
        color: blue
        notify: true</programlisting>
</section>
<section id="hipchat-api-user">
<title>Using the HipChat User Profile<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/hipchat.asciidoc">Edit me</ulink></title>
<simpara>You can use the <literal>user</literal> profile to send messages to rooms as well as individual
HipChat users. When you set an account&#8217;s profile to <literal>user</literal>, Watcher sends
messages as a particular user through the HipChat v2 API.</simpara>
<simpara>Before you can configure a <literal>user</literal> account, you need to:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Add a HipChat user for Watcher. When setting the user name, keep in mind that
  the messages are sent on behalf of this user.
</simpara>
</listitem>
<listitem>
<simpara>
Create an API token for the Watcher user:
</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>
Log in to HipChat as the Watcher user.
</simpara>
</listitem>
<listitem>
<simpara>
Go to <literal>https://&lt;hipchat-server&gt;/account/api</literal>. For example,
   <literal>https://www.hipchat.com/account/api</literal>.
</simpara>
</listitem>
<listitem>
<simpara>
Confirm the user password.
</simpara>
</listitem>
<listitem>
<simpara>
Enter a name for the token in the <emphasis role="strong">Label</emphasis> field.
</simpara>
<informalfigure>
<mediaobject>
  <imageobject>
  <imagedata fileref="images/watcher/hipchat-generate-user-token.jpg"/>
  </imageobject>
  <textobject><phrase>hipchat-generate-user-token.jpg</phrase></textobject>
</mediaobject>
</informalfigure>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>
Select the <emphasis role="strong">Send Notification</emphasis> and <emphasis role="strong">Send Message</emphasis> scopes.
</simpara>
</listitem>
<listitem>
<simpara>
Click <emphasis role="strong">Create</emphasis>.
</simpara>
</listitem>
<listitem>
<simpara>
Copy the generated token so you can paste it into your HipChat account
  configuration in <literal>elasticsearch.yml</literal>.
</simpara>
<informalfigure>
<mediaobject>
  <imageobject>
  <imagedata fileref="images/watcher/hipchat-copy-room-token.jpg"/>
  </imageobject>
  <textobject><phrase>hipchat-copy-room-token.jpg</phrase></textobject>
</mediaobject>
</informalfigure>
</listitem>
</orderedlist>
<simpara>To configure a HipChat account that uses the <literal>user</literal> profile:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Set the <literal>type</literal> to <literal>user</literal>.
</simpara>
</listitem>
<listitem>
<simpara>
Set <literal>user</literal> to the email address associated with the Watcher user.
</simpara>
</listitem>
<listitem>
<simpara>
Set <literal>auth_token</literal> to the Watcher user&#8217;s authentication token.
</simpara>
</listitem>
</orderedlist>
<simpara>For example, the following configuration creates an account called
<literal>notify-monitoring</literal> that sends messages to the <literal>monitoring</literal> room:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.notification.hipchat:
  account:
    notify-monitoring:
      profile: user
      user: watcher-user@example.com
      auth_token: 3eLB803Nyp7UBmegJwP1rMdUmzk5HqnzJCgflrhv</programlisting>
<simpara>You can also specify defaults for the <link linkend="hipchat-account-attributes">message attributes</link>:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.notification.hipchat:
  account:
    notify-monitoring:
      profile: user
      user: watcher-user@example.com
      auth_token: 3eLB803Nyp7UBmegJwP1rMdUmzk5HqnzJCgflrhv
      message:
        format: text
        color: blue
        notify: true</programlisting>
</section>
<section id="hipchat-api-v1">
<title>Using the HipChat v1 Profile<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/hipchat.asciidoc">Edit me</ulink></title>
<simpara>You can use the <literal>v1</literal> profile to send messages to particular rooms. When you set
an account&#8217;s profile to <literal>v1</literal>, messages are sent through HipChat&#8217;s v1
<ulink url="https://www.hipchat.com/docs/api/method/rooms/message">rooms/message</ulink> API.</simpara>
<warning><simpara>The <literal>v1</literal> profile uses a deprecated API that is expected to be removed
          by HipChat in the future.</simpara></warning>
<simpara>The <literal>v1</literal> profile only supports sending messages to rooms, it does not support
sending private messages. Use the <link linkend="hipchat-api-user"><literal>user</literal></link> profile to send
private messages to HipChat users.</simpara>
<simpara>Before you can configure a <literal>v1</literal> account, you need to generate a <literal>v1</literal> API token:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Log in to your HipChat server as a group admin.
</simpara>
</listitem>
<listitem>
<simpara>
Go to <literal>https://&lt;hipchat-server&gt;/admin/api</literal>. For example,
  <literal>https://hipchat.com/admin/api</literal>.
</simpara>
</listitem>
<listitem>
<simpara>
Confirm your admin password.
</simpara>
</listitem>
<listitem>
<simpara>
Select the <emphasis role="strong">Notification</emphasis> type.
</simpara>
<informalfigure>
<mediaobject>
  <imageobject>
  <imagedata fileref="images/watcher/hipchat-generate-v1-token.jpg"/>
  </imageobject>
  <textobject><phrase>hipchat-generate-v1-token.jpg</phrase></textobject>
</mediaobject>
</informalfigure>
</listitem>
<listitem>
<simpara>
Enter a name for the token in the <emphasis role="strong">Label</emphasis> field.
</simpara>
</listitem>
<listitem>
<simpara>
Click <emphasis role="strong">Create</emphasis>.
</simpara>
</listitem>
<listitem>
<simpara>
Copy the generated token so you can paste it into your HipChat account
  configuration in <literal>elasticsearch.yml</literal>.
</simpara>
<informalfigure>
<mediaobject>
  <imageobject>
  <imagedata fileref="images/watcher/hipchat-copy-v1-token.jpg"/>
  </imageobject>
  <textobject><phrase>hipchat-copy-v1-token.jpg</phrase></textobject>
</mediaobject>
</informalfigure>
</listitem>
</orderedlist>
<simpara>To configure a HipChat account that uses the <literal>v1</literal> profile:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Set the <literal>type</literal> to <literal>v1</literal>.
</simpara>
</listitem>
<listitem>
<simpara>
Set <literal>auth_token</literal> to the v1 authentication token you generated.
</simpara>
</listitem>
</orderedlist>
<simpara>For example, the following configuration creates an account called
<literal>notify-monitoring</literal>:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.notification.hipchat:
  account:
    notify-monitoring:
      profile: v1
      auth_token: 3eLB803Nyp7UBmegJwP1rMdUmzk5HqnzJCgflrhv</programlisting>
<simpara>You can also specify defaults for the <link linkend="hipchat-account-attributes">message attributes</link>.</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.notification.hipchat:
  account:
    notify-monitoring:
      profile: v1
      auth_token: 3eLB803Nyp7UBmegJwP1rMdUmzk5HqnzJCgflrhv
      message:
        format: text
        color: blue
        notify: true</programlisting>
</section>
</section>
</section>
<section id="actions-slack">
<title>Slack Action<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/slack.asciidoc">Edit me</ulink></title>
<simpara>Use the <literal>slack</literal> action to send messages to a <ulink url="https://slack.com/">Slack</ulink>
team&#8217;s channels or users. To send Slack messages, you need to
<link linkend="configuring-slack">configure at least one Slack account</link> in
<literal>elasticsearch.yml</literal>.</simpara>
<section id="configuring-slack-actions">
<title>Configuring Slack Actions<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/slack.asciidoc">Edit me</ulink></title>
<simpara>You configure Slack actions in the <literal>actions</literal> array. Action-specific attributes
are specified using the <literal>slack</literal> keyword.</simpara>
<simpara>The following snippet shows a simple slack action definition:</simpara>
<programlisting language="js" linenumbering="unnumbered">"actions" : {
  "notify-slack" : {
    "transform" : { ... },
    "throttle_period" : "5m",
    "slack" : {
      "message" : {
        "to" : [ "#admins", "@chief-admin" ], <co id="CO55-1"/>
        "text" : "Encountered  {{ctx.payload.hits.total}} errors in the last 5 minutes (facepalm)" <co id="CO55-2"/>
      }
    }
  }
}</programlisting>
<calloutlist>
<callout arearefs="CO55-1">
<para>
The channels and users you want to send the message to.
</para>
</callout>
<callout arearefs="CO55-2">
<para>
The content of the message.
</para>
</callout>
</calloutlist>
</section>
<section id="formatting-slack-messages">
<title>Using Attachments to Format Slack Messages<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/slack.asciidoc">Edit me</ulink></title>
<simpara>In addition to sending simple text-based messages, you can use the Slack
<ulink url="https://api.slack.com/docs/attachments">attachment</ulink> mechanism to send formatted
messages. Watcher leverages Slack attachments to enable you to dynamically
populate templated messages from the execution context payload.</simpara>
<simpara>The following snippet shows a standard message attachment:</simpara>
<programlisting language="js" linenumbering="unnumbered">"actions" : {
  "notify-slack" : {
    "throttle_period" : "5m",
    "slack" : {
      "account" : "team1",
      "message" : {
        "from" : "watcher",
        "to" : [ "#admins", "@chief-admin" ],
        "text" : "System X Monitoring",
        "attachments" : [
          {
            "title" : "Errors Found",
            "text" : "Encountered  {{ctx.payload.hits.total}} errors in the last 5 minutes (facepalm)",
            "color" : "danger"
          }
        ]
      }
    }
  }
}</programlisting>
<simpara id="slack-dynamic-attachment">To define an attachment template that is dynamically populated from the payload,
you specify <literal>dynamic_attachments</literal> in the watch action. For example, a dynamic
attachment could reference histogram buckets in the payload and build an
attachment per bucket.</simpara>
<simpara>In the following example, the watch input executes a search with a date histogram
aggregation and the Slack action:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Transforms the payload to a list where each item in the list holds the month,
  the user count for that month, and the color that represents the sentiment
  associated with that count (danger or bad).
</simpara>
</listitem>
<listitem>
<simpara>
Defines an attachment template that references items in the list generated by
  the transform.
</simpara>
</listitem>
</orderedlist>
<programlisting language="js" linenumbering="unnumbered">"input" : {
  "search" : {
    "request" : {
      "body" : {
        "aggs" : {
          "users_per_month" : {
            "date_histogram" : {
              "field" : "@timestamp",
              "interval" : "month"
            }
          }
        }
      }
    }
  }
},
...
"actions" : {
  "notify-slack" : {
    "throttle_period" : "5m",
    "transform" : {
      "script" : {
        "inline" : "['items': ctx.payload.aggregations.users_per_month.buckets.collect(bucket -&gt; ['count': bucket.doc_count, 'name': bucket.key_as_string, 'color': bucket.doc_count &lt; 100 ? 'danger' : 'good'])]",
        "lang" : "painless"
      }
    },
    "slack" : {
      "account" : "team1",
      "message" : {
        "from" : "watcher",
        "to" : [ "#admins", "@chief-admin" ],
        "text" : "System X Monitoring",
        "dynamic_attachments" : {
          "list_path" : "ctx.payload.items" <co id="CO56-1"/>
          "attachment_template" : {
            "title" : "{{month}}", <co id="CO56-2"/>
            "text" : "Users Count: {{count}}",
            "color" : "{{color}}"
          }
        }
      }
    }
  }
}</programlisting>
<calloutlist>
<callout arearefs="CO56-1">
<para>
The list generated by the action&#8217;s transform.
</para>
</callout>
<callout arearefs="CO56-2">
<para>
The parameter placeholders refer to attributes in each item of the list
    generated by the transform.
</para>
</callout>
</calloutlist>
</section>
<section id="slack-action-attributes">
<title>Slack Action Attributes<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/slack.asciidoc">Edit me</ulink></title>
<informaltable
frame="all"
rowsep="1" colsep="1"
>
<tgroup cols="3">
<colspec colname="col_1" colwidth="33*"/>
<colspec colname="col_2" colwidth="33*"/>
<colspec colname="col_3" colwidth="33*"/>
<thead>
<row>
<entry align="left" valign="top"> Name                  </entry>
<entry align="center" valign="top">Required </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>from</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>The sender name to display in the  Slack message.
                                    Overrides the incoming webhook&#8217;s configured name.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>to</literal></simpara></entry>
<entry align="center" valign="top"><simpara>yes</simpara></entry>
<entry align="left" valign="top"><simpara>The channels and users you want to send the message
                                    to. Channel names must start with <literal>#</literal> and user names
                                    must start with <literal>@</literal>. Accepts a string value or an
                                    array of string values.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>icon</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>The icon to display in the Slack messages. Overrides
                                    the incoming webhook&#8217;s configured icon. Accepts a
                                    public URL to an image.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>text</literal></simpara></entry>
<entry align="center" valign="top"><simpara>yes</simpara></entry>
<entry align="left" valign="top"><simpara>The message content.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>attachments</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Slack message attachments. Message attachments enable
                                    you to create more richly-formatted messages. Specified
                                    array as defined in the
                                    <ulink url="https://api.slack.com/docs/attachments">Slack attachments documentation</ulink>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>dynamic_attachments</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Slack message attachments that can be populated
                                    dynamically based on the current watch payload. For
                                    more information, see
                                    <link linkend="slack-dynamic-attachment">Using Attachments to Format Slack Messages</link>.</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
</section>
<section id="configuring-slack">
<title>Configuring Slack Accounts<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/slack.asciidoc">Edit me</ulink></title>
<simpara>You configure the accounts Watcher can use to communicate with Slack in the
<literal>xpack.notification.slack</literal> namespace in <literal>elasticsearch.yml</literal>.</simpara>
<simpara>You need a <ulink url="https://api.slack.com/incoming-webhooks">Slack webhook URL</ulink> to
configure a Slack account. To create a webhook
URL, set up an an <emphasis>Incoming Webhook Integration</emphasis> through the Slack console:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Log in to <ulink url="http://slack.com">slack.com</ulink> as a team administrator.
</simpara>
</listitem>
<listitem>
<simpara>
Go to <ulink url="https://my.slack.com/services/new/incoming-webhook">https://my.slack.com/services/new/incoming-webhook</ulink>.
</simpara>
</listitem>
<listitem>
<simpara>
Select a default channel for the integration.
</simpara>
<informalfigure>
<mediaobject>
  <imageobject>
  <imagedata fileref="images/watcher/slack-add-webhook-integration.jpg"/>
  </imageobject>
  <textobject><phrase>slack-add-webhook-integration.jpg</phrase></textobject>
</mediaobject>
</informalfigure>
</listitem>
<listitem>
<simpara>
Click <emphasis role="strong">Add Incoming Webhook Integration</emphasis>.
</simpara>
</listitem>
<listitem>
<simpara>
Copy the generated webhook URL so you can paste it into your Slack account
  configuration in <literal>elasticsearch.yml</literal>.
</simpara>
<informalfigure>
<mediaobject>
  <imageobject>
  <imagedata fileref="images/watcher/slack-copy-webhook-url.jpg"/>
  </imageobject>
  <textobject><phrase>slack-copy-webhook-url.jpg</phrase></textobject>
</mediaobject>
</informalfigure>
</listitem>
</orderedlist>
<simpara>To configure a Slack account, at a minimum you need to specify the account
name and webhook URL:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.notification.slack:
  account:
    monitoring:
      url: https://hooks.slack.com/services/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</programlisting>
<simpara>You can also specify defaults for the &lt;<link linkend="slack-account-attributes">Slack notification attributes</link>:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.notification.slack:
  account:
    monitoring:
      url: https://hooks.slack.com/services/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
      message_defaults:
        from: x-pack
        to: notifications
        icon: http://example.com/images/watcher-icon.jpg
        attachment:
          fallback: "X-Pack Notification"
          color: "#36a64f"
          title: "X-Pack Notification"
          title_link: "https://www.elastic.co/guide/en/x-pack/current/index.html"
          text: "One of your watches generated this notification."</programlisting>
<simpara>If you configure multiple Slack accounts, you either need to configure a default
account or specify which account the notification should be sent with in the
<link linkend="actions-slack">slack</link> action.</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.notification.slack:
  default_account: team1
  account:
    team1:
      ...
    team2:
      ...</programlisting>
</section>
</section>
<section id="actions-pagerduty">
<title>PagerDuty Action<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/pagerduty.asciidoc">Edit me</ulink></title>
<simpara>Use the PagerDuty action to create events in <ulink url="https://pagerduty.com/">
PagerDuty</ulink>. To create PagerDuty events, you must <link linkend="configuring-pagerduty">configure at least one PagerDuty account</link> in <literal>elasticsearch.yml</literal>.</simpara>
<section id="configuring-pagerduty-actions">
<title>Configuring PagerDuty Actions<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/pagerduty.asciidoc">Edit me</ulink></title>
<simpara>You configure PagerDuty actions in the <literal>actions</literal> array. Action-specific attributes
are specified using the <literal>pagerduty</literal> keyword.</simpara>
<simpara>The following snippet shows a simple PagerDuty action definition:</simpara>
<programlisting language="js" linenumbering="unnumbered">"actions" : {
  "notify-pagerduty" : {
    "transform" : { ... },
    "throttle_period" : "5m",
    "pagerduty" : {
      "description" : "Main system down, please check!" <co id="CO57-1"/>
    }
  }
}</programlisting>
<calloutlist>
<callout arearefs="CO57-1">
<para>
Description of the message
</para>
</callout>
</calloutlist>
</section>
<section id="adding-context-and-payloads-to-pagerduty-actions">
<title>Adding Meta Information to a PagerDuty Incident<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/pagerduty.asciidoc">Edit me</ulink></title>
<simpara>To give the PagerDuty incident some more context, you can attach the
payload as well as an array of contexts to the action.</simpara>
<programlisting language="js" linenumbering="unnumbered">"actions" : {
  "notify-pagerduty" : {
    "throttle_period" : "5m",
    "pagerduty" : {
      "account" : "team1",
      "description" : "Main system down, please check! Happened at {{ctx.execution_time}}"
      "attach_payload" : true,
      "client" : "/foo/bar/{{ctx.watch_id}}",
      "client_url" : "http://www.example.org/",
      "context" : [
        {
          "type": "link",
          "href": "http://acme.pagerduty.com"
        },{
          "type": "link",
          "href": "http://acme.pagerduty.com",
          "text": "View the incident on {{ctx.payload.link}}"
        }
      ]
    }
  }
}</programlisting>
</section>
<section id="pagerduty-action-attributes">
<title>Pagerduty Action Attributes<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/pagerduty.asciidoc">Edit me</ulink></title>
<informaltable
frame="all"
rowsep="1" colsep="1"
>
<tgroup cols="3">
<colspec colname="col_1" colwidth="33*"/>
<colspec colname="col_2" colwidth="33*"/>
<colspec colname="col_3" colwidth="33*"/>
<thead>
<row>
<entry align="left" valign="top"> Name        </entry>
<entry align="center" valign="top">Required   </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>account</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>The account to use, falls back to the default one.
                            The account needs a <literal>service_key_api</literal> attribute.</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
<table id="pagerduty-event-trigger-incident-attributes"
frame="all"
rowsep="1" colsep="1"
>
<title>Pagerduty Event Trigger Incident Attributes</title>
<tgroup cols="3">
<colspec colname="col_1" colwidth="33*"/>
<colspec colname="col_2" colwidth="33*"/>
<colspec colname="col_3" colwidth="33*"/>
<thead>
<row>
<entry align="left" valign="top"> Name              </entry>
<entry align="center" valign="top">Required </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>description</literal></simpara></entry>
<entry align="center" valign="top"><simpara>yes</simpara></entry>
<entry align="left" valign="top"><simpara>A quick description for this event</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>event_type</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>The event type to sent. Must be one of <literal>trigger</literal>,
                                <literal>resolve</literal> or <literal>acknowledge</literal>. Defaults to <literal>trigger</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>incident_key</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>The incident key on the pagerduty side, also used
                                for de-duplication and allows to resolve or acknowledge
                                incidents.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>client</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Name of the client triggering the incident, i.e.
                                <literal>Watcher Monitoring</literal></simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>client_url</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>A client URL to visit to get more detailed information.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>attach_payload</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>If set to <literal>true</literal> the payload is attached as a detail
                                to the API call. Defaults to <literal>false</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>contexts</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>An array of objects, that allow you to provide
                                additional links or images in order to provide more
                                context to the trigger.</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<simpara>You can configure defaults for the above values for the whole service using the
<literal>xpack.notification.pagerduty.event_defaults.*</literal> properties as well as
per account using <literal>xpack.notification.pagerduty.account.your_account_name.event_defaults.*</literal></simpara>
<note><simpara>All of those objects have templating support, so you can use data from the
      context and the payload as part of all the fields.</simpara></note>
<table id="pagerduty-event-trigger-context-attributes"
frame="all"
rowsep="1" colsep="1"
>
<title>Pagerduty Event Trigger Context Attributes</title>
<tgroup cols="3">
<colspec colname="col_1" colwidth="33*"/>
<colspec colname="col_2" colwidth="33*"/>
<colspec colname="col_3" colwidth="33*"/>
<thead>
<row>
<entry align="left" valign="top"> Name    </entry>
<entry align="center" valign="top">Required </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>type</literal></simpara></entry>
<entry align="center" valign="top"><simpara>yes</simpara></entry>
<entry align="left" valign="top"><simpara>One of <literal>link</literal> or <literal>image</literal>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>href</literal></simpara></entry>
<entry align="center" valign="top"><simpara>yes/no</simpara></entry>
<entry align="left" valign="top"><simpara>A link to include more information. Must be there if the
                      type is <literal>link</literal>, optional if the type is <literal>image</literal></simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>src</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>A src attribute for the <literal>image</literal> type.</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
</section>
<section id="configuring-pagerduty">
<title>Configuring PagerDuty Accounts<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/actions/pagerduty.asciidoc">Edit me</ulink></title>
<simpara>You configure the accounts Watcher uses to communicate with PagerDuty in
the <literal>xpack.notification.pagerduty</literal> namespace in <literal>elasticsearch.yml</literal>.</simpara>
<simpara>To configure a PagerDuty account, you need the API integration key for
the PagerDuty service you want to send notifications to. To get the
key:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Log in to <ulink url="http://pagerduty.com">pagerduty.com</ulink> as an account administrator.
</simpara>
</listitem>
<listitem>
<simpara>
Go to <emphasis role="strong">Configuration &gt; Services</emphasis> and select the PagerDuty service. The
service must use the API integration.
</simpara>
<informalfigure>
<mediaobject>
  <imageobject>
  <imagedata fileref="images/watcher/pagerduty-services.jpg"/>
  </imageobject>
  <textobject><phrase>pagerduty-services.jpg</phrase></textobject>
</mediaobject>
</informalfigure>
</listitem>
<listitem>
<simpara>
Click the <emphasis role="strong">Integrations</emphasis> tab and copy the API integration key.
</simpara>
<informalfigure>
<mediaobject>
  <imageobject>
  <imagedata fileref="images/watcher/pagerduty-integrations.jpg"/>
  </imageobject>
  <textobject><phrase>pagerduty-integrations.jpg</phrase></textobject>
</mediaobject>
</informalfigure>
</listitem>
</orderedlist>
<simpara>To configure a PagerDuty account in <literal>elasticsearch.yml</literal>, at a minimum you
must specify an account name and integration key:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.notification.pagerduty:
  account:
    my_pagerduty_account:
      service_api_key: d3b07384d113edec49eaa6238ad5ff0</programlisting>
<simpara>You can also specify defaults for the <link linkend="pagerduty-event-trigger-incident-attributes">PagerDuty event attributes</link>:
.</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.notification.pagerduty:
  account:
    my_pagerduty_account:
      service_api_key: d3b07384d113edec49eaa6238ad5ff0
      event_defaults:
        description: "Watch notification"
        incident_key: "my_incident_key"
        client: "my_client"
        client_url: http://www.example.org
        event_type: trigger
        attach_payload: true</programlisting>
<simpara>If you configure multiple PagerDuty accounts, you either need to set a default
account or specify which account the event should be sent with in the
<link linkend="actions-pagerduty"><literal>pagerduty</literal></link> action.</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.notification.pagerduty:
  default_account: team1
  account:
    team1:
      ...
    team2:
      ...</programlisting>
</section>
</section>
</chapter>
<chapter id="transform">
<title>Transforms<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/transform.asciidoc">Edit me</ulink></title>
<simpara>A <emphasis>Transform</emphasis> processes and changes the payload in the watch execution context
to prepare it for the watch actions. Watcher supports three types of
transforms: <link linkend="transform-search"><literal>search</literal></link>,
<link linkend="transform-script"><literal>script</literal></link> and <link linkend="transform-chain"><literal>chain</literal></link>.</simpara>
<note><simpara>Transforms are optional. When none are defined, the actions have access to
      the payload as loaded by the watch input.</simpara></note>
<simpara>You can define transforms in two places:</simpara>
<itemizedlist>
<listitem>
<simpara>
As a top level construct in the watch definition. In this case, the payload is
  transformed before any of the watch actions are executed.
</simpara>
</listitem>
<listitem>
<simpara>
As part of the definition of an action. In this case, the payload is
  transformed before that action is executed. The transformation is only applied
  to the payload for that specific action.
</simpara>
</listitem>
</itemizedlist>
<simpara>If all actions require the same view of the payload, define a transform as part
of the watch definition. If each action requires a different view of the payload,
define different transforms as part of the action definitions so each action has
the payload prepared by its own dedicated transform.</simpara>
<simpara>The following example defines two transforms, one at the watch level and one as
part of the definition of the <literal>my_webhook</literal> action.</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "trigger" : { ...}
  "input" : { ... },
  "condition" : { ... },
  "transform" : { <co id="CO58-1"/>
    "search" : {
      "body" : { "query" : { "match_all" : {} } }
    }
  },
  "actions" : {
    "my_webhook": {
      "transform" : { <co id="CO58-2"/>
        "script" : "return ctx.payload.hits"
      },
      "webhook" : {
        "host" : "host.domain",
        "port" : 8089,
        "path" : "/notify/{{ctx.watch_id}}"
      }
    }
  ]
}</programlisting>
<calloutlist>
<callout arearefs="CO58-1">
<para>
A watch level <literal>transform</literal>
</para>
</callout>
<callout arearefs="CO58-2">
<para>
An action level <literal>transform</literal>
</para>
</callout>
</calloutlist>
<section id="transform-search">
<title>Search Transform<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/transform/search.asciidoc">Edit me</ulink></title>
<simpara>A <link linkend="transform">Transform</link> that executes a search on the cluster and replaces
the current payload in the watch execution context with the returned search
response. The following snippet shows how a simple search transform can be
defined on the watch level:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "transform" : {
    "search" : {
      "request" : {
        "body" : { "query" : { "match_all" : {} }}
      }
    }
  }
}</programlisting>
<simpara>Like every other search based construct, one can make use of the full search
API supported by Elasticsearch. For example, the following search transform
execute a search over all events indices, matching events with <literal>error</literal> priority:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "transform" : {
    "search" : {
      "request" : {
        "indices" : [ "events-*" ],
        "body" : {
          "size" : 0,
          "query" : {
            "match" : { "priority" : "error"}
          }
        }
      }
    }
  }
}</programlisting>
<simpara>The following table lists all available settings for the search transform:</simpara>
<table id="transform-search-settings"
frame="all"
rowsep="1" colsep="1"
>
<title>Search Transform Settings</title>
<tgroup cols="4">
<colspec colname="col_1" colwidth="25*"/>
<colspec colname="col_2" colwidth="25*"/>
<colspec colname="col_3" colwidth="25*"/>
<colspec colname="col_4" colwidth="25*"/>
<thead>
<row>
<entry align="left" valign="top"> Name                                          </entry>
<entry align="center" valign="top">Required   </entry>
<entry align="left" valign="top"> Default           </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>request.search_type</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>query_then_fetch</simpara></entry>
<entry align="left" valign="top"><simpara>The search <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/search-request-search-type.html">type</ulink>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request.indices</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>all indices</simpara></entry>
<entry align="left" valign="top"><simpara>One or more indices to search on.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request.types</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>all types</simpara></entry>
<entry align="left" valign="top"><simpara>One or more document types to search on (may be a
                                                                                  comma-delimited string or an array of document types
                                                                                  names)</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request.body</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara><literal>match_all</literal> query</simpara></entry>
<entry align="left" valign="top"><simpara>The body of the request. The
                                                                                  <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/search-request-body.html">request body</ulink> follows
                                                                                  the same structure you normally send in the body of
                                                                                  a REST <literal>_search</literal> request. The body can be static text
                                                                                  or include <literal>mustache</literal> <link linkend="templates">templates</link>.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request.indices_options.expand_wildcards</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara><literal>open</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Determines how to expand indices wildcards. Can be one
                                                                                  of <literal>open</literal>, <literal>closed</literal>, <literal>none</literal> or <literal>all</literal>
                                                                                  (see <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/multi-index.html">multi-index support</ulink>)</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request.indices_options.ignore_unavailable</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara><literal>true</literal></simpara></entry>
<entry align="left" valign="top"><simpara>A boolean value that determines whether the search
                                                                                  should leniently ignore unavailable indices
                                                                                  (see <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/multi-index.html">multi-index support</ulink>)</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request.indices_options.allow_no_indices</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara><literal>true</literal></simpara></entry>
<entry align="left" valign="top"><simpara>A boolean value that determines whether the search
                                                                                  should leniently return no results when no indices
                                                                                  are resolved (see <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/multi-index.html">multi-index support</ulink>)</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>request.template</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>The body of the search template. See
                                                                                  <link linkend="templates">configure templates</link> for more information.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>timeout</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>30s</simpara></entry>
<entry align="left" valign="top"><simpara>The timeout for waiting for the search api call to
                                                                                  return. If no response is returned within this time,
                                                                                  the search transform times out and fails. This setting
                                                                                  overrides the default timeouts.</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<section id="transform-search-template">
<title>Template Support<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/transform/search.asciidoc">Edit me</ulink></title>
<simpara>The search transform support mustache <link linkend="templates">templates</link>. This can either
be as part of the body definition, or alternatively, point to an existing
template (either defined in a file or <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/search-template.html#pre-registered-templates">registered</ulink>
as a script in Elasticsearch).</simpara>
<simpara>For example, the following snippet shows a search that refers to the scheduled
time of the watch:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "transform" : {
    "search" : {
      "request" : {
        "indices" : [ "logstash-*" ],
        "types" : [ "event" ],
        "body" : {
          "size" : 0,
          "query" : {
            "bool" : {
              "must" : {
                "match" : { "priority" : "error"}
              },
              "filter" : [
                {
                  "range" : {
                    "@timestamp" : {
                      "from" : "{{ctx.trigger.scheduled_time}}||-30s",
                      "to" : "{{ctx.trigger.triggered_time}}"
                    }
                  }
                }
              ]
            }
          }
        }
      }
    }
  }
}</programlisting>
<simpara>The model of the template is a union between the provided <literal>template.params</literal>
settings and the <link linkend="watch-execution-context">standard watch execution context model</link>.</simpara>
<simpara>The following is an example of using templates that refer to provided parameters:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "transform" : {
    "search" : {
      "request" : {
        "indices" : [ "logstash-*" ],
        "types" : [ "event" ],
        "template" : {
          "inline" : {
            "size" : 0,
            "query" : {
              "bool" : {
                "must" : {
                  "match" : { "priority" : "{{priority}}"}
                },
                "filter" : [
                  {
                    "range" : {
                      "@timestamp" : {
                        "from" : "{{ctx.trigger.scheduled_time}}||-30s",
                        "to" : "{{ctx.trigger.triggered_time}}"
                      }
                    }
                  }
                ]
              }
            },
            "params" : {
              "priority" : "error"
            }
          }
        }
      }
    }
  }
}</programlisting>
</section>
</section>
<section id="transform-script">
<title>Script Transform<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/transform/script.asciidoc">Edit me</ulink></title>
<simpara>A <link linkend="transform">Transform</link> that executes a script on the current payload in the
watch execution context and replaces it with a newly generated one. The following
snippet shows how a simple script transform can be defined on the watch level:</simpara>
<tip><simpara>The <literal>script</literal> transform is often useful when used in combination with the
      <link linkend="transform-search"><literal>search</literal></link> transform, where the script can extract only
      the significant data from a search result, and by that, keep the payload
      minimal. This can be achieved with the <link linkend="transform-chain"><literal>chain</literal></link>
      transform.</simpara></tip>
<programlisting language="js" linenumbering="unnumbered">{
  "transform" : {
    "script" : "return [ time : ctx.trigger.scheduled_time ]" <co id="CO59-1"/>
  }
}</programlisting>
<calloutlist>
<callout arearefs="CO59-1">
<para>
A simple <literal>groovy</literal> script that creates a new payload with a single <literal>time</literal>
    field holding the scheduled time.
</para>
</callout>
</calloutlist>
<note><simpara>The executed script may either return a valid model that is the equivalent
      of a Java&#8482; Map or a JSON object (you will need to consult the
      documentation of the specific scripting language to find out what this
      construct is). Any other value that is returned will be assigned and
      accessible to/via the <literal>_value</literal> variable.</simpara></note>
<simpara>The <literal>script</literal> attribute may hold a string value in which case it will be treated
as an inline script and the default elasticsearch script languages will be assumed
(as described in <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/modules-scripting.html#modules-scripting">here</ulink>). You can
use the other scripting languages supported by Elasticsearch. For this, you need
to set the <literal>script</literal> field to an object describing the script and its language.
The following table lists the possible settings that can be configured:</simpara>
<table id="transform-script-settings"
frame="all"
rowsep="1" colsep="1"
>
<title>Script Transform Settings</title>
<tgroup cols="4">
<colspec colname="col_1" colwidth="25*"/>
<colspec colname="col_2" colwidth="25*"/>
<colspec colname="col_3" colwidth="25*"/>
<colspec colname="col_4" colwidth="25*"/>
<thead>
<row>
<entry align="left" valign="top"> Name      </entry>
<entry align="left" valign="top">Required </entry>
<entry align="left" valign="top"> Default   </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tfoot>
<row>
<entry align="left" valign="top" namest="col_1" nameend="col_4"><simpara>* When using the object notation, only one of <literal>inline</literal>, <literal>file</literal> or <literal>id</literal>
       fields must be defined</simpara></entry>
</row>
</tfoot>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>inline</literal></simpara></entry>
<entry align="left" valign="top"><simpara>yes*</simpara></entry>
<entry align="left" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>When using an inline script, this field holds
                                    the script itself.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>file</literal></simpara></entry>
<entry align="left" valign="top"><simpara>yes*</simpara></entry>
<entry align="left" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>When referring to a script file, this field
                                    holds the name of the file.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>id</literal></simpara></entry>
<entry align="left" valign="top"><simpara>yes*</simpara></entry>
<entry align="left" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>When referring to a stored script, this
                                    field holds the id of the script.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>lang</literal></simpara></entry>
<entry align="left" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara><literal>groovy</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The script language</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>params</literal></simpara></entry>
<entry align="left" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>-</simpara></entry>
<entry align="left" valign="top"><simpara>Additional parameters/variables that are
                                    accessible by the script</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<simpara>When using the object notation of the script, one (and only one) of <literal>inline</literal>,
<literal>file</literal> or <literal>id</literal> fields must be defined</simpara>
<note><simpara>In addition to the provided <literal>params</literal>, the scripts also have access to the
      <link linkend="watch-execution-context">Standard Watch Execution Context Parameters</link>.</simpara></note>
<important>
<simpara>For Groovy, you must explicitly <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/modules-scripting-security.html#enable-dynamic-scripting">enable dynamic scripts</ulink>
in <literal>elasticsearch.yml</literal> to use <literal>inline</literal> or <literal>stored</literal> scripts.  To enable groovy
scripting for watches only, you can set <literal>script.engine.groovy.inline.xpack_watch: true</literal>.</simpara>
<simpara>Alternatively, starting with 5.0, Elasticsearch is shipped with the new
<ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/modules-scripting-painless.html">Painless</ulink> scripting language. Painless was
created and designed specifically for use in Elasticsearch. Beyond providing an
extensive feature set, its biggest trait is that it&#8217;s properly sandboxed and safe
to use anywhere in the system (including in Watcher) without the need to enable
dynamic scripting.</simpara>
</important>
</section>
<section id="transform-chain">
<title>Chain Transform<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/transform/chain.asciidoc">Edit me</ulink></title>
<simpara>A <link linkend="transform">Transform</link> that executes an ordered list of configured transforms
in a chain, where the output of one transform serves as the input of the next
transform in the chain. The payload that is accepted by this transform serves as
the input of the first transform in the chain and the output of the last transform
in the chain is the output of the <literal>chain</literal> transform as a whole.</simpara>
<simpara>You can use chain transforms to build more complex transforms out of the other
available transforms. For example, you can combine a <link linkend="transform-search"><literal>search</literal></link>
transform and a <link linkend="transform-script"><literal>script</literal></link> transform, as shown in the
following snippet:</simpara>
<programlisting language="js" linenumbering="unnumbered">"transform" : {
  "chain" : [ <co id="CO60-1"/>
    {
      "search" : {  <co id="CO60-2"/>
        "indices" : [ "logstash-*" ],
        "body" : {
          "size" : 0,
          "query" : {
            "match" : { "priority" : "error" }
          }
        }
      }
    },
    {
      "script" : "return [ error_count : ctx.payload.hits.total ]"  <co id="CO60-3"/>
    }
  ]
}</programlisting>
<calloutlist>
<callout arearefs="CO60-1">
<para>
The <literal>chain</literal> transform definition
</para>
</callout>
<callout arearefs="CO60-2">
<para>
The first transform in the chain (in this case, a <literal>search</literal> transform)
</para>
</callout>
<callout arearefs="CO60-3">
<para>
The second and final transform in the chain (in this case, a <literal>script</literal>
    transform)
</para>
</callout>
</calloutlist>
<simpara>This example executes a <literal>count</literal> search on the cluster to look for <literal>error</literal> events.
The search results are then passed to the second <literal>script</literal> transform. The <literal>script</literal>
transform extracts the total hit count and assigns it to the <literal>error_count</literal> field
in a newly-generated payload. This new payload is the output of the <literal>chain</literal>
transform and replaces the payload in the watch execution context.</simpara>
</section>
</chapter>
<chapter id="api-java">
<title>Java API<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/java.asciidoc">Edit me</ulink></title>
<simpara>X-Pack provides a Java client called <literal>WatcherClient</literal> that adds native Java
support for the Watcher.</simpara>
<simpara>To obtain a <literal>WatcherClient</literal> instance, make sure you first set up the
<literal>XPackClient</literal>.</simpara>
<bridgehead id="_installing_xpackclient" renderas="sect2">Installing XPackClient<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/java.asciidoc">Edit me</ulink></bridgehead>
<simpara>You first need to make sure the <literal>x-pack-transport-5.0.1</literal> JAR file is in the classpath.
You can extract this jar from the downloaded X-Pack bundle.</simpara>
<simpara>If you use Maven to manage dependencies, add the following to the <literal>pom.xml</literal>:</simpara>
<programlisting language="xml" linenumbering="unnumbered">&lt;project ...&gt;

   &lt;repositories&gt;
      &lt;!-- add the elasticsearch repo --&gt;
      &lt;repository&gt;
         &lt;id&gt;elasticsearch-releases&lt;/id&gt;
         &lt;url&gt;https://artifacts.elastic.co/maven&lt;/url&gt;
         &lt;releases&gt;
            &lt;enabled&gt;true&lt;/enabled&gt;
         &lt;/releases&gt;
         &lt;snapshots&gt;
            &lt;enabled&gt;false&lt;/enabled&gt;
         &lt;/snapshots&gt;
      &lt;/repository&gt;
      ...
   &lt;/repositories&gt;
   ...

   &lt;dependencies&gt;
      &lt;!-- add the x-pack jar as a dependency --&gt;
      &lt;dependency&gt;
         &lt;groupId&gt;org.elasticsearch.client&lt;/groupId&gt;
         &lt;artifactId&gt;x-pack-transport&lt;/artifactId&gt;
         &lt;version&gt;5.0.1&lt;/version&gt;
      &lt;/dependency&gt;
      ...
   &lt;/dependencies&gt;
   ...

 &lt;/project&gt;</programlisting>
<simpara>If you use Gradle, add the dependencies to <literal>build.gradle</literal>:</simpara>
<programlisting language="groovy" linenumbering="unnumbered">repositories {
  /* ... Any other repositories ... */

  // Add the Elasticsearch Maven Repository
  maven {
    url "https://artifacts.elastic.co/maven"
  }
}

dependencies {
  // Provide the x-pack jar on the classpath for compilation and at runtime
  compile "org.elasticsearch.client:x-pack-transport:5.0.1"

  /* ... */
}</programlisting>
<simpara>You can also download the <ulink url="https://artifacts.elastic.co/maven/org/elasticsearch/client/x-pack-transport/5.0.1/x-pack-transport-5.0.1.jar">X-Pack Transport JAR</ulink>
manually, directly from our Maven repository.</simpara>
<bridgehead id="_obtaining_the_literal_watcherclient_literal" renderas="sect2">Obtaining the <literal>WatcherClient</literal><ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/java.asciidoc">Edit me</ulink></bridgehead>
<simpara>To obtain an instance of the <literal>WatcherClient</literal> you first need to create the
<literal>XPackClient</literal>. The <literal>XPackClient</literal> is a wrapper around the standard Java
Elasticsearch <literal>Client</literal>:</simpara>
<programlisting language="java" linenumbering="unnumbered">import org.elasticsearch.client.transport.TransportClient;
import org.elasticsearch.xpack.client.PreBuiltXPackTransportClient;
import org.elasticsearch.xpack.XPackClient;
import org.elasticsearch.xpack.XPackPlugin;
import org.elasticsearch.watcher.client.WatcherClient;
...

TransportClient client = new PreBuiltXPackTransportClient(Settings.builder()
    .put("cluster.name", "myClusterName")
    ...
    .build())
    .addTransportAddress(new InetSocketTransportAddress(InetAddress.getByName("localhost"), 9300));

XPackClient xpackClient = new XPackClient(client);
WatcherClient watcherClient = xpackClient.watcher();</programlisting>
<bridgehead id="api-java-put-watch" renderas="sect2">PUT Watch API<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/java/put-watch.asciidoc">Edit me</ulink></bridgehead>
<simpara>The PUT watch API either registers a new watch in Watcher or update an
existing one. Once registered, a new document will be added to the <literal>.watches</literal>
index, representing the watch, and the watch trigger will immediately be
registered with the relevant trigger engine (typically the scheduler, for the
<literal>schedule</literal> trigger).</simpara>
<important><simpara>Putting a watch must be done via this API only. Do not put a watch
            directly to the <literal>.watches</literal> index using Elasticsearch&#8217;s Index API.
            When X-Pack security is enabled, make sure no <literal>write</literal> privileges are
            granted to anyone over the <literal>.watches</literal> index.</simpara></important>
<simpara>The following example adds a watch with the <literal>my-watch</literal> id that has the following
characteristics:</simpara>
<itemizedlist>
<listitem>
<simpara>
The watch schedule triggers every minute.
</simpara>
</listitem>
<listitem>
<simpara>
The watch search input looks for any 404 HTTP responses that occurred in the
  last five minutes.
</simpara>
</listitem>
<listitem>
<simpara>
The watch condition checks if any hits where found.
</simpara>
</listitem>
<listitem>
<simpara>
When hits are found, the watch action sends an email to the administrator.
</simpara>
</listitem>
</itemizedlist>
<programlisting language="java" linenumbering="unnumbered">WatchSourceBuilder watchSourceBuilder = WatchSourceBuilders.watchBuilder();

// Set the trigger
watchSourceBuilder.trigger(TriggerBuilders.schedule(Schedules.cron("0 0/1 * * * ?")));

// Create the search request to use for the input
SearchRequest request = Requests.searchRequest("idx").source(searchSource()
        .query(boolQuery()
                .must(matchQuery("response", 404))
                .filter(rangeQuery("date").gt("{{ctx.trigger.scheduled_time}}"))
                .filter(rangeQuery("date").lt("{{ctx.execution_time}}"))
        ));

// Create the search input
SearchInput input = new SearchInput(new WatcherSearchTemplateRequest(new String[]{"idx"}, null, SearchType.DEFAULT,
    WatcherSearchTemplateRequest.DEFAULT_INDICES_OPTIONS, new BytesArray(request.source().toString())), null, null, null);

// Set the input
watchSourceBuilder.input(input);

// Set the condition
watchSourceBuilder.condition(new ScriptCondition(new Script("ctx.payload.hits.total &gt; 1")));

// Create the email template to use for the action
EmailTemplate.Builder emailBuilder = EmailTemplate.builder();
emailBuilder.to("someone@domain.host.com");
emailBuilder.subject("404 recently encountered");
EmailAction.Builder emailActionBuilder = EmailAction.builder(emailBuilder.build());

// Add the action
watchSourceBuilder.addAction("email_someone", emailActionBuilder);

PutWatchResponse putWatchResponse = watcherClient.preparePutWatch("my-watch")
    .setSource(watchSourceBuilder)
    .get();</programlisting>
<simpara>While the above snippet flashes out all the concrete classes that make our watch,
using the available builder classes along with static imports can significantly
simplify and compact your code:</simpara>
<programlisting language="java" linenumbering="unnumbered">PutWatchResponse putWatchResponse2 = watcherClient.preparePutWatch("my-watch")
        .setSource(watchBuilder()
                .trigger(schedule(cron("0 0/1 * * * ?")))
                .input(searchInput(new WatcherSearchTemplateRequest(new String[]{"idx"}, null, SearchType.DEFAULT,
                        WatcherSearchTemplateRequest.DEFAULT_INDICES_OPTIONS, searchSource()
                        .query(boolQuery()
                                .must(matchQuery("response", 404))
                                .filter(rangeQuery("date").gt("{{ctx.trigger.scheduled_time}}"))
                                .filter(rangeQuery("date").lt("{{ctx.execution_time}}"))
                        ).buildAsBytes())))
                .condition(compareCondition("ctx.payload.hits.total", CompareCondition.Op.GT, 1L))
                .addAction("email_someone", emailAction(EmailTemplate.builder()
                        .to("someone@domain.host.com")
                        .subject("404 recently encountered"))))
        .get();</programlisting>
<itemizedlist>
<listitem>
<simpara>
Use <literal>TriggerBuilders</literal> and <literal>Schedules</literal> classes to define the trigger
</simpara>
</listitem>
<listitem>
<simpara>
Use <literal>InputBuilders</literal> class to define the input
</simpara>
</listitem>
<listitem>
<simpara>
Use <literal>ConditionBuilders</literal> class to define the condition
</simpara>
</listitem>
<listitem>
<simpara>
Use <literal>ActionBuilders</literal> to define the actions
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="api-java-get-watch" renderas="sect2">Get Watch API<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/java/get-watch.asciidoc">Edit me</ulink></bridgehead>
<simpara>This API retrieves a watch by its id.</simpara>
<simpara>The following example gets a watch with <literal>my-watch</literal> id:</simpara>
<programlisting language="java" linenumbering="unnumbered">GetWatchResponse getWatchResponse = watcherClient.prepareGetWatch("my-watch").get();</programlisting>
<simpara>You can access the watch definition by accessing the source of the response:</simpara>
<programlisting language="java" linenumbering="unnumbered">XContentSource source = getWatchResponse.getSource();</programlisting>
<simpara>The <literal>XContentSource</literal> provides you methods to explore the source:</simpara>
<programlisting language="java" linenumbering="unnumbered">Map&lt;String, Object&gt; map = source.getAsMap();</programlisting>
<simpara>Or get a specific value associated with a known key:</simpara>
<programlisting language="java" linenumbering="unnumbered">String host = source.getValue("input.http.request.host");</programlisting>
<bridgehead id="api-java-delete-watch" renderas="sect2">Delete Watch API<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/java/delete-watch.asciidoc">Edit me</ulink></bridgehead>
<simpara>The DELETE watch API removes a watch (identified by its <literal>id</literal>) from Watcher.
Once removed, the document representing the watch in the <literal>.watches</literal> index is
gone and it will never be executed again.</simpara>
<simpara>Please note that deleting a watch <emphasis role="strong">does not</emphasis> delete any watch execution records
related to this watch from the watch history.</simpara>
<important><simpara>Deleting a watch must be done via this API only. Do not delete the
            watch directly from the <literal>.watches</literal> index using Elasticsearch&#8217;s DELETE
            Document API. I X-Pack security is enabled, make sure no <literal>write</literal> privileges
            are granted to anyone over the <literal>.watches</literal> index.</simpara></important>
<simpara>The following example deletes a watch with the <literal>my-watch</literal> id:</simpara>
<programlisting language="java" linenumbering="unnumbered">DeleteWatchResponse deleteWatchResponse = watcherClient.prepareDeleteWatch("my-watch").get();</programlisting>
<bridgehead id="api-java-execute-watch" renderas="sect2">Execute Watch API<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/java/execute-watch.asciidoc">Edit me</ulink></bridgehead>
<simpara>This API enables on-demand execution of a watch stored in the <literal>.watches</literal> index.
It can be used to test a watch without executing all its actions or by ignoring
its condition. The response contains a <literal>BytesReference</literal> that represents the
record that would be written to the <literal>.watcher-history</literal> index.</simpara>
<simpara>The following example executes a watch with the name <literal>my-watch</literal></simpara>
<programlisting language="java" linenumbering="unnumbered">ExecuteWatchResponse executeWatchResponse = watcherClient.prepareExecuteWatch("my-watch")

    // execute the actions, ignoring the watch condition
    .setIgnoreCondition(true)

    // A map containing alternative input to use instead of the output of
    // the watch's input
    .setAlternativeInput(new HashMap&lt;String, Object&gt;())

    // Trigger data to use (Note that "scheduled_time" is not provided to the
    // ctx.trigger by this execution method so you may want to include it here)
    .setTriggerData(new HashMap&lt;String, Object&gt;())

    // Simulating the "email_admin" action while ignoring its throttle state. Use
    // "_all" to set the action execution mode to all actions
    .setActionMode("_all", ActionExecutionMode.FORCE_SIMULATE)

    // If the execution of this watch should be written to the `.watcher-history`
    // index and reflected in the persisted Watch
    .setRecordExecution(false)

    // Indicates whether the watch should execute in debug mode. In debug mode the
    // returned watch record will hold the execution vars
    .setDebug(true)

    .get();</programlisting>
<simpara>Once the response is returned, you can explore it by getting execution record
source:</simpara>
<tip><simpara>The <literal>XContentSource</literal> class provides convenient methods to explore the
      source</simpara></tip>
<programlisting language="java" linenumbering="unnumbered">XContentSource source = executeWatchResponse.getRecordSource();
String actionId = source.getValue("result.actions.0.id");</programlisting>
<bridgehead id="api-java-ack-watch" renderas="sect2">Ack Watch API<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/java/ack-watch.asciidoc">Edit me</ulink></bridgehead>
<simpara><link linkend="actions-ack-throttle">Acknowledging</link> a watch enables you to manually throttle
execution of the watch actions. The action&#8217;s <emphasis>acknowledgement state</emphasis> is stored in
the <literal>_status.actions.&lt;id&gt;.ack.state</literal> structure.</simpara>
<simpara>The current status of the watch and the state of its actions are returned as part
of the <link linkend="api-java-get-watch">Get Watch API</link> response:</simpara>
<programlisting language="java" linenumbering="unnumbered">GetWatchResponse getWatchResponse = watcherClient.prepareGetWatch("my-watch").get();
State state = getWatchResponse.getStatus().actionStatus("my-action").ackStatus().state();</programlisting>
<simpara>The action state of a newly created watch is <literal>awaits_successful_execution</literal>. When
the watch runs and its condition is met, the state changes to <literal>ackable</literal>.
Acknowledging the action sets the state to <literal>acked</literal>.</simpara>
<simpara>When an action state is set to <literal>acked</literal>, further executions of that action are
throttled until its state is reset to <literal>awaits_successful_execution</literal>. This happens
when the watch condition is no longer met (the condition evaluates to <literal>false</literal>).</simpara>
<simpara>The following snippet shows how to acknowledge an action. You specify the IDs of
the watch and the action you want to acknowledge&#8212;in this example <literal>my-watch</literal> and
<literal>my-action</literal>:</simpara>
<programlisting language="java" linenumbering="unnumbered">AckWatchResponse ackResponse = watcherClient.prepareAckWatch("my-watch").setActionIds("my-action").get();</programlisting>
<simpara>As a response to this request, the status of the watch and the state of the
action are returned and can be obtained from <literal>AckWatchResponse</literal> object:</simpara>
<programlisting language="java" linenumbering="unnumbered">WatchStatus status = ackResponse.getStatus();
ActionStatus actionStatus = status.actionStatus("my-action");
ActionStatus.AckStatus ackStatus = actionStatus.ackStatus();
ActionStatus.AckStatus.State ackState = ackStatus.state();</programlisting>
<simpara>You can acknowledge multiple actions:</simpara>
<programlisting language="java" linenumbering="unnumbered">AckWatchResponse ackResponse = watcherClient.prepareAckWatch("my-watch")
  .setActionIds("action1", "action2")
  .get();</programlisting>
<simpara>To acknowledge all actions of a watch, specify only the watch ID:</simpara>
<programlisting language="java" linenumbering="unnumbered">AckWatchResponse ackResponse = watcherClient.prepareAckWatch("my-watch").get();</programlisting>
<bridgehead id="api-java-activate-watch" renderas="sect2">Activate Watch API<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/java/activate-watch.asciidoc">Edit me</ulink></bridgehead>
<simpara>A watch can be either <link linkend="watch-active-state">active or inactive</link>. This API
enables you to activate a currently inactive watch.</simpara>
<simpara>The status of an inactive watch is returned with the watch definition
when you call the <link linkend="api-java-get-watch">Get Watch API</link>:</simpara>
<programlisting language="java" linenumbering="unnumbered">GetWatchResponse getWatchResponse = watcherClient.prepareGetWatch("my-watch").get();
boolean active = getWatchResponse.getStatus().state().isActive();</programlisting>
<simpara>The following snippet shows how you can activate a watch:</simpara>
<programlisting language="java" linenumbering="unnumbered">ActivateWatchResponse activateResponse = watcherClient.prepareActivateWatch("my-watch", true).get();
boolean active = activateResponse.getStatus().state().isActive();</programlisting>
<simpara>The new state of the watch is returned as part of its overall status.</simpara>
<bridgehead id="api-java-deactivate-watch" renderas="sect2">Deactivate Watch API<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/java/deactivate-watch.asciidoc">Edit me</ulink></bridgehead>
<simpara>A watch can be either <link linkend="watch-active-state">active or inactive</link>. This API
enables you to deactivate a currently active watch.</simpara>
<simpara>The status of an active watch is returned with the watch definition
when you call the <link linkend="api-java-get-watch">Get Watch API</link>:</simpara>
<programlisting language="java" linenumbering="unnumbered">GetWatchResponse getWatchResponse = watcherClient.prepareGetWatch("my-watch").get();
boolean active = getWatchResponse.getStatus().state().isActive();</programlisting>
<simpara>The following snippet shows how you can deactivate a watch:</simpara>
<programlisting language="java" linenumbering="unnumbered">ActivateWatchResponse activateResponse = watcherClient.prepareActivateWatch("my-watch", false).get();
boolean active = activateResponse.getStatus().state().isActive();</programlisting>
<simpara>The new state of the watch is returned as part of its overall status.</simpara>
<bridgehead id="api-java-stats" renderas="sect2">Stats API<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/java/stats.asciidoc">Edit me</ulink></bridgehead>
<simpara>The <literal>stats</literal> API returns the current Watcher metrics. You can control what
metrics this API returns using the <literal>metric</literal> parameter.</simpara>
<simpara>The following example queries the <literal>stats</literal> API :</simpara>
<programlisting language="java" linenumbering="unnumbered">WatcherStatsResponse watcherStatsResponse = watcherClient.prepareWatcherStats().get();</programlisting>
<simpara>A successful call returns a response structure that can be accessed as shown:</simpara>
<programlisting language="java" linenumbering="unnumbered">WatcherBuild build = watcherStatsResponse.getBuild();

// The current size of the watcher execution queue
long executionQueueSize = watcherStatsResponse.getThreadPoolQueueSize();

// The maximum size the watch execution queue has grown to
long executionQueueMaxSize = watcherStatsResponse.getThreadPoolQueueSize();

// The total number of watches registered in the system
long totalNumberOfWatches = watcherStatsResponse.getWatchesCount();

// {watcher} state (STARTING,STOPPED or STARTED)
WatcherState watcherState = watcherStatsResponse.getWatcherState();</programlisting>
<bridgehead id="api-java-service" renderas="sect2">Service API<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/java/service.asciidoc">Edit me</ulink></bridgehead>
<simpara>The Watcher <literal>service</literal> API allows the control the lifecycle of the Watcher
service. The following example starts the watcher service:</simpara>
<programlisting language="java" linenumbering="unnumbered">WatcherServiceResponse watcherServiceResponse = watcherClient.prepareWatchService().start().get();</programlisting>
<simpara>The following example stops the watcher service:</simpara>
<programlisting language="java" linenumbering="unnumbered">WatcherServiceResponse watcherServiceResponse = watcherClient.prepareWatchService().stop().get();</programlisting>
<simpara>The following example restarts the watcher service:</simpara>
<programlisting language="java" linenumbering="unnumbered">WatcherServiceResponse watcherServiceResponse = watcherClient.prepareWatchService().restart().get();</programlisting>
</chapter>
<chapter id="managing-watches">
<title>Managing Watches<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/managing-watches.asciidoc">Edit me</ulink></title>
<simpara>Watcher provides as set of APIs you can use to manage your watches:</simpara>
<itemizedlist>
<listitem>
<simpara>
Use the <xref linkend="watcher-api-put-watch"/> to add or update watches
</simpara>
</listitem>
<listitem>
<simpara>
Use the <xref linkend="watcher-api-get-watch"/> to retrieve watches
</simpara>
</listitem>
<listitem>
<simpara>
Use the <xref linkend="watcher-api-delete-watch"/> to delete watches
</simpara>
</listitem>
<listitem>
<simpara>
Use the <xref linkend="watcher-api-activate-watch"/> to activate watches
</simpara>
</listitem>
<listitem>
<simpara>
Use the <xref linkend="watcher-api-deactivate-watch"/> to deactivate watches
</simpara>
</listitem>
<listitem>
<simpara>
Use the <xref linkend="watcher-api-ack-watch"/> to acknowledge watches
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="listing-watches" renderas="sect2">Listing Watches<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/managing-watches.asciidoc">Edit me</ulink></bridgehead>
<simpara>Currently there is not dedicated API for listing the stored watches. However,
since Watcher stores its watches in the <literal>.watches</literal> index, you can list them
by executing a search on this index.</simpara>
<important><simpara>You can only perform read actions on the <literal>.watches</literal> index. You must
            use the Watcher APIs to create, update, and delete watches. If
            X-Pack security is enabled, we recommend you only grant users <literal>read</literal>
            privileges on the <literal>.watches</literal> index.</simpara></important>
<simpara>For example, the following returns the first 100 watches:</simpara>
<programlisting language="js" linenumbering="unnumbered">GET .watches/_search
{
  "size" : 100
}</programlisting>
<remark> CONSOLE</remark>
<remark> TEST[setup:my_active_watch]</remark>
</chapter>
<chapter id="example-watches">
<title>Example Watches<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/example-watches.asciidoc">Edit me</ulink></title>
<section id="watching-meetup-data">
<title>Watching Meetup Data<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/example-watches/example-watch-meetupdata.asciidoc">Edit me</ulink></title>
<simpara>If you are indexing event data, such as log messages, network traffic, or a web feed, you can create a watch to email notifications when certain events occur.
For example, if you index a feed of RSPVs for meetup events happening around the world, you can create a watch that alerts you to interesting events.</simpara>
<simpara>To index the meetup data, you can use <ulink url="https://www.elastic.co/products/logstash">Logstash</ulink> to ingest live data from the Meetup.com streaming API, <literal>http://stream.meetup.com/2/rsvps</literal>.</simpara>
<simpara>To ingest this data with Logstash:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
<ulink url="https://www.elastic.co/downloads/logstash">Download Logstash</ulink> and unpack the
  archive file.
</simpara>
</listitem>
<listitem>
<simpara>
Create a Logstash configuration file that uses the <ulink url="http://www.elastic.co/guide/en/logstash/5.0/plugins-inputs-stdin.html">Logstash standard input</ulink> and the <ulink url="http://www.elastic.co/guide/en/logstash/5.0/plugins-outputs-stdout.html">Logstash standard output</ulink> and save it in <literal>logstash-{version}</literal> directory as <literal>livestream.conf</literal>:
</simpara>
<programlisting language="ruby" linenumbering="unnumbered">input {
  stdin {
    codec =&gt; json <co id="CO61-1"/>
  }
}
filter {
  date {
    match =&gt; [ "event.time", "UNIX_MS" ]
    target =&gt; "event_time"
  }
}
output { <co id="CO61-2"/>
  stdout {
    codec =&gt; rubydebug
  }
  elasticsearch {
    hosts =&gt; "http://localhost:9200"
    user  =&gt; "elastic"
    password  =&gt; "changeme"
  }
}</programlisting>
<calloutlist>
<callout arearefs="CO61-1">
<para>
The meetup data stream is formatted in JSON.
</para>
</callout>
<callout arearefs="CO61-2">
<para>
Index the meetup data into Elasticsearch.
</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>
To start indexing the meetup data, pipe the RSVP stream into Logstash and specify your <literal>livestream.conf</literal> configuration file.
</simpara>
<programlisting language="she" linenumbering="unnumbered">curl http://stream.meetup.com/2/rsvps | bin/logstash -f livestream.conf</programlisting>
</listitem>
</orderedlist>
<simpara>Now that you&#8217;re indexing the meetup RSVPs, you can set up a watch that lets you know about events you might be interested in. For example, let&#8217;s create a watch that runs every hour, looks for events that talk about about <emphasis>Open Source</emphasis>, and sends an email with information about the events.</simpara>
<simpara>To set up the watch:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Specify how often you want to run the watch by adding a schedule trigger to the watch:
</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "trigger": {
    "schedule": {
      "interval": "1h"
    }
  },</programlisting>
</listitem>
<listitem>
<simpara>
Load data into the watch payload by creating an input that searches the meetup data for events that have <emphasis>Open Source</emphasis> as a topic. You can use aggregations to group the data by city, consolidate references to the same events, and sort the events by date.
</simpara>
<programlisting language="js" linenumbering="unnumbered">"input": {
    "search": {
      "request": {
        "indices": [
          "&lt;logstash-{now-1h}&gt;", <co id="CO62-1"/>
          "&lt;logstash-{now}&gt;"
        ],
        "body": {
          "size": 0,
          "query": {
            "bool": {
              "filter": [
                {
                  "range": {
                    "@timestamp": {
                      "gte": "now-3h"
                    }
                  }
                },
                {
                  "match": {
                    "group.group_topics.topic_name": "Open Source" <co id="CO62-2"/>
                  }
                }
              ]
            }
          },
          "aggs": {
            "group_by_city": {
              "terms": {
                "field": "group.group_city.raw", <co id="CO62-3"/>
                "size": 5
              },
              "aggs": {
                "group_by_event": {
                  "terms": {
                    "field": "event.event_url.raw", <co id="CO62-4"/>
                    "size": 5
                  },
                  "aggs": {
                    "get_latest": {
                      "terms": {
                        "field": "@timestamp", <co id="CO62-5"/>
                        "size": 1,
                        "order": {
                          "_term": "desc"
                        }
                      },
                      "aggs": {
                        "group_by_event_name": {
                          "terms": {
                            "field": "event.event_name.raw" <co id="CO62-6"/>
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  },</programlisting>
<calloutlist>
<callout arearefs="CO62-1">
<para>
Elasticsearch Date math is used to select the Logstash indices that contain the meetup data. The second pattern is needed in case the previous hour crosses days.
</para>
</callout>
<callout arearefs="CO62-2">
<para>
Find all of the RSVPs with <literal>Open Source</literal> as a topic.
</para>
</callout>
<callout arearefs="CO62-3">
<para>
Group the RSVPs by city.
</para>
</callout>
<callout arearefs="CO62-4">
<para>
Consolidate multiple RSVPs for the same event.
</para>
</callout>
<callout arearefs="CO62-5">
<para>
Sort the events so the latest events are listed first.
</para>
</callout>
<callout arearefs="CO62-6">
<para>
Group the events by name.
</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>
To determine whether or not there are any Open Source events, add a compare condition that checks the watch payload to see if there were any search hits.
</simpara>
</listitem>
</orderedlist>
<programlisting language="js" linenumbering="unnumbered">"compare" : { "ctx.payload.hits.total" : { "gt" : 0 }}</programlisting>
<orderedlist numeration="arabic">
<listitem>
<simpara>
To send an email when <emphasis>Open Source</emphasis> events are found, add an email action:
</simpara>
</listitem>
</orderedlist>
<programlisting language="js" linenumbering="unnumbered">"actions": {
    "email_me": {
      "throttle_period": "10m",
      "email": {
        "from": "&lt;from:email address&gt;",
        "to": "&lt;to:email address&gt;",
        "subject": "Open Source Events",
        "body": {
          "html": "Found events matching Open Source: &lt;ul&gt;{{#ctx.payload.aggregations.group_by_city.buckets}}&lt;          li&gt;{{key}} ({{doc_count}})&lt;ul&gt;{{#group_by_event.buckets}}
          &lt;li&gt;&lt;a href=\"{{key}}\"&gt;{{get_latest.buckets.0.group_by_event_name.buckets.0.key}}&lt;/a&gt;
          ({{doc_count}})&lt;/li&gt;{{/group_by_event.buckets}}&lt;/ul&gt;&lt;/li&gt;
          {{/ctx.payload.aggregations.group_by_city.buckets}}&lt;/ul&gt;"
        }
      }
    }
  }</programlisting>
<note><simpara>To enable Watcher to send emails, you must configure an email account in <literal>elasticsearch.yml</literal>. For more information, see <link linkend="configuring-email">Working with Various Email Services</link>.</simpara></note>
<simpara>The complete watch looks like this:</simpara>
<programlisting language="js" linenumbering="unnumbered">PUT _xpack/watcher/watch/meetup
{
  "trigger": {
    "schedule": {
      "interval": "1h"
    }
  },
  "input": {
    "search": {
      "request": {
        "indices": [
          "&lt;logstash-{now-1h}&gt;",
          "&lt;logstash-{now}&gt;"
        ],
        "body": {
          "size": 0,
          "query": {
            "bool": {
              "filter": [
                {
                  "range": {
                    "@timestamp": {
                      "gte": "now-3h"
                    }
                  }
                },
                {
                  "match": {
                    "group.group_topics.topic_name": "Open Source"
                  }
                }
              ]
            }
          },
          "aggs": {
            "group_by_city": {
              "terms": {
                "field": "group.group_city.raw",
                "size": 5
              },
              "aggs": {
                "group_by_event": {
                  "terms": {
                    "field": "event.event_url.raw",
                    "size": 5
                  },
                  "aggs": {
                    "get_latest": {
                      "terms": {
                        "field": "@timestamp",
                        "size": 1,
                        "order": {
                          "_term": "desc"
                        }
                      },
                      "aggs": {
                        "group_by_event_name": {
                          "terms": {
                            "field": "event.event_name.raw"
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  },
  "condition": {
    "compare": {
      "ctx.payload.hits.total": {
        "gt": 0
      }
    }
  },
  "actions": {  <co id="CO63-1"/>
    "email_me": {
      "throttle_period": "10m",
      "email": {
        "from": "&lt;username&gt;@&lt;domainname&gt;",  <co id="CO63-2"/>
        "to": "&lt;username@&lt;domainname&gt;",     <co id="CO63-3"/>
        "subject": "Open Source events",
        "body": {
          "html": "Found events matching Open Source: &lt;ul&gt;{{#ctx.payload.aggregations.group_by_city.buckets}}&lt;li&gt;{{key}} ({{doc_count}})&lt;ul&gt;{{#group_by_event.buckets}}&lt;li&gt;&lt;a href=\"{{key}}\"&gt;{{get_latest.buckets.0.group_by_event_name.buckets.0.key}}&lt;/a&gt; ({{doc_count}})&lt;/li&gt;{{/group_by_event.buckets}}&lt;/ul&gt;&lt;/li&gt;{{/ctx.payload.aggregations.group_by_city.buckets}}&lt;/ul&gt;"
         }
      }
    }
  }
}</programlisting>
<remark> CONSOLE</remark>
<calloutlist>
<callout arearefs="CO63-1">
<para>
The email body can include Mustache templates to reference data in the watch payload. By default,it will be <link linkend="email-html-sanitization">sanitized</link> to block dangerous content.
</para>
</callout>
<callout arearefs="CO63-2">
<para>
Replace the <literal>from</literal> address with the email address you configured in <literal>elasticsearch.yml</literal>.
</para>
</callout>
<callout arearefs="CO63-3">
<para>
Replace the <literal>to</literal> address with your email address to receive notifications.
</para>
</callout>
</calloutlist>
<simpara>Now that you&#8217;ve created your watch, you can use the <link linkend="watcher-api-execute-watch"><literal>_execute</literal></link> API to run it without waiting for the schedule to trigger execution:</simpara>
<programlisting language="js" linenumbering="unnumbered">POST _xpack/watcher/watch/meetup/_execute</programlisting>
<remark> CONSOLE</remark>
<remark> TEST[continued]</remark>
</section>
</chapter>
</part>
<part id="xpack-reporting">
<title>Reporting from Kibana <ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/reporting/index.asciidoc">Edit me</ulink></title>
<partintro>
<simpara>X-Pack enables you to generate reports that contain Kibana dashboards,
visualizations, and saved searches.</simpara>
<simpara>When you install X-Pack into Kibana, a Reporting button is added to the
toolbar:</simpara>
<simpara><inlinemediaobject>
  <imageobject>
  <imagedata fileref="images/reporting/reporting.jpg"/>
  </imageobject>
  <textobject><phrase>Reporting</phrase></textobject>
</inlinemediaobject></simpara>
<important><simpara>Reports are stored in the <literal>.reporting-*</literal> indices. Any user with
access to these indices has access to every report generated by all users.</simpara></important>
<simpara>You can also <link linkend="automating-report-generation">generate reports automatically</link>.</simpara>
<simpara>To use X-Pack reporting in a production environment, <link linkend="securing-reporting">secure the Reporting endpoints</link>.</simpara>
</partintro>
<chapter id="reporting-getting-started">
<title>Getting Started<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/reporting/getting-started.asciidoc">Edit me</ulink></title>
<simpara>X-Pack reporting is automatically enabled when you <link linkend="installing-xpack">install X-Pack</link> into Kibana.</simpara>
<simpara>To manually generate a report:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Open Kibana in your web browser and log in. If you are running Kibana
locally, go to <literal>http://localhost:5601</literal>. To access Kibana and generate
reports, you need the <literal>kibana_user</literal> and <link linkend="secure-reporting"><literal>reporting_user</literal></link>
roles.
</simpara>
</listitem>
<listitem>
<simpara>
Open the dashboard, visualization, or saved search you want to include
in the report.
</simpara>
</listitem>
<listitem>
<simpara>
Click <emphasis role="strong">Reporting</emphasis> in the Kibana toolbar:
</simpara>
<simpara><inlinemediaobject>
  <imageobject>
  <imagedata fileref="images/reporting/reporting.jpg"/>
  </imageobject>
  <textobject><phrase>Reporting</phrase></textobject>
</inlinemediaobject></simpara>
</listitem>
<listitem>
<simpara>
Click <emphasis role="strong">Printable PDF</emphasis>.
</simpara>
</listitem>
</orderedlist>
<simpara>If you want to automatically generate reports from a script or with
Watcher, use the displayed Generation URL. For more information, see
<link linkend="automating-report-generation">Automating Report Generation</link>.</simpara>
</chapter>
<chapter id="automating-report-generation">
<title>Automating Report Generation<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/reporting/automating-report-generation.asciidoc">Edit me</ulink></title>
<simpara>You can automatically generate reports with a watch, or by submitting
HTTP POST requests from a script.</simpara>
<simpara>To automatically generate reports with a watch, you need to configure
Watcher to trust the Kibana server’s certificate. For more information,
see <link linkend="securing-reporting">Securing Reporting</link>.</simpara>
<important>
<simpara>The interval between report requests must be longer than the time it
takes to generate the reports&#8212;otherwise, the report queue can back up. To
avoid this, increase the time between report requests.</simpara>
<simpara>By default, report generation times out if the report cannot be generated
within 30 seconds. If you are generating reports that contain complex
visualizations or your machine is slow or under constant heavy load, it
might take longer than 30 seconds to generate a report. You can increase
the timeout by setting <literal>xpack.reporting.queue.timeout</literal> in <literal>kibana.yml</literal>.</simpara>
</important>
<simpara>You request reports through three X-Pack reporting endpoints:</simpara>
<itemizedlist>
<listitem>
<simpara>
Dashboard Reports:  <literal>/api/reporting/generate/dashboard/&lt;dashboard-id&gt;&amp;sync</literal>
</simpara>
</listitem>
<listitem>
<simpara>
Visualization Reports:  <literal>/api/reporting/generate/visualization/&lt;visualization-id&gt;&amp;sync</literal>
</simpara>
</listitem>
<listitem>
<simpara>
Saved Search Reports: <literal>/api/reporting/generate/search/&lt;saved-search-id&gt;&amp;sync</literal>
</simpara>
</listitem>
</itemizedlist>
<note><simpara>The <literal>&amp;sync</literal> parameter is required to retrieve a PDF of the report. If you
omit it, X-Pack reporting returns a JSON structure that only contains the report
metadata.</simpara></note>
<simpara>To specify the time period you want to include in the report, you use the <literal>_g</literal>
parameter in the request. For example:</simpara>
<programlisting language="shell" linenumbering="unnumbered">http://0.0.0.0:5601/api/reporting/generate/dashboard/error-monitoring?_g=(time:(from:now-1d%2Fd,mode:quick,to:now-1d%2Fd))&amp;sync</programlisting>
<simpara>You can get the URL for a particular report from Kibana:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Load the saved object.
</simpara>
</listitem>
<listitem>
<simpara>
Click <emphasis role="strong">Reporting</emphasis> in the Kibana toolbar.
</simpara>
</listitem>
<listitem>
<simpara>
Copy the displayed <emphasis role="strong">Generation URL</emphasis>.
</simpara>
</listitem>
</orderedlist>
<simpara>To configure a watch to email reports, you use the
<ulink url="https://www.elastic.co/guide/en/watcher/current/actions.html#configuring-email-attachments">
<literal>http</literal> attachment type</ulink> in an <literal>email</literal> action.</simpara>
<simpara>For example, the following watch generates a report that contains the
<emphasis role="strong">Error Monitoring</emphasis> dashboard and emails the report every hour:</simpara>
<programlisting language="js" linenumbering="unnumbered">PUT _xpack/watcher/watch/error_report
{
  "trigger" : {
    "schedule": {
      "interval": "1h"
    }
  },
  "actions" : {
  "email_admin" : { <co id="CO64-1"/>
    "email": {
      "to": "'Recipient Name &lt;recipient@example.com&gt;'",
      "subject": "Error Monitoring Report",
      "attachments" : {
        "error_report.pdf" : {
          "http" : {
            "content_type" : "application/pdf",
            "request" : {
              "method": "POST", <co id="CO64-2"/>
              "headers": {
                "kbn-xsrf": "reporting"
              },
              "read_timeout": "300s", <co id="CO64-3"/>
              "url": "http://0.0.0.0:5601/api/reporting/generate/dashboard/Error-Monitoring?_g=(time:(from:now-1d%2Fd,mode:quick,to:now))&amp;sync" <co id="CO64-4"/>
            }
          }
        }
      }
    }
  }
 }
}</programlisting>
<remark> CONSOLE</remark>
<calloutlist>
<callout arearefs="CO64-1">
<para>
You must <ulink url="https://www.elastic.co/guide/en/watcher/current/email-services.html#email-account">
configure at least one email account</ulink> to enable Watcher to send email.
</para>
</callout>
<callout arearefs="CO64-2">
<para>
Requests to the Reporting endpoints must use POST and include the
<literal>kbn-xsrf</literal> header.
</para>
</callout>
<callout arearefs="CO64-3">
<para>
Increase the <literal>read_timeout</literal> to give X-Pack reporting enough time to generate the
report.
</para>
</callout>
<callout arearefs="CO64-4">
<para>
This is an example Generation URL. You can copy and paste the URL for any
report from the Kibana UI.
</para>
</callout>
</calloutlist>
<simpara>For more information about configuring watches, see <link linkend="how-watcher-works">How Watches Work</link>.</simpara>
</chapter>
<chapter id="configuring-reporting">
<title>Configuring Reporting<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/reporting/configuring-reporting.asciidoc">Edit me</ulink></title>
<simpara>By default, a new encryption key is generated for X-Pack reporting each time
you start Kibana. This means any pending reports will fail if you
restart Kibana.</simpara>
<simpara>To set a static encryption key for reporting, set the
<literal>xpack.reporting.encryptionKey</literal> property in the <literal>kibana.yml</literal>
configuration file. You can use any text string as the encryption key.</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.reporting.encryptionKey: "something_secret"</programlisting>
<note><simpara>If you are load balancing across multiple Kibana instances, they need
to have the same reporting encryption key. Otherwise, report generation
will fail if a report is requested through one instance and another instance
picks up the job from the report queue.</simpara></note>
<simpara>You can also configure settings in <literal>kibana.yml</literal> to control how X-Pack reporting
communicates with the Kibana server, manages background jobs, and captures
screenshots. See <link linkend="reporting-settings">Reporting Settings</link> for the complete
list of settings.</simpara>
<section id="securing-reporting">
<title>Securing the Reporting Endpoints<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/reporting/configuring-reporting.asciidoc">Edit me</ulink></title>
<simpara>In a production environment, you should restrict access to
the X-Pack reporting endpoints to authorized users. This requires that you:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
<link linkend="security-getting-started">Enable X-Pack security</link> on your Elasticsearch
cluster.
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="configure-kibana-cert">Configure an SSL certificate</link> for Kibana.
</simpara>
</listitem>
<listitem>
<simpara>
Configure Watcher to trust the Kibana server&#8217;s certificate by adding it to
the Watcher truststore on each node:
</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>
Import the Kibana server certificate into the Watcher truststore using
Java Keytool:
</simpara>
<programlisting language="shell" linenumbering="unnumbered">keytool -importcert -keystore watcher-truststore.jks -file server.crt</programlisting>
<note><simpara>If the truststore doesn&#8217;t already exist, it is created.</simpara></note>
</listitem>
<listitem>
<simpara>
Make sure the <literal>watcher.http.ssl.truststore.path</literal> setting in
<literal>elasticsearch.yml</literal> specifies the location of the Watcher
truststore.
</simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>
<link linkend="secure-reporting">Add one or more users</link> who have the permissions
necessary to use Kibana and X-Pack reporting.
</simpara>
</listitem>
</orderedlist>
<simpara>Once you&#8217;ve enabled SSL for Kibana, all requests to the X-Pack reporting endpoints
must include valid credentials. For example, the following watch submits
requests as the built-in <literal>elastic</literal> user:</simpara>
<programlisting language="js" linenumbering="unnumbered">PUT _xpack/watcher/watch/error_report
{
  "trigger" : {
    "schedule": {
      "interval": "1h"
    }
  },
  "actions" : {
  "email_admin" : {
    "email": {
      "to": "'Recipient Name &lt;recipient@example.com&gt;'",
      "subject": "Error Monitoring Report",
      "attachments" : {
        "error_report.pdf" : {
          "http" : {
            "content_type" : "application/pdf",
            "request" : {
              "method": "POST",
              "scheme": "https", <co id="CO65-1"/>
              "headers": {
                "kbn-xsrf": "reporting"
              },
              "auth": { <co id="CO65-2"/>
                "basic": {
                  "username": "elastic",
                  "password": "changeme"
                }
              },
              "read_timeout": "300s",
              "url": "https://0.0.0.0:5601/api/reporting/generate/dashboard/Error-Monitoring?_g=(time:(from:now-1d%2Fd,mode:quick,to:now))&amp;sync"
            }
          }
        }
      }
    }
  }
 }
}</programlisting>
<remark> CONSOLE</remark>
<calloutlist>
<callout arearefs="CO65-1">
<para>
You must connect to the X-Pack reporting endpoints via HTTPS when SSL is enabled.
</para>
</callout>
<callout arearefs="CO65-2">
<para>
Provide user credentials for a user with permission to access Kibana and X-Pack reporting.
For more information, see <link linkend="reporting-app-users">Setting up a Reporting Role</link>.
</para>
</callout>
</calloutlist>
</section>
</chapter>
</part>
<part id="xpack-graph">
<title>Graphing Connections in Your Data <ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/graph/index.asciidoc">Edit me</ulink></title>
<partintro>
<simpara>The X-Pack graph capabilities enable you to discover how items in an
Elasticsearch index are related. You can explore the connections between
indexed terms and see which connections are the most meaningful. This can be
useful in a variety of applications, from fraud detection to recommendation
engines.</simpara>
<simpara>For example, graph exploration could help you uncover website vulnerabilities
that hackers are targeting so you can harden your website. Or, you might
provide graph-based personalized recommendations to your e-commerce customers.</simpara>
<simpara>X-Pack provides a simple, yet powerful graph exploration API, and an
interactive graph visualization tool for Kibana. Both work with out of the
box with existing Elasticsearch indices&#8212;you don&#8217;t need to store any
additional data to use the X-Pack graph features.</simpara>
<bridgehead id="how-graph-works" renderas="sect2">How Graphs Work<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/graph/index.asciidoc">Edit me</ulink></bridgehead>
<simpara>The Graph API provides an alternative way to extract and summarize information
about the documents and terms in your Elasticsearch index. A <emphasis>graph</emphasis> is really
just a network of related items. In our case, this means a network of related
terms in the index.</simpara>
<simpara>The terms you want to include in the graph are called <emphasis>vertices</emphasis>. The
relationship between any two vertices is a <emphasis>connection</emphasis>. The connection
summarizes the documents that contain both vertices' terms.</simpara>
<informalfigure>
<mediaobject>
  <imageobject>
  <imagedata fileref="images/graph/graph-vertices-connections.jpg"/>
  </imageobject>
  <textobject><phrase>Graph components</phrase></textobject>
</mediaobject>
</informalfigure>
<note><simpara>If you&#8217;re into <ulink url="https://en.wikipedia.org/wiki/Graph_theory">graph theory</ulink>,
you might know vertices and connections as <emphasis>nodes</emphasis> and <emphasis>edges</emphasis>. They&#8217;re the
same thing, we just want to use terminology that makes sense to people who
aren&#8217;t graph geeks and avoid any confusion with the nodes in an Elasticsearch
cluster.</simpara></note>
<simpara>The graph vertices are simply the terms that you&#8217;ve already indexed. The
connections are derived on the fly using Elasticsearch aggregations. To
identify the most <emphasis>meaningful</emphasis> connections, the Graph API leverages
Elasticsearch relevance scoring. The same data structures and relevance ranking
tools built into Elasticsearch to support text searches enable the Graph API to
separate useful signals from the noise that is typical of most connected data.</simpara>
<simpara>This foundation lets you easily answer questions like:</simpara>
<itemizedlist>
<listitem>
<simpara>
What are the shared behaviors of people trying to hack my website?
</simpara>
</listitem>
<listitem>
<simpara>
If users bought this type of gardening glove, what other products might they
be interested in?
</simpara>
</listitem>
<listitem>
<simpara>
Which people on Stack Overflow have expertise in both Hadoop-related
technologies and Python-related tech?
</simpara>
</listitem>
</itemizedlist>
<simpara>But what about performance, you ask? The Elasticsearch aggregation framework
enables the Graph API to quickly summarize millions of documents as a single
super-connection. Instead of retrieving every banking transaction between
accounts A and B, it derives a single connection that represents that
relationship. And, of course, this summarization process works across
multi-node clusters and scales with your Elasticsearch deployment.
Advanced options let you control how your data is sampled and summarized.
You can also set timeouts to prevent graph queries from adversely
affecting the cluster.</simpara>
</partintro>
<chapter id="graph-getting-started">
<title>Getting Started<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/graph/getting-started.asciidoc">Edit me</ulink></title>
<simpara>Graph is automatically enabled when you <link linkend="installing-xpack">install X-Pack</link>
into Elasticsearch and Kibana.</simpara>
<simpara id="exploring-connections">To start exploring connections in your data:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Open Kibana in your web browser and log in. If you are running Kibana
locally, go to <literal>http://localhost:5601/</literal>.
</simpara>
</listitem>
<listitem>
<simpara>
Click <emphasis role="strong">Graph</emphasis> in the side navigation to open the graph explorer.
</simpara>
<informalfigure>
<mediaobject>
  <imageobject>
  <imagedata fileref="images/graph/graph-open.jpg"/>
  </imageobject>
  <textobject><phrase>Accessing Graph</phrase></textobject>
</mediaobject>
</informalfigure>
</listitem>
<listitem>
<simpara>
Select an index pattern to specify what indices you want to explore.
For example, if you are indexing log data with Logstash, you could select the
<literal>logstash-*</literal> index pattern to visualize connections within the log entries.
</simpara>
</listitem>
<listitem>
<simpara>
Select one or more multi-value fields that contain the terms you want to
graph. The vertices in the graph are selected from these terms. If you&#8217;re
visualizing connections between Apache log entries, you could select the
<literal>url.raw</literal> field and the <literal>geo.src</literal> field so you can look at which pages are
being accessed from different locations.
</simpara>
</listitem>
<listitem>
<simpara>
Enter a search query to discover relationships between terms in the selected
fields. For example, to generate a graph of the successful requests to
particular pages from different locations, you could search for the 200
response code:
</simpara>
<informalfigure>
<mediaobject>
  <imageobject>
  <imagedata fileref="images/graph/graph-url-connections.jpg"/>
  </imageobject>
  <textobject><phrase>URL connections</phrase></textobject>
</mediaobject>
</informalfigure>
</listitem>
</orderedlist>
<simpara>The weight of the connection between two vertices indicates how strongly they
are related. You can click any connection to view more information about
the relationship:</simpara>
<informalfigure>
<mediaobject>
  <imageobject>
  <imagedata fileref="images/graph/graph-link-summary.jpg"/>
  </imageobject>
  <textobject><phrase>Link summary</phrase></textobject>
</mediaobject>
</informalfigure>
<simpara>Once you have your initial graph, you can use the toolbar buttons to explore
additional connections. Click the Expand button
<inlinemediaobject>
  <imageobject>
  <imagedata fileref="images/graph/graph-expand-button.jpg"/>
  </imageobject>
  <textobject><phrase>Expand Selection</phrase></textobject>
</inlinemediaobject> to display additional vertices
that connect to your graph. Click the Link button
<inlinemediaobject>
  <imageobject>
  <imagedata fileref="images/graph/graph-link-button.jpg"/>
  </imageobject>
  <textobject><phrase>Add links to existing terms</phrase></textobject>
</inlinemediaobject> to display additional
connections between the displayed vertices. To explore a particular area of the
graph, select the vertices you are interested in and click the Expand or Link button.
To step back through your changes to the graph, click the Undo button
<inlinemediaobject>
  <imageobject>
  <imagedata fileref="images/graph/graph-undo-button.jpg"/>
  </imageobject>
  <textobject><phrase>Undo</phrase></textobject>
</inlinemediaobject>.</simpara>
<simpara>To see more relationships within your data, you can submit additional queries.</simpara>
<informalfigure>
<mediaobject>
  <imageobject>
  <imagedata fileref="images/graph/graph-add-query.jpg"/>
  </imageobject>
  <textobject><phrase>Adding networks</phrase></textobject>
</mediaobject>
</informalfigure>
<note><simpara>By default, when you submit a search query Graph searches all available
fields. You can constrain your search to a particular field using the Lucene
query syntax. For example,  <literal>machine.os: osx</literal>.</simpara></note>
</chapter>
<chapter id="graph-configuration">
<title>Configuring Graph<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/graph/configuring-graph.asciidoc">Edit me</ulink></title>
<simpara>When a user saves a graph workspace in Kibana, it is stored in the <literal>.kibana</literal>
index along with other saved objects like visualizations and dashboards.
By default, both the configuration and data are saved for the workspace:</simpara>
<informaltable tabstyle="horizontal" frame="none" colsep="0" rowsep="0"><tgroup cols="2"><colspec colwidth="15*"/><colspec colwidth="85*"/><tbody valign="top">
<row>
<entry>
<simpara>
<emphasis role="strong">configuration</emphasis>
</simpara>
</entry>
<entry>
<simpara>
The selected index pattern, fields, colors, icons,
and settings.
</simpara>
</entry>
</row>
<row>
<entry>
<simpara>
<emphasis role="strong">data</emphasis>
</simpara>
</entry>
<entry>
<simpara>
The visualized content (the vertices and connections displayed in
the workspace).
</simpara>
</entry>
</row>
</tbody></tgroup></informaltable>
<simpara>The data in a saved workspace is like a report&#8212;it is a saved snapshot that
potentially summarizes millions of raw documents. Once saved, these summaries
are no longer controlled by security policies. Because the original documents
might be deleted after a workspace is saved, there&#8217;s no practical basis for
checking permissions for the data in a saved workspace.</simpara>
<simpara>For this reason, you can configure the save policy for graph workspaces to
ensure appropriate handling of your data. You can allow users to save
only the configuration information for a graph, require users to
explicitly include the workspace data, or completely disable the ability
to save a workspace.</simpara>
<simpara>For example, to disable the save option entirely, set
<literal>xpack.graph.savePolicy</literal> to <literal>none</literal> in <literal>kibana.yml</literal>:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.graph.savePolicy: none</programlisting>
<simpara>The supported save policies are:</simpara>
<variablelist>
<varlistentry>
<term>
<literal>none</literal>
</term>
<listitem>
<simpara>
Neither the configuration or data can be saved.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>config</literal>
</term>
<listitem>
<simpara>
Only the configuration is saved.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>configAndData</literal>
</term>
<listitem>
<simpara>
Both configuration and data are saved. This is the
default policy.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>configAndDataWithConsent</literal>
</term>
<listitem>
<simpara>
Only the configuration is saved unless the user
explicitly selects the include data option.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="disable-drill-down" renderas="sect2">Disabling Drill Down Configuration<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/graph/configuring-graph.asciidoc">Edit me</ulink></bridgehead>
<simpara>By default, users can configure <emphasis>drill down</emphasis> URLs to display additional
information about a selected vertex in a new browser window. For example,
you could configure a drill down URL to perform a web search for the selected
vertex term.</simpara>
<simpara>To prevent users from adding drill down URLs,  set
<literal>xpack.graph.canEditDrillDownUrls</literal> to <literal>false</literal> in <literal>kibana.yml</literal>:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.graph.canEditDrillDownUrls: false</programlisting>
</chapter>
</part>
<part id="xpack-settings">
<title>X-Pack Settings <ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-settings.asciidoc">Edit me</ulink></title>
<partintro>
<simpara>You configure settings for X-Pack features in the <literal>elasticsearch.yml</literal> and <literal>kibana.yml</literal>
configuration files.</simpara>
<itemizedlist>
<listitem>
<simpara>
<link linkend="security-settings">Security Settings</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="monitoring-settings">Monitoring Settings</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="notification-settings">Watcher Settings</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="reporting-settings">Reporting Settings</link>
</simpara>
</listitem>
</itemizedlist>
</partintro>
<chapter id="security-settings">
<title>Security Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/settings/security-settings.asciidoc">Edit me</ulink></title>
<simpara>You configure <literal>xpack.security</literal> settings  to
<link linkend="anonymous-access-settings">enable anonymous access</link>
and perform message authentication,
<link linkend="field-document-security-settings">set up document and field level security</link>, <link linkend="realm-settings">configure realms</link>,
and <link linkend="ssl-tls-settings">encrypt communications with SSL</link>.</simpara>
<bridgehead id="general-security-settings" renderas="sect2">General Security Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/settings/security-settings.asciidoc">Edit me</ulink></bridgehead>
<variablelist>
<varlistentry>
<term>
<literal>xpack.security.enabled</literal>
</term>
<listitem>
<simpara>
Set to <literal>false</literal> to disable X-Pack security.
Configure in both <literal>elasticsearch.yml</literal> and <literal>kibana.yml</literal>.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="anonymous-access-settings" renderas="sect2">Anonymous Access Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/settings/security-settings.asciidoc">Edit me</ulink></bridgehead>
<simpara>You can configure the following anonymous access settings in
<literal>elasticsearch.yml</literal>.  For more information, see <link linkend="anonymous-access">Enabling Anonymous Access</link>.</simpara>
<variablelist>
<varlistentry>
<term>
<literal>xpack.security.authc.anonymous.username</literal>
</term>
<listitem>
<simpara>
The username (principal) of the anonymous user. Defaults to <literal>_es_anonymous_user</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.security.authc.anonymous.roles</literal>
</term>
<listitem>
<simpara>
The roles to associate with the anonymous user. Required.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.security.authc.anonymous.authz_exception</literal>
</term>
<listitem>
<simpara>
When <literal>true</literal>, an HTTP 403 response is returned if the anonymous user
does not have the appropriate permissions for the requested action. The
user is not prompted to provide credentials to access the requested
resource. When set to <literal>false</literal>, a HTTP 401 is returned and the user
can provide credentials with the appropriate permissions to gain
access. Defaults to <literal>true</literal>.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="field-document-security-settings" renderas="sect2">Document and Field Level Security Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/settings/security-settings.asciidoc">Edit me</ulink></bridgehead>
<simpara>You can set the following document and field level security
settings in <literal>elasticsearch.yml</literal>. For more information, see
<link linkend="field-and-document-access-control">Setting Up Document and Field Level Security</link>.</simpara>
<variablelist>
<varlistentry>
<term>
<literal>xpack.security.dls_fls.enabled</literal>
</term>
<listitem>
<simpara>
Set to <literal>false</literal> to prevent document and field level security
from being configured. Defaults to <literal>true</literal>.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="realm-settings" renderas="sect2">Realm Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/settings/security-settings.asciidoc">Edit me</ulink></bridgehead>
<simpara>You configure realm settings in the <literal>xpack.security.authc.realms</literal>
namespace in <literal>elasticsearch.yml</literal>. For example:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.security.authc.realms:

    realm1:
        type: native
        order: 0
        ...

    realm2:
        type: ldap
        order: 1
        ...

    realm3:
        type: active_directory
        order: 2
        ...
    ...</programlisting>
<simpara>The valid settings vary depending on the realm type. For more
information, see <link linkend="setting-up-authentication">Setting Up Authentication</link>.</simpara>
<bridgehead id="_settings_valid_for_all_realms" renderas="sect3">Settings Valid for All Realms<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/settings/security-settings.asciidoc">Edit me</ulink></bridgehead>
<variablelist>
<varlistentry>
<term>
<literal>type</literal>
</term>
<listitem>
<simpara>
The type of the realm: <literal>native, `ldap</literal>, <literal>active_directory</literal>, <literal>pki</literal>, or <literal>file</literal>. Required.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>order</literal>
</term>
<listitem>
<simpara>
The priority of the realm within the realm chain. Defaults to <literal>Integer.MAX_VALUE</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>enabled</literal>
</term>
<listitem>
<simpara>
Enable/disable the realm. Defaults to <literal>true</literal>.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="ref-users-settings" renderas="sect3">File Realm Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/settings/security-settings.asciidoc">Edit me</ulink></bridgehead>
<variablelist>
<varlistentry>
<term>
<literal>cache.ttl</literal>
</term>
<listitem>
<simpara>
The time-to-live for cached user entries&#8212;user credentials are cached for
this configured period of time. Defaults to <literal>20m</literal>. Specify values using the
standard Elasticsearch <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/common-options.html#time-units">time units</ulink>.
Defaults to <literal>20m</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>cache.max_users</literal>
</term>
<listitem>
<simpara>
The maximum number of user entries that can live in the cache at a given time.
Defaults to 100,000.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>cache.hash_algo</literal>
</term>
<listitem>
<simpara>
(Expert Setting) The hashing algorithm that is used for the in-memory cached
user credentials. See the <link linkend="cache-hash-algo">Cache hash algorithms</link> table f
or all possible values. Defaults to <literal>ssha256</literal>.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="ref-ldap-settings" renderas="sect3">LDAP Realm Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/settings/security-settings.asciidoc">Edit me</ulink></bridgehead>
<variablelist>
<varlistentry>
<term>
<literal>url</literal>
</term>
<listitem>
<simpara>
An LDAP URL in the format <literal>ldap[s]://&lt;server&gt;:&lt;port&gt;</literal>. Required.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>load_balance.type</literal>
</term>
<listitem>
<simpara>
The behavior to use when there are multiple LDAP URLs defined. For supported
values see <link linkend="ldap-load-balancing">LDAP load balancing and failover types</link>.
Defaults to <literal>failover</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>load_balance.cache_ttl</literal>
</term>
<listitem>
<simpara>
When using <literal>dns_failover</literal> or <literal>dns_round_robin</literal> as the load balancing type,
this setting controls the amount of time to cache DNS lookups. Defaults
to <literal>1h</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>bind_dn</literal>
</term>
<listitem>
<simpara>
The DN of the user that will be used to bind to the LDAP and perform searches.
If this is not specified, an anonymous bind will be attempted.
Defaults to Empty.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>bind_password</literal>
</term>
<listitem>
<simpara>
The password for the user that will be used to bind to the LDAP.
Defaults to Empty.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>user_dn_templates</literal>
</term>
<listitem>
<simpara>
The DN template that replaces the user name with the string <literal>{0}</literal>.
This element is multivalued; you can specify multiple user contexts.
Required to operate in user template mode. Not valid
if <literal>user_search.base_dn</literal> is specified. For more information on
the different modes, see <link linkend="ldap-realm">ldap realms</link>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>user_group_attribute</literal>
</term>
<listitem>
<simpara>
Specifies the attribute to examine on the user for group membership.
The default is <literal>memberOf</literal>. This setting will be ignored if any
<literal>group_search</literal> settings are specified. Defaults to  <literal>memberOf</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>user_search.base_dn</literal>
</term>
<listitem>
<simpara>
Specifies a container DN to search for users. Required
to operated in user search mode. Not valid if
`user_dn_templates is specified. For more information on
the different modes, see <link linkend="ldap-realm">ldap realms</link>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>user_search.scope</literal>
</term>
<listitem>
<simpara>
The scope of the user search. Valid values are <literal>sub_tree</literal>, <literal>one_level</literal> or
<literal>base</literal>. <literal>one_level</literal> only searches objects directly contained within the
<literal>base_dn</literal>. <literal>sub_tree</literal> searches all objects contained under <literal>base_dn</literal>.
<literal>base</literal> specifies that the <literal>base_dn</literal> is the user object, and that it is
the only user considered. Defaults to  <literal>sub_tree</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>user_search.attribute</literal>
</term>
<listitem>
<simpara>
The attribute to match with the username presented to. Defaults to <literal>uid</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>user_search.pool.enabled</literal>
</term>
<listitem>
<simpara>
Enables or disables connection pooling for user search. When
disabled a new connection is created for every search. The
default is <literal>true</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>user_search.pool.size</literal>
</term>
<listitem>
<simpara>
The maximum number of connections to the LDAP server to allow in the
connection pool. Defaults to <literal>20</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>user_search.pool.initial_size</literal>
</term>
<listitem>
<simpara>
The initial number of connections to create to the LDAP server on startup.
Defaults to <literal>5</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>user_search.pool.health_check.enabled</literal>
</term>
<listitem>
<simpara>
Flag to enable or disable a health check on LDAP connections in the connection
pool. Connections are checked in the background at the specified interval.
Defaults to <literal>true</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>user_search.pool.health_check.dn</literal>
</term>
<listitem>
<simpara>
The distinguished name to be retrieved as part of the health check.
Defaults to the value of <literal>bind_dn</literal>. Required if <literal>bind_dn</literal> is not
specified.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>user_search.pool.health_check.interval</literal>
</term>
<listitem>
<simpara>
The interval to perform background checks of connections in the pool.
Defaults to <literal>60s</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>group_search.base_dn</literal>
</term>
<listitem>
<simpara>
The container DN to search for groups in which the user has membership. When
this element is absent, Security searches for the attribute specified by
<literal>user_group_attribute</literal> set on the user in order to determine group membership.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>group_search.scope</literal>
</term>
<listitem>
<simpara>
Specifies whether the group search should be <literal>sub_tree</literal>, <literal>one_level</literal> or
<literal>base</literal>.  <literal>one_level</literal> only searches objects directly contained within the
<literal>base_dn</literal>. <literal>sub_tree</literal> searches all objects contained under <literal>base_dn</literal>.
<literal>base</literal> specifies that the <literal>base_dn</literal> is a group object, and that it is the
only group considered. Defaults to  <literal>sub_tree</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>group_search.filter</literal>
</term>
<listitem>
<simpara>
When not set, the realm searches for <literal>group</literal>, <literal>groupOfNames</literal>, <literal>groupOfUniqueNames</literal>,
or <literal>posixGroup</literal> with the attributes <literal>member</literal>, <literal>memberOf</literal>, or <literal>memberUid</literal>.  Any
instance of <literal>{0}</literal> in the filter is replaced by the user attribute defined in
<literal>group_search.user_attribute</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>group_search.user_attribute</literal>
</term>
<listitem>
<simpara>
Specifies the user attribute that will be fetched and provided as a parameter to
the filter.  If not set, the user DN is passed into the filter. Defaults to Empty.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>unmapped_groups_as_roles</literal>
</term>
<listitem>
<simpara>
Takes a boolean variable. When this element is set to <literal>true</literal>, the names of any
unmapped LDAP groups are used as role names and assigned to the user. Defaults
to <literal>false</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>files.role_mapping</literal>
</term>
<listitem>
<simpara>
The <link linkend="security-files-location">location</link> for the <link linkend="ldap-role-mapping">YAML role mapping configuration file</link>. Defaults to
<literal>CONFIG_DIR/x-pack/role_mapping.yml</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>follow_referrals</literal>
</term>
<listitem>
<simpara>
Boolean value that specifies whether Securityshould follow referrals returned
by the LDAP server. Referrals are URLs returned by the server that are to be
used to continue the LDAP operation (e.g. search). Defaults to <literal>true</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>connect_timeout</literal>
</term>
<listitem>
<simpara>
The timeout period for establishing an LDAP connection.  An <literal>s</literal> at the end
indicates seconds, <literal>ms</literal> indicates milliseconds. Defaults to <literal>5s</literal> (5 seconds).
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>read_timeout</literal>
</term>
<listitem>
<simpara>
The timeout period for an LDAP operation.  An <literal>s</literal> at the end indicates s
econds, <literal>ms</literal> indicates milliseconds. Defaults to <literal>5s</literal> (5 seconds).
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>ssl.key</literal>
</term>
<listitem>
<simpara>
Path to a PEM encoded file containing the private key.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>ssl.key_passphrase</literal>
</term>
<listitem>
<simpara>
The passphrase that will be used to decrypt the private key. This value is
optional as the key may not be encrypted.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>ssl.certificate</literal>
</term>
<listitem>
<simpara>
Path to a PEM encoded file containing the certificate (or certificate chain)
that will be presented to clients when they connect.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>ssl.certificate_authorities</literal>
</term>
<listitem>
<simpara>
List of paths to PEM encoded certificate files that should be trusted.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>ssl.keystore.path</literal>
</term>
<listitem>
<simpara>
The path to the Java Keystore file that contains a private key and certificate.
<literal>ssl.key</literal> and <literal>ssl.keystore.path</literal> may not be used at the same time.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>ssl.keystore.password</literal>
</term>
<listitem>
<simpara>
The password to the keystore.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>ssl.keystore.key_password</literal>
</term>
<listitem>
<simpara>
The password for the key in the keystore. Defaults to the keystore password.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>ssl.truststore.path</literal>
</term>
<listitem>
<simpara>
The path to the Java Keystore file that contains the certificates to trust.
<literal>ssl.certificate_authorities</literal> and <literal>ssl.trustsore.path</literal> may not be used at the same time.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>ssl.truststore.password</literal>
</term>
<listitem>
<simpara>
The password to the truststore.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>ssl.verification_mode</literal>
</term>
<listitem>
<simpara>
Indicates the type of verification when using <literal>ldaps</literal> to protect against man
in the middle attacks and certificate forgery. Values are <literal>none</literal>, <literal>certificate</literal>,
and <literal>full</literal>. Defaults to the value of <literal>xpack.ssl.verification_mode</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>ssl.supported_protocols</literal>
</term>
<listitem>
<simpara>
Supported protocols with versions. Defaults to the value of
<literal>xpack.ssl.supported_protocols</literal>.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<simpara><literal>ssl.cipher_suites</literal>
Supported cipher suites can be found in Oracle&#8217;s <ulink url="http://docs.oracle.com/javase/8/docs/technotes/guides/security/SunProviders.html">
Java Cryptography Architecture documentation</ulink>. Defaults to the value of
<literal>xpack.ssl.cipher_suites</literal>.</simpara>
<variablelist>
<varlistentry>
<term>
<literal>cache.ttl</literal>
</term>
<listitem>
<simpara>
Specifies the time-to-live for cached user entries (a user and its credentials
are cached for this period of time). Use the standard Elasticsearch
<ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/common-options.html#time-units">time units</ulink>). Defaults to  <literal>20m</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>cache.max_users</literal>
</term>
<listitem>
<simpara>
Specifies the maximum number of user entries that the cache can contain.
Defaults to <literal>100000</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>cache.hash_algo</literal>
</term>
<listitem>
<simpara>
(Expert Setting) Specifies the hashing algorithm that is used for the
in-memory cached user credentials (see <link linkend="cache-hash-algo">Cache hash algorithms</link>
table for all possible values). Defaults to <literal>ssha256</literal>.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="ref-ad-settings" renderas="sect3">Active Directory Realm Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/settings/security-settings.asciidoc">Edit me</ulink></bridgehead>
<variablelist>
<varlistentry>
<term>
<literal>url</literal>
</term>
<listitem>
<simpara>
A URL in the format <literal>ldap[s]://&lt;server&gt;:&lt;port&gt;</literal>. Defaults to <literal>ldap://&lt;domain_name&gt;:389</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>load_balance.type</literal>
</term>
<listitem>
<simpara>
The behavior to use when there are multiple LDAP URLs defined. For supported
values see <link linkend="ad-load-balancing">LDAP load balancing and failover types</link>.
Defaults to  <literal>failover</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>load_balance.cache_ttl</literal>
</term>
<listitem>
<simpara>
When using <literal>dns_failover</literal> or <literal>dns_round_robin</literal> as the load balancing type,
this setting controls the amount of time to cache DNS lookups. Defaults
to <literal>1h</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>domain_name</literal>
</term>
<listitem>
<simpara>
The domain name of Active Directory. The cluster can derive the URL and
<literal>user_search_dn</literal> fields from values in this element if those fields are not
otherwise specified. Required.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>unmapped_groups_as_roles</literal>
</term>
<listitem>
<simpara>
Takes a boolean variable. When this element is set to <literal>true</literal>, the names of
any unmapped groups and the user&#8217;s relative distinguished name are used as
role names and assigned to the user. Defaults to <literal>false</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>files.role_mapping</literal>
</term>
<listitem>
<simpara>
The <link linkend="security-files-location">location</link> for the <link linkend="ad-role-mapping">YAML role mapping configuration file</link>. Defaults to  <literal>CONFIG_DIR/x-pack/role_mapping.yml</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>user_search.base_dn</literal>
</term>
<listitem>
<simpara>
The context to search for a user. Defaults to the root
of the Active Directory domain.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>user_search.scope</literal>
</term>
<listitem>
<simpara>
Specifies whether the user search should be <literal>sub_tree</literal>, <literal>one_level</literal> or <literal>base</literal>.
<literal>one_level</literal> only searches users directly contained within the <literal>base_dn</literal>.
<literal>sub_tree</literal> searches all objects contained under <literal>base_dn</literal>. <literal>base</literal>
specifies that the <literal>base_dn</literal> is a user object, and that it is the
only user considered. Defaults to <literal>sub_tree</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>user_search.filter</literal>
</term>
<listitem>
<simpara>
Specifies a filter to use to lookup a user given a username.  The default
filter looks up <literal>user</literal> objects with either <literal>sAMAccountName</literal> or
<literal>userPrincipalName</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>group_search.base_dn</literal>
</term>
<listitem>
<simpara>
The context to search for groups in which the user has membership.  Defaults
to the root of the  Active Directory domain.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>group_search.scope</literal>
</term>
<listitem>
<simpara>
Specifies whether the group search should be <literal>sub_tree</literal>, <literal>one_level</literal> or
<literal>base</literal>.  <literal>one_level</literal> searches for groups directly contained within the
<literal>base_dn</literal>. <literal>sub_tree</literal> searches all objects contained under <literal>base_dn</literal>.
<literal>base</literal> specifies that the <literal>base_dn</literal> is a group object, and that it is
the only group considered. Defaults to <literal>sub_tree</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>timeout.tcp_connect</literal>
</term>
<listitem>
<simpara>
The TCP connect timeout period for establishing an LDAP connection.
An <literal>s</literal> at the end indicates seconds, or <literal>ms</literal> indicates milliseconds.
Defaults to <literal>5s</literal> (5 seconds ).
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>timeout.tcp_read</literal>
</term>
<listitem>
<simpara>
The TCP read timeout period after establishing an LDAP connection.
An <literal>s</literal> at the end indicates seconds, or <literal>ms</literal> indicates milliseconds.
Defaults to <literal>5s</literal> (5 seconds ).
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>timeout.ldap_search</literal>
</term>
<listitem>
<simpara>
The LDAP Server enforced timeout period for an LDAP search.
An <literal>s</literal> at the end indicates seconds, or <literal>ms</literal> indicates milliseconds.
Defaults to <literal>5s</literal> (5 seconds ).
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>ssl.key</literal>
</term>
<listitem>
<simpara>
Path to the PEM encoded file containing the private key.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>ssl.key_passphrase</literal>
</term>
<listitem>
<simpara>
The passphrase that will be used to decrypt the private key. This value is
optional as the key may not be encrypted.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>ssl.certificate</literal>
</term>
<listitem>
<simpara>
Path to a PEM encoded file containing the certificate (or certificate chain)
that will be presented to clients when they connect.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>ssl.certificate_authorities</literal>
</term>
<listitem>
<simpara>
List of paths to PEM encoded certificate files that should be trusted.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>ssl.keystore.path</literal>
</term>
<listitem>
<simpara>
The path to the Java Keystore file that contains a private key and certificate.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>ssl.keystore.password</literal>
</term>
<listitem>
<simpara>
The password to the keystore.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>ssl.keystore.key_password</literal>
</term>
<listitem>
<simpara>
The password for the key in the keystore. Defaults to the keystore password.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>ssl.truststore.path</literal>
</term>
<listitem>
<simpara>
The path to the Java Keystore file that contains the certificates to trust.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>ssl.truststore.password</literal>
</term>
<listitem>
<simpara>
The password to the truststore.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>ssl.verification_mode</literal>
</term>
<listitem>
<simpara>
Indicates the type of verification when using <literal>ldaps</literal> to protect against man
in the middle attacks and certificate forgery. Values are <literal>none</literal>, <literal>certificate</literal>,
and <literal>full</literal>. Defaults to the value of <literal>xpack.ssl.verification_mode</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>ssl.supported_protocols</literal>
</term>
<listitem>
<simpara>
Supported protocols with versions. Defaults to the value of
<literal>xpack.ssl.supported_protocols</literal>.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<simpara><literal>ssl.cipher_suites</literal>
Supported cipher suites can be found in Oracle&#8217;s <ulink url="http://docs.oracle.com/javase/8/docs/technotes/guides/security/SunProviders.html">
Java Cryptography Architecture documentation</ulink>. Defaults to the value of
<literal>xpack.ssl.cipher_suites</literal>.</simpara>
<variablelist>
<varlistentry>
<term>
<literal>cache.ttl</literal>
</term>
<listitem>
<simpara>
Specifies the time-to-live for cached user entries (user
credentials are cached for this configured period of time). Use the
standard Elasticsearch <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/common-options.html#time-units">time units</ulink>).
Defaults to <literal>20m</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>cache.max_users</literal>
</term>
<listitem>
<simpara>
Specifies the maximum number of user entries that the cache can contain.
Defaults to <literal>100000</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>cache.hash_algo</literal>
</term>
<listitem>
<simpara>
(Expert Setting) Specifies the hashing algorithm that will be used for
the in-memory cached user credentials (see <link linkend="cache-hash-algo">Cache hash algorithms</link> table for all possible values). Defaults to <literal>ssha256</literal>.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="ref-pki-settings" renderas="sect3">PKI Realm Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/settings/security-settings.asciidoc">Edit me</ulink></bridgehead>
<variablelist>
<varlistentry>
<term>
<literal>username_pattern</literal>
</term>
<listitem>
<simpara>
The regular expression pattern used to extract the username from the
certificate DN. The first match group is the used as the username.
Defaults to <literal>CN=(.*?)(?:,\|$)</literal>
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>certificate_authorities</literal>
</term>
<listitem>
<simpara>
List of PEM certificate files that should be used to authenticate a
user&#8217;s certificate as trusted. Defaults to the trusted certificates configured for SSL.
This setting may not be used with <literal>truststore.path</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>truststore.path</literal>
</term>
<listitem>
<simpara>
The path of a truststore to use. Defaults to the trusted certificates configured for SSL.
This setting may not be used with <literal>certificate_authorities</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>truststore.password</literal>
</term>
<listitem>
<simpara>
The password for the truststore. Must be provided if <literal>truststore.path</literal> is set.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>truststore.algorithm</literal>
</term>
<listitem>
<simpara>
Algorithm for the trustsore. Defaults to <literal>SunX509</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>files.role_mapping</literal>
</term>
<listitem>
<simpara>
Specifies the <link linkend="security-files-location">location</link> for the
<link linkend="pki-role-mapping">YAML role  mapping configuration file</link>.
Defaults to <literal>CONFIG_DIR/x-pack/role_mapping.yml</literal>.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="ssl-tls-settings" renderas="sect2">Default TLS/SSL Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/settings/security-settings.asciidoc">Edit me</ulink></bridgehead>
<simpara>You can configure the following TLS/SSL settings in
<literal>elasticsearch.yml</literal>. For more information, see
<link linkend="ssl-tls">Encrypting Communications</link>. These settings will be used
for all of X-Pack unless they have been overridden by more specific
settings such as those for HTTP or Transport.</simpara>
<variablelist>
<varlistentry>
<term>
<literal>xpack.ssl.supported_protocols</literal>
</term>
<listitem>
<simpara>
Supported protocols with versions. Valid protocols: <literal>SSLv2Hello</literal>,
<literal>SSLv3</literal>, <literal>TLSv1</literal>, <literal>TLSv1.1</literal>, <literal>TLSv1.2</literal>. Defaults to <literal>TLSv1.2</literal>, <literal>TLSv1.1</literal>,
<literal>TLSv1</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.ssl.client_authentication</literal>
</term>
<listitem>
<simpara>
Controls the server&#8217;s behavior in regard to requesting a certificate
from client connections. Valid values are <literal>required</literal>, <literal>optional</literal>, and <literal>none</literal>.
<literal>required</literal> forces a client to present a certificate, while <literal>optional</literal>
requests a client certificate but the client is not required to present one.
Defaults to <literal>required</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.ssl.verification_mode</literal>
</term>
<listitem>
<simpara>
Controls the verification of certificates. Valid values are <literal>none</literal>,
<literal>certificate</literal>, and <literal>full</literal>. Defaults to <literal>full</literal>.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<simpara><literal>xpack.ssl.cipher_suites</literal>
Supported cipher suites can be found in Oracle&#8217;s <ulink url="http://docs.oracle.com/javase/8/docs/technotes/guides/security/SunProviders.html">
Java Cryptography Architecture documentation</ulink>. Defaults to <literal>TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256</literal>,
<literal>TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256</literal>, <literal>TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA</literal>, <literal>TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA</literal>,
<literal>TLS_RSA_WITH_AES_128_CBC_SHA256</literal>, <literal>TLS_RSA_WITH_AES_128_CBC_SHA</literal>.</simpara>
<bridgehead id="tls-ssl-key-settings" renderas="sect3">Default TLS/SSL Key and Trusted Certificate Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/settings/security-settings.asciidoc">Edit me</ulink></bridgehead>
<simpara>The following settings are used to specify a private key, certificate, and the
trusted certificates that should be used when communicating over an SSL/TLS connection.
If none of the settings below are specified, this will default to the <link linkend="ssl-tls-settings">X-Pack defaults</link>. If no trusted certificates are configured, the default certificates that are trusted by the JVM will be
trusted along with the certificate(s) from the <link linkend="tls-ssl-key-settings">key settings</link>. The key and certificate must be in place
for connections that require client authentication or when acting as a SSL enabled server.</simpara>
<bridgehead id="_pem_encoded_files" renderas="sect4">PEM Encoded Files<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/settings/security-settings.asciidoc">Edit me</ulink></bridgehead>
<simpara>When using PEM encoded files, use the following settings:</simpara>
<variablelist>
<varlistentry>
<term>
<literal>xpack.ssl.key</literal>
</term>
<listitem>
<simpara>
Path to the PEM encoded file containing the private key.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.ssl.key_passphrase</literal>
</term>
<listitem>
<simpara>
The passphrase that will be used to decrypt the private key. This value is
optional as the key may not be encrypted.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.ssl.certificate</literal>
</term>
<listitem>
<simpara>
Path to a PEM encoded file containing the certificate (or certificate chain)
that will be presented to clients when they connect.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.ssl.certificate_authorities</literal>
</term>
<listitem>
<simpara>
List of paths to the PEM encoded certificate files that should be trusted.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="_java_keystore_files" renderas="sect4">Java Keystore Files<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/settings/security-settings.asciidoc">Edit me</ulink></bridgehead>
<simpara>When using Java keystore files (JKS), which contain the private key, certificate
and certificates that should be trusted, use the following settings:</simpara>
<variablelist>
<varlistentry>
<term>
<literal>xpack.ssl.keystore.path</literal>
</term>
<listitem>
<simpara>
Path to the keystore that holds the private key and certificate.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.ssl.keystore.password</literal>
</term>
<listitem>
<simpara>
Password to the keystore.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.ssl.keystore.key_password</literal>
</term>
<listitem>
<simpara>
Password for the private key in the keystore. Defaults to the
same value as <literal>xpack.ssl.keystore.password</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.ssl.truststore.path</literal>
</term>
<listitem>
<simpara>
Path to the truststore file.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.ssl.truststore.password</literal>
</term>
<listitem>
<simpara>
Password to the truststore.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="http-tls-ssl-settings" renderas="sect2">HTTP TLS/SSL Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-ssl-settings.asciidoc">Edit me</ulink></bridgehead>
<simpara>You can configure the following TLS/SSL settings. If the settings are not configured,
the <link linkend="ssl-tls-settings">X-Pack defaults</link> will be used.</simpara>
<variablelist>
<varlistentry>
<term>
<literal>xpack.security.http.ssl.enabled</literal>
</term>
<listitem>
<simpara>
Used to enable or disable TLS/SSL. The default is <literal>false</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.security.http.ssl.supported_protocols</literal>
</term>
<listitem>
<simpara>
Supported protocols with versions. Valid protocols: <literal>SSLv2Hello</literal>,
<literal>SSLv3</literal>, <literal>TLSv1</literal>, <literal>TLSv1.1</literal>, <literal>TLSv1.2</literal>. Defaults to <literal>TLSv1.2</literal>, <literal>TLSv1.1</literal>,
<literal>TLSv1</literal>. Defaults to the value of <literal>xpack.ssl.supported_protocols</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.security.http.ssl.client_authentication</literal>
</term>
<listitem>
<simpara>
Controls the server&#8217;s behavior in regard to requesting a certificate
from client connections. Valid values are <literal>required</literal>, <literal>optional</literal>, and <literal>none</literal>.
<literal>required</literal> forces a client to present a certificate, while <literal>optional</literal>
requests a client certificate but the client is not required to present one.
Defaults to the value of <literal>xpack.ssl.client_authentication</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.security.http.ssl.cipher_suites</literal>
</term>
<listitem>
<simpara>
Supported cipher suites can be found in Oracle&#8217;s <ulink url="http://docs.oracle.com/javase/8/docs/technotes/guides/security/SunProviders.html">
Java Cryptography Architecture documentation</ulink>. Defaults to the value of
<literal>xpack.ssl.cipher_suites</literal>.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="_http_tls_ssl_key_and_trusted_certificate_settings" renderas="sect3">HTTP TLS/SSL Key and Trusted Certificate Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-ssl-settings.asciidoc">Edit me</ulink></bridgehead>
<simpara>The following settings are used to specify a private key, certificate, and the
trusted certificates that should be used when communicating over an SSL/TLS connection.
If none of the settings below are specified, this will default to the <link linkend="ssl-tls-settings">X-Pack defaults</link>.
A private key and certificate must be configured.
If none of the settings below are specified, the <link linkend="ssl-tls-settings">X-Pack defaults</link> will be used.</simpara>
<bridgehead id="_pem_encoded_files_2" renderas="sect4">PEM Encoded Files<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-ssl-settings.asciidoc">Edit me</ulink></bridgehead>
<simpara>When using PEM encoded files, use the following settings:</simpara>
<variablelist>
<varlistentry>
<term>
<literal>xpack.security.http.ssl.key</literal>
</term>
<listitem>
<simpara>
Path to a PEM encoded file containing the private key.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.security.http.ssl.key_passphrase</literal>
</term>
<listitem>
<simpara>
The passphrase that will be used to decrypt the private key. This value is
optional as the key may not be encrypted.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.security.http.ssl.certificate</literal>
</term>
<listitem>
<simpara>
Path to a PEM encoded file containing the certificate (or certificate chain)
that will be presented when requested.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.security.http.ssl.certificate_authorities</literal>
</term>
<listitem>
<simpara>
List of paths to the PEM encoded certificate files that should be trusted.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="_java_keystore_files_2" renderas="sect4">Java Keystore Files<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-ssl-settings.asciidoc">Edit me</ulink></bridgehead>
<simpara>When using Java keystore files (JKS), which contain the private key, certificate
and certificates that should be trusted, use the following settings:</simpara>
<variablelist>
<varlistentry>
<term>
<literal>xpack.security.http.ssl.keystore.path</literal>
</term>
<listitem>
<simpara>
Path to the keystore that holds the private key and certificate.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.security.http.ssl.keystore.password</literal>
</term>
<listitem>
<simpara>
Password to the keystore.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.security.http.ssl.keystore.key_password</literal>
</term>
<listitem>
<simpara>
Password for the private key in the keystore. Defaults to the
same value as <literal>{ssl-prefix}.ssl.keystore.password</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.security.http.ssl.truststore.path</literal>
</term>
<listitem>
<simpara>
Path to the truststore file.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.security.http.ssl.truststore.password</literal>
</term>
<listitem>
<simpara>
Password to the truststore.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="transport-tls-ssl-settings" renderas="sect2">Transport TLS/SSL Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-ssl-settings.asciidoc">Edit me</ulink></bridgehead>
<simpara>You can configure the following TLS/SSL settings. If the settings are not configured,
the <link linkend="ssl-tls-settings">X-Pack defaults</link> will be used.</simpara>
<variablelist>
<varlistentry>
<term>
<literal>xpack.security.transport.ssl.enabled</literal>
</term>
<listitem>
<simpara>
Used to enable or disable TLS/SSL. The default is <literal>false</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.security.transport.ssl.supported_protocols</literal>
</term>
<listitem>
<simpara>
Supported protocols with versions. Valid protocols: <literal>SSLv2Hello</literal>,
<literal>SSLv3</literal>, <literal>TLSv1</literal>, <literal>TLSv1.1</literal>, <literal>TLSv1.2</literal>. Defaults to <literal>TLSv1.2</literal>, <literal>TLSv1.1</literal>,
<literal>TLSv1</literal>. Defaults to the value of <literal>xpack.ssl.supported_protocols</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.security.transport.ssl.client_authentication</literal>
</term>
<listitem>
<simpara>
Controls the server&#8217;s behavior in regard to requesting a certificate
from client connections. Valid values are <literal>required</literal>, <literal>optional</literal>, and <literal>none</literal>.
<literal>required</literal> forces a client to present a certificate, while <literal>optional</literal>
requests a client certificate but the client is not required to present one.
Defaults to the value of <literal>xpack.ssl.client_authentication</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.security.transport.ssl.verification_mode</literal>
</term>
<listitem>
<simpara>
Controls the verification of certificates. Valid values are <literal>none</literal>,
<literal>certificate</literal>, and <literal>full</literal>. Defaults to the value of <literal>xpack.ssl.verification_mode</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.security.transport.ssl.cipher_suites</literal>
</term>
<listitem>
<simpara>
Supported cipher suites can be found in Oracle&#8217;s <ulink url="http://docs.oracle.com/javase/8/docs/technotes/guides/security/SunProviders.html">
Java Cryptography Architecture documentation</ulink>. Defaults to the value of
<literal>xpack.ssl.cipher_suites</literal>.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="_transport_tls_ssl_key_and_trusted_certificate_settings" renderas="sect3">Transport TLS/SSL Key and Trusted Certificate Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-ssl-settings.asciidoc">Edit me</ulink></bridgehead>
<simpara>The following settings are used to specify a private key, certificate, and the
trusted certificates that should be used when communicating over an SSL/TLS connection.
If none of the settings below are specified, this will default to the <link linkend="ssl-tls-settings">X-Pack defaults</link>.
A private key and certificate must be configured.
If none of the settings below are specified, the <link linkend="ssl-tls-settings">X-Pack defaults</link> will be used.</simpara>
<bridgehead id="_pem_encoded_files_3" renderas="sect4">PEM Encoded Files<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-ssl-settings.asciidoc">Edit me</ulink></bridgehead>
<simpara>When using PEM encoded files, use the following settings:</simpara>
<variablelist>
<varlistentry>
<term>
<literal>xpack.security.transport.ssl.key</literal>
</term>
<listitem>
<simpara>
Path to a PEM encoded file containing the private key.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.security.transport.ssl.key_passphrase</literal>
</term>
<listitem>
<simpara>
The passphrase that will be used to decrypt the private key. This value is
optional as the key may not be encrypted.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.security.transport.ssl.certificate</literal>
</term>
<listitem>
<simpara>
Path to a PEM encoded file containing the certificate (or certificate chain)
that will be presented when requested.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.security.transport.ssl.certificate_authorities</literal>
</term>
<listitem>
<simpara>
List of paths to the PEM encoded certificate files that should be trusted.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="_java_keystore_files_3" renderas="sect4">Java Keystore Files<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-ssl-settings.asciidoc">Edit me</ulink></bridgehead>
<simpara>When using Java keystore files (JKS), which contain the private key, certificate
and certificates that should be trusted, use the following settings:</simpara>
<variablelist>
<varlistentry>
<term>
<literal>xpack.security.transport.ssl.keystore.path</literal>
</term>
<listitem>
<simpara>
Path to the keystore that holds the private key and certificate.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.security.transport.ssl.keystore.password</literal>
</term>
<listitem>
<simpara>
Password to the keystore.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.security.transport.ssl.keystore.key_password</literal>
</term>
<listitem>
<simpara>
Password for the private key in the keystore. Defaults to the
same value as <literal>{ssl-prefix}.ssl.keystore.password</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.security.transport.ssl.truststore.path</literal>
</term>
<listitem>
<simpara>
Path to the truststore file.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.security.transport.ssl.truststore.password</literal>
</term>
<listitem>
<simpara>
Password to the truststore.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="ssl-tls-profile-settings" renderas="sect3">Transport Profile TLS/SSL Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/settings/security-settings.asciidoc">Edit me</ulink></bridgehead>
<simpara>The same settings that are available for the <link linkend="transport-tls-ssl-settings">default transport</link>
are also available for each transport profile. By default, the settings for a
transport profile will be the same as the default transport unless they
are specified.</simpara>
<simpara>As an example, lets look at the enabled setting. For the default transport
this is <literal>xpack.security.transport.ssl.enabled</literal>. In order to use this setting in a
transport profile, use the prefix <literal>transport.profiles.$PROFILE.xpack.security.</literal> and
append the portion of the setting after <literal>xpack.security.transport.</literal>. For the enabled
setting, this would be <literal>transport.profiles.$PROFILE.xpack.security.ssl.enabled</literal>.</simpara>
<bridgehead id="ip-filtering-settings" renderas="sect2">IP Filtering Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/settings/security-settings.asciidoc">Edit me</ulink></bridgehead>
<simpara>You can configure the following settings for <link linkend="ip-filtering">IP filtering</link>.</simpara>
<variablelist>
<varlistentry>
<term>
<literal>xpack.security.transport.filter.allow</literal>
</term>
<listitem>
<simpara>
List of IP addresses to allow.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.security.transport.filter.deny</literal>
</term>
<listitem>
<simpara>
List of IP addresses to deny.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.security.http.filter.allow</literal>
</term>
<listitem>
<simpara>
List of IP addresses to allow just for HTTP.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.security.http.filter.deny</literal>
</term>
<listitem>
<simpara>
List of IP addresses to deny just for HTTP.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>transport.profiles.$PROFILE.xpack.security.filter.allow</literal>
</term>
<listitem>
<simpara>
List of IP addresses to allow for this profile.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>transport.profiles.$PROFILE.xpack.security.filter.deny</literal>
</term>
<listitem>
<simpara>
List of IP addresses to deny for this profile.
</simpara>
</listitem>
</varlistentry>
</variablelist>
</chapter>
<chapter id="monitoring-settings">
<title>Monitoring Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/settings/monitoring-settings.asciidoc">Edit me</ulink></title>
<simpara>You configure <link linkend="monitoring-collection-settings"><literal>xpack.monitoring.collection</literal></link>
settings in <literal>elasticsearch.yml</literal> to control how data is collected from your
Elasticsearch nodes. You can adjust how monitoring data is displayed in the
Monitoring UI by configuring <link linkend="monitoring-ui-settings"><literal>xpack.monitoring</literal></link>
settings in <literal>kibana.yml</literal>.</simpara>
<simpara>For more information, see <link linkend="configuring-monitoring">Configuring Monitoring</link>.</simpara>
<bridgehead id="general-monitoring-settings" renderas="sect2">General Monitoring Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/settings/monitoring-settings.asciidoc">Edit me</ulink></bridgehead>
<variablelist>
<varlistentry>
<term>
<literal>xpack.monitoring.enabled</literal>
</term>
<listitem>
<simpara>
Set to <literal>false</literal> to disable X-Pack monitoring.
Configure in both <literal>elasticsearch.yml</literal> and <literal>kibana.yml</literal>.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="monitoring-collection-settings" renderas="sect2">Monitoring Collection Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/settings/monitoring-settings.asciidoc">Edit me</ulink></bridgehead>
<variablelist>
<varlistentry>
<term>
<literal>xpack.monitoring.collection.cluster.state.timeout</literal>
</term>
<listitem>
<simpara>
Sets the timeout for collecting the cluster state. Defaults to <literal>10m</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.monitoring.collection.cluster.stats.timeout</literal>
</term>
<listitem>
<simpara>
Sets the timeout for collecting the cluster statistics. Defaults to <literal>10m</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.monitoring.collection.indices</literal>
</term>
<listitem>
<simpara>
Controls which indices Monitoring collects data from. Defaults to all indices. Specify the index names
as a comma-separated list, for example <literal>test1,test2,test3</literal>. Names can include wildcards, for
example <literal>test*</literal>. You can explicitly include or exclude indices by prepending
<literal>+</literal> to include the index, or <literal>-</literal> to exclude the index. For example, to include all indices that
start with <literal>test</literal> except <literal>test3</literal>, you could specify <literal>+test*,-test3</literal>.
</simpara>
<simpara>You can update this setting through the Cluster Update Settings API.</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.monitoring.collection.index.stats.timeout</literal>
</term>
<listitem>
<simpara>
Sets the timeout for collecting index statistics. Defaults to <literal>10m</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.monitoring.collection.indices.stats.timeout</literal>
</term>
<listitem>
<simpara>
Sets the timeout for collecting total indices statistics. Defaults to <literal>10m</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.monitoring.exporters</literal> 
</term>
<listitem>
<simpara>
Configures where the agent stores monitoring data. By default, the agent uses a local exporter that
indexes monitoring data on the cluster where it is installed. Use an HTTP exporter to send data to
a separate monitoring cluster. For more information, see <link linkend="monitoring-cluster">Setting up a Separate Monitoring Cluster</link>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.monitoring.collection.index.recovery.active_only</literal>
</term>
<listitem>
<simpara>
Controls whether or not all recoveries are collected. Set to <literal>true</literal> to
collect only active recoveries. Defaults to <literal>false</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.monitoring.collection.index.recovery.timeout</literal>
</term>
<listitem>
<simpara>
Sets the timeout for collecting the recovery information. Defaults to <literal>10m</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.monitoring.collection.interval</literal>
</term>
<listitem>
<simpara>
Controls how often data samples are collected. Defaults to <literal>10s</literal>. If you
modify the collection interval, set the <literal>xpack.monitoring.min_interval_seconds</literal>
option in <literal>kibana.yml</literal> to the same value. Set to <literal>-1</literal> to temporarily disable
data collection. You can update this setting through the Cluster Update
Settings API.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.monitoring.history.duration</literal>
</term>
<listitem>
<simpara>
Sets the retention duration beyond which the indices created by a Monitoring exporter will
be automatically deleted. Defaults to <literal>7d</literal> (7 days).
</simpara>
<simpara>This setting has a minimum value of <literal>1d</literal> (1 day) to ensure that something is being monitored,
and it cannot be disabled.</simpara>
<important><simpara>This setting currently only impacts <literal>local</literal>-type exporters. Indices created using
the <literal>http</literal> exporter will not be deleted automatically.</simpara></important>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="monitoring-ui-settings" renderas="sect2">Monitoring UI Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/settings/monitoring-settings.asciidoc">Edit me</ulink></bridgehead>
<simpara>You can set the following <literal>xpack.monitoring</literal> settings in <literal>kibana.yml</literal> to adjust
how the Monitoring UI displays monitoring data. However, the defaults work best
in most circumstances. For more information about configuring Kibana, see
<ulink url="http://www.elastic.co/guide/en/kibana/5.0/settings.html">Setting Kibana
Server Properties</ulink> in the Kibana User Guide.</simpara>
<variablelist>
<varlistentry>
<term>
<literal>xpack.monitoring.max_bucket_size</literal>
</term>
<listitem>
<simpara>
The number of term buckets to return out of the overall terms list when
performing terms aggregations to retrieve index and node metrics. For more
information about the <literal>size</literal> parameter, see <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/search-aggregations-bucket-terms-aggregation.html#_size">
Terms Aggregation</ulink> in the Elasticsearch Reference. Defaults to 10000.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.monitoring.min_interval_seconds</literal>
</term>
<listitem>
<simpara>
The minimum number of seconds that a time bucket in a chart can represent.
Defaults to 10. If you modify the <literal>xpack.monitoring.collection.interval</literal>
in <literal>elasticsearch.yml</literal>, set this option to the same value.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.monitoring.node_resolver</literal>
</term>
<listitem>
<simpara>
The node resolver controls how nodes are considered unique. This can be set to either <literal>uuid</literal>,
<literal>transport_address</literal>, or <literal>name</literal>. <literal>uuid</literal> controls uniqueness based on the node&#8217;s persistent ID.
<literal>transport_address</literal> controls uniqueness based on the node&#8217;s published
hostname/IP and port. <literal>name</literal> controls uniqueness based on the node&#8217;s <literal>node.name</literal> setting. Defaults to
<literal>uuid</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.monitoring.report_stats</literal>
</term>
<listitem>
<simpara>
Whether or not to send cluster statistics to Elastic. Reporting your cluster statistics
helps us improve your user experience. Your data is never shared with anyone. Set to
<literal>false</literal> to disable statistics reporting from any browser connected to the Kibana instance.
You can also opt-out on a per-browser basis through the Monitoring user interface. Defaults to <literal>true</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.monitoring.kibana.collection.enabled</literal>
</term>
<listitem>
<simpara>
Whether or not to enable data collection from the Kibana NodeJS server for
Kibana Dashboards to be featured in the Monitoring UI. Defaults to <literal>true</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.monitoring.kibana.collection.interval</literal>
</term>
<listitem>
<simpara>
Number of milliseconds to wait in between data sampling for Kibana&#8217;s NodeJS
server for the metrics that are displayed in the Kibana dashboards. Defaults to
<literal>10000</literal> (10 seconds).
</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="local-exporter-settings" renderas="sect3">Local Exporter Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/settings/monitoring-settings.asciidoc">Edit me</ulink></bridgehead>
<simpara>The <literal>local</literal> exporter is the default exporter used by Monitoring. As the name is
meant to imply, it exports data to the <emphasis>local</emphasis> cluster, which means that there
is not much needed to be configured.</simpara>
<simpara>If you do not supply <emphasis>any</emphasis> exporters, then Monitoring will automatically create
one for you. If any exporter is provided, then no default is added.</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.monitoring.exporters.my_local:
  type: local</programlisting>
<variablelist>
<varlistentry>
<term>
<literal>type</literal>
</term>
<listitem>
<simpara>
The value for a Local exporter must always be <literal>local</literal> and it is required.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>use_ingest</literal>
</term>
<listitem>
<simpara>
Whether to supply a placeholder pipeline to the cluster and a pipeline processor with
every bulk request. The default value is <literal>true</literal>. If disabled, then it means that it will not
use pipelines, which means that a future release cannot automatically upgrade bulk requests
to future-proof them.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="http-exporter-settings" renderas="sect3">HTTP Exporter Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/settings/monitoring-settings.asciidoc">Edit me</ulink></bridgehead>
<simpara>The following lists settings that can be supplied with the <literal>http</literal> exporter.
All settings are shown as what follows the name you select for your exporter:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.monitoring.exporters.my_remote:
  type: http
  host: ["host:port", ...]</programlisting>
<variablelist>
<varlistentry>
<term>
<literal>type</literal>
</term>
<listitem>
<simpara>
The value for an HTTP exporter must always be <literal>http</literal> and it is required.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>host</literal>
</term>
<listitem>
<simpara>
Host supports multiple formats, both as an array or as a single value. Supported formats include
<literal>hostname</literal>, <literal>hostname:port</literal>, <literal>http://hostname</literal> <literal>http://hostname:port</literal>, <literal>https://hostname</literal>, and
<literal>https://hostname:port</literal>. Hosts cannot be assumed. The default scheme is always <literal>http</literal> and the default
port is always <literal>9200</literal> if not supplied as part of the <literal>host</literal> string.
</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.monitoring.exporters:
  example1:
    type: http
    host: "10.1.2.3"
  example2:
    type: http
    host: ["http://10.1.2.4"]
  example3:
    type: http
    host: ["10.1.2.5", "10.1.2.6"]
  example4:
    type: http
    host: ["https://10.1.2.3:9200"]</programlisting>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>auth.username</literal>
</term>
<listitem>
<simpara>
The username is required if a <literal>auth.password</literal> is supplied.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>auth.password</literal>
</term>
<listitem>
<simpara>
The password for the <literal>auth.username</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>connection.timeout</literal>
</term>
<listitem>
<simpara>
The amount of time that the HTTP connection is supposed to wait for a socket to open for the
request. The default value is <literal>6s</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>connection.read_timeout</literal>
</term>
<listitem>
<simpara>
The amount of time that the HTTP connection is supposed to wait for a socket to
send back a response. The default value is <literal>10 * connection.timeout</literal> (<literal>60s</literal> if neither are set).
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>ssl</literal>
</term>
<listitem>
<simpara>
Each HTTP exporter can define its own TLS / SSL settings or inherit them. See the
<link linkend="ssl-monitoring-settings">TLS / SSL section below</link>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>proxy.base_path</literal>
</term>
<listitem>
<simpara>
The base path to prefix any outgoing request, such as <literal>/base/path</literal> (e.g., bulk requests would
then be sent as <literal>/base/path/_bulk</literal>). There is no default value.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>headers</literal>
</term>
<listitem>
<simpara>
Optional headers that are added to every request, which can assist with routing requests through
proxies.
</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.monitoring.exporters.my_remote:
  headers:
    X-My-Array: [abc, def, xyz]
    X-My-Header: abc123</programlisting>
<simpara>Array-based headers are sent <literal>n</literal> times where <literal>n</literal> is the size of the array. <literal>Content-Type</literal>
and <literal>Content-Length</literal> cannot be set. Any headers created by the Monitoring agent will override
anything defined here.</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>index.name.time_format</literal>
</term>
<listitem>
<simpara>
A mechanism for changing the default date suffix for the, by default, daily Monitoring indices.
The default value is <literal>YYYY.MM.DD</literal>, which is why the indices are created daily.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>use_ingest</literal>
</term>
<listitem>
<simpara>
Whether to supply a placeholder pipeline to the monitoring cluster and a pipeline processor with
every bulk request. The default value is <literal>true</literal>. If disabled, then it means that it will not
use pipelines, which means that a future release cannot automatically upgrade bulk requests
to future-proof them.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="ssl-monitoring-settings" renderas="sect2">X-Pack monitoring TLS/SSL Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-ssl-settings.asciidoc">Edit me</ulink></bridgehead>
<simpara>You can configure the following TLS/SSL settings. If the settings are not configured,
the <link linkend="ssl-tls-settings">X-Pack defaults</link> will be used.</simpara>
<variablelist>
<varlistentry>
<term>
<literal>xpack.monitoring.exporters.$NAME.ssl.supported_protocols</literal>
</term>
<listitem>
<simpara>
Supported protocols with versions. Valid protocols: <literal>SSLv2Hello</literal>,
<literal>SSLv3</literal>, <literal>TLSv1</literal>, <literal>TLSv1.1</literal>, <literal>TLSv1.2</literal>. Defaults to <literal>TLSv1.2</literal>, <literal>TLSv1.1</literal>,
<literal>TLSv1</literal>. Defaults to the value of <literal>xpack.ssl.supported_protocols</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.monitoring.exporters.$NAME.ssl.verification_mode</literal>
</term>
<listitem>
<simpara>
Controls the verification of certificates. Valid values are <literal>none</literal>,
<literal>certificate</literal>, and <literal>full</literal>. Defaults to the value of <literal>xpack.ssl.verification_mode</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.monitoring.exporters.$NAME.ssl.cipher_suites</literal>
</term>
<listitem>
<simpara>
Supported cipher suites can be found in Oracle&#8217;s <ulink url="http://docs.oracle.com/javase/8/docs/technotes/guides/security/SunProviders.html">
Java Cryptography Architecture documentation</ulink>. Defaults to the value of
<literal>xpack.ssl.cipher_suites</literal>.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="_x_pack_monitoring_tls_ssl_key_and_trusted_certificate_settings" renderas="sect3">X-Pack monitoring TLS/SSL Key and Trusted Certificate Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-ssl-settings.asciidoc">Edit me</ulink></bridgehead>
<simpara>The following settings are used to specify a private key, certificate, and the
trusted certificates that should be used when communicating over an SSL/TLS connection.
If none of the settings below are specified, this will default to the <link linkend="ssl-tls-settings">X-Pack defaults</link>.
A private key and certificate are optional and would be used if the server requires client authentication for PKI
authentication.
If none of the settings below are specified, the <link linkend="ssl-tls-settings">X-Pack defaults</link> will be used.</simpara>
<bridgehead id="_pem_encoded_files_4" renderas="sect4">PEM Encoded Files<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-ssl-settings.asciidoc">Edit me</ulink></bridgehead>
<simpara>When using PEM encoded files, use the following settings:</simpara>
<variablelist>
<varlistentry>
<term>
<literal>xpack.monitoring.exporters.$NAME.ssl.key</literal>
</term>
<listitem>
<simpara>
Path to a PEM encoded file containing the private key.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.monitoring.exporters.$NAME.ssl.key_passphrase</literal>
</term>
<listitem>
<simpara>
The passphrase that will be used to decrypt the private key. This value is
optional as the key may not be encrypted.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.monitoring.exporters.$NAME.ssl.certificate</literal>
</term>
<listitem>
<simpara>
Path to a PEM encoded file containing the certificate (or certificate chain)
that will be presented when requested.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.monitoring.exporters.$NAME.ssl.certificate_authorities</literal>
</term>
<listitem>
<simpara>
List of paths to the PEM encoded certificate files that should be trusted.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="_java_keystore_files_4" renderas="sect4">Java Keystore Files<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-ssl-settings.asciidoc">Edit me</ulink></bridgehead>
<simpara>When using Java keystore files (JKS), which contain the private key, certificate
and certificates that should be trusted, use the following settings:</simpara>
<variablelist>
<varlistentry>
<term>
<literal>xpack.monitoring.exporters.$NAME.ssl.keystore.path</literal>
</term>
<listitem>
<simpara>
Path to the keystore that holds the private key and certificate.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.monitoring.exporters.$NAME.ssl.keystore.password</literal>
</term>
<listitem>
<simpara>
Password to the keystore.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.monitoring.exporters.$NAME.ssl.keystore.key_password</literal>
</term>
<listitem>
<simpara>
Password for the private key in the keystore. Defaults to the
same value as <literal>{ssl-prefix}.ssl.keystore.password</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.monitoring.exporters.$NAME.ssl.truststore.path</literal>
</term>
<listitem>
<simpara>
Path to the truststore file.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.monitoring.exporters.$NAME.ssl.truststore.password</literal>
</term>
<listitem>
<simpara>
Password to the truststore.
</simpara>
</listitem>
</varlistentry>
</variablelist>
</chapter>
<chapter id="graph-settings">
<title>Graph Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/settings/graph-settings.asciidoc">Edit me</ulink></title>
<simpara>You do not need to configure any settings to use X-Pack graph.</simpara>
<bridgehead id="general-graph-settings" renderas="sect2">General Graph Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/settings/graph-settings.asciidoc">Edit me</ulink></bridgehead>
<variablelist>
<varlistentry>
<term>
<literal>xpack.graph.enabled</literal>
</term>
<listitem>
<simpara>
Set to <literal>false</literal> to disable X-Pack graph.
</simpara>
</listitem>
</varlistentry>
</variablelist>
</chapter>
<chapter id="notification-settings">
<title>Watcher Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/settings/notification-settings.asciidoc">Edit me</ulink></title>
<simpara>You configure <literal>xpack.notification</literal> settings in <literal>elasticsearch.yml</literal> to
send set up Watcher and send notifications via <link linkend="email-notification-settings">email</link>, <link linkend="hipchat-notification-settings">HipChat</link>, <link linkend="slack-notification-settings">Slack</link>, and <link linkend="pagerduty-notification-settings">PagerDuty</link>.</simpara>
<bridgehead id="general-notification-settings" renderas="sect2">General Watcher Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/settings/notification-settings.asciidoc">Edit me</ulink></bridgehead>
<variablelist>
<varlistentry>
<term>
<literal>xpack.watcher.enabled</literal>
</term>
<listitem>
<simpara>
Set to <literal>false</literal> to disable Watcher.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.http.proxy.host</literal>
</term>
<listitem>
<simpara>
Specifies the address of the proxy server to use to connect to HTTP services.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.http.proxy.port</literal>
</term>
<listitem>
<simpara>
Specifies the port number to use to connect to the proxy server.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="ssl-notification-settings" renderas="sect2">Watcher TLS/SSL Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-ssl-settings.asciidoc">Edit me</ulink></bridgehead>
<simpara>You can configure the following TLS/SSL settings. If the settings are not configured,
the <link linkend="ssl-tls-settings">X-Pack defaults</link> will be used.</simpara>
<variablelist>
<varlistentry>
<term>
<literal>xpack.http.ssl.supported_protocols</literal>
</term>
<listitem>
<simpara>
Supported protocols with versions. Valid protocols: <literal>SSLv2Hello</literal>,
<literal>SSLv3</literal>, <literal>TLSv1</literal>, <literal>TLSv1.1</literal>, <literal>TLSv1.2</literal>. Defaults to <literal>TLSv1.2</literal>, <literal>TLSv1.1</literal>,
<literal>TLSv1</literal>. Defaults to the value of <literal>xpack.ssl.supported_protocols</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.http.ssl.verification_mode</literal>
</term>
<listitem>
<simpara>
Controls the verification of certificates. Valid values are <literal>none</literal>,
<literal>certificate</literal>, and <literal>full</literal>. Defaults to the value of <literal>xpack.ssl.verification_mode</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.http.ssl.cipher_suites</literal>
</term>
<listitem>
<simpara>
Supported cipher suites can be found in Oracle&#8217;s <ulink url="http://docs.oracle.com/javase/8/docs/technotes/guides/security/SunProviders.html">
Java Cryptography Architecture documentation</ulink>. Defaults to the value of
<literal>xpack.ssl.cipher_suites</literal>.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="_watcher_tls_ssl_key_and_trusted_certificate_settings" renderas="sect3">Watcher TLS/SSL Key and Trusted Certificate Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-ssl-settings.asciidoc">Edit me</ulink></bridgehead>
<simpara>The following settings are used to specify a private key, certificate, and the
trusted certificates that should be used when communicating over an SSL/TLS connection.
If none of the settings below are specified, this will default to the <link linkend="ssl-tls-settings">X-Pack defaults</link>.
A private key and certificate are optional and would be used if the server requires client authentication for PKI
authentication.
If none of the settings below are specified, the <link linkend="ssl-tls-settings">X-Pack defaults</link> will be used.</simpara>
<bridgehead id="_pem_encoded_files_5" renderas="sect4">PEM Encoded Files<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-ssl-settings.asciidoc">Edit me</ulink></bridgehead>
<simpara>When using PEM encoded files, use the following settings:</simpara>
<variablelist>
<varlistentry>
<term>
<literal>xpack.http.ssl.key</literal>
</term>
<listitem>
<simpara>
Path to a PEM encoded file containing the private key.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.http.ssl.key_passphrase</literal>
</term>
<listitem>
<simpara>
The passphrase that will be used to decrypt the private key. This value is
optional as the key may not be encrypted.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.http.ssl.certificate</literal>
</term>
<listitem>
<simpara>
Path to a PEM encoded file containing the certificate (or certificate chain)
that will be presented when requested.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.http.ssl.certificate_authorities</literal>
</term>
<listitem>
<simpara>
List of paths to the PEM encoded certificate files that should be trusted.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="_java_keystore_files_5" renderas="sect4">Java Keystore Files<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-ssl-settings.asciidoc">Edit me</ulink></bridgehead>
<simpara>When using Java keystore files (JKS), which contain the private key, certificate
and certificates that should be trusted, use the following settings:</simpara>
<variablelist>
<varlistentry>
<term>
<literal>xpack.http.ssl.keystore.path</literal>
</term>
<listitem>
<simpara>
Path to the keystore that holds the private key and certificate.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.http.ssl.keystore.password</literal>
</term>
<listitem>
<simpara>
Password to the keystore.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.http.ssl.keystore.key_password</literal>
</term>
<listitem>
<simpara>
Password for the private key in the keystore. Defaults to the
same value as <literal>{ssl-prefix}.ssl.keystore.password</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.http.ssl.truststore.path</literal>
</term>
<listitem>
<simpara>
Path to the truststore file.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.http.ssl.truststore.password</literal>
</term>
<listitem>
<simpara>
Password to the truststore.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="email-notification-settings" renderas="sect2">Email Notification Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/settings/notification-settings.asciidoc">Edit me</ulink></bridgehead>
<simpara>You can configure the following email notification settings in
<literal>elasticsearch.yml</literal>. For more information about sending notifications
via email, see <link linkend="configuring-email">Configuring Email</link>.</simpara>
<variablelist>
<varlistentry>
<term>
<literal>xpack.notification.email.account</literal>
</term>
<listitem>
<simpara>
Specifies account information for sending notifications via email. You
can specify the following email account attributes:
</simpara>
<variablelist id="email-account-attributes">
<varlistentry>
<term>
<literal>profile</literal>
</term>
<listitem>
<simpara>
  The <link linkend="email-profile">profile</link> to use to build the MIME messages
  that are sent from the account. Valid values: <literal>standard</literal>, <literal>gmail</literal> and
  <literal>outlook</literal>. Defaults to <literal>standard</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>email_defaults.*</literal>
</term>
<listitem>
<simpara>
  An optional set of email attributes to use as defaults
  for the emails sent from the account. See <link linkend="email-action-attributes">Email Action   Attributes</link> for the supported attributes.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>smtp.auth</literal>
</term>
<listitem>
<simpara>
  Set to <literal>true</literal> to attempt to authenticate the user using the
  AUTH command. Defaults to <literal>false</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>smtp.host</literal>
</term>
<listitem>
<simpara>
  The SMTP server to connect to. Required.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>smtp.port</literal>
</term>
<listitem>
<simpara>
  The SMTP server port to connect to. Defaults to 25.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>smtp.user</literal>
</term>
<listitem>
<simpara>
  The user name for SMTP. Required.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>smtp.password</literal>
</term>
<listitem>
<simpara>
  The password for the specified SMTP user.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>smtp.starttls.enable</literal>
</term>
<listitem>
<simpara>
  Set to <literal>true</literal> to enable the use of the <literal>STARTTLS</literal>
  command (if supported by the server) to switch the connection to a
  TLS-protected connection before issuing any login commands. Note that
  an appropriate trust store must configured so that the client will
  trust the server&#8217;s certificate. Defaults to <literal>false</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>smtp.*</literal>
</term>
<listitem>
<simpara>
  SMTP attributes that enable fine control over the SMTP
  protocol when sending messages. See
  <ulink url="https://javamail.java.net/nonav/docs/api/com/sun/mail/smtp/package-summary.html">com.sun.mail.smtp</ulink>
  for the full list of SMTP properties you can set. Note that all timeouts
  (<literal>writetimeout</literal>, <literal>connection_timeout</literal> and <literal>timeout</literal>) default to 2 minutes.
</simpara>
</listitem>
</varlistentry>
</variablelist>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.notification.email.html.sanitization.allow</literal>
</term>
<listitem>
<simpara>
Specifies the HTML elements that are allowed in email notifications. For
more information, see <link linkend="email-html-sanitization">Configuring HTML Sanitization Options</link>. You can specify individual HTML elements
and the following HTML feature groups:
</simpara>
<variablelist id="html-feature-groups">
<varlistentry>
<term>
<literal>_tables</literal>
</term>
<listitem>
<simpara>
  All table related elements: <literal>&lt;table&gt;</literal>, <literal>&lt;th&gt;</literal>, <literal>&lt;tr&gt;</literal>
                      and <literal>&lt;td&gt;</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>_blocks</literal>
</term>
<listitem>
<simpara>
  The following block elements: <literal>&lt;p&gt;</literal>, <literal>&lt;div&gt;</literal>, <literal>&lt;h1&gt;</literal>,
                      <literal>&lt;h2&gt;</literal>, <literal>&lt;h3&gt;</literal>, <literal>&lt;h4&gt;</literal>, <literal>&lt;h5&gt;</literal>, <literal>&lt;h6&gt;</literal>, <literal>&lt;ul&gt;</literal>, <literal>&lt;ol&gt;</literal>,
                      <literal>&lt;li&gt;</literal>, and <literal>&lt;blockquote&gt;</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>_formatting</literal>
</term>
<listitem>
<simpara>
  The following inline formatting elements: <literal>&lt;b&gt;</literal>, <literal>&lt;i&gt;</literal>,
                      <literal>&lt;s&gt;</literal>, <literal>&lt;u&gt;</literal>, <literal>&lt;o&gt;</literal>, <literal>&lt;sup&gt;</literal>, <literal>&lt;sub&gt;</literal>, <literal>&lt;ins&gt;</literal>, <literal>&lt;del&gt;</literal>,
                      <literal>&lt;strong&gt;</literal>, <literal>&lt;strike&gt;</literal>, <literal>&lt;tt&gt;</literal>, <literal>&lt;code&gt;</literal>, <literal>&lt;big&gt;</literal>,
                      <literal>&lt;small&gt;</literal>, <literal>&lt;br&gt;</literal>, <literal>&lt;span&gt;</literal>, and <literal>&lt;em&gt;</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>_links</literal>
</term>
<listitem>
<simpara>
  The <literal>&lt;a&gt;</literal> element with an <literal>href</literal> attribute that points
                      to a URL using the following protocols: <literal>http</literal>, <literal>https</literal>
                      and <literal>mailto</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>_styles</literal>
</term>
<listitem>
<simpara>
  The <literal>style</literal> attribute on all elements. Note that CSS
                      attributes are also sanitized to prevent XSS attacks.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>img</literal>
</term>
<term>
<literal>img:all</literal>
</term>
<listitem>
<simpara>
  All images (external and embedded).
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>img:embedded</literal>
</term>
<listitem>
<simpara>
  Only embedded images. Embedded images can only use the
                    <literal>cid:</literal> URL protocol in their <literal>src</literal> attribute.
</simpara>
</listitem>
</varlistentry>
</variablelist>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.notification.email.html.sanitization.disallow</literal>
</term>
<listitem>
<simpara>
Specifies the HTML elements that are NOT allowed in email notifications.
You can specify individual HTML elements and <link linkend="html-feature-groups">HTML feature groups</link>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.notification.email.html.sanitization.enabled</literal> 
</term>
<listitem>
<simpara>
Set to <literal>false</literal> to completely disable HTML sanitation. Not recommended.
Defaults to <literal>true</literal>.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="hipchat-notification-settings" renderas="sect2">HipChat Notification Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/settings/notification-settings.asciidoc">Edit me</ulink></bridgehead>
<simpara>You can configure the following HipChat notification settings in
<literal>elasticsearch.yml</literal>. For more information about sending notifications
via HipChat, see <link linkend="configuring-hipchat">Configuring HipChat</link>.</simpara>
<variablelist>
<varlistentry>
<term>
<literal>xpack.notification.hipchat</literal> 
</term>
<listitem>
<simpara>
Specifies account information for sending notifications
via HipChat. You can specify the following HipChat account attributes:
</simpara>
<variablelist id="hipchat-account-attributes">
<varlistentry>
<term>
<literal>profile</literal>
</term>
<listitem>
<simpara>
  The HipChat account profile to use: <literal>integration</literal>,
                      <literal>user</literal>, or <literal>v1</literal>. Required.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>auth_token</literal>
</term>
<listitem>
<simpara>
  The authentication token to use to access
                      the HipChat API. Required.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>host</literal>
</term>
<listitem>
<simpara>
  The HipChat server hostname. Defaults to <literal>api.hipchat.com</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>port</literal>
</term>
<listitem>
<simpara>
  The HipChat server port number. Defaults to 443.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>room</literal>
</term>
<listitem>
<simpara>
  The room you want to send messages to. Must be specified
                      if the <literal>profile</literal> is set to <literal>integration</literal>. Not valid for
                      the <literal>user</literal> or <literal>vi</literal> profiles.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>user</literal>
</term>
<listitem>
<simpara>
  The HipChat user account to use to send messages.
                      Specified as an email address. Must be specified if the
                      <literal>profile</literal> is set to <literal>user</literal>. Not valid for the <literal>integration</literal>
                      or <literal>v1</literal> profiles.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>message.format</literal>
</term>
<listitem>
<simpara>
  The format of the message: <literal>text</literal> or <literal>html</literal>.
                      Defaults to <literal>html</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>message.color</literal>
</term>
<listitem>
<simpara>
  The background color of the notification in the room.
                      Defaults to  <literal>yellow</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>message.notify</literal>
</term>
<listitem>
<simpara>
  Indicates whether people in the room should be
                      actively notified. Defaults to <literal>false</literal>.
</simpara>
</listitem>
</varlistentry>
</variablelist>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="slack-notification-settings" renderas="sect2">Slack Notification Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/settings/notification-settings.asciidoc">Edit me</ulink></bridgehead>
<simpara>You can configure the following Slack notification settings in
<literal>elasticsearch.yml</literal>. For more information about sending notifications
via Slack, see  <link linkend="configuring-slack">Configuring Slack</link>.</simpara>
<variablelist>
<varlistentry>
<term>
<literal>xpack.notification.slack</literal> 
</term>
<listitem>
<simpara>
Specifies account information for sending notifications
via Slack. You can specify the following Slack account attributes:
</simpara>
<variablelist id="slack-account-attributes">
<varlistentry>
<term>
<literal>url</literal>
</term>
<listitem>
<simpara>
  The Incoming Webhook URL to use to post
                                    messages to Slack. Required.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>message_defaults.from</literal>
</term>
<listitem>
<simpara>
  The sender name to display in the
                                    Slack message. Defaults to the watch ID.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>message_defaults.to</literal>
</term>
<listitem>
<simpara>
  The default Slack channels or groups you
                                             want to send messages to.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>message_defaults.icon</literal>
</term>
<listitem>
<simpara>
  The icon to display in the Slack messages.
                                             Overrides the incoming webhook&#8217;s configured
                                             icon. Accepts a public URL to an image.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>message_defaults.text</literal>
</term>
<listitem>
<simpara>
  The default message content.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>message_defaults.attachment</literal>
</term>
<listitem>
<simpara>
  Default message attachments. Slack message attachments
                                    enable you to create more richly-formatted messages.
                                    Specified as an array as defined in the
                                    <ulink url="https://api.slack.com/docs/attachments">
                                   Slack attachments documentation</ulink>.
</simpara>
</listitem>
</varlistentry>
</variablelist>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="pagerduty-notification-settings" renderas="sect2">PagerDuty Notification Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/settings/notification-settings.asciidoc">Edit me</ulink></bridgehead>
<simpara>You can configure the following PagerDuty notification settings in
<literal>elasticsearch.yml</literal>. For more information about sending notifications
via PagerDuty, see  <link linkend="configuring-pagerduty">Configuring PagerDuty</link>.</simpara>
<variablelist id="pagerduty-account-attributes">
<varlistentry>
<term>
<literal>xpack.notification.pagerduty</literal>
</term>
<listitem>
<simpara>
Specifies account information for sending notifications
via PagerDuty. You can specify the following PagerDuty account attributes:
</simpara>
<variablelist>
<varlistentry>
<term>
<literal>name</literal>
</term>
<listitem>
<simpara>
  A name for the PagerDuty account associated with the API key you
  are using to access PagerDuty. Required.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>service_api_key</literal>
</term>
<listitem>
<simpara>
   The <ulink url="https://developer.pagerduty.com/documentation/rest/authentication">
   PagerDuty API key</ulink> to use to access PagerDuty. Required.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
'event_defaults`
</term>
<listitem>
<simpara>
  Default values for  <ulink url="https://www.elastic.co/guide/en/watcher/current/actions.html#pagerduty-event-trigger-incident-attributes">PagerDuty event attributes</ulink>. Optional.
</simpara>
</listitem>
</varlistentry>
</variablelist>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>description</literal>
</term>
<listitem>
<simpara>
        A string that contains the default description for PagerDuty events.
        If no default is configured, each PagerDuty action must specify a
        <literal>description</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>incident_key</literal>
</term>
<listitem>
<simpara>
        A string that contains the default incident key to use when sending
        PagerDuty events.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>client</literal>
</term>
<listitem>
<simpara>
        A string that specifies the default monitoring client.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>client_url</literal>
</term>
<listitem>
<simpara>
        The URL of the default monitoring client.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>event_type</literal>
</term>
<listitem>
<simpara>
        The default event type. Valid values: <literal>trigger</literal>,<literal>resolve</literal>, <literal>acknowledge</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>attach_payload</literal>
</term>
<listitem>
<simpara>
        Whether or not to provide the watch payload as context for
        the event by default. Valid values: <literal>true</literal>, <literal>false</literal>.
</simpara>
</listitem>
</varlistentry>
</variablelist>
</chapter>
<chapter id="reporting-settings">
<title>Reporting Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/settings/reporting-settings.asciidoc">Edit me</ulink></title>
<simpara>You configure <literal>xpack.reporting</literal> settings in <literal>kibana.yml</literal> to
control how X-Pack reporting <link linkend="reporting-kibana-server-settings">communicates with the Kibana server</link>, <link linkend="reporting-job-queue-settings">manages background jobs</link>, and <link linkend="reporting-capture-settings">captures screenshots</link>.</simpara>
<bridgehead id="general-reporting-settings" renderas="sect2">General Reporting Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/settings/reporting-settings.asciidoc">Edit me</ulink></bridgehead>
<variablelist>
<varlistentry>
<term>
<literal>xpack.reporting.enabled</literal>
</term>
<listitem>
<simpara>
Set to <literal>false</literal> to disable X-Pack reporting.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.reporting.encryptionKey</literal>
</term>
<listitem>
<simpara>
Set to any text string. By default, Kibana generates a random key when it starts,
which causes any pending reports to fail on restart. Configure this setting to use
the same key across restarts.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="reporting-kibana-server-settings" renderas="sect2">Kibana Server Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/settings/reporting-settings.asciidoc">Edit me</ulink></bridgehead>
<simpara>Reporting uses the Kibana interface to generate reports. In most cases, you don&#8217;t need
to configure Reporting to communicate with Kibana, it just works out of the box.
However, if you use a proxy in your stack or otherwise change how you access Kibana, you
might need to configure the following settings.</simpara>
<variablelist>
<varlistentry>
<term>
<literal>xpack.reporting.kibanaApp</literal>
</term>
<listitem>
<simpara>
The root path used to access Kibana, defaults to <literal>/app/kibana</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.reporting.kibanaServer.port</literal>
</term>
<listitem>
<simpara>
The port used to access Kibana, if different than the <literal>server.port</literal> value.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.reporting.kibanaServer.protocol</literal>
</term>
<listitem>
<simpara>
The protocol used to access Kibana, typically <literal>http</literal> or <literal>https</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.reporting.kibanaServer.hostname</literal>
</term>
<listitem>
<simpara>
The hostname used to access Kibana, if different than the <literal>server.name</literal> value.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="reporting-job-queue-settings" renderas="sect2">Background Job Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/settings/reporting-settings.asciidoc">Edit me</ulink></bridgehead>
<simpara>Reporting generates reports in the background and jobs are coordinated using documents
in Elasticsearch. Depending on how often you generate reports and the overall number of
reports, you may need to change some of the following settings.</simpara>
<variablelist>
<varlistentry>
<term>
<literal>xpack.reporting.queue.indexInterval</literal>
</term>
<listitem>
<simpara>
How often the index that stores reporting jobs rolls over to a new index.
Valid values are <literal>year</literal>, <literal>month</literal>, <literal>week</literal>, <literal>day</literal>, and <literal>hour</literal>. Defaults to <literal>week</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.reporting.queue.pollInterval</literal>
</term>
<listitem>
<simpara>
How often idle workers poll the index for pending jobs. Defaults to <literal>3000</literal> (3 seconds).
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.reporting.queue.timeout</literal>
</term>
<listitem>
<simpara>
How long each worker has to produce a report. If your machine is slow or under constant
heavy load, you might need to increase this timeout. Specified in milliseconds.
Defaults to <literal>30000</literal> (30 seconds).
</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="reporting-capture-settings" renderas="sect2">Capture Settings<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/settings/reporting-settings.asciidoc">Edit me</ulink></bridgehead>
<simpara>Reporting works by capturing screenshots from Kibana. These settings are used to
control various aspects of the capturing process.</simpara>
<variablelist>
<varlistentry>
<term>
<literal>xpack.reporting.capture.concurrency</literal>
</term>
<listitem>
<simpara>
The number of concurrent capture processes to run. Note that jobs are CPU bound,
and exceeding the number of cores available on the machine will likely be very
slow and might cause issues. Defaults to the number of cores on
the machine.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.reporting.capture.loadDelay</literal>
</term>
<listitem>
<simpara>
The amount of time to wait for Kibana to finish rendering the visualization before
taking a screenshot. Raising this value will increase report generation time, but
may be required on slower machines. If you are seeing empty images instead of
visualizations in your reports, try increasing this value.
Defaults to <literal>3000</literal> (3 seconds).
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.reporting.capture.timeout</literal>
</term>
<listitem>
<simpara>
The maximum amount of time to wait for things to render in Kibana when capturing
screenshots. Defaults to <literal>6000</literal> (6 seconds).
</simpara>
</listitem>
</varlistentry>
</variablelist>
</chapter>
</part>
<part id="xpack-api">
<title>X-Pack APIs <ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/rest-api/index.asciidoc">Edit me</ulink></title>
<partintro>
<simpara>X-Pack exposes a wide range of REST APIs to manage and monitor its features.</simpara>
<itemizedlist>
<listitem>
<simpara>
<link linkend="info-api">Info API</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="security-api">Security APIs</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="watcher-api">Watcher APIs</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="graph-api">Graph APIs</link>
</simpara>
</listitem>
</itemizedlist>
</partintro>
<chapter id="info-api">
<title>Info API<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/rest-api/index.asciidoc">Edit me</ulink></title>
<simpara>The info API provides general information on the installed X-Pack. This
information includes:</simpara>
<itemizedlist>
<listitem>
<simpara>
Build Information - including the build number and timestamp.
</simpara>
</listitem>
<listitem>
<simpara>
License Information - basic information about the currently installed license.
</simpara>
</listitem>
<listitem>
<simpara>
Features Information - The features that are currently enabled and available
  under the current license.
</simpara>
</listitem>
</itemizedlist>
<simpara>The following example queries the info API:</simpara>
<programlisting language="js" linenumbering="unnumbered">GET /_xpack</programlisting>
<simpara>Example response:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
   "build": {
      "hash": "2798b1a3ce779b3611bb53a0082d4d741e4d3168",
      "timestamp": "2015-04-07T13:34:42Z"
   },
   "license": {
      "uid": "893361dc-9749-4997-93cb-802e3dofh7aa",
      "type": "internal",
      "mode": "platinum",
      "status": "active",
      "expiry_date": "2030-08-29T23:59:59.999Z",
      "expiry_date_in_millis": 1914278399999
   },
   "features": {
      "graph": {
         "description": "Graph Data Exploration for the Elastic Stack",
         "available": true,
         "enabled": true
      },
      "monitoring": {
         "description": "Monitoring for the Elastic Stack",
         "available": true,
         "enabled": true
      },
      "security": {
         "description": "Security for the Elastic Stack",
         "available": true,
         "enabled": true
      },
      "watcher": {
         "description": "Alerting, Notification and Automation for the Elastic Stack",
         "available": true,
         "enabled": true
      }
   },
   "tagline": "You know, for X"
}</programlisting>
<simpara>You can also control what information is returned using the <literal>categories</literal> and
<literal>human</literal> parameters.</simpara>
<simpara>The following example only returns the build and features information:</simpara>
<programlisting language="js" linenumbering="unnumbered">GET /_xpack?categories=build,features</programlisting>
<simpara>The following example removes the descriptions from the response:</simpara>
<programlisting language="js" linenumbering="unnumbered">GET /_xpack?human=false</programlisting>
</chapter>
<chapter id="security-api">
<title>Security APIs<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/rest-api/security.asciidoc">Edit me</ulink></title>
<itemizedlist>
<listitem>
<simpara>
<xref linkend="security-api-authenticate"/>
</simpara>
</listitem>
<listitem>
<simpara>
<xref linkend="security-api-clear-cache"/>
</simpara>
</listitem>
<listitem>
<simpara>
<xref linkend="security-api-users"/>
</simpara>
</listitem>
<listitem>
<simpara>
<xref linkend="security-api-roles"/>
</simpara>
</listitem>
</itemizedlist>
<section id="security-api-authenticate">
<title>Authenticate API<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/rest-api/security/authenticate.asciidoc">Edit me</ulink></title>
<simpara>The Authenticate API enables you to submit a request with a basic auth header to
authenticate a user and retrieve information about the authenticated user.
Returns a 401 status code if the user cannot be authenticated.</simpara>
<simpara>To authenticate a user, submit a GET request to the <literal>_xpack/security/_authenticate</literal> endpoint:</simpara>
<programlisting language="js" linenumbering="unnumbered">GET _xpack/security/_authenticate</programlisting>
<remark> CONSOLE</remark>
<simpara>A successful call returns a JSON structure that shows what roles are assigned
to the user.</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "username": "rdeniro",
  "roles": [
    "admin",
    "kibana4"
  ]
}</programlisting>
</section>
<section id="security-api-change-password">
<title>Change Password API<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/rest-api/security/change-password.asciidoc">Edit me</ulink></title>
<simpara>The Change Password API enables you to submit a request to change the password
of a user. Every user can change their own password and users with the
<literal>manage_security</literal> privilege can change passwords of other users.</simpara>
<simpara>To change the password of the logged in user, submit a POST request to the
<literal>_xpack/security/user/_password</literal> endpoint:</simpara>
<programlisting language="js" linenumbering="unnumbered">POST _xpack/security/user/elastic/_password
{
  "password": "changeme"
}</programlisting>
<remark> CONSOLE</remark>
<simpara>A successful call returns an empty JSON structure.</simpara>
<programlisting language="js" linenumbering="unnumbered">{}</programlisting>
<remark> TESTRESPONSE</remark>
</section>
<section id="security-api-clear-cache">
<title>Clear Cache API<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/rest-api/security/clear-cache.asciidoc">Edit me</ulink></title>
<simpara>The Clear Cache API evicts users from the user cache. You can completely clear
the cache or evict specific users.</simpara>
<simpara>For example, to evict all users cached by the <literal>file</literal> realm:</simpara>
<programlisting language="js" linenumbering="unnumbered">POST _xpack/security/realm/default_file/_clear_cache</programlisting>
<remark> CONSOLE</remark>
<simpara>To evict selected users, specify the <literal>usernames</literal> parameter:</simpara>
<programlisting language="js" linenumbering="unnumbered">POST _xpack/security/realm/default_file/_clear_cache?usernames=rdeniro,alpacino</programlisting>
<remark> CONSOLE</remark>
<simpara>To clear the caches for multiple realms, specify the realms as a comma-delimited
list:</simpara>
<programlisting language="js" linenumbering="unnumbered">POST _xpack/security/realm/default_file,ldap1/_clear_cache</programlisting>
<remark> CONSOLE</remark>
<simpara>For more information, see <link linkend="controlling-user-cache">Controlling the User Cache</link>.</simpara>
</section>
<section id="security-api-users">
<title>User Management APIs<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/rest-api/security/users.asciidoc">Edit me</ulink></title>
<simpara>The <literal>user</literal> API enables you to create, read, update, and delete users from the
<literal>native</literal> realm. These users are commonly referred to as <emphasis role="strong">native users</emphasis>.
To use this API, you must have at least the <literal>manage_security</literal> cluster privilege.</simpara>
<simpara id="security-api-put-user">To add a user, submit a PUT or POST request to the <literal>/_xpack/security/user/&lt;username&gt;</literal>
endpoint.</simpara>
<note id="username-validation"><simpara>A username must be at least 1 character and no longer than 30 characters.
      The first character must be a letter (<literal>a-z</literal> or <literal>A-Z</literal>) or an underscore (<literal>_</literal>).
      Subsequent characters can be letters, underscores (<literal>_</literal>), digits (<literal>0-9</literal>),
      or any of the following symbols <literal>@</literal>, <literal>-</literal>, <literal>.</literal> or <literal>$</literal></simpara></note>
<programlisting language="js" linenumbering="unnumbered">POST /_xpack/security/user/jacknich
{
  "password" : "j@rV1s",
  "roles" : [ "admin", "other_role1" ],
  "full_name" : "Jack Nicholson",
  "email" : "jacknich@example.com",
  "metadata" : {
    "intelligence" : 7
  }
}</programlisting>
<remark> CONSOLE</remark>
<table
frame="all"
rowsep="1" colsep="1"
>
<title>User Fields</title>
<tgroup cols="3">
<colspec colname="col_1" colwidth="25*"/>
<colspec colname="col_2" colwidth="12*"/>
<colspec colname="col_3" colwidth="62*"/>
<tbody>
<row>
<entry align="left" valign="top"><simpara>Name</simpara></entry>
<entry align="center" valign="top"><simpara>Required</simpara></entry>
<entry align="left" valign="top"><simpara>Description</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>password</literal></simpara></entry>
<entry align="center" valign="top"><simpara>yes</simpara></entry>
<entry align="left" valign="top"><simpara>The user&#8217;s password. Passwords must be at least 6
                            characters long.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>roles</literal></simpara></entry>
<entry align="center" valign="top"><simpara>yes</simpara></entry>
<entry align="left" valign="top"><simpara>A set of roles the user has. The roles determine
                            the user&#8217;s access permissions</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>full_name</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>The full name of the user</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>email</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>The email of the user</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>metadata</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="left" valign="top"><simpara>Arbitrary metadata that you want to associate with
                            the user.</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<simpara>A successful call returns a JSON structure that shows whether the user has been
created or updated.</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "user": {
    "created" : true <co id="CO66-1"/>
  }
}</programlisting>
<remark> TESTRESPONSE</remark>
<calloutlist>
<callout arearefs="CO66-1">
<para>
When an existing user is updated, <literal>created</literal> is set to false.
</para>
</callout>
</calloutlist>
<note><simpara>You also use the PUT user API to update users. When updating a user, you
      can update everything but its <literal>username</literal> and <literal>password</literal>. To change a user&#8217;s
      password, use the  <link linkend="security-api-reset-user-password">reset password API</link>.</simpara></note>
<simpara>Once you add a user through the Users API, requests from that user can be
authenticated.</simpara>
<programlisting language="shell" linenumbering="unnumbered">curl -u eustace:secret-password http://localhost:9200/_cluster/health</programlisting>
<simpara id="security-api-get-user">To retrieve a native user, submit a GET request to the <literal>/_xpack/security/user/&lt;username&gt;</literal>
endpoint:</simpara>
<programlisting language="js" linenumbering="unnumbered">GET /_xpack/security/user/jacknich</programlisting>
<remark> CONSOLE</remark>
<remark> TEST[continued]</remark>
<simpara>A successful call returns an array of users with the JSON representation of the
user. Note that user passwords are not included.</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "jacknich": {  <co id="CO67-1"/>
    "username" : "jacknich",
    "roles" : [ "admin", "other_role1" ],
    "full_name" : "Jack Nicholson",
    "email" : "jacknich@example.com",
    "enabled": true,
    "metadata" : {
      "intelligence" : 7
    }
  }
}</programlisting>
<remark> TESTRESPONSE</remark>
<calloutlist>
<callout arearefs="CO67-1">
<para>
If the user is not defined in the <literal>native</literal> realm, the request 404s.
</para>
</callout>
</calloutlist>
<simpara>You can specify multiple usernames as a comma-separated list:</simpara>
<programlisting language="js" linenumbering="unnumbered">GET /_xpack/security/user/jacknich,rdinero</programlisting>
<remark> CONSOLE</remark>
<remark> TEST[continued]</remark>
<simpara>or omit the username all together to retrieve all users:</simpara>
<programlisting language="js" linenumbering="unnumbered">GET /_xpack/security/user</programlisting>
<remark> CONSOLE</remark>
<remark> TEST[continued]</remark>
<simpara id="security-api-reset-user-password">To reset the password for a user, submit a PUT request to the
<literal>/_xpack/security/user/&lt;username&gt;/_password</literal> endpoint:</simpara>
<programlisting language="js" linenumbering="unnumbered">PUT /_xpack/security/user/jacknich/_password
{
  "password" : "s3cr3t"
}</programlisting>
<remark> CONSOLE</remark>
<remark> TEST[continued]</remark>
<simpara id="security-api-disable-user">To disable a user, submit a PUT request to the
<literal>/_xpack/security/user/&lt;username&gt;/_disable</literal> endpoint:</simpara>
<programlisting language="js" linenumbering="unnumbered">PUT /_xpack/security/user/jacknich/_disable</programlisting>
<remark> CONSOLE</remark>
<remark> TEST[continued]</remark>
<simpara id="security-api-enable-user">To disable a user, submit a PUT request to the
<literal>/_xpack/security/user/&lt;username&gt;/_enable</literal> endpoint:</simpara>
<programlisting language="js" linenumbering="unnumbered">PUT /_xpack/security/user/jacknich/_enable</programlisting>
<remark> CONSOLE</remark>
<remark> TEST[continued]</remark>
<simpara id="security-api-delete-user">To delete a user, submit a DELETE request to the <literal>/_xpack/security/user/&lt;username&gt;</literal>
endpoint:</simpara>
<programlisting language="js" linenumbering="unnumbered">DELETE /_xpack/security/user/jacknich</programlisting>
<remark> CONSOLE</remark>
<remark> TEST[continued]</remark>
<simpara>If the user is successfully deleted, the request returns <literal>{"found": true}</literal>.
Otherwise, <literal>found</literal> is set to false.</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "found" : true
}</programlisting>
<remark> TESTRESPONSE</remark>
</section>
<section id="security-api-roles">
<title>Role Management APIs<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/rest-api/security/roles.asciidoc">Edit me</ulink></title>
<simpara>The Roles API enables you to add, remove, and retrieve roles in the <literal>native</literal>
realm. To use this API, you must have at least the <literal>manage_security</literal> cluster
privilege.</simpara>
<note><simpara>The Roles API is now the preferred way to manage roles.</simpara></note>
<simpara id="security-api-put-role">To add a role, submit a PUT or POST request to the <literal>/_xpack/security/role/&lt;rolename&gt;</literal>
endpoint:</simpara>
<programlisting language="js" linenumbering="unnumbered">POST /_xpack/security/role/my_admin_role
{
  "cluster": ["all"],
  "indices": [
    {
      "names": [ "index1", "index2" ],
      "privileges": ["all"],
      "field_security" : { // optional
        "grant" : [ "title", "body" ]
      },
      "query": "{\"match\": {\"title\": \"foo\"}}" // optional
    }
  ],
  "run_as": [ "other_user" ], // optional
  "metadata" : { // optional
    "version" : 1
  }
}</programlisting>
<remark> CONSOLE</remark>
<simpara>The <literal>name</literal>, <literal>cluster</literal>, and <literal>indices</literal> fields are required at the top-level.
Within the <literal>indices</literal> array, the <literal>names</literal> and <literal>privileges</literal> fields are required.
Within the <literal>metadata</literal> object, keys beginning with <literal>_</literal> are reserved for system
usage.</simpara>
<simpara>A successful call returns a JSON structure that shows whether the role has been
created or updated.</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "role": {
    "created": true <co id="CO68-1"/>
  }
}</programlisting>
<remark> TESTRESPONSE</remark>
<calloutlist>
<callout arearefs="CO68-1">
<para>
When an existing role is updated, <literal>created</literal> is set to false.
</para>
</callout>
</calloutlist>
<simpara id="security-api-get-role">To retrieve a role from the <literal>native</literal> Security realm, issue a GET request to the
<literal>/_xpack/security/role/&lt;rolename&gt;</literal> endpoint:</simpara>
<programlisting language="js" linenumbering="unnumbered">GET /_xpack/security/role/my_admin_role</programlisting>
<remark> CONSOLE</remark>
<remark> TEST[continued]</remark>
<simpara>A successful call returns an array of roles with the JSON representation of the
role. If the role is not defined in the <literal>native</literal> realm, the request 404s.</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "my_admin_role": {
    "cluster" : [ "all" ],
    "indices" : [ {
      "names" : [ "index1", "index2" ],
      "privileges" : [ "all" ],
      "field_security" : {
        "grant" : [ "title", "body" ]
      },
      "query" : "{\"match\": {\"title\": \"foo\"}}"
    } ],
    "run_as" : [ "other_user" ],
    "metadata" : {
      "version" : 1
    }
  }
}</programlisting>
<remark> TESTRESPONSE</remark>
<simpara>You can specify multiple roles as a comma-separated list. To retrieve all roles,
omit the role name.</simpara>
<programlisting language="js" linenumbering="unnumbered"># Retrieve roles "r1", "r2", and "my_admin_role"
GET /_xpack/security/role/r1,r2,my_admin_role

# Retrieve all roles
GET /_xpack/security/role</programlisting>
<remark> CONSOLE</remark>
<remark> TEST[continued]</remark>
<simpara id="security-api-delete-role">To delete a role, submit a DELETE request to the <literal>/_xpack/security/role/&lt;rolename&gt;</literal>
endpoint:</simpara>
<programlisting language="js" linenumbering="unnumbered">DELETE /_xpack/security/role/my_admin_role</programlisting>
<remark> CONSOLE</remark>
<remark> TEST[continued]</remark>
<simpara>If the role is successfully deleted, the request returns <literal>{"found": true}</literal>.
Otherwise, <literal>found</literal> is set to false.</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "found" : true
}</programlisting>
<remark> TESTRESPONSE</remark>
<simpara id="security-api-clear-role-cache">The Clear Roles Cache API evicts roles from the native role cache. To clear the
cache for a role, submit a POST request <literal>/_xpack/security/role/&lt;rolename&gt;/_clear_cache</literal>
endpoint:</simpara>
<programlisting language="js" linenumbering="unnumbered">POST /_xpack/security/role/my_admin_role/_clear_cache</programlisting>
<remark> CONSOLE</remark>
</section>
</chapter>
<chapter id="watcher-api">
<title>Watcher APIs<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/rest-api/watcher.asciidoc">Edit me</ulink></title>
<itemizedlist>
<listitem>
<simpara>
<xref linkend="watcher-api-put-watch"/>
</simpara>
</listitem>
<listitem>
<simpara>
<xref linkend="watcher-api-get-watch"/>
</simpara>
</listitem>
<listitem>
<simpara>
<xref linkend="watcher-api-delete-watch"/>
</simpara>
</listitem>
<listitem>
<simpara>
<xref linkend="watcher-api-execute-watch"/>
</simpara>
</listitem>
<listitem>
<simpara>
<xref linkend="watcher-api-activate-watch"/>
</simpara>
</listitem>
<listitem>
<simpara>
<xref linkend="watcher-api-deactivate-watch"/>
</simpara>
</listitem>
<listitem>
<simpara>
<xref linkend="watcher-api-stats"/>
</simpara>
</listitem>
<listitem>
<simpara>
<xref linkend="watcher-api-stop"/>
</simpara>
</listitem>
<listitem>
<simpara>
<xref linkend="watcher-api-start"/>
</simpara>
</listitem>
<listitem>
<simpara>
<xref linkend="watcher-api-restart"/>
</simpara>
</listitem>
</itemizedlist>
<section id="watcher-api-put-watch">
<title>Put Watch API<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/rest-api/watcher/put-watch.asciidoc">Edit me</ulink></title>
<simpara>The PUT watch API either registers a new watch in Watcher or update an
existing one. Once registered, a new document will be added to the <literal>.watches</literal>
index, representing the watch, and its trigger will immediately be registered
with the relevant trigger engine (typically the scheduler, for the <literal>schedule</literal>
trigger).</simpara>
<important><simpara>Putting a watch must be done via this API only. Do not put a watch
            directly to the <literal>.watches</literal> index using Elasticsearch&#8217;s Index API.
            If X-Pack security is enabled, make sure no <literal>write</literal> privileges are
            granted to anyone over the <literal>.watches</literal> index.</simpara></important>
<simpara>The following example adds a watch with the <literal>my-watch</literal> id that has the following
characteristics:</simpara>
<itemizedlist>
<listitem>
<simpara>
The watch schedule triggers every minute.
</simpara>
</listitem>
<listitem>
<simpara>
The watch search input looks for any 404 HTTP responses that occurred in the
  last five minutes.
</simpara>
</listitem>
<listitem>
<simpara>
The watch condition checks if any search hits where found.
</simpara>
</listitem>
<listitem>
<simpara>
When found, the watch action sends an email to an administrator.
</simpara>
</listitem>
</itemizedlist>
<programlisting language="js" linenumbering="unnumbered">PUT _xpack/watcher/watch/my-watch
{
  "trigger" : {
    "schedule" : { "cron" : "0 0/1 * * * ?" }
  },
  "input" : {
    "search" : {
      "request" : {
        "indices" : [
          "logstash*"
        ],
        "body" : {
          "query" : {
            "bool" : {
              "must" : {
                "match": {
                   "response": 404
                }
              },
              "filter" : {
                "range": {
                  "@timestamp": {
                    "from": "{{ctx.trigger.scheduled_time}}||-5m",
                    "to": "{{ctx.trigger.triggered_time}}"
                  }
                }
              }
            }
          }
        }
      }
    }
  },
  "condition" : {
    "compare" : { "ctx.payload.hits.total" : { "gt" : 0 }}
  },
  "actions" : {
    "email_admin" : {
      "email" : {
        "to" : "admin@domain.host.com",
        "subject" : "404 recently encountered"
      }
    }
  }
}</programlisting>
<remark> CONSOLE</remark>
<simpara>A watch has the following fields:</simpara>
<informaltable
frame="all"
rowsep="1" colsep="1"
>
<tgroup cols="2">
<colspec colname="col_1" colwidth="50*"/>
<colspec colname="col_2" colwidth="50*"/>
<thead>
<row>
<entry align="left" valign="top"> Name              </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>trigger</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The <link linkend="trigger">trigger</link> that defines when the watch
                      should run.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>input</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The <link linkend="input">input</link> that defines the input that loads the
                      data for the watch.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>condition</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The <link linkend="condition">condition</link> that defines if the actions
                      should be run.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>actions</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The list of <link linkend="actions">actions</link> that will be run if the
                      condition matches</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>meta</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Metadata json that will be copied into the history entries.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>throttle_period</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The minimum time between actions being run, the default
                      for this is 5 seconds. This default can be changed in the
                      config file with the setting <literal>xpack.watcher.throttle.period.default_period</literal>.</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
<bridgehead id="_timeouts" renderas="sect3">Timeouts<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/rest-api/watcher/put-watch.asciidoc">Edit me</ulink></bridgehead>
<simpara>When updating a watch while it is executing, the put action will block and wait
for the watch execution to finish. Depending on the nature of the watch, in some
situations this can take a while. For this reason, the put watch action is
associated with a timeout that is set to 10 seconds by default. You can control
this timeout by passing in the <literal>master_timeout</literal> parameter.</simpara>
<simpara>The following snippet shows how to change the default timeout of the put action
to 30 seconds:</simpara>
<programlisting language="js" linenumbering="unnumbered">PUT _xpack/watcher/watch/my-watch?master_timeout=30s</programlisting>
<section id="watcher-api-put-watch-active-state">
<title>Controlling Default Active State<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/rest-api/watcher/put-watch.asciidoc">Edit me</ulink></title>
<simpara>When adding a watch you can also define its initial <link linkend="watch-active-state">active state</link>.
You do that by setting the <literal>active</literal> parameter. The following command add a watch
and sets it to be inactive by default:</simpara>
<programlisting language="js" linenumbering="unnumbered">PUT _xpack/watcher/watch/my-watch?active=false</programlisting>
<note><simpara>If you omit the <literal>active</literal> parameter, the watch is active by default.</simpara></note>
</section>
</section>
<section id="watcher-api-get-watch">
<title>Get Watch API<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/rest-api/watcher/get-watch.asciidoc">Edit me</ulink></title>
<simpara>This API retrieves a watch by its id.</simpara>
<simpara>The following example gets a watch with <literal>my-watch</literal> id:</simpara>
<programlisting language="js" linenumbering="unnumbered">GET _xpack/watcher/watch/my_watch</programlisting>
<remark> CONSOLE</remark>
<remark> TEST[setup:my_active_watch]</remark>
<simpara>Response:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "found": true,
  "_id": "my_watch",
  "_status": { <co id="CO69-1"/>
    "version": 1,
    "state": {
      "active": true,
      "timestamp": "2015-05-26T18:21:08.630Z"
    },
    "actions": {
      "test_index": {
        "ack": {
          "timestamp": "2015-05-26T18:21:08.630Z",
          "state": "awaits_successful_execution"
        }
      }
    }
  },
  "watch": {
    "input": {
      "simple": {
        "payload": {
          "send": "yes"
        }
      }
    },
    "condition": {
      "always": {}
    },
    "trigger": {
      "schedule": {
        "hourly": {
          "minute": [0, 5]
        }
      }
    },
    "actions": {
      "test_index": {
        "index": {
          "index": "test",
          "doc_type": "test2"
        }
      }
    }
  }
}</programlisting>
<remark> TESTRESPONSE[s/"timestamp": "2015-05-26T18:21:08.630Z"/"timestamp": "$body._status.state.timestamp"/]</remark>
<calloutlist>
<callout arearefs="CO69-1">
<para>
The current status of the watch
</para>
</callout>
</calloutlist>
</section>
<section id="watcher-api-delete-watch">
<title>Delete Watch API<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/rest-api/watcher/delete-watch.asciidoc">Edit me</ulink></title>
<simpara>The DELETE watch API removes a watch (identified by its <literal>id</literal>) from Watcher.
Once removed, the document representing the watch in the <literal>.watches</literal> index is
gone and it will never be executed again.</simpara>
<simpara>Please note that deleting a watch <emphasis role="strong">does not</emphasis> delete any watch execution records
related to this watch from the watch history.</simpara>
<important><simpara>Deleting a watch must be done via this API only. Do not delete the
            watch directly from the <literal>.watches</literal> index using Elasticsearch&#8217;s
            DELETE Document API. When X-Pack security is enabled, make sure no <literal>write</literal>
            privileges are granted to anyone over the <literal>.watches</literal> index.</simpara></important>
<simpara>The following example deletes a watch with the <literal>my-watch</literal> id:</simpara>
<programlisting language="js" linenumbering="unnumbered">DELETE _xpack/watcher/watch/my_watch</programlisting>
<remark> CONSOLE</remark>
<remark> TEST[setup:my_active_watch]</remark>
<simpara>Response:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
   "found": true,
   "_id": "my_watch",
   "_version": 2
}</programlisting>
<remark> TESTRESPONSE</remark>
<bridgehead id="_timeouts_2" renderas="sect3">Timeouts<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/rest-api/watcher/delete-watch.asciidoc">Edit me</ulink></bridgehead>
<simpara>When deleting a watch while it is executing, the delete action will block and
wait for the watch execution to finish. Depending on the nature of the watch, in
some situations this can take a while. For this reason, the delete watch action
is associated with a timeout that is set to 10 seconds by default. You can
control this timeout by passing in the <literal>master_timeout</literal> parameter.</simpara>
<simpara>The following snippet shows how to change the default timeout of the delete
action to 30 seconds:</simpara>
<programlisting language="js" linenumbering="unnumbered">DELETE _xpack/watcher/watch/my_watch?master_timeout=30s</programlisting>
<remark> CONSOLE</remark>
<remark> TEST[setup:my_active_watch]</remark>
</section>
<section id="watcher-api-execute-watch">
<title>Execute Watch API<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/rest-api/watcher/execute-watch.asciidoc">Edit me</ulink></title>
<simpara>The execute watch API forces the execution of a stored watch. It can be used to
force execution of the watch outside of its triggering logic, or to simulate the
watch execution for debugging purposes.</simpara>
<simpara>The following example executes the <literal>my_watch</literal> watch:</simpara>
<programlisting language="js" linenumbering="unnumbered">POST _xpack/watcher/watch/my_watch/_execute</programlisting>
<remark> CONSOLE</remark>
<remark> TEST[setup:my_active_watch]</remark>
<simpara>For testing and debugging purposes, you also have fine-grained control on how the
watch is executed&#8212;execute the watch without executing all of its actions or
alternatively by simulating them. You can also force execution by ignoring the
watch condition and control whether a watch record would be written to the watch
history after execution.</simpara>
<simpara>This API supports the following fields:</simpara>
<informaltable
frame="all"
rowsep="1" colsep="1"
>
<tgroup cols="4">
<colspec colname="col_1" colwidth="25*"/>
<colspec colname="col_2" colwidth="25*"/>
<colspec colname="col_3" colwidth="25*"/>
<colspec colname="col_4" colwidth="25*"/>
<thead>
<row>
<entry align="left" valign="top"> Name                </entry>
<entry align="center" valign="top"> Required </entry>
<entry align="center" valign="top"> Default  </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>trigger_data</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="center" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>This structure is parsed as the data of the trigger event
                                              that will be used during the watch execution</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ignore_condition</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="center" valign="top"><simpara>false</simpara></entry>
<entry align="left" valign="top"><simpara>When set to <literal>true</literal>, the watch execution uses the
                                              <link linkend="condition-always">Always</link> Condition. This can also be
                                              specified as a HTTP parameter.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>alternative_input</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="center" valign="top"><simpara>null</simpara></entry>
<entry align="left" valign="top"><simpara>When present, the watch uses this object as a payload
                                              instead of executing its own input.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>action_modes</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="center" valign="top"><simpara>null</simpara></entry>
<entry align="left" valign="top"><simpara>Determines how to handle the watch actions as part of the
                                              watch execution. See <link linkend="watcher-api-execute-watch-action-mode">Action Execution Modes</link>
                                              for more information.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>record_execution</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="center" valign="top"><simpara>false</simpara></entry>
<entry align="left" valign="top"><simpara>When set to <literal>true</literal>, the watch record representing the watch
                                              execution result is persisted to the <literal>.watcher-history</literal>
                                              index for the current time. In addition, the status of the
                                              watch is updated, possibly throttling subsequent executions.
                                              This can also be specified as a HTTP parameter.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>watch</literal></simpara></entry>
<entry align="center" valign="top"><simpara>no</simpara></entry>
<entry align="center" valign="top"><simpara>null</simpara></entry>
<entry align="left" valign="top"><simpara>When present, this <link linkend="watch-definition">watch</link> is used
                                              instead of the one specified in the request. This watch is
                                              not persisted to the index and record_execution cannot be set.</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
<simpara>The following example shows a comprehensive example of executing the <literal>my-watch</literal> watch:</simpara>
<programlisting language="js" linenumbering="unnumbered">POST _xpack/watcher/watch/my_watch/_execute
{
  "trigger_data" : { <co id="CO70-1"/>
     "triggered_time" : "now",
     "scheduled_time" : "now"
  },
  "alternative_input" : { <co id="CO70-2"/>
    "foo" : "bar"
  },
  "ignore_condition" : true, <co id="CO70-3"/>
  "action_modes" : {
    "my-action" : "force_simulate" <co id="CO70-4"/>
  },
  "record_execution" : true <co id="CO70-5"/>
}</programlisting>
<remark> CONSOLE</remark>
<remark> TEST[setup:my_active_watch]</remark>
<calloutlist>
<callout arearefs="CO70-1">
<para>
The triggered and schedule times are provided.
</para>
</callout>
<callout arearefs="CO70-2">
<para>
The input as defined by the watch is ignored and instead the provided input
    will be used as the execution payload.
</para>
</callout>
<callout arearefs="CO70-3">
<para>
The condition as defined by the watch will be ignored and will be assumed to
    evaluate to <literal>true</literal>.
</para>
</callout>
<callout arearefs="CO70-4">
<para>
Forces the simulation of <literal>my-action</literal>. Forcing the simulation means that
    throttling is ignored and the watch is simulated by Watcher instead of
    being executed normally.
</para>
</callout>
<callout arearefs="CO70-5">
<para>
The execution of the watch will create a watch record in the watch history,
    and the throttling state of the watch will potentially be updated accordingly.
</para>
</callout>
</calloutlist>
<simpara>This is an example of the output:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "_id": "my_watch_0-2015-06-02T23:17:55.124Z", <co id="CO71-1"/>
  "watch_record": { <co id="CO71-2"/>
    "watch_id": "my_watch",
    "messages": [],
    "trigger_event": {
      "type": "manual",
      "triggered_time": "2015-06-02T23:17:55.124Z",
      "manual": {
        "schedule": {
          "scheduled_time": "2015-06-02T23:17:55.124Z"
        }
      }
    },
    "state": "executed",
    "input": {
      "simple": {
        "payload": {
          "send": "yes"
        }
      }
    },
    "condition": {
      "always": {}
    },
    "result": { <co id="CO71-3"/>
      "execution_time": "2015-06-02T23:17:55.124Z",
      "execution_duration": 12608,
      "input": {
        "type": "simple",
        "payload": {
          "foo": "bar"
        },
        "status": "success"
      },
      "condition": {
        "type": "always",
        "met": true,
        "status": "success"
      },
      "actions": [
        {
          "id": "test_index",
          "index": {
            "response": {
              "index": "test",
              "type": "test2",
              "version": 1,
              "created": true,
              "result": "created",
              "id": "AVSHKzPa9zx62AzUzFXY"
            }
          },
          "status": "success",
          "type": "index"
        }
      ]
    }
  }
}</programlisting>
<remark> TESTRESPONSE[s/my_watch_0-2015-06-02T23:17:55.124Z/$body._id/]</remark>
<remark> TESTRESPONSE[s/"triggered_time": "2015-06-02T23:17:55.124Z"/"triggered_time": "$body.watch_record.trigger_event.triggered_time"/]</remark>
<remark> TESTRESPONSE[s/"scheduled_time": "2015-06-02T23:17:55.124Z"/"scheduled_time": "$body.watch_record.trigger_event.manual.schedule.scheduled_time"/]</remark>
<remark> TESTRESPONSE[s/"execution_time": "2015-06-02T23:17:55.124Z"/"execution_time": "$body.watch_record.result.execution_time"/]</remark>
<remark> TESTRESPONSE[s/"execution_duration": 12608/"execution_duration": "$body.watch_record.result.execution_duration"/]</remark>
<remark> TESTRESPONSE[s/"id": "AVSHKzPa9zx62AzUzFXY"/"id": "$body.watch_record.result.actions.0.index.response.id"/]</remark>
<calloutlist>
<callout arearefs="CO71-1">
<para>
The id of the watch record as it would be stored in the <literal>.watcher-history</literal> index.
</para>
</callout>
<callout arearefs="CO71-2">
<para>
The watch record document as it would be stored in the <literal>.watcher-history</literal> index.
</para>
</callout>
<callout arearefs="CO71-3">
<para>
The watch execution results.
</para>
</callout>
</calloutlist>
<section id="watcher-api-execute-watch-action-mode">
<title>Action Execution Modes<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/rest-api/watcher/execute-watch.asciidoc">Edit me</ulink></title>
<simpara>Action modes define how actions are handled during the watch execution. There
are five possible modes an action can be associated with:</simpara>
<informaltable
frame="all"
rowsep="1" colsep="1"
>
<tgroup cols="2">
<colspec colname="col_1" colwidth="50*"/>
<colspec colname="col_2" colwidth="50*"/>
<thead>
<row>
<entry align="left" valign="top"> Name              </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>simulate</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The action execution will be simulated. Each action type
                      define its own simulation operation mode. For example, The
                      <link linkend="actions-email">email</link> action will create the email that
                      would have been sent but will not actually send it. In this
                      mode, the action may be throttled if the current state
                      of the watch indicates it should be.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>force_simulate</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Similar to the the <literal>simulate</literal> mode, except the action will
                      not be throttled even if the current state of the watch
                      indicates it should be.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>execute</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Executes the action as it would have been executed if the
                      watch would have been triggered by its own trigger. The
                      execution may be throttled if the current state of the
                      watch indicates it should be.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>force_execute</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Similar to the <literal>execute</literal> mode, except the action will not
                      be throttled even if the current state of the watch
                      indicates it should be.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>skip</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The action will be skipped and won&#8217;t be executed nor
                      simulated. Effectively forcing the action to be throttled.</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
<simpara>You can set a different execution mode for every action by associating the mode
name with the action id:</simpara>
<programlisting language="js" linenumbering="unnumbered">POST _xpack/watcher/watch/my_watch/_execute
{
  "action_modes" : {
    "action1" : "force_simulate",
    "action2" : "skip"
  }
}</programlisting>
<remark> CONSOLE</remark>
<remark> TEST[setup:my_active_watch]</remark>
<simpara>You can also associate a single execution mode with all the actions in the watch
using <literal>_all</literal> as the action id:</simpara>
<programlisting language="js" linenumbering="unnumbered">POST _xpack/watcher/watch/my_watch/_execute
{
  "action_modes" : {
    "_all" : "force_execute"
  }
}</programlisting>
<remark> CONSOLE</remark>
<remark> TEST[setup:my_active_watch]</remark>
<bridgehead id="watcher-api-execute-inline-watch" renderas="sect3">Inline Watch Execution<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/rest-api/watcher/execute-watch.asciidoc">Edit me</ulink></bridgehead>
<simpara>You can use the Execute API to execute watches that are not yet registered by
specifying the watch definition inline. This serves as great tool for testing
and debugging your watches prior to adding them to Watcher.</simpara>
<simpara>The following example shows how to execute a watch inline:</simpara>
<programlisting language="js" linenumbering="unnumbered">POST _xpack/watcher/watch/_execute
{
  "watch" : {
    "trigger" : { "schedule" : { "interval" : "10s" } },
    "input" : {
      "search" : {
        "request" : {
          "indices" : [ "logs" ],
          "body" : {
            "query" : {
              "match" : { "message": "error" }
            }
          }
        }
      }
    },
    "condition" : {
      "compare" : { "ctx.payload.hits.total" : { "gt" : 0 }}
    },
    "actions" : {
      "log_error" : {
        "logging" : {
          "text" : "Found {{ctx.payload.hits.total}} errors in the logs"
        }
      }
    }
  }
}</programlisting>
<remark> CONSOLE</remark>
<simpara>All other settings for this API still apply when inlining a watch. In the
following snippet, while the inline watch defines a <literal>compare</literal> condition,
during the execution this condition will be ignored:</simpara>
<programlisting language="js" linenumbering="unnumbered">POST _xpack/watcher/watch/_execute
{
  "ignore_condition" : true,
  "watch" : {
    "trigger" : { "schedule" : { "interval" : "10s" } },
    "input" : {
      "search" : {
        "request" : {
          "indices" : [ "logs" ],
          "body" : {
            "query" : {
              "match" : { "message": "error" }
            }
          }
        }
      }
    },
    "condition" : {
      "compare" : { "ctx.payload.hits.total" : { "gt" : 0 }}
    },
    "actions" : {
      "log_error" : {
        "logging" : {
          "text" : "Found {{ctx.payload.hits.total}} errors in the logs"
        }
      }
    }
  }
}</programlisting>
<remark> CONSOLE</remark>
</section>
</section>
<section id="watcher-api-ack-watch">
<title>Ack Watch API<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/rest-api/watcher/ack-watch.asciidoc">Edit me</ulink></title>
<simpara><link linkend="actions-ack-throttle">Acknowledging</link> a watch enables you to manually throttle
execution of the watch&#8217;s actions. An action&#8217;s <emphasis>acknowledgement state</emphasis> is stored
in the <literal>_status.actions.&lt;id&gt;.ack.state</literal> structure.</simpara>
<simpara>To demonstrate let&#8217;s create a new watch:</simpara>
<programlisting language="js" linenumbering="unnumbered">PUT _xpack/watcher/watch/my_watch
{
  "trigger": {
    "schedule": {
      "hourly": {
        "minute": [ 0, 5 ]
      }
    }
  },
  "input": {
    "simple": {
      "payload": {
        "send": "yes"
      }
    }
  },
  "condition": {
    "always": {}
  },
  "actions": {
    "test_index": {
      "throttle_period": "15m",
      "index": {
        "index": "test",
        "doc_type": "test2"
      }
    }
  }
}</programlisting>
<remark> CONSOLE</remark>
<remark> TESTSETUP</remark>
<simpara>The current status of a watch and the state of its actions is returned with the
watch definition when you call the <link linkend="watcher-api-get-watch">Get Watch API</link>:</simpara>
<programlisting language="js" linenumbering="unnumbered">GET _xpack/watcher/watch/my_watch</programlisting>
<remark> CONSOLE</remark>
<simpara>The action state of a newly-created watch is <literal>awaits_successful_execution</literal>:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "found": true,
  "_id": "my_watch",
  "_status": {
    "version": 1,
    "actions": {
      "test_index": {
        "ack": {
          "timestamp": "2015-05-26T18:04:27.723Z",
          "state": "awaits_successful_execution"
        }
      }
    },
    "state": ...
  },
  "watch": ...
}</programlisting>
<remark> TESTRESPONSE[s/"state": \.\.\./"state": "$body._status.state"/]</remark>
<remark> TESTRESPONSE[s/"watch": \.\.\./"watch": "$body.watch"/]</remark>
<remark> TESTRESPONSE[s/"timestamp": "2015-05-26T18:04:27.723Z"/"timestamp": "$body._status.actions.test_index.ack.timestamp"/]</remark>
<simpara>When the watch executes and the condition matches, the value of the <literal>ack.state</literal>
changes to <literal>ackable</literal>. Let&#8217;s force execution of the watch and fetch it again to
check the status:</simpara>
<programlisting language="js" linenumbering="unnumbered">POST _xpack/watcher/watch/my_watch/_execute
GET _xpack/watcher/watch/my_watch</programlisting>
<remark> TEST[continued]</remark>
<simpara>and the action is now in <literal>ackable</literal> state:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "found": true,
  "_id": "my_watch",
  "_status": {
    "version": 1,
    "actions": {
      "test_index": {
        "ack": {
          "timestamp": "2015-05-26T18:04:27.723Z",
          "state": "ackable"
        }
      }
    },
    "state": ...
  },
  "watch": ...
}</programlisting>
<remark> TESTRESPONSE[s/"state": \.\.\./"state": "$body._status.state"/]</remark>
<remark> TESTRESPONSE[s/"watch": \.\.\./"watch": "$body.watch"/]</remark>
<remark> TESTRESPONSE[s/"timestamp": "2015-05-26T18:04:27.723Z"/"timestamp": "$body._status.actions.test_index.ack.timestamp"/]</remark>
<simpara>Now we can acknowledge it:</simpara>
<programlisting language="js" linenumbering="unnumbered">PUT _xpack/watcher/watch/my_watch/_ack/test_index
GET _xpack/watcher/watch/my_watch</programlisting>
<remark> CONSOLE</remark>
<programlisting language="js" linenumbering="unnumbered">{
  "found": true,
  "_id": "my_watch",
  "_status": {
    "version": 1,
    "actions": {
      "test_index": {
        "ack": {
          "timestamp": "2015-05-26T18:04:27.723Z",
          "state": "acknowledged"
        }
      }
    },
    "state": ...
  },
  "watch": ...
}</programlisting>
<remark> TESTRESPONSE[s/"state": \.\.\./"state": "$body._status.state"/]</remark>
<remark> TESTRESPONSE[s/"watch": \.\.\./"watch": "$body.watch"/]</remark>
<remark> TESTRESPONSE[s/"timestamp": "2015-05-26T18:04:27.723Z"/"timestamp": "$body._status.actions.test_index.ack.timestamp"/]</remark>
<simpara>Acknowledging an action throttles further executions of that action until its
<literal>ack.state</literal> is reset to <literal>awaits_successful_execution</literal>. This happens when the
condition of the watch is not met (the condition evaluates to <literal>false</literal>).</simpara>
<simpara>You can acknowledge multiple actions by assigning the <literal>actions</literal> parameter a
comma-separated list of action ids:</simpara>
<programlisting language="js" linenumbering="unnumbered">POST _xpack/watcher/watch/my_watch/_ack/action1,action2</programlisting>
<remark> CONSOLE</remark>
<simpara>To acknowledge all of the actions of a watch, simply omit the <literal>actions</literal>
parameter:</simpara>
<programlisting language="js" linenumbering="unnumbered">POST _xpack/watcher/watch/my_watch/_ack</programlisting>
<remark> CONSOLE</remark>
<bridgehead id="_timeouts_3" renderas="sect3">Timeouts<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/rest-api/watcher/ack-watch.asciidoc">Edit me</ulink></bridgehead>
<simpara>If you acknowledge a watch while it is executing, the request blocks and waits
for the watch execution to finish. For some watches, this can take a significant
amount of time. By default, the acknowledge action has a timeout of 10 seconds.
You can change the timeout setting by specifying the <literal>master_timeout</literal> parameter.</simpara>
<simpara>The following snippet shows how to change the default timeout of the acknowledge
action to 30 seconds:</simpara>
<programlisting language="js" linenumbering="unnumbered">POST _xpack/watcher/watch/my_watch/_ack?master_timeout=30s</programlisting>
<remark> CONSOLE</remark>
<bridgehead id="_response_format" renderas="sect3">Response format<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/rest-api/watcher/ack-watch.asciidoc">Edit me</ulink></bridgehead>
<programlisting language="js" linenumbering="unnumbered">The response format looks like:</programlisting>
<programlisting language="js" linenumbering="unnumbered">{
   "_status": {
      "last_checked": "2015-05-26T18:21:08.630Z",
      "last_met_condition": "2015-05-26T18:21:08.630Z",
      "actions": {
         "my-action": {
            "ack_status": {
               "timestamp": "2015-05-26T18:21:09.982Z",
               "state": "acked"
            },
            "last_execution": {
               "timestamp": "2015-05-26T18:21:04.106Z",
               "successful": true
            },
            "last_successful_execution": {
               "timestamp": "2015-05-26T18:21:04.106Z",
               "successful": true
            },
            "last_throttle": {
               "timestamp": "2015-05-26T18:21:08.630Z",
               "reason": "throttling interval is set to [5 seconds] but time elapsed since last execution is [4 seconds and 530 milliseconds]"
            }
         }
      }
   }
}</programlisting>
<remark> TESTRESPONSE</remark>
</section>
<section id="watcher-api-activate-watch">
<title>Activate Watch API<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/rest-api/watcher/activate-watch.asciidoc">Edit me</ulink></title>
<simpara>A watch can be either <link linkend="watch-active-state">active or inactive</link>. This API enables
you to activate a currently inactive watch.</simpara>
<simpara>The status of an inactive watch is returned with the watch definition when you
call the <link linkend="watcher-api-get-watch">Get Watch API</link>:</simpara>
<programlisting language="js" linenumbering="unnumbered">GET _xpack/watcher/watch/my_watch</programlisting>
<remark> CONSOLE</remark>
<remark> TEST[setup:my_inactive_watch]</remark>
<programlisting language="js" linenumbering="unnumbered">{
  "found": true,
  "_id": "my_watch",
  "_status": {
    "state" : {
      "active" : false,
      "timestamp" : "2015-08-20T12:21:32.734Z"
    },
    "version": 1,
    "actions": ...
  },
  "watch": ...
}</programlisting>
<remark> TESTRESPONSE[s/2015-08-20T12:21:32.734Z/$body._status.state.timestamp/]</remark>
<remark> TESTRESPONSE[s/"actions": \.\.\./"actions": "$body._status.actions"/]</remark>
<remark> TESTRESPONSE[s/"watch": \.\.\./"watch": "$body.watch"/]</remark>
<simpara>You can activate the watch by executing the following API call:</simpara>
<programlisting language="js" linenumbering="unnumbered">PUT _xpack/watcher/watch/my_watch/_activate</programlisting>
<remark> CONSOLE</remark>
<remark> TEST[setup:my_inactive_watch]</remark>
<simpara>The new state of the watch is returned as part of its overall status:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "_status": {
    "state" : {
      "active" : true,
      "timestamp" : "2015-09-04T08:39:46.816Z"
    },
    "actions": ...
  }
}</programlisting>
<remark> TESTRESPONSE[s/2015-09-04T08:39:46.816Z/$body._status.state.timestamp/]</remark>
<remark> TESTRESPONSE[s/"actions": \.\.\./"actions": "$body._status.actions"/]</remark>
</section>
<section id="watcher-api-deactivate-watch">
<title>Deactivate Watch API<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/rest-api/watcher/deactivate-watch.asciidoc">Edit me</ulink></title>
<simpara>A watch can be either <link linkend="watch-active-state">active or inactive</link>. This API
enables you to deactivate a currently active watch.</simpara>
<simpara>The status of an active watch is returned with the watch definition when you
call the <link linkend="watcher-api-get-watch">Get Watch API</link>:</simpara>
<programlisting language="js" linenumbering="unnumbered">GET _xpack/watcher/watch/my_watch</programlisting>
<remark> CONSOLE</remark>
<remark> TEST[setup:my_active_watch]</remark>
<programlisting language="js" linenumbering="unnumbered">{
  "found": true,
  "_id": "my_watch",
  "_status": {
    "state" : {
      "active" : true,
      "timestamp" : "2015-08-20T12:21:32.734Z"
    },
    "version": 1,
    "actions": ...
  },
  "watch": ...
}</programlisting>
<remark> TESTRESPONSE[s/2015-08-20T12:21:32.734Z/$body._status.state.timestamp/]</remark>
<remark> TESTRESPONSE[s/"actions": \.\.\./"actions": "$body._status.actions"/]</remark>
<remark> TESTRESPONSE[s/"watch": \.\.\./"watch": "$body.watch"/]</remark>
<simpara>You can deactivate the watch by executing the following API call:</simpara>
<programlisting language="js" linenumbering="unnumbered">PUT _xpack/watcher/watch/my_watch/_deactivate</programlisting>
<remark> CONSOLE</remark>
<remark> TEST[setup:my_active_watch]</remark>
<simpara>The new state of the watch is returned as part of its overall status:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "_status": {
    "state" : {
      "active" : false,
      "timestamp" : "2015-09-04T08:39:46.816Z"
    },
    "actions": ...
  }
}</programlisting>
<remark> TESTRESPONSE[s/2015-09-04T08:39:46.816Z/$body._status.state.timestamp/]</remark>
<remark> TESTRESPONSE[s/"actions": \.\.\./"actions": "$body._status.actions"/]</remark>
</section>
<section id="watcher-api-stats">
<title>Stats API<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/rest-api/watcher/stats.asciidoc">Edit me</ulink></title>
<simpara>The <literal>stats</literal> API returns the current Watcher metrics. You can control what
metrics this API returns using the <literal>metric</literal> parameter.</simpara>
<simpara>The supported metrics are:</simpara>
<informaltable
frame="all"
rowsep="1" colsep="1"
>
<tgroup cols="2">
<colspec colname="col_1" colwidth="50*"/>
<colspec colname="col_2" colwidth="50*"/>
<thead>
<row>
<entry align="left" valign="top"> Metric               </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>executing_watches</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Include the current executing watches in the response.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>queued_watches</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Include the watches queued for execution in the response.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>_all</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Include all metrics in the response.</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
<simpara>The Watcher <literal>stats</literal> API always returns basic metrics regardless of the
<literal>metric</literal> option. The following example calls the <literal>stats</literal> API including the
basic metrics:</simpara>
<programlisting language="js" linenumbering="unnumbered">GET _xpack/watcher/stats</programlisting>
<remark> CONSOLE</remark>
<simpara>A successful call returns a JSON structure similar to the following example:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
   "watcher_state": "started",  <co id="CO72-1"/>
   "watch_count": 1, <co id="CO72-2"/>
   "execution_thread_pool": {
      "size": 1000, <co id="CO72-3"/>
      "max_size": 1 <co id="CO72-4"/>
   }
}</programlisting>
<calloutlist>
<callout arearefs="CO72-1">
<para>
The current state of watcher. May be either <literal>started</literal>, <literal>starting</literal> or <literal>stopped</literal>.
</para>
</callout>
<callout arearefs="CO72-2">
<para>
The number of watches currently registered.
</para>
</callout>
<callout arearefs="CO72-3">
<para>
The number of watches that were triggered and currently queued for execution.
</para>
</callout>
<callout arearefs="CO72-4">
<para>
The largest size of the execution thread pool indicating the largest number
    of concurrent executing watches.
</para>
</callout>
</calloutlist>
<section id="_current_executing_watches_metric">
<title>Current executing watches metric<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/rest-api/watcher/stats.asciidoc">Edit me</ulink></title>
<simpara>The current executing watches metric gives insight into the watches that are
currently being executed by Watcher. Additional information is shared per
watch that is currently executing. This information includes the <literal>watch_id</literal>,
the time its execution started and its current execution phase.</simpara>
<simpara>To include this metric, the <literal>metric</literal> option should be set to <literal>executing_watches</literal>
or <literal>_all</literal>.</simpara>
<simpara>The following example specifies the <literal>metric</literal> option as a query string argument
and will include the basic metrics and metrics about the current executing watches:</simpara>
<programlisting language="js" linenumbering="unnumbered">GET _xpack/watcher/stats?metric=executing_watches</programlisting>
<remark> CONSOLE</remark>
<simpara>The following example specifies the <literal>metric</literal> option as part of the url path:</simpara>
<programlisting language="js" linenumbering="unnumbered">GET _xpack/watcher/stats/current_watches</programlisting>
<remark> CONSOLE</remark>
<simpara>The following snippet shows an example of a successful JSON response that
captures a watch in execution:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
   "watcher_state": "started",
   "watch_count": 2,
   "execution_thread_pool": {
      "queue_size": 1000,
      "max_size": 20
   },
   "current_watches": [ <co id="CO73-1"/>
      {
         "watch_id": "slow_condition", <co id="CO73-2"/>
         "watch_record_id": "slow_condition_3-2015-05-13T07:42:32.179Z", <co id="CO73-3"/>
         "triggered_time": "2015-05-12T11:53:51.800Z", <co id="CO73-4"/>
         "execution_time": "2015-05-13T07:42:32.179Z", <co id="CO73-5"/>
         "execution_phase": "condition" <co id="CO73-6"/>
      }
   ]
}</programlisting>
<calloutlist>
<callout arearefs="CO73-1">
<para>
A list of all the Watches that are currently being executed by Watcher.
    When no watches are currently executing an empty array is returned. The
    captured watches are sorted by execution time in descending order. Thus the
    longest running watch is always at the top.
</para>
</callout>
<callout arearefs="CO73-2">
<para>
The id of the watch being executed.
</para>
</callout>
<callout arearefs="CO73-3">
<para>
The id of the watch record.
</para>
</callout>
<callout arearefs="CO73-4">
<para>
The time the watch was triggered by the trigger engine.
</para>
</callout>
<callout arearefs="CO73-5">
<para>
The time the watch was executed. This is just before the input is being
    executed.
</para>
</callout>
<callout arearefs="CO73-6">
<para>
The current watch execution phase. Can be <literal>input</literal>, <literal>condition</literal> or <literal>action</literal>.
</para>
</callout>
</calloutlist>
</section>
<section id="_queued_watches_metric">
<title>Queued watches metric<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/rest-api/watcher/stats.asciidoc">Edit me</ulink></title>
<simpara>Watcher moderates the execution of watches such that their execution won&#8217;t put
too much pressure on the node and its resources. If too many watches trigger
concurrently and there isn&#8217;t enough capacity to execute them all, some of the
watches are queued, waiting for the current executing watches to finish their
execution. The queued watches metric gives insight on these queued watches.</simpara>
<simpara>To include this metric, the <literal>metric</literal> option should include <literal>queued_watches</literal> or
<literal>_all</literal>.</simpara>
<simpara>The following example specifies the <literal>queued_watches</literal> metric option and includes
both the basic metrics and the queued watches:</simpara>
<programlisting language="js" linenumbering="unnumbered">GET _xpack/watcher/stats/queued_watches</programlisting>
<remark> CONSOLE</remark>
<simpara>An example of a successful JSON response that captures a watch in execution:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
   "watcher_state": "started",
   "watch_count": 10,
   "execution_thread_pool": {
      "queue_size": 1000,
      "max_size": 20
   },
   "queued_watches": [ <co id="CO74-1"/>
         {
            "watch_id": "slow_condition4", <co id="CO74-2"/>
            "watch_record_id": "slow_condition4_223-2015-05-21T11:59:59.811Z", <co id="CO74-3"/>
            "triggered_time": "2015-05-21T11:59:59.811Z", <co id="CO74-4"/>
            "execution_time": "2015-05-21T11:59:59.811Z" <co id="CO74-5"/>
         },
      ...
   ]
}</programlisting>
<calloutlist>
<callout arearefs="CO74-1">
<para>
A list of all watches that are currently queued for execution. When no
    watches are queued, an empty array is returned.
</para>
</callout>
<callout arearefs="CO74-2">
<para>
The id of the watch queued for execution.
</para>
</callout>
<callout arearefs="CO74-3">
<para>
The id of the watch record.
</para>
</callout>
<callout arearefs="CO74-4">
<para>
The time the watch was triggered by the trigger engine.
</para>
</callout>
<callout arearefs="CO74-5">
<para>
The time the watch was went into a queued state.
</para>
</callout>
</calloutlist>
</section>
</section>
<section id="watcher-api-stop">
<title>Stop API<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/rest-api/watcher/stop.asciidoc">Edit me</ulink></title>
<simpara>The <literal>stop</literal> API stops the Watcher service if the service is running, as in the
following example:</simpara>
<programlisting language="js" linenumbering="unnumbered">POST _xpack/watcher/_stop</programlisting>
<remark> CONSOLE</remark>
<simpara>Watcher returns the following response if the request is successful:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
   "acknowledged": true
}</programlisting>
<remark> TESTRESPONSE</remark>
</section>
<section id="watcher-api-start">
<title>Start API<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/rest-api/watcher/start.asciidoc">Edit me</ulink></title>
<simpara>The <literal>start</literal> API starts the Watcher service if the service is not already
running, as in the following example:</simpara>
<programlisting language="js" linenumbering="unnumbered">POST _xpack/watcher/_start</programlisting>
<remark> CONSOLE</remark>
<simpara>Watcher returns the following response if the request is successful:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
   "acknowledged": true
}</programlisting>
<remark> TESTRESPONSE</remark>
</section>
<section id="watcher-api-restart">
<title>Restart API<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/rest-api/watcher/restart.asciidoc">Edit me</ulink></title>
<simpara>The <literal>restart</literal> API stops, then starts the Watcher service, as in the
following example:</simpara>
<programlisting language="js" linenumbering="unnumbered">POST _xpack/watcher/_restart</programlisting>
<remark> CONSOLE</remark>
<simpara>Watcher returns the following response if the request is successful:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
   "acknowledged": true
}</programlisting>
<remark> TESTRESPONSE</remark>
</section>
</chapter>
<chapter id="graph-api">
<title>Graph APIs<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/rest-api/graph.asciidoc">Edit me</ulink></title>
<itemizedlist>
<listitem>
<simpara>
<xref linkend="graph-api-explore"/>
</simpara>
</listitem>
</itemizedlist>
<section id="graph-api-explore">
<title>Explore API<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/rest-api/graph/explore.asciidoc">Edit me</ulink></title>
<simpara>The Graph "explore" API is accessible via the /_xpack/graph/_explore endpoint.
One of the best ways to understand the behaviour of this API is to use the Kibana
Graph UI to visually click around connected data and then view the "Last request"
panel (accessible from the button with the cog icon). This panel shows the JSON request/response
pair of the last user operation.</simpara>
<informalfigure>
<mediaobject>
  <imageobject>
  <imagedata fileref="images/graph/spy.jpg"/>
  </imageobject>
  <textobject><phrase>Viewing the last request in the Kibana Graph UI</phrase></textobject>
</mediaobject>
</informalfigure>
<itemizedlist>
<listitem>
<simpara>
<link linkend="basic-search">Basic exploration</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="optional-controls">Optional controls</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="spider-search">"Spidering" operations</link>
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="basic-search" renderas="sect2">Basic exploration<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/rest-api/graph/explore.asciidoc">Edit me</ulink></bridgehead>
<simpara>An initial search typically begins with a query to identify strongly related terms.</simpara>
<programlisting language="js" linenumbering="unnumbered">POST clicklogs/_xpack/graph/_explore
{
    "query": { <co id="CO75-1"/>
        "match": {
            "query.raw": "midi"
        }
    },
    "vertices": [ <co id="CO75-2"/>
        {
            "field": "product"
        }
    ],
    "connections": {  <co id="CO75-3"/>
        "vertices": [
            {
                "field": "query.raw"
            }
        ]
    }
}</programlisting>
<remark> CONSOLE</remark>
<calloutlist>
<callout arearefs="CO75-1">
<para>
A query is used to "seed" the exploration - here we are looking in clicklogs for people who searched for "midi". Any of the
usual elasticsearch query syntax can be used here to identify the documents of interest.
</para>
</callout>
<callout arearefs="CO75-2">
<para>
A list of fields is provided - here we want to find product codes that are significantly associated with searches for "midi"
</para>
</callout>
<callout arearefs="CO75-3">
<para>
A list of fields is provided again - here we are looking for other search terms that led people to click on the products found in 2)
</para>
</callout>
</calloutlist>
<note><simpara>Further "connections" can be nested inside the "connections" object to continue exploring out the relationships in the data. Each level of nesting
is commonly referred to as a "hop" and proximity in a graph is often thought of in terms of "hop depth".</simpara></note>
<simpara>The response from a graph exploration is as follows:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
   "took": 0,
   "timed_out": false,
   "failures": [],
   "vertices": [ <co id="CO76-1"/>
      {
         "field": "query.raw",
         "term": "midi cable",
         "weight": 0.08745858139552132,
         "depth": 1
      },
      {
         "field": "product",
         "term": "8567446",
         "weight": 0.13247784285434397,
         "depth": 0
      },
      {
         "field": "product",
         "term": "1112375",
         "weight": 0.018600718471158982,
         "depth": 0
      },
      {
         "field": "query.raw",
         "term": "midi keyboard",
         "weight": 0.04802242866755111,
         "depth": 1
      }
   ],
   "connections": [ <co id="CO76-2"/>
      {
         "source": 0,
         "target": 1,
         "weight": 0.04802242866755111,
         "doc_count": 13
      },
      {
         "source": 2,
         "target": 3,
         "weight": 0.08120623870976627,
         "doc_count": 23
      }
   ]
}</programlisting>
<calloutlist>
<callout arearefs="CO76-1">
<para>
An array of all of the vertices that were discovered. A vertex is an indexed term so the field and term value are supplied. The <literal>weight</literal> attribute denotes a significance score while <literal>depth</literal> is at which hop-level the term was first encountered.
</para>
</callout>
<callout arearefs="CO76-2">
<para>
The connections between the vertices in the array. The <literal>source</literal> and <literal>target</literal> properties are indexes into the vertices array and indicate which vertex term led to the other as part of exploration.
The <literal>doc_count</literal> value indicates how many documents contain this pairing of terms was found in the sample of documents analyzed (this is not a global count for all documents in the index)
</para>
</callout>
</calloutlist>
<simpara>In the Kibana Graph UI response data is visualized in a diagram like this:</simpara>
<informalfigure>
<mediaobject>
  <imageobject>
  <imagedata fileref="images/graph/midiclicks.jpg" contentwidth="50%" align="center"/>
  </imageobject>
  <textobject><phrase>An example visualization of product/search click data using the Kibana Graph UI</phrase></textobject>
</mediaobject>
</informalfigure>
<bridgehead id="optional-controls" renderas="sect2">Optional controls<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/rest-api/graph/explore.asciidoc">Edit me</ulink></bridgehead>
<simpara>The previous basic example omitted several parameters that have default values. This fuller example illustrates the additional parameters that can be used in graph explore requests.</simpara>
<programlisting language="js" linenumbering="unnumbered">POST clicklogs/_xpack/graph/_explore
{
   "query": {<co id="CO77-1"/>
      "bool": {
         "must": {
            "match": {
               "query.raw": "midi"
            }
         },
         "filter": [
            {
               "range": {
                  "query_time": {
                     "gte": "2015-10-01 00:00:00"
                  }
               }
            }
         ]
      }
   },
   "controls": {
      "use_significance": true,<co id="CO77-2"/>
      "sample_size": 2000,<co id="CO77-3"/>
      "timeout": 2000,<co id="CO77-4"/>
      "sample_diversity": {<co id="CO77-5"/>
         "field": "category.raw",
         "max_docs_per_value": 500
      }
   },
   "vertices": [
      {
         "field": "product",
         "size": 5,<co id="CO77-6"/>
         "min_doc_count": 10,<co id="CO77-7"/>
         "shard_min_doc_count": 3<co id="CO77-8"/>
      }
   ],
   "connections": {
      "query": {<co id="CO77-9"/>
         "bool": {
            "filter": [
               {
                  "range": {
                     "query_time": {
                        "gte": "2015-10-01 00:00:00"
                     }
                  }
               }
            ]
         }
      },
      "vertices": [
         {
            "field": "query.raw",
            "size": 5,
            "min_doc_count": 10,
            "shard_min_doc_count": 3
         }
      ]
   }
}</programlisting>
<remark> CONSOLE</remark>
<calloutlist>
<callout arearefs="CO77-1">
<para>
This seed query iin this example is a more complex query for the word "midi" but with a date filter.
</para>
</callout>
<callout arearefs="CO77-2">
<para>
The <literal>use_significance</literal> flag defaults to true and is used to filter associated terms to only those that are significantly associated with our query.
The algorithm used to calculate significance are explained in the documentation for the <ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-significantterms-aggregation.html">significant_terms aggregation</ulink>.
</para>
</callout>
<callout arearefs="CO77-3">
<para>
Each "hop" considers a sample of the best-matching documents on each shard (default is 100 documents). Using samples has the dual benefit of keeping exploration focused on meaningfully-connected terms and improving the speed of execution. Very small values (less than 50) may not provide sufficient weight-of-evidence to identify significant connections between terms while very large sample sizes may dilute the quality and be slow.
</para>
</callout>
<callout arearefs="CO77-4">
<para>
A <literal>timeout</literal> setting (expressed here in milliseconds) after which exploration will be halted and results gathered so far are returned. This is a best-effort approach to termination so
 may overrun if, for example, a long pause is encountered while FieldData is loaded for a field.
</para>
</callout>
<callout arearefs="CO77-5">
<para>
To avoid the top-matching documents sample being dominated by a single source of results sometimes it can prove necessary to request diversity in the sample. This is achieved by
 selecting a single-value field and a maximum number of documents per value in that field. In this example we are requiring that there are no more than 500 click documents from any one department in the store.
 This might help us consider products from the electronics, book and video departments whereas without this diversification our results may be entirely dominated by the electronics department.
</para>
</callout>
<callout arearefs="CO77-6">
<para>
We can control the maximum number of vertex terms returned for each field using the <literal>size</literal> property (default is 5)
</para>
</callout>
<callout arearefs="CO77-7">
<para>
<literal>min_doc_count</literal> acts as a certainty threshold - just how many documents have to contain a pair of terms before we consider this to be a useful connection? (default is 3)
</para>
</callout>
<callout arearefs="CO77-8">
<para>
<literal>shard_min_doc_count</literal> is an advanced setting - just how many documents on a shard have to contain a pair of terms before we return this for global consideration? (default is 2)
</para>
</callout>
<callout arearefs="CO77-9">
<para>
Optionally, a "guiding query" can be used to guide the Graph API as it explores connected terms. In this case we are guiding the hop from products to related queries by only considering documents that are also clicks that have been recorded recently.
</para>
</callout>
</calloutlist>
<simpara>The default settings are configured to remove noisy data and get "the big picture" from data. For more detailed forensic type work where every document could be of interest see the <link linkend="graph-troubleshooting">troubleshooting guide</link> for tips on tuning the settings for this type of work.</simpara>
<bridgehead id="spider-search" renderas="sect2">"Spidering" operations<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/rest-api/graph/explore.asciidoc">Edit me</ulink></bridgehead>
<simpara>After an initial search users typically want to review the results using a form of graph visualization tool like the one in the Kibana Graph UI.
Users will frequently then select one or more vertices of interest and ask to load more vertices that may be connected to their current selection. In graph-speak, this operation is often called "spidering" or "spidering out".</simpara>
<simpara>In order to spider out it is typically necessary to define two things:</simpara>
<itemizedlist>
<listitem>
<simpara>
The set of vertices from which you would like to spider
</simpara>
</listitem>
<listitem>
<simpara>
The set of vertices you already have in your workspace which you want to avoid seeing again in results
</simpara>
</listitem>
</itemizedlist>
<simpara>These two pieces of information when passed to the Graph API will ensure you are returned new vertices that can be attached to the existing selection.
An example request is as follows:</simpara>
<programlisting language="js" linenumbering="unnumbered">POST clicklogs/_xpack/graph/_explore
{
   "vertices": [
      {
         "field": "product",
         "include": [ "1854873" ] <co id="CO78-1"/>
      }
   ],
   "connections": {
      "vertices": [
         {
            "field": "query.raw",
            "exclude": [ <co id="CO78-2"/>
               "midi keyboard",
               "midi",
               "synth"
            ]
         }
      ]
   }
}</programlisting>
<remark> CONSOLE</remark>
<calloutlist>
<callout arearefs="CO78-1">
<para>
Here we list the mandatory start points from which we want to spider using an <literal>include</literal> array of the terms of interest (in this case a single product code). Note that because
we have an <literal>include</literal> clause here there is no need to define a seed query - we are implicitly querying for documents that contain any of the terms
listed in our include clauses. Instead of passing plain strings in this array it is also possible to pass objects with <literal>term</literal> and <literal>boost</literal> values to
boost matches on certain terms over others.
</para>
</callout>
<callout arearefs="CO78-2">
<para>
The <literal>exclude</literal> clause avoids returning specific terms. Here we are asking for more search terms that have led people to click on product 1854873 but explicitly exclude the search terms the client already
knows about.
</para>
</callout>
</calloutlist>
<simpara>The <literal>include`and `exclude</literal> clauses provide the essential features that enable clients to progressively build up a picture of related information in their workspace.
The <literal>include</literal> clause is used to define the set of start points from which users wish to spider. Include clauses can also be used to limit the end points users wish to reach, thereby "filling in" some of the missing links between existing vertices in their client-side workspace.
The <literal>exclude</literal> clause can be used to avoid the Graph API returning vertices already visible in a client&#8217;s workspace or perhaps could list undesirable vertices that the client has blacklisted from their workspace and never wants to see returned.</simpara>
</section>
</chapter>
</part>
<part id="xpack-troubleshooting">
<title>Troubleshooting <ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-troubleshooting.asciidoc">Edit me</ulink></title>
<partintro>
<simpara>Having trouble? Here are solutions to common problems you might encounter
while using X-Pack. If you can&#8217;t find the answer you need here, give a
shout out for help in our <ulink url="https://discuss.elastic.co/c/x-pack">Discuss forum</ulink>.</simpara>
<itemizedlist>
<listitem>
<simpara>
<link linkend="security-troubleshooting">X-Pack security</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="watcher-troubleshooting">Watcher</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="graph-troubleshooting">X-Pack graph</link>
</simpara>
</listitem>
</itemizedlist>
<remark> * &lt;&lt;monitoring-troubleshooting, {monitoring}&gt;&gt;</remark>
<remark> * &lt;&lt;reporting-troubleshooting, {reporting}&gt;&gt;</remark>
</partintro>
<chapter id="security-troubleshooting">
<title>X-Pack security Troubleshooting<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/troubleshooting.asciidoc">Edit me</ulink></title>
<bridgehead id="_literal_settings_literal" renderas="sect2"><literal>settings</literal><ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/troubleshooting.asciidoc">Edit me</ulink></bridgehead>
<variablelist>
<varlistentry>
<term>
Some settings are not returned via the nodes settings API
</term>
<listitem>
<simpara>This is intentional. Some of the settings are considered to be highly
sensitive: all <literal>ssl</literal> settings, ldap <literal>bind_dn</literal>, <literal>bind_password</literal>).
For this reason, we filter these  settings and do not expose them via
the nodes info API rest endpoint. You can also define additional
sensitive settings that should be hidden  using the
<literal>xpack.security.hide_settings</literal> setting. For example, this snippet
hides the <literal>url</literal> settings of the <literal>ldap1</literal> realm and all settings of the
<literal>ad1</literal> realm.</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.security.hide_settings: xpack.security.authc.realms.ldap1.url, xpack.security.authc.realms.ad1.*</programlisting>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="_literal_users_literal" renderas="sect2"><literal>users</literal><ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/troubleshooting.asciidoc">Edit me</ulink></bridgehead>
<variablelist>
<varlistentry>
<term>
I configured the appropriate roles and the users, but I still get an authorization exception
</term>
<listitem>
<simpara>Verify that the role names associated with the users match the roles defined in the <literal>roles.yml</literal> file. You
can use the <literal>users</literal> tool to list all the users. Any unknown roles are marked with <literal>*</literal>.</simpara>
<programlisting language="shell" linenumbering="unnumbered">bin/xpack/users list
rdeniro        : admin
alpacino       : power_user
jacknich       : monitoring,unknown_role* <co id="CO79-1"/></programlisting>
<calloutlist>
<callout arearefs="CO79-1">
<para>
<literal>unknown_role</literal> was not found in <literal>roles.yml</literal>
</para>
</callout>
</calloutlist>
</listitem>
</varlistentry>
<varlistentry>
<term>
ERROR: extra arguments [&#8230;] were provided
</term>
<listitem>
<simpara>This error occurs when the <literal>users</literal> tool is parsing the input and finds unexepected arguments. This can happen when there
are special characters used in some of the arguments. For example, on Windows systems the <literal>,</literal> character is considered
a parameter separator; in other words <literal>-r role1,role2</literal> is translated to <literal>-r role1 role2</literal> and the <literal>users</literal> tool only recognizes
<literal>role1</literal> as an expected parameter. The solution here is to quote the parameter: <literal>-r "role1,role2"</literal>.</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="trouble-shoot-active-directory" renderas="sect2">Active Directory<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/troubleshooting.asciidoc">Edit me</ulink></bridgehead>
<variablelist>
<varlistentry>
<term>
Certain users are being frequently locked out of Active Directory
</term>
<listitem>
<simpara>Check your realm configuration; realms are checked serially, one after another. If your Active Directory realm is being checked before other realms and there are usernames
that appear in both Active Directory and another realm, a valid login for one realm may be causing failed login attempts in another realm.</simpara>
<simpara>For example, if <literal>UserA</literal> exists in both Active Directory and a file realm, and the Active Directory realm is checked first and
file is checked second, an attempt to authenticate as <literal>UserA</literal> in the file realm would first attempt to authenticate
against Active Directory and fail, before successfully authenticating against the <literal>file</literal> realm. Because authentication is
verified on each request, the Active Directory realm would be checked - and fail - on each request for <literal>UserA</literal> in the <literal>file</literal>
realm. In this case, while the authentication request completed successfully, the account on Active Directory would have received
several failed login attempts, and that account may become temporarily locked out. Plan the order of your realms accordingly.</simpara>
<simpara>Also note that it is not typically necessary to define multiple Active Directory realms to handle domain controller failures. When using Microsoft DNS, the DNS entry for the domain should always point to an available domain controller.</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="_ldap" renderas="sect2">LDAP<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/troubleshooting.asciidoc">Edit me</ulink></bridgehead>
<variablelist>
<varlistentry>
<term>
I can authenticate to LDAP, but I still get an authorization exception
</term>
<listitem>
<simpara>A number of configuration options can cause this error.</simpara>
<informaltable
frame="all"
rowsep="1" colsep="1"
>
<tgroup cols="2">
<colspec colname="col_1" colwidth="50*"/>
<colspec colname="col_2" colwidth="50*"/>
<tbody>
<row>
<entry align="left" valign="top"><simpara><emphasis>group identification</emphasis></simpara></entry>
<entry align="left" valign="top"><simpara>Groups are located by either an LDAP search or by the "memberOf" attribute on
the user.  Also, If subtree search is turned off, it will search only one
level deep.  See the <link linkend="ldap-settings">LDAP Settings</link> for all the options.
There are many options here and sticking to the defaults will not work for all
scenarios.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><emphasis>group to role mapping</emphasis></simpara></entry>
<entry align="left" valign="top"><simpara>Either the <literal>role_mapping.yml</literal> file or the location for this file could be
misconfigured. See <link linkend="security-files">Security Files</link> for more.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><emphasis>role definition</emphasis></simpara></entry>
<entry align="left" valign="top"><simpara>The role definition may be missing or invalid.</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
<simpara>To help track down these possibilities, add the following lines to the end of the <literal>log4j2.properties</literal> configuration file in the
<literal>CONFIG_DIR</literal>:</simpara>
<programlisting language="properties" linenumbering="unnumbered">logger.authc.name = org.elasticsearch.xpack.security.authc
logger.authc.level = DEBUG</programlisting>
<simpara>A successful authentication should produce debug statements that list groups and role mappings.</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="_encryption_amp_certificates" renderas="sect2">Encryption &amp; Certificates<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/troubleshooting.asciidoc">Edit me</ulink></bridgehead>
<variablelist>
<varlistentry>
<term>
<literal>curl</literal> on the Mac returns a certificate verification error even when the <literal>--cacert</literal> option is used
</term>
<listitem>
<simpara>Apple&#8217;s integration of <literal>curl</literal> with their keychain technology disables the <literal>--cacert</literal> option.
See <ulink url="http://curl.haxx.se/mail/archive-2013-10/0036.html">http://curl.haxx.se/mail/archive-2013-10/0036.html</ulink> for more information.</simpara>
<simpara>You can use another tool, such as <literal>wget</literal>, to test certificates. Alternately, you can add the certificate for the
signing certificate authority MacOS system keychain, using a procedure similar to the one detailed at the
<ulink url="http://support.apple.com/kb/PH14003">Apple knowledge base</ulink>. Be sure to add the signing CA&#8217;s certificate and not the server&#8217;s certificate.</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="_sslhandshakeexception_causing_connections_to_fail" renderas="sect3">SSLHandshakeException causing connections to fail<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/troubleshooting.asciidoc">Edit me</ulink></bridgehead>
<simpara>A <literal>SSLHandshakeException</literal> will cause a connection to a node to fail and indicates that there is a configuration issue. Some of the
common exceptions are shown below with tips on how to resolve these issues.</simpara>
<variablelist>
<varlistentry>
<term>
<literal>java.security.cert.CertificateException: No name matching node01.example.com found</literal>
</term>
<listitem>
<simpara>Indicates that a client connection was made to <literal>node01.example.com</literal> but the certificate returned did not contain the name <literal>node01.example.com</literal>.
In most cases, the issue can be resolved by ensuring the name is specified during <link linkend="generating-signed-certificates">certificate creation</link>.
Another scenario is when the environment does not wish to use DNS names in certificates at all. In this scenario, all settings
in <literal>elasticsearch.yml</literal> should only use IP addresses including the <literal>network.publish_host</literal> setting.</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>java.security.cert.CertificateException: No subject alternative names present</literal>
</term>
<listitem>
<simpara>Indicates that a client connection was made to an IP address but the returned certificate did not contain any <literal>SubjectAlternativeName</literal> entries.
IP addresses are only used for hostname verification if they are specified as a <literal>SubjectAlternativeName</literal> during
<link linkend="generating-signed-certificates">certificate creation</link>. If the intent was to use IP addresses for hostname verification, then the certificate
will need to be regenerated with the appropriate IP address.</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>javax.net.ssl.SSLHandshakeException: null cert chain</literal> and <literal>javax.net.ssl.SSLException: Received fatal alert: bad_certificate</literal>
</term>
<listitem>
<simpara>The <literal>SSLHandshakeException</literal> above indicates that a self-signed certificate was returned by the client that is not trusted
as it cannot be found in the <literal>truststore</literal> or <literal>keystore</literal>. The <literal>SSLException</literal> above is seen on the client side of the connection.</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target</literal> and <literal>javax.net.ssl.SSLException: Received fatal alert: certificate_unknown</literal>
</term>
<listitem>
<simpara>The <literal>SunCertPathBuilderException</literal> above indicates that a certificate was returned during the handshake that is not trusted.
This message is seen on the client side of the connection. The <literal>SSLException</literal> above is seen on the server side of the
connection. The CA certificate that signed the returned certificate was not found in the <literal>keystore</literal> or <literal>truststore</literal> and
needs to be added to trust this certificate.</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="_other_ssl_tls_related_exceptions" renderas="sect3">Other SSL/TLS related exceptions<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/troubleshooting.asciidoc">Edit me</ulink></bridgehead>
<simpara>The are other exceptions related to SSL that may be seen in the logs. Below you will find some common exceptions and their
meaning.</simpara>
<variablelist>
<varlistentry>
<term>
WARN: received plaintext http traffic on a https channel, closing connection
</term>
<listitem>
<simpara>Indicates that there was an incoming plaintext http request. This typically occurs when an external applications attempts
to make an unencrypted call to the REST interface. Please ensure that all applications are using <literal>https</literal> when calling the
REST interface with SSL enabled.</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>org.elasticsearch.common.netty.handler.ssl.NotSslRecordException: not an SSL/TLS record:</literal>
</term>
<listitem>
<simpara>Indicates that there was incoming plaintext traffic on an SSL connection. This typically occurs when a node is not
configured to use encrypted communication and tries to connect to nodes that are using encrypted communication. Please
verify that all nodes are using the same setting for <literal>xpack.security.transport.ssl.enabled</literal>.</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>java.io.StreamCorruptedException: invalid internal transport message format, got</literal>
</term>
<listitem>
<simpara>Indicates an issue with data received on the transport interface in an unknown format. This can happen when a node with
encrypted communication enabled connects to a node that has encrypted communication disabled. Please verify that all
nodes are using the same setting for <literal>xpack.security.transport.ssl.enabled</literal>.</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>java.lang.IllegalArgumentException: empty text</literal>
</term>
<listitem>
<simpara>The exception is typically seen when a <literal>https</literal> request is made to a node that is not using <literal>https</literal>. If <literal>https</literal> is desired,
please ensure the following setting is in <literal>elasticsearch.yml</literal>:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.security.http.ssl.enabled: true</programlisting>
</listitem>
</varlistentry>
<varlistentry>
<term>
ERROR: unsupported ciphers [&#8230;] were requested but cannot be used in this JVM
</term>
<listitem>
<simpara>This error occurs when a SSL/TLS cipher suite is specified that cannot supported by the JVM that Elasticsearch is running
in. Security will try to use the specified cipher suites that are supported by this JVM. This error can occur when using
the Security defaults as some distributions of OpenJDK do not enable the PKCS11 provider by default. In this case, we
recommend consulting your JVM documentation for details on how to enable the PKCS11 provider.</simpara>
<simpara>Another common source of this error is requesting cipher suites that use encrypting with a key length greater than 128 bits
when running on an Oracle JDK. In this case, you will need to install the <link linkend="ciphers">JCE Unlimited Strength Jurisdiction Policy Files</link>.</simpara>
</listitem>
</varlistentry>
</variablelist>
</chapter>
<chapter id="watcher-troubleshooting">
<title>Watcher Troubleshooting<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/troubleshooting.asciidoc">Edit me</ulink></title>
<bridgehead id="_dynamic_mapping_error_when_trying_to_add_a_watch" renderas="sect2">Dynamic Mapping Error When Trying to Add a Watch<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/troubleshooting.asciidoc">Edit me</ulink></bridgehead>
<simpara>If you get the <emphasis>Dynamic Mapping is Disabled</emphasis> error when you try to add a watch,
verify that the index mappings for the <literal>.watches</literal> index are available. You can
do that by submitting the following request:</simpara>
<programlisting language="js" linenumbering="unnumbered">GET .watches/_mapping</programlisting>
<remark> CONSOLE</remark>
<remark> TEST[setup:my_active_watch]</remark>
<simpara>If the index mappings are missing, follow these steps to restore the correct
mappings:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Stop the Elasticsearch node.
</simpara>
</listitem>
<listitem>
<simpara>
Add <literal>xpack.watcher.index.rest.direct_access : true</literal> to <literal>elasticsearch.yml</literal>.
</simpara>
</listitem>
<listitem>
<simpara>
Restart the Elasticsearch node.
</simpara>
</listitem>
<listitem>
<simpara>
Delete the <literal>.watches</literal> index:
</simpara>
<programlisting language="js" linenumbering="unnumbered">DELETE .watches</programlisting>
</listitem>
<listitem>
<simpara>
Disable direct access to the <literal>.watches</literal> index:
</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>
Stop the Elasticsearch node.
</simpara>
</listitem>
<listitem>
<simpara>
Remove <literal>xpack.watcher.index.rest.direct_access : true</literal> from <literal>elasticsearch.yml</literal>.
</simpara>
</listitem>
<listitem>
<simpara>
Restart the Elasticsearch node.
</simpara>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
<bridgehead id="_unable_to_send_email" renderas="sect2">Unable to Send Email<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/troubleshooting.asciidoc">Edit me</ulink></bridgehead>
<simpara>If you get an authentication error indicating that you need to continue the
sign-in process from a web browser when Watcher attempts to send email, you need
to configure Gmail to
<ulink url="https://support.google.com/accounts/answer/6010255?hl=en">Allow Less Secure Apps to access your account</ulink>.</simpara>
<simpara>If you have two-step verification enabled for your email account, you must
generate and use an App Specific password to send email from Watcher. For more
information, see:</simpara>
<itemizedlist>
<listitem>
<simpara>
Gmail: <ulink url="https://support.google.com/accounts/answer/185833?hl=en">Sign in using App Passwords</ulink>
</simpara>
</listitem>
<listitem>
<simpara>
Outlook.com: <ulink url="http://windows.microsoft.com/en-us/windows/app-passwords-two-step-verification">App passwords and two-step verification</ulink>
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_watcher_not_responsive" renderas="sect2">Watcher Not Responsive<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/troubleshooting.asciidoc">Edit me</ulink></bridgehead>
<simpara>Keep in mind that there&#8217;s no built-in validation of scripts that you add to a
watch. Buggy or deliberately malicious scripts can negatively impact Watcher
performance. For example, if you add multiple watches with buggy script
conditions in a short period of time, Watcher might be temporarily unable to
process watches until the bad watches time out.</simpara>
<remark> include::marvel/troubleshooting.asciidoc[]</remark>
<remark> include::reporting/troubleshooting.asciidoc[]</remark>
</chapter>
<chapter id="graph-troubleshooting">
<title>X-Pack graph Troubleshooting<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/graph/troubleshooting.asciidoc">Edit me</ulink></title>
<bridgehead id="_why_are_results_missing" renderas="sect2">Why are results missing?<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/graph/troubleshooting.asciidoc">Edit me</ulink></bridgehead>
<simpara>The default settings in Graph API requests are configured to tune out noisy results by using the following strategies:</simpara>
<itemizedlist>
<listitem>
<simpara>
Only looking at samples of the most-relevant documents for a query
</simpara>
</listitem>
<listitem>
<simpara>
Only considering terms that have a significant statistical correlation with the sample
</simpara>
</listitem>
<listitem>
<simpara>
Only considering terms to be paired that have at least 3 documents asserting that connection
</simpara>
</listitem>
</itemizedlist>
<simpara>These are useful defaults for "getting the big picture" signals from noisy data but for detailed forensic type work these
default settings could miss details from individual documents. To ensure a graph exploration produces all data consider changing the following settings:</simpara>
<itemizedlist>
<listitem>
<simpara>
Increase the <literal>sample_size</literal> to a larger number of documents to analyse more data on each shard.
</simpara>
</listitem>
<listitem>
<simpara>
Set the <literal>use_significance</literal> setting to <literal>false</literal> to retrieve terms regardless of any statistical correlation with the sample
</simpara>
</listitem>
<listitem>
<simpara>
Set the <literal>min_doc_count</literal> for your vertices to 1 to ensure only one document is required to assert a relationship.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_what_can_i_do_to_to_improve_performance" renderas="sect2">What can I do to to improve performance?<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/graph/troubleshooting.asciidoc">Edit me</ulink></bridgehead>
<simpara>With the default setting of <literal>use_significance</literal> set to <literal>true</literal> the Graph API will be performing a background frequency check of the terms
it discovers as part of exploration. Each unique term has to have its frequency looked up in the index which costs at least one disk seek.
Disk seeks are expensive so if the noise-filtering aspects of the Graph API are not required then setting the <literal>use_significance</literal> setting
to <literal>false</literal> will eliminate all of these expensive checks (but also any quality-filtering of terms).</simpara>
<simpara>If the significance noise-filtering features are required there are three ways to reduce the number of checks it performs:</simpara>
<itemizedlist>
<listitem>
<simpara>
Consider less documents by decreasing the <literal>sample_size</literal>. Considering less documents can actually be better if the quality of matches is quite variable.
</simpara>
</listitem>
<listitem>
<simpara>
Avoid noisy documents that have very many terms. This can be achieved either through allowing ranking to naturally favour shorter documents in our top-results sample (see <ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/current/norms.html">enabling norms</ulink>)
or by explicitly excluding large documents using criteria in the seed and guiding queries passed to the Graph API.
</simpara>
</listitem>
<listitem>
<simpara>
Consider less terms overall. By increasing the <literal>shard_min_doc_count</literal> from its default of 2 documents to just 3 we will typically consider significantly fewer terms.
Many many terms occur very infrequently so even increasing the frequency threshold by one should massively reduce the number of candidate terms whose background frequencies will be checked.
</simpara>
</listitem>
</itemizedlist>
<simpara>The downside of all of these tweaks is that they reduce the scope of information analysed and can increase the potential to miss what could be interesting details.
The information we lose however tends to be lower-quality documents with lower-frequency terms and so can be an acceptable trade-off.</simpara>
</chapter>
</part>
<part id="xpack-limitations">
<title>Limitations <ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-limitations.asciidoc">Edit me</ulink></title>
<partintro>
<blockquote>
<attribution>
Brendan Francis Behan
</attribution>
<simpara>Once we accept our limits, we go beyond them.</simpara>
</blockquote>
<itemizedlist>
<listitem>
<simpara>
<link linkend="security-limitations">X-Pack security</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="watcher-limitations">Watcher</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="graph-limitations">X-Pack graph</link>
</simpara>
</listitem>
</itemizedlist>
<remark> * &lt;&lt;monitoring-troubleshooting, {monitoring}&gt;&gt;</remark>
<remark> * &lt;&lt;reporting-troubleshooting, {reporting}&gt;&gt;</remark>
</partintro>
<chapter id="security-limitations">
<title>Limitations<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/limitations.asciidoc">Edit me</ulink></title>
<bridgehead id="_plugins" renderas="sect2">Plugins<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/limitations.asciidoc">Edit me</ulink></bridgehead>
<simpara>Elasticsearch&#8217;s plugin infrastructure is extremely flexible in terms of what can
be extended. While it opens up Elasticsearch to a wide variety of (often custom)
additional functionality, when it comes to security, this high extensibility level
comes at a cost. We have no control over the third-party plugins' code (open
source or not) and therefore we cannot guarantee their compliance with X-Pack security.
For this reason, third-party plugins are not officially supported on clusters
with X-Pack security enabled.</simpara>
<bridgehead id="_changes_in_index_wildcard_behavior" renderas="sect2">Changes in Index Wildcard Behavior<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/limitations.asciidoc">Edit me</ulink></bridgehead>
<simpara>Elasticsearch clusters with X-Pack security enabled apply the <literal>/_all</literal> wildcard, and
all other wildcards, to the indices that the current user has privileges for, not
the set of all indices on the cluster. There are two notable results of this
behavior:</simpara>
<itemizedlist>
<listitem>
<simpara>
Elasticsearch clusters with X-Pack security enabled do not honor the <literal>ignore_unavailable</literal>
  option. This behavior means that requests involving indices that the current
  user lacks authorization for throw an <literal>AuthorizationException</literal> error, regardless
  of the option&#8217;s setting.
</simpara>
</listitem>
<listitem>
<simpara>
The <literal>allow_no_indices</literal> option is ignored, resulting in the following behavior:
  when the final set of indices after wildcard expansion and replacement is empty,
  the request throws a <literal>IndexMissingException</literal> error.
</simpara>
</listitem>
</itemizedlist>
<simpara>As a general principle, core Elasticsearch will return empty results in scenarios
where wildcard expansion returns no indices, while Elasticsearch with X-Pack security
returns exceptions. Note that this behavior means that operations with multiple
items will fail the entire set of operations if any one operation throws an
exception due to wildcard expansion resulting in an empty set of authorized
indices.</simpara>
<bridgehead id="_filtered_index_aliases" renderas="sect2">Filtered Index Aliases<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/limitations.asciidoc">Edit me</ulink></bridgehead>
<simpara>Aliases containing filters are not a secure way to restrict access to individual
documents, due to the limitations described in <link linkend="alias-limitations">Index and Field Names Can Be Leaked When Using Aliases</link>.
X-Pack security provides a secure way to restrict access to documents through the
<link linkend="field-and-document-access-control">document-level security</link> feature.</simpara>
<bridgehead id="_field_and_document_level_security_limitations" renderas="sect2">Field and Document Level Security Limitations<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/limitations.asciidoc">Edit me</ulink></bridgehead>
<simpara>When a user&#8217;s role enables document or field level security for an index:</simpara>
<itemizedlist>
<listitem>
<simpara>
The user cannot perform write operations:
</simpara>
<itemizedlist>
<listitem>
<simpara>
The update API isn&#8217;t supported.
</simpara>
</listitem>
<listitem>
<simpara>
Update requests included in bulk requests aren&#8217;t supported.
</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>
The request cache is disabled for search requests.
</simpara>
</listitem>
</itemizedlist>
<simpara>When a user&#8217;s role enables document level security for an index:</simpara>
<itemizedlist>
<listitem>
<simpara>
Document level security isn&#8217;t applied for APIs that aren&#8217;t document based.
  An example is the field stats API.
</simpara>
</listitem>
<listitem>
<simpara>
Document level security doesn&#8217;t affect global index statistics that relevancy
  scoring uses. So this means that scores are computed without taking the role
  query into account. Note that documents not matching with the role query are
  never returned.
</simpara>
</listitem>
<listitem>
<simpara>
The <literal>has_child</literal> and <literal>has_parent</literal> queries aren&#8217;t supported as query in the
  role definition. The <literal>has_child</literal> and <literal>has_parent</literal> queries can be used in the
  search API with document level security enabled.
</simpara>
</listitem>
<listitem>
<simpara>
Any query that makes remote calls to fetch data to query by isn&#8217;t supported.
  The following queries aren&#8217;t supported:
</simpara>
<itemizedlist>
<listitem>
<simpara>
The <literal>terms</literal> query with terms lookup isn&#8217;t supported.
</simpara>
</listitem>
<listitem>
<simpara>
The <literal>geo_shape</literal> query with indexed shapes isn&#8217;t supported.
</simpara>
</listitem>
<listitem>
<simpara>
The <literal>percolate</literal> query isn&#8217;t supported.
</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<bridgehead id="alias-limitations" renderas="sect2">Index and Field Names Can Be Leaked When Using Aliases<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/limitations.asciidoc">Edit me</ulink></bridgehead>
<simpara>Calling certain Elasticsearch APIs on an alias can potentially leak information
about indices that the user isn&#8217;t authorized to access. For example, when you get
the mappings for an alias with the <literal>_mapping</literal> API, the response includes the
index name and mappings for each index that the alias applies to. Similarly, the
response to a <literal>_field_stats</literal> request includes the name of the underlying index,
rather than the alias name.</simpara>
<simpara>Until this limitation is addressed, avoid index and field names that contain
confidential or sensitive information.</simpara>
<bridgehead id="_ldap_realm" renderas="sect2">LDAP Realm<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/limitations.asciidoc">Edit me</ulink></bridgehead>
<simpara>The <link linkend="ldap-realm">LDAP Realm</link> does not currently support the discovery of nested
LDAP Groups.  For example, if a user is a member of <literal>group_1</literal> and <literal>group_1</literal> is a
member of <literal>group_2</literal>, only <literal>group_1</literal> will be discovered. However, the
<link linkend="active-directory-realm">Active Directory Realm</link> <emphasis role="strong">does</emphasis> support transitive
group membership.</simpara>
</chapter>
<chapter id="watcher-limitations">
<title>Limitations<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/limitations.asciidoc">Edit me</ulink></title>
<bridgehead id="_watches_are_not_updated_when_file_based_scripts_change" renderas="sect2">Watches Are Not Updated When File Based Scripts Change<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/limitations.asciidoc">Edit me</ulink></bridgehead>
<simpara>When you refer to a file script in a watch, the watch itself is not updated
if you change the script on the filesystem.</simpara>
<simpara>Currently, the only way to reload a file script in a watch is to delete
the watch and recreate it.</simpara>
<remark> include::marvel/troubleshooting.asciidoc[]</remark>
<remark> include::reporting/troubleshooting.asciidoc[]</remark>
</chapter>
<chapter id="graph-limitations">
<title>Limitations<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/graph/limitations.asciidoc">Edit me</ulink></title>
<bridgehead id="_limited_support_for_multiple_indices" renderas="sect2">Limited Support for Multiple Indices<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/graph/limitations.asciidoc">Edit me</ulink></bridgehead>
<simpara>The Graph API can explore multiple indices, types, or aliases in a
single API request, but the assumption is that each "hop" it performs
is querying the same set of indices. Currently, it is not possible to
take a term found in a field from one index and use that value to explore
connections in <emphasis>a different field</emphasis> held in another type or index.</simpara>
<simpara>A good example of where this might be useful is if an IP address is
found in the <literal>remote_host</literal> field of an index called "weblogs20160101",
you might want to follow that up by looking for the same address in
the <literal>ip_address</literal> field of an index called "knownthreats".</simpara>
<simpara>Supporting this behaviour would require extra mappings to indicate that
the weblogs' <literal>remote_host</literal> field contained values that had currency and
meaning in the <literal>ip_address</literal> field of the threats index.</simpara>
<simpara>Since we do not currently support this translation, you would have to
perform multiple calls to take the values from the weblogs index
response and build them into a separate request to the threats index.</simpara>
</chapter>
</part>
<part id="license-management">
<title>License Management <ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-license.asciidoc">Edit me</ulink></title>
<partintro>
<simpara>When you initially install X-Pack, a 30 day trial license is installed that allows access to all features. At the end of the trial period, you can <ulink url="https://www.elastic.co/subscriptions/">purchase a subscription</ulink> to keep using the full functionality of the X-Pack components.</simpara>
<important><simpara>When your license expires, X-Pack operates in a degraded mode. For more information, see  <link linkend="license-expiration">License Expiration</link>.</simpara></important>
</partintro>
<chapter id="installing-license">
<title>Updating Your License<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-license.asciidoc">Edit me</ulink></title>
<simpara>You can update your license at runtime without shutting down your nodes. License updates take
effect immediately. The license is provided as a <emphasis>JSON</emphasis> file that you install with the <literal>license</literal>
API.</simpara>
<simpara>When Security is enabled, you need cluster admin privileges to install the license.
The <link linkend="built-in-users">built-in <literal>elastic</literal> user</link> has the required privileges.</simpara>
<simpara>To update your license:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Send a request to the <literal>license</literal> API and specify the file that contains your new license:
</simpara>
<programlisting language="shell" linenumbering="unnumbered">curl -XPUT -u elastic 'http://&lt;host&gt;:&lt;port&gt;/_xpack/license' -d @license.json</programlisting>
<simpara>Where:</simpara>
<itemizedlist>
<listitem>
<simpara>
<literal>elastic</literal> is the built-in super user. The default password is <literal>changeme</literal>. If
you haven&#8217;t already, <link linkend="built-in-users">change the default password</link>. Any user
with cluster admin privileges can  install the license.
</simpara>
</listitem>
<listitem>
<simpara>
<literal>&lt;host&gt;</literal> is the hostname of the Elasticsearch node (<literal>localhost</literal> if executing locally)
</simpara>
</listitem>
<listitem>
<simpara>
<literal>&lt;port&gt;</literal> is the http port (defaults to <literal>9200</literal>)
</simpara>
</listitem>
<listitem>
<simpara>
<literal>license.json</literal> is the license JSON file
</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>
If the license you are installing does not support all of the features available with your
previous license, you will be notified in the response. To complete the license installation,
you must resubmit the license update request and set the <literal>acknowledge</literal> parameter to <literal>true</literal> to
indicate that you are aware of the changes.
</simpara>
<programlisting language="shell" linenumbering="unnumbered">curl -XPUT -u elastic 'http://&lt;host&gt;:&lt;port&gt;/_xpack/license?acknowledge=true' -d @license.json</programlisting>
</listitem>
</orderedlist>
</chapter>
<chapter id="listing-licenses">
<title>Viewing the Installed License<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-license.asciidoc">Edit me</ulink></title>
<simpara>You can also use the <literal>license</literal> API to retrieve the currently installed license:</simpara>
<programlisting language="shell" linenumbering="unnumbered">curl -XGET -u elastic:changeme 'http://&lt;host&gt;:&lt;port&gt;/_xpack/license'
{
  "license" : {
    "status" : "active",
    "uid" : "0a98411f-73f4-4c67-954c-724874ed5488",
    "type" : "trial",
    "issue_date" : "2015-10-13T18:18:20.709Z",
    "issue_date_in_millis" : 1444760300709,
    "expiry_date" : "2015-11-12T18:18:20.709Z",
    "expiry_date_in_millis" : 1447352300709,
    "max_nodes" : 1000,
    "issued_to" : "elasticsearch",
    "issuer" : "elasticsearch"
  }
}</programlisting>
<note><simpara>You need cluster admin privileges to retrieve the license.</simpara></note>
</chapter>
<chapter id="license-expiration">
<title>License Expiration<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-license.asciidoc">Edit me</ulink></title>
<simpara>License expiration should never be a surprise. If you&#8217;re using Monitoring, a license expiration
warning is displayed prominently if your license expires within 30 days. Warnings are
also displayed on startup and written to the Elasticsearch log starting 30  days from the expiration date. These error messages tell you when the license expires and what features will be disabled if
you fail to update it.</simpara>
<remark> TODO Update output</remark>
<programlisting language="sh" linenumbering="unnumbered"># License will expire on [Wednesday, May 04, 2016]. If you have a new license, please update it.
# Otherwise, please reach out to your support contact.
#
# Commercial plugins operate with reduced functionality on license expiration:
# - shield
#  - Cluster health, cluster stats and indices stats operations are blocked
#  - All data operations (read and write) continue to work
# - watcher
#  - PUT / GET watch APIs are disabled, DELETE watch API continues to work
#  - Watches execute and write to the history
#  - The actions of the watches don't execute
# - monitoring
#  - The agent will stop collecting cluster and indices metrics
#  - The agent will stop automatically cleaning indices older than [xpack.monitoring.history.duration]
# - graph
#  - Graph explore APIs are disabled</programlisting>
<simpara>Once the license expires, calls to the cluster health, cluster stats, and index stats APIs
fail with a <literal>security_exception</literal> and return a 401 HTTP status code.</simpara>
<remark> TODO Update output</remark>
<programlisting language="sh" linenumbering="unnumbered">{
  "error": {
    "root_cause": [{
      "type": "security_exception",
      "reason": "current license is non-compliant for [shield]",
      "license.expired.feature": "shield"
    }],
    "type": "security_exception",
    "reason": "current license is non-compliant for [shield]",
    "license.expired.feature": "shield"
  },
  "status": 401
}</programlisting>
<simpara>This enables  automatic monitoring systems to easily detect the license failure without immediately impacting other users.</simpara>
<important><simpara>You should update your license as soon as possible. You&#8217;re essentially flying blind when running with an expired license. Access to the cluster health and stats APIs is critical
for monitoring and managing an Elasticsearch cluster.</simpara></important>
</chapter>
</part>
<part id="xpack-release-notes">
<title>Release Notes <ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-release-notes.asciidoc">Edit me</ulink></title>
<partintro>
<simpara>Release notes for all of the X-Pack components:
X-Pack security, X-Pack monitoring, Watcher, X-Pack reporting, and X-Pack graph.</simpara>
<bridgehead id="xpack-change-list" renderas="sect1">Change List<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-release-notes.asciidoc">Edit me</ulink></bridgehead>
<bridgehead id="xpack-5.0.1" renderas="sect2">5.0.1<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>November 15, 2016</simpara>
<bridgehead id="bugs-5.0.1" renderas="sect3">Bug Fixes<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-release-notes.asciidoc">Edit me</ulink></bridgehead>
<variablelist>
<varlistentry>
<term>
Graph
</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>
Fixed the license check so Graph doesn&#8217;t throw an <literal>undefined</literal> error
when Security is disabled and you try to load a workspace URL.
</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>
Monitoring
</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>
Show Replica Count not Replication Factor in Overview.
</simpara>
</listitem>
<listitem>
<simpara>
A non-aliased Monitoring index can now be always be created for the current
day when upgrading from Marvel.
</simpara>
</listitem>
<listitem>
<simpara>
Duplicate shards no longer appear in the shard allocation table.
</simpara>
</listitem>
<listitem>
<simpara>
The Kibana Cluster Summary now always shows the last-known status.
</simpara>
</listitem>
<listitem>
<simpara>
Kibana now makes sure Monitoring is enabled before attempting to send stats.
</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>
Security
</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>
Security can no longer pollute the thread context with incorrect users, which
could cause failures during the discovery process.
</simpara>
</listitem>
<listitem>
<simpara>
Security now honors the <literal>action.destructive_requires_name</literal> setting and
prevents users from deleting indices with wildcards if it is set to <literal>true</literal>.
</simpara>
</listitem>
<listitem>
<simpara>
Made changes to preserve the context when performing internal actions.
This ensures subsequent actions are performed as the correct user.
</simpara>
</listitem>
<listitem>
<simpara>
Files generated by the <literal>certgen</literal> tool now have permissions set to 600
so they aren&#8217;t world-readable.
</simpara>
</listitem>
<listitem>
<simpara>
The Security UI no longer hangs when you configure field-level security when
adding a role.
</simpara>
</listitem>
<listitem>
<simpara>
When running with a Basic License, the login dialog is no longer displayed
and no Security elements are visible in Kibana.
</simpara>
</listitem>
<listitem>
<simpara>
The last sub URL of each Kibana app is no longer cached between sessions.
This means that when a different user logs in, they are longer redirected
to the URLs the previous user viewed last.
</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>
Watcher
</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>
Chain input: An exception is now thrown if the inputs in the chain are
specified with a data structure that does not preserve the input order. The
inputs in a chain must be specified as array elements to guarantee the order
in which the inputs are processed. (JSON does not guarantee the order of
arbitrary objects.)
</simpara>
</listitem>
<listitem>
<simpara>
Watch history template: Removed the unused Watcher plugin version.
</simpara>
</listitem>
<listitem>
<simpara>
Email output: Fixed an error that prevented emails from being sennt when
localhost could not be resolved.
</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="xpack-5.0.0" renderas="sect2">5.0.0<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>October 26, 2016</simpara>
<bridgehead id="breaking-5.0.0" renderas="sect3">Breaking Changes<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-release-notes.asciidoc">Edit me</ulink></bridgehead>
<variablelist>
<varlistentry>
<term>
X-Pack
</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>
All settings have been updated to use the <literal>xpack</literal> prefix. For more
information, see <link linkend="migrating-to-xpack">Migrating to X-Pack</link>.
</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>
Licensing
</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>
Licensing endpoint has been renamed from <literal>/_license</literal> to <literal>/_xpack/license</literal>.
</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>
Monitoring
</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>
<literal>http</literal> exporters no longer honor the <literal>keep_alive</literal> setting as this is handled
by the low-level REST Client.
</simpara>
</listitem>
<listitem>
<simpara>
All <literal>monitoring.agent.*</literal> settings have been changed to more closely
match other monitoring collection settings: <literal>xpack.monitoring.collection.*</literal>
and <literal>xpack.monitoring.exporters.*</literal>.
</simpara>
</listitem>
<listitem>
<simpara>
The Index page&#8217;s Lucene Memory chart was replaced with an Index Memory chart,
which includes a superset of the information. Fielddata, which has become a
significantly less common issue, has been rolled into the Index Memory chart.
</simpara>
</listitem>
<listitem>
<simpara>
To use an external monitoring cluster to monitor an Elasticsearch 5.0
cluster, you must run Elasticsearch 5.0 on the monitoring cluster. For more
information about external monitoring clusters, see <link linkend="monitoring-cluster">Setting up a Separate Monitoring Cluster</link>.
</simpara>
</listitem>
<listitem>
<simpara>
All settings have been updated to use the <literal>xpack.monitoring</literal> prefix. For more
information, see <link linkend="migrating-to-xpack">Migrating to X-Pack</link>.
</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>
Reporting
</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>
Reporting encryption keys configured in <literal>kibana.yml</literal> must now be at least
32 characters.
</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>
Security
</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>
Security encryption keys configured in <literal>kibana.yml</literal> must now be at least
32 characters.
</simpara>
</listitem>
<listitem>
<simpara>
The <link linkend="security-tls-ssl-migrate">SSL configuration settings</link> have been changed
to use an easier to use format that also supports PEM files.
</simpara>
</listitem>
<listitem>
<simpara>
Removed the <literal>files.users</literal> and <literal>files.users_roles</literal> settings from the
<link linkend="file-realm"><literal>file</literal> realm</link>.
</simpara>
</listitem>
<listitem>
<simpara>
Removed the setting that allowed for a custom <literal>roles.yml</literal> file location
to be specified. The <literal>roles.yml</literal> file must always be in the <literal>CONF_DIR/x-pack</literal>
directory.
</simpara>
</listitem>
<listitem>
<simpara>
Removed the setting that allowed for a custom system key location to be
defined. The <literal>system_key</literal> file must always be in the <literal>CONF_DIR/x-pack</literal>
directory.
</simpara>
</listitem>
<listitem>
<simpara>
The <link linkend="audit-log-output"><literal>logfile</literal> output</link> for auditing no longer uses the
log level to determine which events to log. The events are now controlled
in the same way as the <literal>index</literal> output.
</simpara>
</listitem>
<listitem>
<simpara>
Changed the syntax for <link linkend="field-level-security">field-level-security</link>. Roles
stored in the old format in native or file based realm will continue to work
but new roles must use the new format.
</simpara>
</listitem>
<listitem>
<simpara>
The <literal>esusers</literal> realm has been renamed to <literal>file</literal> and the <literal>esusers</literal> command line
tool has been renamed to <literal>users</literal>. Note that the <link linkend="managing-native-users">User and Role APIs</link> are the preferred way to manage internal users.
</simpara>
</listitem>
<listitem>
<simpara>
Elasticsearch enables HTTP compression by default now. To mitigate potential
security risks like the BREACH attack, X-Pack security disables compression if HTTPS
is enabled. If Elasticsearch should compress HTTPS traffic, please explicitly
set &#8216;http.compression` to <literal>true</literal> in `elasticsearch.yml&#8217;.
</simpara>
</listitem>
<listitem>
<simpara>
You must specify all required values to override the global SSL configuration
in a profile. If any values are omitted, the entire configuration falls back to
the global settings,  <literal>xpack.security.ssl.*</literal>.
</simpara>
</listitem>
<listitem>
<simpara>
The <literal>skipSslCheck</literal> and <literal>useUnsafeSessions</literal> for Kibana have been replaced by
<literal>xpack.security.secureCookies</literal> in <literal>kibana.yml</literal>. SSL is now <emphasis>disabled</emphasis> by default.
You can start Kibana without making any changes to <literal>kibana.yml</literal> after you install
X-Pack. Do not deploy to production without <link linkend="encrypting-communications">enabling SSL/TLS encryption</link>!
</simpara>
</listitem>
<listitem>
<simpara>
A default role is now applied to all users, including
<link linkend="anonymous-access">anonymous users</link>. The default role enables users to
access the authenticate endpoint, change their own passwords, and get
information about themselves.
</simpara>
</listitem>
<listitem>
<simpara>
All settings have been updated to use the <literal>xpack.security</literal> prefix. For more
information, see <link linkend="migrating-to-xpack">Migrating to X-Pack</link>.
</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>
Watcher
</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>
The <literal>force</literal> parameter of the <link linkend="watcher-api-delete-watch">Delete Watch Action</link> has been removed.
</simpara>
</listitem>
<listitem>
<simpara>
The use of the <literal>_timestamp</literal> field for the execution time has been removed.
The user now needs to set this explicitly in the <literal>index</literal> action.
</simpara>
</listitem>
<listitem>
<simpara>
The <literal>_xpack/watcher/_start</literal>, <literal>_xpack/watcher/_restart</literal>, and
<literal>_xpack/watcher/_stop</literal> REST endpoints require <literal>POST</literal> actions instead of
<literal>PUT</literal> actions. The <emphasis>deprecated</emphasis> <literal>_watcher/_start</literal>, <literal>_watcher/_restart</literal>, and
<literal>_watcher/_stop</literal> endpoints still allow <literal>PUT</literal>.
</simpara>
</listitem>
<listitem>
<simpara>
Watch history now uses a versioned template. The index names also changed
and contain this version. So instead of <literal>.watch_history_2016.02.03</literal> the new
index name is <literal>.watcher-history-1-2016.02.03</literal>, where <literal>1</literal> is the current
version. If you are using X-Pack security, this might require you to change
roles/permissions because of the different index names! The old index template
named <literal>watch_history</literal> can safely be deleted. However, it does not interfere
with the new index template.
</simpara>
</listitem>
<listitem>
<simpara>
The setting that enables scripting only for Watcher has been renamed from
<literal>script.engine.groovy.inline.elasticsearch-watcher_watch</literal> to
<literal>script.engine.groovy.inline.xpack_watch</literal>.
</simpara>
</listitem>
<listitem>
<simpara>
Elasticsearch has several breaking changes in the query DSL, including that
<literal>search_type=count</literal> is no longer supported. Check to see if your watches use
this search type and upgrade them to use <literal>size: 0</literal> in the request body as
needed. For more information about breaking changes including search changes,
see <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/breaking-changes-5.0.html">breaking changes section in Elasticsearch</ulink>.
</simpara>
</listitem>
<listitem>
<simpara>
All account SMTP timeouts (<literal>smtp.timeout</literal>, <literal>smtp.connection_timeout</literal> and
<literal>smtp.write_timeout</literal>) now require a time value instead of a number in
milliseconds.
</simpara>
</listitem>
<listitem>
<simpara>
The notification settings for PagerDuty, Slack, HipChat, and email have been
moved from <literal>watcher.actions</literal> to <literal>xpack.notification</literal>. You need to update your
Elasticsearch configuration accordingly.
</simpara>
</listitem>
<listitem>
<simpara>
All watcher endpoints have been renamed from <literal>/_watcher/XYZ</literal> to
<literal>/_xpack/watcher/XYZ</literal>. You might need to fix this in external scripts as well
as in your watches.
</simpara>
</listitem>
<listitem>
<simpara>
The notification settings have been stripped of their <literal>service</literal> part. So
<literal>watcher.actions.slack.service.default_account</literal> becomes
<literal>xpack.notification.slack.default_account</literal>
</simpara>
</listitem>
<listitem>
<simpara>
The setting <literal>watcher.shield.encrypt_sensitive_data</literal> has been renamed to
<literal>xpack.watcher.encrypt_sensitive_data</literal>
</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="new-5.0.0" renderas="sect3">New Features<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-release-notes.asciidoc">Edit me</ulink></bridgehead>
<variablelist>
<varlistentry>
<term>
Monitoring
</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>
Added new node resolver, <literal>uuid</literal>, to the Monitoring UI configuration and made
it the default. Starting with Elasticsearch 5.0, instances of Elasticsearch
create a persistent UUID that remains the same across restarts unless the data
directory is deleted. If the data directory is deleted, the instance a new
UUID on start up.
</simpara>
</listitem>
<listitem>
<simpara>
Latencies calculated against <emphasis>totals</emphasis> use derivatives to get the rate of
change. If any derivative is negative, then that time bucket is ignored and
left blank on the latency chart. Values that are negative indicate that the
underlying total shrank, which means that the data is skewed and showing
the result is misleading (for example,  due to nodes restarting).
</simpara>
</listitem>
<listitem>
<simpara>
Added Segment Count memory chart to the Index page.
</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>
Security
</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>
Support for forest wide authentication in the <link linkend="active-directory-realm">Active Directory Realm</link>.
</simpara>
</listitem>
<listitem>
<simpara>
The default LDAP group search filter now includes <literal>posixGroup</literal> groups.
</simpara>
</listitem>
<listitem>
<simpara>
LDAP user search can now use un-pooled connections.
</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>
Watcher
</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>
Added support for accessing the HTTP status code of a response in the HTTP
input through <literal>ctx.payload._status_code</literal>.
</simpara>
</listitem>
<listitem>
<simpara>
The new REST endpoint for acknowledging certain actions of a watch is
  <literal>_xpack/watcher/watch/{watch_id}/_ack/{action_id}</literal>. The old notation was
  <literal>watcher/watch/{watch_id}/{action_id}/_ack</literal>, which will be removed
  in future releases.
</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="enhancements-5.0.0" renderas="sect3">Enhancements<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-release-notes.asciidoc">Edit me</ulink></bridgehead>
<variablelist>
<varlistentry>
<term>
Graph
</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>
Added ability to save Graph workspaces
</simpara>
</listitem>
<listitem>
<simpara>
Added ability to drill-down on Graph selections using other Kibana
visualizations
</simpara>
</listitem>
<listitem>
<simpara>
In the Graph UI, you can now use an index pattern such as <literal>logstash-*</literal> to
select multiple time-based indices instead of a single index.
</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>
Monitoring
</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>
Added dots for all points on charts.
</simpara>
</listitem>
<listitem>
<simpara>
Added the ability to highlight points by hovering close to them. The
highlighted point, and those from other series at the X-position, are what are
displayed in the legend.
</simpara>
</listitem>
<listitem>
<simpara>
Added a monitoring ingest pipeline so that future releases will be compatible
even if backward incompatible changes are made. This is enabled by default, but
can be disabled by setting <literal>use_ingest</literal> to <literal>false</literal> at the exporter level
(for example, <literal>xpack.monitoring.exporters.my_exporter.use_ingest: false</literal>).
</simpara>
</listitem>
<listitem>
<simpara>
Added the ability for HTTP exporters to send arbitrary HTTP headers along
with requests. This allows the HTTP exporter to be used with proxies to route
monitoring data more dynamically, if necessary. This can be used by supplying
name-value pairs at the exporter level (for example,
<literal>xpack.monitoring.exporters.my_exporter.headers.X-My-Header: abc123</literal>).
</simpara>
</listitem>
<listitem>
<simpara>
Rewrote the HTTP exporter to use the low-level REST Client and better pool
connections. This reduces the resources used for both networking and parsing.
</simpara>
</listitem>
<listitem>
<simpara>
Added Kibana instance monitoring as part of the same Elastic Cluster.
</simpara>
</listitem>
<listitem>
<simpara>
Added experimental charts to be used while monitoring Kibana instances.
</simpara>
</listitem>
<listitem>
<simpara>
Added breadcrumbs to allow simpler navigation between monitoring pages.
</simpara>
</listitem>
<listitem>
<simpara>
Simplified the Indices tab to remove charts that already appeared on the
Overview page so that indices are more accessible.
</simpara>
</listitem>
<listitem>
<simpara>
Simplified overall status handling so that it is clearer what the status of
the current item is (e.g., index view gives index status).
</simpara>
</listitem>
<listitem>
<simpara>
Added index memory graph to the Node page so that the cost of open indices
can be determined more accurately.
</simpara>
</listitem>
<listitem>
<simpara>
Added the total indexing rate alongside the primary indexing rate. Total
includes both primaries and replicas.
</simpara>
</listitem>
<listitem>
<simpara>
Added color to all charts.
</simpara>
</listitem>
<listitem>
<simpara>
Added units to all chart titles.
</simpara>
</listitem>
<listitem>
<simpara>
Added the internals to support monitoring Kibana instances.
</simpara>
</listitem>
<listitem>
<simpara>
Improved the display of values in the legend.
</simpara>
</listitem>
<listitem>
<simpara>
Shortened the welcome message.
</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>
Security
</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>
Native users and roles can now be used on tribe nodes.
</simpara>
</listitem>
<listitem>
<simpara>
Added the ability to disable native and reserved users.
</simpara>
</listitem>
<listitem>
<simpara>
Added ability to define exclusions for fields in field level security.
</simpara>
</listitem>
<listitem>
<simpara>
Added <link linkend="built-in-roles">built-in roles</link> for reporting users, monitoring users,
remote monitoring agents, and users of the Kibana ingest feature.
</simpara>
</listitem>
<listitem>
<simpara>
Auditing supports an <link linkend="audit-event-types"><literal>authentication_success</literal> event</link> that
is output after authentication. This event can output the body of the request,
so in combination with the <literal>authentication_failed</literal> event all request bodies can
be audited.
</simpara>
</listitem>
<listitem>
<simpara>
Added a X-Pack specific transport client, <link linkend="transport-client"><literal>PreBuiltXPackTransportClient</literal></link>, that provides an easy way to use the
transport client with X-Pack and other modules of Elasticsearch such as
reindex.
</simpara>
</listitem>
<listitem>
<simpara>
Auditing now de-duplicates the names of indices when logging.
</simpara>
</listitem>
<listitem>
<simpara>
Document and Field Level Security can be used with realtime requests.
</simpara>
</listitem>
<listitem>
<simpara>
The <literal>certgen</literal> tool no longer generates file names that would result in hidden
files and now offers an option to specify the validity
time of the generated certificates.
</simpara>
</listitem>
<listitem>
<simpara>
Added an <literal>ingest_admin</literal> role that grants the permissions requried to use the
ingest feature in Kibana.
</simpara>
</listitem>
<listitem>
<simpara>
New <literal>elastic</literal> and <literal>kibana</literal> built-in users.
</simpara>
</listitem>
<listitem>
<simpara>
New <literal>superuser</literal> and <literal>transport_client</literal> built-in roles.
</simpara>
</listitem>
<listitem>
<simpara>
Added a <link linkend="security-api-reset-user-password">password</link> API to enable
administrators and users to reset and change passwords.
</simpara>
</listitem>
<listitem>
<simpara>
Added a built-in <literal>kibana_user</literal> role that grants the minimum
set of privileges needed to use Kibana.
</simpara>
</listitem>
<listitem>
<simpara>
Default anonymous username changed to <literal>_anonymous</literal> (used to be
<literal>_es_anonymous_user</literal>)
</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>
Watcher
</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>
Allow use of <literal>inline</literal> attachments in emails, so that desktop clients can
display attachments like images embedded in emails.
</simpara>
</listitem>
<listitem>
<simpara>
The HTTP headers of a response are now part of the payload and can be
accessed via   <literal>ctx.payload._headers</literal>
</simpara>
</listitem>
<listitem>
<simpara>
Individual actions now support conditions. This is useful when a single watch
contains multiple actions&#8212;specific actions can fire based on the current
context.
</simpara>
</listitem>
<listitem>
<simpara>
Watches can now be modified or deleted while they are running, which is
especially useful for long running watches
</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="bugs-5.0.0" renderas="sect3">Bug Fixes<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-release-notes.asciidoc">Edit me</ulink></bridgehead>
<variablelist>
<varlistentry>
<term>
Security
</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>
Updated document level security to support preventing requests that use
scripts or <literal>now()</literal> from being cached.
</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>
Watcher
</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>
The watch version is now ignored when deleting a watch.
</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="_x_plugins_release_notes_pre_5_0" renderas="sect1">X-Plugins Release Notes (Pre-5.0)<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/xpack-release-notes.asciidoc">Edit me</ulink></bridgehead>
<itemizedlist>
<listitem>
<simpara>
<link linkend="security-release-notes">Shield</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="watcher-release-notes">Watcher</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="monitoring-release-notes">Marvel</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="graph-release-notes">Graph</link>
</simpara>
</listitem>
</itemizedlist>
</partintro>
<chapter id="security-release-notes">
<title>Shield Release Notes (Pre-5.0)<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/release-notes.asciidoc">Edit me</ulink></title>
<bridgehead id="update-roles" renderas="sect2">Updated Role Definitions<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>The default role definitions in the <literal>roles.yml</literal> file may need to be changed to ensure proper interoperation with other
applications such as Monitoring and Kibana. Any role changes are stored in <literal>roles.yml.new</literal> when you upgrade. We recommend copying the following changes to your <literal>roles.yml</literal> file.</simpara>
<itemizedlist>
<listitem>
<simpara>
The <literal>kibana4</literal> role now grants access to the Field Stats API.
</simpara>
</listitem>
<listitem>
<simpara>
The permission on all the roles are updated to the verbose format to make it easier to enable field level and document level security. The <literal>transport_client</literal> role has been updated to work with Elasticsearch 2.0.0.
 The <literal>marvel_user</literal> role has been updated to work with Monitoring 2.0 and a <literal>remote_marvel_agent</literal> role has been added. The <literal>kibana3</literal> and <literal>marvel_agent</literal> roles have been removed.
</simpara>
</listitem>
<listitem>
<simpara>
<literal>kibana</literal> role added that defines the minimum set of permissions necessary for the Kibana 4 server.
</simpara>
</listitem>
<listitem>
<simpara>
<literal>kibana4</literal> role updated to work with new features in Kibana 4 RC1
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="security-change-list" renderas="sect2">Change List<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/release-notes.asciidoc">Edit me</ulink></bridgehead>
<bridgehead id="_2_4_2" renderas="sect3">2.4.2<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>November 22, 2016</simpara>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
Users with <literal>manage</literal> or <literal>manage_security</literal> cluster privileges can now access the <literal>.security</literal> index if they have the appropriate index
privileges.
</simpara>
</listitem>
</itemizedlist>
<itemizedlist><title>Breaking Changes</title>
<listitem>
<simpara>
Shield on tribe nodes now requires <literal>tribe.on_conflict</literal> to prefer one of the clusters.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_4_0" renderas="sect3">2.4.0<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>August 31, 2016</simpara>
<itemizedlist><title>Breaking Changes</title>
<listitem>
<simpara>
The <literal>monitor</literal> cluster privilege now grants access to the GET <literal>/_license</literal> API
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_3_5" renderas="sect3">2.3.5<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>August 3, 2016</simpara>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
Fixed a license problem that was preventing tribe nodes from working with
Shield.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_3_4" renderas="sect3">2.3.4<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>July 7, 2016</simpara>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
The <literal>default</literal> transport profile SSL settings now override the <literal>shield.ssl.*</literal>
settings properly.
</simpara>
</listitem>
<listitem>
<simpara>
Fixed a memory leak that occured when indices were deleted or closed.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_3_3" renderas="sect3">2.3.3<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>May 18, 2016</simpara>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
Fixed the <literal>/_shield/realm/{realms}/_cache/clear</literal> REST endpoint. This endpoint is deprecated and <literal>/_shield/realm/{realms}/_clear_cache</literal> should be used going forward.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_3_2" renderas="sect3">2.3.2<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>April 26, 2016</simpara>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
Date math expressions in index names are now resolved before attempting to authorize access to the indices.
</simpara>
</listitem>
<listitem>
<simpara>
Fixed an issue where active directory realms did not work unless the url setting was configured.
</simpara>
</listitem>
<listitem>
<simpara>
Enabled <literal>_cat/indices</literal> to be used when Shield is installed.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_3_1" renderas="sect3">2.3.1<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>April 4, 2016</simpara>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
Fixed an issue that could prevent nodes from joining the cluster.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_3_0" renderas="sect3">2.3.0<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>March 30, 2016</simpara>
<itemizedlist><title>New Features</title>
<listitem>
<simpara>
<link linkend="native-realm">Native realm</link> with support for <link linkend="security-api-users">user management APIs</link>.
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="security-api-roles">Role management APIs</link> have been added.
</simpara>
</listitem>
</itemizedlist>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
When evaluating permissions for multiple roles that have document level security enabled for the same index, Shield performed an <literal>AND</literal>
on the queries, which is not consistent with how role privileges work in Shield. This has been changed to an <literal>OR</literal> relationship and may
affect the behavior of existing roles; please ensure you are not relying on the <literal>AND</literal> behavior of document level security queries.
</simpara>
</listitem>
<listitem>
<simpara>
When evaluation permissions for user that has roles with and without document level security (and/or field level security), the roles that
granted unrestricted access were not being applied properly and the user&#8217;s access was still being restricted.
</simpara>
</listitem>
</itemizedlist>
<itemizedlist><title>Enhancements</title>
<listitem>
<simpara>
Added new <link linkend="security-privileges">privileges</link> to simplify access control.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_2_1" renderas="sect3">2.2.1<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>March 15, 2016</simpara>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
Enable <link linkend="field-and-document-access-control">document and field level security</link> by default.
</simpara>
</listitem>
<listitem>
<simpara>
Fix issues with <link linkend="enable-message-authentication">message authentication</link> on certain JDKs that do not support cloning message
authentication codes.
</simpara>
</listitem>
<listitem>
<simpara>
Built in <link linkend="setting-up-authentication">realms</link> no longer throw an exception if the <literal>Authorization</literal> header does not contain a basic
authentication token.
</simpara>
</listitem>
<listitem>
<simpara>
Ensure each tribe client node has the same shield configuration as defined in the settings.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_2_0" renderas="sect3">2.2.0<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>February 2, 2016</simpara>
<itemizedlist><title>New Features</title>
<listitem>
<simpara>
Shield plugin for Kibana:  Secures user sessions and enables users to log in and out of Kibana.
For information about installing the Shield plugin, see <link linkend="kibana">Using Kibana with Shield</link>.
</simpara>
</listitem>
</itemizedlist>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
Update requests (including within bulk requests) are blocked when document
and field level security is enabled
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_1_2" renderas="sect3">2.1.2<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>February 2, 2016</simpara>
<itemizedlist><title>Enhancements</title>
<listitem>
<simpara>
Adds support for Elasticssearch 2.1.2
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_1_1" renderas="sect3">2.1.1<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>December 17, 2015</simpara>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
Disable the request cache when <link linkend="document-level-security">document level security</link> is in use for a search request.
</simpara>
</listitem>
<listitem>
<simpara>
Fix startup failures when using auditing and <link linkend="audit-log-entry-local-node-info">enabling network information output</link>.
</simpara>
</listitem>
<listitem>
<simpara>
Updated the <literal>kibana4</literal> role to include the Field Stats API.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_1_0" renderas="sect3">2.1.0<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>November 24, 2015</simpara>
<itemizedlist><title>Breaking Changes</title>
<listitem>
<simpara>
Same as 2.0.1. <link linkend="field-and-document-access-control">Document and Field Level Security</link> is now disabled by default. Set <literal>shield.dls_fls.enabled</literal> to <literal>true</literal> in <literal>elasticsearch.yml</literal> to enable it. You cannot submit <literal>_bulk</literal> update requests when document and field level security is enabled.
</simpara>
</listitem>
</itemizedlist>
<itemizedlist><title>Enhancements</title>
<listitem>
<simpara>
Adds support for Elasticsearch 2.1.0.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_0_2" renderas="sect3">2.0.2<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>December 16, 2015</simpara>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
Disable the request cache when <link linkend="document-level-security">document level security</link> is in use for a search request.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_0_1" renderas="sect3">2.0.1<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>November 24, 2015</simpara>
<itemizedlist><title>Breaking Changes</title>
<listitem>
<simpara>
<link linkend="field-and-document-access-control">Document and Field Level Security</link> is now disabled by default. Set <literal>shield.dls_fls.enabled</literal> to <literal>true</literal> in <literal>elasticsearch.yml</literal> to enable it. You cannot submit <literal>_bulk</literal> update requests when document and field level security is enabled.
</simpara>
</listitem>
</itemizedlist>
<itemizedlist><title>Enhancement</title>
<listitem>
<simpara>
Adds support for Elasticsearch 2.0.1.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_0_0" renderas="sect3">2.0.0<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>October 28, 2015</simpara>
<itemizedlist><title>Breaking Changes</title>
<listitem>
<simpara>
All files that Shield uses must be kept in the <link linkend="security-files-location">configuration directory</link> due to the enhanced security of Elasticsearch 2.0.
</simpara>
</listitem>
<listitem>
<simpara>
The network format has been changed from all previous versions of Shield and a full cluster restart is required to upgrade to Shield 2.0.
</simpara>
</listitem>
</itemizedlist>
<itemizedlist><title>New Features</title>
<listitem>
<simpara>
<link linkend="field-and-document-access-control">Document and Field Level Security</link> support has been added and can be
configured per role.
</simpara>
</listitem>
<listitem>
<simpara>
Support for <link linkend="custom-realms">custom authentication realms</link> has been added, allowing Shield to integrate with more authentication sources and methods.
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="run-as-privilege">User impersonation support</link> has also been added, which allows a user to send a request to Elasticsearch that will be run
with the specified user&#8217;s permissions.
</simpara>
</listitem>
</itemizedlist>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
<link linkend="auditing">Auditing</link> now captures requests from nodes using a different system key as tampered requests.
</simpara>
</listitem>
<listitem>
<simpara>
The <link linkend="audit-index">index output for auditing</link> stores the type of request when available.
</simpara>
</listitem>
<listitem>
<simpara>
<literal>esusers</literal> and <literal>syskeygen</literal> work when spaces are in the Elasticsearch installation path.
</simpara>
</listitem>
<listitem>
<simpara>
Fixed a rare issue where authentication fails even when the username and password are correct.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_1_3_3" renderas="sect3">1.3.3<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/release-notes.asciidoc">Edit me</ulink></bridgehead>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
Fixed a rare issue where authentication fails even when the username and password are correct.
</simpara>
</listitem>
<listitem>
<simpara>
The <link linkend="audit-index">index output for auditing</link> stores the type of request when available.
</simpara>
</listitem>
</itemizedlist>
<itemizedlist><title>Enhancements</title>
<listitem>
<simpara>
Tampered requests with a bad header are now audited.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_1_3_2" renderas="sect3">1.3.2<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>August 10, 2015</simpara>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
When using the <link linkend="ldap-user-search">LDAP user search</link> mechanism, connection errors during startup no longer cause the node to stop.
</simpara>
</listitem>
<listitem>
<simpara>
The <link linkend="security-api-clear-cache">Clear Cache API</link> no longer generates invalid JSON.
</simpara>
</listitem>
<listitem>
<simpara>
The <link linkend="audit-index">index output for auditing</link> starts properly when forwarding the audit events to a remote cluster and uses
the correct user to index the audit events.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_1_3_1" renderas="sect3">1.3.1<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>July 21, 2015</simpara>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
Fixes <link linkend="enable-message-authentication">message authentication</link> serialization to work with Shield 1.2.1 and earlier.
</simpara>
<itemizedlist>
<listitem>
<simpara>
will be necessary. When upgrading from other versions of Shield, follow the normal upgrade procedure.
</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<bridgehead id="_1_3_0" renderas="sect3">1.3.0<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>June 24, 2015</simpara>
<itemizedlist><title>Breaking Changes</title>
<listitem>
<simpara>
The <literal>sha2</literal> and <literal>apr1</literal> hashing algorithms have been removed as options for the <link linkend="cache-hash-algo"><literal>cache.hash_algo</literal> setting</link>.
  If your existing Shield installation uses either of these options, remove the setting and use the default <literal>ssha256</literal>
  algorithm.
</simpara>
</listitem>
<listitem>
<simpara>
The <literal>users</literal> file now only supports <literal>bcrypt</literal> password hashing. All existing passwords stored using the <literal>esusers</literal> tool
  have been hashed with <literal>bcrypt</literal> and are not affected.
</simpara>
</listitem>
</itemizedlist>
<itemizedlist><title>New Features</title>
<listitem>
<simpara>
<link linkend="pki-realm">PKI Realm</link>: Adds Public Key Infrastructure (PKI) authentication through the use of X.509 certificates in place of
 username and password credentials.
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="auditing">Index Output for Audit Events</link>: An index based output has been added for storing audit events in an Elasticsearch index.
</simpara>
</listitem>
</itemizedlist>
<itemizedlist><title>Enhancements</title>
<listitem>
<simpara>
TLS 1.2 is now the default protocol.
</simpara>
</listitem>
<listitem>
<simpara>
Clients that do not support pre-emptive basic authentication can now support both anonymous and authenticated access
  by specifying the <literal>shield.authc.anonymous.authz_exception</literal> <link linkend="anonymous-access">setting</link> with a value of <literal>false</literal>.
</simpara>
</listitem>
<listitem>
<simpara>
Reduced logging for common SSL exceptions, such as a client closing the connection during a handshake.
</simpara>
</listitem>
</itemizedlist>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
The <literal>esusers</literal> and <literal>syskeygen</literal> tools now work correctly with environment variables in the RPM and DEB installation
  environment files <literal>/etc/sysconfig/elasticsearch</literal> and <literal>/etc/default/elasticsearch</literal>.
</simpara>
</listitem>
<listitem>
<simpara>
Default ciphers no longer include <literal>TLS_DHE_RSA_WITH_AES_128_CBC_SHA</literal>.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_1_2_3" renderas="sect3">1.2.3<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>July 21, 2015</simpara>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
Fixes <link linkend="enable-message-authentication">message authentication</link> serialization to work with Shield 1.2.1 and earlier.
</simpara>
<itemizedlist>
<listitem>
<simpara>
will be necessary. When upgrading from other versions of Shield, follow the normal upgrade procedure.
</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<bridgehead id="_1_2_2" renderas="sect3">1.2.2<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>June 24, 2015</simpara>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
The <literal>esusers</literal> tool no longer warns about missing roles that are properly defined in the <literal>roles.yml</literal> file.
</simpara>
</listitem>
<listitem>
<simpara>
The period character, <literal>.</literal>, is now allowed in usernames and role names.
</simpara>
</listitem>
<listitem>
<simpara>
  are properly authorized. This removes the need to manually disable the terms filter cache.
</simpara>
</listitem>
<listitem>
<simpara>
For LDAP client connections, only the protocols and ciphers specified in the <literal>shield.ssl.supported_protocols</literal> and
  <literal>shield.ssl.ciphers</literal> <link linkend="ssl-tls-settings">settings</link> will be used.
</simpara>
</listitem>
<listitem>
<simpara>
The auditing mechanism now logs authentication failed events when a request contains an invalid authentication token.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_1_2_1" renderas="sect3">1.2.1<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>April 29, 2015</simpara>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
Several bug fixes including a fix to ensure that <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/disk-allocator.html">Disk-based Shard Allocation</ulink>
works properly with Shield
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_1_2_0" renderas="sect3">1.2.0<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>March 24, 2015</simpara>
<itemizedlist><title>Enhancements</title>
<listitem>
<simpara>
Adds support for Elasticsearch 1.5
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_1_1_1" renderas="sect3">1.1.1<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>April 29, 2015</simpara>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
Several bug fixes including a fix to ensure that <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/disk-allocator.html">Disk-based Shard Allocation</ulink>
works properly with Shield
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_1_1_0" renderas="sect3">1.1.0<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>March 24, 2015</simpara>
<itemizedlist><title>New Features</title>
<listitem>
<simpara>
LDAP:
</simpara>
<itemizedlist>
<listitem>
<simpara>
Add the ability to bind as a specific user for LDAP searches, which removes the need to specify <literal>user_dn_templates</literal>.
This mode of operation also makes use of connection pooling for better performance. Please see <link linkend="ldap-user-search">ldap user search</link>
for more information.
</simpara>
</listitem>
<listitem>
<simpara>
User distinguished names (DNs) can now be used for <link linkend="ldap-role-mapping">role mapping</link>.
</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>
Authentication:
</simpara>
<itemizedlist>
<listitem>
<simpara>
<link linkend="anonymous-access">Anonymous access</link> is now supported (disabled by default).
</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>
IP Filtering:
</simpara>
<itemizedlist>
<listitem>
<simpara>
IP Filtering settings can now be <link linkend="dynamic-ip-filtering">dynamically updated</link> using the <ulink url="http://www.elastic.co/guide/en/elasticsearch/reference/5.0/cluster-update-settings.html">Cluster Update Settings API</ulink>.
</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<itemizedlist><title>Enhancements</title>
<listitem>
<simpara>
Significant memory footprint reduction of internal data structures
</simpara>
</listitem>
<listitem>
<simpara>
Test if SSL/TLS ciphers are supported and warn if any of the specified ciphers are not supported
</simpara>
</listitem>
<listitem>
<simpara>
Reduce the amount of logging when a non-encrypted connection is opened and <literal>https</literal> is being used
</simpara>
</listitem>
<listitem>
<simpara>
Added the <link linkend="kibana-roles"><literal>kibana_server</literal> role</link>, which is a role that contains the minimum set of permissions required for the Kibana 4 server.
</simpara>
</listitem>
<listitem>
<simpara>
In-memory user credential caching hash algorithm defaults now to salted SHA-256 (see <link linkend="cache-hash-algo">Cache hash algorithms</link>
</simpara>
</listitem>
</itemizedlist>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
Filter out sensitive settings from the settings APIs
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_1_0_2" renderas="sect3">1.0.2<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>March 24, 2015</simpara>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
Filter out sensitive settings from the settings APIs
</simpara>
</listitem>
<listitem>
<simpara>
Significant memory footprint reduction of internal data structures
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_1_0_1" renderas="sect3">1.0.1<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/shield/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>February 13, 2015</simpara>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
Fixed dependency issues with Elasticsearch 1.4.3 and (Lucene 4.10.3 that comes with it)
</simpara>
</listitem>
<listitem>
<simpara>
Fixed bug in how user roles were handled. When multiple roles were defined for a user, and one of the
  roles only had cluster permissions, not all privileges were properly evaluated.
</simpara>
</listitem>
<listitem>
<simpara>
Updated <literal>kibana4</literal> permissions to be compatible with Kibana 4 RC1
</simpara>
</listitem>
<listitem>
<simpara>
Ensure the mandatory <literal>base_dn</literal> settings is set in the <literal>ldap</literal> realm configuration
</simpara>
</listitem>
</itemizedlist>
</chapter>
<chapter id="monitoring-release-notes">
<title>Marvel Release Notes (Pre-5.0)<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/marvel/release-notes.asciidoc">Edit me</ulink></title>
<simpara>This section summarizes the Monitoring changes in each release.
For information about upgrading X-Pack, see <link linkend="xpack-upgrading">Upgrading X-Pack</link>.</simpara>
<bridgehead id="monitoring-change-list" renderas="sect2">Change List<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/marvel/release-notes.asciidoc">Edit me</ulink></bridgehead>
<bridgehead id="_2_4_2_2" renderas="sect3">2.4.2<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/marvel/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>November 22, 2016</simpara>
<itemizedlist><title>Enhancements</title>
<listitem>
<simpara>
Compatibility with Elasticsearch 2.4.2.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_4_0_2" renderas="sect3">2.4.0<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/marvel/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>August 31, 2016</simpara>
<itemizedlist><title>Enhancements</title>
<listitem>
<simpara>
Node transport addresses are now consistently reported using only their IP address and port, rather than a subset reporting their resolved hostname, IP address, and port.
</simpara>
</listitem>
</itemizedlist>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
Using the time picker to select clusters now honors the full time range, rather than only clusters that sent updates within the last 10 minutes.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_3_5_2" renderas="sect3">2.3.5<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/marvel/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>August 3, 2016</simpara>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
Fixed sorting by number of unassigned shards in the indices table.
</simpara>
</listitem>
<listitem>
<simpara>
Fixed the shard allocation tables to render when shards are relocating.
</simpara>
</listitem>
<listitem>
<simpara>
Fixed the tooltips that are supposed to show for relocating shards in the
allocation table, and also added tooltips for shards of all states.
</simpara>
</listitem>
<listitem>
<simpara>
Removed Google Analytics beacon, and fix the optional phone-home call to not
block page rendering.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_3_4_2" renderas="sect3">2.3.4<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/marvel/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>July 7, 2016</simpara>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
Using the time picker to select clusters now honors the full time range,
rather than only clusters that sent updates within the last 10 minutes.
</simpara>
</listitem>
<listitem>
<simpara>
Phone home data omits <literal>source_node</literal> information that was being erroneously
picked up from the <literal>cluster_info</literal> field.
</simpara>
</listitem>
<listitem>
<simpara>
Shards in the Relocating state are no longer counted as Unassigned Shards.
</simpara>
</listitem>
<listitem>
<simpara>
Removed Google Analytics Tag from UI.
</simpara>
</listitem>
<listitem>
<simpara>
The UI rendering no longer blocks waiting for the phone home call to return.
</simpara>
</listitem>
<listitem>
<simpara>
Fixed the "no data" page to run an automatic refresh cycle to look for data.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_3_3_2" renderas="sect3">2.3.3<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/marvel/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>May 18, 2016</simpara>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
Prevents exceptions from being logged if the node stats are temporarily empty.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_3_2_2" renderas="sect3">2.3.2<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/marvel/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>April 26, 2016</simpara>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
Fixed a bug where non-elected master nodes all appeared as Offline in the node list.
</simpara>
<note><simpara>You can workaround this in 2.3.0 and 2.3.1 by setting <literal>marvel.node_resolver: name</literal> in <literal>kibana.yml</literal>.
* Introduced the timepicker controls in the clusters page so you can view snapshots Marvel data.
* Added a link to go back to the previous page from the License page.</simpara></note>
</listitem>
</itemizedlist>
<bridgehead id="_2_3_1_2" renderas="sect3">2.3.1<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/marvel/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>April 4, 2016</simpara>
<itemizedlist><title>Enhancements</title>
<listitem>
<simpara>
Adds support for Elasticsearch 2.3.1
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_3_0_2" renderas="sect3">2.3.0<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/marvel/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>March 30, 2016</simpara>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
Minor UI improvements.
</simpara>
</listitem>
</itemizedlist>
<itemizedlist><title>Enhancements</title>
<listitem>
<simpara>
Adds support for Elasticssearch 2.3.0
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_2_1_2" renderas="sect3">2.2.1<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/marvel/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>March 15, 2016</simpara>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
Fix a bug when Monitoring is configured to export data over HTTP on a monitoring cluster protected by Security (with SSL).
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_2_0_2" renderas="sect3">2.2.0<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/marvel/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>February 2, 2016</simpara>
<itemizedlist><title>Enhancements</title>
<listitem>
<simpara>
Enable access to the License page from the cluster status bar.
</simpara>
</listitem>
<listitem>
<simpara>
Allow configuration of a monthly interval for Monitoring indices instead of limiting it to daily.
</simpara>
</listitem>
<listitem>
<simpara>
Provide a sha1 hash for the Monitoring app download.
</simpara>
</listitem>
</itemizedlist>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
Minor UI improvements.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_1_2_2" renderas="sect3">2.1.2<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/marvel/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>February 2, 2016</simpara>
<itemizedlist><title>Enhancements</title>
<listitem>
<simpara>
Adds support for Elasticsearch 2.1.2
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_1_1_2" renderas="sect3">2.1.1<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/marvel/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>December 17, 2015</simpara>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
Check the Kibana version to ensure compatibility.
</simpara>
</listitem>
<listitem>
<simpara>
Respect opt-out for statistics reporting in all cases.
</simpara>
</listitem>
<listitem>
<simpara>
Fixed transport address not showing on the node detail page.
</simpara>
</listitem>
<listitem>
<simpara>
Fixed the table filtering on the node listing page.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_1_0_2" renderas="sect3">2.1.0<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/marvel/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>November 24, 2015</simpara>
<itemizedlist><title>Enhancements</title>
<listitem>
<simpara>
Display a node type indicator on the Node Listing and Node Detail pages.
</simpara>
</listitem>
<listitem>
<simpara>
Show the online/offline status of nodes.
</simpara>
</listitem>
<listitem>
<simpara>
Remove the Time Picker from the Cluster Listing page.
</simpara>
</listitem>
</itemizedlist>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
Multiple fixes for showing historical data.
</simpara>
</listitem>
<listitem>
<simpara>
Filter out derivative calculations where the start and end times are incomplete time buckets.
</simpara>
</listitem>
<listitem>
<simpara>
Cluster table sorting.
</simpara>
</listitem>
<listitem>
<simpara>
Use the new Elasticsearch <literal>_field_stats</literal> API  to determine which Monitoring indices are needed to generate the stats.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_0_1_2" renderas="sect3">2.0.1<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/marvel/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>November 24, 2015</simpara>
<itemizedlist><title>Enhancements</title>
<listitem>
<simpara>
Adds support for Elasticsearch 2.0.1.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_0_0_2" renderas="sect3">2.0.0<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/marvel/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>October 28, 2015</simpara>
<formalpara><title>Breaking Changes</title><para>Monitoring 2.0.0 is a complete rewrite from Monitoring 1.3. If you are upgrading from Monitoring 1.3, note that
the Monitoring agent plugin only needs to be installed on the Elasticsearch nodes you are monitoring.
If you need to stop collecting data from a node, remove the plugin or set the <literal>xpack.monitoring.enabled</literal>
configuration parameter to <literal>false</literal>. (The <literal>xpack.monitoring.agent.enabled</literal> parameter is no longer supported.)</para></formalpara>
<itemizedlist><title>New Features</title>
<listitem>
<simpara>
Fully-integrated with Kibana 4.2 as a Kibana plugin.
</simpara>
</listitem>
<listitem>
<simpara>
Supports Multiple clusters for Paid Subscriptions
</simpara>
</listitem>
<listitem>
<simpara>
Reduced data footprint for Monitoring indices
</simpara>
</listitem>
<listitem>
<simpara>
Simplified dashboards for Indices and Nodes
</simpara>
</listitem>
<listitem>
<simpara>
Better support for large clusters
</simpara>
</listitem>
</itemizedlist>
</chapter>
<chapter id="watcher-release-notes">
<title>Watcher Release Notes (Pre-5.0)<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/release-notes.asciidoc">Edit me</ulink></title>
<bridgehead id="watcher-change-list" renderas="sect2">Change List<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD</simpara>
<informalexample>
<simpara>November 22, 2016</simpara>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
Deleting a watch now is independent from its current execution state in
order to prevent failed deletions with watches having small intervals
</simpara>
</listitem>
<listitem>
<simpara>
Chain input: Parsing now throws an exception if a data structure is added, that cannot keep its order
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_4_1" renderas="sect3">2.4.1<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>September 28, 2016</simpara>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
Fixed a serialization error that resulted in the watch history not being
written when a proxy is specified in a watch.
</simpara>
</listitem>
<listitem>
<simpara>
Triggered watches are now correctly deleted from the <literal>.triggered-watches</literal>
index if they are rejected due to a full thread pool.
</simpara>
</listitem>
<listitem>
<simpara>
Deleting or closing the <literal>.watches</literal> index now correctly cleans up the
in-memory watch store so the watches are no longer executed.
</simpara>
</listitem>
<listitem>
<simpara>
If the HTTP request for an attachment fails, the error message is included
in the watch history.
</simpara>
</listitem>
<listitem>
<simpara>
Fixed a possible exception when chained inputs don&#8217;t execute successfully.
</simpara>
</listitem>
</itemizedlist>
<itemizedlist><title>Enhancements</title>
<listitem>
<simpara>
<link linkend="watcher-settings">Hostname verification</link> can be disabled for Watcher
HTTP actions.
</simpara>
</listitem>
<listitem>
<simpara>
Running watches can be updated and deleted.
&gt;&gt;&gt;&gt;&gt;&gt;&gt; c2e5e43&#8230; Docs: Version bump &amp; RN update for 2.4.2
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_4_0_3" renderas="sect3">2.4.0<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>August 31, 2016</simpara>
<itemizedlist><title>Enhancements</title>
<listitem>
<simpara>
The HTTP headers of a response are now part of the payload and can be accessed via <literal>ctx.payload._headers</literal>
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_3_5_3" renderas="sect3">2.3.5<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>August 3, 2016</simpara>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
The watch history was not written, if one of the chained inputs resulted in a failure as well as an input containing a field name with dots
</simpara>
</listitem>
<listitem>
<simpara>
Status of an acked watch, whose condition evaluates to false again is now properly persisted and not lost in case of a master node switch
</simpara>
</listitem>
<listitem>
<simpara>
Fixed the watch history template so payloads and request bodies are handled
correctly. To update an existing installation, delete the existing watch history
template by running <literal>DELETE /_template/watch_history</literal> and the correct template
will be autocreated. To verify the template is recreated, call <literal>GET
/_template/watch_history</literal>. Note that this just updates the template, so you
need to wait one day for this update to take effect when a new history index is
created.
</simpara>
</listitem>
<listitem>
<simpara>
The <literal>watcher.http.proxy.port</literal> setting for global proxy configuration was not applied correctly.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_3_4_3" renderas="sect3">2.3.4<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>July 7, 2016</simpara>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
Putting a new watch with state <literal>active=false</literal> now stores that state correctly
on a multi node cluster.
</simpara>
</listitem>
<listitem>
<simpara>
Fixed the watch history template so nested request bodies are handled
correctly. To update an existing installation, delete the existing watch history
template by running <literal>DELETE /_template/watch_history</literal> and the correct template
will be autocreated. To verify the template is recreated, call <literal>GET
/_template/watch_history</literal>. Note that this just updates the template, so you
need to wait one day for this update to take effect when a new history index is
created.
</simpara>
</listitem>
<listitem>
<simpara>
The HTML sanitizer now supports border and cellpadding attributes on table
elements and the colspan and rowspan attributes on &lt;td&gt; and &lt;tr&gt; elements.
</simpara>
</listitem>
<listitem>
<simpara>
Fixed the Watcher/Marvel examples in the documentation.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_3_3_3" renderas="sect3">2.3.3<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>May 18, 2016</simpara>
<itemizedlist><title>Enhancements</title>
<listitem>
<simpara>
Adds support for Elasticsearch 2.3.3
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_3_2_3" renderas="sect3">2.3.2<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>April 26, 2016</simpara>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
All SMTP connection timeouts are now set to two minutes by default to prevent
a watch from getting stuck.
</simpara>
</listitem>
<listitem>
<simpara>
HTTP headers from responses that contained dots led to exceptions when the
HTTP response was stored in the watch history. All dots in any header names
are now replaced with underscores. For example, a header called <literal>foo.bar</literal>
becomes <literal>foo_bar</literal>
</simpara>
</listitem>
<listitem>
<simpara>
Hipchat action: Fall back to the default Hipchat color and format if they
are not specified at the account level or within the action itself, instead
of failing.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_3_1_3" renderas="sect3">2.3.1<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>April 4, 2016</simpara>
<itemizedlist><title>Enhancements</title>
<listitem>
<simpara>
Adds support for Elasticsearch 2.3.1
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_3_0_3" renderas="sect3">2.3.0<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>March 30, 2016</simpara>
<itemizedlist><title>Bug fixes</title>
<listitem>
<simpara>
The http client does not do any URL escaping by itself anymore, preventing
  potential wrong double escapes.
</simpara>
</listitem>
</itemizedlist>
<itemizedlist><title>Enhancement</title>
<listitem>
<simpara>
Support <literal>url</literal> in http requests as a shortcut for <literal>path</literal>, <literal>scheme</literal>, <literal>port</literal>, <literal>params</literal>
</simpara>
</listitem>
<listitem>
<simpara>
Support <literal>ignore_condition</literal> and <literal>record_execution</literal> as parameters in the
  <link linkend="watcher-api-execute-watch">Execute Watch API</link>
</simpara>
</listitem>
</itemizedlist>
<itemizedlist><title>New Features</title>
<listitem>
<simpara>
Added <link linkend="actions-pagerduty">PagerDuty action</link>
</simpara>
</listitem>
<listitem>
<simpara>
Added support for adding <link linkend="configuring-email-attachments">attachments to emails</link>
  via HTTP requests and superceding and deprecating the usage of <literal>attach_data</literal>
  in order to use this feature
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_2_1_3" renderas="sect3">2.2.1<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>March 10, 2016</simpara>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
The <literal>croneval</literal> CLI tool sets the correct environment to run
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_2_0_3" renderas="sect3">2.2.0<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>February 2, 2016</simpara>
<itemizedlist><title>Enhancements</title>
<listitem>
<simpara>
Adds support for Elasticsearch 2.2.0.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_1_2_3" renderas="sect3">2.1.2<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>February 2, 2016</simpara>
<itemizedlist><title>Enhancements</title>
<listitem>
<simpara>
Adds support for Elasticssearch 2.1.2
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_1_1_3" renderas="sect3">2.1.1<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>December 17, 2015</simpara>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
Fixed an issue that prevented sending of emails
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_1_0_3" renderas="sect3">2.1.0<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>November 24, 2015</simpara>
<itemizedlist><title>New Features</title>
<listitem>
<simpara>
Adds support for <link linkend="input-chain">chaining several inputs</link>
</simpara>
</listitem>
</itemizedlist>
<itemizedlist><title>Enhancements</title>
<listitem>
<simpara>
Adds support for Elasticsearch 2.1.0.
</simpara>
</listitem>
<listitem>
<simpara>
Adds support for configuring a proxy in the webhook action, http input and
  configuring a default proxy (which is also used by the slack action), using the
  <literal>watcher.http.proxy.host</literal> and <literal>watcher.http.proxy.port</literal> settings.
</simpara>
</listitem>
</itemizedlist>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
Fixed an issue where the scheduler may get stuck during Watcher startup. This
  caused no watches to ever fire.
</simpara>
</listitem>
<listitem>
<simpara>
Fixed an issue where under specific conditions Watcher would not start if there
  are not finished watch executions from the previous time that watcher was
  running and those watch execution are unable the execute during the current
  start process.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_0_1_3" renderas="sect3">2.0.1<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>November 24, 2015</simpara>
<itemizedlist><title>Enhancement</title>
<listitem>
<simpara>
Adds support for Elasticsearch 2.0.1.
</simpara>
</listitem>
</itemizedlist>
<itemizedlist><title>Bug fixes</title>
<listitem>
<simpara>
Fixed an issue where under specific conditions Watcher would not start if
  there are not finished watch executions from the previous time that watcher
  was running and those watch execution are unable the execute during the current
  start process.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_0_0_3" renderas="sect3">2.0.0<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>October 28, 2015</simpara>
<itemizedlist><title>Breaking Changes</title>
<listitem>
<simpara>
The dynamic index names support has been removed and Elasticsearch&#8217;s date math
  index names support should be used instead. The only difference between Watcher&#8217;s
  dynamic index names support and Elasticsearch&#8217;s date math index names support is
  how timezones are expressed. In Watcher this is done via node settings, in
  Elasticsearch the timezone is part of the date math index names support. Only
  if you&#8217;re using dynamic index names with timezones in Watcher then you need to
  upgrade your watches after the upgrade, otherwise your watches will work as
  they did before the upgrade. For example if <literal>watcher.dynamic_indices.time_zone</literal>
  setting was set to <literal>+01:00</literal> and a watch has the following index name
  <literal>&lt;logstash-{now/d}&gt;</literal> then after the upgrade you need to update this watch to
  use the following index name <literal>&lt;logstash-{now/d{YYYY.MM.dd|+01:00}}&gt;</literal>.
</simpara>
</listitem>
</itemizedlist>
<itemizedlist><title>New Features</title>
<listitem>
<simpara>
Added new <link linkend="actions-hipchat">HipChat Action</link>
</simpara>
</listitem>
<listitem>
<simpara>
Added new <link linkend="actions-slack">Slack Action</link>
</simpara>
</listitem>
<listitem>
<simpara>
Watches now have an <link linkend="watch-active-state">active state</link>. In addition, a new
  API was added to <link linkend="watcher-api-activate-watch">activate</link>/<link linkend="watcher-api-deactivate-watch">deactivate</link>
  registered watches.
</simpara>
</listitem>
<listitem>
<simpara>
Added new <link linkend="condition-array-compare">array_compare</link>, that can compare an array
  of values in the <link linkend="watch-execution-context">Watch Execution Context Model</link>
  to a given value.
</simpara>
</listitem>
</itemizedlist>
<itemizedlist><title>Enhancements</title>
<listitem>
<simpara>
Watcher continuously checks if the index templates for <literal>.watches</literal>,
  <literal>.triggered_watches</literal> and <literal>.watch_history-*</literal> exist. Whereas before the existence
  of these index templates was only checked at Watcher startup time. The absence
  of these index templates leads to watcher data being indexed incorrectly, which
  then can cause Watcher to behave incorrectly.
</simpara>
</listitem>
<listitem>
<simpara>
If Watcher was stopped via the stop Watcher api and after that a master
  election took place then Watcher would then unexpectedly start.
</simpara>
</listitem>
<listitem>
<simpara>
During Watcher start up only wait for the shards of the <literal>.watches</literal> and
  <literal>.triggered_watches</literal> indices to be available. Before Watcher also waited for
  the shards of the <literal>.watch_history-*</literal> indices, which wasn&#8217;t needed. This
  improved time it takes for Watcher to startup.
</simpara>
</listitem>
<listitem>
<simpara>
If <literal>action.auto_create_index</literal> setting has been configured then Watcher will
  check if the setting is too restrictive. If the <literal>action.auto_create_index</literal> is
  too restrictive then Watcher will fail during startup with a descriptive error
  message.
</simpara>
</listitem>
</itemizedlist>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
If Watcher was installed with Security then the Watcher index templates couldn&#8217;t
  be stored and could lead to Watcher behaving incorrectly. This was caused by
  Watcher not detecting correctly if Security was installed.
</simpara>
</listitem>
<listitem>
<simpara>
Update <literal>croneval</literal> command line utility to properly handle whitespaces in the
  elasticsearch home path.
</simpara>
</listitem>
<listitem>
<simpara>
Fixed an issue where the scheduler may get stuck during Watcher startup. This
  caused no watches to ever fire.
</simpara>
</listitem>
<listitem>
<simpara>
Fixed url encoding issue in http input and webhook output. The url params were
  url encoded twice.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_1_0_1_2" renderas="sect3">1.0.1<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>July 29, 2015</simpara>
<itemizedlist><title>Enhancements</title>
<listitem>
<simpara>
Dynamic index names now support specifying a time zone to be used when
  computing the names of the indices. The default is UTC. Previously, the
  computation was fixed to always use UTC when computing the names of the
  indices.
</simpara>
</listitem>
</itemizedlist>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
Fixed a compatibility issue with Elasticsearch 1.6.1 and 1.7.2, which were
  released earlier today.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_1_0_0" renderas="sect3">1.0.0<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>June 25, 2015</simpara>
<itemizedlist><title>Enhancements</title>
<listitem>
<simpara>
Added execution time aware dynamic index names support to <literal>index</literal>
  action, <literal>search</literal> input, and <literal>search</literal> transform.
</simpara>
</listitem>
<listitem>
<simpara>
You must now explicitly specify the unit when configuring any time value.
  (Numeric-only values are no longer supported.)
</simpara>
</listitem>
<listitem>
<simpara>
Cleaned up the <link linkend="watcher-api-get-watch">Get Watch API</link> response.
</simpara>
</listitem>
<listitem>
<simpara>
Cleaned up the <link linkend="watcher-api-stats">Stats API</link> response.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_1_0_0_rc1" renderas="sect3">1.0.0-rc1<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>June 19, 2015</simpara>
<itemizedlist><title>New Features</title>
<listitem>
<simpara>
Added <link linkend="watcher-api-execute-inline-watch">inline watch</link> support to the Execute API
</simpara>
</listitem>
</itemizedlist>
<itemizedlist><title>Enhancements</title>
<listitem>
<simpara>
Added execution context <link linkend="watch-execution-context">variables</link> support.
</simpara>
</listitem>
<listitem>
<simpara>
Email html body sanitization is now <link linkend="email-html-sanitization">configurable</link>.
</simpara>
</listitem>
<listitem>
<simpara>
It is now possible to configure timeouts for http requests in
  <link linkend="http-input-attributes">HTTP input</link> and <link linkend="webhook-action-attributes">webhook actions</link>.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_1_0_0_beta2" renderas="sect3">1.0.0-Beta2<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/watcher/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>June 10, 2015</simpara>
<itemizedlist><title>New Features</title>
<listitem>
<simpara>
<link linkend="actions-ack-throttle">Acking and Throttling</link> are now applied at the action
  level rather than the watch level.
</simpara>
</listitem>
<listitem>
<simpara>
Added support for <link linkend="anatomy-actions-index-multi-doc-support">multi-doc</link>
  indexing to the index action.
</simpara>
</listitem>
<listitem>
<simpara>
Added a queued watches metric that&#8217;s accessible via the <link linkend="watcher-api-stats">Stats API</link>.
</simpara>
</listitem>
<listitem>
<simpara>
Added a currently-executing watches metric that&#8217;s accessible via the
  <link linkend="watcher-api-stats">Stats API</link>.
</simpara>
</listitem>
</itemizedlist>
<itemizedlist><title>Enhancements</title>
<listitem>
<simpara>
The <link linkend="condition-compare">compare condition</link> result now includes the value of
  each field that was referenced in the comparison.
</simpara>
</listitem>
<listitem>
<simpara>
The <link linkend="watcher-api-execute-watch">Execute API</link> now supports a default trigger
  event (<emphasis role="strong">breaking change</emphasis>).
</simpara>
</listitem>
<listitem>
<simpara>
The <literal>watch_record</literal> document structure in the <literal>.watch_history-*</literal> indices has
  changed significantly (<emphasis role="strong">breaking change</emphasis>).
</simpara>
</listitem>
<listitem>
<simpara>
A new internal index was introduced - <literal>.triggered_watches</literal>
</simpara>
</listitem>
<listitem>
<simpara>
Added support for headers in the <link linkend="actions-webhook">Webhook Action</link> result
  and the <link linkend="input-http">HTTP Input</link> result.
</simpara>
</listitem>
<listitem>
<simpara>
Add plain text response body support for the <link linkend="input-http">HTTP Input</link>.
</simpara>
</listitem>
</itemizedlist>
<itemizedlist><title>Bug Fixes</title>
<listitem>
<simpara>
Disallow negative time value settings for <link linkend="actions-ack-throttle"><literal>throttle_period</literal></link>
</simpara>
</listitem>
<listitem>
<simpara>
Added support for separate keystore and truststore in <link linkend="actions-webhook">Webhook Action</link>
  and <link linkend="input-http">HTTP Input</link>.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="reporting-change-list" renderas="sect2">Change List<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/reporting/release-notes.asciidoc">Edit me</ulink></bridgehead>
<bridgehead id="_2_4_2_3" renderas="sect3">2.4.2<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/reporting/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>September 28, 2016</simpara>
<itemizedlist><title>Enhancements</title>
<listitem>
<simpara>
You can now view all reports, or just your own reports.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="post-change" renderas="sect3">2.4.1<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/reporting/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>September 6, 2016</simpara>
<itemizedlist><title>Breaking Changes</title>
<listitem>
<simpara>
To prevent abuse, the reporting endpoints now require requests to be submitted
as HTTP POST requests rather than GET requests.
</simpara>
</listitem>
<listitem>
<simpara>
Requests must include the <literal>kbn-xsrf</literal> header added in Kibana 4.6.1. You should
upgrade to Kibana 4.6.1 to use Reporting 2.4.1.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_4_0_4" renderas="sect3">2.4.0<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/reporting/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>August 31, 2016</simpara>
<itemizedlist><title>New Features</title>
<listitem>
<simpara>
Manually Export PDF reports from Kibana and automatically generate reports from Watcher.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="graph-change-list" renderas="sect2">Change List<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/graph/release-notes.asciidoc">Edit me</ulink></bridgehead>
<bridgehead id="_2_4_2_4" renderas="sect3">2.4.2<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/graph/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>September 22, 2016</simpara>
<itemizedlist><title>Enhancements</title>
<listitem>
<simpara>
Adds support for Elasticsearch 2.4.2
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_4_0_5" renderas="sect3">2.4.0<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/graph/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>August 31, 2016</simpara>
<itemizedlist><title>Enhancements</title>
<listitem>
<simpara>
Adds support for Elasticsearch 2.4.0
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_3_5_4" renderas="sect3">2.3.5<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/graph/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>August 3, 2016</simpara>
<itemizedlist><title>Enhancements</title>
<listitem>
<simpara>
Adds support for Elasticsearch 2.3.5
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_3_4_4" renderas="sect3">2.3.4<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/graph/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>July 7, 2016</simpara>
<itemizedlist><title>Enhancements</title>
<listitem>
<simpara>
Adds support for Elasticsearch 2.3.4
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_3_3_4" renderas="sect3">2.3.3<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/graph/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>May 18, 2016</simpara>
<itemizedlist><title>Enhancements</title>
<listitem>
<simpara>
Adds support for Elasticsearch 2.3.3
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_3_2_4" renderas="sect3">2.3.2<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/graph/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>April 26, 2016</simpara>
<itemizedlist><title>Enhancements</title>
<listitem>
<simpara>
Adds support for Elasticsearch 2.3.2
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_3_1_4" renderas="sect3">2.3.1<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/graph/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>April 4, 2016</simpara>
<itemizedlist><title>Enhancements</title>
<listitem>
<simpara>
Adds support for Elasticsearch 2.3.1
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_2_3_0_4" renderas="sect3">2.3.0<ulink role="edit_me" url="/mnt/docs/docs/.repos/.temp/RIxzItwgG_/docs/public/graph/release-notes.asciidoc">Edit me</ulink></bridgehead>
<simpara>March 30, 2016</simpara>
<itemizedlist><title>New Features</title>
<listitem>
<simpara>
Introduces the <link linkend="graph-api">Graph API</link> and a Graph UI plugin for Kibana.
</simpara>
</listitem>
</itemizedlist>
</informalexample>
</chapter>
</part>
</book>
